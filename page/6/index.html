<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.to2b.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.to2b.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/6/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.to2b.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%89%8D%E7%AB%AF/node/node/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%89%8D%E7%AB%AF/node/node/" class="post-title-link" itemprop="url">json</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-15 23:44:06" itemprop="dateCreated datePublished" datetime="2021-03-15T23:44:06+08:00">2021-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/node/" itemprop="url" rel="index"><span itemprop="name">node</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> json <span class="token parameter variable">-g</span></code></pre>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 标准输入</span>
<span class="token operator">&lt;</span>something generating JSON on stdout<span class="token operator">></span> <span class="token operator">|</span> json <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token punctuation">[</span>LOOKUPS<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token comment"># 从文件中加载</span>
json <span class="token parameter variable">-f</span> FILE <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token punctuation">[</span>LOOKUPS<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<ul>
<li><p>-e：修改</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">echo</span> <span class="token string">'&#123;"name":"trent","age":38&#125;'</span> <span class="token operator">|</span> json <span class="token parameter variable">-e</span> <span class="token string">'this.age++'</span>
<span class="token punctuation">&#123;</span>
<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"trent"</span>,
<span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">39</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$json</span> <span class="token parameter variable">-I</span> <span class="token parameter variable">-f</span> tmp.json <span class="token parameter variable">-e</span> <span class="token string">'this.deploy.type="git"'</span></code></pre>
</li>
<li><p>-c：添加</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">json <span class="token parameter variable">-I</span> <span class="token parameter variable">-f</span> tmp.json <span class="token parameter variable">-c</span> <span class="token string">'this.deploy.branch="main"'</span></code></pre></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">配置清单示例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-14 19:11:42" itemprop="dateCreated datePublished" datetime="2021-03-14T19:11:42+08:00">2021-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>资源清单是 yml 格式，api-server 会自动转成 json 格式</p>
<p>每个 API 对象都有 3 大类属性：元数据 metadata、规范 spec 和状态 status</p>
<p>spec 是期望状态，status 是实际状态，如果实际状态和期望状态有出入，控制器（通常是 deployment 控制器）的控制循环就会监控到差异，然后将需要做出的更改提交到 apiserver，调度器 scheduler 监控到 apiserver 中有未执行的操作，就会去找适合执行操作的 node，然后提交到 apiserver，kubelet 监控到 apiserver 中有关于自己节点的操作，就会执行操作，将执行结果返回给 apiserver，apiserver 再更新实际状态</p>
<h2 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h2><pre class="language-yaml" data-language="yaml"><code class="language-yaml"></code></pre>

<h2 id="HorizontalPodAutoscaler"><a href="#HorizontalPodAutoscaler" class="headerlink" title="HorizontalPodAutoscaler"></a>HorizontalPodAutoscaler</h2><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> linux42
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>app1<span class="token punctuation">-</span>podautoscaler
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>app1 <span class="token comment">#自定义app标签</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> v2beta1 <span class="token comment">#自定义version标签</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 对象具体信息</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span> <span class="token comment">#定义水平伸缩的目标对象：Deployment、ReplicationController/ReplicaSet</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment">#目标对象类型为deployment</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment">#API版本</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>app1<span class="token punctuation">-</span>deployment <span class="token comment">#deployment的名称</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment">#最小pod数</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment">#最大pod数</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span> <span class="token comment">#需要安装metrics server</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource <span class="token comment"># 类型为资源</span>
      <span class="token key atrule">resource</span><span class="token punctuation">:</span> <span class="token comment"># 定义资源</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
        <span class="token key atrule">targetAverageUtilization</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#CPU使用率，超过80%就增加pod</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> memory
        <span class="token key atrule">targetAverageValue</span><span class="token punctuation">:</span> 1024Mi <span class="token comment"># 内存使用量，超过1024Mi就增加pod</span></code></pre>

<h2 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h2><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test</code></pre>

<h2 id="Nginx-业务-yaml-文件"><a href="#Nginx-业务-yaml-文件" class="headerlink" title="Nginx 业务 yaml 文件"></a>Nginx 业务 yaml 文件</h2><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1 <span class="token comment"># API版本</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># deployment元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment <span class="token comment"># deployment名称，创建后的pdo名称是这个名称加随机字符串</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test <span class="token comment"># pod的namespace，默认是default</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment"># 自定义deployment标签</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>label
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># deployment的详细信息</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 创建出的pod的副本数，即多少个pod，默认值为1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># Deployment如何查找要管理的Pods，它必须与pod模板的标签相匹配</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># 定义匹配Pod的标签，pod模板的标签相匹配</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>selector <span class="token comment"># 就是下面的 template.metadata.labels.app</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 定义模板，必须定义，用于描述要创建的pod</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># pod元数据</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment"># 自定义pod的标签，主要用于service匹配</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>selector <span class="token comment"># 自定义app标签</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># pod详细信息</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># pod中容器列表，可以多个，至少一个，绝大部分情况是一个，pod不能动态增减容器</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>container <span class="token comment"># 容器名称</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span>
            harbor.magedu.net/test/nginx<span class="token punctuation">-</span>web1<span class="token punctuation">:</span>v1 <span class="token comment"># 镜像地址</span>
            <span class="token comment"># command: ["/apps/tomcat/bin/run_tomcat.sh"]     # 容器启动执行的命令或脚本</span>
            <span class="token comment"># imagePullPolicy: IfNotPresent</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always <span class="token comment"># 拉取镜像策略</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 定义容器端口列表</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http <span class="token comment"># 端口名称</span>
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https <span class="token comment"># 端口名称</span>
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">env</span><span class="token punctuation">:</span> <span class="token comment"># 配置环境变量</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"password"</span> <span class="token comment"># 变量名称。必须要用引号引起来</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"age"</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"18"</span>
          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 对资源的请求设置和限制设置</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span> <span class="token comment"># 资源限制设置上限</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># cpu的限制，单位为core数，可以写0.5或者500m等CPU压缩值</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi <span class="token comment"># 内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># 资源请求的设置</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># cpu请求数，容器启动的初始可用数量,可以写0.5或者500m等CPU压缩值</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi <span class="token comment"># 内存请求大小，容器启动的初始可用数量，用于调度pod时候使用</span>
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1 <span class="token comment"># API版本</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># service元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>spec <span class="token comment"># service的名称，此名称会被DNS解析</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test <span class="token comment"># 该service隶属于的namespaces名称，即把service创建到哪个namespace里面</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment"># 自定义service标签</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># service的详细信息</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># service的类型，定义服务的访问方式，默认为ClusterIP</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 定义访问端口</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http <span class="token comment"># 定义一个端口名称</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># service 80端口</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment"># 协议类型</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 目标pod的端口</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30001</span> <span class="token comment"># node节点暴露的端口</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30043</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># service的标签选择器，匹配Pod的标签</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>selector <span class="token comment"># 匹配定义了app标签且值为nginx-selector的Pod</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%B7%A5%E5%85%B7/windows/MasterPDFEditor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B7%A5%E5%85%B7/windows/MasterPDFEditor/" class="post-title-link" itemprop="url">MasterPDFEditor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-14 16:42:55" itemprop="dateCreated datePublished" datetime="2021-03-14T16:42:55+08:00">2021-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/windows/" itemprop="url" rel="index"><span itemprop="name">windows</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Master PDF Editor，强大的多功能 PDF 编辑器，轻松查看，创建，修改，批注，签名，扫描，OCR 和打印 PDF 文档。高级注释工具，可以添加任意便笺指示对象突出显示，加下划线和删除，而无需更改源 PDF 文件</p>
<h2 id="添加目录"><a href="#添加目录" class="headerlink" title="添加目录"></a>添加目录</h2><p>左键选中文字，右键添加书签</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615711680248.png"></p>
<h2 id="批量去除水印"><a href="#批量去除水印" class="headerlink" title="批量去除水印"></a>批量去除水印</h2><p><img data-src="//img.to2b.cn/blog/ljk/1615712186839.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/" class="post-title-link" itemprop="url">网络模型与网络策略</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-12 00:49:04" itemprop="dateCreated datePublished" datetime="2021-03-12T00:49:04+08:00">2021-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="VXLAN"><a href="#VXLAN" class="headerlink" title="VXLAN"></a>VXLAN</h2><p>vxlan 是属于 overlay 中的一种隧道封装技术，实际上将 L2(数据链路层)的以太网帧封装成 L4(传输层)的 UDP 数据报文，然后在 L3 网络层传输，最终实现的效果就类似于在 L2 的以太网传输报文一样，但是不受 L3 网络层限制</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">为什么是在L3传输？
因为传输是基于路由表，路由只涉及ip，不涉及端口</code></pre>

<p>vxlan 标志位有 24 位，可以划分 2^24 个虚拟局域网</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615481012212.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615485312659.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615564694360.png"></p>
<pre class="language-none"><code class="language-none">1. 感觉封装UDP是多余的，只靠IP也能通信
因为Vxlan的封装思维是将原始数据报文当做用户数据包，VTEP当做大二层接入，那么VTEP会依次进行传输层封装，网络层封装，以太网头部封装，如果直接进行IP封装则跳过了传输层的封装过程，会在传输的过程中遇到一些困难，很多数据中心里都会有大量的冗余链路，交换机面对多条等价路径时会进行基于五元组进行HASH,此时会出现问题；其次，在遇到NAT设备时，无法穿透也会造成影响

2. 为什么封装成UDP，而不是TCP
因为封装UDP开销比较小，至于TCP比UDP更可靠，但是依靠原始数据报文的TCP也可以实现可靠性的要求</code></pre>

<h2 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h2><h3 id="docker-的网络模型"><a href="#docker-的网络模型" class="headerlink" title="docker 的网络模型"></a>docker 的网络模型</h3><ul>
<li>Bridge：桥接</li>
<li>Host：主机</li>
<li>Container：容器</li>
</ul>
<h3 id="kubernetes-网络模型"><a href="#kubernetes-网络模型" class="headerlink" title="kubernetes 网络模型"></a>kubernetes 网络模型</h3><p>kubernetes 的网络模型主要用于解决四类通信需求</p>
<h4 id="Pod-内通信"><a href="#Pod-内通信" class="headerlink" title="Pod 内通信"></a>Pod 内通信</h4><p>命名空间：linux 底层概念，在内核层实现，容器使用 namespce 技术实现容器间相互隔离</p>
<ul>
<li>mnt namespace：隔离根，即 chroot 技术</li>
<li>ipc namespace：隔离进程间通信</li>
<li>uts namespace：隔离系统信息，主机名等信息</li>
<li>pid namespace：隔离进程号</li>
<li>net namespace：隔离网络</li>
<li>user namespce：隔离用户</li>
</ul>
<p>运行在同一个 pod 内的容器，共享 net、ipc、uts、一组存储卷，亲密关系，同进同退</p>
<img data-src="//img.to2b.cn/blog/ljk/same-pod.gif" style="zoom: 67%;" />

<h4 id="Pod-间通信-★★★"><a href="#Pod-间通信-★★★" class="headerlink" title="Pod 间通信 ★★★"></a>Pod 间通信 ★★★</h4><p>网络模型：<strong>所有 Pod 在一个平面网络中，每个 Pod 拥有一个集群全局唯一的地址，可直接与其他 Pod 通信</strong></p>
<p>k8s 设计了网络模型，但将其实现交给网络插件，主流的网络插件有：flannel、calico、kube-router 等</p>
<h5 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h5><p>早期版本的 Flannel 使用 UDP 封装完成报文的跨越主机转发，其安全性及性能略有不足，现在已经废弃这种方式了，现在只能通过 vxlan 或 host-gw 进行通信</p>
<ul>
<li><p>flannel VXLAN 后端：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615534030113.png"></p>
</li>
<li><p>flannel VXLAN Direct Routing 后端：</p>
<p>Directrouting 为在同一个二层网络中的 node 节点启用直接路由机制，类似于 host-gw 模式</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615534089377.png"></p>
</li>
<li><p>host-gw 后端：</p>
<p>类似 calico，通过路由表完成报文转发</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615563474041.png"></p>
</li>
</ul>
<h5 id="calico"><a href="#calico" class="headerlink" title="calico"></a>calico</h5><p>Calico 本身是一个三层的虚拟网络方案，它将每个节点都当作路由器（router），将每个节点的容器都当作是“节点路由器”的一个终端并为其分配一个 IP 地址，各节点路由器通过<strong>BGP</strong>（BorderGateway Protocol）学习生成路由规则，从而将不同节点上的容器连接起来</p>
<img data-src="//img.to2b.cn/blog/ljk/1615560029213.png" style="zoom: 45%;" />

<p>BGP 是互联网上一个核心的去中心化自治路由协议，性能非常高，需要物理路由器的支持，这也是公有云不提供 calico 的原因，因为公有云上节点连接的都是虚拟路由器</p>
<p>calico 核心组件：</p>
<ul>
<li>Felix：calico 的 agent，维护路由规则、汇报当前节点状态</li>
<li>Etcd：路由规则储存在 etcd</li>
<li>BGP Client：运行在每个 node 上，负责监听由 felix 生成的路由信息，然后通过 BGP 协议广播至其他 node 节点，其他 node 的 Felix 会自动更新路由规则，从而实现路由的相互学习</li>
<li>Route Reflector：集中式的路由反射器，维护全网的路由规则，替换路由广播，如果节点非常多，可以考虑使用</li>
</ul>
<p>BGP 模式下 calico 的通信过程：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># traceroute命令查看请求ip为10.10.74.193的pod</span>
/ $ <span class="token function">traceroute</span> <span class="token number">10.10</span>.74.193
<span class="token function">traceroute</span> to <span class="token number">10.10</span>.74.193 <span class="token punctuation">(</span><span class="token number">10.10</span>.74.193<span class="token punctuation">)</span>, <span class="token number">30</span> hops max, <span class="token number">46</span> byte packets
 <span class="token number">1</span>  <span class="token number">10.0</span>.1.32 <span class="token punctuation">(</span><span class="token number">10.0</span>.1.32<span class="token punctuation">)</span>  <span class="token number">0.005</span> ms  <span class="token number">0.006</span> ms  <span class="token number">0.002</span> ms		<span class="token comment"># 当前pod所在节点的ip</span>
 <span class="token number">2</span>  <span class="token number">10.0</span>.1.33 <span class="token punctuation">(</span><span class="token number">10.0</span>.1.33<span class="token punctuation">)</span>  <span class="token number">1.220</span> ms  <span class="token number">0.254</span> ms  <span class="token number">0.147</span> ms		<span class="token comment"># 对方pod所在节点的ip</span>
 <span class="token number">3</span>  <span class="token number">10.10</span>.74.193 <span class="token punctuation">(</span><span class="token number">10.10</span>.74.193<span class="token punctuation">)</span>  <span class="token number">0.207</span> ms  <span class="token number">0.308</span> ms  <span class="token number">0.163</span> ms	<span class="token comment"># 对方pod的ip</span></code></pre>

<p>如果 node 需要跨网段通信，Calico 也提供了<strong>IPIP</strong>模式，IPIP 模式下，calico 会在每个节点上创建一个 tunl0 接口（TUN 类型虚拟设备）用于封装三层隧道报文。节点上每创建一个 Pod 资源，都自动创建一对虚拟以太网接口（TAP 类型的虚拟设备），其中一个附加于 Pod 的网络名称空间，另一个（名称以 cali 为前缀后跟随机字串）留置在节点的根网络名称空间，并经由 tunl0 封装或解封三层隧道报文，Calico IPIP 模式如下图：</p>
<img data-src="//img.to2b.cn/blog/ljk/1615539857199.png" style="zoom:50%;" />

<p>IPIP 模式下 calico 的通信过程：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/ $ <span class="token function">traceroute</span> <span class="token number">10.10</span>.58.65		<span class="token comment"># 请求ip为10.10.58.65的pod</span>
<span class="token function">traceroute</span> to <span class="token number">10.10</span>.58.65 <span class="token punctuation">(</span><span class="token number">10.10</span>.58.65<span class="token punctuation">)</span>, <span class="token number">30</span> hops max, <span class="token number">46</span> byte packets
 <span class="token number">1</span>  <span class="token number">172.31</span>.6.210 <span class="token punctuation">(</span><span class="token number">172.31</span>.6.210<span class="token punctuation">)</span>  <span class="token number">0.004</span> ms  <span class="token number">0.004</span> ms  <span class="token number">0.002</span> ms	<span class="token comment"># 当前pod所在node地址</span>
 <span class="token number">2</span>  <span class="token number">10.10</span>.58.64 <span class="token punctuation">(</span><span class="token number">10.10</span>.58.64<span class="token punctuation">)</span>  <span class="token number">0.003</span> ms  <span class="token number">0.432</span> ms  <span class="token number">0.497</span> ms	<span class="token comment"># 对方pod所在node的tunl0地址</span>
 <span class="token number">3</span>  <span class="token number">10.10</span>.58.65 <span class="token punctuation">(</span><span class="token number">10.10</span>.58.65<span class="token punctuation">)</span>  <span class="token number">0.553</span> ms  <span class="token number">2.114</span> ms  <span class="token number">0.775</span> ms	<span class="token comment"># 对方pod地址</span></code></pre>

<p>BGP 模式则直接使用物理机作为虚拟路由路（vRouter），请求直接通过路由跳转，不再创建额外的 tunnel，没有 tunnel 封装、解封的步骤，所以 BGP 的性能会比 IPIP 高很多，建议禁用 IPIP</p>
<h4 id="Service-与-Pod-通信"><a href="#Service-与-Pod-通信" class="headerlink" title="Service 与 Pod 通信"></a>Service 与 Pod 通信</h4><p><img data-src="//img.to2b.cn/blog/ljk/1615539372246.png"></p>
<h4 id="集群外部与-Service-通信"><a href="#集群外部与-Service-通信" class="headerlink" title="集群外部与 Service 通信"></a>集群外部与 Service 通信</h4><p>请求流量首先到达外部负载均衡器，由其调度至某个工作节点之上，而后再由工作节点的 netfilter（kube-proxy）组件上的规则（iptables 或 ipvs）调度至某个目标 Pod 对象</p>
<p>集群外的流量先进入<strong>节点网络</strong>，再进入<strong>service 网络</strong>，最后进入<strong>pod 网络</strong></p>
<h2 id="网络策略"><a href="#网络策略" class="headerlink" title="网络策略"></a>网络策略</h2><p>网络策略（Network Policy）是用于控制分组的 Pod 资源彼此之间如何进行通信，以及分组的 Pod 资源如何与其他网络端点进行通信的规范。它用于为 Kubernetes 实现更为精细的流量控制，实现租户隔离机制。Kubernetes 使用标准的资源对象“NetworkPolicy”供管理员按需定义网络访问控制策略</p>
<p>Kubernetes 的网络策略功能由其所使用的网络插件实现，Calico、Canal 及 kube-router 支持网络策略，而 flannel 不支持</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/etcdctl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/etcdctl/" class="post-title-link" itemprop="url">etcdctl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-11 17:38:04" itemprop="dateCreated datePublished" datetime="2021-03-11T17:38:04+08:00">2021-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>etcdctl</code> is a command line client for <a target="_blank" rel="noopener" href="https://github.com/coreos/etcd">etcd</a>.</p>
<p>The v3 API is used by default on master branch. For the v2 API, make sure to set environment variable <code>ETCDCTL_API=2</code>. See also <a href="READMEv2.md">READMEv2</a>.</p>
<p>If using released versions earlier than v3.4, set <code>ETCDCTL_API=3</code> to use v3 API.</p>
<p>Global flags (e.g., <code>dial-timeout</code>, <code>--cacert</code>, <code>--cert</code>, <code>--key</code>) can be set with environment variables:</p>
<pre class="language-none"><code class="language-none">ETCDCTL_DIAL_TIMEOUT&#x3D;3s
ETCDCTL_CACERT&#x3D;&#x2F;tmp&#x2F;ca.pem
ETCDCTL_CERT&#x3D;&#x2F;tmp&#x2F;cert.pem
ETCDCTL_KEY&#x3D;&#x2F;tmp&#x2F;key.pem</code></pre>

<p>Prefix flag strings with <code>ETCDCTL_</code>, convert all letters to upper-case, and replace dash(<code>-</code>) with underscore(<code>_</code>). Note that the environment variables with the prefix <code>ETCDCTL_</code> can only be used with the etcdctl global flags. Also, the environment variable <code>ETCDCTL_API</code> is a special case variable for etcdctl internal use only.</p>
<h2 id="Key-value-commands"><a href="#Key-value-commands" class="headerlink" title="Key-value commands"></a>Key-value commands</h2><h3 id="PUT-options-lt-key-gt-lt-value-gt"><a href="#PUT-options-lt-key-gt-lt-value-gt" class="headerlink" title="PUT [options] &lt;key&gt; &lt;value&gt;"></a>PUT [options] &lt;key&gt; &lt;value&gt;</h3><p>PUT assigns the specified value with the specified key. If key already holds a value, it is overwritten.</p>
<p>RPC: Put</p>
<h4 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>lease – lease ID (in hexadecimal) to attach to the key.</p>
</li>
<li><p>prev-kv – return the previous key-value pair before modification.</p>
</li>
<li><p>ignore-value – updates the key using its current value.</p>
</li>
<li><p>ignore-lease – updates the key using its current lease.</p>
</li>
</ul>
<h4 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h4><p><code>OK</code></p>
<h4 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put foo bar <span class="token parameter variable">--lease</span><span class="token operator">=</span>1234abcd
<span class="token comment"># OK</span>
./etcdctl get foo
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
./etcdctl put foo --ignore-value <span class="token comment"># to detache lease</span>
<span class="token comment"># OK</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put foo bar <span class="token parameter variable">--lease</span><span class="token operator">=</span>1234abcd
<span class="token comment"># OK</span>
./etcdctl put foo bar1 --ignore-lease <span class="token comment"># to use existing lease 1234abcd</span>
<span class="token comment"># OK</span>
./etcdctl get foo
<span class="token comment"># foo</span>
<span class="token comment"># bar1</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put foo bar1 --prev-kv
<span class="token comment"># OK</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
./etcdctl get foo
<span class="token comment"># foo</span>
<span class="token comment"># bar1</span></code></pre>

<h4 id="Remarks"><a href="#Remarks" class="headerlink" title="Remarks"></a>Remarks</h4><p>If &lt;value&gt; isn’t given as command line argument, this command tries to read the value from standard input.</p>
<p>When &lt;value&gt; begins with ‘-‘, &lt;value&gt; is interpreted as a flag.<br>Insert ‘–’ for workaround:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put <span class="token operator">&lt;</span>key<span class="token operator">></span> -- <span class="token operator">&lt;</span>value<span class="token operator">></span>
./etcdctl put -- <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token operator">&lt;</span>value<span class="token operator">></span></code></pre>

<p>Providing &lt;value&gt; in a new line after using <code>carriage return</code> is not supported and etcdctl may hang in that case. For example, following case is not supported:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put <span class="token operator">&lt;</span>key<span class="token operator">></span><span class="token punctuation">\</span>r
<span class="token operator">&lt;</span>value<span class="token operator">></span></code></pre>

<p>A &lt;value&gt; can have multiple lines or spaces but it must be provided with a double-quote as demonstrated below:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put foo <span class="token string">"bar1 2 3"</span></code></pre>

<h3 id="GET-options-lt-key-gt-range-end"><a href="#GET-options-lt-key-gt-range-end" class="headerlink" title="GET [options] &lt;key&gt; [range_end]"></a>GET [options] &lt;key&gt; [range_end]</h3><p>GET gets the key or a range of keys [key, range_end) if range_end is given.</p>
<p>RPC: Range</p>
<h4 id="Options-1"><a href="#Options-1" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>hex – print out key and value as hex encode string</p>
</li>
<li><p>limit – maximum number of results</p>
</li>
<li><p>prefix – get keys by matching prefix</p>
</li>
<li><p>order – order of results; ASCEND or DESCEND</p>
</li>
<li><p>sort-by – sort target; CREATE, KEY, MODIFY, VALUE, or VERSION</p>
</li>
<li><p>rev – specify the kv revision</p>
</li>
<li><p>print-value-only – print only value when used with write-out&#x3D;simple</p>
</li>
<li><p>consistency – Linearizable(l) or Serializable(s)</p>
</li>
<li><p>from-key – Get keys that are greater than or equal to the given key using byte compare</p>
</li>
<li><p>keys-only – Get only the keys</p>
</li>
</ul>
<h4 id="Output-1"><a href="#Output-1" class="headerlink" title="Output"></a>Output</h4><p>&lt;key&gt;\n&lt;value&gt;\n&lt;next_key&gt;\n&lt;next_value&gt;…</p>
<h4 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a>Examples</h4><p>First, populate etcd with some keys:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put foo bar
<span class="token comment"># OK</span>
./etcdctl put foo1 bar1
<span class="token comment"># OK</span>
./etcdctl put foo2 bar2
<span class="token comment"># OK</span>
./etcdctl put foo3 bar3
<span class="token comment"># OK</span></code></pre>

<p>Get the key named <code>foo</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl get foo
<span class="token comment"># foo</span>
<span class="token comment"># bar</span></code></pre>

<p>Get all keys:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl get --from-key <span class="token string">''</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
<span class="token comment"># foo1</span>
<span class="token comment"># bar1</span>
<span class="token comment"># foo2</span>
<span class="token comment"># foo2</span>
<span class="token comment"># foo3</span>
<span class="token comment"># bar3</span></code></pre>

<p>Get all keys with names greater than or equal to <code>foo1</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl get --from-key foo1
<span class="token comment"># foo1</span>
<span class="token comment"># bar1</span>
<span class="token comment"># foo2</span>
<span class="token comment"># bar2</span>
<span class="token comment"># foo3</span>
<span class="token comment"># bar3</span></code></pre>

<p>Get keys with names greater than or equal to <code>foo1</code> and less than <code>foo3</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl get foo1 foo3
<span class="token comment"># foo1</span>
<span class="token comment"># bar1</span>
<span class="token comment"># foo2</span>
<span class="token comment"># bar2</span></code></pre>

<h4 id="Remarks-1"><a href="#Remarks-1" class="headerlink" title="Remarks"></a>Remarks</h4><p>If any key or value contains non-printable characters or control characters, simple formatted output can be ambiguous due to new lines. To resolve this issue, set <code>--hex</code> to hex encode all strings.</p>
<h3 id="DEL-options-lt-key-gt-range-end"><a href="#DEL-options-lt-key-gt-range-end" class="headerlink" title="DEL [options] &lt;key&gt; [range_end]"></a>DEL [options] &lt;key&gt; [range_end]</h3><p>Removes the specified key or range of keys [key, range_end) if range_end is given.</p>
<p>RPC: DeleteRange</p>
<h4 id="Options-2"><a href="#Options-2" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>prefix – delete keys by matching prefix</p>
</li>
<li><p>prev-kv – return deleted key-value pairs</p>
</li>
<li><p>from-key – delete keys that are greater than or equal to the given key using byte compare</p>
</li>
</ul>
<h4 id="Output-2"><a href="#Output-2" class="headerlink" title="Output"></a>Output</h4><p>Prints the number of keys that were removed in decimal if DEL succeeded.</p>
<h4 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put foo bar
<span class="token comment"># OK</span>
./etcdctl del foo
<span class="token comment"># 1</span>
./etcdctl get foo</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put key val
<span class="token comment"># OK</span>
./etcdctl del --prev-kv key
<span class="token comment"># 1</span>
<span class="token comment"># key</span>
<span class="token comment"># val</span>
./etcdctl get key</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put a <span class="token number">123</span>
<span class="token comment"># OK</span>
./etcdctl put b <span class="token number">456</span>
<span class="token comment"># OK</span>
./etcdctl put z <span class="token number">789</span>
<span class="token comment"># OK</span>
./etcdctl del --from-key a
<span class="token comment"># 3</span>
./etcdctl get --from-key a</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl put zoo val
<span class="token comment"># OK</span>
./etcdctl put zoo1 val1
<span class="token comment"># OK</span>
./etcdctl put zoo2 val2
<span class="token comment"># OK</span>
./etcdctl del <span class="token parameter variable">--prefix</span> zoo
<span class="token comment"># 3</span>
./etcdctl get zoo2</code></pre>

<h3 id="TXN-options"><a href="#TXN-options" class="headerlink" title="TXN [options]"></a>TXN [options]</h3><p>TXN reads multiple etcd requests from standard input and applies them as a single atomic transaction.<br>A transaction consists of list of conditions, a list of requests to apply if all the conditions are true, and a list of requests to apply if any condition is false.</p>
<p>RPC: Txn</p>
<h4 id="Options-3"><a href="#Options-3" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>hex – print out keys and values as hex encoded strings.</p>
</li>
<li><p>interactive – input transaction with interactive prompting.</p>
</li>
</ul>
<h4 id="Input-Format"><a href="#Input-Format" class="headerlink" title="Input Format"></a>Input Format</h4><pre class="language-ebnf" data-language="ebnf"><code class="language-ebnf">&lt;<span class="token rule">Txn</span>> ::<span class="token operator">=</span> &lt;<span class="token rule">CMP</span>><span class="token operator">*</span> <span class="token string">"\n"</span> &lt;<span class="token rule">THEN</span>> <span class="token string">"\n"</span> &lt;<span class="token rule">ELSE</span>> <span class="token string">"\n"</span>
&lt;<span class="token rule">CMP</span>> ::<span class="token operator">=</span> <span class="token punctuation">(</span>&lt;<span class="token rule">CMPCREATE</span>><span class="token operator">|</span>&lt;<span class="token rule">CMPMOD</span>><span class="token operator">|</span>&lt;<span class="token rule">CMPVAL</span>><span class="token operator">|</span>&lt;<span class="token rule">CMPVER</span>><span class="token operator">|</span>&lt;<span class="token rule">CMPLEASE</span>><span class="token punctuation">)</span> <span class="token string">"\n"</span>
&lt;<span class="token rule">CMPOP</span>> ::<span class="token operator">=</span> <span class="token string">"&lt;"</span> <span class="token operator">|</span> <span class="token string">"="</span> <span class="token operator">|</span> <span class="token string">">"</span>
&lt;<span class="token rule">CMPCREATE</span>> :<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"c"</span><span class="token operator">|</span><span class="token string">"create"</span><span class="token punctuation">)</span><span class="token string">"("</span>&lt;<span class="token rule">KEY</span>><span class="token string">")"</span> &lt;<span class="token rule">CMPOP</span>> &lt;<span class="token rule">REVISION</span>>
&lt;<span class="token rule">CMPMOD</span>> ::<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"m"</span><span class="token operator">|</span><span class="token string">"mod"</span><span class="token punctuation">)</span><span class="token string">"("</span>&lt;<span class="token rule">KEY</span>><span class="token string">")"</span> &lt;<span class="token rule">CMPOP</span>> &lt;<span class="token rule">REVISION</span>>
&lt;<span class="token rule">CMPVAL</span>> ::<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"val"</span><span class="token operator">|</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token string">"("</span>&lt;<span class="token rule">KEY</span>><span class="token string">")"</span> &lt;<span class="token rule">CMPOP</span>> &lt;<span class="token rule">VALUE</span>>
&lt;<span class="token rule">CMPVER</span>> ::<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"ver"</span><span class="token operator">|</span><span class="token string">"version"</span><span class="token punctuation">)</span><span class="token string">"("</span>&lt;<span class="token rule">KEY</span>><span class="token string">")"</span> &lt;<span class="token rule">CMPOP</span>> &lt;<span class="token rule">VERSION</span>>
&lt;<span class="token rule">CMPLEASE</span>> ::<span class="token operator">=</span> <span class="token string">"lease("</span>&lt;<span class="token rule">KEY</span>><span class="token string">")"</span> &lt;<span class="token rule">CMPOP</span>> &lt;<span class="token rule">LEASE</span>>
&lt;<span class="token rule">THEN</span>> ::<span class="token operator">=</span> &lt;<span class="token rule">OP</span>><span class="token operator">*</span>
&lt;<span class="token rule">ELSE</span>> ::<span class="token operator">=</span> &lt;<span class="token rule">OP</span>><span class="token operator">*</span>
&lt;<span class="token rule">OP</span>> ::<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token rule">see put</span><span class="token punctuation">,</span> <span class="token rule">get</span><span class="token punctuation">,</span> <span class="token rule">del etcdctl command syntax</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token string">"\n"</span>
&lt;<span class="token rule">KEY</span>> ::<span class="token operator">=</span> <span class="token punctuation">(</span>%<span class="token rule">q formatted string</span><span class="token punctuation">)</span>
&lt;<span class="token rule">VALUE</span>> ::<span class="token operator">=</span> <span class="token punctuation">(</span>%<span class="token rule">q formatted string</span><span class="token punctuation">)</span>
&lt;<span class="token rule">REVISION</span>> ::<span class="token operator">=</span> <span class="token string">"\"</span><span class="token string">"[0-9]+"</span>\<span class="token string">""</span>
&lt;<span class="token rule">VERSION</span>> ::<span class="token operator">=</span> <span class="token string">"\"</span><span class="token string">"[0-9]+"</span>\<span class="token string">""</span>
&lt;<span class="token rule">LEASE</span>> ::<span class="token operator">=</span> <span class="token string">"\"</span><span class="token string">"[0-9]+\"</span>"</code></pre>

<h4 id="Output-3"><a href="#Output-3" class="headerlink" title="Output"></a>Output</h4><p><code>SUCCESS</code> if etcd processed the transaction success list, <code>FAILURE</code> if etcd processed the transaction failure list. Prints the output for each command in the executed request list, each separated by a blank line.</p>
<h4 id="Examples-3"><a href="#Examples-3" class="headerlink" title="Examples"></a>Examples</h4><p>txn in interactive mode:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl txn <span class="token parameter variable">-i</span>
<span class="token comment"># compares:</span>
mod<span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token string">"0"</span>

<span class="token comment"># success requests (get, put, delete):</span>
put key1 <span class="token string">"overwrote-key1"</span>

<span class="token comment"># failure requests (get, put, delete):</span>
put key1 <span class="token string">"created-key1"</span>
put key2 <span class="token string">"some extra key"</span>

<span class="token comment"># FAILURE</span>

<span class="token comment"># OK</span>

<span class="token comment"># OK</span></code></pre>

<p>txn in non-interactive mode:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl txn <span class="token operator">&lt;&lt;&lt;</span><span class="token string">'mod("key1") > "0"

put key1 "overwrote-key1"

put key1 "created-key1"
put key2 "some extra key"

'</span>

<span class="token comment"># FAILURE</span>

<span class="token comment"># OK</span>

<span class="token comment"># OK</span></code></pre>

<h4 id="Remarks-2"><a href="#Remarks-2" class="headerlink" title="Remarks"></a>Remarks</h4><p>When using multi-line values within a TXN command, newlines must be represented as <code>\n</code>. Literal newlines will cause parsing failures. This differs from other commands (such as PUT) where the shell will convert literal newlines for us. For example:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl txn <span class="token operator">&lt;&lt;&lt;</span><span class="token string">'mod("key1") > "0"

put key1 "overwrote-key1"

put key1 "created-key1"
put key2 "this is\na multi-line\nvalue"

'</span>

<span class="token comment"># FAILURE</span>

<span class="token comment"># OK</span>

<span class="token comment"># OK</span></code></pre>

<h3 id="COMPACTION-options-lt-revision-gt"><a href="#COMPACTION-options-lt-revision-gt" class="headerlink" title="COMPACTION [options] &lt;revision&gt;"></a>COMPACTION [options] &lt;revision&gt;</h3><p>COMPACTION discards all etcd event history prior to a given revision. Since etcd uses a multiversion concurrency control<br>model, it preserves all key updates as event history. When the event history up to some revision is no longer needed,<br>all superseded keys may be compacted away to reclaim storage space in the etcd backend database.</p>
<p>RPC: Compact</p>
<h4 id="Options-4"><a href="#Options-4" class="headerlink" title="Options"></a>Options</h4><ul>
<li>physical – ‘true’ to wait for compaction to physically remove all old revisions</li>
</ul>
<h4 id="Output-4"><a href="#Output-4" class="headerlink" title="Output"></a>Output</h4><p>Prints the compacted revision.</p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl compaction <span class="token number">1234</span>
<span class="token comment"># compacted revision 1234</span></code></pre>

<h3 id="WATCH-options-key-or-prefix-range-end-–-exec-command-arg1-arg2-…"><a href="#WATCH-options-key-or-prefix-range-end-–-exec-command-arg1-arg2-…" class="headerlink" title="WATCH [options] [key or prefix] [range_end] [–] [exec-command arg1 arg2 …]"></a>WATCH [options] [key or prefix] [range_end] [–] [exec-command arg1 arg2 …]</h3><p>Watch watches events stream on keys or prefixes, [key or prefix, range_end) if range_end is given. The watch command runs until it encounters an error or is terminated by the user. If range_end is given, it must be lexicographically greater than key or “\x00”.</p>
<p>RPC: Watch</p>
<h4 id="Options-5"><a href="#Options-5" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>hex – print out key and value as hex encode string</p>
</li>
<li><p>interactive – begins an interactive watch session</p>
</li>
<li><p>prefix – watch on a prefix if prefix is set.</p>
</li>
<li><p>prev-kv – get the previous key-value pair before the event happens.</p>
</li>
<li><p>rev – the revision to start watching. Specifying a revision is useful for observing past events.</p>
</li>
</ul>
<h4 id="Input-format"><a href="#Input-format" class="headerlink" title="Input format"></a>Input format</h4><p>Input is only accepted for interactive mode.</p>
<pre class="language-none"><code class="language-none">watch [options] &lt;key or prefix&gt;\n</code></pre>

<h4 id="Output-5"><a href="#Output-5" class="headerlink" title="Output"></a>Output</h4><p>&lt;event&gt;[\n&lt;old_key&gt;\n&lt;old_value&gt;]\n&lt;key&gt;\n&lt;value&gt;\n&lt;event&gt;\n&lt;next_key&gt;\n&lt;next_value&gt;\n…</p>
<h4 id="Examples-4"><a href="#Examples-4" class="headerlink" title="Examples"></a>Examples</h4><h5 id="Non-interactive"><a href="#Non-interactive" class="headerlink" title="Non-interactive"></a>Non-interactive</h5><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token function">watch</span> foo
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ETCDCTL_WATCH_KEY</span><span class="token operator">=</span>foo ./etcdctl <span class="token function">watch</span>
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span></code></pre>

<p>Receive events and execute <code>echo watch event received</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token function">watch</span> foo -- <span class="token builtin class-name">echo</span> <span class="token function">watch</span> event received
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
<span class="token comment"># watch event received</span></code></pre>

<p>Watch response is set via <code>ETCD_WATCH_*</code> environmental variables:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token function">watch</span> foo -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">"env | grep ETCD_WATCH_"</span>

<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
<span class="token comment"># ETCD_WATCH_REVISION=11</span>
<span class="token comment"># ETCD_WATCH_KEY="foo"</span>
<span class="token comment"># ETCD_WATCH_EVENT_TYPE="PUT"</span>
<span class="token comment"># ETCD_WATCH_VALUE="bar"</span></code></pre>

<p>Watch with environmental variables and execute <code>echo watch event received</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_WATCH_KEY</span><span class="token operator">=</span>foo
./etcdctl <span class="token function">watch</span> -- <span class="token builtin class-name">echo</span> <span class="token function">watch</span> event received
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
<span class="token comment"># watch event received</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_WATCH_KEY</span><span class="token operator">=</span>foo
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_WATCH_RANGE_END</span><span class="token operator">=</span>foox
./etcdctl <span class="token function">watch</span> -- <span class="token builtin class-name">echo</span> <span class="token function">watch</span> event received
<span class="token comment"># PUT</span>
<span class="token comment"># fob</span>
<span class="token comment"># bar</span>
<span class="token comment"># watch event received</span></code></pre>

<h5 id="Interactive"><a href="#Interactive" class="headerlink" title="Interactive"></a>Interactive</h5><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token function">watch</span> <span class="token parameter variable">-i</span>
<span class="token function">watch</span> foo
<span class="token function">watch</span> foo
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span></code></pre>

<p>Receive events and execute <code>echo watch event received</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token function">watch</span> <span class="token parameter variable">-i</span>
<span class="token function">watch</span> foo -- <span class="token builtin class-name">echo</span> <span class="token function">watch</span> event received
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
<span class="token comment"># watch event received</span></code></pre>

<p>Watch with environmental variables and execute <code>echo watch event received</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_WATCH_KEY</span><span class="token operator">=</span>foo
./etcdctl <span class="token function">watch</span> <span class="token parameter variable">-i</span>
<span class="token function">watch</span> -- <span class="token builtin class-name">echo</span> <span class="token function">watch</span> event received
<span class="token comment"># PUT</span>
<span class="token comment"># foo</span>
<span class="token comment"># bar</span>
<span class="token comment"># watch event received</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_WATCH_KEY</span><span class="token operator">=</span>foo
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_WATCH_RANGE_END</span><span class="token operator">=</span>foox
./etcdctl <span class="token function">watch</span> <span class="token parameter variable">-i</span>
<span class="token function">watch</span> -- <span class="token builtin class-name">echo</span> <span class="token function">watch</span> event received
<span class="token comment"># PUT</span>
<span class="token comment"># fob</span>
<span class="token comment"># bar</span>
<span class="token comment"># watch event received</span></code></pre>

<h3 id="LEASE-lt-subcommand-gt"><a href="#LEASE-lt-subcommand-gt" class="headerlink" title="LEASE &lt;subcommand&gt;"></a>LEASE &lt;subcommand&gt;</h3><p>LEASE provides commands for key lease management.</p>
<h3 id="LEASE-GRANT-lt-ttl-gt"><a href="#LEASE-GRANT-lt-ttl-gt" class="headerlink" title="LEASE GRANT &lt;ttl&gt;"></a>LEASE GRANT &lt;ttl&gt;</h3><p>LEASE GRANT creates a fresh lease with a server-selected time-to-live in seconds<br>greater than or equal to the requested TTL value.</p>
<p>RPC: LeaseGrant</p>
<h4 id="Output-6"><a href="#Output-6" class="headerlink" title="Output"></a>Output</h4><p>Prints a message with the granted lease ID.</p>
<h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lease grant <span class="token number">60</span>
<span class="token comment"># lease 32695410dcc0ca06 granted with TTL(60s)</span></code></pre>

<h3 id="LEASE-REVOKE-lt-leaseID-gt"><a href="#LEASE-REVOKE-lt-leaseID-gt" class="headerlink" title="LEASE REVOKE &lt;leaseID&gt;"></a>LEASE REVOKE &lt;leaseID&gt;</h3><p>LEASE REVOKE destroys a given lease, deleting all attached keys.</p>
<p>RPC: LeaseRevoke</p>
<h4 id="Output-7"><a href="#Output-7" class="headerlink" title="Output"></a>Output</h4><p>Prints a message indicating the lease is revoked.</p>
<h4 id="Example-2"><a href="#Example-2" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lease revoke 32695410dcc0ca06
<span class="token comment"># lease 32695410dcc0ca06 revoked</span></code></pre>

<h3 id="LEASE-TIMETOLIVE-lt-leaseID-gt-options"><a href="#LEASE-TIMETOLIVE-lt-leaseID-gt-options" class="headerlink" title="LEASE TIMETOLIVE &lt;leaseID&gt; [options]"></a>LEASE TIMETOLIVE &lt;leaseID&gt; [options]</h3><p>LEASE TIMETOLIVE retrieves the lease information with the given lease ID.</p>
<p>RPC: LeaseTimeToLive</p>
<h4 id="Options-6"><a href="#Options-6" class="headerlink" title="Options"></a>Options</h4><ul>
<li>keys – Get keys attached to this lease</li>
</ul>
<h4 id="Output-8"><a href="#Output-8" class="headerlink" title="Output"></a>Output</h4><p>Prints lease information.</p>
<h4 id="Example-3"><a href="#Example-3" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lease grant <span class="token number">500</span>
<span class="token comment"># lease 2d8257079fa1bc0c granted with TTL(500s)</span>

./etcdctl put foo1 bar <span class="token parameter variable">--lease</span><span class="token operator">=</span>2d8257079fa1bc0c
<span class="token comment"># OK</span>

./etcdctl put foo2 bar <span class="token parameter variable">--lease</span><span class="token operator">=</span>2d8257079fa1bc0c
<span class="token comment"># OK</span>

./etcdctl lease timetolive 2d8257079fa1bc0c
<span class="token comment"># lease 2d8257079fa1bc0c granted with TTL(500s), remaining(481s)</span>

./etcdctl lease timetolive 2d8257079fa1bc0c <span class="token parameter variable">--keys</span>
<span class="token comment"># lease 2d8257079fa1bc0c granted with TTL(500s), remaining(472s), attached keys([foo2 foo1])</span>

./etcdctl lease timetolive 2d8257079fa1bc0c --write-out<span class="token operator">=</span>json
<span class="token comment"># &#123;"cluster_id":17186838941855831277,"member_id":4845372305070271874,"revision":3,"raft_term":2,"id":3279279168933706764,"ttl":465,"granted-ttl":500,"keys":null&#125;</span>

./etcdctl lease timetolive 2d8257079fa1bc0c --write-out<span class="token operator">=</span>json <span class="token parameter variable">--keys</span>
<span class="token comment"># &#123;"cluster_id":17186838941855831277,"member_id":4845372305070271874,"revision":3,"raft_term":2,"id":3279279168933706764,"ttl":459,"granted-ttl":500,"keys":["Zm9vMQ==","Zm9vMg=="]&#125;</span>

./etcdctl lease timetolive 2d8257079fa1bc0c
<span class="token comment"># lease 2d8257079fa1bc0c already expired</span></code></pre>

<h3 id="LEASE-LIST"><a href="#LEASE-LIST" class="headerlink" title="LEASE LIST"></a>LEASE LIST</h3><p>LEASE LIST lists all active leases.</p>
<p>RPC: LeaseLeases</p>
<h4 id="Output-9"><a href="#Output-9" class="headerlink" title="Output"></a>Output</h4><p>Prints a message with a list of active leases.</p>
<h4 id="Example-4"><a href="#Example-4" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lease grant <span class="token number">60</span>
<span class="token comment"># lease 32695410dcc0ca06 granted with TTL(60s)</span>

./etcdctl lease list
32695410dcc0ca06</code></pre>

<h3 id="LEASE-KEEP-ALIVE-lt-leaseID-gt"><a href="#LEASE-KEEP-ALIVE-lt-leaseID-gt" class="headerlink" title="LEASE KEEP-ALIVE &lt;leaseID&gt;"></a>LEASE KEEP-ALIVE &lt;leaseID&gt;</h3><p>LEASE KEEP-ALIVE periodically refreshes a lease so it does not expire.</p>
<p>RPC: LeaseKeepAlive</p>
<h4 id="Output-10"><a href="#Output-10" class="headerlink" title="Output"></a>Output</h4><p>Prints a message for every keep alive sent or prints a message indicating the lease is gone.</p>
<h4 id="Example-5"><a href="#Example-5" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lease keep-alive 32695410dcc0ca0
<span class="token comment"># lease 32695410dcc0ca0 keepalived with TTL(100)</span>
<span class="token comment"># lease 32695410dcc0ca0 keepalived with TTL(100)</span>
<span class="token comment"># lease 32695410dcc0ca0 keepalived with TTL(100)</span>
<span class="token punctuation">..</span>.</code></pre>

<h2 id="Cluster-maintenance-commands"><a href="#Cluster-maintenance-commands" class="headerlink" title="Cluster maintenance commands"></a>Cluster maintenance commands</h2><h3 id="MEMBER-lt-subcommand-gt"><a href="#MEMBER-lt-subcommand-gt" class="headerlink" title="MEMBER &lt;subcommand&gt;"></a>MEMBER &lt;subcommand&gt;</h3><p>MEMBER provides commands for managing etcd cluster membership.</p>
<h3 id="MEMBER-ADD-lt-memberName-gt-options"><a href="#MEMBER-ADD-lt-memberName-gt-options" class="headerlink" title="MEMBER ADD &lt;memberName&gt; [options]"></a>MEMBER ADD &lt;memberName&gt; [options]</h3><p>MEMBER ADD introduces a new member into the etcd cluster as a new peer.</p>
<p>RPC: MemberAdd</p>
<h4 id="Options-7"><a href="#Options-7" class="headerlink" title="Options"></a>Options</h4><ul>
<li>peer-urls – comma separated list of URLs to associate with the new member.</li>
</ul>
<h4 id="Output-11"><a href="#Output-11" class="headerlink" title="Output"></a>Output</h4><p>Prints the member ID of the new member and the cluster ID.</p>
<h4 id="Example-6"><a href="#Example-6" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl member <span class="token function">add</span> newMember --peer-urls<span class="token operator">=</span>https://127.0.0.1:12345

Member ced000fda4d05edf added to cluster 8c4281cc65c7b112

<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">"newMember"</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">"newMember=https://127.0.0.1:12345,default=http://10.0.0.30:2380"</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">"existing"</span></code></pre>

<h3 id="MEMBER-UPDATE-lt-memberID-gt-options"><a href="#MEMBER-UPDATE-lt-memberID-gt-options" class="headerlink" title="MEMBER UPDATE &lt;memberID&gt; [options]"></a>MEMBER UPDATE &lt;memberID&gt; [options]</h3><p>MEMBER UPDATE sets the peer URLs for an existing member in the etcd cluster.</p>
<p>RPC: MemberUpdate</p>
<h4 id="Options-8"><a href="#Options-8" class="headerlink" title="Options"></a>Options</h4><ul>
<li>peer-urls – comma separated list of URLs to associate with the updated member.</li>
</ul>
<h4 id="Output-12"><a href="#Output-12" class="headerlink" title="Output"></a>Output</h4><p>Prints the member ID of the updated member and the cluster ID.</p>
<h4 id="Example-7"><a href="#Example-7" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl member update 2be1eb8f84b7f63e --peer-urls<span class="token operator">=</span>https://127.0.0.1:11112
<span class="token comment"># Member 2be1eb8f84b7f63e updated in cluster ef37ad9dc622a7c4</span></code></pre>

<h3 id="MEMBER-REMOVE-lt-memberID-gt"><a href="#MEMBER-REMOVE-lt-memberID-gt" class="headerlink" title="MEMBER REMOVE &lt;memberID&gt;"></a>MEMBER REMOVE &lt;memberID&gt;</h3><p>MEMBER REMOVE removes a member of an etcd cluster from participating in cluster consensus.</p>
<p>RPC: MemberRemove</p>
<h4 id="Output-13"><a href="#Output-13" class="headerlink" title="Output"></a>Output</h4><p>Prints the member ID of the removed member and the cluster ID.</p>
<h4 id="Example-8"><a href="#Example-8" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl member remove 2be1eb8f84b7f63e
<span class="token comment"># Member 2be1eb8f84b7f63e removed from cluster ef37ad9dc622a7c4</span></code></pre>

<h3 id="MEMBER-LIST"><a href="#MEMBER-LIST" class="headerlink" title="MEMBER LIST"></a>MEMBER LIST</h3><p>MEMBER LIST prints the member details for all members associated with an etcd cluster.</p>
<p>RPC: MemberList</p>
<h4 id="Output-14"><a href="#Output-14" class="headerlink" title="Output"></a>Output</h4><p>Prints a humanized table of the member IDs, statuses, names, peer addresses, and client addresses.</p>
<h4 id="Examples-5"><a href="#Examples-5" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl member list
<span class="token comment"># 8211f1d0f64f3269, started, infra1, http://127.0.0.1:12380, http://127.0.0.1:2379</span>
<span class="token comment"># 91bc3c398fb3c146, started, infra2, http://127.0.0.1:22380, http://127.0.0.1:22379</span>
<span class="token comment"># fd422379fda50e48, started, infra3, http://127.0.0.1:32380, http://127.0.0.1:32379</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">-w</span> json member list
<span class="token comment"># &#123;"header":&#123;"cluster_id":17237436991929493444,"member_id":9372538179322589801,"raft_term":2&#125;,"members":[&#123;"ID":9372538179322589801,"name":"infra1","peerURLs":["http://127.0.0.1:12380"],"clientURLs":["http://127.0.0.1:2379"]&#125;,&#123;"ID":10501334649042878790,"name":"infra2","peerURLs":["http://127.0.0.1:22380"],"clientURLs":["http://127.0.0.1:22379"]&#125;,&#123;"ID":18249187646912138824,"name":"infra3","peerURLs":["http://127.0.0.1:32380"],"clientURLs":["http://127.0.0.1:32379"]&#125;]&#125;</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">-w</span> table member list
+------------------+---------+--------+------------------------+------------------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span> STATUS  <span class="token operator">|</span>  NAME  <span class="token operator">|</span>       PEER ADDRS       <span class="token operator">|</span>      CLIENT ADDRS      <span class="token operator">|</span>
+------------------+---------+--------+------------------------+------------------------+
<span class="token operator">|</span> 8211f1d0f64f3269 <span class="token operator">|</span> started <span class="token operator">|</span> infra1 <span class="token operator">|</span> http://127.0.0.1:12380 <span class="token operator">|</span> http://127.0.0.1:2379  <span class="token operator">|</span>
<span class="token operator">|</span> 91bc3c398fb3c146 <span class="token operator">|</span> started <span class="token operator">|</span> infra2 <span class="token operator">|</span> http://127.0.0.1:22380 <span class="token operator">|</span> http://127.0.0.1:22379 <span class="token operator">|</span>
<span class="token operator">|</span> fd422379fda50e48 <span class="token operator">|</span> started <span class="token operator">|</span> infra3 <span class="token operator">|</span> http://127.0.0.1:32380 <span class="token operator">|</span> http://127.0.0.1:32379 <span class="token operator">|</span>
+------------------+---------+--------+------------------------+------------------------+</code></pre>

<h3 id="ENDPOINT-lt-subcommand-gt"><a href="#ENDPOINT-lt-subcommand-gt" class="headerlink" title="ENDPOINT &lt;subcommand&gt;"></a>ENDPOINT &lt;subcommand&gt;</h3><p>ENDPOINT provides commands for querying individual endpoints.</p>
<h4 id="Options-9"><a href="#Options-9" class="headerlink" title="Options"></a>Options</h4><ul>
<li>cluster – fetch and use all endpoints from the etcd cluster member list</li>
</ul>
<h3 id="ENDPOINT-HEALTH"><a href="#ENDPOINT-HEALTH" class="headerlink" title="ENDPOINT HEALTH"></a>ENDPOINT HEALTH</h3><p>ENDPOINT HEALTH checks the health of the list of endpoints with respect to cluster. An endpoint is unhealthy<br>when it cannot participate in consensus with the rest of the cluster.</p>
<h4 id="Output-15"><a href="#Output-15" class="headerlink" title="Output"></a>Output</h4><p>If an endpoint can participate in consensus, prints a message indicating the endpoint is healthy. If an endpoint fails to participate in consensus, prints a message indicating the endpoint is unhealthy.</p>
<h4 id="Example-9"><a href="#Example-9" class="headerlink" title="Example"></a>Example</h4><p>Check the default endpoint’s health:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl endpoint health
<span class="token comment"># 127.0.0.1:2379 is healthy: successfully committed proposal: took = 2.095242ms</span></code></pre>

<p>Check all endpoints for the cluster associated with the default endpoint:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl endpoint <span class="token parameter variable">--cluster</span> health
<span class="token comment"># http://127.0.0.1:2379 is healthy: successfully committed proposal: took = 1.060091ms</span>
<span class="token comment"># http://127.0.0.1:22379 is healthy: successfully committed proposal: took = 903.138µs</span>
<span class="token comment"># http://127.0.0.1:32379 is healthy: successfully committed proposal: took = 1.113848ms</span></code></pre>

<h3 id="ENDPOINT-STATUS"><a href="#ENDPOINT-STATUS" class="headerlink" title="ENDPOINT STATUS"></a>ENDPOINT STATUS</h3><p>ENDPOINT STATUS queries the status of each endpoint in the given endpoint list.</p>
<h4 id="Output-16"><a href="#Output-16" class="headerlink" title="Output"></a>Output</h4><h5 id="Simple-format"><a href="#Simple-format" class="headerlink" title="Simple format"></a>Simple format</h5><p>Prints a humanized table of each endpoint URL, ID, version, database size, leadership status, raft term, and raft status.</p>
<h5 id="JSON-format"><a href="#JSON-format" class="headerlink" title="JSON format"></a>JSON format</h5><p>Prints a line of JSON encoding each endpoint URL, ID, version, database size, leadership status, raft term, and raft status.</p>
<h4 id="Examples-6"><a href="#Examples-6" class="headerlink" title="Examples"></a>Examples</h4><p>Get the status for the default endpoint:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl endpoint status
<span class="token comment"># 127.0.0.1:2379, 8211f1d0f64f3269, 3.0.0, 25 kB, false, 2, 63</span></code></pre>

<p>Get the status for the default endpoint as JSON:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">-w</span> json endpoint status
<span class="token comment"># [&#123;"Endpoint":"127.0.0.1:2379","Status":&#123;"header":&#123;"cluster_id":17237436991929493444,"member_id":9372538179322589801,"revision":2,"raft_term":2&#125;,"version":"3.0.0","dbSize":24576,"leader":18249187646912138824,"raftIndex":32623,"raftTerm":2&#125;&#125;]</span></code></pre>

<p>Get the status for all endpoints in the cluster associated with the default endpoint:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">-w</span> table endpoint <span class="token parameter variable">--cluster</span> status
+------------------------+------------------+----------------+---------+-----------+-----------+------------+
<span class="token operator">|</span>        ENDPOINT        <span class="token operator">|</span>        ID        <span class="token operator">|</span>    VERSION     <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span>
+------------------------+------------------+----------------+---------+-----------+-----------+------------+
<span class="token operator">|</span> http://127.0.0.1:2379  <span class="token operator">|</span> 8211f1d0f64f3269 <span class="token operator">|</span> <span class="token number">3.2</span>.0-rc.1+git <span class="token operator">|</span>   <span class="token number">25</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">8</span> <span class="token operator">|</span>
<span class="token operator">|</span> http://127.0.0.1:22379 <span class="token operator">|</span> 91bc3c398fb3c146 <span class="token operator">|</span> <span class="token number">3.2</span>.0-rc.1+git <span class="token operator">|</span>   <span class="token number">25</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">8</span> <span class="token operator">|</span>
<span class="token operator">|</span> http://127.0.0.1:32379 <span class="token operator">|</span> fd422379fda50e48 <span class="token operator">|</span> <span class="token number">3.2</span>.0-rc.1+git <span class="token operator">|</span>   <span class="token number">25</span> kB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">8</span> <span class="token operator">|</span>
+------------------------+------------------+----------------+---------+-----------+-----------+------------+</code></pre>

<h3 id="ENDPOINT-HASHKV"><a href="#ENDPOINT-HASHKV" class="headerlink" title="ENDPOINT HASHKV"></a>ENDPOINT HASHKV</h3><p>ENDPOINT HASHKV fetches the hash of the key-value store of an endpoint.</p>
<h4 id="Output-17"><a href="#Output-17" class="headerlink" title="Output"></a>Output</h4><h5 id="Simple-format-1"><a href="#Simple-format-1" class="headerlink" title="Simple format"></a>Simple format</h5><p>Prints a humanized table of each endpoint URL and KV history hash.</p>
<h5 id="JSON-format-1"><a href="#JSON-format-1" class="headerlink" title="JSON format"></a>JSON format</h5><p>Prints a line of JSON encoding each endpoint URL and KV history hash.</p>
<h4 id="Examples-7"><a href="#Examples-7" class="headerlink" title="Examples"></a>Examples</h4><p>Get the hash for the default endpoint:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl endpoint hashkv
<span class="token comment"># 127.0.0.1:2379, 1084519789</span></code></pre>

<p>Get the status for the default endpoint as JSON:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">-w</span> json endpoint hashkv
<span class="token comment"># [&#123;"Endpoint":"127.0.0.1:2379","Hash":&#123;"header":&#123;"cluster_id":14841639068965178418,"member_id":10276657743932975437,"revision":1,"raft_term":3&#125;,"hash":1084519789,"compact_revision":-1&#125;&#125;]</span></code></pre>

<p>Get the status for all endpoints in the cluster associated with the default endpoint:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">-w</span> table endpoint <span class="token parameter variable">--cluster</span> hashkv
+------------------------+------------+
<span class="token operator">|</span>        ENDPOINT        <span class="token operator">|</span>    HASH    <span class="token operator">|</span>
+------------------------+------------+
<span class="token operator">|</span> http://127.0.0.1:2379  <span class="token operator">|</span> <span class="token number">1084519789</span> <span class="token operator">|</span>
<span class="token operator">|</span> http://127.0.0.1:22379 <span class="token operator">|</span> <span class="token number">1084519789</span> <span class="token operator">|</span>
<span class="token operator">|</span> http://127.0.0.1:32379 <span class="token operator">|</span> <span class="token number">1084519789</span> <span class="token operator">|</span>
+------------------------+------------+</code></pre>

<h3 id="ALARM-lt-subcommand-gt"><a href="#ALARM-lt-subcommand-gt" class="headerlink" title="ALARM &lt;subcommand&gt;"></a>ALARM &lt;subcommand&gt;</h3><p>Provides alarm related commands</p>
<h3 id="ALARM-DISARM"><a href="#ALARM-DISARM" class="headerlink" title="ALARM DISARM"></a>ALARM DISARM</h3><p><code>alarm disarm</code> Disarms all alarms</p>
<p>RPC: Alarm</p>
<h4 id="Output-18"><a href="#Output-18" class="headerlink" title="Output"></a>Output</h4><p><code>alarm:&lt;alarm type&gt;</code> if alarm is present and disarmed.</p>
<h4 id="Examples-8"><a href="#Examples-8" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl alarm disarm</code></pre>

<p>If NOSPACE alarm is present:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl alarm disarm
<span class="token comment"># alarm:NOSPACE</span></code></pre>

<h3 id="ALARM-LIST"><a href="#ALARM-LIST" class="headerlink" title="ALARM LIST"></a>ALARM LIST</h3><p><code>alarm list</code> lists all alarms.</p>
<p>RPC: Alarm</p>
<h4 id="Output-19"><a href="#Output-19" class="headerlink" title="Output"></a>Output</h4><p><code>alarm:&lt;alarm type&gt;</code> if alarm is present, empty string if no alarms present.</p>
<h4 id="Examples-9"><a href="#Examples-9" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl alarm list</code></pre>

<p>If NOSPACE alarm is present:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl alarm list
<span class="token comment"># alarm:NOSPACE</span></code></pre>

<h3 id="DEFRAG-options"><a href="#DEFRAG-options" class="headerlink" title="DEFRAG [options]"></a>DEFRAG [options]</h3><p>DEFRAG defragments the backend database file for a set of given endpoints while etcd is running, or directly defragments an etcd data directory while etcd is not running. When an etcd member reclaims storage space from deleted and compacted keys, the space is kept in a free list and the database file remains the same size. By defragmenting the database, the etcd member releases this free space back to the file system.</p>
<p><strong>Note that defragmentation to a live member blocks the system from reading and writing data while rebuilding its states.</strong></p>
<p><strong>Note that defragmentation request does not get replicated over cluster. That is, the request is only applied to the local node. Specify all members in <code>--endpoints</code> flag or <code>--cluster</code> flag to automatically find all cluster members.</strong></p>
<h4 id="Options-10"><a href="#Options-10" class="headerlink" title="Options"></a>Options</h4><ul>
<li>data-dir – Optional. If present, defragments a data directory not in use by etcd.</li>
</ul>
<h4 id="Output-20"><a href="#Output-20" class="headerlink" title="Output"></a>Output</h4><p>For each endpoints, prints a message indicating whether the endpoint was successfully defragmented.</p>
<h4 id="Example-10"><a href="#Example-10" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span>localhost:2379,badendpoint:2379 defrag
<span class="token comment"># Finished defragmenting etcd member[localhost:2379]</span>
<span class="token comment"># Failed to defragment etcd member[badendpoint:2379] (grpc: timed out trying to connect)</span></code></pre>

<p>Run defragment operations for all endpoints in the cluster associated with the default endpoint:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl defrag <span class="token parameter variable">--cluster</span>
Finished defragmenting etcd member<span class="token punctuation">[</span>http://127.0.0.1:2379<span class="token punctuation">]</span>
Finished defragmenting etcd member<span class="token punctuation">[</span>http://127.0.0.1:22379<span class="token punctuation">]</span>
Finished defragmenting etcd member<span class="token punctuation">[</span>http://127.0.0.1:32379<span class="token punctuation">]</span></code></pre>

<p>To defragment a data directory directly, use the <code>--data-dir</code> flag:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Defragment while etcd is not running</span>
./etcdctl defrag --data-dir default.etcd
<span class="token comment"># success (exit status 0)</span>
<span class="token comment"># Error: cannot open database at default.etcd/member/snap/db</span></code></pre>

<h4 id="Remarks-3"><a href="#Remarks-3" class="headerlink" title="Remarks"></a>Remarks</h4><p>DEFRAG returns a zero exit code only if it succeeded defragmenting all given endpoints.</p>
<h3 id="SNAPSHOT-lt-subcommand-gt"><a href="#SNAPSHOT-lt-subcommand-gt" class="headerlink" title="SNAPSHOT &lt;subcommand&gt;"></a>SNAPSHOT &lt;subcommand&gt;</h3><p>SNAPSHOT provides commands to restore a snapshot of a running etcd server into a fresh cluster.</p>
<h3 id="SNAPSHOT-SAVE-lt-filename-gt"><a href="#SNAPSHOT-SAVE-lt-filename-gt" class="headerlink" title="SNAPSHOT SAVE &lt;filename&gt;"></a>SNAPSHOT SAVE &lt;filename&gt;</h3><p>SNAPSHOT SAVE writes a point-in-time snapshot of the etcd backend database to a file.</p>
<h4 id="Output-21"><a href="#Output-21" class="headerlink" title="Output"></a>Output</h4><p>The backend snapshot is written to the given file path.</p>
<h4 id="Example-11"><a href="#Example-11" class="headerlink" title="Example"></a>Example</h4><p>Save a snapshot to “snapshot.db”:</p>
<pre class="language-none"><code class="language-none">.&#x2F;etcdctl snapshot save snapshot.db</code></pre>

<h3 id="SNAPSHOT-RESTORE-options-lt-filename-gt"><a href="#SNAPSHOT-RESTORE-options-lt-filename-gt" class="headerlink" title="SNAPSHOT RESTORE [options] &lt;filename&gt;"></a>SNAPSHOT RESTORE [options] &lt;filename&gt;</h3><p>SNAPSHOT RESTORE creates an etcd data directory for an etcd cluster member from a backend database snapshot and a new cluster configuration. Restoring the snapshot into each member for a new cluster configuration will initialize a new etcd cluster preloaded by the snapshot data.</p>
<h4 id="Options-11"><a href="#Options-11" class="headerlink" title="Options"></a>Options</h4><p>The snapshot restore options closely resemble to those used in the <code>etcd</code> command for defining a cluster.</p>
<ul>
<li><p>data-dir – Path to the data directory. Uses &lt;name&gt;.etcd if none given.</p>
</li>
<li><p>wal-dir – Path to the WAL directory. Uses data directory if none given.</p>
</li>
<li><p>initial-cluster – The initial cluster configuration for the restored etcd cluster.</p>
</li>
<li><p>initial-cluster-token – Initial cluster token for the restored etcd cluster.</p>
</li>
<li><p>initial-advertise-peer-urls – List of peer URLs for the member being restored.</p>
</li>
<li><p>name – Human-readable name for the etcd cluster member being restored.</p>
</li>
<li><p>skip-hash-check – Ignore snapshot integrity hash value (required if copied from data directory)</p>
</li>
</ul>
<h4 id="Output-22"><a href="#Output-22" class="headerlink" title="Output"></a>Output</h4><p>A new etcd data directory initialized with the snapshot.</p>
<h4 id="Example-12"><a href="#Example-12" class="headerlink" title="Example"></a>Example</h4><p>Save a snapshot, restore into a new 3 node cluster, and start the cluster:</p>
<pre class="language-none"><code class="language-none">.&#x2F;etcdctl snapshot save snapshot.db

# restore members
bin&#x2F;etcdctl snapshot restore snapshot.db --initial-cluster-token etcd-cluster-1 --initial-advertise-peer-urls http:&#x2F;&#x2F;127.0.0.1:12380  --name sshot1 --initial-cluster &#39;sshot1&#x3D;http:&#x2F;&#x2F;127.0.0.1:12380,sshot2&#x3D;http:&#x2F;&#x2F;127.0.0.1:22380,sshot3&#x3D;http:&#x2F;&#x2F;127.0.0.1:32380&#39;
bin&#x2F;etcdctl snapshot restore snapshot.db --initial-cluster-token etcd-cluster-1 --initial-advertise-peer-urls http:&#x2F;&#x2F;127.0.0.1:22380  --name sshot2 --initial-cluster &#39;sshot1&#x3D;http:&#x2F;&#x2F;127.0.0.1:12380,sshot2&#x3D;http:&#x2F;&#x2F;127.0.0.1:22380,sshot3&#x3D;http:&#x2F;&#x2F;127.0.0.1:32380&#39;
bin&#x2F;etcdctl snapshot restore snapshot.db --initial-cluster-token etcd-cluster-1 --initial-advertise-peer-urls http:&#x2F;&#x2F;127.0.0.1:32380  --name sshot3 --initial-cluster &#39;sshot1&#x3D;http:&#x2F;&#x2F;127.0.0.1:12380,sshot2&#x3D;http:&#x2F;&#x2F;127.0.0.1:22380,sshot3&#x3D;http:&#x2F;&#x2F;127.0.0.1:32380&#39;

# launch members
bin&#x2F;etcd --name sshot1 --listen-client-urls http:&#x2F;&#x2F;127.0.0.1:2379 --advertise-client-urls http:&#x2F;&#x2F;127.0.0.1:2379 --listen-peer-urls http:&#x2F;&#x2F;127.0.0.1:12380 &amp;
bin&#x2F;etcd --name sshot2 --listen-client-urls http:&#x2F;&#x2F;127.0.0.1:22379 --advertise-client-urls http:&#x2F;&#x2F;127.0.0.1:22379 --listen-peer-urls http:&#x2F;&#x2F;127.0.0.1:22380 &amp;
bin&#x2F;etcd --name sshot3 --listen-client-urls http:&#x2F;&#x2F;127.0.0.1:32379 --advertise-client-urls http:&#x2F;&#x2F;127.0.0.1:32379 --listen-peer-urls http:&#x2F;&#x2F;127.0.0.1:32380 &amp;</code></pre>

<h3 id="SNAPSHOT-STATUS-lt-filename-gt"><a href="#SNAPSHOT-STATUS-lt-filename-gt" class="headerlink" title="SNAPSHOT STATUS &lt;filename&gt;"></a>SNAPSHOT STATUS &lt;filename&gt;</h3><p>SNAPSHOT STATUS lists information about a given backend database snapshot file.</p>
<h4 id="Output-23"><a href="#Output-23" class="headerlink" title="Output"></a>Output</h4><h5 id="Simple-format-2"><a href="#Simple-format-2" class="headerlink" title="Simple format"></a>Simple format</h5><p>Prints a humanized table of the database hash, revision, total keys, and size.</p>
<h5 id="JSON-format-2"><a href="#JSON-format-2" class="headerlink" title="JSON format"></a>JSON format</h5><p>Prints a line of JSON encoding the database hash, revision, total keys, and size.</p>
<h4 id="Examples-10"><a href="#Examples-10" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl snapshot status file.db
<span class="token comment"># cf1550fb, 3, 3, 25 kB</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl -write-out<span class="token operator">=</span>json snapshot status file.db
<span class="token comment"># &#123;"hash":3474280699,"revision":3,"totalKey":3,"totalSize":24576&#125;</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl -write-out<span class="token operator">=</span>table snapshot status file.db
+----------+----------+------------+------------+
<span class="token operator">|</span>   HASH   <span class="token operator">|</span> REVISION <span class="token operator">|</span> TOTAL KEYS <span class="token operator">|</span> TOTAL SIZE <span class="token operator">|</span>
+----------+----------+------------+------------+
<span class="token operator">|</span> cf1550fb <span class="token operator">|</span>        <span class="token number">3</span> <span class="token operator">|</span>          <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">25</span> kB      <span class="token operator">|</span>
+----------+----------+------------+------------+</code></pre>

<h3 id="MOVE-LEADER-lt-hexadecimal-transferee-id-gt"><a href="#MOVE-LEADER-lt-hexadecimal-transferee-id-gt" class="headerlink" title="MOVE-LEADER &lt;hexadecimal-transferee-id&gt;"></a>MOVE-LEADER &lt;hexadecimal-transferee-id&gt;</h3><p>MOVE-LEADER transfers leadership from the leader to another member in the cluster.</p>
<h4 id="Example-13"><a href="#Example-13" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># to choose transferee</span>
<span class="token assign-left variable">transferee_id</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>./etcdctl <span class="token punctuation">\</span>
  <span class="token parameter variable">--endpoints</span> localhost:2379,localhost:22379,localhost:32379 <span class="token punctuation">\</span>
  endpoint status <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-m</span> <span class="token number">1</span> <span class="token string">"false"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">', '</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>
<span class="token builtin class-name">echo</span> <span class="token variable">$&#123;transferee_id&#125;</span>
<span class="token comment"># c89feb932daef420</span>

<span class="token comment"># endpoints should include leader node</span>
./etcdctl <span class="token parameter variable">--endpoints</span> <span class="token variable">$&#123;transferee_ep&#125;</span> move-leader <span class="token variable">$&#123;transferee_id&#125;</span>
<span class="token comment"># Error:  no leader endpoint given at [localhost:22379 localhost:32379]</span>

<span class="token comment"># request to leader with target node ID</span>
./etcdctl <span class="token parameter variable">--endpoints</span> <span class="token variable">$&#123;leader_ep&#125;</span> move-leader <span class="token variable">$&#123;transferee_id&#125;</span>
<span class="token comment"># Leadership transferred from 45ddc0e800e20b93 to c89feb932daef420</span></code></pre>

<h2 id="Concurrency-commands"><a href="#Concurrency-commands" class="headerlink" title="Concurrency commands"></a>Concurrency commands</h2><h3 id="LOCK-options-lt-lockname-gt-command-arg1-arg2-…"><a href="#LOCK-options-lt-lockname-gt-command-arg1-arg2-…" class="headerlink" title="LOCK [options] &lt;lockname&gt; [command arg1 arg2 …]"></a>LOCK [options] &lt;lockname&gt; [command arg1 arg2 …]</h3><p>LOCK acquires a distributed mutex with a given name. Once the lock is acquired, it will be held until etcdctl is terminated.</p>
<h4 id="Options-12"><a href="#Options-12" class="headerlink" title="Options"></a>Options</h4><ul>
<li>ttl - time out in seconds of lock session.</li>
</ul>
<h4 id="Output-24"><a href="#Output-24" class="headerlink" title="Output"></a>Output</h4><p>Once the lock is acquired but no command is given, the result for the GET on the unique lock holder key is displayed.</p>
<p>If a command is given, it will be executed with environment variables <code>ETCD_LOCK_KEY</code> and <code>ETCD_LOCK_REV</code> set to the lock’s holder key and revision.</p>
<h4 id="Example-14"><a href="#Example-14" class="headerlink" title="Example"></a>Example</h4><p>Acquire lock with standard output display:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lock mylock
<span class="token comment"># mylock/1234534535445</span></code></pre>

<p>Acquire lock and execute <code>echo lock acquired</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lock mylock <span class="token builtin class-name">echo</span> lock acquired
<span class="token comment"># lock acquired</span></code></pre>

<p>Acquire lock and execute <code>etcdctl put</code> command</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl lock mylock ./etcdctl put foo bar
<span class="token comment"># OK</span></code></pre>

<h4 id="Remarks-4"><a href="#Remarks-4" class="headerlink" title="Remarks"></a>Remarks</h4><p>LOCK returns a zero exit code only if it is terminated by a signal and releases the lock.</p>
<p>If LOCK is abnormally terminated or fails to contact the cluster to release the lock, the lock will remain held until the lease expires. Progress may be delayed by up to the default lease length of 60 seconds.</p>
<h3 id="ELECT-options-lt-election-name-gt-proposal"><a href="#ELECT-options-lt-election-name-gt-proposal" class="headerlink" title="ELECT [options] &lt;election-name&gt; [proposal]"></a>ELECT [options] &lt;election-name&gt; [proposal]</h3><p>ELECT participates on a named election. A node announces its candidacy in the election by providing<br>a proposal value. If a node wishes to observe the election, ELECT listens for new leaders values.<br>Whenever a leader is elected, its proposal is given as output.</p>
<h4 id="Options-13"><a href="#Options-13" class="headerlink" title="Options"></a>Options</h4><ul>
<li>listen – observe the election.</li>
</ul>
<h4 id="Output-25"><a href="#Output-25" class="headerlink" title="Output"></a>Output</h4><ul>
<li><p>If a candidate, ELECT displays the GET on the leader key once the node is elected election.</p>
</li>
<li><p>If observing, ELECT streams the result for a GET on the leader key for the current election and all future elections.</p>
</li>
</ul>
<h4 id="Example-15"><a href="#Example-15" class="headerlink" title="Example"></a>Example</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl elect myelection foo
<span class="token comment"># myelection/1456952310051373265</span>
<span class="token comment"># foo</span></code></pre>

<h4 id="Remarks-5"><a href="#Remarks-5" class="headerlink" title="Remarks"></a>Remarks</h4><p>ELECT returns a zero exit code only if it is terminated by a signal and can revoke its candidacy or leadership, if any.</p>
<p>If a candidate is abnormally terminated, election rogress may be delayed by up to the default lease length of 60 seconds.</p>
<h2 id="Authentication-commands"><a href="#Authentication-commands" class="headerlink" title="Authentication commands"></a>Authentication commands</h2><h3 id="AUTH-lt-enable-or-disable-gt"><a href="#AUTH-lt-enable-or-disable-gt" class="headerlink" title="AUTH &lt;enable or disable&gt;"></a>AUTH &lt;enable or disable&gt;</h3><p><code>auth enable</code> activates authentication on an etcd cluster and <code>auth disable</code> deactivates. When authentication is enabled, etcd checks all requests for appropriate authorization.</p>
<p>RPC: AuthEnable&#x2F;AuthDisable</p>
<h4 id="Output-26"><a href="#Output-26" class="headerlink" title="Output"></a>Output</h4><p><code>Authentication Enabled</code>.</p>
<h4 id="Examples-11"><a href="#Examples-11" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl user <span class="token function">add</span> root
<span class="token comment"># Password of root:#type password for root</span>
<span class="token comment"># Type password of root again for confirmation:#re-type password for root</span>
<span class="token comment"># User root created</span>
./etcdctl user grant-role root root
<span class="token comment"># Role root is granted to user root</span>
./etcdctl user get root
<span class="token comment"># User: root</span>
<span class="token comment"># Roles: root</span>
./etcdctl role <span class="token function">add</span> root
<span class="token comment"># Role root created</span>
./etcdctl role get root
<span class="token comment"># Role root</span>
<span class="token comment"># KV Read:</span>
<span class="token comment"># KV Write:</span>
./etcdctl auth <span class="token builtin class-name">enable</span>
<span class="token comment"># Authentication Enabled</span></code></pre>

<h3 id="ROLE-lt-subcommand-gt"><a href="#ROLE-lt-subcommand-gt" class="headerlink" title="ROLE &lt;subcommand&gt;"></a>ROLE &lt;subcommand&gt;</h3><p>ROLE is used to specify different roles which can be assigned to etcd user(s).</p>
<h3 id="ROLE-ADD-lt-role-name-gt"><a href="#ROLE-ADD-lt-role-name-gt" class="headerlink" title="ROLE ADD &lt;role name&gt;"></a>ROLE ADD &lt;role name&gt;</h3><p><code>role add</code> creates a role.</p>
<p>RPC: RoleAdd</p>
<h4 id="Output-27"><a href="#Output-27" class="headerlink" title="Output"></a>Output</h4><p><code>Role &lt;role name&gt; created</code>.</p>
<h4 id="Examples-12"><a href="#Examples-12" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 role <span class="token function">add</span> myrole
<span class="token comment"># Role myrole created</span></code></pre>

<h3 id="ROLE-GET-lt-role-name-gt"><a href="#ROLE-GET-lt-role-name-gt" class="headerlink" title="ROLE GET &lt;role name&gt;"></a>ROLE GET &lt;role name&gt;</h3><p><code>role get</code> lists detailed role information.</p>
<p>RPC: RoleGet</p>
<h4 id="Output-28"><a href="#Output-28" class="headerlink" title="Output"></a>Output</h4><p>Detailed role information.</p>
<h4 id="Examples-13"><a href="#Examples-13" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 role get myrole
<span class="token comment"># Role myrole</span>
<span class="token comment"># KV Read:</span>
<span class="token comment"># foo</span>
<span class="token comment"># KV Write:</span>
<span class="token comment"># foo</span></code></pre>

<h3 id="ROLE-DELETE-lt-role-name-gt"><a href="#ROLE-DELETE-lt-role-name-gt" class="headerlink" title="ROLE DELETE &lt;role name&gt;"></a>ROLE DELETE &lt;role name&gt;</h3><p><code>role delete</code> deletes a role.</p>
<p>RPC: RoleDelete</p>
<h4 id="Output-29"><a href="#Output-29" class="headerlink" title="Output"></a>Output</h4><p><code>Role &lt;role name&gt; deleted</code>.</p>
<h4 id="Examples-14"><a href="#Examples-14" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 role delete myrole
<span class="token comment"># Role myrole deleted</span></code></pre>

<h3 id="ROLE-LIST-lt-role-name-gt"><a href="#ROLE-LIST-lt-role-name-gt" class="headerlink" title="ROLE LIST &lt;role name&gt;"></a>ROLE LIST &lt;role name&gt;</h3><p><code>role list</code> lists all roles in etcd.</p>
<p>RPC: RoleList</p>
<h4 id="Output-30"><a href="#Output-30" class="headerlink" title="Output"></a>Output</h4><p>A role per line.</p>
<h4 id="Examples-15"><a href="#Examples-15" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 role list
<span class="token comment"># roleA</span>
<span class="token comment"># roleB</span>
<span class="token comment"># myrole</span></code></pre>

<h3 id="ROLE-GRANT-PERMISSION-options-lt-role-name-gt-lt-permission-type-gt-lt-key-gt-endkey"><a href="#ROLE-GRANT-PERMISSION-options-lt-role-name-gt-lt-permission-type-gt-lt-key-gt-endkey" class="headerlink" title="ROLE GRANT-PERMISSION [options] &lt;role name&gt; &lt;permission type&gt; &lt;key&gt; [endkey]"></a>ROLE GRANT-PERMISSION [options] &lt;role name&gt; &lt;permission type&gt; &lt;key&gt; [endkey]</h3><p><code>role grant-permission</code> grants a key to a role.</p>
<p>RPC: RoleGrantPermission</p>
<h4 id="Options-14"><a href="#Options-14" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>from-key – grant a permission of keys that are greater than or equal to the given key using byte compare</p>
</li>
<li><p>prefix – grant a prefix permission</p>
</li>
</ul>
<h4 id="Output-31"><a href="#Output-31" class="headerlink" title="Output"></a>Output</h4><p><code>Role &lt;role name&gt; updated</code>.</p>
<h4 id="Examples-16"><a href="#Examples-16" class="headerlink" title="Examples"></a>Examples</h4><p>Grant read and write permission on the key <code>foo</code> to role <code>myrole</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 role grant-permission myrole readwrite foo
<span class="token comment"># Role myrole updated</span></code></pre>

<p>Grant read permission on the wildcard key pattern <code>foo/*</code> to role <code>myrole</code>:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 role grant-permission <span class="token parameter variable">--prefix</span> myrole readwrite foo/
<span class="token comment"># Role myrole updated</span></code></pre>

<h3 id="ROLE-REVOKE-PERMISSION-lt-role-name-gt-lt-permission-type-gt-lt-key-gt-endkey"><a href="#ROLE-REVOKE-PERMISSION-lt-role-name-gt-lt-permission-type-gt-lt-key-gt-endkey" class="headerlink" title="ROLE REVOKE-PERMISSION &lt;role name&gt; &lt;permission type&gt; &lt;key&gt; [endkey]"></a>ROLE REVOKE-PERMISSION &lt;role name&gt; &lt;permission type&gt; &lt;key&gt; [endkey]</h3><p><code>role revoke-permission</code> revokes a key from a role.</p>
<p>RPC: RoleRevokePermission</p>
<h4 id="Options-15"><a href="#Options-15" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>from-key – revoke a permission of keys that are greater than or equal to the given key using byte compare</p>
</li>
<li><p>prefix – revoke a prefix permission</p>
</li>
</ul>
<h4 id="Output-32"><a href="#Output-32" class="headerlink" title="Output"></a>Output</h4><p><code>Permission of key &lt;key&gt; is revoked from role &lt;role name&gt;</code> for single key. <code>Permission of range [&lt;key&gt;, &lt;endkey&gt;) is revoked from role &lt;role name&gt;</code> for a key range. Exit code is zero.</p>
<h4 id="Examples-17"><a href="#Examples-17" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 role revoke-permission myrole foo
<span class="token comment"># Permission of key foo is revoked from role myrole</span></code></pre>

<h3 id="USER-lt-subcommand-gt"><a href="#USER-lt-subcommand-gt" class="headerlink" title="USER &lt;subcommand&gt;"></a>USER &lt;subcommand&gt;</h3><p>USER provides commands for managing users of etcd.</p>
<h3 id="USER-ADD-lt-user-name-or-user-password-gt-options"><a href="#USER-ADD-lt-user-name-or-user-password-gt-options" class="headerlink" title="USER ADD &lt;user name or user:password&gt; [options]"></a>USER ADD &lt;user name or user:password&gt; [options]</h3><p><code>user add</code> creates a user.</p>
<p>RPC: UserAdd</p>
<h4 id="Options-16"><a href="#Options-16" class="headerlink" title="Options"></a>Options</h4><ul>
<li>interactive – Read password from stdin instead of interactive terminal</li>
</ul>
<h4 id="Output-33"><a href="#Output-33" class="headerlink" title="Output"></a>Output</h4><p><code>User &lt;user name&gt; created</code>.</p>
<h4 id="Examples-18"><a href="#Examples-18" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 user <span class="token function">add</span> myuser
<span class="token comment"># Password of myuser: #type password for my user</span>
<span class="token comment"># Type password of myuser again for confirmation:#re-type password for my user</span>
<span class="token comment"># User myuser created</span></code></pre>

<h3 id="USER-GET-lt-user-name-gt-options"><a href="#USER-GET-lt-user-name-gt-options" class="headerlink" title="USER GET &lt;user name&gt; [options]"></a>USER GET &lt;user name&gt; [options]</h3><p><code>user get</code> lists detailed user information.</p>
<p>RPC: UserGet</p>
<h4 id="Options-17"><a href="#Options-17" class="headerlink" title="Options"></a>Options</h4><ul>
<li>detail – Show permissions of roles granted to the user</li>
</ul>
<h4 id="Output-34"><a href="#Output-34" class="headerlink" title="Output"></a>Output</h4><p>Detailed user information.</p>
<h4 id="Examples-19"><a href="#Examples-19" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 user get myuser
<span class="token comment"># User: myuser</span>
<span class="token comment"># Roles:</span></code></pre>

<h3 id="USER-DELETE-lt-user-name-gt"><a href="#USER-DELETE-lt-user-name-gt" class="headerlink" title="USER DELETE &lt;user name&gt;"></a>USER DELETE &lt;user name&gt;</h3><p><code>user delete</code> deletes a user.</p>
<p>RPC: UserDelete</p>
<h4 id="Output-35"><a href="#Output-35" class="headerlink" title="Output"></a>Output</h4><p><code>User &lt;user name&gt; deleted</code>.</p>
<h4 id="Examples-20"><a href="#Examples-20" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 user delete myuser
<span class="token comment"># User myuser deleted</span></code></pre>

<h3 id="USER-LIST"><a href="#USER-LIST" class="headerlink" title="USER LIST"></a>USER LIST</h3><p><code>user list</code> lists detailed user information.</p>
<p>RPC: UserList</p>
<h4 id="Output-36"><a href="#Output-36" class="headerlink" title="Output"></a>Output</h4><ul>
<li>List of users, one per line.</li>
</ul>
<h4 id="Examples-21"><a href="#Examples-21" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 user list
<span class="token comment"># user1</span>
<span class="token comment"># user2</span>
<span class="token comment"># myuser</span></code></pre>

<h3 id="USER-PASSWD-lt-user-name-gt-options"><a href="#USER-PASSWD-lt-user-name-gt-options" class="headerlink" title="USER PASSWD &lt;user name&gt; [options]"></a>USER PASSWD &lt;user name&gt; [options]</h3><p><code>user passwd</code> changes a user’s password.</p>
<p>RPC: UserChangePassword</p>
<h4 id="Options-18"><a href="#Options-18" class="headerlink" title="Options"></a>Options</h4><ul>
<li>interactive – if true, read password in interactive terminal</li>
</ul>
<h4 id="Output-37"><a href="#Output-37" class="headerlink" title="Output"></a>Output</h4><p><code>Password updated</code>.</p>
<h4 id="Examples-22"><a href="#Examples-22" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 user <span class="token function">passwd</span> myuser
<span class="token comment"># Password of myuser: #type new password for my user</span>
<span class="token comment"># Type password of myuser again for confirmation: #re-type the new password for my user</span>
<span class="token comment"># Password updated</span></code></pre>

<h3 id="USER-GRANT-ROLE-lt-user-name-gt-lt-role-name-gt"><a href="#USER-GRANT-ROLE-lt-user-name-gt-lt-role-name-gt" class="headerlink" title="USER GRANT-ROLE &lt;user name&gt; &lt;role name&gt;"></a>USER GRANT-ROLE &lt;user name&gt; &lt;role name&gt;</h3><p><code>user grant-role</code> grants a role to a user</p>
<p>RPC: UserGrantRole</p>
<h4 id="Output-38"><a href="#Output-38" class="headerlink" title="Output"></a>Output</h4><p><code>Role &lt;role name&gt; is granted to user &lt;user name&gt;</code>.</p>
<h4 id="Examples-23"><a href="#Examples-23" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 user grant-role userA roleA
<span class="token comment"># Role roleA is granted to user userA</span></code></pre>

<h3 id="USER-REVOKE-ROLE-lt-user-name-gt-lt-role-name-gt"><a href="#USER-REVOKE-ROLE-lt-user-name-gt-lt-role-name-gt" class="headerlink" title="USER REVOKE-ROLE &lt;user name&gt; &lt;role name&gt;"></a>USER REVOKE-ROLE &lt;user name&gt; &lt;role name&gt;</h3><p><code>user revoke-role</code> revokes a role from a user</p>
<p>RPC: UserRevokeRole</p>
<h4 id="Output-39"><a href="#Output-39" class="headerlink" title="Output"></a>Output</h4><p><code>Role &lt;role name&gt; is revoked from user &lt;user name&gt;</code>.</p>
<h4 id="Examples-24"><a href="#Examples-24" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl <span class="token parameter variable">--user</span><span class="token operator">=</span>root:123 user revoke-role userA roleA
<span class="token comment"># Role roleA is revoked from user userA</span></code></pre>

<h2 id="Utility-commands"><a href="#Utility-commands" class="headerlink" title="Utility commands"></a>Utility commands</h2><h3 id="MAKE-MIRROR-options-lt-destination-gt"><a href="#MAKE-MIRROR-options-lt-destination-gt" class="headerlink" title="MAKE-MIRROR [options] &lt;destination&gt;"></a>MAKE-MIRROR [options] &lt;destination&gt;</h3><p><a href="./doc/mirror_maker.md">make-mirror</a> mirrors a key prefix in an etcd cluster to a destination etcd cluster.</p>
<h4 id="Options-19"><a href="#Options-19" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>dest-cacert – TLS certificate authority file for destination cluster</p>
</li>
<li><p>dest-cert – TLS certificate file for destination cluster</p>
</li>
<li><p>dest-key – TLS key file for destination cluster</p>
</li>
<li><p>prefix – The key-value prefix to mirror</p>
</li>
<li><p>dest-prefix – The destination prefix to mirror a prefix to a different prefix in the destination cluster</p>
</li>
<li><p>no-dest-prefix – Mirror key-values to the root of the destination cluster</p>
</li>
<li><p>dest-insecure-transport – Disable transport security for client connections</p>
</li>
</ul>
<h4 id="Output-40"><a href="#Output-40" class="headerlink" title="Output"></a>Output</h4><p>The approximate total number of keys transferred to the destination cluster, updated every 30 seconds.</p>
<h4 id="Examples-25"><a href="#Examples-25" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-none"><code class="language-none">.&#x2F;etcdctl make-mirror mirror.example.com:2379
# 10
# 18</code></pre>

<h3 id="MIGRATE-options"><a href="#MIGRATE-options" class="headerlink" title="MIGRATE [options]"></a>MIGRATE [options]</h3><p>Migrates keys in a v2 store to a v3 mvcc store. Users should run migration command for all members in the cluster.</p>
<h4 id="Options-20"><a href="#Options-20" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>data-dir – Path to the data directory</p>
</li>
<li><p>wal-dir – Path to the WAL directory</p>
</li>
<li><p>transformer – Path to the user-provided transformer program (default if not provided)</p>
</li>
</ul>
<h4 id="Output-41"><a href="#Output-41" class="headerlink" title="Output"></a>Output</h4><p>No output on success.</p>
<h4 id="Default-transformer"><a href="#Default-transformer" class="headerlink" title="Default transformer"></a>Default transformer</h4><p>If user does not provide a transformer program, migrate command will use the default transformer. The default transformer transforms <code>storev2</code> formatted keys into <code>mvcc</code> formatted keys according to the following Go program:</p>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">transform</span><span class="token punctuation">(</span>n <span class="token operator">*</span>storev2<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token operator">*</span>mvccpb<span class="token punctuation">.</span>KeyValue <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> n<span class="token punctuation">.</span>Dir <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	kv <span class="token operator">:=</span> <span class="token operator">&amp;</span>mvccpb<span class="token punctuation">.</span>KeyValue<span class="token punctuation">&#123;</span>
		Key<span class="token punctuation">:</span>            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">,</span>
		CreateRevision<span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>CreatedIndex<span class="token punctuation">)</span><span class="token punctuation">,</span>
		ModRevision<span class="token punctuation">:</span>    <span class="token function">int64</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>ModifiedIndex<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Version<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> kv
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="User-provided-transformer"><a href="#User-provided-transformer" class="headerlink" title="User-provided transformer"></a>User-provided transformer</h4><p>Users can provide a customized 1:n transformer function that transforms a key from the v2 store to any number of keys in the mvcc store. The migration program writes JSON formatted <a href="../store/node_extern.go#L28-L37">v2 store keys</a> to the transformer program’s stdin, reads protobuf formatted <a href="../mvcc/mvccpb/kv.proto#L12-L29">mvcc keys</a> back from the transformer program’s stdout, and finishes migration by saving the transformed keys into the mvcc store.</p>
<p>The provided transformer should read until EOF and flush the stdout before exiting to ensure data integrity.</p>
<h4 id="Example-16"><a href="#Example-16" class="headerlink" title="Example"></a>Example</h4><pre class="language-none"><code class="language-none">.&#x2F;etcdctl migrate --data-dir&#x3D;&#x2F;var&#x2F;etcd --transformer&#x3D;k8s-transformer
# finished transforming keys</code></pre>

<h3 id="VERSION"><a href="#VERSION" class="headerlink" title="VERSION"></a>VERSION</h3><p>Prints the version of etcdctl.</p>
<h4 id="Output-42"><a href="#Output-42" class="headerlink" title="Output"></a>Output</h4><p>Prints etcd version and API version.</p>
<h4 id="Examples-26"><a href="#Examples-26" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl version
<span class="token comment"># etcdctl version: 3.1.0-alpha.0+git</span>
<span class="token comment"># API version: 3.1</span></code></pre>

<h3 id="CHECK-lt-subcommand-gt"><a href="#CHECK-lt-subcommand-gt" class="headerlink" title="CHECK &lt;subcommand&gt;"></a>CHECK &lt;subcommand&gt;</h3><p>CHECK provides commands for checking properties of the etcd cluster.</p>
<h3 id="CHECK-PERF-options"><a href="#CHECK-PERF-options" class="headerlink" title="CHECK PERF [options]"></a>CHECK PERF [options]</h3><p>CHECK PERF checks the performance of the etcd cluster for 60 seconds. Running the <code>check perf</code> often can create a large keyspace history which can be auto compacted and defragmented using the <code>--auto-compact</code> and <code>--auto-defrag</code> options as described below.</p>
<p>RPC: CheckPerf</p>
<h4 id="Options-21"><a href="#Options-21" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>load – the performance check’s workload model. Accepted workloads: s(small), m(medium), l(large), xl(xLarge)</p>
</li>
<li><p>prefix – the prefix for writing the performance check’s keys.</p>
</li>
<li><p>auto-compact – if true, compact storage with last revision after test is finished.</p>
</li>
<li><p>auto-defrag – if true, defragment storage after test is finished.</p>
</li>
</ul>
<h4 id="Output-43"><a href="#Output-43" class="headerlink" title="Output"></a>Output</h4><p>Prints the result of performance check on different criteria like throughput. Also prints an overall status of the check as pass or fail.</p>
<h4 id="Examples-27"><a href="#Examples-27" class="headerlink" title="Examples"></a>Examples</h4><p>Shows examples of both, pass and fail, status. The failure is due to the fact that a large workload was tried on a single node etcd cluster running on a laptop environment created for development and testing purpose.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl check perf <span class="token parameter variable">--load</span><span class="token operator">=</span><span class="token string">"s"</span>
<span class="token comment"># 60 / 60 Booooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo! 100.00%1m0s</span>
<span class="token comment"># PASS: Throughput is 150 writes/s</span>
<span class="token comment"># PASS: Slowest request took 0.087509s</span>
<span class="token comment"># PASS: Stddev is 0.011084s</span>
<span class="token comment"># PASS</span>
./etcdctl check perf <span class="token parameter variable">--load</span><span class="token operator">=</span><span class="token string">"l"</span>
<span class="token comment"># 60 / 60 Booooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo! 100.00%1m0s</span>
<span class="token comment"># FAIL: Throughput too low: 6808 writes/s</span>
<span class="token comment"># PASS: Slowest request took 0.228191s</span>
<span class="token comment"># PASS: Stddev is 0.033547s</span>
<span class="token comment"># FAIL</span></code></pre>

<h3 id="CHECK-DATASCALE-options"><a href="#CHECK-DATASCALE-options" class="headerlink" title="CHECK DATASCALE [options]"></a>CHECK DATASCALE [options]</h3><p>CHECK DATASCALE checks the memory usage of holding data for different workloads on a given server endpoint. Running the <code>check datascale</code> often can create a large keyspace history which can be auto compacted and defragmented using the <code>--auto-compact</code> and <code>--auto-defrag</code> options as described below.</p>
<p>RPC: CheckDatascale</p>
<h4 id="Options-22"><a href="#Options-22" class="headerlink" title="Options"></a>Options</h4><ul>
<li><p>load – the datascale check’s workload model. Accepted workloads: s(small), m(medium), l(large), xl(xLarge)</p>
</li>
<li><p>prefix – the prefix for writing the datascale check’s keys.</p>
</li>
<li><p>auto-compact – if true, compact storage with last revision after test is finished.</p>
</li>
<li><p>auto-defrag – if true, defragment storage after test is finished.</p>
</li>
</ul>
<h4 id="Output-44"><a href="#Output-44" class="headerlink" title="Output"></a>Output</h4><p>Prints the system memory usage for a given workload. Also prints status of compact and defragment if related options are passed.</p>
<h4 id="Examples-28"><a href="#Examples-28" class="headerlink" title="Examples"></a>Examples</h4><pre class="language-bash" data-language="bash"><code class="language-bash">./etcdctl check datascale <span class="token parameter variable">--load</span><span class="token operator">=</span><span class="token string">"s"</span> --auto-compact<span class="token operator">=</span>true --auto-defrag<span class="token operator">=</span>true
<span class="token comment"># Start data scale check for work load [10000 key-value pairs, 1024 bytes per key-value, 50 concurrent clients].</span>
<span class="token comment"># Compacting with revision 18346204</span>
<span class="token comment"># Compacted with revision 18346204</span>
<span class="token comment"># Defragmenting "127.0.0.1:2379"</span>
<span class="token comment"># Defragmented "127.0.0.1:2379"</span>
<span class="token comment"># PASS: Approximate system memory used : 64.30 MB.</span></code></pre>

<h2 id="Exit-codes"><a href="#Exit-codes" class="headerlink" title="Exit codes"></a>Exit codes</h2><p>For all commands, a successful execution return a zero exit code. All failures will return non-zero exit codes.</p>
<h2 id="Output-formats"><a href="#Output-formats" class="headerlink" title="Output formats"></a>Output formats</h2><p>All commands accept an output format by setting <code>-w</code> or <code>--write-out</code>. All commands default to the “simple” output format, which is meant to be human-readable. The simple format is listed in each command’s <code>Output</code> description since it is customized for each command. If a command has a corresponding RPC, it will respect all output formats.</p>
<p>If a command fails, returning a non-zero exit code, an error string will be written to standard error regardless of output format.</p>
<h3 id="Simple"><a href="#Simple" class="headerlink" title="Simple"></a>Simple</h3><p>A format meant to be easy to parse and human-readable. Specific to each command.</p>
<h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><p>The JSON encoding of the command’s <a href="../etcdserver/etcdserverpb/rpc.proto">RPC response</a>. Since etcd’s RPCs use byte strings, the JSON output will encode keys and values in base64.</p>
<p>Some commands without an RPC also support JSON; see the command’s <code>Output</code> description.</p>
<h3 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h3><p>The protobuf encoding of the command’s <a href="../etcdserver/etcdserverpb/rpc.proto">RPC response</a>. If an RPC is streaming, the stream messages will be concetenated. If an RPC is not given for a command, the protobuf output is not defined.</p>
<h3 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h3><p>An output format similar to JSON but meant to parse with coreutils. For an integer field named <code>Field</code>, it writes a line in the format <code>&quot;Field&quot; : %d</code> where <code>%d</code> is go’s integer formatting. For byte array fields, it writes <code>&quot;Field&quot; : %q</code> where <code>%q</code> is go’s quoted string formatting (e.g., <code>[]byte&#123;&#39;a&#39;, &#39;\n&#39;&#125;</code> is written as <code>&quot;a\n&quot;</code>).</p>
<h2 id="Compatibility-Support"><a href="#Compatibility-Support" class="headerlink" title="Compatibility Support"></a>Compatibility Support</h2><p>etcdctl is still in its early stage. We try out best to ensure fully compatible releases, however we might break compatibility to fix bugs or improve commands. If we intend to release a version of etcdctl with backward incompatibilities, we will provide notice prior to release and have instructions on how to upgrade.</p>
<h3 id="Input-Compatibility"><a href="#Input-Compatibility" class="headerlink" title="Input Compatibility"></a>Input Compatibility</h3><p>Input includes the command name, its flags, and its arguments. We ensure backward compatibility of the input of normal commands in non-interactive mode.</p>
<h3 id="Output-Compatibility"><a href="#Output-Compatibility" class="headerlink" title="Output Compatibility"></a>Output Compatibility</h3><p>Output includes output from etcdctl and its exit code. etcdctl provides <code>simple</code> output format by default.<br>We ensure compatibility for the <code>simple</code> output format of normal commands in non-interactive mode. Currently, we do not ensure<br>backward compatibility for <code>JSON</code> format and the format in non-interactive mode. Currently, we do not ensure backward compatibility of utility commands.</p>
<h3 id="TODO-compatibility-with-etcd-server"><a href="#TODO-compatibility-with-etcd-server" class="headerlink" title="TODO: compatibility with etcd server"></a>TODO: compatibility with etcd server</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/service%E5%92%8Cingress/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/service%E5%92%8Cingress/" class="post-title-link" itemprop="url">service和ingress</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-11 11:27:51" itemprop="dateCreated datePublished" datetime="2021-03-11T11:27:51+08:00">2021-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuyuteng/p/11598768.html">https://www.cnblogs.com/fuyuteng/p/11598768.html</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/111244353">kubernetes service 原理解析 - 知乎 (zhihu.com)</a></p>
<h3 id="为什么需要-service"><a href="#为什么需要-service" class="headerlink" title="为什么需要 service"></a>为什么需要 service</h3><p>在 kubernetes 中，当创建带有多个副本的 deployment 时，kubernetes 会创建出多个 pod，此时即一个服务后端有多个容器，那么在 kubernetes 中负载均衡怎么做，容器漂移后 ip 也会发生变化，如何做服务发现以及会话保持？这就是 service 的作用，service 是一组具有相同 label pod 集合的抽象，集群内外的各个服务可以通过 service 进行互相通信，当创建一个 service 对象时也会对应创建一个 endpoint 对象，endpoint 是用来做容器发现的，service 只是将多个 pod 进行关联，实际的路由转发都是由 kubernetes 中的 kube-proxy 组件来实现，因此，service 必须结合 kube-proxy 使用，kube-proxy 组件可以运行在 kubernetes 集群中的每一个节点上也可以只运行在单独的几个节点上，其会根据 service 和 endpoints 的变动来改变节点上 iptables 或者 ipvs 中保存的路由规则</p>
<h3 id="service-的工作原理"><a href="#service-的工作原理" class="headerlink" title="service 的工作原理"></a>service 的工作原理</h3><p>service 资源基于标签选择器将一组 pod 定义成一个逻辑组合，并通过自己的 ip 地址和端口调度代理请求至组内 pod 的对象之上，它向客户隐藏了真实的、处理用户请求的 pod 资源，使得客户端的请求看上去像是由 service 直接处理并进行响应一样</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615448927873.png"></p>
<p>Service 对象的 IP 地址也称为 Cluster IP，是一种 VIP（虚拟 IP），k8s 集群内部的 VIP</p>
<p>service 网段不能跟机房网络、docker 网段、容器网段冲突，否则可能会导致网络不通</p>
<p>Service 以负载均衡的方式进行流量调度，Service 和 Pod 之间松耦合，创建 Service 和 Pod 的任务可由不同的用户分别完成</p>
<p>Service 通过 API Server 实时监控（watch）标签选择器匹配到的后端 Pod，不过 Service 并不直接链接至 Pod，它们中间还有一个中间层 －－<strong>Endpoints</strong>资源对象，默认情况下，创建 Service 对象时，其关联的 Endpoints 对象会自动创建</p>
<p>endpoints controller 是负责生成和维护所有 endpoints 对象的控制器，监听 service 和对应 pod 的变化，更新对应 service 的 endpoints 对象。当用户创建 service 后 endpoints controller 会监听 pod 的状态，当 pod 处于 running 且准备就绪时，endpoints controller 会将 pod ip 记录到 endpoints 对象中，因此，service 的容器发现是通过 endpoints 来实现的。而 kube-proxy 会监听 service 和 endpoints 的更新并调用其代理模块在主机上刷新路由转发规则</p>
<p>Endpoints 是一个由 IP 地址和端口组成的列表，这些 IP 和端口来自于其 Service 关联的 Pod</p>
<p>每个节点上的 kube-proxy 组件 watch 各 Service 及其关联的 Endpoints，如果有变动，就会实时更新当前节点上相应的 iptables 或 ipvs 规则，确保 Cluster IP 的流量能调度到 Endpoints</p>
<p>简单来讲，一个 Service 对象就是一个 Node 上的这些 iptables 和 ipvs 规则</p>
<h3 id="service-的负载均衡"><a href="#service-的负载均衡" class="headerlink" title="service 的负载均衡"></a>service 的负载均衡</h3><p>pod 之间通信，一般不会 pod 直接访问 pod，而是 pod 先访问 service，然后 service 再到 pod</p>
<p>关于将 Cluster IP 的流量能调度到 Endpoints，有三种方式：userspace 代理、iptables 代理、ipvs 代理</p>
<ol>
<li><p><strong>userspace 代理</strong></p>
<p>1.1 版本之前的默认代理模型，效率低</p>
</li>
<li><p><strong>iptables 代理</strong></p>
<p>通过 iptables 进行目标地址转换和流量调度，缺点是不会在后端 Pod 资源无响应时自动进行重定向</p>
<img data-src="//img.to2b.cn/blog/ljk/1615452819548.png" style="zoom: 33%;" />
</li>
<li><p><strong>ipvs 代理</strong></p>
<p>和 iptables 代理模型的区别仅在于，流量的调度功能由 ipvs 实现，其他功能仍由 iptables 完成</p>
<img data-src="//img.to2b.cn/blog/ljk/1615452852108.png" style="zoom:33%;" /></li>
</ol>
<h3 id="service-的类型"><a href="#service-的类型" class="headerlink" title="service 的类型"></a>service 的类型</h3><p>service 支持的类型也就是 kubernetes 中服务暴露的方式，默认有四种：ClusterIP、NodePort、LoadBalancer、ExternelName</p>
<h4 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h4><p>kubernetes 集群默认的服务暴露方式，它只能用于集群内部通信，可以被各 pod 访问，其访问方式为：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">pod ---<span class="token operator">></span> ClusterIP:ServicePort --<span class="token operator">></span> <span class="token punctuation">(</span>iptables<span class="token punctuation">)</span>DNAT --<span class="token operator">></span> PodIP:containePort

<span class="token comment"># 集群内pod直接访问service的ip即可</span></code></pre>

<img data-src="//img.to2b.cn/blog/ljk/1616166170835.png" style="zoom: 50%;" />

<h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><p>如果想要在集群外访问集群内部的服务，可以使用 NodePort 类型的 service，在集群内部署了 kube-proxy 的节点打开一个指定的端口，将访问 node 此端口的流量直接发送到这个端口，然后会被转发到 service 后端真实的服务进行访问。<strong>Nodeport 构建在 ClusterIP 上</strong>，其访问链路如下所示：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">client ---<span class="token operator">></span> NodeIP:NodePort ---<span class="token operator">></span> ClusterIP:ServicePort ---<span class="token operator">></span> <span class="token punctuation">(</span>iptables<span class="token punctuation">)</span>DNAT ---<span class="token operator">></span> PodIP:containePort

<span class="token comment"># 外部流量请求先到node，再到service</span>
<span class="token comment"># 只要安装了kube-proxy的node，都可以处理外部流量，有实力的话可以单独拿出几个node，打上污点，然后负载均衡只会将外部流量转发到这几个node</span></code></pre>

<img data-src="//img.to2b.cn/blog/ljk/1616166008315.png" style="zoom:50%;" />

<h4 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h4><p>主要在公有云如阿里云、AWS 上使用，<strong>LoadBalancer 构建在 nodePort 基础之上</strong>，通过公有云服务商提供的负载均衡器将 k8s 集群中的服务暴露到外网，云厂商的 LoadBalancer 会给用户分配一个 IP，之后通过该 IP 的流量会转发到你的 service 上</p>
<p>LoadBalancer service 类型的结构如下图所示：</p>
<img data-src="//img.to2b.cn/blog/ljk/1616165936617.png" style="zoom:50%;" />

<h4 id="ExternelName"><a href="#ExternelName" class="headerlink" title="ExternelName"></a>ExternelName</h4><p>通过 CNAME 将 service 与 externalName 的值(比如：<a target="_blank" rel="noopener" href="http://foo.bar.example.com)映射起来,这种方式用的比较少./">http://foo.bar.example.com)映射起来，这种方式用的比较少。</a></p>
<h3 id="service-的服务发现"><a href="#service-的服务发现" class="headerlink" title="service 的服务发现"></a>service 的服务发现</h3><p>Pod 与 Service 的 DNS：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/">https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/</a></p>
<p>虽然 service 的 endpoints 解决了容器发现问题，但不提前知道 service 的 Cluster IP，怎么发现 service 服务呢？service 当前支持两种类型的服务发现机制，一种是通过环境变量，另一种是通过 DNS。在这两种方案中，建议使用后者：</p>
<p>在集群中部署 CoreDNS 服务， 来达到集群内部的 pod 通过 DNS 的方式进行集群内部各个服务之间的通讯</p>
<p>当前 kubernetes 集群默认使用 CoreDNS 作为默认的 DNS 服务，主要原因是 CoreDNS 是基于 Plugin 的方式进行扩展的，简单，灵活，并且不完全被 Kubernetes 所捆绑</p>
<h3 id="service-的使用"><a href="#service-的使用" class="headerlink" title="service 的使用"></a>service 的使用</h3><h4 id="ClusterIP-方式"><a href="#ClusterIP-方式" class="headerlink" title="ClusterIP 方式"></a>ClusterIP 方式</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx <span class="token comment">#service的名称，此名称会被DNS解析</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.105.146.177
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Service的端口号</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment"># 后端目标进程的端口号或名称，名称需由Pod规范定义</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</code></pre>

<h4 id="NodePort-方式"><a href="#NodePort-方式" class="headerlink" title="NodePort 方式"></a>NodePort 方式</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30090</span> <span class="token comment"># 节点端口，kube-proxy监听本机此端口，将访问此端口的流量转发到service</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># service端口</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment"># 目标pod端口</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre>

<h3 id="Headless-service-就是没有-Cluster-IP-的-service"><a href="#Headless-service-就是没有-Cluster-IP-的-service" class="headerlink" title="Headless service(就是没有 Cluster IP 的 service )"></a>Headless service(就是没有 Cluster IP 的 service )</h3><p>当不需要负载均衡以及单独的 ClusterIP 时，可以通过指定 spec.clusterIP 的值为 None 来创建 Headless service，它会给一个集群内部的每个成员提供一个唯一的 DNS 域名来作为每个成员的网络标识，集群内部成员之间使用域名通信。</p>
<p>deployment 中对应的服务是 service，而 statefulset 中与之对应的服务就是 headless service</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30090</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>nginx</code></pre>

<h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">https://kubernetes.io/zh/docs/concepts/services-networking/ingress/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/</a></p>
<p>上面介绍的 ClusterIP 、NodePort 、LoadBalancer 都是基于 ip 和 port 做负载均衡，属于四层负载均衡</p>
<p>Ingress 可以作用于多个 service，被称为 service 的 service，作为<strong>集群内部服务的入口</strong>，Ingress 其实就是<strong>七层的反向代理</strong>，可以根据不同的 url，将请求转发到不同的 service 上</p>
<p>Ingress 的结构如下图所示：</p>
<img data-src="//img.to2b.cn/blog/ljk/1616165748076.png" style="zoom:67%;" />

<p>kube-proxy 监听 node 的指定端口，将此端口的流量转发到 ingress，然后 ingress 再转发到不同的 service</p>
<pre class="language-none"><code class="language-none">反正都是实现七层代理，也可以使用deployment创建一组pod，提供nginx服务，实现代替ingress的效果：

kube-proxy监听node的指定端口，将此端口的流量转发到nginx service，然后nginx在转发到不同的service，可以配置service ip，也可以使用服务发现

建议：域名多、流量大，使用nginx；反之使用ingress</code></pre>

<h2 id="其他服务类型"><a href="#其他服务类型" class="headerlink" title="其他服务类型"></a>其他服务类型</h2><p>完全不使用 k8s 内置的 service，而是通过注册中心自动发现 pod 地址，如果开发有实力，推荐使用这种方式</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1616323318334.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%B7%A5%E5%85%B7/ubuntu/wireshark%E5%9C%A8ubuntu18.04%E4%B8%8B%E6%97%A0%E6%89%A7%E8%A1%8C%E6%9D%83%E9%99%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B7%A5%E5%85%B7/ubuntu/wireshark%E5%9C%A8ubuntu18.04%E4%B8%8B%E6%97%A0%E6%89%A7%E8%A1%8C%E6%9D%83%E9%99%90/" class="post-title-link" itemprop="url">wireshark在ubuntu18.04下无执行权限</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-10 23:45:31" itemprop="dateCreated datePublished" datetime="2021-03-10T23:45:31+08:00">2021-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/ubuntu/" itemprop="url" rel="index"><span itemprop="name">ubuntu</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>网上的教程基本都给 dumpcap 设置 suid，修改 dumpcap 的属组为 wireshark，将 whoami 添加到 wireshark 附属组。其实后面的都是多余操作，只需给 dumpcap 设置 suid 即可。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> u+s /usr/bin/dumpcap</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-10 13:55:03" itemprop="dateCreated datePublished" datetime="2021-03-10T13:55:03+08:00">2021-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="什么是-k8s？"><a href="#什么是-k8s？" class="headerlink" title="什么是 k8s？"></a>什么是 k8s？</h2><p>kubernetes：容器的管理和编排系统</p>
<p>k8s 由多个组件组成，部署在一群服务器之上，将所有服务器整合成一个资源池，然后向客户端提供各种接口， 客户端只需要调用相应接口就可以管理容器，至于底层容器具体跑在哪台服务器，不可见也不需要关心</p>
<p>针对各种特定的业务，尤其是比较依赖工程师经验的业务（例如数据库集群宕机后的数据恢复、各种集群的扩缩容），可以将一系列复杂操作代码化，这个代码在 k8s 中就叫 operator，只要用好各种 operator，就可以方便高效的解决各种问题，这样，运维工程师的主要工作就变成了维护 k8s，确保 k8s 自身能够良好运行</p>
<p>k8s 内置了各种 operator，但是这些 operator 更重视通用性，很难完全匹配实际工作需要，所以就需要对 k8s 进行二次开发，编写各种 operator，这也是 SRE 工程师的必备技能之一</p>
<p>operator 能单独管理应用集群，实现复杂操作；controllor：控制器，只能实现简单的容器操作</p>
<p>开发人员为 k8s 开发应用程序的时候，通常不会完整的部署一个分布式 k8s 集群，而是使用一个叫做 MiniKube，它可以在单机上模拟出一个完整意义上的 k8s 集群</p>
<h2 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h2><p>资源池中的各个服务器叫做节点，节点有两种：</p>
<ul>
<li>Worker Node：运行 Pod，一般称 <strong>Node</strong></li>
<li>Master Node：运行控制平面组件，不运行 pod，一般称为 <strong>Master</strong></li>
</ul>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><p>k8s 组件分为三种： <strong>控制平面组件</strong>、<strong>Node 组件</strong>、<strong>Addons</strong></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/components/">https://kubernetes.io/docs/concepts/overview/components/</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615356791215.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610298132384.png"></p>
<h3 id="控制平面组件"><a href="#控制平面组件" class="headerlink" title="控制平面组件"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/components/#control-plane-components">控制平面组件</a></h3><p>控制平面（control plane）管理 Node 和 Node 上的 Pods</p>
<p>控制平面组件可以分别运行在任意节点上，但是为了简单，通常会将所有控制平面组件运行在同一个节点上，还可以以副本的形式运行在多个节点上，然后禁止在这种节点上运行 pod，这种节点就叫做 Master Node（后文简称 Master），当集群中只有一个 Master 时，就是单控制平面，有多个 Master 时，就是多控制平面，生产中肯定是多控制平面，但是学习中一般只使用单控制平面</p>
<h4 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h4><p>https 服务器，监听在 6443 端口，它将 k8s 集群内的一切都抽象成资源，提供 RESTful 风格的 API，对资源（对象）进行增删改查等管理操作</p>
<p>apiserver 是整个 k8s 系统的总线，所有组件之间，都是通过它进行协同，它是唯一可以存储 k8s 集群的状态信息的组件（储存在 Etcd）</p>
<p>生产中，apiserver 需要做冗余，因为无状态，所以最少部署两个 apiserver，因为是 https 服务器，所以需要做四层负载，使用 Nginx、HAProxy、LVS 均可，然后搭配 keepalived 给负载均衡做高可用</p>
<p>关于健康监测，分为 AH（主动监测）和 PH（被动监测或者叫异常值探测）</p>
<h4 id="kube-controller-manager"><a href="#kube-controller-manager" class="headerlink" title="kube-controller-manager"></a>kube-controller-manager</h4><p>控制器管理器，负责管理控制器，真正意义上让 k8s 所有功能得以实现的控制中心，controller-manager 中有很多 controller（deployment 等数十种），这些 controller 才是真正意义上的 k8s 控制中心，负责集群内的 Node、Pod 副本、服务端点（Endpoint）、命名空间（Namespace）、服务账号（ServiceAccount）、资源定额（ResourceQuota）的管理</p>
<p>当某个 Node 意外宕机时，Controller Manager 会及时发现并执行自动化修复流程，确保集群始终处于预期（yaml 配置文件指定）的工作状态</p>
<p>k8s 可以把运维人员日常重复性的工作代码化，就是将多 controller 打包起来，单一运行</p>
<p>默认监听本机的 10252 端口</p>
<p>controller loop：控制循环</p>
<h4 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h4><p>调度器，调度 pod，它的核心作用就是运行应用，scheduler 时刻关注着每个节点的资源可用量，以及运行 pod 所需的资源量，让二者达到最佳匹配，让 pod 以最好的状态运行</p>
<p>在整个系统中起”承上启下”作用，承上：负责接收 Controller Manager 创建的新的 Pod，为其选择一个合适的 Node；启下：Node 上的 kubelet 接管 Pod 的生命周期</p>
<pre class="language-none"><code class="language-none">通过调度算法为待调度Pod列表的每个Pod从可用Node列表中选择一个最适合的Node，并将信息写入etcd中node节点上的kubelet通过API Server监听到kubernetes Scheduler产生的Pod绑定信息，然后获取对应的Pod清
单，下载Image，并启动容器

优选策略：
1.LeastRequestedPriority
优先从备选节点列表中选择资源消耗最小的节点（CPU+内存）
2.CalculateNodeLabelPriority
优先选择含有指定Label的节点。
3.BalancedResourceAllocation
优先从备选节点列表中选择各项资源使用率最均衡的节点</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1615428426624.png"></p>
<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p><a target="_blank" rel="noopener" href="https://etcd.io/">https://etcd.io/</a><br><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd">https://github.com/etcd-io/etcd</a></p>
<p>第三方、非 k8s 内置，它的目标是构建一个高可用的分布式键值(key-value)数据库，为避免脑裂，通常部署 3 个或 5 个节点</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">完全复制 	<span class="token comment"># 集群中的每个节点都可以使用完整的存档</span>
高可用性 	<span class="token comment"># Etcd可用于避免硬件的单点故障或网络问题</span>
一致性 		<span class="token comment"># 每次读取都会返回跨多主机的最新写入</span>
简单   		<span class="token comment"># 包括一个定义良好、面向用户的API（gRPC）</span>
安全   		<span class="token comment"># 实现了带有可选的客户端证书身份验证的自动化TLS</span>
快速   		<span class="token comment"># 每秒10000次写入的基准速度</span>
可靠   		<span class="token comment"># 使用Raft算法实现了存储的合理分布Etcd的工作原理</span></code></pre>

<p>etcd 有多个不同的 API 访问版本，v1 版本已经废弃，etcd v2 和 v3 本质上是共享同一套 raft 协议代码的两个独立的应用，接口不一样，存储不一样，数据互相隔离。也就是说如果从 Etcd v2 升级到 Etcd v3，原来 v2 的数据还是只能用 v2 的接口访问，v3 的接口创建的数据也只能访问通过 v3 的接口访问</p>
<p>以下以内容以 v3 为准</p>
<p><a href="./etcdctl/">etcdctl</a> 是 etcd 的命令行客户端工具</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">etcdctl <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token builtin class-name">command</span> <span class="token punctuation">[</span>command options<span class="token punctuation">]</span> <span class="token punctuation">[</span>arguments<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<h5 id="管理成员"><a href="#管理成员" class="headerlink" title="管理成员"></a>管理成员</h5><pre class="language-bash" data-language="bash"><code class="language-bash">etcdctl member list
etcdctl member <span class="token function">add</span>
etcdctl member promote
etcdctl member remove
etcdctl member update</code></pre>

<p>验证成员状态：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$etcdctl</span> endpoint health <span class="token punctuation">\</span>
    <span class="token parameter variable">--endpoints</span><span class="token operator">=</span>https://10.0.1.31:2379 <span class="token punctuation">\</span>
    <span class="token parameter variable">--cacert</span><span class="token operator">=</span>/etc/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
    <span class="token parameter variable">--cert</span><span class="token operator">=</span>/etc/etcd/ssl/etcd.pem <span class="token punctuation">\</span>
    <span class="token parameter variable">--key</span><span class="token operator">=</span>/etc/etcd/ssl/etcd-key.pem

<span class="token comment"># 多个成员写个遍历即可</span></code></pre>

<h5 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h5><ul>
<li><p>增 put</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">etcdctl put <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token operator">&lt;</span>value<span class="token operator">></span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>value<span class="token operator">></span> can also be given from stdin<span class="token punctuation">)</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>

<span class="token variable">$etcdctl</span> put /testkey <span class="token string">"test data"</span>
OK

<span class="token variable">$etcdctl</span> get --print-value-only /testkey
<span class="token builtin class-name">test</span> data</code></pre>
</li>
<li><p>删 del</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">etcdctl del <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token punctuation">[</span>range_end<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>

<span class="token variable">$etcdctl</span> del /testkey
<span class="token number">1</span></code></pre>
</li>
<li><p>改 put</p>
<p>直接覆盖即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$etcdctl</span> put /testkey <span class="token string">"test data2"</span>
OK</code></pre>
</li>
<li><p>查 get</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">etcdctl get <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token punctuation">[</span>range_end<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>

<span class="token variable">$etcdctl</span> get --print-value-only /testkey
<span class="token builtin class-name">test</span> data2

<span class="token variable">$etcdctl</span> get <span class="token parameter variable">--prefix</span> --keys-only /		<span class="token comment"># 获取所有key</span>
<span class="token variable">$etcdctl</span> get <span class="token parameter variable">--prefix</span> --keys-only /calico
<span class="token variable">$etcdctl</span> get <span class="token parameter variable">--prefix</span> --keys-only /registry
<span class="token variable">$etcdctl</span> get <span class="token parameter variable">--prefix</span> --keys-only /registry/services
<span class="token variable">$etcdctl</span> get /calico/ipam/v2/handle/ipip-tunnel-addr-k8s-master.ljk.local</code></pre></li>
</ul>
<h5 id="watch-机制"><a href="#watch-机制" class="headerlink" title="watch 机制"></a>watch 机制</h5><p>etcd v3 的 watch 机制支持 watch 某个固定的 key，也支持 watch 一个范围，发生变化就主动触发通知客户端</p>
<p>相比 Etcd v2, Etcd v3 的一些主要变化：</p>
<pre class="language-none"><code class="language-none">1. 接口通过grpc提供rpc接口，放弃了v2的http接口，优势是长连接效率提升明显，缺点是使用不如以前方便，尤其对不方便维护长连接的场景。
2. 废弃了原来的目录结构，变成了纯粹的kv，用户可以通过前缀匹配模式模拟目录
3. 内存中不再保存value，同样的内存可以支持存储更多的key
4. watch机制更稳定，基本上可以通过watch机制实现数据的完全同步
5. 提供了批量操作以及事务机制，用户可以通过批量事务请求来实现Etcd v2的CAS机制（批量事务支持if条件判断）</code></pre>

<p>watch 测试：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在 etcd node1 上watch一个key，没有此 key 也可以执行 watch，后期可以再创建</span>
<span class="token variable">$etcdctl</span> <span class="token function">watch</span> /testkey

<span class="token comment"># 在 etcd node2 修改数据，验证 etcd node1 是否能够发现数据变化</span>
<span class="token variable">$etcdctl</span> put /testkey <span class="token string">"test for new"</span>
OK</code></pre>

<h5 id="数据备份与恢复机制"><a href="#数据备份与恢复机制" class="headerlink" title="数据备份与恢复机制"></a>数据备份与恢复机制</h5><p><strong>v2 版本数据备份与恢复：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份</span>
etcdctl backup --data-dir /var/lib/etcd/ --backup-dir /opt/etcd_backup

<span class="token comment"># 恢复</span>
etcd --data-dir<span class="token operator">=</span>/var/lib/etcd/default.etcd --force-new-cluster <span class="token operator">&amp;</span></code></pre>

<p><strong>v3 版本数据备份与恢复：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">etcdctl snapshot <span class="token operator">&lt;</span>subcommand<span class="token operator">></span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>

subcommand：save、restore、status</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$etcdctl</span> snapshot save snapshot.db		<span class="token comment"># 备份</span>
<span class="token punctuation">..</span>.
Snapshot saved at snapshot.db
<span class="token variable">$file</span> snapshot.db
snapshot.db: data

<span class="token comment"># 恢复，将数据恢复到一个新的不存在的目录中</span>
etcdctl snapshot restore snapshot.db --data-dir<span class="token operator">=</span>/opt/etcd-testdir</code></pre>

<h4 id="cloud-controller-manager"><a href="#cloud-controller-manager" class="headerlink" title="cloud-controller-manager"></a>cloud-controller-manager</h4><p>略…</p>
<h3 id="Node-组件"><a href="#Node-组件" class="headerlink" title="Node 组件"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/components/#node-components">Node 组件</a></h3><p>Node 组件运行在<strong>所有</strong>的节点上，包括 Master</p>
<h4 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h4><p>与 api server 建立联系，监视 api server 中与自己 node 相关的 pod 的变动信息，执行指令操作</p>
<p>在 kubernetes 集群中，每个 Node 节点都会启动 kubelet 进程，处理 Master 节点下发到本节点的任务，管理 Pod 和其中的容器。kubelet 会在 API Server 上注册节点信息，定期向 Master 汇报节点资源使用情况，并通过 cAdvisor（顾问）监控容器和节点资源，可以把 kubelet 理解成 Server&#x2F;Agent 架构中的 agent，kubelet 是 Node 上的 pod 管家</p>
<h4 id="kube-porxy"><a href="#kube-porxy" class="headerlink" title="kube-porxy"></a>kube-porxy</h4><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">https://kubernetes.io/zh/docs/concepts/services-networking/service/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-proxy/">https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-proxy/</a></p>
<p>守护进程，管理当前节点的 iptables 或 ipvs 规则，而且管理的只是和 service 相关的规则</p>
<p>监控 service，把集群上的每一个 service 的定义转换为本地的 ipvs 或 iptables 规则</p>
<p>kube-proxy 是运行在集群中的每个节点上的网络代理，实现了 Kubernetes 服务概念的一部分<br>kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话到 Pods 进行网络通信<br>kube-proxy 使用操作系统包过滤层（如果有的话）并且它是可用的。否则，kube-proxy 将自己转发流量</p>
<h4 id="Container-runtime"><a href="#Container-runtime" class="headerlink" title="Container runtime"></a>Container runtime</h4><p>通常是 docker，其他类型的容器也支持</p>
<h3 id="Addons"><a href="#Addons" class="headerlink" title="Addons"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/components/#addons">Addons</a></h3><p>附加组件扩展了 Kubernetes 的功能</p>
<p>插件使用 Kubernetes 资源(DaemonSet, Deployment，等等)来实现集群特性。因为它们提供了集群级的特性，所以插件的命名空间资源属于 kube-system 命名空间</p>
<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><p>CoreDNS，k8s 中，DNS 是至关重要的，所有的访问都不会基于 ip，而是基于 name，name 再通过 DNS 解析成 ip</p>
<h4 id="Web-UI"><a href="#Web-UI" class="headerlink" title="Web UI"></a>Web UI</h4><h4 id="集群监控系统"><a href="#集群监控系统" class="headerlink" title="集群监控系统"></a>集群监控系统</h4><p>prometheus</p>
<h4 id="集群日志系统"><a href="#集群日志系统" class="headerlink" title="集群日志系统"></a>集群日志系统</h4><p>EFK、LG</p>
<h4 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h4><p>入栈流量控制器，是对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。</p>
<h4 id="…"><a href="#…" class="headerlink" title="…"></a>…</h4><p>附件千千万，按需部署</p>
<h2 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h2><p>CNI：Container Network Interface，容器网络接口</p>
<p>kubernetes 的网络插件遵从 CNI 规范的 v0.4.0 版本</p>
<p>网络插件有很多，最常用的是 flannel 和 Project Calico，生产环境用后者的最多</p>
<p>跨主机 pod 之间通信，有两种虚拟网络，有两种：overlay 和 underlay</p>
<ul>
<li>overlay：叠加网络 ，搭建隧道</li>
<li>underlay：承载网络，设置路由表</li>
</ul>
<h3 id="overlay"><a href="#overlay" class="headerlink" title="overlay"></a>overlay</h3><p>OverLay 其实就是一种隧道技术，VXLAN，NVGRE 及 STT 是典型的三种隧道技术，它们都是通过隧道技术实现大二层网络。将原生态的二层数据帧报文进行封装后在通过隧道进行传输。总之，通过 OverLay 技术，我们在对物理网络不做任何改造的情况下，通过隧道技术在现有的物理网络上创建了一个或多个逻辑网络即虚拟网络，有效解决了物理数据中心，尤其是云数据中心存在 的诸多问题，实现了数据中心的自动化和智能化</p>
<p>以 flannel 为例，默认网段 10.224.1.0&#x2F;16，flannel 在每个节点创建一个网卡 flannel.1，这是一个隧道，网段 10.2441.0&#x2F;32 - 10.244.255&#x2F;32，而每个节点上的容器的 ip 为 10.244.x.1&#x2F;24 - 10.244.x.254&#x2F;24，也就是说 flannel 默认支持最多 256 个节点，每个节点上又最多支持 256 个容器</p>
<h3 id="underlay"><a href="#underlay" class="headerlink" title="underlay"></a>underlay</h3><p>UnderLay 指的是物理网络，它由物理设备和物理链路组成。常见的物理设备有交换机、路由器、防火墙、负载均衡、入侵检测、行为管理等，这些设备通过特定的链路连接起来形成了一个传统的物理网络，这样的物理网络，我们称之为 UnderLay 网络</p>
<p>UnderLay 是底层网络，负责互联互通而 Overlay 是基于隧道技术实现的，overlay 的流量需要跑在 underlay 之上</p>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p>Pod、Deployment、Service 等等，反映在 Etcd 中，就是一张张的表</p>
<p>kube-apiserver 以群组分区资源，群组化管理的 api 使得其可以更轻松地进行扩展，常用的 api 群组分为两类：</p>
<ol>
<li>命名群组：<code>/apis/$GROUP_NAME/$VERSION</code>，例如 <code>/apis/apps/v1</code></li>
<li>核心群组 core：简化了路径，<code>/api/$VERSION</code>，即<code> /api/v1</code></li>
</ol>
<p>打印 kube-apiserver 支持的所有资源：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl api-resources</code></pre>

<h2 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h2><p>资源表中的每一条数据项就是一个对象，例如 Pod 表中的数据项就是 Pod 对象。所以资源表通常不叫 Pod 表、Deployment 表…，而是叫做 PodList、DeploymentList…</p>
<h3 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h3><p>三种方式</p>
<ol>
<li>命令式命令：命令，全部配置通过选项指定</li>
<li>命令式配置文件：命令，加载配置文件</li>
<li>声明式配置文件：声明式命令，加载配置清单，推荐使用</li>
</ol>
<p>配置清单：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 配置清单的规范叫做资源规范,范例：</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
	<span class="token key atrule">name</span><span class="token punctuation">:</span> myPod
	<span class="token key atrule">labels</span><span class="token punctuation">:</span>
		<span class="token key atrule">app</span><span class="token punctuation">:</span> mypod
		<span class="token key atrule">release</span><span class="token punctuation">:</span> canary
<span class="token key atrule">spec</span><span class="token punctuation">:</span>													<span class="token comment"># 期望状态</span>
	<span class="token key atrule">containers</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> demoapp
	  <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/demoapp<span class="token punctuation">:</span>v1.0</code></pre>

<p>资源清单是 yml 格式，api-server 会自动转成 json 格式</p>
<p>如果实际状态和期望状态有出入，控制器的控制循环就会监控到差异，然后将需要做出的更改提交到 apiserver，调度器 scheduler 监控到 apiserver 中有未执行的操作，就会去找适合执行操作的 node，然后提交到 apiserver，kubelet 监控到 apiserver 中有关于自己节点的操作，就会执行操作，将执行结果返回给 apiserver，apiserver 再更新实际状态</p>
<h3 id="查看对象"><a href="#查看对象" class="headerlink" title="查看对象"></a>查看对象</h3><h4 id="外部访问"><a href="#外部访问" class="headerlink" title="外部访问"></a>外部访问</h4><pre class="language-bash" data-language="bash"><code class="language-bash">domain:6643/apis/<span class="token variable">$GROUP_NAME</span>/<span class="token variable">$VERSION</span>/namespaces/<span class="token variable">$NAMESPACE</span>/<span class="token variable">$NAME</span>/<span class="token variable">$API_RESOURCE_NAME</span>
domain:6643/api/<span class="token variable">$VERSION</span>/namespaces/<span class="token variable">$NAMESPACE</span>/<span class="token variable">$NAME</span>/<span class="token variable">$API_RESOURCE_NAME</span>

<span class="token comment"># 范例：</span>
domain:6643/api/v1/namespaces/default/pods/demoapp-5f7d8f9847-tjn4v</code></pre>

<h4 id="内部访问"><a href="#内部访问" class="headerlink" title="内部访问"></a>内部访问</h4><p>以下三种访问方式是一样的：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 方式一，这种方式最方便</span>
kubectl get pods net-tes1 <span class="token parameter variable">-o</span> json<span class="token operator">|</span>yaml
<span class="token comment"># 方式二</span>
kubectl get <span class="token parameter variable">--raw</span> /api/v1/namespaces/default/pods/net-test1
<span class="token comment"># 方式三，这种方式适用于监控</span>
kubectl proxy	<span class="token comment"># 搭建代理</span>
<span class="token function">curl</span> <span class="token number">127.0</span>.0.1:8001/api/v1/namespaces/default/pods/net-test1	<span class="token comment"># 另起一终端</span></code></pre>

<p>注：1.20 之前的版本可以直接<code>curl 127.0.0.1:8080</code>，并且通过<code>--insecure-port</code>可以修改默认的 8080 端口，1.20.4 之后的版本取消了这种不安全的访问方式，只能通过以上方式三，先<code>kubectl proxy</code>代理一下，默认端口也改成了 8001</p>
<blockquote>
<p>The kube-apiserver ability to serve on an insecure port, deprecated since v1.10, has been removed. The insecure address flags <code>--address</code> and <code>--insecure-bind-address</code> have no effect in kube-apiserver and will be removed in v1.24. The insecure port flags <code>--port</code> and <code>--insecure-port</code> may only be set to 0 and will be removed in v1.24. (<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/95856">#95856</a>, <a target="_blank" rel="noopener" href="https://github.com/knight42">@knight42</a>, [SIG API Machinery, Node, Testing])</p>
</blockquote>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$kubectl</span> get pods net-test1 <span class="token parameter variable">-o</span> yaml
 apiVersion: v1
 kind: Pod
<span class="token operator">></span>metadata:
<span class="token operator">></span>spec:
<span class="token operator">></span>status:</code></pre>

<p>以上返回的数据，每个字段表示的意义可以通过 <code>kubectl explain</code> 查询帮助</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl explain <span class="token operator">&lt;</span>type<span class="token operator">></span>.<span class="token operator">&lt;</span>fieldName<span class="token operator">></span><span class="token punctuation">[</span>.<span class="token operator">&lt;</span>fieldName<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$kubectl</span> explain pod.apiVersion
KIND:     Pod
VERSION:  v1

FIELD:    apiVersion <span class="token operator">&lt;</span>string<span class="token operator">></span>

DESCRIPTION:
     APIVersion defines the versioned schema of this representation of an
     object. Servers should convert recognized schemas to the latest internal
     value, and may reject unrecognized values. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="token comment">#resources</span>

<span class="token comment"># 范例</span>
<span class="token variable">$kubectl</span> explain pod.kind
<span class="token variable">$kubectl</span> explain pod.metadata
<span class="token variable">$kubectl</span> explain pod.spec</code></pre>

<h2 id="lease-租约"><a href="#lease-租约" class="headerlink" title="lease 租约"></a>lease 租约</h2><p>lease 是分布式系统中一个常见的概念，用于代表一个分布式租约。典型情况下，在分布式系统中需要去检测一个节点是否存活的时，就需要租约机制。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610675848800.png"></p>
<p>上图示例中的代码示例首先创建了一个 10s 的租约，如果创建租约后不做任何的操作，那么 10s 之后，这个租约就会自动过期。接着将 key1 和 key2 两个 key value 绑定到这个租约之上，这样当租约过期时 etcd 就会自动清理掉 key1 和 key2，使得节点 key1 和 key2 具备了超时自动删除的能力。</p>
<p>如果希望这个租约永不过期，需要周期性的调用 KeeyAlive 方法刷新租约。比如说需要检测分布式系统中一个进程是否存活，可以在进程中去创建一个租约，并在该进程中周期性的调用 KeepAlive 的方法。如果一切正常，该节点的租约会一致保持，如果这个进程挂掉了，最终这个租约就会自动过期。</p>
<p>在 etcd 中，允许将多个 key 关联在同一个 lease 之上，这个设计是非常巧妙的，可以大幅减少 lease 对象刷新带来的开销。试想一下，如果有大量的 key 都需要支持类似的租约机制，每一个 key 都需要独立的去刷新租约，这会给 etcd 带来非常大的压力。通过多个 key 绑定在同一个 lease 的模式，我们可以将超时间相似的 key 聚合在一起，从而大幅减小租约刷新的开销，在不失灵活性同时能够大幅提高 etcd 支持的使用规模。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/ELK/logstash%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E6%A1%88%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/ELK/logstash%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E6%A1%88%E4%BE%8B/" class="post-title-link" itemprop="url">logstash收集日志案例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-05 10:24:34" itemprop="dateCreated datePublished" datetime="2021-03-05T10:24:34+08:00">2021-03-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="tomcat-日志"><a href="#tomcat-日志" class="headerlink" title="tomcat 日志"></a>tomcat 日志</h2><p>tomcat 默认的格式比较简单，包含 ip、date、method、url、status code 等信息，例如：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:09 +0800<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">11156</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /tomcat.svg HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">67795</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /tomcat.css HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">5542</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /bg-nav.png HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">1401</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /bg-middle.png HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">1918</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /bg-upper.png HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">3103</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /bg-button.png HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">713</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /asf-logo-wide.svg HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">27235</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:10 +0800<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">21630</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:12 +0800<span class="token punctuation">]</span> <span class="token string">"GET /manager/status HTTP/1.1"</span> <span class="token number">403</span> <span class="token number">3446</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:14 +0800<span class="token punctuation">]</span> <span class="token string">"GET /manager/html HTTP/1.1"</span> <span class="token number">403</span> <span class="token number">3446</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:19 +0800<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">11156</span>
<span class="token number">10.0</span>.0.1 - - <span class="token punctuation">[</span>06/Mar/2021:09:26:19 +0800<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">21630</span></code></pre>

<ol>
<li><p>为了 kibana 能单独统计每个字段，需要日志记录成 json 格式，当然也可以是其他格式，只要有对应的 codec 插件可以解析就行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk conf<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/local/tomcat/conf
<span class="token punctuation">[</span>root@elk2-ljk conf<span class="token punctuation">]</span><span class="token variable">$vim</span> server.xml		<span class="token comment"># 自定义日志格式 为json格式</span>
<span class="token punctuation">..</span>.
        <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span>
               <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"tomcat_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".log"</span>
               <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;: &amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,    &amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;"</span> /<span class="token operator">></span>
<span class="token punctuation">..</span>.

<span class="token comment"># &amp;quot; 表示双引号</span>

<span class="token punctuation">[</span>root@elk2-ljk conf<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart tomcat.service	<span class="token comment"># 重启tomcat</span>
<span class="token comment"># 查看日志，已经成功修改为json格式</span>
<span class="token punctuation">[</span>root@elk2-ljk logs<span class="token punctuation">]</span><span class="token variable">$cat</span> <span class="token punctuation">..</span>/logs/tomcat_access_log.2021-03-06.log
<span class="token punctuation">&#123;</span><span class="token string">"clientip"</span><span class="token builtin class-name">:</span><span class="token string">"10.0.0.1"</span>,<span class="token string">"ClientUser"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"authenticated"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"AccessTime"</span><span class="token builtin class-name">:</span><span class="token string">"[06/Mar/2021:12:50:56 +0800]"</span>,<span class="token string">"method"</span><span class="token builtin class-name">:</span><span class="token string">"GET / HTTP/1.1"</span>,<span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"200"</span>,<span class="token string">"SendBytes"</span><span class="token builtin class-name">:</span>       <span class="token string">"11156"</span>,<span class="token string">"Query?string"</span><span class="token builtin class-name">:</span><span class="token string">""</span>,<span class="token string">"partner"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"AgentVersion"</span><span class="token builtin class-name">:</span><span class="token string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token string">"clientip"</span><span class="token builtin class-name">:</span><span class="token string">"10.0.0.1"</span>,<span class="token string">"ClientUser"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"authenticated"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"AccessTime"</span><span class="token builtin class-name">:</span><span class="token string">"[06/Mar/2021:12:50:56 +0800]"</span>,<span class="token string">"method"</span><span class="token builtin class-name">:</span><span class="token string">"GET /favicon.ico HTTP/1.1"</span>,<span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"200"</span>,        <span class="token string">"SendBytes"</span><span class="token builtin class-name">:</span><span class="token string">"21630"</span>,<span class="token string">"Query?string"</span><span class="token builtin class-name">:</span><span class="token string">""</span>,<span class="token string">"partner"</span><span class="token builtin class-name">:</span><span class="token string">"http://10.0.1.122:8080/"</span>,<span class="token string">"AgentVersion"</span><span class="token builtin class-name">:</span><span class="token string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like  Gecko) Chrome/88.0.4324.190 Safari/537.36"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token string">"clientip"</span><span class="token builtin class-name">:</span><span class="token string">"10.0.0.1"</span>,<span class="token string">"ClientUser"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"authenticated"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"AccessTime"</span><span class="token builtin class-name">:</span><span class="token string">"[06/Mar/2021:12:51:00 +0800]"</span>,<span class="token string">"method"</span><span class="token builtin class-name">:</span><span class="token string">"GET / HTTP/1.1"</span>,<span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"200"</span>,<span class="token string">"SendBytes"</span><span class="token builtin class-name">:</span>       <span class="token string">"11156"</span>,<span class="token string">"Query?string"</span><span class="token builtin class-name">:</span><span class="token string">""</span>,<span class="token string">"partner"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"AgentVersion"</span><span class="token builtin class-name">:</span><span class="token string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36"</span><span class="token punctuation">&#125;</span></code></pre>

<p>百度搜索 “tomcat 日志格式” 或 “apache 日志格式”，下面是部分格式说明：</p>
<pre class="language-none"><code class="language-none">％a - 远程IP地址
％A - 本地IP地址
％b - 发送的字节数，不包括HTTP头，或“ - ”如果没有发送字节
％B - 发送的字节数，不包括HTTP头
％h - 远程主机名
％H - 请求协议
％l (小写的L)- 远程逻辑从identd的用户名（总是返回&#39; - &#39;）
％m - 请求方法
％p - 本地端口
％q - 查询字符串（在前面加上一个“？”如果它存在，否则是一个空字符串
％r - 第一行的要求
％s - 响应的HTTP状态代码
％S - 用户会话ID
％t - 日期和时间，在通用日志格式
％u - 远程用户身份验证
％U - 请求的URL路径
％v - 本地服务器名
％D - 处理请求的时间（以毫秒为单位）
％T - 处理请求的时间（以秒为单位）
％I （大写的i） - 当前请求的线程名称

％&#123;XXX&#125;i xxx代表传入的头(HTTP Request)
％&#123;XXX&#125;o xxx代表传出​​的响应头(Http Resonse)
％&#123;XXX&#125;c  xxx代表特定的Cookie名
％&#123;XXX&#125;r  xxx代表ServletRequest属性名
％&#123;XXX&#125;s xxx代表HttpSession中的属性名</code></pre>
</li>
<li><p>logstash 配置文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"tomcat-access-log"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/usr/local/tomcat/logs/tomcat_access_log.*.log"</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"end"</span>
        stat_interval <span class="token operator">=</span><span class="token operator">></span> <span class="token number">3</span>
        codec <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"json"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"tomcat-access-log"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.1.121:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"mytest-%&#123;type&#125;-%&#123;+xxxx.ww&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>重启 logstash，注意要以 root 用户身份启动，否则无法采集数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart logstash.service</code></pre></li>
</ol>
<h2 id="java-日志"><a href="#java-日志" class="headerlink" title="java 日志"></a>java 日志</h2><p>基于 java 开发的应用，都会有 java 日志，java 日志会记录 java 的报错信息，但是一个报错会产生多行日志，例如：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615022486227.png"></p>
<p>为了方便观察，需要将一个报错的多行日志合并为一行，以 elasticsearch 为例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"elasticsearch-java-log"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/data/elasticsearch/logs/es-cluster.log"</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"beginning"</span>
        stat_interval <span class="token operator">=</span><span class="token operator">></span> <span class="token number">3</span>
        codec <span class="token operator">=</span><span class="token operator">></span> multiline <span class="token punctuation">&#123;</span>
            pattern <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"^\["</span>
            negate <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">true</span>
            what <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"previous"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.1.121:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"mytest-%&#123;type&#125;-%&#123;+yyyy.MM&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>查看 kibana：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615023193996.png"></p>
<h2 id="nginx-访问日志"><a href="#nginx-访问日志" class="headerlink" title="nginx 访问日志"></a>nginx 访问日志</h2><p>和采集 tomcat 日志类似，重点是把 nginx 日志修改为 json 格式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 注意：log_format要写在server外面</span>
<span class="token punctuation">[</span>root@47105171233 vhost<span class="token punctuation">]</span><span class="token variable">$cat</span> lujinkai.cn.conf
log_format access_json <span class="token string">'&#123;"@timestamp":"$time_iso8601",'</span>
<span class="token string">'"host":"$server_addr",'</span>
<span class="token string">'"clientip":"$remote_addr",'</span>
<span class="token string">'"size":$body_bytes_sent,'</span>
<span class="token string">'"responsetime":$request_time,'</span>
<span class="token string">'"upstreamtime":"$upstream_response_time",'</span>
<span class="token string">'"upstreamhost":"$upstream_addr",'</span>
<span class="token string">'"http_host":"$host",'</span>
<span class="token string">'"url":"$uri",'</span>
<span class="token string">'"domain":"$host",'</span>
<span class="token string">'"xff":"$http_x_forwarded_for",'</span>
<span class="token string">'"referer":"$http_referer",'</span>
<span class="token string">'"status":"$status"&#125;'</span><span class="token punctuation">;</span>

server <span class="token punctuation">&#123;</span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  server_name lujinkai.cn<span class="token punctuation">;</span>
  access_log /data/wwwlogs/lujinkai.cn_nginx.log access_json<span class="token punctuation">;</span>
  rewrite / http://blog.lujinkai.cn permanent<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 日志成功转为json格式</span>
<span class="token punctuation">[</span>root@47105171233 wwwlogs<span class="token punctuation">]</span><span class="token variable">$tail</span> <span class="token parameter variable">-f</span> lujinkai.cn_nginx.log
<span class="token punctuation">&#123;</span><span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2021-03-06T18:20:13+08:00"</span>,<span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"10.0.0.1"</span>,<span class="token string">"clientip"</span><span class="token builtin class-name">:</span><span class="token string">"113.120.245.191"</span>,<span class="token string">"size"</span>:162,<span class="token string">"responsetime"</span>:0.000,<span class="token string">"upstreamtime"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"upstreamhost"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"http_host"</span><span class="token builtin class-name">:</span><span class="token string">"lujinkai.cn"</span>,<span class="token string">"url"</span><span class="token builtin class-name">:</span><span class="token string">"/"</span>,<span class="token string">"domain"</span><span class="token builtin class-name">:</span><span class="token string">"lujinkai.cn"</span>,<span class="token string">"xff"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"referer"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"301"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"2021-03-06T18:20:13+08:00"</span>,<span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"10.0.0.1"</span>,<span class="token string">"clientip"</span><span class="token builtin class-name">:</span><span class="token string">"113.120.245.191"</span>,<span class="token string">"size"</span>:162,<span class="token string">"responsetime"</span>:0.000,<span class="token string">"upstreamtime"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"upstreamhost"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"http_host"</span><span class="token builtin class-name">:</span><span class="token string">"lujinkai.cn"</span>,<span class="token string">"url"</span><span class="token builtin class-name">:</span><span class="token string">"/robots.txt"</span>,<span class="token string">"domain"</span><span class="token builtin class-name">:</span><span class="token string">"lujinkai.cn"</span>,<span class="token string">"xff"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"referer"</span><span class="token builtin class-name">:</span><span class="token string">"-"</span>,<span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"301"</span><span class="token punctuation">&#125;</span></code></pre>

<h2 id="TCP-x2F-UDP-日志"><a href="#TCP-x2F-UDP-日志" class="headerlink" title="TCP&#x2F;UDP 日志"></a>TCP&#x2F;UDP 日志</h2><p>场景：没有安装 logstash 的服务器（A），向安装了 logstash 的服务器（B）发送日志信息，这个场景不多</p>
<p>实现：A 通过 nc 命令给 B 发送日志信息，B 监听本地的对应端口，接收数据</p>
<p>A：客户端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk ~<span class="token punctuation">]</span><span class="token variable">$nc</span> <span class="token number">10.0</span>.1.121 <span class="token number">9889</span></code></pre>

<p>B：服务端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9889</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"tcplog"</span>
        mode <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"server"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span>
    	codec <span class="token operator">=</span><span class="token operator">></span> rubydebug
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="通过-rsyslog-收集-haproxy-日志"><a href="#通过-rsyslog-收集-haproxy-日志" class="headerlink" title="通过 rsyslog 收集 haproxy 日志"></a>通过 rsyslog 收集 haproxy 日志</h2><p>有些设备无法安装 logstash，例如 路由器、交换机，但是厂家内置了 rsyslog 功能，这里以 haproxy 为例</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. haproxy.cfg 定义haproxy的日志设备为local6</span>
log <span class="token number">127.0</span>.0.1 local6 info

<span class="token comment"># 2. rsyslog.conf</span>
module<span class="token punctuation">(</span>load<span class="token operator">=</span><span class="token string">"imudp"</span><span class="token punctuation">)</span>
input<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">"imudp"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"514"</span><span class="token punctuation">)</span>
module<span class="token punctuation">(</span>load<span class="token operator">=</span><span class="token string">"imtcp"</span><span class="token punctuation">)</span>
input<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">"imtcp"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"514"</span><span class="token punctuation">)</span>
local6.* @@10.0.1.122

<span class="token comment"># 3. 10.0.1.122主机监听本机的udp514端口，接收日志数据</span>
input<span class="token punctuation">&#123;</span>
    syslog <span class="token punctuation">&#123;</span>
    	<span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"ststem-rsyslog"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output<span class="token punctuation">&#123;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.1.123:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"logstash-rsyslog-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="filebeat-收集日志并写入-redis-x2F-kafka"><a href="#filebeat-收集日志并写入-redis-x2F-kafka" class="headerlink" title="filebeat 收集日志并写入 redis&#x2F;kafka"></a>filebeat 收集日志并写入 redis&#x2F;kafka</h2><p>考虑到 elasticsearch 的性能问题，通常不会直接往 elasticsearch 写日志，会加 redis 或 kafka 缓冲一下</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615130970319.png"></p>
<ul>
<li>有少数场景，需要收集多个不同格式的日志，例如有的是 syslog 格式，有的是 json 格式，所有的日志都 output 到 redis 的一个 list 中，因为 logstash 的 input 没有条件判断，只能配置一个 codec，所以 logstash 可以将不同的日志发送到 elasticsearch 的不同 index，却无法对不同的日志格式配置不同的 codec，这样的数据最后展示在 kibana 也没有意义，解决方法是在日志收集和日志缓存中间在加一个 logstash（可以共用日志提取及过滤的 logstash），将不同的日志转发到 redis 的不同 list</li>
<li>日志缓存如果用 redis，需要大内存，推荐 32G；如果用 kafka，16G 就够，因为 kafka 存储数据到磁盘</li>
</ul>
<h2 id="日志收集实战"><a href="#日志收集实战" class="headerlink" title="日志收集实战"></a>日志收集实战</h2><p><img data-src="//img.to2b.cn/blog/ljk/1615135063740.png"></p>
<p>从左向右看，当要访问 ELK 日志统计平台的时候，首先访问的是两台 nginx+keepalived 做的负载高可用，访问的地址是 keepalived 的 IP，当一台 nginx 代理服务器挂掉之后也不影响访问，然后 nginx 将请求转发到 kibana，kibana 再去 elasticsearch 获取数据，elasticsearch 是两台做的集群，数据会随机保存在任意一台 elasticsearch 服务器，redis 服务器做数据的临时保存，避免 web 服务器日志量过大的时候造成的数据收集与保存不一致导致的日志丢失，可以临时保存到 redis，redis 可以是集群，然后再由 logstash 服务器在非高峰时期从 redis 持续的取出即可，另外有一台 mysql 数据库服务器，用于持久化保存特定的数据，web 服务器的日志由 filebeat 收集之后发送给另外的一台 logstash，再有其写入到 redis 即可完成日志的收集，从图中可以看出，redis 服务器处于前端结合的最中间，其左右都要依赖于 redis 的正常运行，web 服务删个日志经过 filebeat 收集之后通过日志转发层的 logstash 写入到 redis 不同的 key 当中，然后提取层 logstash 再从 redis 将数据提取并安按照不同的类型写入到 elasticsearch 的不同 index 当中，用户最终通过 nginx 代理的 kibana 查看到收集到的日志的具体内容</p>
<h2 id="通过坐标地图统计客户-IP-所在城市"><a href="#通过坐标地图统计客户-IP-所在城市" class="headerlink" title="通过坐标地图统计客户 IP 所在城市"></a>通过坐标地图统计客户 IP 所在城市</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-geoip.html">https://www.elastic.co/guide/en/logstash/current/plugins-filters-geoip.html</a></p>
<h2 id="日志写入数据库"><a href="#日志写入数据库" class="headerlink" title="日志写入数据库"></a>日志写入数据库</h2><p>写入数据库的目的是用于持久化保存重要数据，比如状态码、客户端 IP、客户端浏览器版本等等，用于后期按月做数据统计等</p>
<p>写个脚本从，定期从 elasticsearch 中获取数据，写入到 PostgreSQL</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/MGR/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/MGR/" class="post-title-link" itemprop="url">MGR</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-03 10:27:20" itemprop="dateCreated datePublished" datetime="2021-03-03T10:27:20+08:00">2021-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/ELK/ELK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/ELK/ELK/" class="post-title-link" itemprop="url">ELK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-03 08:30:51" itemprop="dateCreated datePublished" datetime="2021-03-03T08:30:51+08:00">2021-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="什么是-ELK"><a href="#什么是-ELK" class="headerlink" title="什么是 ELK"></a>什么是 ELK</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/what-is/elk-stack">https://www.elastic.co/cn/what-is/elk-stack</a></p>
<p>ELK 全称 ELK Stack，它的更新换代产品叫 Elastic Stack</p>
<p>ELK &#x3D; Elasticsearch + Logstash + Kibana</p>
<ul>
<li>Elasticsearch：搜索和分析引擎</li>
<li>Logstash：服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到诸如 Elasticsearch 等“存储库”中</li>
<li>Kibana：让用户在 Elasticsearch 中使用图形和图表对数据进行可视化</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1614731653192.png"></p>
<h3 id="什么是-Elasticsearch"><a href="#什么是-Elasticsearch" class="headerlink" title="什么是 Elasticsearch"></a>什么是 Elasticsearch</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/what-is/elasticsearch">https://www.elastic.co/cn/what-is/elasticsearch</a></p>
<h3 id="什么是-Logstash"><a href="#什么是-Logstash" class="headerlink" title="什么是 Logstash"></a>什么是 Logstash</h3><p>Logstash 是 Elastic Stack 的核心产品之一，可用来对数据进行聚合和处理，并将数据发送到 Elasticsearch。Logstash 是一个开源的服务器端数据处理管道，允许您在将数据索引到 Elasticsearch 之前同时从多个来源采集数据，并对数据进行充实和转换。</p>
<h3 id="什么是-kibana"><a href="#什么是-kibana" class="headerlink" title="什么是 kibana"></a>什么是 kibana</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/what-is/kibana">https://www.elastic.co/cn/what-is/kibana</a></p>
<h3 id="为什么使用-ELK"><a href="#为什么使用-ELK" class="headerlink" title="为什么使用 ELK"></a>为什么使用 ELK</h3><p>ELK 组件在海量日志系统的运维中，可用于解决以下主要问题：</p>
<ul>
<li>分布式日志数据统一收集，实现集中式查询和管理</li>
<li>故障排查</li>
<li>安全信息和事件管理</li>
<li>报表功能</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1614734003034.png"></p>
<h2 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>参考博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/qdhxhz/p/11448451.html">https://www.cnblogs.com/qdhxhz/p/11448451.html</a></p>
<p>重点理解 index 和 document 这两个概念：index（索引）类似 kafka 的 topic，oss 的 bucket，要尽量控制 index 的数量；index 中的单条数据称为 document（文档），相当于 mysql 表中的行</p>
<p>之前的版本中，索引和文档中间还有个 type（类型）的概念，每个索引下可以建立多个 type，document 存储时需要指定 index 和 type，因为一个 index 中的 type 并不隔离，document 不能重名，所以 type 并没有多少意义。从 7.0 版本开始，一个 index 只能建一个名为_doc 的 type，8.0.0 以后将完全取消</p>
<p>下面是一个 document 的源数据：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614868627749.png"></p>
<ul>
<li><code>_index</code>：文档所属索引名称</li>
<li><code>_type</code>：文档所属类型名</li>
<li><code>_id</code>：doc 主键，写入时指定，如果不指定，则系统自动生成一个唯一的 UUID 值</li>
<li><code>_version</code>：doc 版本信息，保证 doc 的变更能以正确的顺序执行，避免乱序造成的数据丢失</li>
<li><code>_seq_no</code>：严格递增的顺序号，shard 级别严格递增，保证后写入的 doc 的<code>_seq_no</code>大于先写入的 doc 的_seq_no</li>
<li><code>_primary_term</code>：和<code>_seq_no</code>一样是一个整数，每当 primary shard 发生重新分配时，比如重启，primary 选举等，_primary_term 会递增 1</li>
<li><code>found</code>：查询的 ID 正确那么 ture, 如果 Id 不正确，就查不到数据，found 字段就是 false</li>
<li><code>_source</code>：文档的原始 JSON 数据</li>
</ul>
<h3 id="apt-安装"><a href="#apt-安装" class="headerlink" title="apt 安装"></a>apt 安装</h3><p><strong>elasticsearch 集群中 master 与 slave 的区别：</strong></p>
<p>master：统计各节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭节点等<br>slave：从 master 同步数据、等待机会成为 master</p>
<ol>
<li><p>apt 安装</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> elasticsearch-7.11.1-amd64.deb</code></pre>

<p>主要目录：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/usr/share/elasticsearch	<span class="token comment"># 主目录</span>
/etc/elasticsearch			<span class="token comment"># 配置文件目录</span>
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>修改 hosts</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/hosts
<span class="token punctuation">..</span>.
<span class="token number">10.0</span>.1.121 elk1-ljk.local
<span class="token number">10.0</span>.1.122 elk2-ljk.local
<span class="token number">10.0</span>.1.123 elk3-ljk.local</code></pre>
</li>
<li><p>修改配置文件 elasticsearch.yml</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk /<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token string">'^[a-Z]'</span> /etc/elasticsearch/elasticsearch.yml
cluster.name: es-cluster            <span class="token comment"># ELK的集群名称，名称相同即属于是同一个集群</span>
node.name: node-2                   <span class="token comment"># 当前节点在集群内的节点名称</span>
path.data: /data/elasticsearch/data <span class="token comment"># ES数据保存目录</span>
path.logs: /data/elasticsearch/logs <span class="token comment"># ES日志保存目</span>
bootstrap.memory_lock: <span class="token boolean">true</span>         <span class="token comment"># 服务启动的时候锁定足够的内存，防止数据写入swap</span>
network.host: <span class="token number">10.0</span>.1.122            <span class="token comment"># 监听本机ip</span>
http.port: <span class="token number">9200</span>                     <span class="token comment"># 监听端口</span>
<span class="token comment"># 集群中node节点发现列表，最好使用hostname，这里为了方便，使用ip</span>
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"elk1-ljk.local"</span>, <span class="token string">"elk2-ljk.local"</span>, <span class="token string">"elk3-ljk.local"</span><span class="token punctuation">]</span>
<span class="token comment"># 集群初始化那些节点可以被选举为master</span>
cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"node-1"</span>, <span class="token string">"node-2"</span>, <span class="token string">"node-3"</span><span class="token punctuation">]</span>
gateway.recover_after_nodes: <span class="token number">2</span> <span class="token comment"># 一个集群中的 N 个节点启动后,才允许进行数据恢复处理，默认是 1</span>
<span class="token comment"># 设置是否可以通过正则或者_all 删除或者关闭索引库，默认 true 表示必须需要显式指定索引库名称，生产环境建议设置为 true，删除索引库的时候必须指定，否则可能会误删索引库中的索引库</span>
action.destructive_requires_name: <span class="token boolean">true</span></code></pre>
</li>
<li><p>修改内存限制</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$vim</span> /usr/lib/systemd/system/elasticsearch.service
<span class="token punctuation">..</span>.
<span class="token assign-left variable">LimitMEMLOCK</span><span class="token operator">=</span>infinity	<span class="token comment"># 无限制使用内存</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$vim</span> /usr/local/elasticsearch/config/jvm.options
<span class="token parameter variable">-Xms2g</span>	<span class="token comment"># 最小内存限制</span>
<span class="token parameter variable">-Xmx2g</span>	<span class="token comment"># 最大内存限制</span></code></pre>
</li>
<li><p>创建数据目录并修改属主</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$mkdir</span> <span class="token parameter variable">-p</span> /data/elasticsearch
<span class="token punctuation">[</span>root@elk3-ljk src<span class="token punctuation">]</span><span class="token variable">$chown</span> <span class="token parameter variable">-R</span> elasticsearch:elasticsearch /data/elasticsearch</code></pre>
</li>
<li><p>启动</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk1-ljk src<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start elasticsearch.service 	<span class="token comment"># 稍等几分钟</span>

<span class="token punctuation">[</span>root@elk1-ljk ~<span class="token punctuation">]</span><span class="token variable">$curl</span> http://10.0.1.121:9200/_cat/nodes
<span class="token number">10.0</span>.1.123 <span class="token number">13</span> <span class="token number">96</span> <span class="token number">0</span> <span class="token number">0.14</span> <span class="token number">0.32</span> <span class="token number">0.22</span> cdhilmrstw - node-3
<span class="token number">10.0</span>.1.122 <span class="token number">28</span> <span class="token number">97</span> <span class="token number">0</span> <span class="token number">0.01</span> <span class="token number">0.02</span> <span class="token number">0.02</span> cdhilmrstw * node-2		<span class="token comment"># master</span>
<span class="token number">10.0</span>.1.121 <span class="token number">26</span> <span class="token number">96</span> <span class="token number">2</span> <span class="token number">0.13</span> <span class="token number">0.07</span> <span class="token number">0.03</span> cdhilmrstw - node-1</code></pre></li>
</ol>
<h3 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h3><p>启动总是失败，各种报错，解决不了…</p>
<h3 id="安装-elasticsearch-插件"><a href="#安装-elasticsearch-插件" class="headerlink" title="安装 elasticsearch 插件"></a>安装 elasticsearch 插件</h3><p>插件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对 elasticsearch 集群的状态监控与管理配置等功能</p>
<h4 id="head-插件"><a href="#head-插件" class="headerlink" title="head 插件"></a>head 插件</h4><p>在 elasticsearch 5.x 版本以后不再支持直接安装 head 插件，而是需要通过启动一个服务方式</p>
<p>github 地址：<a target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># git太慢，这里用迅雷下载zip包，然后上传</span>
<span class="token punctuation">[</span>root@elk1-ljk src<span class="token punctuation">]</span><span class="token variable">$unzip</span> master.zip
<span class="token punctuation">[</span>root@elk1-ljk src<span class="token punctuation">]</span><span class="token variable">$cd</span> elasticsearch-head-master/
<span class="token punctuation">[</span>root@elk1-ljk elasticsearch-head-master<span class="token punctuation">]</span><span class="token variable">$npm</span> <span class="token function">install</span> grunt <span class="token parameter variable">-save</span>
<span class="token punctuation">[</span>root@elk1-ljk elasticsearch-head-master<span class="token punctuation">]</span><span class="token variable">$npm</span> <span class="token function">install</span>	<span class="token comment"># 这一步要等很久</span>
<span class="token punctuation">[</span>root@elk1-ljk elasticsearch-head-master<span class="token punctuation">]</span><span class="token variable">$npm</span> run start	<span class="token comment"># 前台启动</span>

<span class="token comment"># 开启跨域访问支持，每个节点都需要开启</span>
<span class="token punctuation">[</span>root@elk3-ljk ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/elasticsearch/elasticsearch.yml
<span class="token punctuation">..</span>.
http.cors.enabled: <span class="token boolean">true</span>
http.cors.allow-origin: <span class="token string">"*"</span>

<span class="token punctuation">[</span>root@elk2-ljk games<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart elasticsearch.service 	<span class="token comment"># 重启elasticsearch</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1614790916767.png"></p>
<h4 id="kopf-插件"><a href="#kopf-插件" class="headerlink" title="kopf 插件"></a>kopf 插件</h4><p>过时的插件，只支持 elasticsearc 1.x 或 2.x 的版本</p>
<h4 id="cerebro-插件"><a href="#cerebro-插件" class="headerlink" title="cerebro 插件"></a>cerebro 插件</h4><p>新开源的 elasticsearch 集群 web 管理程序，需要 java11 或者更高版本</p>
<p>github 地址：<a target="_blank" rel="noopener" href="https://github.com/lmenezes/cerebro">https://github.com/lmenezes/cerebro</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$unzip</span> cerebro-0.9.3.zip
<span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$cd</span> cerebro-0.9.3/
<span class="token punctuation">[</span>root@elk2-ljk cerebro-0.9.3<span class="token punctuation">]</span><span class="token variable">$vim</span> conf/application.conf
<span class="token punctuation">..</span>.
<span class="token comment"># host列表</span>
hosts <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">host</span> <span class="token operator">=</span> <span class="token string">"http://10.0.1.122:9200"</span>
    name <span class="token operator">=</span> <span class="token string">"es-cluster1"</span>  <span class="token comment"># host的名称，如果有多个elasticsearch集群，可以用这个name区分</span>
  <span class="token comment">#  headers-whitelist = [ "x-proxy-user", "x-proxy-roles", "X-Forwarded-For" ]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@elk2-ljk cerebro-0.9.3<span class="token punctuation">]</span>$./bin/cerebro 	<span class="token comment"># 前台启动</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1614790940334.png"></p>
<h3 id="监控-elasticsearch-集群状态"><a href="#监控-elasticsearch-集群状态" class="headerlink" title="监控 elasticsearch 集群状态"></a>监控 elasticsearch 集群状态</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk3-ljk ~<span class="token punctuation">]</span><span class="token variable">$curl</span> http://10.0.1.122:9200/_cluster/health?pretty<span class="token operator">=</span>true
<span class="token punctuation">&#123;</span>
  <span class="token string">"cluster_name"</span> <span class="token builtin class-name">:</span> <span class="token string">"es-cluster"</span>,
  <span class="token string">"status"</span> <span class="token builtin class-name">:</span> <span class="token string">"green"</span>,	<span class="token comment"># green：运行正常、yellow：副本分片丢失、red：主分片丢失</span>
  <span class="token string">"timed_out"</span> <span class="token builtin class-name">:</span> false,
  <span class="token string">"number_of_nodes"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
  <span class="token string">"number_of_data_nodes"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
  <span class="token string">"active_primary_shards"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"active_shards"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"relocating_shards"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"initializing_shards"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"unassigned_shards"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"delayed_unassigned_shards"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"number_of_pending_tasks"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"number_of_in_flight_fetch"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"task_max_waiting_in_queue_millis"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"active_shards_percent_as_number"</span> <span class="token builtin class-name">:</span> <span class="token number">100.0</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>如果是单节点，status 会显示 yellow，设置副本数为 0 即可解决：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk1-ljk ~<span class="token punctuation">]</span><span class="token variable">$curl</span> <span class="token parameter variable">-X</span> PUT <span class="token string">"10.0.1.121:9200/_settings"</span> <span class="token parameter variable">-H</span> <span class="token string">'Content-Type: application/json'</span> -d<span class="token string">' &#123;"number_of_replicas":0&#125;'</span>
<span class="token punctuation">&#123;</span><span class="token string">"acknowledged"</span>:true<span class="token punctuation">&#125;</span></code></pre>

<p>或者：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615007863772.png"></p>
<h4 id="zabbix-添加监控"><a href="#zabbix-添加监控" class="headerlink" title="zabbix 添加监控"></a>zabbix 添加监控</h4><h2 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h2><p>官方参考文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/index.html">https://www.elastic.co/guide/en/logstash/current/index.html</a></p>
<p><font color=red> logstash 是一个具有 3 个阶段的处理<strong>管道</strong>：输入 –&gt; 过滤器 –&gt; 输出  </font></p>
<p><font color=red>输入生成事件，过滤器修改数据（日志），输出将数据（日志）发送到其他地方</font></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614827175253.png"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>logstash 依赖 java，可以自己配置 java 环境，如果不配置，logstash 会使用其自带的 openjdk</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk src<span class="token punctuation">]</span><span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> logstash-7.11.1-amd64.deb

<span class="token comment"># 修改启动用户为root，不然因为权限问题，后面会出现各种莫名其妙的错误，有些根本找不到报错</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/systemd/system/logstash.service
<span class="token punctuation">..</span>.
<span class="token assign-left variable">User</span><span class="token operator">=</span>root
<span class="token assign-left variable">Group</span><span class="token operator">=</span>root
<span class="token punctuation">..</span>.</code></pre>

<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk bin<span class="token punctuation">]</span>$./logstash <span class="token parameter variable">--help</span></code></pre>

<ul>
<li><p>-n：node name，就是节点的 hostname，例如：elk2-ljk.local</p>
</li>
<li><p>-f：从特定的文件或目录加载 logstash 配置。如果给定一个目录，该目录中的所有文件将按字典顺序合并，然后作为单个配置文件进行解析。您还可以指定通配符(globs)，任何匹配的文件将按照上面描述的顺序加载</p>
</li>
<li><p>-e：从命令行加载 logstash 配置，一般不用</p>
</li>
<li><p>-t：检查配置文件是否合法，配合-f 使用，-f 指定配置文件，-t 检查</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例：检查test.conf的合法性</span>
$/usr/share/logstash/bin/logstash <span class="token parameter variable">-f</span> /etc/logstash/conf.d/test.conf <span class="token parameter variable">-t</span></code></pre>
</li>
<li><p>…</p>
</li>
</ul>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>logstash 的输入和输出都依赖插件</p>
<p>不同的插件使用不同的配置，但是所有输入插件都支持以下配置选项：</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-add_field"><code>add_field</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#hash">hash</a></td>
<td>Add a field to an event</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-codec"><code>codec</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#codec">codec</a></td>
<td>用于输入数据的编解码器。输入编解码器是一种方便的方法，可以在数据进入输入之前对其进行解码，而不需要在 Logstash 管道中使用单独的过滤器</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-enable_metric"><code>enable_metric</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#boolean">boolean</a></td>
<td>Disable or enable metric logging for this specific plugin instance by default we record all the metrics we can, but you can disable metrics collection for a specific plugin.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-id"><code>id</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#string">string</a></td>
<td>唯一的 ID，如果没有指定，logstash 会自动生成一个，尤其是多个相同类型的插件时，强烈建议配置此项，例如有多个 file 输入，应当配置此项防止混淆</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-tags"><code>tags</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#array">array</a></td>
<td>Add any number of arbitrary tags to your event.<br/>This can help with processing later.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html#plugins-inputs-file-type"><code>type</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#string">string</a></td>
<td>类型，例如收集 &#x2F;var&#x2F;log&#x2F;syslog 日志，type 可以设置为 “system”；收集网站日志，type 可以设置为 “web”。 <br/>此项用的较多，一般会根据判断 type 值来进行输出或过滤</td>
</tr>
</tbody></table>
<p>所有输出插件都支持以下配置选项：</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-xmpp.html#plugins-outputs-xmpp-codec"><code>codec</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#codec">codec</a></td>
<td>用于输出数据的编解码器。输出编解码器是一种方便的方法，可以在数据离开输出之前对数据进行编码，而不需要在 Logstash 管道中使用单独的过滤器</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-xmpp.html#plugins-outputs-xmpp-enable_metric"><code>enable_metric</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#boolean">boolean</a></td>
<td>Disable or enable metric logging for this specific plugin instance. By default we record all the metrics we can, but you can disable metrics collection for a specific plugin.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-xmpp.html#plugins-outputs-xmpp-id"><code>id</code></a></td>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.11/configuration-file-structure.html#string"> string</a></td>
<td>唯一的 ID，如果没有指定，logstash 会自动生成一个，尤其是多个相同类型的插件时，强烈建议配置此项，例如有多个 file 输出，应当配置此项防止混淆</td>
</tr>
</tbody></table>
<p>可以看到 input 和 output 插件都支持 codec 配置项，input 的 codec 根据被采集的日志文件确定，如果日志是 json 格式，则 input 插件的 codec 应当设置为 json；而 output 的 codec 根据数据库确定，如果是 elasticsearch，codec 保持默认的 rubydebug 即可，如果是 kafka，codec 应该设置为 json</p>
<h3 id="input-插件"><a href="#input-插件" class="headerlink" title="input 插件"></a>input 插件</h3><h4 id="stdin"><a href="#stdin" class="headerlink" title="stdin"></a>stdin</h4><p>标准输入</p>
<h4 id="file"><a href="#file" class="headerlink" title="file"></a>file</h4><p>日志输出到文件</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td>日志路径</td>
<td>必需</td>
</tr>
<tr>
<td><code>start_position</code></td>
<td>从文件的开头或者结尾开始采集数据</td>
<td><code>[&quot;beginning&quot;, &quot;end&quot;]</code></td>
</tr>
<tr>
<td><code>stat_interval</code></td>
<td>日志收集的时间间隔</td>
<td>每个 input 文件都生成一个 .sincedb_xxxxx 文件，这个文件中记录了上次收集日志位置，下次从记录的位置继续收集</td>
</tr>
</tbody></table>
<h4 id="tcp"><a href="#tcp" class="headerlink" title="tcp"></a>tcp</h4><table>
<thead>
<tr>
<th>Setting</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>host</code></td>
<td>当 mode 是<code>server</code>，<code>host</code>是监听的地址；<br>当 mode 是<code>client</code>，<code>host</code>是要连接的地址</td>
<td>默认<code>0.0.0.0</code></td>
</tr>
<tr>
<td><code>mode</code></td>
<td><code>server</code>：监听客户端连接；<br><code>client</code>：连接到服务器；</td>
<td>[“server”, “client”]</td>
</tr>
<tr>
<td><code>port</code></td>
<td>监听的端口或要连接的端口</td>
<td>必需</td>
</tr>
</tbody></table>
<h4 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h4><table>
<thead>
<tr>
<th>Setting</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>bootstrap_servers</code></td>
<td></td>
<td>host1:port1,host2:port2</td>
</tr>
<tr>
<td><code>topics</code></td>
<td>要订阅的 topic 列表，默认为[“logstash”]</td>
<td></td>
</tr>
<tr>
<td><code>decorate_events</code></td>
<td>是否添加一个 kafka 元数据，包含以下信息：<br>topic、consumer_group、partition、offset、key</td>
<td>布尔值</td>
</tr>
<tr>
<td><code>codec</code></td>
<td>设置为 <code>json</code></td>
<td></td>
</tr>
</tbody></table>
<h3 id="output-插件"><a href="#output-插件" class="headerlink" title="output 插件"></a>output 插件</h3><h4 id="output"><a href="#output" class="headerlink" title="output"></a>output</h4><p>标准输出</p>
<h4 id="elasticsearch-1"><a href="#elasticsearch-1" class="headerlink" title="elasticsearch"></a>elasticsearch</h4><h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><table>
<thead>
<tr>
<th>Setting</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html#plugins-outputs-redis-key"><code>key</code></a></td>
<td>list（列表）名，或者 channel（频道）名，<br>至于是哪个取决于<code>data_type</code></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html#plugins-outputs-redis-data_type"><code>data_type</code></a></td>
<td>如果<code>data_type</code>为<code>list</code>，将数据 push 到 list；<br>如果<code>data_type</code>为 channel，将数据发布到 channel；</td>
<td>[“list”, “channel”]</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html#plugins-outputs-redis-host"><code>host</code></a></td>
<td>redis 主机列表，可以是 hostname 或者 ip 地址</td>
<td>数组</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html#plugins-outputs-redis-port"><code>port</code></a></td>
<td>redis 服务端口，默认 6379</td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html#plugins-outputs-redis-db"><code>db</code></a></td>
<td>数据库编号，默认 0</td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html#plugins-outputs-redis-password"><code>password</code></a></td>
<td>身份认证，默认不认证</td>
<td>不建议设置密码</td>
</tr>
</tbody></table>
<p>写个脚本统计 redis 的 key 数量，使用 zabbix-agent 定时执行脚本，一旦 key 超过某个数量，就增加 logstash 数量，从而加快从 redis 中取数据的速度</p>
<h4 id="kafka-1"><a href="#kafka-1" class="headerlink" title="kafka"></a>kafka</h4><table>
<thead>
<tr>
<th>Setting</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>bootstrap_servers</code></td>
<td></td>
<td>host1:port1,host2:port2</td>
</tr>
<tr>
<td><code>topic_id</code></td>
<td>主题</td>
<td></td>
</tr>
<tr>
<td><code>codec</code></td>
<td>设置为 <code>json</code></td>
<td></td>
</tr>
<tr>
<td><code>batch_size</code></td>
<td>The producer will attempt to batch records together into fewer requests whenever multiple records are being sent to the same partition. This helps performance on both the client and the server. This configuration controls the default batch size in bytes.</td>
<td>默认 16384</td>
</tr>
</tbody></table>
<h3 id="codec-插件"><a href="#codec-插件" class="headerlink" title="codec 插件"></a>codec 插件</h3><h4 id="multiline"><a href="#multiline" class="headerlink" title="multiline"></a>multiline</h4><p>合并多行，比如 java 的一个报错，日志中会记录多行，为了方便查看，应该将一个报错的多行日志合并成一行</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>pattern</td>
<td>正则匹配</td>
<td>必需</td>
</tr>
<tr>
<td>negate</td>
<td>匹配成功或失败，就开始多行合并</td>
<td>布尔值</td>
</tr>
<tr>
<td>what</td>
<td>如果模式匹配，向前多行合并，还是向后多行合并</td>
<td>必需，<code>[&quot;previous&quot;, &quot;next&quot;]</code></td>
</tr>
</tbody></table>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>配置：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/configuration.html">https://www.elastic.co/guide/en/logstash/current/configuration.html</a><br>配置文件结构：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html">https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html</a><br>配置文件语法：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/event-dependent-configuration.html">https://www.elastic.co/guide/en/logstash/current/event-dependent-configuration.html</a><br>使用环境变量：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/environment-variables.html">https://www.elastic.co/guide/en/logstash/current/environment-variables.html</a><br>配置文件示例：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/config-examples.html">https://www.elastic.co/guide/en/logstash/current/config-examples.html</a><br>数据发送到 es：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/connecting-to-cloud.html">https://www.elastic.co/guide/en/logstash/current/connecting-to-cloud.html</a></p>
<pre class="language-conf" data-language="conf"><code class="language-conf">input &#123;
  ...
&#125;

filter &#123;
  ...
&#125;

output &#123;
  ...
&#125;</code></pre>

<h4 id="多配置文件"><a href="#多配置文件" class="headerlink" title="多配置文件"></a>多配置文件</h4><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html">https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html</a><br><a target="_blank" rel="noopener" href="https://elasticstack.blog.csdn.net/article/details/100995868">https://elasticstack.blog.csdn.net/article/details/100995868</a></p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 定义了两个管道</span>
<span class="token punctuation">[</span>root@elk2-ljk logstash<span class="token punctuation">]</span><span class="token variable">$cat</span> pipelines.yml
- pipeline.id: syslog
  path.config: <span class="token string">"/etc/logstash/conf.d/syslog.conf"</span>
- pipeline.id: tomcat
  path.config: <span class="token string">"/etc/logstash/conf.d/tomcat.conf"</span>

<span class="token comment"># syslog.conf 和 tomcat.conf，没有使用条件判断语句做输出判断</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$cat</span> syslog.conf
input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"syslog"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/var/log/syslog"</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"end"</span>
        stat_interval <span class="token operator">=</span><span class="token operator">></span> <span class="token number">3</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"syslog"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.1.121:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"mytest-%&#123;type&#125;-%&#123;+xxxx.ww&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$cat</span> tomcat.conf
input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"tomcat-access-log"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/usr/local/tomcat/logs/tomcat_access_log.*.log"</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"end"</span>
        stat_interval <span class="token operator">=</span><span class="token operator">></span> <span class="token number">3</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.1.121:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"mytest-%&#123;type&#125;-%&#123;+xxxx.ww&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 启动，注意一定要以为root用户启动</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart logstash.service</code></pre>

<p>效果：<img data-src="//img.to2b.cn/blog/ljk/1615015973480.png"></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="标准输入输出"><a href="#标准输入输出" class="headerlink" title="标准输入输出"></a>标准输入输出</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/logstash/conf.d/test.conf
input <span class="token punctuation">&#123;</span>
  stdin <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
  stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span>$/usr/share/logstash/bin/logstash <span class="token parameter variable">-f</span> /etc/logstash/conf.d/test.conf
<span class="token punctuation">..</span>.		<span class="token comment"># 启动得等一会</span>
<span class="token punctuation">[</span>INFO <span class="token punctuation">]</span> <span class="token number">2021</span>-03-04 <span class="token number">18</span>:10:06.020 <span class="token punctuation">[</span>Api Webserver<span class="token punctuation">]</span> agent - Successfully started Logstash API endpoint <span class="token punctuation">&#123;</span>:port<span class="token operator">=</span><span class="token operator">></span><span class="token number">9600</span><span class="token punctuation">&#125;</span>
hello word	<span class="token comment"># 标准输入</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"@timestamp"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">2021</span>-03-04T10:10:15.528Z,	<span class="token comment"># 当前事件的发生时间</span>
          <span class="token string">"host"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"elk2-ljk.local"</span>,			<span class="token comment"># 标记事件发生的节点</span>
      <span class="token string">"@version"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"1"</span>,						<span class="token comment"># 事件版本号，一个事件就是一个 ruby 对象</span>
       <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"hello word"</span>				<span class="token comment"># 息的具体内容</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="输出到文件"><a href="#输出到文件" class="headerlink" title="输出到文件"></a>输出到文件</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 修改被采集日志文件权限，至少让logstash用户可以读</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$chmod</span> o+r /var/log/syslog
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$chmod</span> o+r /var/log/auth.log

<span class="token comment"># 2. 编写配置文件，采集多个日志文件，输出到不同的文件</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$vim</span> system-log.conf
input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"syslog"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/var/log/syslog"</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"end"</span>
        stat_interval <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
    	<span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"authlog"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/var/log/auth.log"</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"end"</span>
        stat_interval <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"syslog"</span> <span class="token punctuation">&#123;</span>
        <span class="token function">file</span> <span class="token punctuation">&#123;</span>
            path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/%&#123;type&#125;.%&#123;+yyyy.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"authlog"</span> <span class="token punctuation">&#123;</span>
        <span class="token function">file</span> <span class="token punctuation">&#123;</span>
            path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/%&#123;type&#125;.%&#123;+yyyy.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 3. 检查配置文件是否合法</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span>$/usr/share/logstash/bin/logstash <span class="token parameter variable">-f</span> ./system-log.conf <span class="token parameter variable">-t</span>

<span class="token comment"># 4. 重启logstash.service</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart logstash.service

<span class="token comment"># 5. 观察输出文件</span>
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$tail</span> <span class="token parameter variable">-f</span> /tmp/syslog.2021.03.05
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@elk2-ljk conf.d<span class="token punctuation">]</span><span class="token variable">$tail</span> <span class="token parameter variable">-f</span> /tmp/authlog.2021.03.05
<span class="token punctuation">..</span>.</code></pre>

<p>时间格式参考：<a target="_blank" rel="noopener" href="http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html">http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html</a></p>
<h4 id="输出到-elasticsearch"><a href="#输出到-elasticsearch" class="headerlink" title="输出到 elasticsearch"></a>输出到 elasticsearch</h4><p>elasticsearch 输出插件至少指定 <code>hosts</code> 和<code>index</code>，<code>hosts</code>可以指定 hosts 列表</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"syslog"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/var/log/syslog"</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"end"</span>
        stat_interval <span class="token operator">=</span><span class="token operator">></span> <span class="token number">3</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
  elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.1.121:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"mytest-%&#123;type&#125;-%&#123;+xxxx.ww&#125;"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h2><p>开源的数据分析和可视化平台，可以 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作，可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk1-ljk src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf kibana-7.11.1-linux-x86_64.tar.gz
<span class="token punctuation">[</span>root@elk1-ljk src<span class="token punctuation">]</span><span class="token variable">$mv</span> kibana-7.11.1-linux-x86_64 /usr/local/kibana
<span class="token punctuation">[</span>root@elk1-ljk src<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/kibana
<span class="token punctuation">[</span>root@elk1-ljk kibana<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token string">'^[a-Z]'</span> config/kibana.yml 	<span class="token comment"># 修改以下配置项</span>
server.port: <span class="token number">5601</span>
server.host: <span class="token string">"10.0.1.121"</span>
elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.1.121:9200"</span><span class="token punctuation">]</span>
i18n.locale: <span class="token string">"zh-CN"</span>

<span class="token punctuation">[</span>root@elk1-ljk kibana<span class="token punctuation">]</span>$./bin/kibana --allow-root	<span class="token comment"># 启动</span>
<span class="token comment"># nohup ./bin/kibana --allow-root >/dev/null 2>&amp;1 &amp;		# 后台启动</span></code></pre>

<p>因为笔记本的性能问题，将 elasticsearch 集群缩减为 elasticsearch 单节点，这导致 kibana 无法连接到 elasticsearch，启动失败。解决办法：将 elasticsearch 的数据目录清空，然后重启</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk1-ljk data<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop elasticsearch.service 	<span class="token comment"># 停止elasticsearch</span>
<span class="token punctuation">[</span>root@elk1-ljk data<span class="token punctuation">]</span><span class="token variable">$ls</span> /data/elasticsearch/
data  logs
<span class="token punctuation">[</span>root@elk1-ljk data<span class="token punctuation">]</span><span class="token variable">$rm</span> <span class="token parameter variable">-rf</span> /data/elasticsearch/*	<span class="token comment"># 清空数据目录</span>
<span class="token punctuation">[</span>root@elk1-ljk data<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start elasticsearch.service	<span class="token comment"># 重新启动elasticsearch</span>
<span class="token punctuation">[</span>root@elk1-ljk kibana<span class="token punctuation">]</span>$./bin/kibana --allow-root	<span class="token comment"># 再次启动kibana</span></code></pre>

<h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614862854522.png"></p>
<h3 id="kibana-画图功能详解"><a href="#kibana-画图功能详解" class="headerlink" title="kibana 画图功能详解"></a>kibana 画图功能详解</h3><h3 id="添加一个仪表盘"><a href="#添加一个仪表盘" class="headerlink" title="添加一个仪表盘"></a>添加一个仪表盘</h3><h2 id="Beats"><a href="#Beats" class="headerlink" title="Beats"></a>Beats</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/beats/">https://www.elastic.co/cn/beats/</a></p>
<p>logstash 基于 java，资源消耗很大，容器等场景，大多跑的都是轻量级的服务，没有必要安装 logstash，就可以用 beats 代替 logstash 做日志收集，beats 基于 go，性能更强，资源占用更低，但是功能也相对简单</p>
<p>beats 是一个系列，具体包含以下类型的采集器：</p>
<ul>
<li><strong>filebeat</strong>：轻量型日志采集器，最常用</li>
<li><strong>metricbeat</strong>：轻量型指标采集器，获取系统级的 CPU 使用率、内存、文件系统、磁盘 IO 和网络 IO 统计数据，还可针对系统上的每个进程获得与 top 命令类似的统计数据</li>
<li><strong>heartbeat</strong>：面向运行状态监测的轻量型采集器，通过 ICMP、TCP 和 HTTP 进行 ping 检测主机、网站可用性</li>
<li>packetbeat：轻量型网络数据采集器</li>
<li>winlogbeat：轻量型 Windows 事件日志采集器</li>
<li>auditbeat：轻量型审计日志采集器</li>
<li>functionbeat：面向云端数据的无服务器采集器</li>
</ul>
<p>除了 filebeat，其他的 beat 可以用 zabbix 替代</p>
<h3 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/index.html">https://www.elastic.co/guide/en/beats/filebeat/current/index.html</a></p>
<p>配置：只需要配置 input 和 output</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ============================== Filebeat inputs ==================</span>
filebeat.inputs:

- type: log							<span class="token comment"># 日志type</span>
  enabled: <span class="token boolean">false</span>					<span class="token comment"># 是否启动</span>
  paths:							<span class="token comment"># 被采集日志，可以写多个</span>
    - /var/log/*.log
  exclude_lines: <span class="token punctuation">[</span><span class="token string">'^DBG'</span><span class="token punctuation">]</span>			<span class="token comment"># 不采集日志中的哪些行</span>
  include_lines: <span class="token punctuation">[</span><span class="token string">'^ERR'</span>, <span class="token string">'^WARN'</span><span class="token punctuation">]</span>	<span class="token comment"># 只采集日志中的哪些行</span>
  exclude_files: <span class="token punctuation">[</span><span class="token string">'.gz$'</span><span class="token punctuation">]</span>			<span class="token comment"># 从paths的匹配中排除哪些文件</span>
  fields:							<span class="token comment"># 自定义字段，可以定义多个，后面用来做条件判断</span>
    level: debug
    review: <span class="token number">1</span>
  multiline.pattern: ^<span class="token punctuation">\</span><span class="token punctuation">[</span>			<span class="token comment"># 合并多行，匹配规则</span>
  multiline.negate: <span class="token boolean">false</span>			<span class="token comment"># 合并多行，配皮成功或失败执行合并</span>
  multiline.match: after			<span class="token comment"># 合并多行，向前合并还是向后合并</span>

<span class="token comment"># ============================== Filebeat modules ==============================</span>

filebeat.config.modules:
  path: <span class="token variable">$&#123;path.config&#125;</span>/modules.d/*.yml
  reload.enabled: <span class="token boolean">false</span>
  reload.period: 10s

<span class="token comment"># ======================= Elasticsearch template setting =======================</span>

setup.template.settings:
  index.number_of_shards: <span class="token number">1</span>
  index.codec: best_compression
  _source.enabled: <span class="token boolean">false</span>

<span class="token comment"># ================================== General ===================================</span>

<span class="token comment">#name:</span>
<span class="token comment">#tags: ["service-X", "web-tier"]</span>
<span class="token comment">#fields:</span>
<span class="token comment">#  env: staging</span>

<span class="token comment"># ================================= Dashboards =================================</span>

<span class="token comment">#setup.dashboards.enabled: false</span>
<span class="token comment">#setup.dashboards.url:</span>

<span class="token comment"># =================================== Kibana ===================================</span>

setup.kibana:
  <span class="token comment">#host: "localhost:5601"</span>
  <span class="token comment">#space.id:</span>

<span class="token comment"># =============================== Elastic Cloud ================================</span>

<span class="token comment">#cloud.id:</span>
<span class="token comment">#cloud.auth:</span>

<span class="token comment"># ================================== Outputs ===================================</span>
<span class="token comment"># 不同的output，有不同的配置，但是没有条件判断功能，无法根据不同的input使用不用的output</span>
<span class="token comment"># ---------------------------- Elasticsearch Output ----------------------------</span>
<span class="token comment">#output.elasticsearch:</span>
  <span class="token comment">#hosts: ["localhost:9200"]</span>
  <span class="token comment">#protocol: "https"</span>
  <span class="token comment">#api_key: "id:api_key"</span>
  <span class="token comment">#username: "elastic"</span>
  <span class="token comment">#password: "changeme"</span>

<span class="token comment"># ------------------------------ Logstash Output -------------------------------</span>
<span class="token comment">#output.logstash:</span>
  <span class="token comment">#hosts: ["localhost:5044"]</span>
  <span class="token comment">#ssl.certificate_authorities: ["/etc/pki/root/ca.pem"]</span>
  <span class="token comment">#ssl.certificate: "/etc/pki/client/cert.pem"</span>
  <span class="token comment">#ssl.key: "/etc/pki/client/cert.key"</span>

<span class="token comment"># ================================= Processors =================================</span>
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~

<span class="token comment"># ================================== Logging ===================================</span>

<span class="token comment">#logging.level: debug</span>
<span class="token comment">#logging.selectors: ["*"]</span>

<span class="token comment"># ============================= X-Pack Monitoring ==============================</span>

<span class="token comment">#monitoring.enabled: false</span>
<span class="token comment">#monitoring.cluster_uuid:</span>
<span class="token comment">#monitoring.elasticsearch:</span>

<span class="token comment"># ============================== Instrumentation ===============================</span>

<span class="token comment">#instrumentation:</span>
    <span class="token comment">#enabled: false</span>
    <span class="token comment">#environment: ""</span>
    <span class="token comment">#hosts:</span>
    <span class="token comment">#  - http://localhost:8200</span>
    <span class="token comment">#api_key:</span>
    <span class="token comment">#secret_token:</span>

<span class="token comment"># ================================= Migration ==================================</span>

<span class="token comment">#migration.6_to_7.enabled: true</span>
</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

<h3 id="metricbeat"><a href="#metricbeat" class="headerlink" title="metricbeat"></a>metricbeat</h3><h3 id="heartbeat"><a href="#heartbeat" class="headerlink" title="heartbeat"></a>heartbeat</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/ELK/Elastic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/ELK/Elastic/" class="post-title-link" itemprop="url">ELK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-03 08:30:51" itemprop="dateCreated datePublished" datetime="2021-03-03T08:30:51+08:00">2021-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>配套 B 站教程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Be4y167n9">https://www.bilibili.com/video/BV1Be4y167n9</a></p>
<h2 id="Elastic-Stack-在企业的常见架构"><a href="#Elastic-Stack-在企业的常见架构" class="headerlink" title="Elastic Stack 在企业的常见架构"></a>Elastic Stack 在企业的常见架构</h2><p><img data-src="//img.to2b.cn/blog/lujinkai/1667283447322.png"></p>
<h3 id="Elastic-Stack-分布式⽇志系统概述"><a href="#Elastic-Stack-分布式⽇志系统概述" class="headerlink" title="Elastic Stack 分布式⽇志系统概述"></a>Elastic Stack 分布式⽇志系统概述</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667283566667.png"></p>
<h2 id="集群基础环境初始化"><a href="#集群基础环境初始化" class="headerlink" title="集群基础环境初始化"></a>集群基础环境初始化</h2><h3 id="1-准备虚拟机"><a href="#1-准备虚拟机" class="headerlink" title="1.准备虚拟机"></a>1.准备虚拟机</h3><table>
<thead>
<tr>
<th>IP 地址</th>
<th>主机名</th>
<th>CPU 配置</th>
<th>内存配置</th>
<th>磁盘配置</th>
<th>角色说明</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>elk101.oldboyedu.com</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>elk102.oldboyedu.com</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>elk103.oldboyedu.com</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
</tbody></table>
<h3 id="2-修改软件源"><a href="#2-修改软件源" class="headerlink" title="2.修改软件源"></a>2.修改软件源</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/centos/">https://mirrors.tuna.tsinghua.edu.cn/help/centos/</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 对于 CentOS 7</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org|baseurl=https://mirrors.tuna.tsinghua.edu.cn|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo

<span class="token comment"># 对于 CentOS 8</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo</code></pre>

<h3 id="3-修改终端颜色"><a href="#3-修改终端颜色" class="headerlink" title="3.修改终端颜色"></a>3.修改终端颜色</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">>></span> ~/.bashrc</span>
PS1='[\[<span class="token entity" title="\e">\e</span>[34;1m\]\u@\[<span class="token entity" title="\e">\e</span>[0m\]\[<span class="token entity" title="\e">\e</span>[32;1m\]\H\[<span class="token entity" title="\e">\e</span>[0m\]\[<span class="token entity" title="\e">\e</span>[31;1m\] \W\[<span class="token entity" title="\e">\e</span>[0m\]]# '
EOF</span>
<span class="token builtin class-name">source</span> ~/.bashrc</code></pre>

<h3 id="4-修改-sshd-服务优化"><a href="#4-修改-sshd-服务优化" class="headerlink" title="4.修改 sshd 服务优化"></a>4.修改 sshd 服务优化</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s@^#UseDNS yes@UseDNS no@g'</span> /etc/ssh/sshd_config
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s#^GSSAPIAuthentication yes#GSSAPIAuthentication no#g'</span> /etc/ssh/sshd_config
<span class="token function">grep</span> ^UseDNS /etc/ssh/sshd_config
<span class="token function">grep</span> ^GSSAPIAuthentication /etc/ssh/sshd_config</code></pre>

<h3 id="5-关闭防⽕墙"><a href="#5-关闭防⽕墙" class="headerlink" title="5.关闭防⽕墙"></a>5.关闭防⽕墙</h3><pre class="language-bash" data-language="bash"><code class="language-bash">systemctl disable <span class="token parameter variable">--now</span> firewalld <span class="token operator">&amp;&amp;</span> systemctl is-enabled firewalld
systemctl status firewalld</code></pre>

<h3 id="6-禁⽤-selinux"><a href="#6-禁⽤-selinux" class="headerlink" title="6.禁⽤ selinux"></a>6.禁⽤ selinux</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s#(SELINUX=)enforcing#\1disabled#'</span> /etc/selinux/config
<span class="token function">grep</span> ^SELINUX<span class="token operator">=</span> /etc/selinux/config
setenforce <span class="token number">0</span>
getenforce</code></pre>

<h3 id="7-配置集群免密登录及同步脚本"><a href="#7-配置集群免密登录及同步脚本" class="headerlink" title="7.配置集群免密登录及同步脚本"></a>7.配置集群免密登录及同步脚本</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.修改主机列表</span>
<span class="token function">cat</span> <span class="token operator">>></span>/etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
10.0.0.101 elk101.oldboyedu.com
10.0.0.102 elk102.oldboyedu.com
10.0.0.103 elk103.oldboyedu.com
EOF</span>
<span class="token comment"># 2.elk101节点上⽣成密钥对</span>
ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-P</span> <span class="token string">''</span> <span class="token parameter variable">-f</span> ~/.ssh/id_rsa <span class="token parameter variable">-q</span>
<span class="token comment"># 3.elk101配置所有集群节点的免密登录</span>
<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>host_id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span> host_id <span class="token operator">&lt;=</span> <span class="token number">103</span><span class="token punctuation">;</span> host_id<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  ssh-copy-id
  elk<span class="token variable">$&#123;host_id&#125;</span>.oldboyedu.com
<span class="token keyword">done</span>
<span class="token comment"># 4.链接测试</span>
<span class="token function">ssh</span> <span class="token string">'elk101.oldboyedu.com'</span>
<span class="token function">ssh</span> <span class="token string">'elk102.oldboyedu.com'</span>
<span class="token function">ssh</span> <span class="token string">'elk103.oldboyedu.com'</span>
<span class="token comment"># 5.所有节点安装rsync数据同步⼯具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">rsync</span>
<span class="token comment"># 6.编写同步脚本</span>
<span class="token function">vim</span> /usr/local/sbin/data_rsync.sh
<span class="token comment"># 将下⾯的内容拷⻉到该⽂件即可</span>
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># Auther: Jason Yin</span>
<span class="token keyword">if</span>
  <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> /path/to/file(绝对路径)"</span>
  <span class="token builtin class-name">exit</span>
<span class="token keyword">fi</span>
<span class="token comment"># 判断⽂件是否存在</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-e</span> <span class="token variable">$1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"[ <span class="token variable">$1</span> ] dir or file not find!"</span>
  <span class="token builtin class-name">exit</span>
<span class="token keyword">fi</span>
<span class="token comment"># 获取⽗路径</span>
<span class="token assign-left variable">fullpath</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> $1<span class="token variable">)</span></span>
<span class="token comment"># 获取⼦路径</span>
<span class="token assign-left variable">basename</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $1<span class="token variable">)</span></span>
<span class="token comment"># 进⼊到⽗路径</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$fullpath</span>
<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>host_id <span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span> host_id <span class="token operator">&lt;=</span> <span class="token number">103</span><span class="token punctuation">;</span> host_id<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token comment"># 使得终端输出变为绿⾊</span>
  tput setaf <span class="token number">2</span>
  <span class="token builtin class-name">echo</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> rsyncing elk<span class="token variable">$&#123;host_id&#125;</span>.oldboyedu.com: <span class="token variable">$basename</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
  <span class="token comment"># 使得终端恢复原来的颜⾊</span>
  tput setaf <span class="token number">7</span>
  <span class="token comment"># 将数据同步到其他两个节点</span>
  <span class="token function">rsync</span> <span class="token parameter variable">-az</span> <span class="token variable">$basename</span>
  <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>@elk<span class="token variable">$&#123;host_id&#125;</span>.oldboyedu.com:<span class="token variable">$fullpath</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"命令执⾏成功!"</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>


<span class="token comment"># 7.给脚本授权</span>
<span class="token function">chmod</span> +x /usr/local/sbin/data_rsync.sh</code></pre>

<h3 id="8-集群时间同步"><a href="#8-集群时间同步" class="headerlink" title="8.集群时间同步"></a>8.集群时间同步</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.安装常⽤的Linux⼯具，您可以⾃定义哈。</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">vim</span> net-tools
<span class="token comment"># 2.安装chrony服务</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ntpdate chrony
<span class="token comment"># 3.修改chrony服务配置⽂件</span>
<span class="token function">vim</span> /etc/chrony.conf
<span class="token comment">#...</span>
<span class="token comment"># 注释官⽅的时间服务器，换成国内的时间服务器即可</span>
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst
server ntp2.aliyun.com iburst
server ntp3.aliyun.com iburst
server ntp4.aliyun.com iburst
server ntp5.aliyun.com iburst
<span class="token comment">#...</span>
<span class="token comment"># 4.配置chronyd的开机⾃启动</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> chronyd
systemctl restart chronyd
<span class="token comment"># 5.查看服务</span>
systemctl status chronyd</code></pre>

<h2 id="Elasticsearch-单点部署"><a href="#Elasticsearch-单点部署" class="headerlink" title="Elasticsearch 单点部署"></a>Elasticsearch 单点部署</h2><h3 id="1-下载"><a href="#1-下载" class="headerlink" title="1.下载"></a>1.下载</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<h3 id="2-单点部署-elasticsearch"><a href="#2-单点部署-elasticsearch" class="headerlink" title="2.单点部署 elasticsearch"></a>2.单点部署 elasticsearch</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.安装服务</span>
$ yum <span class="token parameter variable">-y</span> localinstal elasticsearch-7.17.3-x86_64.rpm
<span class="token comment"># 2.修改配置⽂件</span>
$ <span class="token function">egrep</span> <span class="token parameter variable">-v</span> <span class="token string">"^#|^$"</span> /etc/elasticsearch/elasticsearch.yml
cluster.name: oldboyedu-elk
node.name: oldboyedu-elk103
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: <span class="token number">10.0</span>.0.103
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>

<span class="token comment"># 相关参数说明:</span>
<span class="token comment"># cluster.name: 集群名称，若不指定，则默认是"elasticsearch",⽇志⽂件的前缀也是集群名称。</span>
<span class="token comment"># node.name: 指定节点的名称，可以⾃定义，推荐使⽤当前的主机名，要求集群唯⼀。</span>
<span class="token comment"># path.data: 数据路径。</span>
<span class="token comment"># path.logs: ⽇志路径</span>
<span class="token comment"># network.host: ES服务监听的IP地址</span>
<span class="token comment"># discovery.seed_hosts: 服务发现的主机列表，对于单点部署⽽⾔，主机列表和"network.host"字段配置相同即可。</span>

<span class="token comment"># 3.启动服务</span>
$ systemctl start elasticsearch.service</code></pre>

<h2 id="Elasticsearch-分布式集群部署"><a href="#Elasticsearch-分布式集群部署" class="headerlink" title="Elasticsearch 分布式集群部署"></a>Elasticsearch 分布式集群部署</h2><h3 id="1-elk101-修改配置文件"><a href="#1-elk101-修改配置文件" class="headerlink" title="1.elk101 修改配置文件"></a>1.elk101 修改配置文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">egrep</span> <span class="token parameter variable">-v</span> <span class="token string">"^$|^#"</span> /etc/elasticsearch/elasticsearch.yml
<span class="token punctuation">..</span>.
cluster.name: oldboyedu-elk
node.name: elk101
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: <span class="token number">0.0</span>.0.0
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"elk101"</span>,<span class="token string">"elk102"</span>,<span class="token string">"elk103"</span><span class="token punctuation">]</span>
cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"elk101"</span>,<span class="token string">"elk102"</span>,<span class="token string">"elk103"</span><span class="token punctuation">]</span>


<span class="token comment"># 温馨提示:</span>
<span class="token comment"># "node.name"各个节点配置要区分清楚，建议写对应的主机名称。</span></code></pre>

<h3 id="2-同步配置⽂件到集群的其他节点"><a href="#2-同步配置⽂件到集群的其他节点" class="headerlink" title="2.同步配置⽂件到集群的其他节点"></a>2.同步配置⽂件到集群的其他节点</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.elk101同步配置⽂件到集群的其他节点</span>
data_rsync.sh /etc/elasticsearch/elasticsearch.yml

<span class="token comment"># 2.elk102节点配置</span>
<span class="token function">vim</span> /etc/elasticsearch/elasticsearch.yml
<span class="token punctuation">..</span>.
node.name: elk102

<span class="token comment"># 3.elk103节点配置</span>
<span class="token function">vim</span> /etc/elasticsearch/elasticsearch.yml
<span class="token punctuation">..</span>.
node.name: elk103</code></pre>

<h3 id="3-所有节点删除之前的临时数据"><a href="#3-所有节点删除之前的临时数据" class="headerlink" title="3.所有节点删除之前的临时数据"></a>3.所有节点删除之前的临时数据</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">pkill</span> <span class="token function">java</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/<span class="token punctuation">&#123;</span>lib,log<span class="token punctuation">&#125;</span>/elasticsearch/* /tmp/*
ll /var/<span class="token punctuation">&#123;</span>lib,log<span class="token punctuation">&#125;</span>/elasticsearch/ /tmp/</code></pre>

<h3 id="4-所有节点启动服务"><a href="#4-所有节点启动服务" class="headerlink" title="4.所有节点启动服务"></a>4.所有节点启动服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.所有节点启动服务</span>
systemctl start elasticsearch

<span class="token comment"># 2.启动过程中建议查看⽇志</span>
<span class="token function">tail</span> <span class="token parameter variable">-100f</span> /var/log/elasticsearch/oldboyedu-elk.log</code></pre>

<h3 id="5-验证集群是否正常"><a href="#5-验证集群是否正常" class="headerlink" title="5.验证集群是否正常"></a>5.验证集群是否正常</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> elk103:9200/_cat/nodes?v</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667284700478.png"></p>
<h2 id="部署-kibana-服务"><a href="#部署-kibana-服务" class="headerlink" title="部署 kibana 服务"></a>部署 kibana 服务</h2><h3 id="1-本地安装-kibana"><a href="#1-本地安装-kibana" class="headerlink" title="1.本地安装 kibana"></a>1.本地安装 kibana</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> localinstall kibana-7.17.3-x86_64.rpm</code></pre>

<h3 id="2-修改-kibana-的配置⽂件"><a href="#2-修改-kibana-的配置⽂件" class="headerlink" title="2.修改 kibana 的配置⽂件"></a>2.修改 kibana 的配置⽂件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/kibana/kibana.yml
<span class="token punctuation">..</span>.
server.host: <span class="token string">"10.0.0.101"</span>
server.name: <span class="token string">"oldboyedu-kibana-server"</span>
elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
i18n.locale: <span class="token string">"zh-CN"</span></code></pre>

<h3 id="3-启动-kibana-服务"><a href="#3-启动-kibana-服务" class="headerlink" title="3.启动 kibana 服务"></a>3.启动 kibana 服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash">systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kibana
systemctl status kibana</code></pre>

<h3 id="4-访问-kibana-的-webUI"><a href="#4-访问-kibana-的-webUI" class="headerlink" title="4.访问 kibana 的 webUI"></a>4.访问 kibana 的 webUI</h3><p>略。。。</p>
<h2 id="filebeat-部署及基础使用"><a href="#filebeat-部署及基础使用" class="headerlink" title="filebeat 部署及基础使用"></a>filebeat 部署及基础使用</h2><pre class="language-bash" data-language="bash"><code class="language-bash">$ ./filebeat <span class="token parameter variable">--help</span>
Usage:
  filebeat <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
  filebeat <span class="token punctuation">[</span>command<span class="token punctuation">]</span>

Available Commands:
  <span class="token builtin class-name">export</span>      Export current config or index template
  generate    Generate Filebeat modules, filesets and fields.yml
  <span class="token builtin class-name">help</span>        Help about any <span class="token builtin class-name">command</span>
  keystore    Manage secrets keystore
  modules     Manage configured modules
  run         Run filebeat
  setup       Setup index template, dashboards and ML <span class="token function">jobs</span>
  <span class="token builtin class-name">test</span>        Test config
  version     Show current version info

Flags:
  -E, <span class="token parameter variable">--E</span> <span class="token assign-left variable">setting</span><span class="token operator">=</span>value              Configuration overwrite
  -M, <span class="token parameter variable">--M</span> <span class="token assign-left variable">setting</span><span class="token operator">=</span>value              Module configuration overwrite
  -N, <span class="token parameter variable">--N</span>                            Disable actual publishing <span class="token keyword">for</span> testing
  -c, <span class="token parameter variable">--c</span> string                     Configuration file, relative to path.config <span class="token punctuation">(</span>default <span class="token string">"filebeat.yml"</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--cpuprofile</span> string            Write cpu profile to <span class="token function">file</span>
  -d, <span class="token parameter variable">--d</span> string                     Enable certain debug selectors
  -e, <span class="token parameter variable">--e</span>                            Log to stderr and disable syslog/file output
      <span class="token parameter variable">--environment</span> environmentVar   <span class="token builtin class-name">set</span> environment being ran <span class="token keyword">in</span> <span class="token punctuation">(</span>default default<span class="token punctuation">)</span>
  -h, <span class="token parameter variable">--help</span>                         <span class="token builtin class-name">help</span> <span class="token keyword">for</span> filebeat
      <span class="token parameter variable">--httpprof</span> string              Start pprof http server
      <span class="token parameter variable">--memprofile</span> string            Write memory profile to this <span class="token function">file</span>
      <span class="token parameter variable">--modules</span> string               List of enabled modules <span class="token punctuation">(</span>comma separated<span class="token punctuation">)</span>
      <span class="token parameter variable">--once</span>                         Run filebeat only once <span class="token keyword">until</span> all harvesters reach EOF
      <span class="token parameter variable">--path.config</span> string           Configuration path
      <span class="token parameter variable">--path.data</span> string             Data path
      <span class="token parameter variable">--path.home</span> string             Home path
      <span class="token parameter variable">--path.logs</span> string             Logs path
      <span class="token parameter variable">--plugin</span> pluginList            Load additional plugins
      <span class="token parameter variable">--strict.perms</span>                 Strict permission checking on config files <span class="token punctuation">(</span>default <span class="token boolean">true</span><span class="token punctuation">)</span>
  -v, <span class="token parameter variable">--v</span>                            Log at INFO level

Use <span class="token string">"filebeat [command] --help"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a command.</code></pre>

<h3 id="1-部署-filebeat-环境"><a href="#1-部署-filebeat-环境" class="headerlink" title="1.部署 filebeat 环境"></a>1.部署 filebeat 环境</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> localinstall filebeat-7.17.3-x86_64.rpm

<span class="token comment"># 温馨提示: elk102节点操作</span></code></pre>

<h3 id="2-简单测试"><a href="#2-简单测试" class="headerlink" title="2.简单测试"></a>2.简单测试</h3><h4 id="2-1-编写配置文件"><a href="#2-1-编写配置文件" class="headerlink" title="2.1 编写配置文件"></a>2.1 编写配置文件</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /etc/filebeat/config
<span class="token function">cat</span> <span class="token operator">></span> /etc/filebeat/config/01-stdin-to-console.yml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
filebeat.inputs:         # 指定输⼊的类型
 - type: stdin           # 指定输⼊的类型为"stdin",表示标准输⼊
output.console:          # 指定输出的类型
 pretty: true            # 打印漂亮的格式
EOF</span></code></pre>

<h4 id="2-2-运行-filebeat-实例"><a href="#2-2-运行-filebeat-实例" class="headerlink" title="2.2 运行 filebeat 实例"></a>2.2 运行 filebeat 实例</h4><pre class="language-bash" data-language="bash"><code class="language-bash">$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> /etc/filebeat/config/01-stdin-to-console.yml
<span class="token punctuation">..</span>.</code></pre>

<h4 id="2-3-测试"><a href="#2-3-测试" class="headerlink" title="2.3 测试"></a>2.3 测试</h4><pre class="language-bash" data-language="bash"><code class="language-bash"> <span class="token punctuation">..</span>.
hello word
<span class="token punctuation">&#123;</span>
  <span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-11-04T05:47:24.880Z"</span>,
  <span class="token string">"@metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"beat"</span><span class="token builtin class-name">:</span> <span class="token string">"filebeat"</span>,
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.4.3"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"ecs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.0.0"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"host"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"lujinkai-pc"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"log"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"file"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string">"path"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"offset"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"hello word"</span>,
  <span class="token string">"input"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"stdin"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"agent"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"filebeat"</span>,
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.4.3"</span>,
    <span class="token string">"ephemeral_id"</span><span class="token builtin class-name">:</span> <span class="token string">"8a43c946-9a6d-43dc-8a79-4fe673f7882d"</span>,
    <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"af9266b6-6d99-48d2-abc2-acea45ef1c61"</span>,
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"lujinkai-pc"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">..</span>.</code></pre>

<h3 id="3-input-的-log-类型"><a href="#3-input-的-log-类型" class="headerlink" title="3.input 的 log 类型"></a>3.input 的 log 类型</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /tmp/test.log
<span class="token key atrule">output.console</span><span class="token punctuation">:</span>
  <span class="token key atrule">pretty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>

<h3 id="4-input-的通配符案例"><a href="#4-input-的通配符案例" class="headerlink" title="4.input 的通配符案例"></a>4.input 的通配符案例</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /tmp/test.log
      <span class="token punctuation">-</span> /tmp/<span class="token important">*.txt</span>
<span class="token key atrule">output.console</span><span class="token punctuation">:</span>
  <span class="token key atrule">pretty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>

<h3 id="5-input-的通用字段案例"><a href="#5-input-的通用字段案例" class="headerlink" title="5.input 的通用字段案例"></a>5.input 的通用字段案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    <span class="token comment"># 是否启动当前的输⼊类型，默认值为true</span>
    enabled: <span class="token boolean">true</span>
    <span class="token comment"># 指定数据路径</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    <span class="token comment"># 给当前的输⼊类型搭上标签</span>
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    <span class="token comment"># ⾃定义字段</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    <span class="token comment"># 将⾃定义字段的key-value放到顶级字段.</span>
    <span class="token comment"># 默认值为false，会将数据放在⼀个叫"fields"字段的下⾯.</span>
    fields_under_root: <span class="token boolean">true</span>

output.console:
  pretty: <span class="token boolean">true</span></code></pre>

<h3 id="6-日志过滤案例"><a href="#6-日志过滤案例" class="headerlink" title="6.日志过滤案例"></a>6.日志过滤案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*.log
    <span class="token comment"># 注意，⿊⽩名单均⽀持通配符,⽣产环节中不建议同时使⽤，</span>
    <span class="token comment"># 指定⽩名单，包含指定的内容才会采集，且区分⼤⼩写!</span>
    include_lines: <span class="token punctuation">[</span><span class="token string">"^ERR"</span>, <span class="token string">"^WARN"</span>, <span class="token string">"oldboyedu"</span><span class="token punctuation">]</span>
    <span class="token comment"># 指定⿊名单，排除指定的内容</span>
    exclude_lines: <span class="token punctuation">[</span><span class="token string">"^DBG"</span>, <span class="token string">"linux"</span>, <span class="token string">"oldboyedu"</span><span class="token punctuation">]</span>

output.console:
  pretty: <span class="token boolean">true</span></code></pre>

<h3 id="7-将数据写入-es-案例"><a href="#7-将数据写入-es-案例" class="headerlink" title="7.将数据写入 es 案例"></a>7.将数据写入 es 案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span></code></pre>

<h3 id="8-自定义-es-索引名称"><a href="#8-自定义-es-索引名称" class="headerlink" title="8.自定义 es 索引名称"></a>8.自定义 es 索引名称</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span>					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span>		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span>	<span class="token comment"># 设置索引模板的匹配模式</span></code></pre>

<h3 id="9-多个索引写入案例"><a href="#9-多个索引写入案例" class="headerlink" title="9.多个索引写入案例"></a>9.多个索引写入案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>
output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token comment"># index: "oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
  indices:
    - index: <span class="token string">"oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token comment"># 匹配指定字段包含的内容</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-linux80"</span>
    - index: <span class="token string">"oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-python"</span>

setup.ilm.enabled: <span class="token boolean">false</span>						<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span>			<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span>		<span class="token comment"># 设置索引模板的匹配模式</span></code></pre>

<h3 id="10-自定义分片和副本案例"><a href="#10-自定义分片和副本案例" class="headerlink" title="10.自定义分片和副本案例"></a>10.自定义分片和副本案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token comment"># index: "oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
  indices:
    - index: <span class="token string">"oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token comment"># 匹配指定字段包含的内容</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-linux80"</span>
    - index: <span class="token string">"oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-python"</span>


setup.ilm.enabled: <span class="token boolean">false</span>						<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span>			<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span>		<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">false</span>					<span class="token comment"># 覆盖已有的索引模板</span>
setup.template.settings:						<span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span>						<span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">2</span>						<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="11-filebeat-实现日志聚合到本地"><a href="#11-filebeat-实现日志聚合到本地" class="headerlink" title="11.filebeat 实现日志聚合到本地"></a>11.filebeat 实现日志聚合到本地</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>

output.file:
  path: <span class="token string">"/tmp/filebeat"</span>
  filename: oldboyedu-linux80
  rotate_every_kb: <span class="token number">102400</span> 		<span class="token comment"># 指定⽂件的滚动⼤⼩，默认值为20MB</span>
  number_of_files: <span class="token number">300</span> 			<span class="token comment"># 指定保存的⽂件个数，默认是7个，有效值为2-1024个</span>
  permissions: 0600 			<span class="token comment"># 指定⽂件的权限，默认权限是0600</span></code></pre>

<h3 id="12-filebeat-实现日志聚合到-ES-集群"><a href="#12-filebeat-实现日志聚合到-ES-集群" class="headerlink" title="12.filebeat 实现日志聚合到 ES 集群"></a>12.filebeat 实现日志聚合到 ES 集群</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667287595368.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>
    tags: <span class="token punctuation">[</span><span class="token string">"aaa"</span><span class="token punctuation">]</span>
  - type: tcp
    host: <span class="token string">"0.0.0.0:8000"</span>
    tags: <span class="token punctuation">[</span><span class="token string">"bbb"</span><span class="token punctuation">]</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  indices:
    - index: <span class="token string">"oldboyedu-linux80-elk-aaa-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"aaa"</span>
    - index: <span class="token string">"oldboyedu-linux80-elk-bbb-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"bbb"</span>

setup.ilm.enabled: <span class="token boolean">false</span>
setup.template.name: <span class="token string">"oldboyedu-linux80-elk"</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux80-elk*"</span>
setup.template.overwrite: <span class="token boolean">true</span>
setup.template.settings:
    index.number_of_shards: <span class="token number">3</span>
    index.number_of_replicas: <span class="token number">0</span></code></pre>

<h2 id="EFK-架构企业级实战案例"><a href="#EFK-架构企业级实战案例" class="headerlink" title="EFK 架构企业级实战案例"></a>EFK 架构企业级实战案例</h2><h3 id="1-部署-nginx-服务"><a href="#1-部署-nginx-服务" class="headerlink" title="1.部署 nginx 服务"></a>1.部署 nginx 服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.配置nginx的软件源</span>
<span class="token function">cat</span> <span class="token operator">></span>/etc/yum.repos.d/nginx.repo <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/centos/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
EOF</span>
<span class="token comment"># 2.安装nginx服务</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nginx
<span class="token comment"># 3.启动nginx服务</span>
systemctl start nginx</code></pre>

<h3 id="2-基于-log-类型收集-nginx-原生日志"><a href="#2-基于-log-类型收集-nginx-原生日志" class="headerlink" title="2.基于 log 类型收集 nginx 原生日志"></a>2.基于 log 类型收集 nginx 原生日志</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /var/log/nginx/access.log*
    tags: <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-nginx-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span> 					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> 		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> 	<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span> 				<span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: 					<span class="token comment"># 配置索引模板</span>
  index.number_of_shards: <span class="token number">3</span> 					<span class="token comment"># 设置分⽚数量</span>
  index.number_of_replicas: <span class="token number">0</span> 					<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="3-基于-log-类型收集-nginx-的-json-日志"><a href="#3-基于-log-类型收集-nginx-的-json-日志" class="headerlink" title="3.基于 log 类型收集 nginx 的 json 日志"></a>3.基于 log 类型收集 nginx 的 json 日志</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 修改nginx的源⽇志格式</span>
<span class="token function">vim</span> /etc/nginx/nginx.conf
<span class="token punctuation">..</span>.
log_format oldboyedu_nginx_json <span class="token string">'&#123;"@timestamp":"$time_iso8601",'</span>
<span class="token string">'"host":"$server_addr",'</span>
<span class="token string">'"clientip":"$remote_addr",'</span>
<span class="token string">'"SendBytes":$body_bytes_sent,'</span>
<span class="token string">'"responsetime":$request_time,'</span>
<span class="token string">'"upstreamtime":"$upstream_response_time",'</span>
<span class="token string">'"upstreamhost":"$upstream_addr",'</span>
<span class="token string">'"http_host":"$host",'</span>
<span class="token string">'"uri":"$uri",'</span>
<span class="token string">'"domain":"$host",'</span>
<span class="token string">'"xff":"$http_x_forwarded_for",'</span>
<span class="token string">'"referer":"$http_referer",'</span>
<span class="token string">'"tcp_xff":"$proxy_protocol_addr",'</span>
<span class="token string">'"http_user_agent":"$http_user_agent",'</span>
<span class="token string">'"status":"$status"&#125;'</span><span class="token punctuation">;</span>

access_log /var/log/nginx/access.log oldboyedu_nginx_json<span class="token punctuation">;</span>
<span class="token comment"># 2.检查nginx的配置⽂件语法并重启nginx服务</span>
nginx <span class="token parameter variable">-t</span>
systemctl restart nginx
<span class="token comment"># 3.定义配置⽂件</span>
filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /var/log/nginx/access.log*
    tags: <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    json.keys_under_root: <span class="token boolean">true</span>      <span class="token comment"># 以JSON格式解析message字段的内容</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span> 					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> 		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> 	<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span> 				<span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: 					<span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span> 					<span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">0</span> 				<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="4-基于-modules-采集-nginx-日志文件"><a href="#4-基于-modules-采集-nginx-日志文件" class="headerlink" title="4.基于 modules 采集 nginx 日志文件"></a>4.基于 modules 采集 nginx 日志文件</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667288224966.png"></p>
<h4 id="模块的基本使用"><a href="#模块的基本使用" class="headerlink" title="模块的基本使用"></a>模块的基本使用</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看模块</span>
$ filebeat modules list
<span class="token comment"># 启动模块</span>
$ filebeat modules <span class="token builtin class-name">enable</span> nginx tomcat
<span class="token comment"># 禁⽤模块</span>
$ filebeat modules disable nginx tomcat</code></pre>

<h4 id="filebeat-配置⽂件（需要启⽤-nginx-模块）"><a href="#filebeat-配置⽂件（需要启⽤-nginx-模块）" class="headerlink" title="filebeat 配置⽂件（需要启⽤ nginx 模块）"></a>filebeat 配置⽂件（需要启⽤ nginx 模块）</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.config.modules</span><span class="token punctuation">:</span>
  <span class="token comment"># 指定模块的配置⽂件路径，如果是yum⽅式安装，在7.17.3版本中不能使⽤如下的默认值。</span>
  <span class="token comment">#  path: $&#123;path.config&#125;/modules.d/*.yml</span>
  <span class="token comment"># 经过实际测试，推荐⼤家使⽤如下的配置,此处写绝对路径即可!⽽对于⼆进制部署⽆需做此操作.</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/filebeat/modules.d/<span class="token important">*.yml</span>
  <span class="token comment"># 开启热加载功能</span>
  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span></code></pre>

<p><code>/etc/filebeat/modules.d/nginx.yml</code> ⽂件内容：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">module</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">access</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">var.paths</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/var/log/nginx/access.log*"</span><span class="token punctuation">]</span>
  <span class="token key atrule">error</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">var.paths</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/var/log/nginx/error.log"</span><span class="token punctuation">]</span>
  <span class="token key atrule">ingress_controller</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>

<h3 id="5-基于-modules-采集-tomcat-日志文件"><a href="#5-基于-modules-采集-tomcat-日志文件" class="headerlink" title="5.基于 modules 采集 tomcat 日志文件"></a>5.基于 modules 采集 tomcat 日志文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.部署tomcat服务</span>
<span class="token comment"># 1.1.解压tomcat软件包</span>
<span class="token function">tar</span> xf apache-tomcat-10.0.20.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token comment"># 1.2.创建符号链接</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> apache-tomcat-10.0.20 tomcat
<span class="token comment"># 1.3.配置环境变量</span>
<span class="token function">vim</span> /etc/profile.d/elk.sh
<span class="token punctuation">..</span>.
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/share/elasticsearch/jdk
<span class="token builtin class-name">export</span> <span class="token assign-left variable">TOMCAT_HOME</span><span class="token operator">=</span>/oldboyedu/softwares/tomcat
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$TOMCAT_HOME</span>/bin:<span class="token variable">$JAVA_HOME</span>/bin
<span class="token comment"># 1.4.使得环境变量⽣效</span>
<span class="token builtin class-name">source</span> /etc/profile.d/elk.sh
<span class="token comment"># 1.5.启动服务</span>
catalina.sh start

<span class="token comment"># 2.启⽤tomcat的模块管理</span>
filebeat <span class="token parameter variable">-c</span> ~/config/11-nginx-to-es.yml modules disable nginx
filebeat <span class="token parameter variable">-c</span> ~/config/11-nginx-to-es.yml modules <span class="token builtin class-name">enable</span> tomcat
filebeat <span class="token parameter variable">-c</span> ~/config/11-nginx-to-es.yml modules list

<span class="token comment"># 3.filebeat配置⽂件</span>
filebeat.config.modules:
  <span class="token comment"># 指定模块的配置⽂件路径，如果是yum⽅式安装，在7.17.3版本中不能使⽤如下的默认值。</span>
  <span class="token comment"># path: $&#123;path.config&#125;/modules.d/*.yml</span>
  <span class="token comment"># 经过实际测试，推荐⼤家使⽤如下的配置,此处写绝对路径即可!⽽对于⼆进制部署⽆需做此操作.</span>
  path: /etc/filebeat/modules.d/*.yml
  <span class="token comment"># 开启热加载功能</span>
  reload.enabled: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span>  					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> 		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> 	<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span>		<span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: 			<span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span> 		<span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">0</span> 	<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span>

<span class="token comment"># 4./etc/filebeat/modules.d/tomcat.yml⽂件内容</span>
- module: tomcat
  log:
    enabled: <span class="token boolean">true</span>
    <span class="token comment"># 指定输⼊的类型是⽂件，默认是监听udp端⼝哟～</span>
    var.input: <span class="token function">file</span>
    var.paths:
      - <span class="token string">"/oldboyedu/softwares/apache-tomcat-10.0.20/logs/localhost_access_log.2022-05-11.txt"</span></code></pre>

<h3 id="6-基于-log-类型收集-tomcat-的原生日志"><a href="#6-基于-log-类型收集-tomcat-的原生日志" class="headerlink" title="6.基于 log 类型收集 tomcat 的原生日志"></a>6.基于 log 类型收集 tomcat 的原生日志</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.txt</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="7-基于-log-类型收集-tomcat-的-json-日志"><a href="#7-基于-log-类型收集-tomcat-的-json-日志" class="headerlink" title="7.基于 log 类型收集 tomcat 的 json 日志"></a>7.基于 log 类型收集 tomcat 的 json 日志</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.⾃定义tomcat的⽇志格式</span>
<span class="token function">cp</span> /oldboyedu/softwares/apache-tomcat-10.0.20/conf/<span class="token punctuation">&#123;</span>server.xml,server.xml-<span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%F<span class="token variable">`</span></span><span class="token punctuation">&#125;</span>
<span class="token comment"># ...(切换到⾏尾修改，⼤概是在133-149之间)</span>
<span class="token operator">&lt;</span>Host <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"tomcat.oldboyedu.com"</span> <span class="token assign-left variable">appBase</span><span class="token operator">=</span><span class="token string">"webapps"</span>
      <span class="token assign-left variable">unpackWARs</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token assign-left variable">autoDeploy</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span>
           <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span>
           <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"tomcat.oldboyedu.com_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span>
           <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;request&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;http_user_agent&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;"</span>/<span class="token operator">></span>
<span class="token operator">&lt;</span>/Host<span class="token operator">></span>

<span class="token comment"># 2.修改filebeat的配置⽂件</span>
filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt
    <span class="token comment"># 解析message字段的json格式，并放在顶级字段中</span>
    json.keys_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: <span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="8-多⾏匹配-收集-tomcat-的错误日志"><a href="#8-多⾏匹配-收集-tomcat-的错误日志" class="headerlink" title="8.多⾏匹配-收集 tomcat 的错误日志"></a>8.多⾏匹配-收集 tomcat 的错误日志</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html">https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html</a></p>
<p><code>multiline.match</code></p>
<p>Specifies how Filebeat combines matching lines into an event. The settings are <code>after</code> or <code>before</code>. The behavior of these settings depends on what you specify for <code>negate</code>:</p>
<table>
<thead>
<tr>
<th>Setting for <code>negate</code></th>
<th>Setting for <code>match</code></th>
<th>Result</th>
<th>Example <code>pattern: ^b</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>false</code></td>
<td><code>after</code></td>
<td>Consecutive lines that match the pattern are appended to the previous line that doesn’t match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397337884.png"></td>
</tr>
<tr>
<td><code>false</code></td>
<td><code>before</code></td>
<td>Consecutive lines that match the pattern are prepended to the next line that doesn’t match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397348947.png"></td>
</tr>
<tr>
<td><code>true</code></td>
<td><code>after</code></td>
<td>Consecutive lines that don’t match the pattern are appended to the previous line that does match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397358476.png"></td>
</tr>
<tr>
<td><code>true</code></td>
<td><code>before</code></td>
<td>Consecutive lines that don’t match the pattern are prepended to the next line that does match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397369443.png"></td>
</tr>
</tbody></table>
<blockquote>
<p>The <code>after</code> setting is equivalent to <code>previous</code> in <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html">Logstash</a>, and <code>before</code> is equivalent to <code>next</code>.</p>
</blockquote>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.out</span>
    <span class="token comment"># 指定多⾏匹配的类型，可选值为"pattern","count"</span>
    <span class="token key atrule">multiline.type</span><span class="token punctuation">:</span> pattern
    <span class="token comment"># 指定匹配模式</span>
    <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">'^\d&#123;2&#125;'</span>
    <span class="token comment"># 下⾯2个参数参考官⽅架构图即可，如上图所示。</span>
    <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-tomcat-error-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="9-多⾏匹配-收集-elasticsearch-的错误日志"><a href="#9-多⾏匹配-收集-elasticsearch-的错误日志" class="headerlink" title="9.多⾏匹配-收集 elasticsearch 的错误日志"></a>9.多⾏匹配-收集 elasticsearch 的错误日志</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/elasticsearch/oldboyedu<span class="token punctuation">-</span>elk<span class="token punctuation">-</span>2022.log*
    <span class="token comment"># 指定多⾏匹配的类型，可选值为"pattern","count"</span>
    <span class="token key atrule">multiline.type</span><span class="token punctuation">:</span> pattern
    <span class="token comment"># 指定匹配模式</span>
    <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">'^\['</span>
    <span class="token comment"># 下⾯2个参数参考官⽅架构图即可</span>
    <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-es-error-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="10-nginx-错误日志过滤"><a href="#10-nginx-错误日志过滤" class="headerlink" title="10.nginx 错误日志过滤"></a>10.nginx 错误日志过滤</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/access.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    <span class="token comment"># 解析message字段的json格式，并放在顶级字段中</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/error.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span>
    <span class="token key atrule">include_lines</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'\[error\]'</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token comment"># index: "oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token comment"># 匹配指定字段包含的内容</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"error"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="11-nginx-和-tomcat-同时采集案例"><a href="#11-nginx-和-tomcat-同时采集案例" class="headerlink" title="11.nginx 和 tomcat 同时采集案例"></a>11.nginx 和 tomcat 同时采集案例</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/access.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nginx-access"</span><span class="token punctuation">]</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/error.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nginx-error"</span><span class="token punctuation">]</span>
    <span class="token key atrule">include_lines</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'\[error\]'</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.txt</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"tomcat-access"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.out</span>
    <span class="token key atrule">multiline.type</span><span class="token punctuation">:</span> pattern
    <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">'^\d&#123;2&#125;'</span>
    <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"tomcat-error"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"nginx-access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"nginx-error"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"tomcat-access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"tomcat-error"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="12-log-类型切换-filestream-类型注意事项"><a href="#12-log-类型切换-filestream-类型注意事项" class="headerlink" title="12.log 类型切换 filestream 类型注意事项"></a>12.log 类型切换 filestream 类型注意事项</h3><h4 id="12-1-filestream-类型-json-解析配置"><a href="#12-1-filestream-类型-json-解析配置" class="headerlink" title="12.1.filestream 类型 json 解析配置"></a>12.1.filestream 类型 json 解析配置</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/access.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    <span class="token comment"># 对于filestream类型⽽⾔，不能直接配置json解析，⽽是需要借助解析器实现</span>
    <span class="token comment"># json.keys_under_root: true</span>
    <span class="token comment"># 综上所述，我们就需要使⽤以下的写法实现.</span>
    <span class="token key atrule">parsers</span><span class="token punctuation">:</span>
      <span class="token comment"># 使 Filebeat能够解码结构化为JSON消息的⽇志。</span>
      <span class="token comment"># Filebeat逐⾏处理⽇志，因此JSON解码仅在每条消息有⼀个JSON对象时才有效。</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ndjson</span><span class="token punctuation">:</span>
        <span class="token comment"># 对message字段进⾏JSON格式解析，并将key放在顶级字段。</span>
        <span class="token key atrule">keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-nginx-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h4 id="12-2-filestream-类型多行匹配"><a href="#12-2-filestream-类型多行匹配" class="headerlink" title="12.2.filestream 类型多行匹配"></a>12.2.filestream 类型多行匹配</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.txt</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    <span class="token key atrule">parsers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ndjson</span><span class="token punctuation">:</span>
          <span class="token key atrule">keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.out</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span>
    <span class="token key atrule">parsers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">multiline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> pattern
        <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">'^\d&#123;2&#125;'</span>
        <span class="token key atrule">negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">match</span><span class="token punctuation">:</span> after

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"error"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h3 id="13-收集日志到-redis-服务"><a href="#13-收集日志到-redis-服务" class="headerlink" title="13.收集日志到 redis 服务"></a>13.收集日志到 redis 服务</h3><h4 id="13-1-部署-redis"><a href="#13-1-部署-redis" class="headerlink" title="13.1.部署 redis"></a>13.1.部署 redis</h4><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> redis</code></pre>

<h4 id="13-2-修改配置⽂件"><a href="#13-2-修改配置⽂件" class="headerlink" title="13.2.修改配置⽂件"></a>13.2.修改配置⽂件</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/redis.conf
<span class="token punctuation">..</span>.
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
requirepass oldboyedu</code></pre>

<h4 id="13-3-启动-redis-服务"><a href="#13-3-启动-redis-服务" class="headerlink" title="13.3.启动 redis 服务"></a>13.3.启动 redis 服务</h4><pre class="language-bash" data-language="bash"><code class="language-bash">systemctl start redis</code></pre>

<h4 id="13-4-其他节点连接测试-redis-环境"><a href="#13-4-其他节点连接测试-redis-环境" class="headerlink" title="13.4.其他节点连接测试 redis 环境"></a>13.4.其他节点连接测试 redis 环境</h4><pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-a</span> oldboyedu <span class="token parameter variable">-h</span> <span class="token number">10.0</span>.0.101 <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">--raw</span> <span class="token parameter variable">-n</span> <span class="token number">5</span></code></pre>

<h4 id="13-5-将-filebeat-数据写入到-redis-环境"><a href="#13-5-将-filebeat-数据写入到-redis-环境" class="headerlink" title="13.5.将 filebeat 数据写入到 redis 环境"></a>13.5.将 filebeat 数据写入到 redis 环境</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667398812569.png"></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> tcp
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0:9000"</span>

<span class="token key atrule">output.redis</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6379"</span><span class="token punctuation">]</span> <span class="token comment"># 写⼊redis的主机地址</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu"</span> <span class="token comment"># 指定redis的认证⼝令</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 指定连接数据库的编号</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux80-filebeat"</span> <span class="token comment"># 指定的key值</span>
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 规定超时时间.</span></code></pre>

<h4 id="13-6-测试写入数据"><a href="#13-6-测试写入数据" class="headerlink" title="13.6.测试写入数据"></a>13.6.测试写入数据</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 写⼊数据:</span>
<span class="token builtin class-name">echo</span> <span class="token number">33333333333333333333</span><span class="token operator">|</span> <span class="token function">nc</span> <span class="token number">10.0</span>.0.102 <span class="token number">9000</span>
<span class="token comment"># 查看数据:</span>
<span class="token punctuation">[</span>root@elk103.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a oldboyedu -h 10.0.0.101 -p</span>
<span class="token number">6379</span> <span class="token parameter variable">--raw</span> <span class="token parameter variable">-n</span> <span class="token number">5</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token number">10.0</span>.0.101:6379<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">></span> LRANGE oldboyedu-linux80-filebeat <span class="token number">0</span> <span class="token parameter variable">-1</span></code></pre>

<h3 id="14-今日作业"><a href="#14-今日作业" class="headerlink" title="14.今日作业"></a>14.今日作业</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 完成课堂的所有练习;</span>

<span class="token comment"># 2. 使⽤filebeat收集以下系统⽇志:</span>
/var/log/secure
/var/log/maillog
/var/log/yum.log
/var/log/firewalld
/var/log/cron
/var/log/messages
    <span class="token comment"># 要求如下:</span>
    <span class="token comment"># 1.在同⼀个filebeat配置⽂件中书写;</span>
    <span class="token comment"># 2.将上述6类⽇志分别写⼊不同的索引，索引前缀名称为"oldboyedu-elk-system-log-&#123;xxx&#125;-%&#123;+yyyy.MM.dd&#125;";</span>
    <span class="token comment"># 3.要求副本数量为0，分⽚数量为10;</span>

<span class="token comment"># 7.17.3版本可能遇到的问题:</span>
<span class="token comment"># 1.input源配置⼀旦超过4个，写⼊ES时，就可能会复现出部分数据⽆法写⼊的问题;</span>
<span class="token comment"># 有两种解决⽅案:</span>
<span class="token comment"># ⽅案⼀: 拆成多个filebeat实例。运⾏多个filebeat实例时需要指定数据路径"--path.data"。</span>
	filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/23-systemLog-to-es.yml <span class="token parameter variable">--path.data</span> /tmp/filebeat
<span class="token comment"># ⽅案⼆: ⽇志聚合思路解决问题。</span>
<span class="token comment"># 1)部署服务</span>
	yum <span class="token parameter variable">-y</span> <span class="token function">install</span> rsyslog
<span class="token comment"># 2)修改配置⽂件</span>
	<span class="token function">vim</span> /etc/rsyslog.conf
    <span class="token punctuation">..</span>.
    <span class="token variable">$ModLoad</span> imtcp
    <span class="token variable">$InputTCPServerRun</span> <span class="token number">514</span>
    <span class="token punctuation">..</span>.
    *.* /var/log/oldboyedu.log
<span class="token comment"># 3)重启服务并测试</span>
    systemctl restart rsyslog
    logger <span class="token string">"1111"</span></code></pre>

<h4 id="⽅案⼀：filebeat-多实例"><a href="#⽅案⼀：filebeat-多实例" class="headerlink" title="⽅案⼀：filebeat 多实例"></a>⽅案⼀：filebeat 多实例</h4><p>filebeat 实例⼀：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/firewalld
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"firewalld"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/cron
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cron"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/messages
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
<span class="token key atrule">indices</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-firewalld-%&#123;+yyyy.MM.dd&#125;"</span>
    <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"firewalld"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-cron-%&#123;+yyyy.MM.dd&#125;"</span>
    <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"cron"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-message-%&#123;+yyyy.MM.dd&#125;"</span>
    <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"message"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<p>filebeat 实例二：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/secure
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secure"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/maillog
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"maillog"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/yum.log
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"yum"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-secure-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"secure"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-maillog-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"maillog"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-yum-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"yum"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h4 id="方案二：基于-rsyslog-案例"><a href="#方案二：基于-rsyslog-案例" class="headerlink" title="方案二：基于 rsyslog 案例"></a>方案二：基于 rsyslog 案例</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667399463086.png"></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/oldboyedu.log
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"rsyslog"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-rsyslog--%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"rsyslog"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h2 id="部署-logstash-环境及基础使用"><a href="#部署-logstash-环境及基础使用" class="headerlink" title="部署 logstash 环境及基础使用"></a>部署 logstash 环境及基础使用</h2><h3 id="1-部署-logstash-环境"><a href="#1-部署-logstash-环境" class="headerlink" title="1.部署 logstash 环境"></a>1.部署 logstash 环境</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> localinstall logstash-7.17.3-x86_64.rpm
<span class="token function">ln</span> <span class="token parameter variable">-sv</span> /usr/share/logstash/bin/logstash /usr/local/bin/

<span class="token comment"># 下载地址: https://www.elastic.co/downloads/past-releases#logstash</span></code></pre>

<h3 id="2-修改-logstash-的配置⽂件"><a href="#2-修改-logstash-的配置⽂件" class="headerlink" title="2.修改 logstash 的配置⽂件"></a>2.修改 logstash 的配置⽂件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)编写配置⽂件</span>
<span class="token function">cat</span> <span class="token operator">></span> conf.d/01-stdin-to-stdout.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
input &#123;
    stdin &#123;&#125;
&#125;
output &#123;
    stdout &#123;&#125;
&#125;
EOF</span>

<span class="token comment"># (2)检查配置⽂件语法</span>
logstash <span class="token parameter variable">-tf</span> conf.d/01-stdin-to-stdout.conf

<span class="token comment"># (3)启动logstash实例</span>
logstash <span class="token parameter variable">-f</span> conf.d/01-stdin-to-stdout.conf</code></pre>

<h3 id="3-input-插件基于-file-案例"><a href="#3-input-插件基于-file-案例" class="headerlink" title="3.input 插件基于 file 案例"></a>3.input 插件基于 file 案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定收集的路径</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"/tmp/test/*.txt"</span><span class="token punctuation">]</span>
        <span class="token comment"># 指定⽂件的读取位置，仅在".sincedb*"⽂件中没有记录的情况下⽣效!</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"beginning"</span>
        <span class="token comment"># start_position => "end"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="4-input-插件基于-tcp-案例"><a href="#4-input-插件基于-tcp-案例" class="headerlink" title="4.input 插件基于 tcp 案例"></a>4.input 插件基于 tcp 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667399789647.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    tcp <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="5-input-插件基于-http-案例"><a href="#5-input-插件基于-http-案例" class="headerlink" title="5.input 插件基于 http 案例"></a>5.input 插件基于 http 案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    http <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    http <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="6-input-插件基于-redis-案例"><a href="#6-input-插件基于-redis-案例" class="headerlink" title="6.input 插件基于 redis 案例"></a>6.input 插件基于 redis 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667399903071.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># filebeat的配置:(仅供参考)</span>
filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>

output.redis:
  hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6379"</span><span class="token punctuation">]</span> <span class="token comment"># 写⼊redis的主机地址</span>
  password: <span class="token string">"oldboyedu"</span> <span class="token comment"># 指定redis的认证⼝令</span>
  db: <span class="token number">5</span> <span class="token comment"># 指定连接数据库的编号</span>
  key: <span class="token string">"oldboyedu-linux80-filebeat"</span> <span class="token comment"># 指定的key值</span>
  timeout: <span class="token number">3</span> <span class="token comment"># 规定超时时间.</span>

<span class="token comment"># logstash的配置:</span>
input <span class="token punctuation">&#123;</span>
    redis <span class="token punctuation">&#123;</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>	    				<span class="token comment"># 指定的是REDIS的键(key)的类型</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5</span>	        						<span class="token comment"># 指定数据库的编号,默认值是0号数据库</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>					<span class="token comment"># 指定数据库的ip地址,默认值是localhost</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>	        				<span class="token comment"># 指定数据库的端⼝号，默认值为6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>					<span class="token comment"># 指定redis的认证密码</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>		<span class="token comment"># 指定从redis的哪个key取数据</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="7-input-插件基于-beats-案例"><a href="#7-input-插件基于-beats-案例" class="headerlink" title="7.input 插件基于 beats 案例"></a>7.input 插件基于 beats 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400112207.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># filbeat配置:</span>
filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>
output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:5044"</span><span class="token punctuation">]</span>

<span class="token comment"># logstsh配置:</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5044</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="8-output-插件基于-redis-案例"><a href="#8-output-插件基于-redis-案例" class="headerlink" title="8.output 插件基于 redis 案例"></a>8.output 插件基于 redis 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400209038.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    redis <span class="token punctuation">&#123;</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>		<span class="token comment"># 指定redis的主机地址</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"6379"</span>				<span class="token comment"># 指定redis的端⼝号</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10</span>					<span class="token comment"># 指定redis数据库编号</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>		<span class="token comment"># 指定redis的密码</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>			<span class="token comment"># 指定写⼊数据的key类型</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash"</span>		<span class="token comment"># 指定的写⼊的key名称</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="9-output-插件基于-file-案例"><a href="#9-output-插件基于-file-案例" class="headerlink" title="9.output 插件基于 file 案例"></a>9.output 插件基于 file 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400316902.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
   		port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定磁盘的落地位置</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/oldboyedu-linux80-logstash.log"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="10-logstash-综合案例"><a href="#10-logstash-综合案例" class="headerlink" title="10.logstash 综合案例"></a>10.logstash 综合案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400376710.png"></p>
<p>1.filebeat-to-redis 参考笔记</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> tcp
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0:8888"</span>

<span class="token key atrule">output.redis</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6379"</span><span class="token punctuation">]</span> <span class="token comment"># 写⼊redis的主机地址</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu"</span> <span class="token comment"># 指定redis的认证⼝令</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux80-filebeat"</span> <span class="token comment"># 指定的key值</span>
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 规定超时时间.</span></code></pre>

<p>2.filebeat-to-logstash 参考笔记</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> tcp
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0:9999"</span>
<span class="token key atrule">output.logstash</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:7777"</span><span class="token punctuation">]</span></code></pre>

<p>3.logstash 配置⽂件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-tcp"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6666</span>
    <span class="token punctuation">&#125;</span>
    beats <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-beat"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">7777</span>
    <span class="token punctuation">&#125;</span>
    redis <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-redis"</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-tcp"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-tcp-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-beat"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-beat-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-redis"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-redis-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-other-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="11-今日作业"><a href="#11-今日作业" class="headerlink" title="11.今日作业"></a>11.今日作业</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400682356.png"></p>
<pre class="language-none"><code class="language-none">(1)完成课堂的所有练习，要求能够⼿绘架构图;
(2)如上图所示，按照上述要求完成作业;</code></pre>

<h4 id="11-1-运行一个-logsash-版本"><a href="#11-1-运行一个-logsash-版本" class="headerlink" title="11.1 运行一个 logsash 版本"></a>11.1 运行一个 logsash 版本</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/11-many-to-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    redis <span class="token punctuation">&#123;</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/11-many-to-es.conf</code></pre>

<h4 id="11-2-运行两个-logstash-版本"><a href="#11-2-运行两个-logstash-版本" class="headerlink" title="11.2.运行两个 logstash 版本"></a>11.2.运行两个 logstash 版本</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># logstash接受redis示例：</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/13-redis-to-es.conf
input <span class="token punctuation">&#123;</span>
    redis <span class="token punctuation">&#123;</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/13-redis-to-es.conf

<span class="token comment">#logstash接受beats示例：</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/12-beat-to-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/12-beat-to-es.conf <span class="token parameter variable">--path.data</span> /tmp/logstash</code></pre>

<h2 id="logstash-企业级插件案例-ELFK-架构"><a href="#logstash-企业级插件案例-ELFK-架构" class="headerlink" title="logstash 企业级插件案例(ELFK 架构)"></a>logstash 企业级插件案例(ELFK 架构)</h2><h3 id="1-gork-插件概述"><a href="#1-gork-插件概述" class="headerlink" title="1.gork 插件概述"></a>1.gork 插件概述</h3><p>Grok 是将⾮结构化⽇志数据解析为结构化和可查询的好⽅法。底层原理是基于正则匹配任意⽂本格式。<br>该⼯具⾮常适合 syslog ⽇志、apache 和其他⽹络服务器⽇志、mysql ⽇志，以及通常为⼈类⽽⾮计算机消耗⽽编写的任何⽇志格式。<br>内置 120 种匹配模式，当然也可以⾃定义匹配模式:<br><a target="_blank" rel="noopener" href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a></p>
<h3 id="2-使⽤-grok-内置的正则案例-1"><a href="#2-使⽤-grok-内置的正则案例-1" class="headerlink" title="2.使⽤ grok 内置的正则案例 1"></a>2.使⽤ grok 内置的正则案例 1</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667401251531.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/14-beat-grok-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
  	  port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># "message" => "%&#123;COMBINEDAPACHELOG&#125;"</span>
        <span class="token comment"># 上⾯的""变量官⽅github上已经废弃，建议使⽤下⾯的匹配模式</span>
        <span class="token comment"># https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span>
        <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/14-beat-grok-es.conf</code></pre>

<h3 id="3-使用-grok-内置的正则案例-2"><a href="#3-使用-grok-内置的正则案例-2" class="headerlink" title="3.使用 grok 内置的正则案例 2"></a>3.使用 grok 内置的正则案例 2</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/15-stdin-grok-stdout.conf
input <span class="token punctuation">&#123;</span>
	stdin <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;IP:oldboyedu-client&#125; %&#123;WORD:oldboyedu-method&#125; %&#123;URIPATHPARAM:oldboyedu-request&#125; %&#123;NUMBER:oldboyedu-bytes&#125; %&#123;NUMBER:oldboyedu-duration&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/15-stdin-grok-stdout.conf


<span class="token comment"># 温馨提示:（如下图所示，按照要求输⼊数据）</span>
<span class="token number">55.3</span>.244.1 GET /index.html <span class="token number">15824</span> <span class="token number">0.043</span>
<span class="token number">10.0</span>.0.103 POST /oldboyedu.html <span class="token number">888888</span> <span class="token number">5.20</span>
<span class="token comment"># 参考地址:</span>
https://github.com/logstash-plugins/logstash-patterns-core/tree/main/patterns/legacy</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667401452697.png"></p>
<h3 id="4-使用-grop-自定义的正则案例"><a href="#4-使用-grop-自定义的正则案例" class="headerlink" title="4.使用 grop 自定义的正则案例"></a>4.使用 grop 自定义的正则案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667401700078.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/16-stdin-grok_custom_patterns-stdout.conf
input <span class="token punctuation">&#123;</span>
    stdin <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定匹配模式的⽬录，可以使⽤绝对路径哟～</span>
        <span class="token comment"># 在./patterns⽬录下随便创建⼀个⽂件，并写⼊以下匹配模式</span>
        <span class="token comment"># POSTFIX_QUEUEID [0-9A-F]&#123;10,11&#125;</span>
        <span class="token comment"># OLDBOYEDU_LINUX80 [\d]&#123;3&#125;</span>
        patterns_dir <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"./patterns"</span><span class="token punctuation">]</span>
        <span class="token comment"># 匹配模式</span>
        <span class="token comment"># 测试数据为: Jan 1 06:25:43 mailserver14 postfix/cleanup[21403]:BEF25A72965: message-id=&lt;20130101142543.5828399CCAF@mailserver14.example.com></span>
        <span class="token comment"># match => &#123; "message" => "%&#123;SYSLOGBASE&#125; %&#123;POSTFIX_QUEUEID:queue_id&#125;: %&#123;GREEDYDATA:syslog_message&#125;" &#125;</span>
        <span class="token comment"># 测试数据为: ABCDE12345678910 ---> 333FGHIJK</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;POSTFIX_QUEUEID:oldboyedu_queue_id&#125; ---> %&#123;OLDBOYEDU_LINUX80:oldboyedu_linux80_elk&#125;"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/16-stdin-grok_custom_patterns-stdout.conf</code></pre>

<h3 id="5-filter-插件通用字段案例"><a href="#5-filter-插件通用字段案例" class="headerlink" title="5.filter 插件通用字段案例"></a>5.filter 插件通用字段案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667401967834.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/17-beat-grok-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># "message" => "%&#123;COMBINEDAPACHELOG&#125;"</span>
            <span class="token comment"># 上⾯的""变量官⽅github上已经废弃，建议使⽤下⾯的匹配模式</span>
            <span class="token comment"># https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment"># 移除指定的字段</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"agent"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 添加指定的字段</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
            <span class="token string">"oldboyedu-clientip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip ---> %&#123;clientip&#125;"</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment"># 添加tag</span>
        add_tag <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"linux80"</span>,<span class="token string">"zookeeper"</span>,<span class="token string">"kafka"</span>,<span class="token string">"elk"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 移除tag</span>
        remove_tag <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"zookeeper"</span>, <span class="token string">"kafka"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 创建插件的唯⼀ID，如果不创建则系统默认⽣成</span>
        <span class="token function">id</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"nginx"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token comment"># elasticsearch &#123;</span>
        <span class="token comment"># hosts => ["10.0.0.101:9200","10.0.0.102:9200","10.0.0.103:9200"]</span>
        <span class="token comment"># index => "oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token comment"># &#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/17-beat-grok-es.conf</code></pre>

<h3 id="6-date-插件修改写入-ES-的时间"><a href="#6-date-插件修改写入-ES-的时间" class="headerlink" title="6.date 插件修改写入 ES 的时间"></a>6.date 插件修改写入 ES 的时间</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/18-beat-grok_date-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
  	  port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># "message" => "%&#123;COMBINEDAPACHELOG&#125;"</span>
            <span class="token comment"># 上⾯的""变量官⽅github上已经废弃，建议使⽤下⾯的匹配模式</span>
            <span class="token comment"># https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment"># 移除指定的字段</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"agent"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 添加指定的字段</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token function">date</span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># 匹配时间字段并解析,值得注意的是，logstash的输出时间可能会错8⼩时,但写⼊es但数据是准确的!</span>
        <span class="token comment"># "13/May/2022:15:47:24 +0800", 以下2种match写法均可!</span>
        <span class="token comment"># match => ["timestamp","dd/MMM/yyyy:HH:mm:ss Z"]</span>
        <span class="token comment"># 当然，我们也可以不对时区字段进⾏解析，⽽是使⽤"timezone"指定时区哟!</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"timestamp"</span>,<span class="token string">"dd/MMM/yyyy:HH:mm:ss +0800"</span><span class="token punctuation">]</span>
        <span class="token comment"># 设置时区字段为UTC时间,写⼊ES的数据时间是不准确的</span>
        <span class="token comment"># timezone => "UTC"</span>
        <span class="token comment"># 建议⼤家设置为"Asia/Shanghai"，写⼊ES的数据是准确的!</span>
        timezone <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Asia/Shanghai"</span>
        <span class="token comment"># 将匹配到到时间字段解析后存储到⽬标字段，若不指定，则默认字段为"@timestamp"字段</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx-access-time"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/18-beat-grok_date-es.conf</code></pre>

<h3 id="7-geoip-分析源地址的地址位置"><a href="#7-geoip-分析源地址的地址位置" class="headerlink" title="7.geoip 分析源地址的地址位置"></a>7.geoip 分析源地址的地址位置</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/19-beat-grok_date_geoip-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"agent"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">date</span> <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"timestamp"</span>,<span class="token string">"dd/MMM/yyyy:HH:mm:ss Z"</span><span class="token punctuation">]</span>
        timezone <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Asia/Shanghai"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx-access-time"</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定基于哪个字段分析IP地址</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        <span class="token comment"># 如果期望查看指定的字段，则可以在这⾥配置即可，若不设置，表示显示所有的查询字段.</span>
        fields <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"city_name"</span>,<span class="token string">"country_name"</span>,<span class="token string">"ip"</span><span class="token punctuation">]</span>
        <span class="token comment"># 指定geoip的输出字段，如果想要对多个IP地址进⾏分析，则该字段很有⽤哟~</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/19-beat-grok_date_geoip-es.conf</code></pre>

<h3 id="8-useragent-分析客户端的设备类型"><a href="#8-useragent-分析客户端的设备类型" class="headerlink" title="8.useragent 分析客户端的设备类型"></a>8.useragent 分析客户端的设备类型</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/20-beat-grok_date_geoip_useragent-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    <span class="token function">date</span> <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"timestamp"</span>,<span class="token string">"dd/MMM/yyyy:HH:mm:ss Z"</span><span class="token punctuation">]</span>
        timezone <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Asia/Shanghai"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx-access-time"</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"agent"</span>, <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        fields <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"city_name"</span>,<span class="token string">"country_name"</span>,<span class="token string">"ip"</span><span class="token punctuation">]</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
    <span class="token punctuation">&#125;</span>
    useragent <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定客户端的设备相关信息的字段</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"http_user_agent"</span>
        <span class="token comment"># 将分析的数据存储在⼀个指定的字段中，若不指定，则默认存储在target字段中。</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/20-beat-grok_date_geoip_useragent-es.conf</code></pre>

<h3 id="9-mutate-组件数据准备-python-脚本"><a href="#9-mutate-组件数据准备-python-脚本" class="headerlink" title="9.mutate 组件数据准备-python 脚本"></a>9.mutate 组件数据准备-python 脚本</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> generate_log.py <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/usr/bin/env python
# -*- coding: UTF-8 -*-
# @author : oldboyedu-linux80

import datetime
import random
import logging
import time
import sys

LOG_FORMAT = "%(levelname)s %(asctime)s [com.oldboyedu.%(module)s] - %(message)s "
DATE_FORMAT = "%Y-%m-%d %H:%M:%S"

# 配置root的logging.Logger实例的基本配置
logging.basicConfig(level=logging.INFO, format=LOG_FORMAT,datefmt=DATE_FORMAT, filename=sys.argv[1], filemode='a',)
actions = ["浏览⻚⾯", "评论商品", "加⼊收藏", "加⼊购物⻋", "提交订单", "使⽤优惠券", "领取优惠券","搜索", "查看订单", "付款", "清空购物⻋"]

while True:
    time.sleep(random.randint(1, 5))
    user_id = random.randint(1, 10000)
    # 对⽣成的浮点数保留2位有效数字.
    price = round(random.uniform(15000, 30000),2)
    action = random.choice(actions)
    svip = random.choice([0,1])
	logging.info("DAU|&#123;0&#125;|&#123;1&#125;|&#123;2&#125;|&#123;3&#125;".format(user_id,action,svip,price))
EOF</span>

$ <span class="token function">nohup</span> python generate_log.py /tmp/app.log <span class="token operator">&amp;></span>/dev/null <span class="token operator">&amp;</span></code></pre>

<h3 id="9-mutate-组件常⽤字段案例"><a href="#9-mutate-组件常⽤字段案例" class="headerlink" title="9.mutate 组件常⽤字段案例"></a>9.mutate 组件常⽤字段案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667402745944.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/21-mutate.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
	mutate <span class="token punctuation">&#123;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"@timestamp"</span>, <span class="token string">"agent"</span>, <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	<span class="token comment"># 对"message"字段内容使⽤"|"进⾏切分。</span>
        <span class="token function">split</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        	<span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"|"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 添加字段，其中引⽤到了变量</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][1]&#125;"</span>
            <span class="token string">"action"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][2]&#125;"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][3]&#125;"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][4]&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	strip <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"svip"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	<span class="token comment"># 将指定字段转换成相应对数据类型.</span>
        convert <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"integer"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"boolean"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"float"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 将"price"字段拷⻉到"oldboyedu-linux80-price"字段中.</span>
        copy <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-price"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 修改字段到名称</span>
        <span class="token function">rename</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-ssvip"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 替换字段的内容</span>
        replace <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;message&#125;: My new message"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 将指定字段的字⺟全部⼤写</span>
        uppercase <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"message"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	elasticsearch <span class="token punctuation">&#123;</span>
		hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
		index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/21-mutate.conf</code></pre>

<h3 id="10-logstash-的多-if-分支案例"><a href="#10-logstash-的多-if-分支案例" class="headerlink" title="10.logstash 的多 if 分支案例"></a>10.logstash 的多 if 分支案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667403026999.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/22-beats_tcp-filter-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-beats"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    tcp <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-tcp"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
    tcp <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-tcp-new"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">7777</span>
    <span class="token punctuation">&#125;</span>
    http <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-http"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6666</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-file"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/apps.log"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token string">"oldboyedu-beats"</span>,<span class="token string">"oldboyedu-tcp-new"</span>,<span class="token string">"oldboyedu-http"</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
        mutate <span class="token punctuation">&#123;</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"agent"</span>, <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
        geoip <span class="token punctuation">&#123;</span>
            <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
            target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
        <span class="token punctuation">&#125;</span>
        useragent <span class="token punctuation">&#123;</span>
            <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"http_user_agent"</span>
            target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-file"</span> <span class="token punctuation">&#123;</span>
    	mutate <span class="token punctuation">&#123;</span>
            add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"class"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80"</span>
                <span class="token string">"address"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京昌平区沙河镇⽼男孩IT教育"</span>
                <span class="token string">"hobby"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"LOL"</span>,<span class="token string">"王者荣耀"</span><span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"host"</span>,<span class="token string">"@version"</span>,<span class="token string">"school"</span><span class="token punctuation">]</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        mutate <span class="token punctuation">&#123;</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"port"</span>,<span class="token string">"@version"</span>,<span class="token string">"host"</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
        mutate <span class="token punctuation">&#123;</span>
            <span class="token function">split</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"|"</span>
            <span class="token punctuation">&#125;</span>
            add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][1]&#125;"</span>
                <span class="token string">"action"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][2]&#125;"</span>
                <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][3]&#125;"</span>
                <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][4]&#125;"</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment"># 利⽤完message字段后，在删除是可以等!注意代码等执⾏顺序!</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>
            strip <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"svip"</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
        mutate <span class="token punctuation">&#123;</span>
            convert <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"integer"</span>
                <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"boolean"</span>
                <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"float"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-beats"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-beats"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    	elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-tcp"</span>
    	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/22-beats_tcp-filter-es.conf</code></pre>

<h3 id="11-今日作业-1"><a href="#11-今日作业-1" class="headerlink" title="11.今日作业"></a>11.今日作业</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667403459392.png"></p>
<pre class="language-none"><code class="language-none">如上图所示，要求完成以下内容:
(1)收集nginx⽇志，写⼊ES集群，分⽚数量为3，副本数量为0，索引名称为&quot;oldboyedu-linux80-nginx&quot;;
(2)收集tomcat⽇志，写⼊ES集群，分⽚数量为5，副本数量为0，索引名称为&quot;oldboyedu-linux80-tomcat&quot;;
(3)收集app⽇志，写⼊ES集群，分⽚数量为10，副本数量为0，索引名称为&quot;oldboyedu-linux80-app&quot;;
进阶作业:
(1)分析出nginx，tomcat的客户端ip所属城市，访问时使⽤的设备类型等。
(2)请调研使⽤logstash的pipline来替代logstash的多实例⽅案;</code></pre>

<h4 id="filebeat-手机-tomcat-日志"><a href="#filebeat-手机-tomcat-日志" class="headerlink" title="filebeat 手机 tomcat 日志"></a>filebeat 手机 tomcat 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat ~/config/38-tomcat-to-logstash.yml</span>
filebeat.inputs:
    - type: log
      enabled: <span class="token boolean">true</span>
      paths:
          - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt
      json.keys_under_root: <span class="token boolean">true</span>

output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:7777"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/38-tomcat-to-logstash.yml</code></pre>

<h4 id="filebeat-收集-nginx-日志"><a href="#filebeat-收集-nginx-日志" class="headerlink" title="filebeat 收集 nginx 日志"></a>filebeat 收集 nginx 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat ~/config/37-nginx-to-logstash.yml</span>
filebeat.inputs:
    - type: log
      enabled: <span class="token boolean">true</span>
      paths:
          - /var/log/nginx/access.log*
      json.keys_under_root: <span class="token boolean">true</span>

output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:8888"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/37-nginx-to-logstash.yml <span class="token parameter variable">--path.data</span> /tmp/filebeat-nginx</code></pre>

<h4 id="filebeat-收集-apps-日志"><a href="#filebeat-收集-apps-日志" class="headerlink" title="filebeat 收集 apps 日志"></a>filebeat 收集 apps 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat ~/config/39-apps-to-logstash.yml</span>
filebeat.inputs:
    - type: log
      enabled: <span class="token boolean">true</span>
      paths:
          - /tmp/app.log*
output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6666"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/39-apps-to-logstash.yml <span class="token parameter variable">--path.data</span> /tmp/filebeat-app</code></pre>

<h4 id="logstash-收集-nginx-日志"><a href="#logstash-收集-nginx-日志" class="headerlink" title="logstash 收集 nginx 日志"></a>logstash 收集 nginx 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/24-homework-01-to-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"tags"</span>,<span class="token string">"log"</span>,<span class="token string">"agent"</span>,<span class="token string">"@version"</span>, <span class="token string">"input"</span>,<span class="token string">"ecs"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
    <span class="token punctuation">&#125;</span>
    useragent <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"http_user_agent"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	elasticsearch <span class="token punctuation">&#123;</span>
		hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
		index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx"</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># logstash -rf config-logstash/24-homework-01-to-es.conf</span></code></pre>

<h4 id="logstash-收集-tomcat-日志"><a href="#logstash-收集-tomcat-日志" class="headerlink" title="logstash 收集 tomcat 日志"></a>logstash 收集 tomcat 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/24-homework-02-to-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">7777</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"tags"</span>,<span class="token string">"log"</span>,<span class="token string">"agent"</span>,<span class="token string">"@version"</span>, <span class="token string">"input"</span>,<span class="token string">"ecs"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
    <span class="token punctuation">&#125;</span>
    useragent <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"AgentVersion"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-tomcat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/24-homework-02-to-es.conf <span class="token parameter variable">--path.data</span> /tmp/homework-logstash-02</code></pre>

<h4 id="logstash-收集-apps-日志"><a href="#logstash-收集-apps-日志" class="headerlink" title="logstash 收集 apps 日志"></a>logstash 收集 apps 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/24-homework-03-to-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6666</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"tags"</span>,<span class="token string">"log"</span>,<span class="token string">"agent"</span>,<span class="token string">"@version"</span>, <span class="token string">"input"</span>,<span class="token string">"ecs"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"port"</span>,<span class="token string">"@version"</span>,<span class="token string">"host"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token function">split</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"|"</span>
        <span class="token punctuation">&#125;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][1]&#125;"</span>
            <span class="token string">"action"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][2]&#125;"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][3]&#125;"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][4]&#125;"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>
        strip <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"svip"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        convert <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"integer"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"boolean"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"float"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-apps"</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/24-homework-03-to-es.conf <span class="token parameter variable">--path.data</span> /tmp/homework-logstash-03</code></pre>

<h2 id="kibana-自定义-dashboard-实战案例"><a href="#kibana-自定义-dashboard-实战案例" class="headerlink" title="kibana 自定义 dashboard 实战案例"></a>kibana 自定义 dashboard 实战案例</h2><h3 id="1-统计-pv（指标）"><a href="#1-统计-pv（指标）" class="headerlink" title="1.统计 pv（指标）"></a>1.统计 pv（指标）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667405121451.png"></p>
<pre class="language-none"><code class="language-none">Page View(简称:&quot;PV&quot;)
	⻚⾯访问或点击量。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)新建可视化
    (4)基于聚合
    (5)指标
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中选择:
        聚合: 计数
        定制标签: PV</code></pre>

<h3 id="2-统计客户端-IP（指标）"><a href="#2-统计客户端-IP（指标）" class="headerlink" title="2.统计客户端 IP（指标）"></a>2.统计客户端 IP（指标）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407132063.png"></p>
<pre class="language-none"><code class="language-none">客户端IP:
	通常指的是访问Web服务器的客户端IP地址，但要注意，客户端IP数量并不难代表UV。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)指标
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中选择:
        聚合: 唯⼀计数
        字段: clientip.keyword
        定制标签: IP</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667407161985.png"></p>
<h3 id="3-统计-web-下载带宽（指标）"><a href="#3-统计-web-下载带宽（指标）" class="headerlink" title="3.统计 web 下载带宽（指标）"></a>3.统计 web 下载带宽（指标）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407232833.png"></p>
<pre class="language-none"><code class="language-none">带宽:
	统计nginx返回给客户端⽂件⼤⼩的字段进⾏累计求和。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)指标
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中选择:
        聚合: 求和
        字段: SendBytes
        定制标签: 带宽</code></pre>

<h3 id="4-访问页面统计（水平条形图）"><a href="#4-访问页面统计（水平条形图）" class="headerlink" title="4.访问页面统计（水平条形图）"></a>4.访问页面统计（水平条形图）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407385838.png"></p>
<pre class="language-none"><code class="language-none">访问资源统计:
	对URI的访问次数统计。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)⽔平条形图
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    定制标签: 访问量
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: uri.keyword
        ...
        定制标签: URI</code></pre>

<h3 id="5-分析客户端的城市分布（垂直条形图）"><a href="#5-分析客户端的城市分布（垂直条形图）" class="headerlink" title="5.分析客户端的城市分布（垂直条形图）"></a>5.分析客户端的城市分布（垂直条形图）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407440342.png"></p>
<pre class="language-none"><code class="language-none">分析客户端的城市分布:
	需要借助logstash的filter插件的geoip实现对客户端的IP地址进⾏地域解析。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)垂直条形图
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    定制标签: 城市分布
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: oldboyedu-linux80-nginx.city_name.keyword
        ...
        定制标签: 城市名称</code></pre>

<h3 id="6-城市分布百分比（饼图）"><a href="#6-城市分布百分比（饼图）" class="headerlink" title="6.城市分布百分比（饼图）"></a>6.城市分布百分比（饼图）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407492998.png"></p>
<pre class="language-none"><code class="language-none">分析客户端的城市分布:
	需要借助logstash的filter插件的geoip实现对客户端的IP地址进⾏地域解析。
kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)饼图
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    定制标签: 城市分布
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: oldboyedu-linux80-nginx.city_name.keyword
        ...
        定制标签: 城市名称</code></pre>

<h3 id="7-IP-的-TopN-统计（仪表盘）"><a href="#7-IP-的-TopN-统计（仪表盘）" class="headerlink" title="7.IP 的 TopN 统计（仪表盘）"></a>7.IP 的 TopN 统计（仪表盘）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407565612.png"></p>
<pre class="language-none"><code class="language-none">IP的TopN统计:
	统计访问量的客户端IP最⼤的是谁。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)仪表盘
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: client.keyword
        顺序: 降序
        ⼤⼩: 3
        ...</code></pre>

<h3 id="8-自定义-dashboard"><a href="#8-自定义-dashboard" class="headerlink" title="8.自定义 dashboard"></a>8.自定义 dashboard</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407613789.png"></p>
<pre class="language-none"><code class="language-none">kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Dashboard
    (3)创建仪表盘
    (4)从可视化库中添加即可。

如上图和下图所示，为我添加到dashboard界⾯。</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667407635559.png"></p>
<h2 id="ElasticStack-二进制部署及排错"><a href="#ElasticStack-二进制部署及排错" class="headerlink" title="ElasticStack 二进制部署及排错"></a>ElasticStack 二进制部署及排错</h2><h3 id="1-部署-Oracle-JDK-环境"><a href="#1-部署-Oracle-JDK-环境" class="headerlink" title="1.部署 Oracle JDK 环境"></a>1.部署 Oracle JDK 环境</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407713319.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 官⽅连接:		https://www.oracle.com/java/technologies/downloads/#java8</span>
<span class="token comment"># elk101单节点部署oracle jdk步骤:</span>
<span class="token comment"># (1)创建⼯作⽬录</span>
$ <span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /oldboyedu/softwares
<span class="token comment"># (2)解压JDK到指定的⽬录</span>
$ <span class="token function">tar</span> xf jdk-8u291-linux-x64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token comment"># (3)创建符号链接</span>
$ <span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> jdk1.8.0_291 jdk
<span class="token comment"># (4)创建环境变量</span>
$ <span class="token function">cat</span> <span class="token operator">></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/bin/bash
export JAVA_HOME=/oldboyedu/softwares/jdk
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$JAVA_HOME</span>/bin
EOF</span>

$ <span class="token builtin class-name">source</span> /etc/profile.d/elk.sh
<span class="token comment">#  (5)查看JDK的版本号</span>
$ <span class="token function">java</span> <span class="token parameter variable">-version</span>
<span class="token comment"># 集群部署还需要做下⾯2个步骤:</span>
<span class="token comment"># (1)同步jdk环境到其他节点</span>
$ data_rsync.sh /oldboyedu/
$ data_rsync.sh /etc/profile.d/elk.sh
<span class="token comment"># (2)其他节点测试</span>
$ <span class="token builtin class-name">source</span> /etc/profile.d/elk.sh
$ <span class="token function">java</span> <span class="token parameter variable">-version</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667407777709.png"></p>
<h3 id="2-单节点-ES-部署"><a href="#2-单节点-ES-部署" class="headerlink" title="2.单节点 ES 部署"></a>2.单节点 ES 部署</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)下载ES软件</span>
<span class="token comment"># 略，参考之前的视频。</span>

<span class="token comment"># (2)解压ES</span>
$ <span class="token function">tar</span> xf elasticsearch-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/

<span class="token comment"># (3)创建符号链接</span>
$ <span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> elasticsearch-7.17.3 es

<span class="token comment"># (4)配置环境变量</span>
$ <span class="token function">cat</span> <span class="token operator">>></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
export ES_HOME=/oldboyedu/softwares/es
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$ES_HOME</span>/bin
EOF</span>

$ <span class="token builtin class-name">source</span> /etc/profile.d/elk.sh

<span class="token comment"># (5)创建ES⽤户，⽤于运⾏ES服务</span>
$ <span class="token function">useradd</span> oldboyedu

<span class="token comment"># (6)修改配置⽂件</span>
$ <span class="token function">vim</span> /oldboyedu/softwares/es/config/elasticsearch.yml
<span class="token punctuation">..</span>.
cluster.name: oldboyedu-linux80-elk
network.host: <span class="token number">0.0</span>.0.0
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span><span class="token punctuation">]</span>
cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span><span class="token punctuation">]</span>

<span class="token comment"># (7)修改权限</span>
$ <span class="token function">chown</span> oldboyedu:oldboyedu <span class="token parameter variable">-R</span> /oldboyedu/softwares/elasticsearch-7.17.3/

<span class="token comment"># (8)修改⽂件打开数量的限制(退出当前会话⽴即⽣效)</span>
$ <span class="token function">cat</span> <span class="token operator">></span> /etc/security/limits.d/elk.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
* soft nofile 65535
* hard nofile 131070
EOF</span>

<span class="token comment"># (9)修改内核参数的内存映射信息</span>
$ <span class="token function">cat</span> <span class="token operator">></span> /etc/sysctl.d/elk.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
vm.max_map_count = 262144
EOF</span>
$ <span class="token function">sysctl</span> <span class="token parameter variable">-f</span> /etc/sysctl.d/elk.conf
$ <span class="token function">sysctl</span> <span class="token parameter variable">-q</span> vm.max_map_count

<span class="token comment"># (10)启动服务("-d"选项代表是后台启动服务.)</span>
$ <span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"elasticsearch"</span> oldboyedu
$ <span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"elasticsearch -d"</span> oldboyedu

<span class="token comment"># (11)验证服务</span>
$ <span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200
$ <span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200/_cat/nodes</code></pre>

<h3 id="3-修改-ES-的堆（heap）内存大小"><a href="#3-修改-ES-的堆（heap）内存大小" class="headerlink" title="3.修改 ES 的堆（heap）内存大小"></a>3.修改 ES 的堆（heap）内存大小</h3><pre class="language-none"><code class="language-none">前置知识:
    jps快速⼊⻔:
        作⽤:
        	查看java相关的进程信息。
        常⽤参数:
            -l: 显示包名称。
            -v: 显示进程的相信信息
            -V: 默认就是该选项，表示查看简要信息。
            -q: 只查看pid。

    jmap快速⼊⻔:
        作⽤:
        	查看java的堆栈信息。
        常⽤参数:
            -heap: 查看堆内存的⼤⼩。
            -dump: 下载堆内存的相关信息。

(1)修改堆内存⼤⼩
vim &#x2F;oldboyedu&#x2F;softwares&#x2F;es&#x2F;config&#x2F;jvm.options
...
# 堆内存设置不建议超过32G.
-Xms256m
-Xmx256m

(2)重启服务
kill &#96;jps | grep Elasticsearch | awk &#39;&#123;print $1&#125;&#39;&#96;
su -c &quot;elasticsearch -d&quot; oldboyedu

(3)验证堆内存的⼤⼩
jmap -heap &#96;jps | grep Elasticsearch | awk &#39;&#123;print $1&#125;&#39;&#96;

推荐阅读:
https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.17&#x2F;advanced-configuration.html#set-jvm-heap-size</code></pre>

<h3 id="4-ES-启动脚本编写"><a href="#4-ES-启动脚本编写" class="headerlink" title="4.ES 启动脚本编写"></a>4.ES 启动脚本编写</h3><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">></span> /usr/lib/systemd/system/es.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Oldboyedu linux80 ELK
After=network.target

[Service]
Type=forking
ExecStart=/oldboyedu/softwares/es/bin/elasticsearch -d
Restart=no
User=oldboyedu
Group=oldboyedu
LimitNOFILE=131070

[Install]
WantedBy=multi-user.target
EOF</span>

$ systemctl daemon-reload
$ systemctl restart es</code></pre>

<h3 id="5-部署-ES-集群"><a href="#5-部署-ES-集群" class="headerlink" title="5.部署 ES 集群"></a>5.部署 ES 集群</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)停⽌ES服务并删除集群之前的数据（如果是ES集群扩容就别删除数据了，我这⾥是部署⼀个"⼲净"的集群）</span>
systemctl stop es
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /oldboyedu/softwares/es/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span> /tmp/*
<span class="token function">install</span> <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyedu <span class="token parameter variable">-d</span> /oldboyedu/softwares/es/logs

<span class="token comment"># (2)创建数据和⽇志⽬录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /oldboyedu/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span>
<span class="token function">install</span> <span class="token parameter variable">-d</span> /oldboyedu/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span>/es7 <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyedu

<span class="token comment"># (3)修改配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/es/config/elasticsearch.yml
<span class="token punctuation">..</span>.
cluster.name: oldboyedu-linux80-elk
path.data: /oldboyedu/data/es7
path.logs: /oldboyedu/logs/es7
network.host: <span class="token number">0.0</span>.0.0
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span>,<span class="token string">"10.0.0.102"</span>,<span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>
cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span>,<span class="token string">"10.0.0.102"</span>,<span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>

<span class="token comment"># (4)elk101节点同步数据到其他节点</span>
data_rsync.sh /oldboyedu/
data_rsync.sh /etc/security/limits.d/elk.conf
data_rsync.sh /etc/sysctl.d/elk.conf
data_rsync.sh /usr/lib/systemd/system/es.service
data_rsync.sh /etc/profile.d/elk.sh

<span class="token comment"># (5)其他节点重连会话后执⾏以下操作</span>
<span class="token function">useradd</span> oldboyedu
<span class="token function">sysctl</span> <span class="token parameter variable">-f</span> /etc/sysctl.d/elk.conf
<span class="token function">sysctl</span> <span class="token parameter variable">-q</span> vm.max_map_count
systemctl daemon-reload

<span class="token comment"># (6)启动ES集群</span>
systemctl start es

<span class="token comment"># (7)验证ES的集群服务是否正常</span>
<span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200
<span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200/_cat/nodes</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408129949.png"></p>
<h3 id="6-部署-kibana-服务"><a href="#6-部署-kibana-服务" class="headerlink" title="6.部署 kibana 服务"></a>6.部署 kibana 服务</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667408158533.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)解压软件包</span>
<span class="token function">tar</span> xf kibana-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/

<span class="token comment"># (2)创建符号链接</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> kibana-7.17.3-linux-x86_64 kibana

<span class="token comment"># (3)配置环境变量</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
export KIBANA_HOME=/oldboyedu/softwares/kibana
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$KIBANA_HOME</span>/bin
EOF</span>

<span class="token builtin class-name">source</span> /etc/profile.d/elk.sh

<span class="token comment"># (4)修改⽂件全选</span>
<span class="token function">chown</span> oldboyedu:oldboyedu <span class="token parameter variable">-R</span> /oldboyedu/softwares/kibana-7.17.3-linux-x86_64/

<span class="token comment"># (5)修改配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/kibana/config/kibana.yml
<span class="token punctuation">..</span>.
server.host: <span class="token string">"0.0.0.0"</span>
server.name: <span class="token string">"oldboyedu-linux80-kibana"</span>
elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
i18n.locale: <span class="token string">"zh-CN"</span>

<span class="token comment"># (6)启动服务</span>
<span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"kibana"</span> oldboyedu</code></pre>

<h3 id="7-部署-logstash"><a href="#7-部署-logstash" class="headerlink" title="7.部署 logstash"></a>7.部署 logstash</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)解压logstash</span>
<span class="token function">tar</span> xf logstash-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/

<span class="token comment"># (2)创建符号链接</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> logstash-7.17.3 logstsash

<span class="token comment"># (3)配置环境变量</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
export LOGSTASH_HOME=/oldboyedu/softwares/logstsash
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$LOGSTASH_HOME</span>/bin
EOF</span>

<span class="token builtin class-name">source</span> /etc/profile.d/elk.sh

<span class="token comment"># (4)编写测试案例</span>
<span class="token function">cat</span> <span class="token operator">></span> conf-logstash/01-stdin-to-stdout.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
input &#123;
    stdin &#123;&#125;
&#125;
output&#123;
    stdout &#123;&#125;
&#125;
EOF</span>

<span class="token comment"># (5)运⾏测试案例</span>
logstash <span class="token parameter variable">-f</span> conf-logstash/01-stdin-to-stdout.conf</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408245132.png"></p>
<h3 id="7-部署-filebeat"><a href="#7-部署-filebeat" class="headerlink" title="7.部署 filebeat"></a>7.部署 filebeat</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)解压软件包</span>
<span class="token function">tar</span> xf filebeat-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/filebeat-7.17.3-linux-x86_64
<span class="token function">mkdir</span> config-filebeat

<span class="token comment"># (2)编写配置⽂件</span>
<span class="token function">cat</span> <span class="token operator">></span> config-filebeat/01-stdin-to-console.yml <span class="token operator">&lt;</span>EOF
filebeat.inputs:
    - type: stdin
output.console:
    pretty: <span class="token boolean">true</span>
EOF

<span class="token comment"># (3)启动filebeat实例</span>
./filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> config-filebeat/01-stdin-to-console.yml</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408384164.png"></p>
<h3 id="8-部署-es-head-插件"><a href="#8-部署-es-head-插件" class="headerlink" title="8.部署 es-head 插件"></a>8.部署 es-head 插件</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667408419501.png"></p>
<pre class="language-none"><code class="language-none">(1)解压es-head组件的软件包
unzip es-head-0.1.4_0.crx.zip

(2)⾕歌浏览器导⼊软件包
设置 ---&gt; 扩展程序 ---&gt; 勾选&quot;开发者模式&quot; ---&gt; &quot;加载已经解压的扩展程序&quot; ---&gt; 选择&quot;上⼀步骤解压的⽬录&quot;</code></pre>

<h3 id="9-部署-postman-组件"><a href="#9-部署-postman-组件" class="headerlink" title="9.部署 postman 组件"></a>9.部署 postman 组件</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667408466932.png"></p>
<pre class="language-none"><code class="language-none">(1)下载postman组件
https:&#x2F;&#x2F;www.postman.com&#x2F;downloads&#x2F;

(2)post的使⽤
后续讲解。</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408482877.png"></p>
<h3 id="10-今⽇作业"><a href="#10-今⽇作业" class="headerlink" title="10.今⽇作业"></a>10.今⽇作业</h3><pre class="language-none"><code class="language-none">(1)完成课堂的所有练习
(2)完善kibana的启动脚本，使⽤systemctl⼯具管理kibana并设置为开机⾃启动;

进阶作业:
	调研logstash的多pipline编写。</code></pre>

<h2 id="ElasticSearch-的-Restful-风格-API-实战"><a href="#ElasticSearch-的-Restful-风格-API-实战" class="headerlink" title="ElasticSearch 的 Restful 风格 API 实战"></a>ElasticSearch 的 Restful 风格 API 实战</h2><h3 id="1-Restful-及-JSON-格式"><a href="#1-Restful-及-JSON-格式" class="headerlink" title="1.Restful 及 JSON 格式"></a>1.Restful 及 JSON 格式</h3><table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>字符串</td>
<td>要求使⽤双引号（””）引起来的数据</td>
<td>“oldboyedu”</td>
</tr>
<tr>
<td>数字</td>
<td>通常指的是 0-9 的所有数字。</td>
<td>100</td>
</tr>
<tr>
<td>布尔值</td>
<td>只有 true 和 false 两个值</td>
<td>true</td>
</tr>
<tr>
<td>空值</td>
<td>只有 null 一个值</td>
<td>null</td>
</tr>
<tr>
<td>数组</td>
<td>使⽤⼀对中括号（”[]”）放⼊不同的元素（⽀持⾼级数据类型和基础数据类型）</td>
<td>[“linux”,100,false]</td>
</tr>
<tr>
<td>对象</td>
<td>使⽤⼀对⼤括号（”{}”）扩起来，⾥⾯的数据使⽤ KEY-VALUE 键值对即可。</td>
<td>{“class”:”linux80”,”age”:25}</td>
</tr>
</tbody></table>
<pre class="language-none"><code class="language-none">Restful⻛格程序:
	RESTFUL是⼀种⽹络应⽤程序的设计⻛格和开发⽅式，基于HTTP，可以使⽤XML格式定义或
JSON格式定义。
	REST（英⽂：Representational State Transfer，简称REST）描述了⼀个架构样式的⽹络系统，⽐如 web 应⽤程序。
	REST⾸次出现在2000年Roy Fielding的博⼠论⽂中，Roy Fielding是HTTP规范的主要编写者之⼀。

JSON语法:
    基础数据类型:
        字符串:
            &quot;oldboyedu&quot;
            &quot;⽼男孩IT教育&quot;
            &quot;2022&quot;
            &quot;&quot;
    数字:
        0
        1
        2
        ...
    布尔值:
        true
        false
    空值:
        null

    ⾼级数据类型:
        数组:
        	[&quot;oldboyedu&quot;,&quot;沙河&quot;,2022,null,true,&#123;&quot;school&quot;:&quot;oldboyedu&quot;,&quot;class&quot;:&quot;linux80&quot;&#125;]
        对象:
        	&#123;&quot;name&quot;:&quot;oldboy&quot;, &quot;age&quot;:40, &quot;address&quot;:&quot;北京沙河&quot;, &quot;hobby&quot;:[&quot;Linux&quot;,&quot;思想课&quot;],&quot;other&quot;:null&#125;

课堂练习:
	使⽤json格式记录你的名字(name),年龄(age),学校(school),爱好(hobby),地址(address)。</code></pre>

<h3 id="2-ElasticSearch-的相关术语"><a href="#2-ElasticSearch-的相关术语" class="headerlink" title="2.ElasticSearch 的相关术语"></a>2.ElasticSearch 的相关术语</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667409049243.png"></p>
<pre class="language-none"><code class="language-none">Document:
	即⽂档，是⽤户存储在ES的⼀些数据，它是ES中最⼩的存储单元。换句话说，⼀个⽂档是不可被拆分的。
	⼀个⽂档使⽤的是json的对象数据类型存储。
filed:
	相当于数据库表的字段，对⽂档数据根据不同属性进⾏分类标示。
index:
	即索引，⼀个索引就是⼀个拥有相似特征⽂档的集合。
shard:
	即分⽚，是真正存储数据的地⽅，每个分⽚底层对应的是⼀个Lucene库。⼀个索引⾄少有1个或多个分⽚。
replica:
	即副本，是对数据的备份，⼀个分⽚可以有0个或多个副本。
	⼀旦副本数量不为0，就会引⼊主分⽚(primary shard)和副本分⽚(replica shard)的概念。
		主分⽚(primary shard):
			可以实现数据的读写操作。
		副本分⽚(replica shard):
			可以实现数据读操作，与此同时，需要去主分⽚同步数据，当主分⽚挂掉，副本分⽚会变为主分⽚。
Allocation:
	即分配，将分⽚(shard)分配给某个节点的过程，包括主分⽚和副本分⽚。
	如果是副本分⽚，还包含从主分⽚复制数据的过程，这个分配过程由master节点调度完成。
Type:
	在es 5.x即更早的版本，在⼀个索引中，我们可以定义⼀种或多种数据类型。但在es7仅⽀持&quot;_doc&quot;类型。</code></pre>

<h3 id="3-管理索引的-API"><a href="#3-管理索引的-API" class="headerlink" title="3.管理索引的 API"></a>3.管理索引的 API</h3><h4 id="3-1-查看索引信息"><a href="#3-1-查看索引信息" class="headerlink" title="3.1 查看索引信息"></a>3.1 查看索引信息</h4><pre class="language-none"><code class="language-none">GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;_cat&#x2F;indices		# 查看全部的索引信息
GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;_cat&#x2F;indices?v	# 查看表头信息
GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;_cat&#x2F;indices&#x2F;.kibana_7.17.3_001?v	# 查看单个索引
GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;.kibana_7.17.3_001	# 查看单个索引的详细信息</code></pre>

<h4 id="3-2-创建索引"><a href="#3-2-创建索引" class="headerlink" title="3.2 创建索引"></a>3.2 创建索引</h4><pre class="language-none"><code class="language-none">PUT http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux82 # 创建索引并指定分⽚和副本
&#123;
    &quot;settings&quot;: &#123;
        &quot;index&quot;: &#123;
            &quot;number_of_shards&quot;: &quot;3&quot;,
            &quot;number_of_replicas&quot;: 0
        &#125;
    &#125;
&#125;

参数说明:
	&quot;number_of_shards&quot;:		指定分⽚数量。
	&quot;number_of_replicas&quot;:	指定副本数量。</code></pre>

<h4 id="3-3-修改索引"><a href="#3-3-修改索引" class="headerlink" title="3.3 修改索引"></a>3.3 修改索引</h4><pre class="language-none"><code class="language-none">PUT http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux80&#x2F;_settings
&#123;
	&quot;number_of_replicas&quot;: 0
&#125;

温馨提示:
	分⽚数量⽆法修改，副本数量是可以修改的。</code></pre>

<h4 id="3-4-删除索引"><a href="#3-4-删除索引" class="headerlink" title="3.4 删除索引"></a>3.4 删除索引</h4><pre class="language-none"><code class="language-none">DELETE http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux80

温馨提示:
	删除索引，服务器的数据也会随之删除哟!</code></pre>

<h4 id="3-5-索引别名"><a href="#3-5-索引别名" class="headerlink" title="3.5 索引别名"></a>3.5 索引别名</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/_aliases 	<span class="token comment"># 添加索引别名</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"actions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"add"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"Linux容器运维"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token punctuation">&#123;</span>
            <span class="token string">"add"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux82"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"DBA"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/_aliases <span class="token comment"># 查看索引别名</span>

POST http://10.0.0.101:9200/_aliases <span class="token comment"># 删除索引别名</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"actions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"remove"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"Linux容器运维"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_aliases <span class="token comment"># 修改索引别名</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"actions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"remove"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux82"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"DBA"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token punctuation">&#123;</span>
            <span class="token string">"add"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux82"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"SRE"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="3-6-索引关闭"><a href="#3-6-索引关闭" class="headerlink" title="3.6 索引关闭"></a>3.6 索引关闭</h4><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux80&#x2F;_close	# 关闭索引
POST http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-*&#x2F;_close			# 基于通配符关闭索引

温馨提示:
	索引关闭意味着该索引⽆法进⾏任何的读写操作，但数据并不会被删除。</code></pre>

<h4 id="3-7-索引打开"><a href="#3-7-索引打开" class="headerlink" title="3.7 索引打开"></a>3.7 索引打开</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/oldboyedu-linux80/_open		<span class="token comment"># 打开索引</span>
POST http://10.0.0.101:9200/oldboyedu-*/_open			<span class="token comment"># 基于通配符打开索引</span></code></pre>

<h4 id="3-8-索引的其他操作"><a href="#3-8-索引的其他操作" class="headerlink" title="3.8 索引的其他操作"></a>3.8 索引的其他操作</h4><p>推荐阅读: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html</a></p>
<h3 id="4-管理文档的-API"><a href="#4-管理文档的-API" class="headerlink" title="4.管理文档的 API"></a>4.管理文档的 API</h3><h4 id="4-1-文档的创建"><a href="#4-1-文档的创建" class="headerlink" title="4.1 文档的创建"></a>4.1 文档的创建</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/teacher/_doc	<span class="token comment"># 创建⽂档不指定"_id"</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"Linux"</span>,
        <span class="token string">"思想课"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/student/_doc/1003	<span class="token comment"># 创建⽂档并指定ID</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"苍⽼师"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"家庭主妇"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="4-2-文档的查看"><a href="#4-2-文档的查看" class="headerlink" title="4.2 文档的查看"></a>4.2 文档的查看</h4><pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/teacher/_search	<span class="token comment"># 查看所有的⽂档</span>
GET http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6	<span class="token comment"># 查看某⼀个⽂档</span>
HEAD http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6	<span class="token comment"># 判断某⼀个⽂档是否存在，返回200，404.</span>

温馨提示:
    源数据:
    	指的是⽤户写⼊的数据。
    元数据:
    	指的是描述数据的数据，由ES内部维护。</code></pre>

<h4 id="4-3-文档的修改"><a href="#4-3-文档的修改" class="headerlink" title="4.3 文档的修改"></a>4.3 文档的修改</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6	<span class="token comment"># 全量更新，会覆盖原有的⽂档数据内容。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"Linux"</span>,
        <span class="token string">"思想课"</span>,
        <span class="token string">"抖⾳"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
POST http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6/_update	<span class="token comment"># 局部更新，并不会覆盖原有的数据。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"doc"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"⽼男孩"</span>,
        <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">45</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="4-4-文档的删除"><a href="#4-4-文档的删除" class="headerlink" title="4.4 文档的删除"></a>4.4 文档的删除</h4><pre class="language-bash" data-language="bash"><code class="language-bash">DELETE http://10.0.0.101:9200/teacher/_doc/1001</code></pre>

<h4 id="4-5-文档的批量操作"><a href="#4-5-文档的批量操作" class="headerlink" title="4.5 文档的批量操作"></a>4.5 文档的批量操作</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 批量创建</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,<span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"Linux"</span>,<span class="token string">"思想课"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,<span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token number">1002</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"振亚"</span>,<span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"妹⼦"</span>,<span class="token string">"吃⾯"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,<span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token number">1001</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"苍⽼师"</span>,<span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"家庭主妇"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 批量删除</span>
<span class="token punctuation">&#123;</span> <span class="token string">"delete"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>, <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1001"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"delete"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>, <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1002"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 批量修改</span>
<span class="token punctuation">&#123;</span> <span class="token string">"update"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1001"</span>, <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"doc"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"CangLaoShi"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"update"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1002"</span>, <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"doc"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"ZhenYa"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_mget	<span class="token comment"># 批量查看</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"docs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,
            <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1001"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token punctuation">&#123;</span>
            <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,
            <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1002"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示: 对于⽂档的批量写操作，需要使⽤<code>_bulk</code>的 API，⽽对于批量的读操作，需要使⽤<code>_mget</code>的 API。</p>
<p>参考链接:</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-bulk.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-bulk.html</a><br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-multi-get.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-multi-get.html</a></p>
<h4 id="4-6-课堂的练习"><a href="#4-6-课堂的练习" class="headerlink" title="4.6 课堂的练习"></a>4.6 课堂的练习</h4><p>将下⾯的数据存储到 ES 集群：</p>
<pre class="language-none"><code class="language-none">&#123;&quot;name&quot;:&quot;oldboy&quot;,&quot;hobby&quot;:[&quot;Linux&quot;,&quot;思想课&quot;]&#125;
&#123;&quot;name&quot;:&quot;振亚&quot;,&quot;hobby&quot;:[&quot;妹⼦&quot;,&quot;吃⾯&quot;]&#125;
&#123;&quot;name&quot;:&quot;苍⽼师&quot;,&quot;hobby&quot;:[&quot;家庭主妇&quot;]&#125;</code></pre>

<h3 id="5-使用映射（mapping）自定义数据类型"><a href="#5-使用映射（mapping）自定义数据类型" class="headerlink" title="5.使用映射（mapping）自定义数据类型"></a>5.使用映射（mapping）自定义数据类型</h3><h4 id="5-1-映射的数据类型"><a href="#5-1-映射的数据类型" class="headerlink" title="5.1 映射的数据类型"></a>5.1 映射的数据类型</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667447917074.png"></p>
<p>当写⼊⽂档时，字段的数据类型会被 ES 动态⾃动创建，但有的时候动态创建的类型并符合我们的需求。这个时候就可以使⽤映射解决。</p>
<p>使⽤映射技术，可以对 ES ⽂档的字段类型提前定义我们期望的数据类型，便于后期的处理和搜索。</p>
<ul>
<li>text: 全⽂检索，可以被全⽂匹配，即该字段是可以被拆分的。</li>
<li>keyword: 精确匹配，必须和内容完全匹配，才能被查询出来。</li>
<li>ip: ⽀持 Ipv4 和 Ipv6，将来可以对该字段类型进⾏ IP 地址范围搜索。</li>
</ul>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping-types.html</a></p>
<h4 id="5-2-IP-案例"><a href="#5-2-IP-案例" class="headerlink" title="5.2 IP 案例"></a>5.2 IP 案例</h4><pre class="language-bash" data-language="bash"><code class="language-bash">PUT http://10.0.0.101:9200/oldboyedu-linux80-elk	<span class="token comment"># 创建索引时指定映射关系</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"mappings"</span> :<span class="token punctuation">&#123;</span>
        <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            	<span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"ip"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk	<span class="token comment"># 查看索引的映射关系</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 创建测试数据</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.10.101"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.10.201"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"172.31.10.100"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"10.0.0.222"</span> <span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk/_search	<span class="token comment"># 查看IP的⽹断</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.0/16"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="5-3-其他类型类型案例"><a href="#5-3-其他类型类型案例" class="headerlink" title="5.3 其他类型类型案例"></a>5.3 其他类型类型案例</h4><pre class="language-bash" data-language="bash"><code class="language-bash">PUT http://10.0.0.101:9200/oldboyedu-linux80-elk-2022	<span class="token comment"># 创建索引</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022<span class="token comment"># 查看索引信息</span>

PUT http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_mapping	<span class="token comment"># 为已创建的索引修改数据类型</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"gender"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"telephone"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"email"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"ip"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 添加测试数据</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.10.101"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"柳鹏"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"男性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"33333333"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"沙河"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"liupeng@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.20.21"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王岩"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"男性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"55555"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"松兰堡"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"wangyan@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"172.28.30.101"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"赵嘉欣"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"⼥性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"33333333"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"于⾟庄"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"zhaojiaxin@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"172.28.50.121"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"庞冉"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"⼥性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"444444444"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"于⾟庄"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"pangran@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"10.0.0.67"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王浩任"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"男性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"22222222"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"松兰堡"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"wanghaoren@oldboyedu.com"</span><span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于gender字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"gender"</span><span class="token builtin class-name">:</span> <span class="token string">"⼥"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于name字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于email字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"email"</span><span class="token builtin class-name">:</span> <span class="token string">"pangran@oldboyedu.com"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于ip_addr字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.0/16"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于address字段搜索，⽆法完成。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token string">"松兰堡"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="6-IK-中文分词器"><a href="#6-IK-中文分词器" class="headerlink" title="6. IK 中文分词器"></a>6. IK 中文分词器</h3><h4 id="6-1-内置的标准分词器-分析英文"><a href="#6-1-内置的标准分词器-分析英文" class="headerlink" title="6.1 内置的标准分词器 - 分析英文"></a>6.1 内置的标准分词器 - 分析英文</h4><pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"My name is Jason Yin, and I'm 18 years old !"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示: 标准分词器模式使⽤空格和符号进⾏切割分词的。</p>
<h4 id="6-2-内置的标准分词器-分析中文并不友好"><a href="#6-2-内置的标准分词器-分析中文并不友好" class="headerlink" title="6.2 内置的标准分词器 - 分析中文并不友好"></a>6.2 内置的标准分词器 - 分析中文并不友好</h4><pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"我爱北京天安⻔!"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示: 标准分词器默认使⽤单个汉⼦进⾏切割，很明显，并不符合我们国内的使⽤习惯。</p>
<h4 id="6-3-安装-IK-分词器"><a href="#6-3-安装-IK-分词器" class="headerlink" title="6.3 安装 IK 分词器"></a>6.3 安装 IK 分词器</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667448439377.png"></p>
<p>下载地址: <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>安装 IK 分词器：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">install</span> <span class="token parameter variable">-d</span> /oldboyedu/softwares/es/plugins/ik <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyed
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/es/plugins/ik
<span class="token function">unzip</span> elasticsearch-analysis-ik-7.17.3.zip
<span class="token function">rm</span> <span class="token parameter variable">-f</span> elasticsearch-analysis-ik-7.17.3.zip
<span class="token function">chown</span> <span class="token parameter variable">-R</span> oldboyedu:oldboyedu *</code></pre>

<p>重启 ES 节点，使之加载插件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">systemctl restart es</code></pre>

<p>测试 IK 分词器：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/_analyze		<span class="token comment"># 细粒度拆分</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_max_word"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"我爱北京天安⻔!"</span>
<span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/_analyze		<span class="token comment"># 粗粒度拆分</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_smart"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"我爱北京天安⻔!"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="6-4-自定义-IK-分词器的字典"><a href="#6-4-自定义-IK-分词器的字典" class="headerlink" title="6.4 自定义 IK 分词器的字典"></a>6.4 自定义 IK 分词器的字典</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)进⼊到IK分词器的插件安装⽬录</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/es/plugins/ik/config

<span class="token comment"># (2)⾃定义字典</span>
<span class="token function">cat</span> <span class="token operator">></span> oldboyedu-linux80.dic <span class="token operator">&lt;&lt;</span><span class="token string">EOF
上号
德玛⻄亚
艾欧尼亚
亚索
EOF</span>

<span class="token function">chown</span> oldboyedu:oldboyedu oldboyedu-linux80.dic

<span class="token comment"># (3)加载⾃定义字典</span>
<span class="token function">vim</span> IKAnalyzer.cfg.xml
<span class="token punctuation">..</span>.
<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">"ext_dict"</span><span class="token operator">></span>oldboyedu-linux80.dic<span class="token operator">&lt;</span>/entry<span class="token operator">></span>

<span class="token comment"># (4)重启ES集群</span>
systemctl restart es

<span class="token comment"># (5)测试分词器</span>
GET http://10.0.0.101:9200/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_smart"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"嗨，哥们! 上号，我德玛⻄亚和艾欧尼亚都有号! 我亚索贼6，肯定能带你⻜!!!"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="6-5-自定义分词器-了解即可"><a href="#6-5-自定义分词器-了解即可" class="headerlink" title="6.5 自定义分词器 - 了解即可"></a>6.5 自定义分词器 - 了解即可</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)⾃定义分词器</span>
PUT http://10.0.0.101:9200/oldboyedu_linux80_2022
<span class="token punctuation">&#123;</span>
    <span class="token string">"settings"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"analysis"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"char_filter"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"&amp;_to_and"</span>:<span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"mapping"</span>,
                    <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"&amp; => and"</span><span class="token punctuation">]</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"filter"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"my_stopwords"</span>:<span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"stop"</span>,
                    <span class="token string">"stopwords"</span>:<span class="token punctuation">[</span><span class="token string">"the"</span>,<span class="token string">"a"</span>,<span class="token string">"if"</span>,<span class="token string">"are"</span>,<span class="token string">"to"</span>,<span class="token string">"be"</span>,<span class="token string">"kind"</span><span class="token punctuation">]</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"analyzer"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"my_analyzer"</span>:<span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"custom"</span>,
                    <span class="token string">"char_filter"</span>:<span class="token punctuation">[</span><span class="token string">"html_strip"</span>,<span class="token string">"&amp;_to_and"</span><span class="token punctuation">]</span>,
                    <span class="token string">"tokenizer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>,
                    <span class="token string">"filter"</span>:<span class="token punctuation">[</span><span class="token string">"lowercase"</span>,<span class="token string">"my_stopwords"</span><span class="token punctuation">]</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># (2)验证置⾃定义分词器是否⽣效</span>
GET http://10.0.0.101:9200/oldboyedu_linux80_2022/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"text"</span><span class="token builtin class-name">:</span><span class="token string">"If you are a PERSON, Please be kind to small Animals."</span>,
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span><span class="token string">"my_analyzer"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="7-今日作业"><a href="#7-今日作业" class="headerlink" title="7. 今日作业"></a>7. 今日作业</h3><pre class="language-none"><code class="language-none">(1)将&quot;shopping.json&quot;⽂件的内容使⽤&quot;_bulk&quot;的API批量写⼊ES集群，要求索引名称为&quot;oldboyedu-shopping&quot;;

(2)每⼈收集10条数据并写⼊ES集群，索引名称为&quot;oldboyedu-linux80&quot;</code></pre>

<h4 id="7-1-shopping-json"><a href="#7-1-shopping-json" class="headerlink" title="7.1 shopping.json"></a>7.1 shopping.json</h4><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"戴尔（DELL）31.5英⼨ 4K 曲⾯ 内置⾳箱 低蓝光 影院级⾊彩 FreeSync技术 可壁挂 1800R 电脑显示器 S3221QS"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">3399.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"Dell"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"15.25kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100014940686.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"三星（SAMSUNG）28英⼨ 4K IPS 10.7亿⾊ 90%DCI-P3 Eyecomfort2.0认证 专业设计制图显示器（U28R550UQC）"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">2099.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"SAMSUNG"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"7.55kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100009558656.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"ALIENWARE外星⼈新品外设⾼端键⿏套装AW510K机械键盘cherry轴RGB/AW610M 610M ⽆线⿏标+510K机械键盘+510H⽿机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">6000.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"ALIENWARE外星⼈"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10030370257612.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"樱桃CHERRY MX8.0彩光87键游戏机械键盘合⾦⼥⽣樱粉⾊版 彩光-粉⾊红轴-粉⾊箱 官⽅标配"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4066.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"樱桃CHERRY"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10024385308012.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"罗技（G）G610机械键盘 有线机械键盘 游戏机械键盘 全尺⼨背光机械键盘 吃鸡键盘 Cherry红轴"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">429.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"罗技"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.627kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/3378484.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"美商海盗船（USCORSAIR）K68机械键盘⿊⾊ 防⽔防尘樱桃轴体 炫彩背光游戏有线 红光红轴"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">499.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"美商海盗船"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.41kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/43580479783.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"雷蛇(Razer) 蝰蛇标准版 ⿏标 有线⿏标 游戏⿏标 ⼈体⼯程学 电竞 ⿊⾊6400DPI lol吃鸡神器cf"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">109.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"雷蛇"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"185.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/8141909.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"罗技（G）G502 HERO主宰者有线⿏标 游戏⿏标 HERO引擎 RGB⿏标 电竞⿏标 25600DPI"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">299.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"罗技"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"250.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100001691967.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"武极 i5 10400F/GTX1050Ti/256G游戏台式办公电脑主机DIY组装机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4099.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"武极"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"5.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/1239166056.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"变异者 组装电脑主机DIY台式游戏 i5 9400F/16G/GTX1050Ti 战胜G1"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4299.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"变异者"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"9.61kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/41842373306.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"宏碁(Acer) 暗影骑⼠·威N50-N92 英特尔酷睿i5游戏台机 吃鸡电脑主机(⼗⼀代i5-11400F 16G 256G+1T GTX1650)"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">5299.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"宏碁"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"7.25kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100020726324.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"京天 酷睿i7 10700F/RTX2060/16G内存 吃鸡游戏台式电脑主机DIY组装机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">7999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"京天"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"10.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/40808512828.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"戴尔（DELL）OptiPlex 3070MFF/3080MFF微型台式机电脑迷你⼩主机客厅HTPC 标配 i5-10500T/8G/1T+256G 内置WiFi+蓝⽛ 全国联保 三年上⻔"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">3999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"DELL"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"2.85kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10025304273651.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"伊萌纯种英短蓝⽩猫活体猫咪幼猫活体英国短⽑猫矮脚猫英短蓝猫幼体银渐层蓝⽩活体宠物蓝猫幼崽猫咪宠物猫短 双⾎统A级 ⺟"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4000.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"英短"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10027188382742.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"柴墨 ⾦渐层幼猫英短猫宠物猫英短⾦渐层猫咪活体猫活体纯种⼩猫银渐层 双⾎统"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">12000.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"英短"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"3.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10029312412476.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Redmi Note10 Pro 游戏智能5G⼿机 ⼩⽶ 红⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">9999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"10.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100021970002.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"【⼆⼿99新】⼩⽶Max3⼿机⼆⼿⼿机 ⼤屏安卓 曜⽯⿊ 6G+128G 全⽹通"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1046.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"0.75kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/35569092038.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"现货速发（10天价保）⼩⽶11 5G⼿机 骁⻰888 游戏智能⼿机 PRO店内可选⿊⾊ 套装版 12GB+256GB"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4699.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"0.7kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10025836790851.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"⼩⽶⼿环6 NFC版 全⾯彩屏 30种运动模式 24h⼼率检测 50⽶防⽔ 智能⼿环"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">279.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"65.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100019867468.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"HUAWEI MateView⽆线原⾊显示器⽆线版 28.2英⼨ 4K+ IPS 98% DCI-P310.7亿⾊ HDR400 TypeC 双扬声器 双MIC"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4699.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"9.8kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100021420806.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"华为nova7se/nova7 se 5G⼿机（ 12期免息可选 ）下单享好礼 绮境森林乐活版 8G+128G（1年碎屏险）"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">2999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"500.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10029312412476.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"华为HUAWEI FreeBuds 4i主动降噪 ⼊⽿式真⽆线蓝⽛⽿机/通话降噪/⻓续航/⼩巧舒适 Android&amp;ios通⽤ 陶瓷⽩"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">479.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"137.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100018510746.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"HUAWEI WATCH GT2 华为⼿表 运动智能⼿表 两周⻓续航/蓝⽛通话/⾎氧检测/麒麟芯⽚ 华为gt2 46mm 曜⽯⿊"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1488.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"335.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100008492922.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Apple苹果12 mini iPhone 12 mini 5G ⼿机（现货速发 12期免息可选）蓝⾊ 5G版 64G"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4699.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"280.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10026100075337.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Apple iPhone 12 (A2404) 128GB 紫⾊ ⽀持移动联通电信5G 双卡双待⼿机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">6799.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"330.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100011203359.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"华硕ROG冰刃双屏 ⼗代英特尔酷睿 15.6英⼨液⾦导热300Hz电竞游戏笔记本电脑 i9-10980H 32G 2T RTX2080S"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">48999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华硕"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"2.5kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10021558215658.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"联想⼩新Air15 2021超轻薄笔记本电脑 ⾼⾊域学⽣办公设计师游戏本 ⼋核锐⻰R7-5700U 16G内存 512G固态 升级15.6英⼨IPS全⾯屏【DC调光护眼⽆闪烁】"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">5499.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"10.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/33950552707.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"苹果（Apple）MacBook Air 13.3英⼨ 笔记本电脑 【2020款商务灰】⼗代i7 16G 512G 官⽅标配 19点前付款当天发货"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">10498.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.29kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10021130510120.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"科⼤讯⻜机器⼈ 阿尔法蛋A10智能机器⼈ 专业教育⼈⼯智能编程机器⼈学习机智能可编程 ⽩⾊"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1099.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"科⼤讯⻜"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.7kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100005324258.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"robosen乐森机器⼈六⼀⼉童节礼物⾃营孩⼦玩具星际特⼯智能编程机器⼈⼉童语⾳控制陪伴益智变形机器⼈"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">2499.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"senpowerT9-X"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"3.01kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100006740372.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"优必选（UBTECH）悟空智能语⾳监控对话⼈形机器⼈⼉童教育陪伴早教学习机玩具"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"优必选悟空"</span><span class="token punctuation">,</span>
	<span class="token property">"weigth"</span><span class="token operator">:</span> <span class="token string">"1.21kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100000722348.html"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="7-2-oldboyedu-linux80-json"><a href="#7-2-oldboyedu-linux80-json" class="headerlink" title="7.2 oldboyedu-linux80.json"></a>7.2 oldboyedu-linux80.json</h4><pre class="language-none"><code class="language-none">等你来完善...

要求如下:
	(1)收集源数据，要求包含&quot;title&quot;,&quot;price&quot;,&quot;brand&quot;,&quot;weigth&quot;,&quot;item&quot;,&quot;producer&quot;;
    &quot;title&quot;		商品的标题。
    &quot;price&quot;		商品的价格。
    &quot;brand&quot;		商品的品牌。
    &quot;weigth&quot;	商品的重量。
    &quot;item&quot;		商品的链接。
    &quot;producer&quot;	收集者姓名。

	(2)要求使⽤ES的批量操作的API完成;</code></pre>

<h5 id="参考案例-1"><a href="#参考案例-1" class="headerlink" title="参考案例 1"></a>参考案例 1</h5><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_bulk
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;戴尔（DELL）31.5英⼨ 4K 曲⾯ 内置⾳箱 低蓝光 影院级⾊彩 FreeSync技术 可壁挂 1800R 电脑显示器 S3221QS&quot;,&quot;price&quot;:3399.00,&quot;brand&quot;:&quot;Dell&quot;,&quot;weight&quot;:&quot;15.25kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100014940686.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;三星（SAMSUNG）28英⼨ 4K IPS 10.7亿⾊ 90%DCI-P3 Eyecomfort2.0认证 专业设计制图显示器（U28R550UQC）&quot;,&quot;price&quot;:2099.00,&quot;brand&quot;:&quot;SAMSUNG&quot;,&quot;weight&quot;:&quot;7.55kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100009558656.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;ALIENWARE外星⼈新品外设⾼端键⿏套装AW510K机械键盘cherry轴RGB&#x2F;AW610M 610M ⽆线⿏标+510K机械键盘+510H⽿机&quot;,&quot;price&quot;:6000.00,&quot;brand&quot;:&quot;ALIENWARE外星⼈&quot;,&quot;weight&quot;:&quot;1.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10030370257612.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;樱桃CHERRY MX8.0彩光87键游戏机械键盘合⾦⼥⽣樱粉⾊版 彩光-粉⾊红轴-粉⾊箱 官⽅标配&quot;,&quot;price&quot;:4066.00,&quot;brand&quot;:&quot;樱桃CHERRY&quot;,&quot;weight&quot;:&quot;1.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10024385308012.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;罗技（G）G610机械键盘 有线机械键盘 游戏机械键盘 全尺⼨背光机械键盘 吃技&quot;,&quot;weight&quot;:&quot;1.627kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;3378484.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;美商海盗船（USCORSAIR）K68机械键盘⿊⾊ 防⽔防尘樱桃轴体 炫彩背光游戏有线 红光红轴&quot;,&quot;price&quot;:499.00,&quot;brand&quot;:&quot;美商海盗船&quot;,&quot;weight&quot;:&quot;1.41kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;43580479783.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;雷蛇(Razer) 蝰蛇标准版 ⿏标 有线⿏标 游戏⿏标 ⼈体⼯程学 电竞 ⿊⾊6400DPI lol吃鸡神器cf&quot;,&quot;price&quot;:109.00,&quot;brand&quot;:&quot;雷蛇&quot;,&quot;weight&quot;:&quot;185.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;8141909.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;罗技（G）G502 HERO主宰者有线⿏标 游戏⿏标 HERO引擎 RGB⿏标 电竞⿏标25600DPI&quot;,&quot;price&quot;:299.00,&quot;brand&quot;:&quot;罗技&quot;,&quot;weight&quot;:&quot;250.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100001691967.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;武极 i5 10400F&#x2F;GTX1050Ti&#x2F;256G游戏台式办公电脑主机DIY组装机&quot;,&quot;price&quot;:4099.00,&quot;brand&quot;:&quot;武极&quot;,&quot;weight&quot;:&quot;5.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;1239166056.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;宏碁(Acer) 暗影骑⼠·威N50-N92 英特尔酷睿i5游戏台机 吃鸡电脑主机(⼗⼀代i5-11400F 16G 256G+1T GTX1650)&quot;,&quot;price&quot;:5299.00,&quot;brand&quot;:&quot;宏碁&quot;,&quot;weight&quot;:&quot;7.25kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100020726324.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;京天 酷睿i7 10700F&#x2F;RTX2060&#x2F;16G内存 吃鸡游戏台式电脑主机DIY组装机&quot;,&quot;price&quot;:7999.00,&quot;brand&quot;:&quot;京天&quot;,&quot;weight&quot;:&quot;10.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;40808512828.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;戴尔（DELL）OptiPlex 3070MFF&#x2F;3080MFF微型台式机电脑迷你⼩主机客厅HTPC 标配 i5-10500T&#x2F;8G&#x2F;1T+256G 内置WiFi+蓝⽛ 全国联保 三年上⻔&quot;,&quot;price&quot;:3999.00,&quot;brand&quot;:&quot;DELL&quot;,&quot;weight&quot;:&quot;2.85kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10025304273651.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;伊萌纯种英短蓝⽩猫活体猫咪幼猫活体英国短⽑猫矮脚猫英短蓝猫幼体银渐层蓝⽩活体宠物蓝猫幼崽猫咪宠物猫短 双⾎统A级 ⺟&quot;,&quot;price&quot;:4000.00,&quot;brand&quot;:&quot;英短&quot;,&quot;weight&quot;:&quot;1.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10027188382742.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;柴墨 ⾦渐层幼猫英短猫宠物猫英短⾦渐层猫咪活体猫活体纯种⼩猫银渐层 双⾎统&quot;,&quot;price&quot;:12000.00,&quot;brand&quot;:&quot;英短&quot;,&quot;weight&quot;:&quot;3.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10029312412476.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;Redmi Note10 Pro 游戏智能5G⼿机 ⼩⽶ 红⽶&quot;,&quot;price&quot;:9999.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;10.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100021970002.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;【⼆⼿99新】⼩⽶Max3⼿机⼆⼿⼿机 ⼤屏安卓 曜⽯⿊ 6G+128G 全⽹通&quot;,&quot;price&quot;:1046.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;0.75kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;35569092038.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;现货速发（10天价保）⼩⽶11 5G⼿机 骁⻰888 游戏智能⼿机 PRO店内可选⿊⾊ 套装版 12GB+256GB&quot;,&quot;price&quot;:4699.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;0.75kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10025836790851.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;⼩⽶⼿环6 NFC版 全⾯彩屏 30种运动模式 24h⼼率检测 50⽶防⽔ 智能⼿环&quot;,&quot;price&quot;:279.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;65.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100019867468.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;HUAWEI MateView⽆线原⾊显示器⽆线版 28.2英⼨ 4K+ IPS 98% DCI-P310.7亿⾊ HDR400 TypeC 双扬声器 双MIC&quot;,&quot;price&quot;:4699.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;9.8kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100021420806.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;华为nova7se&#x2F;nova7 se 5G⼿机（ 12期免息可选 ）下单享好礼 绮境森林 乐活版 8G+128G（1年碎屏险）&quot;,&quot;price&quot;:2999.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;500.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10029312412476.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;华为HUAWEI FreeBuds 4i主动降噪 ⼊⽿式真⽆线蓝⽛⽿机&#x2F;通话降噪&#x2F;⻓续航&#x2F;⼩巧舒适 Android&amp;ios通⽤ 陶瓷⽩&quot;,&quot;price&quot;:479.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;137.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100018510746.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;HUAWEI WATCH GT2 华为⼿表 运动智能⼿表 两周⻓续航&#x2F;蓝⽛通话&#x2F;⾎氧检测&#x2F;麒麟芯⽚ 华为gt2 46mm 曜⽯⿊&quot;,&quot;price&quot;:1488.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;335.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100008492922.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;Apple苹果12 mini iPhone 12 mini 5G ⼿机（现货速发 12期免息可选）蓝⾊ 5G版 64G&quot;,&quot;price&quot;:4699.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;280.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10026100075337.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;Apple iPhone 12 (A2404) 128GB 紫⾊ ⽀持移动联通电信5G 双卡双待⼿机&quot;,&quot;price&quot;:6799.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;330.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100011203359.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;华硕ROG冰刃双屏 ⼗代英特尔酷睿 15.6英⼨液⾦导热300Hz电竞游戏笔记本电脑 i9-10980H 32G 2T RTX2080S&quot;,&quot;price&quot;:48999.00,&quot;brand&quot;:&quot;华硕&quot;,&quot;weight&quot;:&quot;2.5kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10021558215658.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;联想⼩新Air15 2021超轻薄笔记本电脑 ⾼⾊域学⽣办公设计师游戏本 ⼋核锐⻰R7-5700U 16G内存 512G固态 升级15.6英⼨IPS全⾯屏【DC调光护眼⽆闪烁】&quot;,&quot;price&quot;:5499.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;10.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;33950552707.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;苹果（Apple）MacBook Air 13.3英⼨ 笔记本电脑 【2020款商务灰】⼗代i7 16G 512G 官⽅标配 19点前付款当天发货&quot;,&quot;price&quot;:10498.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;1.29kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10021130510120.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;科⼤讯⻜机器⼈ 阿尔法蛋A10智能机器⼈ 专业教育⼈⼯智能编程机器⼈学习机智能可编程 ⽩⾊&quot;,&quot;price&quot;:1099.00,&quot;brand&quot;:&quot;科⼤讯⻜&quot;,&quot;weight&quot;:&quot;1.7kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100005324258.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;robosen乐森机器⼈六⼀⼉童节礼物⾃营孩⼦玩具星际特⼯智能编程机器⼈⼉童语⾳控制陪伴益智变形机器⼈&quot;,&quot;price&quot;:2499.00,&quot;brand&quot;:&quot;senpowerT9-X&quot;,&quot;weight&quot;:&quot;3.01kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100006740372.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;优必选（UBTECH）悟空智能语⾳监控对话⼈形机器⼈⼉童教育陪伴早教学习机玩具&quot;,&quot;price&quot;:4999.00,&quot;brand&quot;:&quot;优必选悟空&quot;,&quot;weight&quot;:&quot;1.21kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100000722348.html&quot;&#125;</code></pre>

<h5 id="参考案例-2"><a href="#参考案例-2" class="headerlink" title="参考案例 2"></a>参考案例 2</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)启动filebeat</span>
<span class="token function">cat</span> <span class="token operator">></span> config-filebeat/02-log-to-es.yml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
filebeat.inputs:
    - type: log
      paths:
          - /tmp/shopping.json
      json.keys_under_root: true

output.logstash:
    hosts: ["10.0.0.101:8888"]
EOF</span>
./filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> config-filebeat/02-log-to-es.yml

<span class="token comment"># (2)启动logstash</span>
<span class="token function">cat</span> <span class="token operator">></span> conf-logstash/02-beats-to-es.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
input &#123;
    beats &#123;
   		port => 8888
    &#125;
&#125;
filter &#123;
    mutate &#123;
        remove_field => ["host","@timestamp","tags","log","agent","@version", "input","ecs"]
    &#125;
&#125;
output &#123;
	stdout &#123;&#125;
    elasticsearch &#123;
        hosts => ["10.0.0.101:9200","10.0.0.102:9200","10.0.0.103:9200"]
        index => "oldboyedu-linux80-shopping"
    &#125;
&#125;
EOF</span>

logstash <span class="token parameter variable">-rf</span> conf-logstash/02-beats-to-es.conf</code></pre>

<h2 id="索引模板"><a href="#索引模板" class="headerlink" title="索引模板"></a>索引模板</h2><h3 id="1-什么是索引模板"><a href="#1-什么是索引模板" class="headerlink" title="1.什么是索引模板"></a>1.什么是索引模板</h3><p>索引模板是创建索引的⼀种⽅式。<br>当数据写⼊指定索引时，如果该索引不存在，则根据索引名称匹配相应索引模板的话，会根据模板的配置⽽建⽴索引。<br>索引模板仅对新创建的索引⽣效，对已经创建的索引是没有任何作⽤的。<br>推荐阅读: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index-templates.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index-templates.html</a></p>
<h3 id="2-查看索引模板"><a href="#2-查看索引模板" class="headerlink" title="2.查看索引模板"></a>2.查看索引模板</h3><pre class="language-none"><code class="language-none">GET http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_template 					# 查看所有的索引模板
GET http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_template&#x2F;oldboyedu-linux80 	# 查看单个索引模板</code></pre>

<h3 id="3-创建-x2F-修改索引模板"><a href="#3-创建-x2F-修改索引模板" class="headerlink" title="3.创建&#x2F;修改索引模板"></a>3.创建&#x2F;修改索引模板</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/_template/oldboyedu-linux80
<span class="token punctuation">&#123;</span>
    <span class="token string">"aliases"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"DBA"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>,
        <span class="token string">"SRE"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>,
        <span class="token string">"K8S"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"index_patterns"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
   		<span class="token string">"oldboyedu-linux80*"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"number_of_shards"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
            <span class="token string">"number_of_replicas"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"properties"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"ip"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"access_time"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"date"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span> <span class="token builtin class-name">:</span><span class="token string">"text"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="4-删除索引模板"><a href="#4-删除索引模板" class="headerlink" title="4.删除索引模板"></a>4.删除索引模板</h3><pre class="language-none"><code class="language-none">DELETE http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_template&#x2F;oldboyedu-linux80</code></pre>

<h2 id="ES-的-DSL-语句查询-DBA-方向需要掌握"><a href="#ES-的-DSL-语句查询-DBA-方向需要掌握" class="headerlink" title="ES 的 DSL 语句查询 - DBA 方向需要掌握!"></a>ES 的 DSL 语句查询 - DBA 方向需要掌握!</h2><h3 id="1-什么是-DSL"><a href="#1-什么是-DSL" class="headerlink" title="1.什么是 DSL"></a>1.什么是 DSL</h3><p>Elasticsearch 提供了基于 JSON 的完整 Query DSL（Domain Specific Language，领域特定语⾔）来定义查询。</p>
<h3 id="2-全文检索-match-查询"><a href="#2-全文检索-match-查询" class="headerlink" title="2.全文检索 - match 查询"></a>2.全文检索 - match 查询</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span><span class="token string">"⼩苹华"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	查询品牌是<span class="token string">"⼩苹华"</span>的所有商品。背后的逻辑是会对中⽂进⾏分词。</code></pre>

<h3 id="3-完全匹配-match-phrase-查询"><a href="#3-完全匹配-match-phrase-查询" class="headerlink" title="3.完全匹配 - match_phrase 查询"></a>3.完全匹配 - match_phrase 查询</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span><span class="token string">"⼩苹华"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	查询品牌是<span class="token string">"⼩苹华"</span>的所有商品。背后的逻辑并不会对中⽂进⾏分词。</code></pre>

<h3 id="4-全量查询-match-all"><a href="#4-全量查询-match-all" class="headerlink" title="4.全量查询 - match_all"></a>4.全量查询 - match_all</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_all"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	请求体的内容可以不写，即默认就是发起了全量查询<span class="token punctuation">(</span>match_all<span class="token punctuation">)</span>。</code></pre>

<h3 id="5-分页查询-size-from"><a href="#5-分页查询-size-from" class="headerlink" title="5.分页查询 - size-from"></a>5.分页查询 - size-from</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_all"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">7</span>,
    <span class="token string">"from"</span><span class="token builtin class-name">:</span> <span class="token number">28</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    size:
        指定每⻚显示多少条数据，默认值为10.
    from:
        指定跳过数据偏移量的⼤⼩，默认值为0，即默认看第⼀⻚。
        查询指定⻚码的from值 <span class="token operator">=</span> <span class="token string">"(⻚码 - 1) * 每⻚数据⼤⼩(size)"</span>

温馨提示:
	⽣产环境中，不建议深度分⻚，百度的⻚码数量控制在76⻚左右。</code></pre>

<h3 id="6-查看“-source”对象的指定字段"><a href="#6-查看“-source”对象的指定字段" class="headerlink" title="6.查看“_source”对象的指定字段"></a>6.查看“_source”对象的指定字段</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_all"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">7</span>,
    <span class="token string">"from"</span><span class="token builtin class-name">:</span> <span class="token number">28</span>,
    <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"brand"</span>,<span class="token string">"price"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    _source:
        ⽤于指定查看<span class="token string">"_source"</span>对象的指定字段。</code></pre>

<h3 id="7-查询包含指定字段的文档-exists"><a href="#7-查询包含指定字段的文档-exists" class="headerlink" title="7.查询包含指定字段的文档 - exists"></a>7.查询包含指定字段的文档 - exists</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"exists"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"hobby"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    exists
        判断某个字段是否存在，若存在则返回该⽂档，若不存在，则不返回⽂档。</code></pre>

<h3 id="8-语法高亮-hightlight"><a href="#8-语法高亮-hightlight" class="headerlink" title="8.语法高亮 - hightlight"></a>8.语法高亮 - hightlight</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"苹果"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"highlight"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"pre_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"post_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;/h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    highlight:	设置⾼亮。
    fields:		指定对哪个字段进⾏语法⾼亮。
    pre_tags:	⾃定义⾼亮的前缀标签。
    post_tags	⾃定义⾼亮的后缀标签。</code></pre>

<h3 id="9-基于字段进行排序-sort"><a href="#9-基于字段进行排序-sort" class="headerlink" title="9.基于字段进行排序 - sort"></a>9.基于字段进行排序 - sort</h3><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;: &#123;
        &quot;match_phrase&quot;: &#123;
            &quot;brand&quot;: &quot;苹果&quot;
        &#125;
    &#125;,
    &quot;sort&quot;: &#123;
        &quot;price&quot; :&#123;
            &quot;order&quot;: &quot;asc&quot;
        &#125;
    &#125;
&#125;

相关字段说明:
    sort:	基于指定的字段进⾏排序。此处为指定的是&quot;price&quot;
    order:	指定排序的规则，分为&quot;asc&quot;(升序)和&quot;desc&quot;(降序)。</code></pre>

<h3 id="10-多条件查询-bool"><a href="#10-多条件查询-bool" class="headerlink" title="10.多条件查询 - bool"></a>10.多条件查询 - bool</h3><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;:&#123;
        &quot;bool&quot; :&#123;
            &quot;must&quot;: [
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot; :&quot; 苹果&quot;
                    &#125;
                &#125;,
                &#123;
                    &quot;match&quot;: &#123;
                        &quot;price&quot;: 5499
                    &#125;
                &#125;
			]
		&#125;
	&#125;
&#125;

POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;:&#123;
        &quot;bool&quot; :&#123;
            &quot;must_not&quot;: [
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot; :&quot; 苹果&quot;
                    &#125;
                &#125;,
                &#123;
                    &quot;match&quot;: &#123;
                        &quot;price&quot;: 3399
                    &#125;
                &#125;
            ]
        &#125;
    &#125;
&#125;

POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;: &#123;
        &quot;bool&quot;: &#123;
            &quot;should&quot;: [
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot;: &quot; 苹果&quot;
                    &#125;
                &#125;,
                &#123;
                    &quot;match&quot;: &#123;
                        &quot;price&quot;: 5499
                    &#125;
                &#125;,
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot;: &quot; ⼩⽶&quot;
                    &#125;
                &#125;
            ],
            &quot;minimum_should_match&quot;: 2
        &#125;
    &#125;
&#125;

温馨提示:
    bool:		可以匹配多个条件查询。其中有&quot;must&quot;，&quot;must_not&quot;,&quot;should&quot;。
    &quot;must&quot;		必须匹配的条件。
    &quot;must_not&quot;	必须不匹配的条件，即和must相反。
    &quot;should&quot;	不是必要条件，满⾜其中之⼀即可，可以使⽤&quot;minimum_should_match&quot;来限制满⾜要求的条件数量。</code></pre>

<h3 id="11-范围查询-filter"><a href="#11-范围查询-filter" class="headerlink" title="11.范围查询 - filter"></a>11.范围查询 - filter</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">" 苹果"</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token punctuation">]</span>,
			<span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"price"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"gt"</span><span class="token builtin class-name">:</span> <span class="token number">5000</span>,
                        <span class="token string">"lt"</span><span class="token builtin class-name">:</span> <span class="token number">8000</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关字段说明:
    filter	过滤数据。
    range：	基于范围进⾏过滤，此处为基于的是<span class="token string">"price"</span>进⾏过滤。
    常⻅的操作符如下:
        gt:		⼤于。
        lt:		⼩于。
        gte:	⼤于等于。
        lte:	⼩于等于。</code></pre>

<h3 id="12-精确匹配多个值-terms"><a href="#12-精确匹配多个值-terms" class="headerlink" title="12.精确匹配多个值 - terms"></a>12.精确匹配多个值 - terms</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"price"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token number">4699</span>,
                <span class="token number">299</span>,
                <span class="token number">4066</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="13-多词搜索-了解即可"><a href="#13-多词搜索-了解即可" class="headerlink" title="13.多词搜索 - 了解即可"></a>13.多词搜索 - 了解即可</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"显示器曲⾯"</span>,
                            <span class="token string">"operator"</span><span class="token builtin class-name">:</span> <span class="token string">"and"</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
        	<span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"highlight"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"pre_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"post_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;/h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	当我们将<span class="token string">"operator"</span>设置为<span class="token string">"and"</span>则⽂档必须包含<span class="token string">"query"</span>中的所有词汇，<span class="token string">"operator"</span>的默认值为<span class="token string">"or"</span>。</code></pre>

<h3 id="14-权重案例-了解即可"><a href="#14-权重案例-了解即可" class="headerlink" title="14.权重案例 - 了解即可"></a>14.权重案例 - 了解即可</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"⼩苹华"</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"should"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"防⽔"</span>,
                            <span class="token string">"boost"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>,
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"⿊⾊"</span>,
                            <span class="token string">"boost"</span><span class="token builtin class-name">:</span> <span class="token number">10</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"highlight"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>,
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	修改<span class="token string">"boost"</span>字段的值来提升相应权重。</code></pre>

<h3 id="15-聚合查询-了解即可"><a href="#15-聚合查询-了解即可" class="headerlink" title="15.聚合查询 - 了解即可"></a>15.聚合查询 - 了解即可</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计每个品牌的数量。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_brand_group"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"terms"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"brand.keyword"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>
POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计苹果商品中最贵的。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"苹果"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_max_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"max"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计华为商品中最便宜的。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"华为"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_min_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"min"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计⼩⽶商品的品均架构。</span>
<span class="token punctuation">&#123;</span>
<span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"⼩⽶"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_avg_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"avg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计⻢下⼩⽶所有商品的价格。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"⼩⽶"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_sum_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"sum"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="ES-集群迁移"><a href="#ES-集群迁移" class="headerlink" title="ES 集群迁移"></a>ES 集群迁移</h2><h3 id="1-部署-ES6-分布式集群"><a href="#1-部署-ES6-分布式集群" class="headerlink" title="1.部署 ES6 分布式集群"></a>1.部署 ES6 分布式集群</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)下载ES 6的软件包</span>
<span class="token function">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.23.tar.gz

<span class="token comment"># (2)解压软件包并创建数据⽬录和⽇志⽬录</span>
<span class="token function">tar</span> xf elasticsearch-6.8.23.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token function">install</span> <span class="token parameter variable">-d</span> /oldboyedu/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span>/es6 <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyedu
<span class="token function">chown</span> oldboyedu:oldboyedu <span class="token parameter variable">-R</span> /oldboyedu/softwares/elasticsearch-6.8.23/

<span class="token comment"># (3)修改配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/elasticsearch-6.8.23/config/elasticsearch.yml
<span class="token punctuation">..</span><span class="token punctuation">..</span>.
cluster.name: oldboyedu-linux80-es6
node.name: elk101
path.data: /oldboyedu/data/es6
path.logs: /oldboyedu/logs/es6
network.host: <span class="token number">0.0</span>.0.0
http.port: <span class="token number">19200</span>
transport.tcp.port: <span class="token number">19300</span>
discovery.zen.ping.unicast.hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span>,<span class="token string">"10.0.0.102"</span>,<span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>
discovery.zen.minimum_master_nodes: <span class="token number">2</span>

<span class="token comment"># (4)同步环境到其他节点</span>
data_rsync.sh /oldboyedu/softwares/elasticsearch-6.8.23

<span class="token comment"># (5)其他节点修改⼀下⼏个参数即可修改各节点的"node.name"名称即可。</span>

<span class="token comment"># (6)编写启动脚本</span>
<span class="token function">cat</span> <span class="token operator">></span> /etc/sysconfig/jdk <span class="token operator">&lt;&lt;</span><span class="token string">EOF
JAVA_HOME=/oldboyedu/softwares/jdk
EOF</span>
<span class="token function">cat</span> <span class="token operator">></span> /usr/lib/systemd/system/es68.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Oldboyedu linux80 ELK
After=network.target

[Service]
Type=forking
EnvironmentFile=/etc/sysconfig/jdk
ExecStart=/oldboyedu/softwares/elasticsearch-6.8.23/bin/elasticsearch -d
Restart=no
User=oldboyedu
Group=oldboyedu
LimitNOFILE=131070

[Install]
WantedBy=multi-user.target
EOF</span>

systemctl daemon-reload

<span class="token comment"># (7)启动服务</span>
systemctl start es68</code></pre>

<h3 id="2-基于-reindex-的-API-迁移"><a href="#2-基于-reindex-的-API-迁移" class="headerlink" title="2.基于_reindex 的 API 迁移"></a>2.基于_reindex 的 API 迁移</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/_reindex
<span class="token punctuation">&#123;</span>
    <span class="token string">"source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"dest"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping-new"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 不同⼀个集群迁移索引</span>
POST http://10.0.0.103:9200/_reindex
<span class="token punctuation">&#123;</span>
    <span class="token string">"source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping"</span>,
        <span class="token string">"remote"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"host"</span><span class="token builtin class-name">:</span> <span class="token string">"http://10.0.0.101:19200"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"Dell"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"dest"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping-new-22222222222"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>不同集群迁移时，需要修改9200端⼝对应的ES7的elasticsearch.yml配置⽂件，添加如下内容，并重启集群。
        reindex.remote.whitelist: <span class="token string">"*:*"</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>跨集群迁移时，可以使⽤DSL语句来对源集群的数据进⾏过滤，⽐如上⾯的<span class="token string">"query"</span>语句。
推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-reindex.html</code></pre>

<h3 id="3-基于-logstash-实现索引跨集群迁移"><a href="#3-基于-logstash-实现索引跨集群迁移" class="headerlink" title="3.基于 logstash 实现索引跨集群迁移"></a>3.基于 logstash 实现索引跨集群迁移</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> conf-logstash/03-es-to-es.conf
input <span class="token punctuation">&#123;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-shopping"</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101:19200"</span>
        query <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'&#123; "query": &#123; "match_phrase": &#123; "brand": "dell" &#125; &#125;&#125;'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-shopping-6666666666666666666"</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101:9200"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> conf-logstash/03-es-to-es.conf

温馨提示:
    对于低版本的数据迁移到⾼版本时，⽐如从ES5迁移到ES7，应该注意不同点:
        <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>默认的分⽚数量和副本数量<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>默认的⽂档类型是否相同,尤其是在ES7版本中移除了type类型，仅保留了<span class="token string">"_doc"</span>这⼀种内置类型<span class="token punctuation">;</span></code></pre>

<h2 id="ES-集群常用的-API"><a href="#ES-集群常用的-API" class="headerlink" title="ES 集群常用的 API"></a>ES 集群常用的 API</h2><h3 id="1-ES-集群健康状态-API（heath）"><a href="#1-ES-集群健康状态-API（heath）" class="headerlink" title="1.ES 集群健康状态 API（heath）"></a>1.ES 集群健康状态 API（heath）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667450229695.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)安装jq⼯具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> jq

<span class="token comment"># (2)测试取数据</span>
<span class="token function">curl</span> http://10.0.0.103:9200/_cluster/health <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">|</span> jq
<span class="token function">curl</span> http://10.0.0.103:9200/_cluster/health <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">|</span> jq .status
<span class="token function">curl</span> http://10.0.0.103:9200/_cluster/health <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">|</span> jq
.active_shards_percent_as_number


相关参数说明:
    cluster_name
    	集群的名称。
    status
        集群的健康状态，基于其主分⽚和副本分⽚的状态。
        ES集群有以下三种状态:
            green	所有分⽚都已分配。
            yellow	所有主分⽚都已分配，但⼀个或多个副本分⽚未分配。如果集群中的某个节点发⽣故障，则在修复该节点之前，某些数据可能不可⽤。
            red		⼀个或多个主分⽚未分配，因此某些数据不可⽤。这可能会在集群启动期间短暂发⽣，因为分配了主分⽚。
    timed_out
    	是否在参数false指定的时间段内返回响应（默认情况下30秒）。
    number_of_nodes
   		集群内的节点数。
    number_of_data_nodes
        作为专⽤数据节点的节点数。
    active_primary_shards
        可⽤主分⽚的数量。
    active_shards
        可⽤主分⽚和副本分⽚的总数。
    relocating_shards
        正在重定位的分⽚数。
    initializing_shards
        正在初始化的分⽚数。
    unassigned_shards
        未分配的分⽚数。
    delayed_unassigned_shards
        分配因超时设置⽽延迟的分⽚数。
    number_of_pending_tasks
        尚未执⾏的集群级别更改的数量。
    number_of_in_flight_fetch
        未完成的提取次数。
    task_max_waiting_in_queue_millis
        ⾃最早启动的任务等待执⾏以来的时间（以毫秒为单位）。
    active_shards_percent_as_number
        集群中活动分⽚的⽐率，以百分⽐表示。</code></pre>

<h3 id="2-ES-集群的设置及优先级（settings）"><a href="#2-ES-集群的设置及优先级（settings）" class="headerlink" title="2.ES 集群的设置及优先级（settings）"></a>2.ES 集群的设置及优先级（settings）</h3><pre class="language-bash" data-language="bash"><code class="language-bash">如果您使⽤多种⽅法配置相同的设置，Elasticsearch 会按以下优先顺序应⽤这些设置：
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>Transient setting<span class="token punctuation">(</span>临时配置，集群重启后失效<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>Persistent setting<span class="token punctuation">(</span>持久化配置，集群重启后依旧⽣效<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>elasticsearch.yml setting<span class="token punctuation">(</span>配置⽂件<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>Default setting value<span class="token punctuation">(</span>默认设置值<span class="token punctuation">)</span>

<span class="token comment"># (1)查询集群的所有配置信息</span>
GET http://10.0.0.103:9200/_cluster/settings?include_defaults<span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">flat_settings</span><span class="token operator">=</span>true

<span class="token comment"># (2)修改集群的配置信息</span>
PUT http://10.0.0.103:9200/_cluster/settings
<span class="token punctuation">&#123;</span>
    <span class="token string">"transient"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"cluster.routing.allocation.enable"</span><span class="token builtin class-name">:</span> <span class="token string">"none"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
<span class="token string">"cluster.routing.allocation.enable"</span><span class="token builtin class-name">:</span>
    <span class="token string">"all"</span>			允许所有分⽚类型进⾏分配。
    <span class="token string">"primaries"</span>		仅允许分配主分⽚。
    <span class="token string">"new_primaries"</span>	仅允许新创建索引分配主分⽚。
    <span class="token string">"none"</span>			不允许分配任何类型的分配。

参考链接:
https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-get-settings.html
https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-update-settings.html</code></pre>

<h3 id="3-集群状态-API（state）"><a href="#3-集群状态-API（state）" class="headerlink" title="3.集群状态 API（state）"></a>3.集群状态 API（state）</h3><pre class="language-bash" data-language="bash"><code class="language-bash">集群状态是⼀种内部数据结构，它跟踪每个节点所需的各种信息，包括：
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>集群中其他节点的身份和属性
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>集群范围的设置
    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>索引元数据，包括每个索引的映射和设置
    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>集群中每个分⽚副本的位置和状态

<span class="token comment"># (1)查看集群的状态信息</span>
GET http://10.0.0.103:9200/_cluster/state

<span class="token comment"># (2)只查看节点信息。</span>
GET http://10.0.0.103:9200/_cluster/state/nodes

<span class="token comment"># (3)查看nodes,version,routing_table这些信息，并且查看以"oldboyedu*"开头的所有索引</span>
http://10.0.0.103:9200/_cluster/state/nodes,version,routing_table/oldboyedu*


推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-state.html</code></pre>

<h3 id="4-集群统计-API（stats）"><a href="#4-集群统计-API（stats）" class="headerlink" title="4.集群统计 API（stats）"></a>4.集群统计 API（stats）</h3><pre class="language-bash" data-language="bash"><code class="language-bash">Cluster Stats API 允许从集群范围的⻆度检索统计信息。返回基本索引指标（分⽚数量、存储⼤⼩、内存使⽤情况）和有关构成集群的当前节点的信息（数量、⻆⾊、操作系统、jvm 版本、内存使⽤情况、cpu 和已安装的插件）。

<span class="token comment"># (1)查看统计信息</span>
GET http://10.0.0.103:9200/_cluster/stats


推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-stats.html</code></pre>

<h3 id="5-查看集群的分片分配情况（allocation）"><a href="#5-查看集群的分片分配情况（allocation）" class="headerlink" title="5.查看集群的分片分配情况（allocation）"></a>5.查看集群的分片分配情况（allocation）</h3><p>集群分配解释 API 的⽬的是为集群中的分⽚分配提供解释。</p>
<p>对于未分配的分⽚，解释 API 提供了有关未分配分⽚的原因的解释。</p>
<p>对于分配的分⽚，解释 API 解释了为什么分⽚保留在其当前节点上并且没有移动或重新平衡到另⼀个节点。</p>
<p>当您尝试诊断分⽚未分配的原因或分⽚继续保留在其当前节点上的原因时，此 API 可能⾮常有⽤，⽽您可能会对此有所期待。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)分析teacher索引的0号分⽚未分配的原因。</span>
GET http://10.0.0.101:9200/_cluster/allocation/explain
<span class="token punctuation">&#123;</span>
    <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"teacher"</span>,
    <span class="token string">"shard"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
    <span class="token string">"primary"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span>

推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-allocation-explain.html</code></pre>

<h3 id="6-集群分片重路由-API（reroute）"><a href="#6-集群分片重路由-API（reroute）" class="headerlink" title="6.集群分片重路由 API（reroute）"></a>6.集群分片重路由 API（reroute）</h3><p>reroute 命令允许⼿动更改集群中各个分⽚的分配。</p>
<p>例如，可以将分⽚从⼀个节点显式移动到另⼀个节点，可以取消分配，并且可以将未分配的分⽚显式分配给特定节点。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/_cluster/reroute	<span class="token comment"># 将"teacher"索引的0号分⽚从elk102节点移动到elk101节点。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"commands"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"move"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"teacher"</span>,
                <span class="token string">"shard"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
                <span class="token string">"from_node"</span><span class="token builtin class-name">:</span> <span class="token string">"elk102.oldboyedu.com"</span>,
                <span class="token string">"to_node"</span><span class="token builtin class-name">:</span> <span class="token string">"elk101.oldboyedu.com"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_cluster/reroute	<span class="token comment"># 取消副本分⽚的分配，其副本会重新初始化分配。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"commands"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"cancel"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"teacher"</span>,
                <span class="token string">"shard"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
                <span class="token string">"node"</span><span class="token builtin class-name">:</span> <span class="token string">"elk101.oldboyedu.com"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>推荐阅读: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-reroute.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-reroute.html</a></p>
<h3 id="7-今日作业-1"><a href="#7-今日作业-1" class="headerlink" title="7.今日作业"></a>7.今日作业</h3><pre class="language-none"><code class="language-none">(1)完成课堂的所有练习;

进阶作业:
(2)使⽤zabbix健康ES集群的健康状态，包含以下2个指标:
    curl http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_cluster&#x2F;health 2&gt;&#x2F;dev&#x2F;null| jq .status
    curl http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_cluster&#x2F;health 2&gt;&#x2F;dev&#x2F;null| jq .active_shards_percent_as_number</code></pre>

<h2 id="ES-集群理论篇"><a href="#ES-集群理论篇" class="headerlink" title="ES 集群理论篇"></a>ES 集群理论篇</h2><h3 id="1-倒排索引"><a href="#1-倒排索引" class="headerlink" title="1.倒排索引"></a>1.倒排索引</h3><p>⾯试题: 分⽚底层时如何⼯作的？</p>
<p>答: 分⽚底层对应的是⼀个 Lucene 库，⽽ Lucene 底层使⽤倒排索引技术实现。</p>
<h4 id="正排索引-正向索引"><a href="#正排索引-正向索引" class="headerlink" title="正排索引(正向索引)"></a>正排索引(正向索引)</h4><p>我们 MySQL 为例，⽤ id 字段存储博客⽂章的编号，⽤ context 存储⽂件的内容。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> blog <span class="token punctuation">(</span>id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> contextTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INDEX</span> blog <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'I am Jason Yin, I love Linux ...'</span><span class="token punctuation">)</span></code></pre>

<p>此时，如果我们查询⽂章内容包含”Jason Yin”的词汇的时候，就⽐较麻烦了，因为要进⾏全表扫描。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> blog <span class="token keyword">WHERE</span> context <span class="token operator">LIKE</span> <span class="token string">'Jason Yin'</span><span class="token punctuation">;</span></code></pre>

<h4 id="倒排索引-反向索引"><a href="#倒排索引-反向索引" class="headerlink" title="倒排索引(反向索引)"></a>倒排索引(反向索引)</h4><p>ES 使⽤⼀种称为”倒排索引”的结构，它适⽤于快速的全⽂检索。<br>倒排索引中有以下三个专业术语:</p>
<p>1、词条:<br>指的是最⼩的存储和查询单元，换句话说，指的是您想要查询的关键字(词)。<br>对应英⽂⽽⾔通常指的是⼀个单词，⽽对于中⽂⽽⾔，对应的是⼀个词组。</p>
<p>2、词典(字典):<br>它是词条的集合，底层通常基于”Btree+”和”HASHMap”实现。</p>
<p>3、倒排表:<br>记录了词条出现在什么位置，出现的频率是什么。<br>倒排表中的每⼀条记录我们称为倒排项。</p>
<p>倒排索引的搜索过程:</p>
<ol>
<li>⾸先根据⽤户需要查询的词条进⾏分词后，将分词后的各个词条字典进⾏匹配，验证词条在词典中是否存在;</li>
<li>如果上⼀步搜索结果发现词条不在字典中，则结束本次搜索，如果在词典中，就需要去查看倒排表中的记录(倒排项);</li>
<li>根据倒排表中记录的倒排项来定位数据在哪个⽂档中存在，⽽后根据这些⽂档的”_id”来获取指定的数据;</li>
</ol>
<p>综上所述，假设有 10 亿篇⽂章，对于 mysql 不创建索引的情况下，会进⾏全表扫描搜索”JasonYin”。⽽对于 ES ⽽⾔，其只需要将倒排表中返回的 id 进⾏扫描即可，⽽⽆须进⾏全量查询。</p>
<h3 id="2-集群角色"><a href="#2-集群角色" class="headerlink" title="2.集群角色"></a>2.集群角色</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457339777.png"></p>
<pre class="language-none"><code class="language-none">⻆⾊说明:
    c：	Cold data
    d：	data node
    f：	frozen node
    h：	hot node
    i：	ingest node
    l：	machine learning node
    m：	master eligible node
    r：	remote cluster client node
    s：	content node
    t：	transform node
    v：	voting-only node
    w：	warm node
    -：	coordinating node only

常⽤的⻆⾊说明:
    data node:	指的是存储数据的节点。
    			node.data: true
    master node:	控制ES集群，并维护集群的状态(cluster state，包括节点信息，索引信息等，ES集群每个节点都有⼀份)。
    				node.master: true
    coordinating:	协调节点可以处理请求的节点，ES集群所有的节点均为协调节点，该⻆⾊⽆法取消。</code></pre>

<h3 id="3-文档的写流程"><a href="#3-文档的写流程" class="headerlink" title="3.文档的写流程"></a>3.文档的写流程</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457504851.png"></p>
<h3 id="4-单个文档的读流程"><a href="#4-单个文档的读流程" class="headerlink" title="4.单个文档的读流程"></a>4.单个文档的读流程</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457540842.png"></p>
<h3 id="5-ES-底层存储原理剖析"><a href="#5-ES-底层存储原理剖析" class="headerlink" title="5.ES 底层存储原理剖析"></a>5.ES 底层存储原理剖析</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457568386.png"></p>
<p>事务⽇志存储在哪⾥?</p>
<pre class="language-none"><code class="language-none">在索引分⽚⽬录下，取名⽅式如下:
	translog-N.tlog:	真正的⽇志⽂件，N表示generation（代）的意思，通过它跟索引⽂件关联
	tranlog.ckp:		⽇志的元数据⽂件，⻓度总是20个字节，记录3个信息：偏移量 &amp; 事务操作数量 &amp; 当前代</code></pre>

<p>什么时候删事务⽇志？</p>
<pre class="language-none"><code class="language-none">在flush的时候，translog⽂件会被清空。实际的过程是先删掉⽼⽂件，再创建⼀个新⽂件，取名时，序号加1，⽐如图2中，flush后你只会看到 translog-2.tlog，原来的translog-1.tlog已被删除。</code></pre>

<p>为什么要删？</p>
<pre class="language-none"><code class="language-none">因为数据修改已经写⼊磁盘了，之前的旧的⽇志就⽆⽤武之地了，留着只能⽩嫖存储空间。</code></pre>

<h3 id="6-乐观锁机制-了解即可"><a href="#6-乐观锁机制-了解即可" class="headerlink" title="6.乐观锁机制 - 了解即可"></a>6.乐观锁机制 - 了解即可</h3><p>两种⽅法通常被⽤来解决并发更新时变更不会丢失的解决⽅案:</p>
<p><strong>1、悲观并发控制</strong></p>
<p>这种⽅法被关系型数据库⼴泛使⽤，它假定有变更冲突可能发⽣，因此阻塞访问资源以防⽌冲突。⼀个典型的例⼦是修改⼀⾏数据之前像将其锁住，确保只有获得锁的线程能够对这⾏数据进⾏修改。</p>
<p><strong>2、乐观锁并发控制</strong></p>
<p>ES 中使⽤的这种⽅法假设冲突是不可能发⽣的，并且不会阻塞正在尝试的操作。然⽽，如果源数据在读写当中被修改，更新将会失败。应⽤程序接下来该如果解决冲突。例如，可以重试更新，使⽤新的数据，或者将相关情况报告给⽤户。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)创建⽂档</span>
PUT http://10.0.0.103:9200/oldboyedu_student/_doc/10001
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王岩"</span>,
    <span class="token string">"age"</span>:25,
    <span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"苍⽼师"</span>,<span class="token string">"⽼男孩"</span>,<span class="token string">"欧美"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># (2)模拟事物1修改</span>
POST http://10.0.0.103:9200/oldboyedu_student/_doc/10001/_update?
<span class="token assign-left variable">if_seq_no</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span><span class="token assign-left variable">if_primary_term</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"⽇韩"</span>,
            <span class="token string">"国内"</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># (3)模拟事物2修改(如果上⾯的事物执⾏成功，则本事物执⾏失败，因为"_seq_no"发⽣变化)</span>
POST http://10.0.0.103:9200/oldboyedu_student/_doc/10001/_update?
<span class="token assign-left variable">if_seq_no</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span><span class="token assign-left variable">if_primary_term</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"欧美"</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 扩展:(基于扩展的version版本来控制)</span>
POST http://10.0.0.103:9200/oldboyedu_student/_doc/10001?version<span class="token operator">=</span><span class="token number">10</span><span class="token operator">&amp;</span><span class="token assign-left variable">version_type</span><span class="token operator">=</span>external
<span class="token punctuation">&#123;</span>
	<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"⽇韩"</span>,
        <span class="token string">"国内"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="python-操作-ES-集群-API-实战"><a href="#python-操作-ES-集群-API-实战" class="headerlink" title="python 操作 ES 集群 API 实战"></a>python 操作 ES 集群 API 实战</h2><h3 id="1-创建索引"><a href="#1-创建索引" class="headerlink" title="1.创建索引"></a>1.创建索引</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
msg_body <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"settings"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"number_of_replicas"</span><span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
            <span class="token string">"number_of_shards"</span><span class="token punctuation">:</span> <span class="token string">"5"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"mappings"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"ip"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"long"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"keyword"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"aliases"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu-elstaicstack-linux80-python"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">"oldboyedu-linux80-python"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>msg_body<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="2-写⼊单个⽂档"><a href="#2-写⼊单个⽂档" class="headerlink" title="2.写⼊单个⽂档"></a>2.写⼊单个⽂档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 写⼊单个⽂档</span>
msg_body <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Jason Yin"</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"120.53.104.136"</span><span class="token punctuation">,</span>
    <span class="token string">"blog"</span><span class="token punctuation">:</span> <span class="token string">"https://blog.yinzhengjie.com/"</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"k8s"</span><span class="token punctuation">,</span> <span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"elk"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"yinzhengjie@oldboyedu.com"</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">10086</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>index<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> doc_type<span class="token operator">=</span><span class="token string">"_doc"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>msg_body<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="3-写入多个文档"><a href="#3-写入多个文档" class="headerlink" title="3.写入多个文档"></a>3.写入多个文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch
<span class="token keyword">from</span> elasticsearch<span class="token punctuation">.</span>helpers <span class="token keyword">import</span> bulk

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 批量写⼊多个⽂档</span>
doc2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">10010</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"⽼男孩"</span><span class="token punctuation">,</span>
    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">45</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"下棋"</span><span class="token punctuation">,</span> <span class="token string">"抖⾳"</span><span class="token punctuation">,</span> <span class="token string">"思想课"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"10.0.0.101"</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"oldboy@oldboyedu.com"</span>
<span class="token punctuation">&#125;</span>
doc3 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">10011</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"李导"</span><span class="token punctuation">,</span>
    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"三剑客"</span><span class="token punctuation">,</span> <span class="token string">"打枪"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"lidao@oldboyedu.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"10.0.0.201"</span>
<span class="token punctuation">&#125;</span>
doc4 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">100012</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"赵嘉欣"</span><span class="token punctuation">,</span>
    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"⽇韩"</span><span class="token punctuation">,</span> <span class="token string">"⼩说"</span><span class="token punctuation">,</span> <span class="token string">"王岩"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"zhaojiaxin@oldboyedu.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"10.0.0.222"</span>
<span class="token punctuation">&#125;</span>
many_doc <span class="token operator">=</span> <span class="token punctuation">[</span>doc2<span class="token punctuation">,</span> doc3<span class="token punctuation">,</span> doc4<span class="token punctuation">]</span>
write_number<span class="token punctuation">,</span> _ <span class="token operator">=</span> bulk<span class="token punctuation">(</span>es<span class="token punctuation">,</span> many_doc<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>write_number<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="4-全量查询"><a href="#4-全量查询" class="headerlink" title="4.全量查询"></a>4.全量查询</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 全量查询</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hobby"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>

<h3 id="5-查看多个文档"><a href="#5-查看多个文档" class="headerlink" title="5.查看多个文档"></a>5.查看多个文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 获取多个⽂档</span>
doc1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'ids'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"5gIk24AB2f3QZVpX1AxN"</span><span class="token punctuation">,</span> <span class="token string">"5AIk24AB2f3QZVpX1AxN"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
res <span class="token operator">=</span> es<span class="token punctuation">.</span>mget<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>doc1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">'docs'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="6-DSL-查询"><a href="#6-DSL-查询" class="headerlink" title="6.DSL 查询"></a>6.DSL 查询</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># DSL语句查询</span>
dsl <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token string">"王岩"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># DSL语句查询</span>
<span class="token comment"># dsl = &#123;</span>
<span class="token comment">#     "query": &#123;</span>
<span class="token comment">#         "bool": &#123;</span>
<span class="token comment">#             "should": [</span>
<span class="token comment">#                 &#123;</span>
<span class="token comment">#                     "match": &#123;</span>
<span class="token comment">#                         "type": "pets"</span>
<span class="token comment">#                     &#125;</span>
<span class="token comment">#                 &#125;,</span>
<span class="token comment">#                 &#123;</span>
<span class="token comment">#                     "match": &#123;</span>
<span class="token comment">#                         "type": "lunxury"</span>
<span class="token comment">#                     &#125;</span>
<span class="token comment">#                 &#125;</span>
<span class="token comment">#             ],</span>
<span class="token comment">#             "minimum_should_match": 1,</span>
<span class="token comment">#             "filter": &#123;</span>
<span class="token comment">#                 "range": &#123;</span>
<span class="token comment">#                     "price": &#123;</span>
<span class="token comment">#                         "gt": 1500,</span>
<span class="token comment">#                         "lt": 2500</span>
<span class="token comment">#                     &#125;</span>
<span class="token comment">#                 &#125;</span>
<span class="token comment">#             &#125;</span>
<span class="token comment">#         &#125;</span>
<span class="token comment">#     &#125;,</span>
<span class="token comment">#     "sort": &#123;</span>
<span class="token comment">#         "price": &#123;</span>
<span class="token comment">#             "order": "desc"</span>
<span class="token comment">#         &#125;</span>
<span class="token comment">#     &#125;,</span>
<span class="token comment">#     "_source": [</span>
<span class="token comment">#         "title",</span>
<span class="token comment">#         "price",</span>
<span class="token comment">#         "producer"</span>
<span class="token comment">#     ]</span>
<span class="token comment"># &#125;</span>

res <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"shopping"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>dsl<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
res <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>dsl<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="7-查看索引是否存在"><a href="#7-查看索引是否存在" class="headerlink" title="7.查看索引是否存在"></a>7.查看索引是否存在</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 判断索引是否存在</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-shopping"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="8-修改文档"><a href="#8-修改文档" class="headerlink" title="8.修改文档"></a>8.修改文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
new_doc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">'doc'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'下棋'</span><span class="token punctuation">,</span> <span class="token string">'抖⾳'</span><span class="token punctuation">,</span> <span class="token string">'思想课'</span><span class="token punctuation">,</span> <span class="token string">"Linux运维"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">:</span> <span class="token string">'中华⼈⺠共和国北京市昌平区沙河镇⽼男孩教育'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token comment"># 更新⽂档</span>
res <span class="token operator">=</span> es<span class="token punctuation">.</span>update<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'5gIk24AB2f3QZVpX1AxN'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>new_doc<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="9-删除单个文档"><a href="#9-删除单个文档" class="headerlink" title="9.删除单个文档"></a>9.删除单个文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 删除单个⽂档</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"5gIk24AB2f3QZVpX1AxN"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="10-删除索引"><a href="#10-删除索引" class="headerlink" title="10.删除索引"></a>10.删除索引</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 删除索引</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h2 id="ES-集群加密的-Kibana-的-RABC-实战"><a href="#ES-集群加密的-Kibana-的-RABC-实战" class="headerlink" title="ES 集群加密的 Kibana 的 RABC 实战"></a>ES 集群加密的 Kibana 的 RABC 实战</h2><h3 id="1-基于-nginx-反向代理控制-kibana"><a href="#1-基于-nginx-反向代理控制-kibana" class="headerlink" title="1.基于 nginx 反向代理控制 kibana"></a>1.基于 nginx 反向代理控制 kibana</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667458865578.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)部署nginx服务	略，参考之前的笔记即可。</span>

<span class="token comment"># (2)编写nginx的配置⽂件</span>
<span class="token function">cat</span> <span class="token operator">></span> /etc/nginx/conf.d/kibana.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
server &#123;
	listen 80;
	server_name kibana.oldboyedu.com;
    location / &#123;
        proxy_pass http://10.0.0.103:5601<span class="token variable">$request_uri</span>;
        auth_basic "oldboyedu kibana web!";
        auth_basic_user_file conf/htpasswd;
    &#125;
&#125;
EOF</span>

<span class="token comment"># (3)创建账号⽂件</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /etc/nginx/conf
htpasswd <span class="token parameter variable">-c</span> <span class="token parameter variable">-b</span> /etc/nginx/conf/htpasswd admin oldboyedu

<span class="token comment"># (4)启动nginx服务</span>
nginx <span class="token parameter variable">-t</span>
systemcat restart nginx

<span class="token comment"># (5)访问nginx验证kibana访问	如下图所示。</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667458890281.png"></p>
<h3 id="2-配置-ES-集群-TLS-认证"><a href="#2-配置-ES-集群-TLS-认证" class="headerlink" title="2.配置 ES 集群 TLS 认证"></a>2.配置 ES 集群 TLS 认证</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667458780145.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)⽣成证书⽂件</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/es/
elasticsearch-certutil cert <span class="token parameter variable">-out</span> config/elastic-certificates.p12 <span class="token parameter variable">-pass</span> <span class="token string">""</span>

<span class="token comment"># (2)为证书⽂件修改属主和属组</span>
<span class="token function">chown</span> oldboyedu:oldboyedu config/elastic-certificates.p12

<span class="token comment"># (3)同步证书⽂件到其他节点</span>
data_rsync.sh <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/config/elastic-certificates.p12

<span class="token comment"># (4)修改ES集群的配置⽂件</span>
vim/oldboyedu/softwares/es/config/elasticsearch.yml
<span class="token punctuation">..</span>.
<span class="token comment"># 在最后⼀⾏添加以下内容</span>
xpack.security.enabled: <span class="token boolean">true</span>
xpack.security.transport.ssl.enabled: <span class="token boolean">true</span>
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: elastic-certificates.p12

<span class="token comment"># (5)同步ES配置⽂件到其他节点</span>
data_rsync.sh <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/config/elasticsearch.yml

<span class="token comment"># (6)所有节点重启ES集群</span>
systemctl restart es

<span class="token comment"># (7)⽣成随机密码(如上图所示)</span>
elasticsearch-setup-passwords auto

<span class="token comment"># (8)postman访问	如下图所示。</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667458804018.png"></p>
<h3 id="3-kibana-添加-ES-认证"><a href="#3-kibana-添加-ES-认证" class="headerlink" title="3.kibana 添加 ES 认证"></a>3.kibana 添加 ES 认证</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)修改kibana的配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/kibana/config/kibana.yml
<span class="token punctuation">..</span>.

elasticsearch.username: <span class="token string">"kibana_system"</span>
elasticsearch.password: <span class="token string">"NqJFTqDoVLmgX70bMc9t"</span>

<span class="token comment"># (2)重启kibana访问</span>
<span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"kibana"</span> oldboyedu

<span class="token comment"># (3)访问测试	如下图所示。</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667458744466.png"></p>
<h3 id="4-kibana-的-RBAC"><a href="#4-kibana-的-RBAC" class="headerlink" title="4.kibana 的 RBAC"></a>4.kibana 的 RBAC</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667458716770.png"></p>
<p>具体实操⻅视频。</p>
<h3 id="5-logstash-写入-ES-加密集群案例"><a href="#5-logstash-写入-ES-加密集群案例" class="headerlink" title="5.logstash 写入 ES 加密集群案例"></a>5.logstash 写入 ES 加密集群案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
	stdin <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-6666666666666666666"</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101:9200"</span>
        user <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"logstash-linux80"</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"123456"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示:<br>建议⼤家不要使⽤ elastic 管理员⽤户给 logstash 程序使⽤，⽽是创建⼀个普通⽤户，并为该⽤户细化权限。</p>
<h3 id="6-filebeat-写入-ES-加密集群案例"><a href="#6-filebeat-写入-ES-加密集群案例" class="headerlink" title="6.filebeat 写入 ES 加密集群案例"></a>6.filebeat 写入 ES 加密集群案例</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> stdin

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux80-stdin-%&#123;+yyyy.MM.dd&#125;"</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"filebeat-linux80"</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<p>温馨提示:<br>建议⼤家不要使⽤ elastic 管理员⽤户给 filebeat 程序使⽤，⽽是创建⼀个普通⽤户，并为该⽤户细化权限。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/postgresql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/postgresql/" class="post-title-link" itemprop="url">postgresql</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-02 11:05:11" itemprop="dateCreated datePublished" datetime="2021-03-02T11:05:11+08:00">2021-03-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/" itemprop="url" rel="index"><span itemprop="name">Jenkins与Gitlab</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/SonarQube/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/SonarQube/" class="post-title-link" itemprop="url">SonarQube</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-01 10:31:11" itemprop="dateCreated datePublished" datetime="2021-03-01T10:31:11+08:00">2021-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/" itemprop="url" rel="index"><span itemprop="name">Jenkins与Gitlab</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>SonarQube 是一个用于代码质量管理的开放平台，通过插件机制，SonarQube 可以集成不同的测试<br>工具，代码分析工具，以及持续集成工具，例如 Hudson&#x2F;Jenkins 等</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.sonarqube.org/">https://www.sonarqube.org/</a></p>
<h2 id="部署-SonarQube"><a href="#部署-SonarQube" class="headerlink" title="部署 SonarQube"></a>部署 SonarQube</h2><p>略…</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614681385194.png"></p>
<h2 id="jenkins-服务器部署扫描器-sonar-scanner"><a href="#jenkins-服务器部署扫描器-sonar-scanner" class="headerlink" title="jenkins 服务器部署扫描器 sonar-scanner"></a>jenkins 服务器部署扫描器 sonar-scanner</h2><p>官方文档： <a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/</a></p>
<h3 id="部署-sonar-scanner"><a href="#部署-sonar-scanner" class="headerlink" title="部署 sonar-scanner"></a>部署 sonar-scanner</h3><p>顾名思义，扫描器的具体工作就是扫描代码，sonarqube 通过调用扫描器 sonar-scanner 进行代码质量分析</p>
<p>下载地址： <a target="_blank" rel="noopener" href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$unzip</span> sonar-scanner-cli-4.6.0.2311.zip
<span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$mv</span> sonar-scanner-4.6.0.2311/ /usr/local/sonar-scanner
<span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$vim</span> /usr/local/sonar-scanner/conf/sonar-scanner.properties
<span class="token assign-left variable">sonar.host.url</span><span class="token operator">=</span>http://10.0.1.102:9000	<span class="token comment"># 指向sonarqube服务器的地址</span>
<span class="token assign-left variable">sonar.sourceEncoding</span><span class="token operator">=</span>UTF-8		<span class="token comment"># Default source code encoding</span></code></pre>

<h3 id="准备测试代码"><a href="#准备测试代码" class="headerlink" title="准备测试代码"></a>准备测试代码</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$unzip</span> sonar-examples-master.zip ^C
<span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$cd</span> sonar-examples-master/projects/languages/php/php-sonar-runner
<span class="token punctuation">[</span>root@jenkins php-sonar-runner<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">24</span>
drwxr-xr-x <span class="token number">3</span> root root <span class="token number">4096</span> Mar  <span class="token number">2</span> <span class="token number">23</span>:30 ./
drwxr-xr-x <span class="token number">4</span> root root <span class="token number">4096</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> <span class="token punctuation">..</span>/
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">453</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> README.md
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">331</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> sonar-project.properties
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">4096</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> src/
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">272</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> validation.txt
<span class="token punctuation">[</span>root@jenkins php-sonar-runner<span class="token punctuation">]</span><span class="token variable">$cat</span> sonar-project.properties 	<span class="token comment"># 确保有这个文件</span>
<span class="token comment"># Required metadata</span>
<span class="token assign-left variable">sonar.projectKey</span><span class="token operator">=</span>org.sonarqube:php-simple-sq-scanner
<span class="token assign-left variable">sonar.projectName</span><span class="token operator">=</span>PHP :: Simple Project :: SonarQube Scanner
<span class="token assign-left variable">sonar.projectVersion</span><span class="token operator">=</span><span class="token number">1.0</span>

<span class="token comment"># Comma-separated paths to directories with sources (required)</span>
<span class="token assign-left variable">sonar.sources</span><span class="token operator">=</span>src

<span class="token comment"># Language</span>
<span class="token assign-left variable">sonar.language</span><span class="token operator">=</span>php

<span class="token comment"># Encoding of the source files</span>
<span class="token assign-left variable">sonar.sourceEncoding</span><span class="token operator">=</span>UTF-8</code></pre>

<h3 id="在源代码目录执行扫描"><a href="#在源代码目录执行扫描" class="headerlink" title="在源代码目录执行扫描"></a>在源代码目录执行扫描</h3><p>在 sonar-project.properties 这个文件的目录下，执行 sonar-scanner 即可：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@jenkins php-sonar-runner<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">24</span>
drwxr-xr-x <span class="token number">3</span> root root <span class="token number">4096</span> Mar  <span class="token number">2</span> <span class="token number">23</span>:30 ./
drwxr-xr-x <span class="token number">4</span> root root <span class="token number">4096</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> <span class="token punctuation">..</span>/
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">453</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> README.md
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">331</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> sonar-project.properties
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">4096</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> src/	<span class="token comment"># 代码</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">272</span> Jul <span class="token number">25</span>  <span class="token number">2016</span> validation.txt
<span class="token punctuation">[</span>root@jenkins php-sonar-runner<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@jenkins php-sonar-runner<span class="token punctuation">]</span>$/usr/local/sonar-scanner/bin/sonar-scanner	<span class="token comment"># 测试</span>
INFO: Scanner configuration file: /usr/local/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: /usr/local/src/sonar-examples-master/projects/languages/php/php-sonar-runner/sonar-project.properties
INFO: SonarScanner <span class="token number">4.6</span>.0.2311
INFO: Java <span class="token number">11.0</span>.10 Oracle Corporation <span class="token punctuation">(</span><span class="token number">64</span>-bit<span class="token punctuation">)</span>
INFO: Linux <span class="token number">4.15</span>.0-136-generic amd64
INFO: User cache: /root/.sonar/cache
INFO: Scanner configuration file: /usr/local/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: /usr/local/src/sonar-examples-master/projects/languages/php/php-sonar-runner/sonar-project.properties
INFO: Analyzing on SonarQube server <span class="token number">7.9</span>.5
INFO: Default locale: <span class="token string">"en_US"</span>, <span class="token builtin class-name">source</span> code encoding: <span class="token string">"UTF-8"</span>
INFO: Load global settings
INFO: Load global settings <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>225ms
INFO: Server id: 3B6AA649-AXfye5RyEWrAjeeRmPxd
INFO: User cache: /root/.sonar/cache
INFO: Load/download plugins
INFO: Load plugins index
INFO: Load plugins index <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>126ms
INFO: Plugin <span class="token punctuation">[</span>l10nzh<span class="token punctuation">]</span> defines <span class="token string">'l10nen'</span> as base plugin. This metadata can be removed from manifest of l10n plugins since version <span class="token number">5.2</span>.
INFO: Load/download plugins <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>3633ms
INFO: Process project properties
INFO: Execute project builders
INFO: Execute project builders <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>18ms
INFO: Project key: org.sonarqube:php-simple-sq-scanner
INFO: Base dir: /usr/local/src/sonar-examples-master/projects/languages/php/php-sonar-runner
INFO: Working dir: /usr/local/src/sonar-examples-master/projects/languages/php/php-sonar-runner/.scannerwork
INFO: Load project settings <span class="token keyword">for</span> component key: <span class="token string">'org.sonarqube:php-simple-sq-scanner'</span>
INFO: Load quality profiles
INFO: Load quality profiles <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>293ms
INFO: Load active rules
INFO: Load active rules <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>3061ms
WARN: SCM provider autodetection failed. Please use <span class="token string">"sonar.scm.provider"</span> to define SCM of your project, or disable the SCM Sensor <span class="token keyword">in</span> the project settings.
INFO: Indexing files<span class="token punctuation">..</span>.
INFO: Project configuration:
INFO: Load project repositories
INFO: Load project repositories <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>19ms
INFO: <span class="token number">1</span> <span class="token function">file</span> indexed
INFO: Quality profile <span class="token keyword">for</span> php: Sonar way
INFO: ------------- Run sensors on module PHP :: Simple Project :: SonarQube Scanner
INFO: Load metrics repository
INFO: Load metrics repository <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>134ms
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by net.sf.cglib.core.ReflectUtils<span class="token variable">$1</span> <span class="token punctuation">(</span>file:/root/.sonar/cache/866bb1adbf016ea515620f1aaa15ec53/sonar-javascript-plugin.jar<span class="token punctuation">)</span> to method java.lang.ClassLoader.defineClass<span class="token punctuation">(</span>java.lang.String,byte<span class="token punctuation">[</span><span class="token punctuation">]</span>,int,int,java.security.ProtectionDomain<span class="token punctuation">)</span>
WARNING: Please consider reporting this to the maintainers of net.sf.cglib.core.ReflectUtils<span class="token variable">$1</span>
WARNING: Use --illegal-access<span class="token operator">=</span>warn to <span class="token builtin class-name">enable</span> warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied <span class="token keyword">in</span> a future release
INFO: Sensor JaCoCo XML Report Importer <span class="token punctuation">[</span>jacoco<span class="token punctuation">]</span>
INFO: Sensor JaCoCo XML Report Importer <span class="token punctuation">[</span>jacoco<span class="token punctuation">]</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>12ms
INFO: Sensor JavaXmlSensor <span class="token punctuation">[</span>java<span class="token punctuation">]</span>
INFO: Sensor JavaXmlSensor <span class="token punctuation">[</span>java<span class="token punctuation">]</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>7ms
INFO: Sensor HTML <span class="token punctuation">[</span>web<span class="token punctuation">]</span>
INFO: Sensor HTML <span class="token punctuation">[</span>web<span class="token punctuation">]</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>144ms
INFO: Sensor PHP sensor <span class="token punctuation">[</span>php<span class="token punctuation">]</span>
INFO: <span class="token number">1</span> <span class="token builtin class-name">source</span> files to be analyzed
INFO: <span class="token number">1</span>/1 <span class="token builtin class-name">source</span> files have been analyzed
INFO: No PHPUnit <span class="token builtin class-name">test</span> report provided <span class="token punctuation">(</span>see <span class="token string">'sonar.php.tests.reportPath'</span> property<span class="token punctuation">)</span>
INFO: No PHPUnit coverage reports provided <span class="token punctuation">(</span>see <span class="token string">'sonar.php.coverage.reportPaths'</span> property<span class="token punctuation">)</span>
INFO: Sensor PHP sensor <span class="token punctuation">[</span>php<span class="token punctuation">]</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>1652ms
INFO: Sensor Analyzer <span class="token keyword">for</span> <span class="token string">"php.ini"</span> files <span class="token punctuation">[</span>php<span class="token punctuation">]</span>
INFO: Sensor Analyzer <span class="token keyword">for</span> <span class="token string">"php.ini"</span> files <span class="token punctuation">[</span>php<span class="token punctuation">]</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>26ms
INFO: ------------- Run sensors on project
INFO: Sensor Zero Coverage Sensor
INFO: Sensor Zero Coverage Sensor <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token assign-left variable">time</span><span class="token operator">=</span>21ms
INFO: No SCM system was detected. You can use the <span class="token string">'sonar.scm.provider'</span> property to explicitly specify it.
INFO: Calculating CPD <span class="token keyword">for</span> <span class="token number">1</span> <span class="token function">file</span>
INFO: CPD calculation finished
INFO: Analysis report generated <span class="token keyword">in</span> 189ms, <span class="token function">dir</span> <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">83</span> KB
INFO: Analysis report compressed <span class="token keyword">in</span> 17ms, <span class="token function">zip</span> <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">14</span> KB
INFO: Analysis report uploaded <span class="token keyword">in</span> 1437ms
INFO: ANALYSIS SUCCESSFUL, you can browse http://10.0.1.102:9000/dashboard?id<span class="token operator">=</span>org.sonarqube%3Aphp-simple-sq-scanner
INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report
INFO: More about the report processing at http://10.0.1.102:9000/api/ce/task?id<span class="token operator">=</span>AXfzlFbUEMwg_dNR3M3w
INFO: Analysis total time: <span class="token number">13.302</span> s
INFO: ------------------------------------------------------------------------
INFO: EXECUTION SUCCESS
INFO: ------------------------------------------------------------------------
INFO: Total time: <span class="token number">21</span>.257s
INFO: Final Memory: 8M/40M
INFO: ------------------------------------------------------------------------
<span class="token punctuation">[</span>root@jenkins php-sonar-runner<span class="token punctuation">]</span>$</code></pre>

<p>web 看测试结果：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614699497744.png"></p>
<h2 id="jenkins-执行代码扫描"><a href="#jenkins-执行代码扫描" class="headerlink" title="jenkins 执行代码扫描"></a>jenkins 执行代码扫描</h2><p>上面是命令行执行 sonar-scanner 命令进行测试，可以结合 jenkins 进行测试，无非就是将命令写到脚本里，让 jenkins 自动执行</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/Jenkins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/Jenkins/" class="post-title-link" itemprop="url">Jenkins</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-27 11:03:03" itemprop="dateCreated datePublished" datetime="2021-02-27T11:03:03+08:00">2021-02-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/" itemprop="url" rel="index"><span itemprop="name">Jenkins与Gitlab</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>官方网站： <a target="_blank" rel="noopener" href="https://jenkins.io/zh/">https://jenkins.io/zh/</a></p>
<p>Jenkins 是开源 CI&amp;CD 软件领导者， 提供超过 1000 个插件来支持构建、部署、自动化， 满足任何项目的需要。</p>
<h2 id="部署-jenkins"><a href="#部署-jenkins" class="headerlink" title="部署 jenkins"></a>部署 jenkins</h2><p>Jenkins 支持各种运行方式，可通过系统包、Docker 或者通过一个独立的 Java 程序</p>
<h3 id="安装-JDK"><a href="#安装-JDK" class="headerlink" title="安装 JDK"></a>安装 JDK</h3><p>Jenkins 基于 JAVA 实现，安装 Jenkins 前需要先安装 JDK</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@jenkins ~<span class="token punctuation">]</span><span class="token variable">$java</span> <span class="token parameter variable">-version</span>
<span class="token function">java</span> version <span class="token string">"1.8.0_271"</span>
Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build <span class="token number">1.8</span>.0_271-b09<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span>build <span class="token number">25.271</span>-b09, mixed mode<span class="token punctuation">)</span></code></pre>

<h3 id="安装-jenkins"><a href="#安装-jenkins" class="headerlink" title="安装 jenkins"></a>安装 jenkins</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$wget</span> https://mirrors.tuna.tsinghua.edu.cn/jenkins/debian-stable/jenkins_2.263.4_all.deb	<span class="token comment"># 清华源下载dep包</span>
<span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> daemon	<span class="token comment"># 依赖的包，如果没有，会报错，所以提前装上</span>
<span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$ln</span> <span class="token parameter variable">-s</span> /usr/local/jdk/bin/java /usr/bin/java <span class="token comment"># Jenkins只会在/bin:/usr/bin:/sbin:/usr/sbin找java，所以设置$PATH不好使，得做个软连接</span>

<span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> jenkins_2.263.4_all.deb	<span class="token comment"># 安装</span></code></pre>

<p>主要文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/default/jenkins
/etc/init.d/jenkins
/etc/logrotate.d/jenkins
/usr/share/jenkins/jenkins.war	<span class="token comment"># 实际上就是启动这个war包</span>
/var/cache/jenkins/
/var/lib/jenkins/
/var/log/jenkins/</code></pre>

<h3 id="修改-jenkins-服务的用户"><a href="#修改-jenkins-服务的用户" class="headerlink" title="修改 jenkins 服务的用户"></a>修改 jenkins 服务的用户</h3><p>默认 jenkins 服务使用 jenkins 帐号启动，将文件复制到生产服务器可能会遇到权限问题，需要先 su 到对应的用户，这里学习环境为了方便，修改为 root 用户，注意：工作中还是使用 jenkins 普通用户</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/default/jenkins
<span class="token comment">#JENKINS_USER=$NAME</span>
<span class="token comment">#JENKINS_GROUP=$GROUP</span>
<span class="token assign-left variable">JENKINS_USER</span><span class="token operator">=</span>root		<span class="token comment"># 直接修改为root，不要修改$NAME变量</span>
<span class="token assign-left variable">JENKINS_GROUP</span><span class="token operator">=</span>root</code></pre>

<h3 id="访问-jenkins-页面"><a href="#访问-jenkins-页面" class="headerlink" title="访问 jenkins 页面"></a>访问 jenkins 页面</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614401256959.png"></p>
<h3 id="创建管理员用户"><a href="#创建管理员用户" class="headerlink" title="创建管理员用户"></a>创建管理员用户</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614419504909.png"></p>
<p>先创建用户，然后使用刚创建的用户登录</p>
<h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p>Jenkins 是完全插件化的服务，我们想实现什么功能，不是改配置文件，而是下载插件</p>
<p>修改更新源为国内清华源：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$cat</span> /var/lib/jenkins/hudson.model.UpdateCenter.xml
<span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">'1.1'</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">'UTF-8'</span>?<span class="token operator">></span>
<span class="token operator">&lt;</span>sites<span class="token operator">></span>
  <span class="token operator">&lt;</span>site<span class="token operator">></span>
    <span class="token operator">&lt;</span>id<span class="token operator">></span>default<span class="token operator">&lt;</span>/id<span class="token operator">></span>
    <span class="token operator">&lt;</span>url<span class="token operator">></span>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json<span class="token operator">&lt;</span>/url<span class="token operator">></span>
  <span class="token operator">&lt;</span>/site<span class="token operator">></span>
<span class="token operator">&lt;</span>/sites<span class="token operator">></span>
<span class="token punctuation">[</span>root@jenkins src<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart jenkins.service</code></pre>

<p>有以下几种安装插件的方式：</p>
<ul>
<li><p>在线安装：官网，也是默认的方式，比较慢</p>
</li>
<li><p>在线安装：清华大学镜像源，sed 或者编辑器把 update-center.json 中的 Jenkins 网址替换为清华源</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将：</span>
https://updates.jenkins.io/download/plugins/warnings/5.0.1/warnings.hpi
<span class="token comment"># 替换为：</span>
https://mirrors-i.tuna.tsinghua.edu.cn/jenkins/plugins/warnings/5.0.1/warnings.hpi</code></pre>
</li>
<li><p>离线安装：手动下载插件，然后放到 <code>/var/lib/jenkins/plugins/</code>，重启 Jenkins 即可</p>
</li>
<li><p>通过 web 界面安装</p>
</li>
</ul>
<p>搜索需要 gitlab（和 gitlab 相连）和 Blue Ocean（显示信息更加好看）的相关插件并安装<br><img data-src="//img.to2b.cn/blog/ljk/1614420618342.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614420627245.png"></p>
<h3 id="配置-jenkins-权限管理"><a href="#配置-jenkins-权限管理" class="headerlink" title="配置 jenkins 权限管理"></a>配置 jenkins 权限管理</h3><p>默认 jenkins 用户可以执行所有操作，为了更好的分层控制，可以实现基于角色的权限管理，先创建角色和用户，给角色授权，然后把用户管理到角色<br><img data-src="//img.to2b.cn/blog/ljk/1614420854983.png"></p>
<h4 id="安装插件-1"><a href="#安装插件-1" class="headerlink" title="安装插件"></a>安装插件</h4><p>安装插件：Role-based Authorization Strategy</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614421540614.png"></p>
<p>如果直接下载失败，可以直接清华源下载，将插件放在 &#x2F;var&#x2F;lib&#x2F;jenkins&#x2F;plugins 目录下</p>
<h4 id="创建新用户"><a href="#创建新用户" class="headerlink" title="创建新用户"></a>创建新用户</h4><p>新建 xiaoming 和 xiaogang 两个用户：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614421772031.png"></p>
<h4 id="更改认证方式"><a href="#更改认证方式" class="headerlink" title="更改认证方式"></a>更改认证方式</h4><p><img data-src="//img.to2b.cn/blog/ljk/1614421857383.png"></p>
<h4 id="新建任务"><a href="#新建任务" class="headerlink" title="新建任务"></a>新建任务</h4><p>通常选择“构建一个自由风格的软件项目”，新建四个任务：test1-job1、test1-job2、test2-job1、test2-job2</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614437643715.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614438035531.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614438185388.png"></p>
<h4 id="创建角色并对角色分配权限"><a href="#创建角色并对角色分配权限" class="headerlink" title="创建角色并对角色分配权限"></a>创建角色并对角色分配权限</h4><ol>
<li><p>创建全局角色<br>创建全局读角色，只有读权限</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614438336925.png"></p>
</li>
<li><p>创建 item 角色<br>创建两个 item 角色，test1-role、test2-role，通过正则匹配分配任务</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614438723442.png"></p>
</li>
</ol>
<h4 id="将用户关联到角色"><a href="#将用户关联到角色" class="headerlink" title="将用户关联到角色"></a>将用户关联到角色</h4><p><img data-src="//img.to2b.cn/blog/ljk/1614439083101.png"></p>
<h4 id="测试普通用户登录"><a href="#测试普通用户登录" class="headerlink" title="测试普通用户登录"></a>测试普通用户登录</h4><p>xiaogang 用户只能看到 test1.* 匹配的项目：test1-job1、test1-job2</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614439212771.png"></p>
<p>xiaoming 用户只能看到 test2.*匹配的项目：test2-job1、test2-job2</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614439131227.png"></p>
<h3 id="jenkins-邮箱配置"><a href="#jenkins-邮箱配置" class="headerlink" title="jenkins 邮箱配置"></a>jenkins 邮箱配置</h3><p>邮件发送到组邮件地址，组邮件会转发到组内所有人</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614440906709.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614448899376.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614448948512.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614448968065.png"></p>
<h2 id="配置-jenkins-到-gitlab-非交互式拉取代码"><a href="#配置-jenkins-到-gitlab-非交互式拉取代码" class="headerlink" title="配置 jenkins 到 gitlab 非交互式拉取代码"></a>配置 jenkins 到 gitlab 非交互式拉取代码</h2><p>需要配置 ssh key （公钥）和 凭据（私钥）</p>
<h3 id="配置-ssh-key"><a href="#配置-ssh-key" class="headerlink" title="配置 ssh key"></a>配置 ssh key</h3><p>实现 jenkins 服务器到 gitlab 服务器的基于密钥的验证，可以让 jenkins 连接到 gitlab 执行操作</p>
<ol>
<li>在 jenkins 服务上生成 ssh key</li>
<li>在 gitlab 服务器上添加上面生成的 ssh key</li>
<li>在 jenkins 服务器上测试 ssh key</li>
</ol>
<h3 id="配置凭据"><a href="#配置凭据" class="headerlink" title="配置凭据"></a>配置凭据</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614475785419.png"></p>
<p>凭据就是私钥，clone 项目的时候，可选择不同的凭据（私钥），只要他在 gitlab 上配置了 key（公钥），如果不指定，就以当前用户的私钥作为凭据去 clone 项目</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614450304298.png"></p>
<p><strong>管理凭据：系统管理 -&gt; 安全 -&gt; Manage Credentials</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614530969063.png"></p>
<h2 id="构建触发器"><a href="#构建触发器" class="headerlink" title="构建触发器"></a>构建触发器</h2><p>构建触发器（webhook），有的人称为钩子，实际上是一个 HTTP 回调，其用于在开发人员向 gitlab 提交代码后能够触发 jenkins 自动执行代码构建操作</p>
<p>以下为新建一个开发分支，只有在开发人员向开发（develop）分支提交代码的时候才会触发代码构建，而向主分支提交的代码不会自动构建，需要运维人员手动部署代码到生产环境</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614476777486.png"></p>
<p>生产中千万不要用，测试一般也不用，都是由开发登陆自己的账号，只能看到自己的 job，然后开发自己手动部署</p>
<h2 id="项目关联"><a href="#项目关联" class="headerlink" title="项目关联"></a>项目关联</h2><p>用于多个 job 相互关联，需要串行执行多个 job 的场景，不过这个操作基本不用</p>
<p>例如：克隆代码、编译代码、停止 tomcat、部署代码、启动 tomcat 这些操作使用不同的 job 执行，这些 job 需要串行执行</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614483144955.png"></p>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>job 太多需要分类</p>
<p>视图可用于归档 job 进行分组显示，比如将一个业务的 job 放在一个视图显示，最常用的是<strong>列表视图</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614486049732.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614486289558.png"></p>
<h2 id="jenkins-分布式"><a href="#jenkins-分布式" class="headerlink" title="jenkins 分布式"></a>jenkins 分布式</h2><p>在众多 Job 的场景下，单台 jenkins master 同时执行代码 clone、编译、打包及构建，其性能可能会出现瓶颈从而会影响代码部署效率，影响 jenkins 官方提供了 jenkins 分布式构建，将众多 job 分散运行到不同的 jenkins slave 节点，大幅提高并行 job 的处理能力</p>
<h3 id="配置-slave-节点环境"><a href="#配置-slave-节点环境" class="headerlink" title="配置 slave 节点环境"></a>配置 slave 节点环境</h3><p>slave 节点需要配置与 master 一样的基础运行环境，另外也要创建与 master 相同的数据目录，因为脚本中调用的路径只有相对于 master 的一个路径，此路径在 master 与各 node 节点必须保持一致</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置java环境</span>
<span class="token punctuation">[</span>root@jenkins-slave1 ~<span class="token punctuation">]</span><span class="token variable">$java</span> <span class="token parameter variable">-version</span>
<span class="token function">java</span> version <span class="token string">"1.8.0_271"</span>
Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build <span class="token number">1.8</span>.0_271-b09<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span>build <span class="token number">25.271</span>-b09, mixed mode<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@jenkins-slave1 ~<span class="token punctuation">]</span><span class="token variable">$ln</span> <span class="token parameter variable">-s</span> /usr/local/jdk/bin/java /usr/bin/java

<span class="token comment"># 创建数据目录</span>
<span class="token punctuation">[</span>root@jenkins-slave1 ~<span class="token punctuation">]</span><span class="token variable">$mkdir</span> <span class="token parameter variable">-p</span> /var/lib/jenkins</code></pre>

<h3 id="添加-slave-节点"><a href="#添加-slave-节点" class="headerlink" title="添加 slave 节点"></a>添加 slave 节点</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614491840961.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614491886001.png"></p>
<p>可以限制项目只能在指定的节点中执行：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614506433668.png"></p>
<h2 id="流水线-pipline"><a href="#流水线-pipline" class="headerlink" title="流水线 pipline"></a>流水线 pipline</h2><p>流水线 pipline 是 Jenkins 中的头等公民，官方介绍；<a target="_blank" rel="noopener" href="https://www.jenkins.io/zh/doc/book/pipeline/">https://www.jenkins.io/zh/doc/book/pipeline/</a></p>
<p>本质上，Jenkins 是一个自动化引擎，它支持许多自动模式。 流水线向 Jenkins 中添加了一组强大的工具, 支持用例 简单的持续集成到全面的 CD 流水线。通过对一系列的相关任务进行建模, 用户可以利用流水线的很多特性:</p>
<ul>
<li>代码：流水线是在代码中实现的，通常会检查到源代码控制，使团队有编辑，审查和迭代他们的交付流水线的能力</li>
<li>可持续性：jenkins 的重启或者中断后不影响已经执行的 Pipline Job</li>
<li>支持暂停：pipline 可以选择停止并等待人工输入或批准后再继续执行</li>
<li>可扩展：通过 groovy 的编程更容易的扩展插件</li>
<li>并行执行：通过 groovy 脚本可以实现 step，stage 间的并行执行，和更复杂的相互依赖关系</li>
</ul>
<h3 id="流水线概念"><a href="#流水线概念" class="headerlink" title="流水线概念"></a>流水线概念</h3><h4 id="流水线-pipeline"><a href="#流水线-pipeline" class="headerlink" title="流水线 pipeline"></a>流水线 pipeline</h4><p>流水线是用户定义的一个 CD 流水线模型 。流水线的代码定义了整个的构建过程, 他通常包括构建, 测试和交付应用程序的阶段</p>
<h4 id="节点-node"><a href="#节点-node" class="headerlink" title="节点 node"></a>节点 node</h4><p>每个 node 都是一个 jenkins 节点，可以是 jenkins master 也可以是 jenkins agent，node 是执行 step 的具体服务器</p>
<h4 id="阶段-stage"><a href="#阶段-stage" class="headerlink" title="阶段 stage"></a>阶段 stage</h4><p>一个 pipline 可以划分为若干个 stage，每个 stage 都是一个操作，比如 clone 代码、代码编译、代码测试和代码部署，阶段是一个逻辑分组，可以跨多个 node 执行</p>
<h4 id="步骤-step"><a href="#步骤-step" class="headerlink" title="步骤 step"></a>步骤 step</h4><p>step 是 jenkins pipline 最基本的操作单元，从在服务器创建目录到构建容器镜像，由各类 Jenkins 插件提供实现，例如： sh “make”</p>
<h3 id="流水线语法概述"><a href="#流水线语法概述" class="headerlink" title="流水线语法概述"></a>流水线语法概述</h3><p>对 Jenkins 流水线的定义被写在一个文本文件中： <strong>Jenkinsfile</strong>，该文件可以被提交到项目的源代码的控制仓库。 这是”流水线即代码”的基础；将 CD 流水线作为应用程序的一部分，像其他代码一样进行版本化和审查。</p>
<p>Jenkinsfile 能使用两种语法进行编写，声明式和脚本化。</p>
<p>声明式和脚本化的流水线从根本上是不同的。 <strong>声明式流水线的是 Jenkins 流水线更近的特性</strong>。</p>
<h4 id="声明式流水线基础"><a href="#声明式流水线基础" class="headerlink" title="声明式流水线基础"></a>声明式流水线基础</h4><p>在声明式流水线语法中, <code>pipeline</code> 块定义了整个流水线中完成的所有的工作。</p>
<p>示例：</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">Jenkinsfile <span class="token punctuation">(</span>Declarative Pipeline<span class="token punctuation">)</span>
pipeline <span class="token punctuation">&#123;</span>
    agent any
    stages <span class="token punctuation">&#123;</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Build'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            steps <span class="token punctuation">&#123;</span>
                sh <span class="token string">'make'</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Test'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            steps <span class="token punctuation">&#123;</span>
                sh <span class="token string">'make check'</span>
                junit <span class="token string">'reports/**/*.xml'</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            steps <span class="token punctuation">&#123;</span>
                sh <span class="token string">'make publish'</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<ul>
<li>pipeline 是声明式流水线的一种特定语法，他定义了包含执行整个流水线的所有内容和指令的 “block” 。</li>
<li>agent 是声明式流水线的一种特定语法，它指示 Jenkins 为整个流水线分配一个执行器 (在节点上)和工作区。</li>
<li>stage 是一个描述 stage of this Pipeline 的语法块。在 Pipeline syntax 页面阅读更多有关声明式流水线语法的<code>stage</code>块的信息。如 above 所述, 在脚本化流水线语法中，stage 块是可选的。</li>
<li>steps 是声明式流水线的一种特定语法，它描述了在这个 stage 中要运行的步骤。</li>
<li>sh 是一个执行给定的 shell 命令的流水线 step (由 Pipeline: Nodes and Processes plugin 提供) 。</li>
<li>junit 是另一个聚合测试报告的流水线 step (由 JUnit plugin 提供)。</li>
<li>node 是脚本化流水线的一种特定语法，它指示 Jenkins 在任何可用的代理&#x2F;节点上执行流水线 (和包含在其中的任何阶段)这实际上等效于 声明式流水线特定语法的<code>agent</code>。</li>
</ul>
<h4 id="脚本化流水线基础"><a href="#脚本化流水线基础" class="headerlink" title="脚本化流水线基础"></a>脚本化流水线基础</h4><p>…</p>
<h3 id="pipline-语法"><a href="#pipline-语法" class="headerlink" title="pipline 语法"></a>pipline 语法</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/">https://www.jenkins.io/zh/doc/book/pipeline/syntax/</a></p>
<h3 id="pipline-job"><a href="#pipline-job" class="headerlink" title="pipline job"></a>pipline job</h3><h4 id="创建-pipline-job"><a href="#创建-pipline-job" class="headerlink" title="创建 pipline job"></a>创建 pipline job</h4><p><img data-src="//img.to2b.cn/blog/ljk/1614528712085.png"></p>
<h4 id="测试简单-pipline-job-运行"><a href="#测试简单-pipline-job-运行" class="headerlink" title="测试简单 pipline job 运行"></a>测试简单 pipline job 运行</h4><pre class="language-groovy" data-language="groovy"><code class="language-groovy">node <span class="token punctuation">&#123;</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'clone 代码'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        echo <span class="token string">'代码 clone'</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码构建'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        echo <span class="token string">'代码构建'</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码测试'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        echo <span class="token string">'代码测试'</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码部署'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        echo <span class="token string">'代码部署'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1614530003079.png"></p>
<p>立即构建，查看输出信息：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614530073645.png"></p>
<h4 id="自动生成拉取代码的-pipline-脚本"><a href="#自动生成拉取代码的-pipline-脚本" class="headerlink" title="自动生成拉取代码的 pipline 脚本"></a>自动生成拉取代码的 pipline 脚本</h4><p><img data-src="//img.to2b.cn/blog/ljk/1614532586175.png"></p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/git%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/git%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">git命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-26 16:05:33" itemprop="dateCreated datePublished" datetime="2021-02-26T16:05:33+08:00">2021-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/" itemprop="url" rel="index"><span itemprop="name">Jenkins与Gitlab</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><pre class="language-none"><code class="language-none">master分支：稳定的分支
develop分支：开发分支

lujinkai：开发人员分支
xiaoming：开发人员分支
...</code></pre>

<p>master 分支是上线的代码，develop 是开发中的代码，lujinkai、xiaoming 等是开发人员分支，开发在自己的分支里面写代码，然后下班前提交、合并到 develop 分支，等项目开发、测试完，最后再合并到 master 分支，然后上线</p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kafka2 testproject<span class="token punctuation">]</span><span class="token variable">$git</span> branch		<span class="token comment"># 查看本地分支</span>
* master	<span class="token comment"># 分支前标 * 表示当前处于的分支</span>

<span class="token punctuation">[</span>root@kafka2 testproject<span class="token punctuation">]</span><span class="token variable">$git</span> branch <span class="token parameter variable">-a</span>		<span class="token comment"># 查看所有分支</span>
* master
  remotes/origin/HEAD -<span class="token operator">></span> origin/master
  remotes/origin/ludongsheng
  remotes/origin/master

<span class="token function">git</span> status      <span class="token comment"># 查看工作区的状态</span>
<span class="token function">git</span> branch <span class="token builtin class-name">test</span> <span class="token comment"># 创建test分支</span>
<span class="token function">git</span> merge <span class="token builtin class-name">test</span>  <span class="token comment"># 将test分支合并到当前分支</span>
<span class="token function">git</span> log         <span class="token comment"># 查看操作日志</span>
<span class="token function">git</span> reflog      <span class="token comment"># 获取每次提交的ID，可以使用--hard根据提交的ID进行版本回退</span>

<span class="token function">vim</span> .gitignore          	<span class="token comment"># 定义忽略文件，即不放在仓库的文件</span>

<span class="token function">git</span> reset <span class="token parameter variable">--hard</span> HEAD^^ 	<span class="token comment"># git版本回滚， HEAD为当前版本，加一个^为上一个，^^为上上一个版本</span>

<span class="token function">git</span> reset <span class="token parameter variable">--hard</span> 5ae4b06 	<span class="token comment"># 回退到指定id的版本</span>

<span class="token function">git</span> checkout <span class="token parameter variable">-b</span> develop 	<span class="token comment"># 创建并切换到一个新分支</span>
<span class="token function">git</span> checkout develop    	<span class="token comment"># 切换分支</span>

<span class="token function">git</span> clone <span class="token parameter variable">-b</span> 分支名 仓库地址	<span class="token comment"># clone指定分支的代码</span></code></pre>

<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol>
<li><p>在 gitlab 创建个人分支 lujinkai</p>
</li>
<li><p>克隆 master 分支到本地</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@dev ~<span class="token punctuation">]</span><span class="token variable">$git</span> clone git@gitlab.ljk.local:testgroup/testproject.git</code></pre>
</li>
<li><p>切换到自己分支</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@dev ~<span class="token punctuation">]</span><span class="token variable">$git</span> checkout lujinkai</code></pre>
</li>
<li><p>将 develop 分支拉下来和个人分支合并</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@dev ~<span class="token punctuation">]</span><span class="token variable">$git</span> pull origin develop

<span class="token comment"># git pull &lt;远程主机名> &lt;远程分支名>:&lt;本地分支名></span>
<span class="token comment"># 如果与当前分支合并，则冒号后面的部分可以省略</span></code></pre>

<p>以上命令是把远程分支 develop 拉下来，然后合并到当前分支 lujinkai，或者可以拆分成以下步骤：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout develop			<span class="token comment"># 切换到分支develop</span>
<span class="token function">git</span> pull origin develop			<span class="token comment"># 远程develop拉下来和本地develop合并</span>
<span class="token function">git</span> checkout lujinkai			<span class="token comment"># 切换到分支lujinkai</span>
<span class="token function">git</span> merge develop --no-commit	<span class="token comment"># 将本地分支develop和当前分支lujinkai合并</span></code></pre>
</li>
<li><p>开发代码</p>
</li>
<li><p>下班了，需要提交代码，但是在提交之前最好再执行一遍上一步，因为在你写代码的过程中，develop 分支可能有其他人提交</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@dev ~<span class="token punctuation">]</span><span class="token variable">$git</span> pull origin develop</code></pre>
</li>
<li><p>添加文件到本地缓存区</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@dev ~<span class="token punctuation">]</span><span class="token variable">$git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>		<span class="token comment"># . 表示当前目录下的所有文件</span></code></pre>
</li>
<li><p>提交内容到本地分支上</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"注释, 提交说明"</span></code></pre>
</li>
<li><p>上传本地分支到远程分支</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> push

<span class="token comment"># 默认提交到本地分支对应的远程分支，或者可以显式指定</span>
<span class="token function">git</span> push origin lujinkai</code></pre></li>
</ol>
<p>之后每天 3 - 9 步骤走一遍</p>
<h2 id="清除-master-分支的-commit-记录"><a href="#清除-master-分支的-commit-记录" class="headerlink" title="清除 master 分支的 commit 记录"></a>清除 master 分支的 commit 记录</h2><ol>
<li>克隆仓库 （这时工作目录里是 master 分支最后一次提交的内容）</li>
<li>创建一个新的空的分支</li>
<li>添加工作目录里所有文件到新的分支并做一次提交</li>
<li>删除 master 分支</li>
<li>将新的分支更名为 master</li>
<li>强制更新到 github 仓库</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone <span class="token punctuation">[</span>URL<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token punctuation">[</span>仓库名<span class="token punctuation">]</span>           <span class="token comment"># 克隆git仓库,进入仓库</span>
<span class="token function">git</span> checkout <span class="token parameter variable">--orphan</span>  new_branch		<span class="token comment"># 创建一个新的空的分支</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token parameter variable">-A</span>								<span class="token comment"># 添加工作目录里所有文件到新的分支</span>
<span class="token function">git</span> commit <span class="token parameter variable">-am</span> <span class="token string">'v1'</span> 					<span class="token comment"># 做一次提交</span>
<span class="token function">git</span> branch <span class="token parameter variable">-D</span> master					<span class="token comment"># 删除master分支</span>
<span class="token function">git</span> branch <span class="token parameter variable">-m</span> master					<span class="token comment"># 将新的分支更名为master</span>
<span class="token function">git</span> push origin master <span class="token parameter variable">--force</span>			<span class="token comment"># 强制更新到github仓库</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/GitLab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/GitLab/" class="post-title-link" itemprop="url">GitLab</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-24 20:57:24" itemprop="dateCreated datePublished" datetime="2021-02-24T20:57:24+08:00">2021-02-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/" itemprop="url" rel="index"><span itemprop="name">Jenkins与Gitlab</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h2><p>DevOps 是 Development 和 Operations 的组合，也就是开发和运维的简写</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614169616979.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614169709436.png"></p>
<h3 id="什么是持续集成-CI-Continuous-integration"><a href="#什么是持续集成-CI-Continuous-integration" class="headerlink" title="什么是持续集成(CI-Continuous integration)"></a>什么是持续集成(CI-Continuous integration)</h3><p>持续集成是指多名开发者在开发不同功能代码的过程当中，可以频繁的将代码行合并到一起并切相互不影响工作</p>
<h3 id="什么是持续部署-CD-continuous-deployment"><a href="#什么是持续部署-CD-continuous-deployment" class="headerlink" title="什么是持续部署(CD-continuous deployment)"></a>什么是持续部署(CD-continuous deployment)</h3><p>是基于某种工具或平台实现代码自动化的构建、测试和部署到线上环境以实现交付高质量的产品,持续部署在某种程度上代表了一个开发团队的更新迭代速率</p>
<h3 id="什么是持续交付-Continuous-Delivery"><a href="#什么是持续交付-Continuous-Delivery" class="headerlink" title="什么是持续交付(Continuous Delivery)"></a>什么是持续交付(Continuous Delivery)</h3><p>持续交付是在持续部署的基础之上，将产品交付到线上环境，因此持续交付是产品价值的一种交付，是产品价值的一种盈利的实现</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614176255696.png"></p>
<h2 id="GitLab"><a href="#GitLab" class="headerlink" title="GitLab"></a>GitLab</h2><p>GitLab 和 GitHub 一样属于第三方基于 Git 开发的作品，免费且开源，与 Github 类似，可以注册用户，任意提交你的代码，添加 SSHKey 等等。不同的是，GitLab 是可以部署到自己的服务器上，简单来说可把 GitLab 看作个人版的 GitHub</p>
<p>Git 在每个用户都有一个完整的服务器，然后再有一个中央服务器，用户可以先将代码提交到本地，没有网络也可以先提交到本地，然后在有网络的时候再提交到中央服务器，这样就大大方便了开发者，而相比 CVS 和 SVN 都是集中式的版本控制系统，工作的时候需要先从中央服务器获 取最新的代码，改完之后需要提交，如果是一个比较大的文件则需要足够快的网络才能快速提交完成，而使用分布式的版本控制系统，每个用户都是一个完整的版本库，即使没有中央服务器也可以提交代码或者回滚，最终再把改好的代码提交至中央服务器进行合并即可</p>
<h3 id="SVN"><a href="#SVN" class="headerlink" title="SVN"></a>SVN</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614177398119.png"></p>
<p>每次提交的文件都单独保存， 即按照文件的提交时间区分不同的版本， 保存至不同的逻辑存储区域，后期恢复时候直接基于之前版本恢复。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614390874831.png"></p>
<hr>
<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614177324513.png"></p>
<p>Gitlab 与 SVN 的数据保存方式不一样，gitlab 虽然 也会在内部 对数据进行逻辑划分保存，但是当后期提交的数据如和之前交的数据没有变化，其就直接 快照之前的文件 ，而不是再将文件重新上传一份再保存一遍，这样既节省 了空间又加快了代码提交速度 。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614390911662.png"></p>
<h4 id="git-缓存区与工作区等概念"><a href="#git-缓存区与工作区等概念" class="headerlink" title="git 缓存区与工作区等概念"></a>git 缓存区与工作区等概念</h4><p><img data-src="//img.to2b.cn/blog/ljk/1614391028145.png"></p>
<ul>
<li>工作区 ：clone 的代码或者开发自己编写代码文件所在 的目录 ，通常是代码所在的一 个服务的目录名称</li>
<li>暂存区 ：用于存储在工作区中对代码进行修改后的文件所保存的地方，使用 <code>git add</code> 添加</li>
<li>本地仓库： 用于提交存储在工作区和暂存区中改过的文件地方，使 <code>git commit</code> 提交</li>
<li>远程仓库 ：多个开发人员共同协作提交代码的仓库，即 gitlab 服务器</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1614391097079.png"></p>
<h2 id="Gitlab-部署与使用"><a href="#Gitlab-部署与使用" class="headerlink" title="Gitlab 部署与使用"></a>Gitlab 部署与使用</h2><p>测试环境：内存 4G 以上<br>生产环境：建议 CPU2C，内存 8G，磁盘 10G 以上配置，和用户数有关</p>
<p>清华源 centos7：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/</a><br>清华源 ubuntu18.04：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/bionic/main/g/gitlab-ce/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/bionic/main/g/gitlab-ce/</a></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@gitlab src<span class="token punctuation">]</span><span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> gitlab-ce_13.8.4-ce.0_amd64.deb	<span class="token comment"># 得等一会</span>
<span class="token punctuation">..</span>.
configuration <span class="token keyword">in</span> /etc/gitlab/gitlab.rb file.	<span class="token comment"># 配置文件</span>
<span class="token punctuation">..</span>.</code></pre>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 需要配置gitlab服务器地址和邮件地址</span>
<span class="token punctuation">[</span>root@gitlab src<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/gitlab/gitlab.rb
external_url <span class="token string">'http://gitlab.ljk.local'</span>		<span class="token comment"># 修改此行</span>
<span class="token comment"># 增加下面行，可选邮件通知设置</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_address'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"smtp.qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">465</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_user_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"441757636@qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"jwopcvnpcawdabbg"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_domain'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"qq.com"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_authentication'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"login"</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_enable_starttls_auto'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'smtp_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_email_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"441757636@qq.com"</span></code></pre>

<p>gitlab 相关目录：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/gitlab     	<span class="token comment">#配置文件目录</span>
/run/gitlab     	<span class="token comment">#运行pid目录</span>
/opt/gitlab     	<span class="token comment">#安装目录</span>
/var/opt/gitlab 	<span class="token comment">#数据目录</span>
/var/log/gitlab 	<span class="token comment">#日志目录</span></code></pre>

<h3 id="初始化服务"><a href="#初始化服务" class="headerlink" title="初始化服务"></a>初始化服务</h3><p>修改完配置文件要执行此操作</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@gitlab src<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-ctl reconfigure</code></pre>

<p>常用命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">gitlab-rails          <span class="token comment">#用于启动控制台进行特殊操作，如修改管理员密码、打开数据库控制台( gitlab-rails dbconsole)等</span>
gitlab-psql           <span class="token comment">#数据库命令行</span>
gitlab-rake           <span class="token comment">#数据备份恢复等数据操作</span>

gitlab-ctl            <span class="token comment">#客户端命令行操作行</span>
gitlab-ctl stop       <span class="token comment">#停止gitlab</span>
gitlab-ctl start      <span class="token comment">#启动gitlab</span>
gitlab-ctl restart     <span class="token comment">#重启gitlab</span>
gitlab-ctl status     <span class="token comment">#查看组件运行状态</span>
gitlab-ctl <span class="token function">tail</span> nginx <span class="token comment">#查看某个组件的日志</span></code></pre>

<h3 id="gitlab-web-界面"><a href="#gitlab-web-界面" class="headerlink" title="gitlab web 界面"></a>gitlab web 界面</h3><p>username：root<br>注意，使用域名访问需要做 hosts</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614182163957.png"></p>
<h3 id="关闭账号注册"><a href="#关闭账号注册" class="headerlink" title="关闭账号注册"></a>关闭账号注册</h3><p>默认情况下可以直接注册账号，一般都关闭此功能，由管理员统一注册用户</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614182718463.png"></p>
<h3 id="修改邮箱地址"><a href="#修改邮箱地址" class="headerlink" title="修改邮箱地址"></a>修改邮箱地址</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614220790963.png"></p>
<p>新添加的邮箱不是默认的通知邮箱，下面是设置新邮箱为默认邮箱<br><img data-src="//img.to2b.cn/blog/ljk/1614220865939.png"></p>
<p>设置完后，需要重新登录才能生效，然后可以把之前的默认邮箱删除</p>
<h3 id="创建-gitlab-账户"><a href="#创建-gitlab-账户" class="headerlink" title="创建 gitlab 账户"></a>创建 gitlab 账户</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614221436755.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614221909588.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614225936831.png"></p>
<p>创建成功后，需要查看邮件，在邮件链接中重置密码</p>
<h3 id="创建组"><a href="#创建组" class="headerlink" title="创建组"></a>创建组</h3><p>使用管理员 root 创建组，一个组里面可以有多个项目分支，可以将开发添加到组里，再进行设置权限，不同的组对应公司不同的开发项目或者服务模块，不同的组中添加不同的开发人员帐号，即可实现对开发设置权限的管理<br><img data-src="//img.to2b.cn/blog/ljk/1614222603444.png"><br><img data-src="//img.to2b.cn/blog/ljk/1614222631085.png"></p>
<h3 id="管理员创建项目"><a href="#管理员创建项目" class="headerlink" title="管理员创建项目"></a>管理员创建项目</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614222932661.png"></p>
<p>有三种方式：创建空项目、使用模板、导入项目<br><img data-src="//img.to2b.cn/blog/ljk/1614223225964.png"></p>
<h3 id="将用户添加到组"><a href="#将用户添加到组" class="headerlink" title="将用户添加到组"></a>将用户添加到组</h3><p>更多权限：<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/user/permissions.html">https://docs.gitlab.com/ee/user/permissions.html</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614226154584.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614226205798.png"></p>
<h4 id="gitlab-仓库-developer-权限无法-push"><a href="#gitlab-仓库-developer-权限无法-push" class="headerlink" title="gitlab 仓库 developer 权限无法 push"></a>gitlab 仓库 developer 权限无法 push</h4><p>默认 develop 权限无法 merge 和 push 到 master 分支的，可以修改：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614227282416.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614227321434.png"></p>
<p>在这里，也可以设置也可以保护其他分支</p>
<h3 id="在项目中新建测试页面"><a href="#在项目中新建测试页面" class="headerlink" title="在项目中新建测试页面"></a>在项目中新建测试页面</h3><p>使用 陆东生 用户登录，新建分支，继承自 master：<br><img data-src="//img.to2b.cn/blog/ljk/1614325772039.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614325921744.png"></p>
<h3 id="git-客户端测试-clone-项目"><a href="#git-客户端测试-clone-项目" class="headerlink" title="git 客户端测试 clone 项目"></a>git 客户端测试 clone 项目</h3><ol>
<li><p>ssh 认证</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa
<span class="token function">cat</span> ~/.ssh/id_rsa.pub	<span class="token comment"># 将公钥复制到给gitlab</span></code></pre>
</li>
<li><p>clone</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone git@gitlab.ljk.local:testgroup/testproject.git</code></pre></li>
</ol>
<h3 id="git-常用命令"><a href="#git-常用命令" class="headerlink" title="git 常用命令"></a>git 常用命令</h3><p>运维常用：<code>git pull</code>、<code>git clone</code>、<code>git reset</code></p>
<h3 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h3><p>有些文件不需要上传，在 .gitignore 文件中设置忽略规则，示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 项目根目录下创建.gitignore，规则如下：忽略.vscode目录和.gitignore文件</span>
$ <span class="token function">cat</span> .gitignore
/.vscode/
.gitignore

<span class="token comment"># 在src目录下创建.gitignore文件，规则如下：忽略全部，只保留.gitignore</span>
<span class="token comment"># 目的是只保留src空目录</span>
$ <span class="token function">cat</span> ./src/.gitignore
*
<span class="token operator">!</span>.gitignore</code></pre>

<p>修改完 .gitignore 文件后，更新缓存：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> <span class="token function">rm</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">--cached</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span></code></pre>

<h3 id="gitlab-数据备份恢复"><a href="#gitlab-数据备份恢复" class="headerlink" title="gitlab 数据备份恢复"></a>gitlab 数据备份恢复</h3><ol>
<li><p>备份前必须先停止 gitlab 两个服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-ctl stop unicorn
<span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-ctl stop sidekiq</code></pre>
</li>
<li><p>备份数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-rake gitlab:backup:create
<span class="token punctuation">..</span>.
Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data
and are not included <span class="token keyword">in</span> this backup. You will need these files to restore a backup.
Please back them up manually.

<span class="token comment"># 以上warning表示gitlab.rb和gitlab-secrets.json两个文件包含敏感信息。未被备份到备份文件中。需要手动备份，这两个文件位于 /etc/gitlab</span>

<span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-ctl start	<span class="token comment"># 备份完成后启动gitlab</span></code></pre>

<p>备份数据位于 <code>/var/opt/gitlab/backups/</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$ls</span> /var/opt/gitlab/backups/
1614392268_2021_02_27_13.8.4_gitlab_backup.tar</code></pre>
</li>
<li><p>查看要恢复的文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/var/opt/gitlab/backups/   <span class="token comment"># Gitlab数据备份目录，需要使用命令备份的</span>
/var/opt/gitlab/nginx/conf <span class="token comment"># nginx配置文件</span>
/etc/gitlab/gitlab.rb      <span class="token comment"># gitlab配置文件</span></code></pre>
</li>
<li><p>删除项目和用户信息</p>
</li>
<li><p>执行恢复</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 恢复前先停止两个服务</span>
<span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-ctl stop unicorn
<span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-ctl stop sidekiq
<span class="token comment"># 恢复时指定备份文件的时间部分，不需要指定文件的全名</span>
<span class="token punctuation">[</span>root@gitlab ~<span class="token punctuation">]</span><span class="token variable">$gitlab</span>-rake gitlab:backup:restore <span class="token assign-left variable">BACKUP</span><span class="token operator">=</span>备份文件名</code></pre>
</li>
<li><p>恢复后再将之前停止的两个服务启动</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">gitlab-ctl start</code></pre></li>
</ol>
<h3 id="gitlab-汉化"><a href="#gitlab-汉化" class="headerlink" title="gitlab 汉化"></a>gitlab 汉化</h3><p>虽然不推荐，但是有需求，基于第三方开发爱好者实现</p>
<p>汉化包地址： <a target="_blank" rel="noopener" href="https://gitlab.com/xhang/gitlab">https://gitlab.com/xhang/gitlab</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://gitlab.com/xhang/gitlab.git
<span class="token function">head</span> <span class="token parameter variable">-1</span> /opt/gitlab/version-manifest.txt	<span class="token comment"># 查看当前gitlab版本</span>
<span class="token builtin class-name">cd</span> gitlab
<span class="token function">git</span> <span class="token function">diff</span> v11.9.8 v11.9.8-zh
<span class="token function">git</span> <span class="token function">diff</span> v11.9.8 v11.9.8-zh <span class="token operator">></span>/root/v11.9.8-zh.diff
gitlab-ctl stop
patch <span class="token parameter variable">-f</span> <span class="token parameter variable">-d</span> /opt/gitlab/embedded/service/gitlab-rails <span class="token parameter variable">-p1</span> <span class="token operator">&lt;</span>/root/v11.9.8-zh.diff
gitlab-ctl reconfigure
gitlab-ctl start
gitlab-ctl status</code></pre>

<h2 id="常见的代码部署方式"><a href="#常见的代码部署方式" class="headerlink" title="常见的代码部署方式"></a>常见的代码部署方式</h2><h3 id="蓝绿部署"><a href="#蓝绿部署" class="headerlink" title="蓝绿部署"></a>蓝绿部署</h3><p>不停老版本代码（不影响上一个版本访问），而是在另外一套环境部署新版本然后进行测试，测试通过后将用户流量切到新版本，其特点为业务无中断，升级风险相对较小</p>
<p>具体过程：</p>
<ol>
<li>当前版本业务正常访问(V1)</li>
<li>在另外一套环境部署新代码(V2)，代码可能是增加了功能或者是修复了某些 bug</li>
<li>测试通过之后将用户请求流量切到新版本环境</li>
<li>观察一段时间，如有异常直接切换旧版本，没有异常就删除老版本</li>
<li>下次升级，将旧版本升级到新版本(V3)</li>
</ol>
<h3 id="金丝雀发布"><a href="#金丝雀发布" class="headerlink" title="金丝雀发布"></a>金丝雀发布</h3><p>金丝雀发布也叫灰度发布，是指在黑与白之间，能够平滑过渡的一种发布方式，灰度发布是增量发布的一种类型，灰度发布是在原有版本可用的情况下，同时部署一个新版本应用作为“金丝雀”(小白鼠)，测试新版本的性能和表现，以保障整体系统稳定的情况下，尽早发现、调整问题。因此，灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度</p>
<p>具体过程：</p>
<ol>
<li>准备好部署各个阶段的工件，包括：构建组件，测试脚本，配置文件和部署清单文件。</li>
<li>从负载均衡列表中移除掉“金丝雀”服务器。</li>
<li>升级“金丝雀”应用（排掉原有流量并进行部署）。</li>
<li>对应用进行自动化测试。</li>
<li>将“金丝雀”服务器重新添加到负载均衡列表中（连通性和健康检查）。</li>
<li>如果“金丝雀”在线使用测试成功，升级剩余的其他服务器。（否则就回滚）</li>
</ol>
<h3 id="滚动发布"><a href="#滚动发布" class="headerlink" title="滚动发布"></a>滚动发布</h3><p>滚动发布，一般是取出一个或者多个服务器停止服务，执行更新，并重新将其投入使用。周而复始，直到集群中所有的实例都更新成新版本，此方式可以防止同时升级，造成服务停止</p>
<h3 id="A-x2F-B-测试"><a href="#A-x2F-B-测试" class="headerlink" title="A&#x2F;B 测试"></a>A&#x2F;B 测试</h3><p>A&#x2F;B 测试也是同时运行两个 APP 环境，但是和蓝绿部署完全是两码事，A&#x2F;B 测试是用来测试应用功能表现的方法，例如可用性、受欢迎程度、可见性等等，蓝绿部署的目的是安全稳定地发布新版本应用，并在必要时回滚，即蓝绿部署是同一时间只有一套正式环境环境在线，而 A&#x2F;B 测试是两套正式环境同时在线，一般用于多个产品竟争时使用</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/Nexus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/Nexus/" class="post-title-link" itemprop="url">Nexus</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-24 00:55:22" itemprop="dateCreated datePublished" datetime="2021-02-24T00:55:22+08:00">2021-02-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Nexus 是一个强大的 Maven 仓库管理器，它极大地简化了自己内部仓库的维护和外部仓库的访问</p>
<p>官方下载：<a target="_blank" rel="noopener" href="https://help.sonatype.com/repomanager3/download/download-archives---repository-manager-3">https://help.sonatype.com/repomanager3/download/download-archives---repository-manager-3</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614139161138.png"></p>
<h2 id="部署-Nexus"><a href="#部署-Nexus" class="headerlink" title="部署 Nexus"></a>部署 Nexus</h2><ol>
<li><p>下载、解压、创建用户</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@nexus src<span class="token punctuation">]</span><span class="token variable">$useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin nexus		<span class="token comment"># 创建nexus用户</span>
<span class="token punctuation">[</span>root@nexus src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf nexus-3.29.2-02-unix.tar.gz
<span class="token punctuation">[</span>root@nexus src<span class="token punctuation">]</span><span class="token variable">$mv</span> nexus-3.29.2-02 /usr/local/nexus
<span class="token punctuation">[</span>root@nexus src<span class="token punctuation">]</span><span class="token variable">$mv</span> sonatype-work/ /usr/local/
<span class="token punctuation">[</span>root@nexus src<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/
<span class="token punctuation">[</span>root@nexus local<span class="token punctuation">]</span><span class="token variable">$chown</span> <span class="token parameter variable">-R</span> nexus:nexus ./nexus/
<span class="token punctuation">[</span>root@nexus local<span class="token punctuation">]</span><span class="token variable">$chown</span> <span class="token parameter variable">-R</span> nexus:nexus ./sonatype-work/
<span class="token punctuation">[</span>root@nexus local<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token string">'nexus - nofile 65536'</span> <span class="token operator">>></span> /etc/security/limits.conf</code></pre>
</li>
<li><p>Service 启动文件，官方提供<br><img data-src="//img.to2b.cn/blog/ljk/1614140610635.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@nexus ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /lib/systemd/system/nexus.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>nexus <span class="token function">service</span>
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/nexus/bin/nexus start
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/nexus/bin/nexus stop
<span class="token assign-left variable">User</span><span class="token operator">=</span>nexus
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-abort
<span class="token assign-left variable">TimeoutSec</span><span class="token operator">=</span><span class="token number">600</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token punctuation">[</span>root@nexus ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start nexus.service	<span class="token comment"># 需要几分钟时间启动</span></code></pre>
</li>
<li><p>设置向导：<br><img data-src="//img.to2b.cn/blog/ljk/1614159934358.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614160006421.png"></p>
</li>
<li><p>验证默认仓库</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614160165663.png"></p>
<ul>
<li><strong>Hosted</strong>：本地仓库，通常我们会部署自己的构件到这一类型的仓库，比如公司的第三方库</li>
<li><strong>Proxy</strong>：代理仓库，它们被用来代理远程的公共仓库，如 maven 中央仓库(官方仓库)</li>
<li><strong>Group</strong>：仓库组，用来合并多个 hosted&#x2F;proxy 仓库，当你的项目希望在多个 repository 使用资源时就不需要多次引用了，只需要引用一个 group 即可</li>
</ul>
</li>
</ol>
<h2 id="构建私有-yum-仓库"><a href="#构建私有-yum-仓库" class="headerlink" title="构建私有 yum 仓库"></a>构建私有 yum 仓库</h2><ol>
<li><p>配置仓库的数据目录</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614166892473.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614166942682.png"></p>
</li>
<li><p>仓库配置，以 zabbix 为例<br><img data-src="//img.to2b.cn/blog/ljk/1614166833754.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614166765497.png"></p>
</li>
<li><p>centos 7.x 配置 yum 仓库</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/yum.repos.d/zabbix.repo
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/yum.repos.d/zabbix.repo
<span class="token punctuation">[</span>zabbix-nexus<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>zabbix
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://10.0.1.103:8081/repository/zabbix-proxy/
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span></code></pre>
</li>
<li><p>测试：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614167615659.png"></p>
</li>
<li><p>下载过的包会缓存下来<br><img data-src="//img.to2b.cn/blog/ljk/1614167736346.png"></p>
</li>
</ol>
<h2 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h2><p>Nexus 中普通数据信息和元数据是分开存储的，普通数据是保存在 blob 中，而元数据保存在数据库中，所以在备份的时候必须同时进行备份普通数据和元数据，才能在后期恢复数据的时候保证数据的最终完整性</p>
<p>数据量太大，而且不影响用户业务，数据备份没什么意义</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/RocketMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/RocketMQ/" class="post-title-link" itemprop="url">RocketMQ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-22 22:57:09" itemprop="dateCreated datePublished" datetime="2021-02-22T22:57:09+08:00">2021-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">https://rocketmq.apache.org/</a><br><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq">https://github.com/apache/rocketmq</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/ActiveMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/ActiveMQ/" class="post-title-link" itemprop="url">ActiveMQ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-22 22:56:45" itemprop="dateCreated datePublished" datetime="2021-02-22T22:56:45+08:00">2021-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="http://activemq.apache.org/">http://activemq.apache.org/</a></p>
<p>ActiveMQ 是一种开源的基于 JMS（Java Message Servie）规范的一种消息中间件的实现，采用 Java 开发，设计目标是提供标准的、面向消息的、能够跨越多语言和多系统的应用集成消息通信中间件</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.to2b.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.to2b.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.to2b.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.to2b.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
