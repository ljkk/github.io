<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.to2b.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.to2b.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/13/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/13/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/13/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.to2b.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">文件共享服务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:38:35" itemprop="dateCreated datePublished" datetime="2020-12-09T23:38:35+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/" itemprop="url" rel="index"><span itemprop="name">网络文件共享</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>补充知识：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/60986068">iSCSI</a></p>
<p>概括的说，iSCSI 是一种存储设备远程映射技术，它可以将一个远程服务器上的存储设备映射到本地，并呈现为一个块设备（大白话就是磁盘）。从普通用户的角度，映射过来的磁盘与本地安装的磁盘毫无差异。</p>
<p>这种映射方式基于是基于 SCSI 协议的，SCSI 协议是计算机与外围设备（例如硬盘、光盘等）通信的协议。而 iSCSI 则是通过 TCP 协议对 SCSI 进行封装的一种协议，也就是通过以太网传输 SCSI 协议的内容。</p>
<h2 id="存储类型"><a href="#存储类型" class="headerlink" title="存储类型"></a>存储类型</h2><p>存储类型分为三类：</p>
<ul>
<li><p>直连式存储：Direct-Attached Storage，简称 DAS</p>
</li>
<li><p>网络附加存储：Network-Attached Storage，简称 NAS</p>
</li>
<li><p>存储区域网络：Storage Area Network，简称 SAN</p>
<p>FC：Fibre Channel 光纤</p>
</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1605015314494.png"></p>
<h3 id="三种存储比较"><a href="#三种存储比较" class="headerlink" title="三种存储比较"></a>三种存储比较</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605015584443.png"></p>
<h3 id="三种存储应用场景"><a href="#三种存储应用场景" class="headerlink" title="三种存储应用场景"></a>三种存储应用场景</h3><ul>
<li>DAS 虽然比较古老了，但是还是很适用于那些数据量不大，对磁盘访问速度要求较高的中小企业</li>
<li>NAS 多适用于文件服务器，用来存储非结构化数据，虽然受限于以太网的速度，但是部署灵活，成本低</li>
<li>SAN 则适用于大型应用或数据库系统，缺点是成本高、较为复杂</li>
</ul>
<h2 id="FTP-服务"><a href="#FTP-服务" class="headerlink" title="FTP 服务"></a>FTP 服务</h2><p>文件传输协议：File Transfer Protocol，基于 C&#x2F;S 结构</p>
<p>数据传输格式：二进制（默认）和文本</p>
<p>双通道协议：命令和数据传输使用不同的端口</p>
<p>两种模式：从服务器角度命令 <strong>主动</strong> 和 <strong>被动</strong> 模式</p>
<ul>
<li><p>主动模式：Port Style</p>
<p>windows 连接 FTP 服务器默认使用主动模式</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605016511802.png"></p>
</li>
<li><p>被动模式：PASV Style</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605016539213.png"></p>
</li>
</ul>
<p>FTP 服务状态码：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">1XX：信息   <span class="token number">125</span>：数据连接打开
2XX：成功类状态   <span class="token number">200</span>：命令OK <span class="token number">230</span>：登录成功
3XX：补充类   <span class="token number">331</span>：用户名OK
4XX：客户端错误   <span class="token number">425</span>：不能打开数据连接
5XX：服务器错误   <span class="token number">530</span>：不能登录</code></pre>

<p>用户认证：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">匿名用户：ftp、anonymous，对应Linux用户ftp
系统用户：Linux用户、用户/etc/passwd，密码/etc/shadow
虚拟用户：特定服务的专用用户、独立的用户/密码文件</code></pre>

<p>常见 FTP 相关软件：</p>
<ul>
<li><p>FTP 服务器端软件</p>
<p>Wu-ftpd、Proftpd、Pureftpd、Filezilla Server、Serv-U、Wing FTP Server、IIS</p>
<p><a target="_blank" rel="noopener" href="https://security.appspot.com/vsftpd.html">vsftpd</a>：Very Secure FTP Daemon，CentOS 默认 FTP 服务器</p>
</li>
<li><p>客户端软件</p>
<p>ftp、lftp、lftpget、wget、curl</p>
</li>
</ul>
<h3 id="vsftpd"><a href="#vsftpd" class="headerlink" title="vsftpd"></a>vsftpd</h3><pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

<h3 id="pureftpd"><a href="#pureftpd" class="headerlink" title="pureftpd"></a>pureftpd</h3><pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

<h2 id="NFS-服务"><a href="#NFS-服务" class="headerlink" title="NFS 服务"></a>NFS 服务</h2><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>Network File System：网络文件系统，基于内核的文件系统。通过 NFS，用户和程序可以像访问本地文件一样去访问远端系统上的文件，基于 RPC（Remote Procedure Call Protecol）实现。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605259157055.png"></p>
<p>上图中的 portmap，自 centos6 之后就被 rpcbind 代替了</p>
<p><strong>优点：</strong>节省本地存储空间,将常用的数据,如:&#x2F;home 目录,存放在 NFS 服务器上且可以通过网络访问,本地终端将可减少自身存储空间的使用</p>
<p><strong>缺点：</strong>1. 占用带宽；2. 端口号比较多，而且不固定，防火墙不太好配；所以 nfs 一般不用在互联网，都是用在局域网</p>
<h3 id="nfs-软件介绍"><a href="#nfs-软件介绍" class="headerlink" title="nfs 软件介绍"></a>nfs 软件介绍</h3><p>软件包：nfs-utils（包括服务器和客户端相关工具）</p>
<p>相关软件包：rpcbind（必须）、tcp_wrappers</p>
<p>kernel 支持：nfs.ko</p>
<p>端口：2049（nfsd），其他端口由 portmap 分配</p>
<p>nfs 服务主要进程：</p>
<ul>
<li>rpc.nfsd：最主要的 NFS 进程,管理客户端是否可登录</li>
<li>rpc.mountd：挂载和卸载 NFS 文件系统,包括权限管理</li>
<li>rpc.lockd：非必要,管理文件锁,避免同时写出错</li>
<li>rpc.statd：非必要,检查文件一致性,可修复文件</li>
</ul>
<p>日志：&#x2F;var&#x2F;lib&#x2F;nfs</p>
<p>配置文件：&#x2F;etc&#x2F;exports 和 &#x2F;etc&#x2F;exports.d&#x2F;*.exports</p>
<h3 id="nfs-配置文件"><a href="#nfs-配置文件" class="headerlink" title="nfs 配置文件"></a>nfs 配置文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash">/dir	host1<span class="token punctuation">(</span>opt1,opt2<span class="token punctuation">)</span>	host2<span class="token punctuation">(</span>opt1,opt2<span class="token punctuation">)</span></code></pre>

<ul>
<li><p>host 格式：支持通配符 *、ipv4、ipv6、FQDN（全域名）、NIS 域的主机组</p>
</li>
<li><p>opt 格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">默认选项：<span class="token punctuation">(</span>ro,sync,root_squash,no_all_squash<span class="token punctuation">)</span>
ro：只读
rw：可读可写
async：异步,数据变化后不立即写磁盘,先写入到缓冲区中,过一段时间再写入磁盘,性能高,安全性低
sync：1.0.0后为默认，同步,数据在请求时立即写入共享存储磁盘,性能低,安全性高
root_squash：默认，远程root映射为nobody（CentOS7以前的版本为nfsnobody）,<span class="token environment constant">UID</span>为65534
no_root_squash：远程root映射成NFS服务器的root用户，squash的意思是压榨
all_squash：所有远程用户<span class="token punctuation">(</span>包括root<span class="token punctuation">)</span>都被压榨
no_all_squash：默认，保留共享文件的<span class="token environment constant">UID</span>和GID，即不压榨
anonuid和anongid：指明匿名用户映射为特定用户<span class="token environment constant">UID</span>和组GID,而非nobody,可配合all_squash使用</code></pre></li>
</ul>
<pre class="language-none"><code class="language-none">
  默认把root用户压榨成nobody用户，普通用户不压榨，anonuid和anongid可以设置默认压榨成哪个用户

范例：

​&#96;&#96;&#96;bash
# vim &#x2F;etc&#x2F;exports

&#x2F;data&#x2F;script 10.0.0.0&#x2F;24(ro,async)
&#x2F;data&#x2F;script 10.0.0.0&#x2F;24(rw,async,root_squash,anonuid&#x3D;1000,anongid&#x3D;1000,all_squash)

&#x2F;myshare server.example.com
&#x2F;myshare *.example.com
&#x2F;myshare server?.example.com
&#x2F;myshare server[0-20].example.com
&#x2F;myshare 172.25.11.10
&#x2F;myshare 172.25.0.0&#x2F;16
&#x2F;myshare 2000:472:18:b51:c32:a21
&#x2F;myshare 2000:472:18:b51::&#x2F;64
&#x2F;myshare *.example.com 172.25.0.0&#x2F;16
&#x2F;myshare desktop.example.com(ro)
&#x2F;myshare desktop.example.com(ro) server[0-20].example.com(rw)
&#x2F;myshare diskless.example.com(rw,no_root_squash)</code></pre>

<h3 id="nfs-工具"><a href="#nfs-工具" class="headerlink" title="nfs 工具"></a>nfs 工具</h3><h4 id="fpcinfo"><a href="#fpcinfo" class="headerlink" title="fpcinfo"></a>fpcinfo</h4><p>rpcinfo 工具可以查看 RPC 相关信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看注册在指定主机的RPC程序</span>
rpcinfo <span class="token parameter variable">-p</span> <span class="token function">hostname</span>

<span class="token comment"># 查看RPC注册程序</span>
rpcinfo <span class="token parameter variable">-s</span> <span class="token function">hostname</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#rpcinfo -p</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#rpcinfo -s</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#rpcinfo -p 10.0.0.8	# 查看远程主机</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#rpcinfo -s 10.0.0.8</span></code></pre>

<h4 id="exportfs"><a href="#exportfs" class="headerlink" title="exportfs"></a>exportfs</h4><p>用于管理 NFS 导出的文件系统</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">exportfs <span class="token punctuation">[</span>-avi<span class="token punctuation">]</span> <span class="token punctuation">[</span>-o options,<span class="token punctuation">..</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>client:/path <span class="token punctuation">..</span><span class="token punctuation">]</span>
exportfs <span class="token parameter variable">-r</span> <span class="token punctuation">[</span>-v<span class="token punctuation">]</span>
exportfs <span class="token punctuation">[</span>-av<span class="token punctuation">]</span> <span class="token parameter variable">-u</span> <span class="token punctuation">[</span>client:/path <span class="token punctuation">..</span><span class="token punctuation">]</span>
exportfs <span class="token punctuation">[</span>-v<span class="token punctuation">]</span>
exportfs <span class="token parameter variable">-f</span>
exportfs <span class="token parameter variable">-s</span></code></pre>

<ul>
<li>-v：查看本机所有 NFS 共享</li>
<li>-r：重读配置文件，这个选项可以避免重启服务</li>
<li>-a：输出本机所有共享</li>
<li>-au：停止本机所有共享</li>
</ul>
<h4 id="showmount"><a href="#showmount" class="headerlink" title="showmount"></a>showmount</h4><p>常见用法：查看远程主机的 nfs 共享</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">showmount <span class="token parameter variable">-e</span> <span class="token function">hostname</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#showmount -e 10.0.0.8</span>
Export list <span class="token keyword">for</span> <span class="token number">10.0</span>.0.8:
/data/wordpress *</code></pre>

<h4 id="monut"><a href="#monut" class="headerlink" title="monut"></a>monut</h4><p>客户端 nfs 挂载</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> <span class="token punctuation">[</span>-fnrsvw<span class="token punctuation">]</span> <span class="token parameter variable">-t</span> nfs <span class="token punctuation">[</span>-o options<span class="token punctuation">]</span> device <span class="token function">dir</span></code></pre>

<p>options：</p>
<ul>
<li>nfsvers&#x3D;n</li>
<li>vers&#x3D;n</li>
<li>soft &#x2F; hard</li>
<li></li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

<h3 id="自动挂载-autofs"><a href="#自动挂载-autofs" class="headerlink" title="自动挂载 autofs"></a>自动挂载 autofs</h3><p>使用 autofs 服务按需要挂载外围设备，NFS 共享等，并在空闲 5 分钟后后自动卸载</p>
<p>配置文件：&#x2F;etc&#x2F;auto.master</p>
<p>案例：</p>
<p>10.0.0.1(ubuntu)：nfs server，共享&#x2F;data&#x2F;wwwroot&#x2F;script 目录</p>
<p>10.0.0.71(centos)：nfs client</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 10.0.0.1</span>
<span class="token comment"># 安装nfs服务端软件</span>
lujinkai@Z510:~$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> nfs-kernel-server
<span class="token comment"># 修改exports共享设置文件</span>
lujinkai@Z510:~$ <span class="token function">vim</span> /etc/exports
/data/wwwroot/script <span class="token number">10.0</span>.0.0/24<span class="token punctuation">(</span>rw,async,root_squash,anonuid<span class="token operator">=</span><span class="token number">1000</span>,anongid<span class="token operator">=</span><span class="token number">1000</span>,all_squash<span class="token punctuation">)</span>
<span class="token comment"># 重新加载配置文件</span>
lujinkai@Z510:~$ <span class="token function">sudo</span> exportfs <span class="token parameter variable">-r</span>

<span class="token comment"># 10.0.0.71</span>
<span class="token comment"># 安装autofs，并设置开机自启</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> autofs
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> autofs.service
<span class="token comment"># 查看10.0.0.1共享的目录</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$showmount</span> <span class="token parameter variable">-e</span> <span class="token number">10.0</span>.0.1
Export list <span class="token keyword">for</span> <span class="token number">10.0</span>.0.1:
/data/wwwroot/script <span class="token number">10.0</span>.0.0/24
<span class="token comment"># 修改auto.master，注意格式，`man auto.master`可以查看格式</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/auto.master
<span class="token punctuation">..</span>.
/root/www /etc/auto.www
<span class="token comment"># 编辑/root/www指定的配置文件</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/auto.www
script <span class="token parameter variable">-fstype</span><span class="token operator">=</span>nfs <span class="token number">10.0</span>.0.1:/home/lujinkai/www/script
<span class="token comment"># 重启autofs</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart autofs.service
<span class="token comment"># 查看是否挂载成功</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> ~/www/
<span class="token punctuation">[</span>root@c71 www<span class="token punctuation">]</span><span class="token variable">$ll</span>	<span class="token comment"># 没有任何东西</span>
总用量 <span class="token number">0</span>
<span class="token punctuation">[</span>root@c71 www<span class="token punctuation">]</span><span class="token variable">$df</span> <span class="token parameter variable">-Th</span> ./
文件系统       类型    容量  已用  可用 已用% 挂载点
/etc/auto.www  autofs     <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">0</span>     - /root/www
<span class="token punctuation">[</span>root@c71 www<span class="token punctuation">]</span><span class="token variable">$cd</span> script	<span class="token comment"># 直接进入，就会自动挂载</span>
<span class="token punctuation">[</span>root@c71 script<span class="token punctuation">]</span><span class="token variable">$ll</span>
总用量 <span class="token number">48</span>
<span class="token parameter variable">-rwxrwxrwx</span> <span class="token number">1</span> lujinkai lujinkai  <span class="token number">688</span> <span class="token number">11</span>月 <span class="token number">13</span> <span class="token number">21</span>:54 demo.sh
drwxrwxrwx <span class="token number">2</span> lujinkai lujinkai <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">12</span> <span class="token number">10</span>:09 etc
drwxrwxrwx <span class="token number">4</span> lujinkai lujinkai <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">12</span> <span class="token number">16</span>:30 include
drwxrwxrwx <span class="token number">2</span> lujinkai lujinkai <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">12</span> <span class="token number">19</span>:34 ini
drwxrwxrwx <span class="token number">2</span> lujinkai lujinkai <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:08 init.d
<span class="token parameter variable">-rwxrwxrwx</span> <span class="token number">1</span> lujinkai lujinkai <span class="token number">3750</span> <span class="token number">10</span>月 <span class="token number">31</span> <span class="token number">20</span>:11 install.sh
<span class="token parameter variable">-rwxrwxrwx</span> <span class="token number">1</span> lujinkai lujinkai <span class="token number">2051</span> <span class="token number">10</span>月 <span class="token number">31</span> <span class="token number">15</span>:52 magedu.sh
<span class="token parameter variable">-rwxrwxrwx</span> <span class="token number">1</span> lujinkai lujinkai <span class="token number">1462</span> <span class="token number">10</span>月 <span class="token number">28</span> <span class="token number">15</span>:58 scp_list.sh
<span class="token parameter variable">-rwxrwxrwx</span> <span class="token number">1</span> lujinkai lujinkai <span class="token number">1744</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">10</span>:54 scp_sh.sh
<span class="token parameter variable">-rwxrwxrwx</span> <span class="token number">1</span> lujinkai lujinkai <span class="token number">1440</span> <span class="token number">10</span>月 <span class="token number">13</span> <span class="token number">21</span>:57 sftp-config.json
drwxrwxrwx <span class="token number">3</span> lujinkai lujinkai <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:03 src
-rwxrwxr-x <span class="token number">1</span> lujinkai lujinkai <span class="token number">1211</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">10</span>:55 u_scp_sh.sh
<span class="token punctuation">[</span>root@c71 script<span class="token punctuation">]</span><span class="token variable">$df</span> <span class="token parameter variable">-Th</span> ./
文件系统                           类型  容量  已用  可用 已用% 挂载点
<span class="token number">10.0</span>.0.1:/home/lujinkai/www/script nfs4  117G   37G   74G   <span class="token number">34</span>% /root/www/script</code></pre>

<h4 id="x2F-etc-x2F-fstab-和-autofs"><a href="#x2F-etc-x2F-fstab-和-autofs" class="headerlink" title="&#x2F;etc&#x2F;fstab 和 autofs"></a>&#x2F;etc&#x2F;fstab 和 autofs</h4><p>&#x2F;etc&#x2F;fstab 设置开机自动挂载，系统开机会去读取这个文件，用于挂载本地固定设备，如硬盘</p>
<p>autofs 设置自动挂载，只有当访问挂载点的时候，autofs 才会挂载，过一段时间没有访问，autofs 就会自动卸载设备，用于挂载动态的设备，如光盘、nfs、smb 等文件系统</p>
<h2 id="SAMBA-服务"><a href="#SAMBA-服务" class="headerlink" title="SAMBA 服务"></a>SAMBA 服务</h2><p>官网：<a target="_blank" rel="noopener" href="https://www.samba.org/">https://www.samba.org/</a></p>
<p>相关包：</p>
<ul>
<li>samba 提供 smb 服务器端</li>
<li>samba-client 客户端软件</li>
<li>samba-common 通用软件</li>
<li>cifs-utils smb 客户端工具</li>
<li>samba-winbind 和 AD 相关</li>
</ul>
<p>相关服务进程：</p>
<ul>
<li>smbd 提供 smb(cifs)服务 TCP：139、445</li>
<li>nmbd NetBIOS 名称解析 UDP：137、138，如果不使用计算机名来访问，这个就没用</li>
</ul>
<p>主配置文件：&#x2F;etc&#x2F;samba&#x2F;smb.conf</p>
<p>语法检查: testparm [-v] [&#x2F;etc&#x2F;samba&#x2F;smb.conf]</p>
<p>客户端工具：smbclient、mount.cifs</p>
<h3 id="samba-服务器配置"><a href="#samba-服务器配置" class="headerlink" title="samba 服务器配置"></a>samba 服务器配置</h3><p>&#x2F;etc&#x2F;samba&#x2F;smb.conf 是主配置文件，ini 格式，来自 samba-common 包</p>
<p>分为全局配置[global] 和特定的共享设置，例如[homes]、[printers]等\</p>
<h4 id="smb-conf-中的宏定义"><a href="#smb-conf-中的宏定义" class="headerlink" title="smb.conf 中的宏定义"></a>smb.conf 中的宏定义</h4><pre class="language-bash" data-language="bash"><code class="language-bash">%m 客户端主机的NetBIOS名
%M 客户端主机的FQDN
%H 当前用户家目录路径
%U 当前用户的用户名
%g 当前用户所属组
%h samba服务器的主机名
%L samba服务器的NetBIOS名
%I 客户端主机的IP，是i的大写字母
%T 当前日期和时间
%S 可登录的用户名
<span class="token punctuation">..</span>.</code></pre>

<h4 id="global-全局配置"><a href="#global-全局配置" class="headerlink" title="[global] 全局配置"></a>[global] 全局配置</h4><ul>
<li><p>workgroup：指定工作组名称</p>
</li>
<li><p>server string：主机注释信息</p>
</li>
<li><p>netbios name：指定 NetBIOS 名，可以被 SAMBA 客户端使用，但不支持 ping</p>
<p>注意：netbios name 需要启动 nmb 服务</p>
<p>范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">global</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">workgroup</span> <span class="token punctuation">=</span> <span class="token value attr-value">workgroup</span>
<span class="token key attr-name">netbios name</span> <span class="token punctuation">=</span> <span class="token value attr-value">smbserver # 此设置需要启动nmb服务才可能生效</span></code></pre>
</li>
<li><p>interfaces：指定服务侦听接口和 IP</p>
</li>
<li><p>hosts allow： 允许指定主机访问，可用逗号，空格，或 tab 分隔，默认允许所有主机访问，可以在其他共享独立配置，但是[global]中的设置会覆盖其他共享设置，可以是以下格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">172.16</span>.0.0/24
<span class="token number">172.16</span>.0.0/255.255.255.0
desktop.example.com
.example.com	<span class="token comment"># 以example.com后缀的主机名</span></code></pre>
</li>
<li><p>hosts deny：拒绝指定主机访问，格式和 hosts allow 相同</p>
</li>
<li><p>config file&#x3D;&#x2F;etc&#x2F;samba&#x2F;conf.d&#x2F;%U：用户独立的配置文件</p>
</li>
<li><p>log file&#x3D;&#x2F;var&#x2F;log&#x2F;samba&#x2F;log.%I：不同客户机采用不同日志</p>
</li>
<li><p>log level &#x3D; 2：日志级别，默认为 0，不记录日志</p>
<p>范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">global</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Log file</span><span class="token punctuation">=</span><span class="token value attr-value">/var/log/samba/log.%I</span>
<span class="token key attr-name">log level</span> <span class="token punctuation">=</span> <span class="token value attr-value">2</span></code></pre>
</li>
<li><p>max log size&#x3D;50：日志文件达到 50K，将轮循 rotate，单位 KB</p>
</li>
<li><p>security&#x3D;user：认证方式，有三种</p>
<ul>
<li>user：samba 用户（采有 linux 用户，samba 的独立口令）</li>
<li>share：匿名(CentOS7 不再支持)，已不建议使用</li>
<li>server：已不建议使用</li>
</ul>
</li>
<li><p>passdb backend &#x3D; tdbsam：密码数据库格式</p>
</li>
<li><p>…</p>
</li>
</ul>
<h4 id="特定共享目录配置"><a href="#特定共享目录配置" class="headerlink" title="特定共享目录配置"></a>特定共享目录配置</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>共享名称<span class="token punctuation">]</span> 		 <span class="token comment"># 远程网络看到的共享名称</span>
comment 		<span class="token comment"># 注释信息</span>
path 			<span class="token comment"># 所共享的目录路径</span>
public			<span class="token comment"># 能否被guest访问的共享，默认no，和guest=ok 类似</span>
browsable 		<span class="token comment"># 是否允许所有用户浏览此共享,默认为yes,no为隐藏</span>
<span class="token assign-left variable">writable</span><span class="token operator">=</span>yes 	<span class="token comment"># 可以被所有用户读写，默认为no</span>
<span class="token builtin class-name">read</span> <span class="token assign-left variable">only</span><span class="token operator">=</span>no 	<span class="token comment"># 和writable=yes等价，如与以上设置冲突，放在后面的设置生效，默认只读</span>
<span class="token function">write</span> list		<span class="token comment"># 可读写的用户，可设置为用户或者组，用空格或逗号分隔，用户组有两种格式：@组名、+组名；如果设置writable=no，那write list中的用户和组可读写</span>
valid <span class="token function">users</span> 	<span class="token comment"># 规定合法用户，即能访问该共享的用户，用空格或逗号分隔，如为空，将允许所有</span>
force group		<span class="token comment"># 指定存取资源时须以此设定的群组使用者进入才能存取(用户名/@组名)</span>
force user		<span class="token comment"># 指定存取资源时须以此设定的使用者进入才能存取(用户名/@组名)</span></code></pre>

<p>范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">share</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">path</span> <span class="token punctuation">=</span> <span class="token value attr-value">/data/dir</span>
<span class="token key attr-name">valid users</span><span class="token punctuation">=</span><span class="token value attr-value">wang,@admins</span>
<span class="token key attr-name">writeable</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span>
<span class="token key attr-name">browseable</span> <span class="token punctuation">=</span> <span class="token value attr-value">no</span></code></pre>

<h3 id="samba-用户管理"><a href="#samba-用户管理" class="headerlink" title="samba 用户管理"></a>samba 用户管理</h3><h4 id="smbpasswd-命令"><a href="#smbpasswd-命令" class="headerlink" title="smbpasswd 命令"></a>smbpasswd 命令</h4><p>smbpasswd 用于管理 samba 用户</p>
<p><strong>添加用户：</strong>实际上是把把系统用户映射为 samba 用户，所以添加的用户首先必须是 linux 系统用户</p>
<pre class="language-none"><code class="language-none">smbpasswd -a &lt;user&gt;		# 交互式
pdbedit -a -u &lt;user&gt;</code></pre>

<p><strong>修改用户密码：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">smbpasswd <span class="token operator">&lt;</span>user<span class="token operator">></span>	<span class="token comment"># 交互式</span></code></pre>

<p><strong>删除用户和密码：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">smbpasswd <span class="token parameter variable">-x</span> <span class="token operator">&lt;</span>user<span class="token operator">></span>
pdbedit <span class="token parameter variable">-x</span> <span class="token parameter variable">-u</span> <span class="token operator">&lt;</span>user<span class="token operator">></span>	<span class="token comment"># 这个好像权限更大</span></code></pre>

<p><strong>查看 samba 用户列表：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">pdbedit <span class="token parameter variable">-L</span> <span class="token parameter variable">-v</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 为了方便配置，可以将用户指定同一个组</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span>$ <span class="token function">groupadd</span> <span class="token parameter variable">-r</span> smb
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$useradd</span> <span class="token parameter variable">-G</span> smb <span class="token parameter variable">-s</span> /sbin/nologin smb1
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$useradd</span> <span class="token parameter variable">-G</span> smb <span class="token parameter variable">-s</span> /sbin/nologin smb2

<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$smbpasswd</span> <span class="token parameter variable">-a</span> smb1
New SMB password:
Retype new SMB password:
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$smbpasswd</span> <span class="token parameter variable">-a</span> smb2
New SMB password:
Retype new SMB password:
Added user smb2.

<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$pdbedit</span> <span class="token parameter variable">-L</span>
smb1:1001:
smb2:1002:
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$pdbedit</span> <span class="token parameter variable">-L</span> <span class="token parameter variable">-v</span>
---------------
Unix username:        smb1
NT username:
Account Flags:        <span class="token punctuation">[</span>U          <span class="token punctuation">]</span>
User SID:             S-1-5-21-540276018-2794668495-3753694806-1000
Primary Group SID:    S-1-5-21-540276018-2794668495-3753694806-513
Full Name:
Home Directory:       <span class="token punctuation">\</span><span class="token punctuation">\</span>c71<span class="token punctuation">\</span>smb1
HomeDir Drive:
Logon Script:
Profile Path:         <span class="token punctuation">\</span><span class="token punctuation">\</span>c71<span class="token punctuation">\</span>smb1<span class="token punctuation">\</span>profile
Domain:               C71
Account desc:
Workstations:
Munged dial:
Logon time:           <span class="token number">0</span>
Logoff time:          Wed, 06 Feb <span class="token number">2036</span> <span class="token number">23</span>:06:39 CST
Kickoff time:         Wed, 06 Feb <span class="token number">2036</span> <span class="token number">23</span>:06:39 CST
Password last set:    Sat, <span class="token number">14</span> Nov <span class="token number">2020</span> <span class="token number">17</span>:46:18 CST
Password can change:  Sat, <span class="token number">14</span> Nov <span class="token number">2020</span> <span class="token number">17</span>:46:18 CST
Password must change: never
Last bad password   <span class="token builtin class-name">:</span> <span class="token number">0</span>
Bad password count  <span class="token builtin class-name">:</span> <span class="token number">0</span>
Logon hours         <span class="token builtin class-name">:</span> FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
---------------
Unix username:        smb2
NT username:
Account Flags:        <span class="token punctuation">[</span>U          <span class="token punctuation">]</span>
User SID:             S-1-5-21-540276018-2794668495-3753694806-1001
Primary Group SID:    S-1-5-21-540276018-2794668495-3753694806-513
Full Name:
Home Directory:       <span class="token punctuation">\</span><span class="token punctuation">\</span>c71<span class="token punctuation">\</span>smb2
HomeDir Drive:
Logon Script:
Profile Path:         <span class="token punctuation">\</span><span class="token punctuation">\</span>c71<span class="token punctuation">\</span>smb2<span class="token punctuation">\</span>profile
Domain:               C71
Account desc:
Workstations:
Munged dial:
Logon time:           <span class="token number">0</span>
Logoff time:          Wed, 06 Feb <span class="token number">2036</span> <span class="token number">23</span>:06:39 CST
Kickoff time:         Wed, 06 Feb <span class="token number">2036</span> <span class="token number">23</span>:06:39 CST
Password last set:    Sat, <span class="token number">14</span> Nov <span class="token number">2020</span> <span class="token number">17</span>:46:24 CST
Password can change:  Sat, <span class="token number">14</span> Nov <span class="token number">2020</span> <span class="token number">17</span>:46:24 CST
Password must change: never
Last bad password   <span class="token builtin class-name">:</span> <span class="token number">0</span>
Bad password count  <span class="token builtin class-name">:</span> <span class="token number">0</span>
Logon hours         <span class="token builtin class-name">:</span> FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</code></pre>

<h4 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h4><p>实现不同 samba 用户访问相同的 samba 共享，实现不同的配置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 10.0.0.71 服务端</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> samba
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$groupadd</span> <span class="token parameter variable">-r</span> smb
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$useradd</span> <span class="token parameter variable">-G</span> smb <span class="token parameter variable">-s</span> /sbin/nologin smb1	<span class="token comment"># 注意这里是-G，而不是-g</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$useradd</span> <span class="token parameter variable">-G</span> smb <span class="token parameter variable">-s</span> /sbin/nologin smb2
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$smbpasswd</span> <span class="token parameter variable">-a</span> smb1
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$smbpasswd</span> <span class="token parameter variable">-a</span> smb2
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/samba/smb.conf
<span class="token comment">#在workgroup下加一行</span>
config <span class="token assign-left variable">file</span><span class="token operator">=</span> /etc/samba/conf.d/%U
<span class="token punctuation">[</span>share<span class="token punctuation">]</span>
<span class="token assign-left variable">Path</span><span class="token operator">=</span>/data/dir
Read <span class="token assign-left variable">only</span><span class="token operator">=</span> NO
Guest ok <span class="token operator">=</span> <span class="token function">yes</span>
<span class="token function">write</span> <span class="token assign-left variable">list</span><span class="token operator">=</span>@wheel
<span class="token comment">#针对smb1和smb2用户创建单独的配置文件</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/samba/smb.conf/smb1
<span class="token punctuation">[</span>share<span class="token punctuation">]</span>
<span class="token assign-left variable">Path</span><span class="token operator">=</span>/data/dir1
Read <span class="token assign-left variable">only</span><span class="token operator">=</span> NO 					<span class="token comment"># 等价于writable = yes</span>
Create <span class="token assign-left variable">mask</span><span class="token operator">=</span>0644 				<span class="token comment"># 说明：默认为744</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/samba/smb.conf/smb2
<span class="token punctuation">[</span>share<span class="token punctuation">]</span>
<span class="token assign-left variable">path</span><span class="token operator">=</span>/data/dir2
Read <span class="token assign-left variable">only</span><span class="token operator">=</span> NO
Create <span class="token assign-left variable">mask</span><span class="token operator">=</span>0644
<span class="token comment"># 重启服务</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart smb.service

<span class="token comment"># 10.0.0.72 客户端</span>
<span class="token comment"># 用户smb1，smb2访问share共享目录，看到目录是不同目录</span>
<span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> samba-client cifs-utils
<span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token variable">$smbclient</span> //10.0.0.73/share <span class="token parameter variable">-U</span> smb1%123456
<span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token variable">$smbclient</span> //10.0.0.73/share <span class="token parameter variable">-U</span> smb2%123456

<span class="token comment"># windows：文件管理器输入 \\10.0.0.73\share 回车，然后输入账号密码即可</span></code></pre>

<h2 id="数据的实时同步"><a href="#数据的实时同步" class="headerlink" title="数据的实时同步"></a>数据的实时同步</h2><p>实现实时同步的方法：</p>
<ul>
<li>inotify + rsync</li>
<li>sersync：国人周洋在 inotify 基础上开发的，功能强大，只是已经不再更新了</li>
</ul>
<h3 id="inotify"><a href="#inotify" class="headerlink" title="inotify"></a>inotify</h3><p>异步的文件系统事件监控机制，利用事件驱动机制，而无须通过诸如 cron 等的轮询机制来获取事件，linux 内核从 2.6.13 起支持 inotify，通过 inotify 可以监控文件系统中添加、删除，修改、移动等各种事件</p>
<p>inotify+rsync 使用方式：</p>
<ol>
<li>利用监控服务（inotify），监控同步数据服务器目录中信息的变化</li>
<li>发现目录中数据产生变化，就利用 rsync 服务推送到备份服务器上</li>
<li>利用脚本进行结合</li>
</ol>
<h4 id="inotify-内核参数"><a href="#inotify-内核参数" class="headerlink" title="inotify 内核参数"></a>inotify 内核参数</h4><ul>
<li>max_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错误，默认值:16384， 生产环境建议调大，比如:327679</li>
<li>max_user_instances：每个用户创建 inotify 实例最大值，默认值:128</li>
<li>max_user_watches：可以监视的文件的总数量(inotifywait 单进程)，默认值:8192，建议调大</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@data-centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/sysctl.conf</span>
<span class="token assign-left variable">fs.inotify.max_queued_events</span><span class="token operator">=</span><span class="token number">66666</span>
<span class="token assign-left variable">fs.inotify.max_user_watches</span><span class="token operator">=</span><span class="token number">100000</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#sysctl</span>
<span class="token parameter variable">-p</span>
fs.inotify.max_queued_events <span class="token operator">=</span> <span class="token number">66666</span>
fs.inotify.max_user_watches <span class="token operator">=</span> <span class="token number">100000</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#cat /proc/sys/fs/inotify/*</span>
<span class="token number">66666</span>
<span class="token number">128</span>
<span class="token number">100000</span></code></pre>

<h4 id="inotify-tools"><a href="#inotify-tools" class="headerlink" title="inotify-tools"></a>inotify-tools</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> inotify-tools

<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-ql</span> inotify-tools
<span class="token comment"># 在被监控的文件或目录上等待特定文件系统事件(open、close、delete等)发生，常用于实时同步的目录监控</span>
/usr/bin/inotifywait
<span class="token comment"># 收集被监控的文件系统使用的统计数据，指文件系统事件发生的次数统计</span>
/usr/bin/inotifywatch
<span class="token punctuation">..</span>.</code></pre>

<h5 id="inotifywait"><a href="#inotifywait" class="headerlink" title="inotifywait"></a>inotifywait</h5><pre class="language-bash" data-language="bash"><code class="language-bash">inotifywait <span class="token punctuation">[</span> options <span class="token punctuation">]</span> file1 <span class="token punctuation">[</span> file2 <span class="token punctuation">]</span> <span class="token punctuation">[</span> file3 <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">..</span>. <span class="token punctuation">]</span>

<span class="token comment"># 常用option</span>
-m, --monitor：			始终保持事件监听
-d, --daemon：			以守护进程方式执行,和-m相似,配合-o使用
-r, --recursive：		递归监控目录数据信息变化
-q, --quiet：			输出少量事件信息
<span class="token parameter variable">--exclude</span> <span class="token operator">&lt;</span>pattern<span class="token operator">></span>：	指定排除文件或目录,使用扩展的正则表达式匹配的模式实现
<span class="token parameter variable">--excludei</span> <span class="token operator">&lt;</span>pattern<span class="token operator">></span>：	和exclude相似,不区分大小写
-o, <span class="token parameter variable">--outfile</span> <span class="token operator">&lt;</span>file<span class="token operator">></span>：	打印事件到文件中,相当于标准正确输出,注意:使用绝对路径
-s, --syslogOutput：		发送错误到syslog相当于标准错误输出
<span class="token parameter variable">--timefmt</span> <span class="token operator">&lt;</span>fmt<span class="token operator">></span>：		指定时间输出格式
<span class="token parameter variable">--format</span> <span class="token operator">&lt;</span>fmt<span class="token operator">></span>：			指定的输出格式<span class="token punctuation">;</span>即实际监控输出内容
-e：						指定监听指定的事件,如果省略,表示所有事件都进行监听

<span class="token parameter variable">--timefmt</span> <span class="token string">"%Y-%m-%d %H:%M:%S"</span>
%Y 	<span class="token comment"># 年份信息,包含世纪信息</span>
%y 	<span class="token comment"># 年份信息,不包括世纪信息</span>
%m 	<span class="token comment"># 显示月份,范围 01-12</span>
%d 	<span class="token comment"># 每月的第几天,范围是 01-31</span>
%H 	<span class="token comment"># 小时信息,使用 24小时制,范围 00-23</span>
%M 	<span class="token comment"># 分钟,范围 00-59</span>
%S 	<span class="token comment"># 秒,范例 0-60</span>

<span class="token parameter variable">--format</span> <span class="token string">"%T %w%f event: %;e"</span>
%T 	<span class="token comment"># 输出时间格式中定义的时间格式信息,通过 --timefmt option 语法格式指定时间信息</span>
%w 	<span class="token comment"># 事件出现时,监控文件或目录的名称信息,相当于dirname</span>
%f 	<span class="token comment"># 事件出现时,将显示监控目录下触发事件的文件或目录信息,否则为空,相当于basename</span>
%e 	<span class="token comment"># 显示发生的事件信息,不同的事件默认用逗号分隔</span>
%Xe <span class="token comment"># 显示发生的事件信息,不同的事件指定用X进行分隔</span>

<span class="token parameter variable">-e</span> create,delete,moved_to,close_write,attrib
create 			<span class="token comment">#文件或目录创建</span>
delete 			<span class="token comment">#文件或目录被删除</span>
modify 			<span class="token comment">#文件或目录内容被写入</span>
attrib 			<span class="token comment">#文件或目录属性改变</span>
close_write 	<span class="token comment">#文件或目录关闭,在写入模式打开之后关闭的</span>
close_nowrite 	<span class="token comment">#文件或目录关闭,在只读模式打开之后关闭的</span>
close 			<span class="token comment">#文件或目录关闭,不管读或是写模式</span>
<span class="token function">open</span> 			<span class="token comment">#文件或目录被打开</span>
lsdir 			<span class="token comment">#浏览目录内容</span>
moved_to 		<span class="token comment">#文件或目录被移动到监控的目录中</span>
moved_from 		<span class="token comment">#文件或目录从监控的目录中被移动</span>
move 			<span class="token comment">#文件或目录不管移动到或是移出监控目录都触发事件</span>
access 			<span class="token comment">#文件或目录内容被读取</span>
delete_self 	<span class="token comment">#文件或目录被删除,目录本身被删除</span>
unmount 		<span class="token comment">#取消挂载</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 监控一次性事件</span>
inotifywait /data/www

<span class="token comment"># 持续前台监控</span>
inotifywait <span class="token parameter variable">-mrq</span> /data/www <span class="token parameter variable">--exclude</span><span class="token operator">=</span><span class="token string">".*\.swx|\.swp"</span>

<span class="token comment"># 持续后台监控,并记录日志</span>
inotifywait <span class="token parameter variable">-o</span> /root/inotify.log <span class="token parameter variable">-drq</span> /data/www <span class="token parameter variable">--timefmt</span> <span class="token string">"%Y-%m-%d %H:%M:%S"</span> <span class="token parameter variable">--format</span> <span class="token string">"%T %w%f event: %e"</span>

<span class="token comment">#持续前台监控特定事件</span>
inotifywait <span class="token parameter variable">-mrq</span> /data/www <span class="token parameter variable">--timefmt</span> <span class="token string">"%F %H:%M:%S"</span> <span class="token parameter variable">--format</span> <span class="token string">"%T %w%f event:%;e"</span> <span class="token parameter variable">-e</span> create,delete,moved_to,close_write,attrib</code></pre>

<h5 id="inotifywatch"><a href="#inotifywatch" class="headerlink" title="inotifywatch"></a>inotifywatch</h5><pre class="language-bash" data-language="bash"><code class="language-bash">inotifywatch <span class="token punctuation">[</span> options <span class="token punctuation">]</span> file1 <span class="token punctuation">[</span> file2 <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">..</span>. <span class="token punctuation">]</span></code></pre>

<h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><p>rsync 常用做镜像备份和同步数据，配合计划任务实现定时备份，配合 inotify 可以实现触发式的实时数据同步</p>
<p>官方网站: <a target="_blank" rel="noopener" href="http://rsync.samba.org/">http://rsync.samba.org/</a></p>
<p>软件包：rsync、rsync-daemon(CentOS 8)</p>
<p>服务文件：&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;rsyncd.service</p>
<p>配置文件：&#x2F;etc&#x2F;rsyncd.conf</p>
<p>端口：873&#x2F;tcp</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 源地址 和 目标地址 都在本机</span>
<span class="token function">rsync</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. SRC <span class="token punctuation">[</span>SRC<span class="token punctuation">]</span><span class="token punctuation">..</span>. DEST

<span class="token comment"># 2. 通过远程shell连接</span>
<span class="token function">rsync</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. SRC <span class="token punctuation">[</span>SRC<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span><span class="token environment constant">USER</span>@<span class="token punctuation">]</span>HOST:DEST		<span class="token comment"># pull 推</span>
<span class="token function">rsync</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span><span class="token environment constant">USER</span>@<span class="token punctuation">]</span>HOST:SRC <span class="token punctuation">[</span>DEST<span class="token punctuation">]</span>			<span class="token comment"># push 拉</span>

<span class="token comment"># 3. 连接到rsync守护进程</span>
<span class="token function">rsync</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. SRC <span class="token punctuation">[</span>SRC<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span><span class="token environment constant">USER</span>@<span class="token punctuation">]</span>HOST::DEST 					<span class="token comment"># pull 推</span>
<span class="token function">rsync</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. SRC <span class="token punctuation">[</span>SRC<span class="token punctuation">]</span><span class="token punctuation">..</span>. rsync://<span class="token punctuation">[</span><span class="token environment constant">USER</span>@<span class="token punctuation">]</span>HOST<span class="token punctuation">[</span>:PORT<span class="token punctuation">]</span>/DEST		<span class="token comment"># pull 推</span>
<span class="token function">rsync</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span><span class="token environment constant">USER</span>@<span class="token punctuation">]</span>HOST::SRC <span class="token punctuation">[</span>DEST<span class="token punctuation">]</span>							<span class="token comment"># push 拉</span>
<span class="token function">rsync</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. rsync://<span class="token punctuation">[</span><span class="token environment constant">USER</span>@<span class="token punctuation">]</span>HOST<span class="token punctuation">[</span>:PORT<span class="token punctuation">]</span>/SRC <span class="token punctuation">[</span>DEST<span class="token punctuation">]</span>				<span class="token comment"># push 拉</span>

The <span class="token string">':'</span> usages connect via remote shell, <span class="token keyword">while</span> <span class="token string">'::'</span> <span class="token operator">&amp;</span> <span class="token string">'rsync://'</span> usages connect to an <span class="token function">rsync</span> daemon, and require SRC or DEST to start with a module name.</code></pre>

<p>前两种的本质是通过本地或远程 shell，而第 3 种方式则是让远程主机上运行 rsyncd 服务，使其监听在一个端口上，等待客户端的连接</p>
<p><strong>范例：</strong>备份服务器启动 rsync 的守护进程，然后数据服务器去连接，再进行数据的推送和拉取</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份服务器 10.0.0.71</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start rsyncd.service
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$ss</span> <span class="token parameter variable">-ntl</span>
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     <span class="token number">0</span>      <span class="token number">5</span>                       *:873                                 *:*
LISTEN     <span class="token number">0</span>      <span class="token number">5</span>                    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:873                              <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:*

<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/rsyncd.conf
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>backup<span class="token punctuation">]</span>				<span class="token comment"># bachup 模块</span>
path <span class="token operator">=</span> /data/backup		<span class="token comment"># 备份路径</span>
<span class="token builtin class-name">read</span> only <span class="token operator">=</span> no			<span class="token comment"># 设置可写，默认只读</span>

<span class="token comment"># 查看设置的模块</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$rsync</span> <span class="token number">127.0</span>.0.1::
backup
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$rsync</span> rsync://127.0.0.1
backup

<span class="token comment"># 默认用户以nobody访问此目录，所以给nobody设置读写权限</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$setfacl</span> <span class="token parameter variable">-m</span> u:nobody:rwx /data/backup/

<span class="token comment"># 数据服务器 10.0.0.1</span>
lujinkai@Z510:~$ <span class="token function">rsync</span> rsync://10.0.0.71
backup
lujinkai@Z510:~$ <span class="token function">rsync</span> <span class="token number">10.0</span>.0.71::
backup

<span class="token comment"># 推送，将本机的u_script目录备份到10.0.0.71的/data/backup目录（rsyncd.conf中backup模块设置）</span>
lujinkai@Z510:~/www$ <span class="token function">rsync</span> <span class="token parameter variable">-av</span> ./u_script/ root@10.0.0.71::backup
lujinkai@Z510:~/www$ <span class="token function">rsync</span> <span class="token number">10.0</span>.0.71::backup
drwxrwxr-x          <span class="token number">4,096</span> <span class="token number">2020</span>/11/14 <span class="token number">22</span>:38:48 <span class="token builtin class-name">.</span>
-rwxrwxr-x            <span class="token number">319</span> <span class="token number">2020</span>/11/14 <span class="token number">22</span>:38:48 demo.sh
drwxrwxr-x          <span class="token number">4,096</span> <span class="token number">2020</span>/11/09 <span class="token number">14</span>:52:39 include
<span class="token comment"># 拉取</span>
lujinkai@Z510:~/www$ <span class="token function">rsync</span> <span class="token parameter variable">-av</span> root@10.0.0.71::backup ./u_script/</code></pre>

<p>rsyncd.conf 的格式 参考 <code>man rsyncd.conf</code> 或者 <a target="_blank" rel="noopener" href="https://linux.die.net/man/5/rsyncd.conf">https://linux.die.net/man/5/rsyncd.conf</a></p>
<p>上面的过程都是免密的，我们也可以设置认证</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份服务器 10.0.0.71</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token string">"rsyncuser:123456"</span> <span class="token operator">></span> /etc/rsync.pas
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$chmod</span> <span class="token number">600</span> /etc/rsync.pas
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/rsyncd.conf
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>backup<span class="token punctuation">]</span>
path <span class="token operator">=</span> /data/backup
<span class="token builtin class-name">read</span> only <span class="token operator">=</span> no
auth <span class="token function">users</span> <span class="token operator">=</span> rsyncuser	<span class="token comment"># 默认anonymous可以访问rsync服务器，这里设置只能虚拟用户rsyncuser访问</span>
secrets <span class="token function">file</span> <span class="token operator">=</span> /etc/rsync.pas	<span class="token comment"># 认证文件</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart rsyncd.service	<span class="token comment"># 也可以不重启</span>

<span class="token comment"># 数据服务器 10.0.0.1</span>
<span class="token comment"># 将秘密写入到/etc/rsync.pas，也可以赋值给环境变量 export RSYNC_PASSWORD=123456</span>
lujinkai@Z510:~/www$ <span class="token builtin class-name">echo</span> <span class="token number">123456</span> <span class="token operator">></span> /etc/rsync.pas
<span class="token comment"># 测试,注意这里一定要指定用户名 rsyncuser</span>
lujinkai@Z510:~/www$ <span class="token function">rsync</span> rsyncuser@10.0.0.71::backup
Password:
drwxrwxr-x          <span class="token number">4,096</span> <span class="token number">2020</span>/11/14 <span class="token number">22</span>:38:48 <span class="token builtin class-name">.</span>
-rwxrwxr-x            <span class="token number">319</span> <span class="token number">2020</span>/11/14 <span class="token number">22</span>:38:48 demo.sh
drwxrwxr-x          <span class="token number">4,096</span> <span class="token number">2020</span>/11/09 <span class="token number">14</span>:52:39 include</code></pre>

<h3 id="inotify-rsync-shell-脚本-实现实时数据同步"><a href="#inotify-rsync-shell-脚本-实现实时数据同步" class="headerlink" title="inotify+rsync+shell 脚本 实现实时数据同步"></a>inotify+rsync+shell 脚本 实现实时数据同步</h3><p>备份数据库是：10.0.0.71，inotifywait 监控文件变化，rsync 负责同步数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">SRC</span><span class="token operator">=</span><span class="token string">'/data/www/'</span> <span class="token comment">#注意最后的/</span>
<span class="token assign-left variable">DEST</span><span class="token operator">=</span><span class="token string">'rsyncuser@10.0.0.71::backup'</span>
<span class="token function">rpm</span> <span class="token parameter variable">-q</span> <span class="token function">rsync</span> <span class="token operator">&amp;></span>/dev/null <span class="token operator">||</span> yum <span class="token function">install</span> <span class="token function">rsync</span>
inotifywait <span class="token punctuation">\</span>
    <span class="token parameter variable">-mrq</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--exclude</span><span class="token operator">=</span><span class="token string">".*\.swp"</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--timefmt</span> <span class="token string">'%Y-%m-%d %H:%M:%S'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--format</span> <span class="token string">'%T %w %f'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> create,delete,moved_to,close_write,attrib <span class="token variable">$&#123;SRC&#125;</span> <span class="token operator">|</span>
    <span class="token keyword">while</span> <span class="token builtin class-name">read</span> DATE TIME DIR FILE<span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token assign-left variable">FILEPATH</span><span class="token operator">=</span><span class="token variable">$&#123;DIR&#125;</span><span class="token variable">$&#123;FILE&#125;</span>
        <span class="token function">rsync</span> <span class="token punctuation">\</span>
            <span class="token parameter variable">-az</span> <span class="token punctuation">\</span>
            <span class="token parameter variable">--delete</span> <span class="token punctuation">\</span>
            -password-file<span class="token operator">=</span>/etc/rsync.pas <span class="token variable">$SRC</span> <span class="token variable">$DEST</span> <span class="token operator">&amp;&amp;</span>
            <span class="token builtin class-name">echo</span> <span class="token string">"At <span class="token variable">$&#123;TIME&#125;</span> on <span class="token variable">$&#123;DATE&#125;</span>, file <span class="token variable">$FILEPATH</span> was backuped up via rsync"</span> <span class="token operator">>></span>/var/log/changelist.log
    <span class="token keyword">done</span></code></pre>

<h3 id="sersync-实现实时数据同步"><a href="#sersync-实现实时数据同步" class="headerlink" title="sersync 实现实时数据同步"></a>sersync 实现实时数据同步</h3><p>sersync 虽然快 10 年没更新了，但是还是比较好用的</p>
<p>sersync 项目地址: <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/">https://code.google.com/archive/p/sersync/</a><br>sersync 下载地址: <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/downloads">https://code.google.com/archive/p/sersync/downloads</a></p>
<p>sersync 类似于 inotify，同样用于监控，但它克服了 inotify 的缺点</p>
<p>inotify 最大的不足是会产生重复事件,或者同一个目录下多个文件的操作会产生多个事件,例如,当监控目录中有 5 个文件时,删除目录时会产生 6 个监控事件,从而导致重复调用 rsync 命令。另外比如:vim 文件时,inotify 会监控到临时文件的事件,但这些事件相对于 rsync 来说是不应该被监控的</p>
<p>sersync 优点：</p>
<ul>
<li>c++编写，速度快</li>
<li>对 linux 系统文件系统产生的临时文件和重复的文件操作进行过滤，所以在结合 rsync 同步的时候，节省了运行时耗和网络资源</li>
<li>配置很简单，其中提供了静态编译好的二进制文件和 xml 配置文件，直接使用即可</li>
<li>使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态</li>
<li>有出错处理机制,通过失败队列对出错的文件重新同步,如果仍旧失败,则按设定时长对同步失败的文件重新同步</li>
<li>不仅可以实现实时同步，另外还自带 crontab 功能，只需在 xml 配置文件中开启，即也可以按要求隔一段时间整体同步一次，而无需再额外配置 crontab 功能</li>
<li>可以二次开发</li>
</ul>
<p>sersync 只有两个文件：</p>
<ul>
<li><p>二进制程序文件 sersync2</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:/usr/local/sersync$ ./sersync2 <span class="token parameter variable">-h</span>
<span class="token builtin class-name">set</span> the system param
execute：echo <span class="token number">50000000</span> <span class="token operator">></span> /proc/sys/fs/inotify/max_user_watches
sh: <span class="token number">1</span>: cannot create /proc/sys/fs/inotify/max_user_watches: Permission denied
execute：echo <span class="token number">327679</span> <span class="token operator">></span> /proc/sys/fs/inotify/max_queued_events
sh: <span class="token number">1</span>: cannot create /proc/sys/fs/inotify/max_queued_events: Permission denied
parse the <span class="token builtin class-name">command</span> param
_______________________________________________________
参数-d:启用守护进程模式
参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍
c参数-n: 指定开启守护线程的数量，默认为10个
参数-o:指定配置文件，默认使用confxml.xml文件
参数-m:单独启用其他模块，使用 <span class="token parameter variable">-m</span> refreshCDN 开启刷新CDN模块
参数-m:单独启用其他模块，使用 <span class="token parameter variable">-m</span> socket 开启socket模块
参数-m:单独启用其他模块，使用 <span class="token parameter variable">-m</span> http 开启http模块
不加-m参数，则默认执行同步程序
</code></pre>
</li>
<li><p>配置文件 confxml.xml</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:/usr/local/sersync$ <span class="token function">vim</span> confxml.xml
<span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"1.0"</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">"ISO-8859-1"</span>?<span class="token operator">></span>
<span class="token operator">&lt;</span>head <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"2.5"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>host <span class="token assign-left variable">hostip</span><span class="token operator">=</span><span class="token string">"localhost"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"8008"</span><span class="token operator">></span><span class="token operator">&lt;</span>/host<span class="token operator">></span>
    <span class="token operator">&lt;</span>debug <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span>/<span class="token operator">></span>		<span class="token comment"># 是否开启调试模式</span>
    <span class="token operator">&lt;</span>fileSystem <span class="token assign-left variable">xfs</span><span class="token operator">=</span><span class="token string">"false"</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>filter <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">></span>	<span class="token comment"># 是否开启文件过滤功能</span>
		<span class="token operator">&lt;</span>exclude <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"(.*)\.svn"</span><span class="token operator">></span><span class="token operator">&lt;</span>/exclude<span class="token operator">></span>
		<span class="token operator">&lt;</span>exclude <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"(.*)\.gz"</span><span class="token operator">></span><span class="token operator">&lt;</span>/exclude<span class="token operator">></span>
		<span class="token operator">&lt;</span>exclude <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"^info/*"</span><span class="token operator">></span><span class="token operator">&lt;</span>/exclude<span class="token operator">></span>
		<span class="token operator">&lt;</span>exclude <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"^static/*"</span><span class="token operator">></span><span class="token operator">&lt;</span>/exclude<span class="token operator">></span>
    <span class="token operator">&lt;</span>/filter<span class="token operator">></span>
    <span class="token operator">&lt;</span>inotify<span class="token operator">></span>	<span class="token comment"># 监控的事件</span>
		<span class="token operator">&lt;</span>delete <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"true"</span>/<span class="token operator">></span>
		<span class="token operator">&lt;</span>createFolder <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"true"</span>/<span class="token operator">></span>
		<span class="token operator">&lt;</span>createFile <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span>/<span class="token operator">></span>
		<span class="token operator">&lt;</span>closeWrite <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"true"</span>/<span class="token operator">></span>
		<span class="token operator">&lt;</span>moveFrom <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"true"</span>/<span class="token operator">></span>
		<span class="token operator">&lt;</span>moveTo <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"true"</span>/<span class="token operator">></span>
		<span class="token operator">&lt;</span>attrib <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span>/<span class="token operator">></span>		<span class="token comment"># 修改此行为true，文件属性变化后也会同步</span>
		<span class="token operator">&lt;</span>modify <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>/inotify<span class="token operator">></span>

    <span class="token operator">&lt;</span>sersync<span class="token operator">></span>	<span class="token comment"># rsync命令的配置段</span>
	<span class="token operator">&lt;</span>localpath <span class="token assign-left variable">watch</span><span class="token operator">=</span><span class="token string">"/opt/tongbu"</span><span class="token operator">></span>		<span class="token comment"># 同步的目录</span>
		<span class="token comment"># name是远程rsyncd的模块名，如果下面ssh标签开启了start，name则为远程sehll方式运行的目标目录</span>
	    <span class="token operator">&lt;</span>remote <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token string">"127.0.0.1"</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"tongbu1"</span>/<span class="token operator">></span>
	    <span class="token operator">&lt;</span><span class="token operator">!</span>--<span class="token operator">&lt;</span>remote <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token string">"192.168.8.39"</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"tongbu"</span>/<span class="token operator">></span>--<span class="token operator">></span>
	    <span class="token operator">&lt;</span><span class="token operator">!</span>--<span class="token operator">&lt;</span>remote <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token string">"192.168.8.40"</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"tongbu"</span>/<span class="token operator">></span>--<span class="token operator">></span>
	<span class="token operator">&lt;</span>/localpath<span class="token operator">></span>
	<span class="token operator">&lt;</span>rsync<span class="token operator">></span>
	    <span class="token operator">&lt;</span>commonParams <span class="token assign-left variable">params</span><span class="token operator">=</span><span class="token string">"-artuz"</span>/<span class="token operator">></span>		<span class="token comment"># 指定rsync选项</span>
	    <span class="token operator">&lt;</span>auth <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span> <span class="token assign-left variable">users</span><span class="token operator">=</span><span class="token string">"root"</span> <span class="token assign-left variable">passwordfile</span><span class="token operator">=</span><span class="token string">"/etc/rsync.pas"</span>/<span class="token operator">></span>
	    <span class="token operator">&lt;</span>userDefinedPort <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"874"</span>/<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>-- <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">874</span> --<span class="token operator">></span>
	    <span class="token operator">&lt;</span>timeout <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"100"</span>/<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>-- <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token number">100</span> --<span class="token operator">></span>
	    <span class="token operator">&lt;</span>ssh <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span>/<span class="token operator">></span>	<span class="token comment"># 默认使用rsync daemon运行rsync命令,true为使用远程shell模式</span>
	<span class="token operator">&lt;</span>/rsync<span class="token operator">></span>
	<span class="token comment"># 错误重传及日志文件路径，默认60分钟</span>
	<span class="token operator">&lt;</span>failLog <span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token string">"/tmp/rsync_fail_log.sh"</span> <span class="token assign-left variable">timeToExecute</span><span class="token operator">=</span><span class="token string">"60"</span>/<span class="token operator">></span>
	<span class="token operator">&lt;</span>crontab <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span> <span class="token assign-left variable">schedule</span><span class="token operator">=</span><span class="token string">"600"</span><span class="token operator">></span>	<span class="token comment"># 定时，默认600分钟</span>
	    <span class="token operator">&lt;</span>crontabfilter <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">></span>	<span class="token comment"># 是否开启定时</span>
		<span class="token operator">&lt;</span>exclude <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"*.php"</span><span class="token operator">></span><span class="token operator">&lt;</span>/exclude<span class="token operator">></span>
		<span class="token operator">&lt;</span>exclude <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"info/*"</span><span class="token operator">></span><span class="token operator">&lt;</span>/exclude<span class="token operator">></span>
	    <span class="token operator">&lt;</span>/crontabfilter<span class="token operator">></span>
	<span class="token operator">&lt;</span>/crontab<span class="token operator">></span>
	<span class="token operator">&lt;</span>plugin <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"command"</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>/sersync<span class="token operator">></span>
<span class="token comment">#####################################以下行不需要修改####################################</span>
    <span class="token operator">&lt;</span>plugin <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"command"</span><span class="token operator">></span>
	<span class="token operator">&lt;</span>param <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"/bin/sh"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">""</span> <span class="token assign-left variable">ignoreError</span><span class="token operator">=</span><span class="token string">"true"</span>/<span class="token operator">></span>	<span class="token operator">&lt;</span><span class="token operator">!</span>--prefix /opt/tongbu/mmm.sh suffix--<span class="token operator">></span>
	<span class="token operator">&lt;</span>filter <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">></span>
	    <span class="token operator">&lt;</span>include <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"(.*)\.php"</span>/<span class="token operator">></span>
	    <span class="token operator">&lt;</span>include <span class="token assign-left variable">expression</span><span class="token operator">=</span><span class="token string">"(.*)\.sh"</span>/<span class="token operator">></span>
	<span class="token operator">&lt;</span>/filter<span class="token operator">></span>
    <span class="token operator">&lt;</span>/plugin<span class="token operator">></span>

    <span class="token operator">&lt;</span>plugin <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"socket"</span><span class="token operator">></span>
	<span class="token operator">&lt;</span>localpath <span class="token assign-left variable">watch</span><span class="token operator">=</span><span class="token string">"/opt/tongbu"</span><span class="token operator">></span>
	    <span class="token operator">&lt;</span>deshost <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token string">"192.168.138.20"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"8009"</span>/<span class="token operator">></span>
	<span class="token operator">&lt;</span>/localpath<span class="token operator">></span>
    <span class="token operator">&lt;</span>/plugin<span class="token operator">></span>
    <span class="token operator">&lt;</span>plugin <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"refreshCDN"</span><span class="token operator">></span>
	<span class="token operator">&lt;</span>localpath <span class="token assign-left variable">watch</span><span class="token operator">=</span><span class="token string">"/data0/htdocs/cms.xoyo.com/site/"</span><span class="token operator">></span>
	    <span class="token operator">&lt;</span>cdninfo <span class="token assign-left variable">domainname</span><span class="token operator">=</span><span class="token string">"ccms.chinacache.com"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"80"</span> <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"xxxx"</span> <span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token string">"xxxx"</span>/<span class="token operator">></span>
	    <span class="token operator">&lt;</span>sendurl <span class="token assign-left variable">base</span><span class="token operator">=</span><span class="token string">"http://pic.xoyo.com/cms"</span>/<span class="token operator">></span>
	    <span class="token operator">&lt;</span>regexurl <span class="token assign-left variable">regex</span><span class="token operator">=</span><span class="token string">"false"</span> <span class="token assign-left variable">match</span><span class="token operator">=</span><span class="token string">"cms.xoyo.com/site([/a-zA-Z0-9]*).xoyo.com/images"</span>/<span class="token operator">></span>
	<span class="token operator">&lt;</span>/localpath<span class="token operator">></span>
    <span class="token operator">&lt;</span>/plugin<span class="token operator">></span>
<span class="token operator">&lt;</span>/head<span class="token operator">></span></code></pre></li>
</ul>
<h4 id="基于-rsync-daemon-实现-sersync"><a href="#基于-rsync-daemon-实现-sersync" class="headerlink" title="基于 rsync daemon 实现 sersync"></a>基于 rsync daemon 实现 sersync</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载</span>
lujinkai@Z510:~/www/script/src$ <span class="token function">wget</span> https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz
<span class="token comment"># 解压，可以看到，sersync只有两个文件：二进制程序文件和xml配置文件</span>
lujinkai@Z510:~/www/script/src$ <span class="token function">tar</span> zxvf sersync2.5.4_64bit_binary_stable_final.tar.gz
lujinkai@Z510:~/www/script/src$ <span class="token function">sudo</span> <span class="token function">mv</span> GNU-Linux-x86/ /usr/local/sersync
<span class="token comment"># 添加到环境变量PATH，过程略...</span>
<span class="token comment"># 修改配置文件</span>
lujinkai@Z510:~/www/script/src$ <span class="token builtin class-name">cd</span> /usr/local/sersync/
lujinkai@Z510:/usr/local/sersync$ <span class="token function">vim</span> confxml.xml	<span class="token comment"># 过程略...</span>
<span class="token comment"># 确认安装rsync客户端工具</span>
lujinkai@Z510:/usr/local/sersync$ <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">rsync</span>
<span class="token comment"># 创建连接rsynd服务器的用户密码文件,并必须修改权限</span>
lujinkai@Z510:~$ <span class="token builtin class-name">echo</span> <span class="token number">123456</span> <span class="token operator">></span> /etc/rsync.pas
lujinkai@Z510:~$ <span class="token function">chmod</span> <span class="token number">600</span> /etc/rsync.pas
<span class="token comment"># 以后台方式执行同步</span>
lujinkai@Z510:~$ sersync2 <span class="token parameter variable">-dro</span> /usr/local/sersync/confxml.xml
<span class="token comment"># 如果同步失败,可以手动执行下面命令,观察过程</span>
lujinkai@Z510:~$ <span class="token builtin class-name">cd</span> /data/www <span class="token operator">&amp;&amp;</span> <span class="token function">rsync</span> <span class="token parameter variable">-artuz</span> <span class="token parameter variable">-R</span> <span class="token parameter variable">--delete</span> ./rsyncuser@10.0.0.71::backup --password-file<span class="token operator">=</span>/etc/rsync.pas <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>

<span class="token comment"># sersync支持多实例，监控多个目录时，只需分别配置不同配置文件，然后使用sersync2指定对应配置文件运行</span>
lujinkai@Z510:~$ sersync2 <span class="token parameter variable">-rd</span> <span class="token parameter variable">-o</span> /etc/sersync.d/nginx.xml</code></pre>

<h4 id="基于远程-shell-实现-sersync"><a href="#基于远程-shell-实现-sersync" class="headerlink" title="基于远程 shell 实现 sersync"></a>基于远程 shell 实现 sersync</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 首先配置ssh基于key的自动验证，过程略...</span>
<span class="token comment"># 修改配置文件 confxml.xml</span>
<span class="token operator">&lt;</span>localpath <span class="token assign-left variable">watch</span><span class="token operator">=</span><span class="token string">"/data/www"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>remote <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token string">"备份服务器IP"</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"/data/backup"</span>/<span class="token operator">></span> <span class="token comment">#修改此行指定备份服务器地址和备份目标目录</span>
<span class="token operator">&lt;</span>/localpath<span class="token operator">></span>
<span class="token punctuation">..</span>.
<span class="token operator">&lt;</span>ssh <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">"true"</span>/<span class="token operator">></span>		<span class="token comment"># 开启ssh</span>

<span class="token comment"># 不需要配置/etc/rsync.pas，其他步骤和上面一样</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%97%A5%E5%BF%97/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%97%A5%E5%BF%97/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">日志服务管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:35:19" itemprop="dateCreated datePublished" datetime="2020-12-09T23:35:19+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%97%A5%E5%BF%97/" itemprop="url" rel="index"><span itemprop="name">日志</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="系统日志"><a href="#系统日志" class="headerlink" title="系统日志"></a>系统日志</h2><p>将系统和应用发生的事件记录至日志中，以助于排错和分析使用：</p>
<p>日志记录的内容包括：</p>
<ul>
<li>历史事件：事件、地点、人物、事件</li>
<li>日志级别：事件的关键程度 LogLevel</li>
</ul>
<p>各种系统日志服务</p>
<ul>
<li>sysklogd：CentOS 5 之前版本采用的日志管理系统服务</li>
<li>rsyslog：CentOS 6 以后版本的系统管理服务<ul>
<li>多线程</li>
<li>UDP、TCP、SSL、TLS、RELP</li>
<li>MySQL、PGSQL、Oracle 实现日志存储</li>
<li>强大的过滤器，可实现过滤记录日志信息中任意部分</li>
<li>自定义输出格式</li>
</ul>
</li>
<li>ELK：Elasticsearch + Logstash + Kibana</li>
</ul>
<h3 id="常见日志文件"><a href="#常见日志文件" class="headerlink" title="常见日志文件"></a>常见日志文件</h3><ul>
<li>&#x2F;var&#x2F;log&#x2F;secure：系统安全日志，文本格式，应周期性分析</li>
<li>&#x2F;var&#x2F;log&#x2F;btmp：当前系统上，用户的失败尝试登录相关的日志信息，二进制格式，lastb 命令进行查看</li>
<li>&#x2F;var&#x2F;log&#x2F;wtmp：当前系统上，用户正常登录系统的相关日志信息，二进制格式，last 命令可以查看</li>
<li>&#x2F;var&#x2F;log&#x2F;lastlog：每一个用户最近一次的登录信息，二进制格式，lastlog 命令可以查看</li>
<li>&#x2F;var&#x2F;log&#x2F;dmesg：CentOS7 之前版本系统引导过程中的日志信息，文本格式，开机后的硬件变化将不再记录专用命令 dmesg 查看，可持续记录硬件变化的情况</li>
<li>&#x2F;var&#x2F;log&#x2F;boot.log：系统服务启动的相关信息，文本格式</li>
<li>&#x2F;var&#x2F;log&#x2F;messages ：系统中大部分的信息</li>
<li>&#x2F;var&#x2F;log&#x2F;anaconda : anaconda 的日志</li>
</ul>
<h2 id="rsyslog"><a href="#rsyslog" class="headerlink" title="rsyslog"></a>rsyslog</h2><p>facility：设施，或者叫设备，从功能或程序上对日志进行归类</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">auth、authpriv、cron、daemon、ftp、kern、lpr、mail、news、security<span class="token punctuation">(</span>auth<span class="token punctuation">)</span>、user、uucp、syslog

auth            <span class="token comment"># pam产生的日志</span>
authpriv        <span class="token comment"># ssh,ftp等登录信息的验证信息</span>
<span class="token function">cron</span>            <span class="token comment"># 时间任务相关</span>
kern            <span class="token comment"># 内核</span>
<span class="token function">lpr</span>             <span class="token comment"># 打印</span>
mail            <span class="token comment"># 邮件</span>
mark<span class="token punctuation">(</span>syslog<span class="token punctuation">)</span>    <span class="token comment"># rsyslog服务内部的信息,时间标识</span>
news            <span class="token comment"># 新闻组</span>
user            <span class="token comment"># 用户程序产生的相关信息</span>
uucp            <span class="token comment"># unix to unix copy, unix主机之间相关的通讯</span>

local0-local7 	<span class="token comment"># 自定义的日志设施</span></code></pre>

<p>priority：优先级别，从低到高排序</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">debug、info、notice、warn<span class="token punctuation">(</span>warning<span class="token punctuation">)</span>、err<span class="token punctuation">(</span>error<span class="token punctuation">)</span>、crit<span class="token punctuation">(</span>critical<span class="token punctuation">)</span>、alert、emerg<span class="token punctuation">(</span>panic<span class="token punctuation">)</span>

debug   <span class="token comment"># 有调式信息的，日志信息最多</span>
info    <span class="token comment"># 一般信息的日志，最常用</span>
notice  <span class="token comment"># 最具有重要性的普通条件的信息</span>
warning <span class="token comment"># 警告级别</span>
err     <span class="token comment"># 错误级别，阻止某个功能或者模块不能正常工作的信息</span>
crit    <span class="token comment"># 严重级别，阻止整个系统或者整个软件不能正常工作的信息</span>
alert   <span class="token comment"># 需要立刻修改的信息</span>
emerg   <span class="token comment"># 内核崩溃等严重信息</span>
none    <span class="token comment"># 什么都不记录</span></code></pre>

<p>参看帮助： <code>man 3 syslog</code>，<code>man logger</code></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件：&#x2F;etc&#x2F;rsyslog.conf 和 &#x2F;etc&#x2F;rsyslog.d&#x2F;*</p>
<p>&#x2F;etc&#x2F;rsyslog.conf 配置文件格式，由三部分组成：</p>
<ul>
<li>MODULES：相关模块配置</li>
<li>GLOBAL DIRECTIVES：全局配置</li>
<li>RULES：日志记录相关的规则配置</li>
</ul>
<p>RULES 配置格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设施.优先级; 设施.优先级; 设施.优先级...    目标</span>
facility.priority<span class="token punctuation">;</span> facility.priority<span class="token punctuation">..</span>. target


<span class="token comment"># facility 格式：</span>
*	<span class="token comment"># 所有的facility</span>
facility1,facility2,facility3,<span class="token punctuation">..</span>.	<span class="token comment"># 指定的facility列表</span>

<span class="token comment"># priority 格式：</span>
*			<span class="token comment"># 所有级别</span>
none		<span class="token comment"># 没有级别，即不记录</span>
PRIORITY	<span class="token comment"># 指定级别（含）以上的所有级别</span>
<span class="token operator">=</span>PRIORITY	<span class="token comment"># 仅记录指定级别的日志信息</span>

<span class="token comment"># target 格式：</span>
文件路径			<span class="token comment"># 通常在/var/log/目录下，文件路径前的-表示异步写入</span>
用户				<span class="token comment"># 将日志事件通知给指定的用户，*表示登录的所有用户</span>
日志服务器			<span class="token comment"># @host：日志发送到指定的远程UDP日志服务器；@@host：日志发送到指定的远程TCP日志服务器</span>
管道				<span class="token comment"># | command：转发给其他命令处理</span></code></pre>

<p>日志文件有很多，如：&#x2F;var&#x2F;log&#x2F;message、cron、secure 等，基本格式都是类似的，如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">事件产生的日期时间	主机	进程<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>：事件内容</code></pre>

<p>范例：将 ssh 服务的日志记录到自定义的 local 的日志设备</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改sshd的配置，然后 Service sshd reload 重启</span>
Vim /etc/ssh/sshd_config
SyslogFacility local2

<span class="token comment"># 修改rsyslog的配置，然后 Systemctl restart rsyslog 重启</span>
Vim /etc/rsyslog.conf
Local2.* /var/log/sshd.log

<span class="token comment"># 测试</span>
Ssh登录后，查看/var/log/sshd.log有记录

<span class="token comment">#logger测试</span>
logger <span class="token parameter variable">-p</span> local2.info <span class="token string">"hello sshd"</span>
<span class="token function">tail</span> /var/log/sshd.log有记录</code></pre>

<h3 id="启用网络日志服务"><a href="#启用网络日志服务" class="headerlink" title="启用网络日志服务"></a>启用网络日志服务</h3><p>启用网络日志服务功能，可以将多个远程主机的日志，发送到集中的日志服务器，方便统一管理。</p>
<p>范例：启用网络日志功能</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># centos8</span>
module<span class="token punctuation">(</span>load<span class="token operator">=</span><span class="token string">"imudp"</span><span class="token punctuation">)</span>			<span class="token comment"># udp</span>
input<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">"imudp"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"514"</span><span class="token punctuation">)</span>
module<span class="token punctuation">(</span>load<span class="token operator">=</span><span class="token string">"imtcp"</span><span class="token punctuation">)</span>			<span class="token comment"># tcp</span>
input<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">"imtcp"</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"514"</span><span class="token punctuation">)</span>

<span class="token comment"># centos6、7</span>
<span class="token variable">$ModLoad</span> imudp			<span class="token comment"># udp</span>
<span class="token variable">$UDPServerRun</span> <span class="token number">514</span>
<span class="token variable">$ModLoad</span> imtcp			<span class="token comment"># tcp</span>
<span class="token variable">$InputTCPServerRun</span> <span class="token number">514</span>


<span class="token comment"># 测试：在客户端指定将日志发送到远程的TCP、UDP的日志服务器</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/rsyslog.conf</span>
*.info<span class="token punctuation">;</span>mail.none<span class="token punctuation">;</span>authpriv.none<span class="token punctuation">;</span>cron.none	/var/log/messages
*.info<span class="token punctuation">;</span>mail.none<span class="token punctuation">;</span>authpriv.none<span class="token punctuation">;</span>cron.none	@@10.0.0.18			<span class="token comment"># tcp</span>
*.info<span class="token punctuation">;</span>mail.none<span class="token punctuation">;</span>authpriv.none<span class="token punctuation">;</span>cron.none	@10.0.0.18			<span class="token comment"># udp</span></code></pre>

<h3 id="logger-命令"><a href="#logger-命令" class="headerlink" title="logger 命令"></a>logger 命令</h3><p>logger 命令可以往系统日志中写入信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">logger <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>message<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$logger</span> <span class="token parameter variable">--help</span>

Usage:
 logger <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>message<span class="token operator">></span><span class="token punctuation">]</span>

Enter messages into the system log.

Options:
 <span class="token parameter variable">-i</span>                       log the logger command's PID
     --id<span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>id<span class="token operator">></span><span class="token punctuation">]</span>          log the given <span class="token operator">&lt;</span>id<span class="token operator">></span>, or otherwise the PID
 -f, <span class="token parameter variable">--file</span> <span class="token operator">&lt;</span>file<span class="token operator">></span>        log the contents of this <span class="token function">file</span>
 -e, --skip-empty         <span class="token keyword">do</span> not log empty lines when processing files
     --no-act             <span class="token keyword">do</span> everything except the <span class="token function">write</span> the log
 -p, <span class="token parameter variable">--priority</span> <span class="token operator">&lt;</span>prio<span class="token operator">></span>    mark given message with this priority
     --octet-count        use rfc6587 octet counting
     --prio-prefix        <span class="token function">look</span> <span class="token keyword">for</span> a prefix on every line <span class="token builtin class-name">read</span> from stdin
 -s, <span class="token parameter variable">--stderr</span>             output message to standard error as well
 -S, <span class="token parameter variable">--size</span> <span class="token operator">&lt;</span>size<span class="token operator">></span>        maximum size <span class="token keyword">for</span> a single message
 -t, <span class="token parameter variable">--tag</span> <span class="token operator">&lt;</span>tag<span class="token operator">></span>          mark every line with this tag
 -n, <span class="token parameter variable">--server</span> <span class="token operator">&lt;</span>name<span class="token operator">></span>      <span class="token function">write</span> to this remote syslog server
 -P, <span class="token parameter variable">--port</span> <span class="token operator">&lt;</span>port<span class="token operator">></span>        use this port <span class="token keyword">for</span> UDP or TCP connection
 -T, <span class="token parameter variable">--tcp</span>                use TCP only
 -d, <span class="token parameter variable">--udp</span>                use UDP only
     <span class="token parameter variable">--rfc3164</span>            use the obsolete BSD syslog protocol
     --rfc5424<span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>snip<span class="token operator">></span><span class="token punctuation">]</span>   use the syslog protocol <span class="token punctuation">(</span>the default <span class="token keyword">for</span> remote<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token operator">&lt;</span>snip<span class="token operator">></span> can be notime, or notq, and/or nohost
     --sd-id <span class="token operator">&lt;</span>id<span class="token operator">></span>         rfc5424 structured data ID
     --sd-param <span class="token operator">&lt;</span>data<span class="token operator">></span>    rfc5424 structured data <span class="token assign-left variable">name</span><span class="token operator">=</span>value
     <span class="token parameter variable">--msgid</span> <span class="token operator">&lt;</span>msgid<span class="token operator">></span>      <span class="token builtin class-name">set</span> rfc5424 message <span class="token function">id</span> field
 -u, <span class="token parameter variable">--socket</span> <span class="token operator">&lt;</span>socket<span class="token operator">></span>    <span class="token function">write</span> to this Unix socket
     --socket-errors<span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>on<span class="token operator">|</span>off<span class="token operator">|</span>auto<span class="token operator">></span><span class="token punctuation">]</span>
                          print connection errors when using Unix sockets
     --journald<span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>file<span class="token operator">></span><span class="token punctuation">]</span>  <span class="token function">write</span> journald entry

 -h, <span class="token parameter variable">--help</span>               display this <span class="token builtin class-name">help</span>
 -V, <span class="token parameter variable">--version</span>            display version

For <span class="token function">more</span> details see logger<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>.</code></pre>

<h3 id="日志管理工具-journalctl"><a href="#日志管理工具-journalctl" class="headerlink" title="日志管理工具 journalctl"></a>日志管理工具 journalctl</h3><p>CentOS7 以后版本利用 Systemd 统一管理所有 Unit 的启动日志。带来的好处就是，可以只用 journalctl 一个命令，查看所有日志（内核日志和应用日志）</p>
<p>配置文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/systemd/journald.conf</code></pre>

<p>命令格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">journalctl <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>MATCHES<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<p>OPTIONS：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">--no-full, --full, <span class="token parameter variable">-l</span>
  如果字段内容超长则以省略号<span class="token punctuation">(</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>截断以适应列宽。
  默认显示完整的字段内容<span class="token punctuation">(</span>超长的部分换行显示或者被分页工具截断<span class="token punctuation">)</span>。
  老旧的 -l/--full 选项 仅用于撤销已有的 --no-full 选项，除此之外没有其他用处。
-a, <span class="token parameter variable">--all</span>
  完整显示所有字段内容， 即使其中包含不可打印字符或者字段内容超长。
-f, <span class="token parameter variable">--follow</span>
  只显示最新的日志项，并且不断显示新生成的日志项。 此选项隐含了 <span class="token parameter variable">-n</span> 选项。
-e, --pager-end
  在分页工具内立即跳转到日志的尾部。 此选项隐含了 <span class="token parameter variable">-n1000</span> 以确保分页工具不必缓存太多的日志行。 不过这个隐含的行数可以被明确设置的 <span class="token parameter variable">-n</span> 选项覆盖。 注意，此选项仅可用于 less<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 分页器。
-n, <span class="token parameter variable">--lines</span><span class="token operator">=</span>
  限制显示最新的日志行数。 --pager-end 与 <span class="token parameter variable">--follow</span> 隐含了此选项。
  此选项的参数：若为正整数则表示最大行数； 若为 <span class="token string">"all"</span> 则表示不限制行数；
  若不设参数则表示默认值10行。
--no-tail
  显示所有日志行， 也就是用于撤销已有的 <span class="token parameter variable">--lines</span><span class="token operator">=</span> 选项<span class="token punctuation">(</span>即使与 <span class="token parameter variable">-f</span> 连用<span class="token punctuation">)</span>。
-r, <span class="token parameter variable">--reverse</span>
  反转日志行的输出顺序， 也就是最先显示最新的日志。
-o, <span class="token parameter variable">--output</span><span class="token operator">=</span>
  控制日志的输出格式。 可以使用如下选项：
  short
    这是默认值， 其输出格式与传统的 syslog<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 文件的格式相似， 每条日志一行。
  short-iso
    与 short 类似，只是将时间戳字段以 ISO <span class="token number">8601</span> 格式显示。
  short-precise
    与 short 类似，只是将时间戳字段的秒数精确到微秒级别。
  short-monotonic
    与 short 类似，只是将时间戳字段的零值从内核启动时开始计算。
  short-unix
    与 short 类似，只是将时间戳字段显示为从<span class="token string">"UNIX时间原点"</span><span class="token punctuation">(</span><span class="token number">1970</span>-1-1 00:00:00 UTC<span class="token punctuation">)</span>以来的秒数。 精确到微秒级别。
  verbose
    以结构化的格式显示每条日志的所有字段。
  <span class="token builtin class-name">export</span>
    将日志序列化为二进制字节流<span class="token punctuation">(</span>大部分依然是文本<span class="token punctuation">)</span> 以适用于备份与网络传输<span class="token punctuation">(</span>详见Journal Export Format<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> 文档<span class="token punctuation">)</span>。
  json
    将日志项按照JSON数据结构格式化， 每条日志一行<span class="token punctuation">(</span>详见 Journal JSON Format<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>文档<span class="token punctuation">)</span>。
  json-pretty
    将日志项按照JSON数据结构格式化， 但是每个字段一行， 以便于人类阅读。
  json-sse
    将日志项按照JSON数据结构格式化，每条日志一行，但是用大括号包围， 以适应 Server-Sent Events<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> 的要求。
  <span class="token function">cat</span>
    仅显示日志的实际内容， 而不显示与此日志相关的任何元数据<span class="token punctuation">(</span>包括时间戳<span class="token punctuation">)</span>。
<span class="token parameter variable">--utc</span>
  以世界统一时间<span class="token punctuation">(</span>UTC<span class="token punctuation">)</span>表示时间
--no-hostname
  不显示来源于本机的日志消息的主机名字段。 此选项仅对 short 系列输出格式<span class="token punctuation">(</span>见上文<span class="token punctuation">)</span>有效。
-x, <span class="token parameter variable">--catalog</span>
  在日志的输出中增加一些解释性的短文本， 以帮助进一步说明日志的含义、问题的解决方案、支持论坛、 开发文档、以及其他任何内容。
  并非所有日志都有这些额外的帮助文本， 详见 Message Catalog Developer Documentation<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> 文档。
  注意，如果要将日志输出用于bug报告， 请不要使用此选项。
-q, <span class="token parameter variable">--quiet</span>
  当以普通用户身份运行时， 不显示任何警告信息与提示信息。例如：<span class="token string">"-- Logs begin at ..."</span>, <span class="token string">"-- Reboot --"</span>
-m, <span class="token parameter variable">--merge</span>
  混合显示包括远程日志在内的所有可见日志。
<span class="token parameter variable">-b</span> <span class="token punctuation">[</span>ID<span class="token punctuation">]</span><span class="token punctuation">[</span>±offset<span class="token punctuation">]</span>, <span class="token parameter variable">--boot</span><span class="token operator">=</span><span class="token punctuation">[</span>ID<span class="token punctuation">]</span><span class="token punctuation">[</span>±offset<span class="token punctuation">]</span>
  显示特定于某次启动的日志， 这相当于添加了一个 <span class="token string">"_BOOT_ID="</span> 匹配条件。
  如果参数为空<span class="token punctuation">(</span>也就是 ID 与 ±offset 都未指定<span class="token punctuation">)</span>， 则表示仅显示本次启动的日志。
  如果省略了 ID ， 那么当 ±offset 是正数的时候， 将从日志头开始正向查找，否则<span class="token punctuation">(</span>也就是为负数或零<span class="token punctuation">)</span>将从日志尾开始反响查找。 举例来说， <span class="token string">"-b 1"</span>表示按时间顺序排列最早的那次启动， <span class="token string">"-b 2"</span>则表示在时间上第二早的那次启动； <span class="token string">"-b -0"</span>表示最后一次启动， <span class="token string">"-b -1"</span>表示在时间上第二近的那次启动， 以此类推。 如果 ±offset 也省略了， 那么相当于<span class="token string">"-b -0"</span>， 除非本次启动不是最后一次启动<span class="token punctuation">(</span>例如用--directory 指定了另外一台主机上的日志目录<span class="token punctuation">)</span>。如果指定了32字符的 ID ， 那么表示以此 ID 所代表的那次启动为基准计算偏移量<span class="token punctuation">(</span>±offset<span class="token punctuation">)</span>， 计算方法同上。 换句话说， 省略 ID 表示以本次启动为基准计算偏移量<span class="token punctuation">(</span>±offset<span class="token punctuation">)</span>。
--list-boots
  列出每次启动的 序号<span class="token punctuation">(</span>也就是相对于本次启动的偏移量<span class="token punctuation">)</span>、32字符的ID、第一条日志的时间戳、最后一条日志的时间戳。
-k, <span class="token parameter variable">--dmesg</span>
  仅显示内核日志。隐含了 <span class="token parameter variable">-b</span> 选项以及 <span class="token string">"_TRANSPORT=kernel"</span> 匹配项。
-t, <span class="token parameter variable">--identifier</span><span class="token operator">=</span>SYSLOG_IDENTIFIER
  仅显示 syslog<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 识别符为 SYSLOG_IDENTIFIER 的日志项。
  可以多次使用该选项以指定多个识别符。
-u, <span class="token parameter variable">--unit</span><span class="token operator">=</span>UNIT<span class="token operator">|</span>PATTERN
  仅显示属于特定单元的日志。 也就是单元名称正好等于 UNIT 或者符合 PATTERN 模式的单元。 这相当于添加了一个 <span class="token string">"_SYSTEMD_UNIT=UNIT"</span> 匹配项<span class="token punctuation">(</span>对于 UNIT 来说<span class="token punctuation">)</span>，或一组匹配项<span class="token punctuation">(</span>对于 PATTERN 来说<span class="token punctuation">)</span>。可以多次使用此选项以添加多个并列的匹配条件<span class="token punctuation">(</span>相当于用<span class="token string">"OR"</span>逻辑连接<span class="token punctuation">)</span>。
--user-unit<span class="token operator">=</span>
  仅显示属于特定用户会话单元的日志。 相当于同时添加了 <span class="token string">"_SYSTEMD_USER_UNIT="</span> 与
<span class="token string">"_UID="</span> 两个匹配条件。
  可以多次使用此选项以添加多个并列的匹配条件<span class="token punctuation">(</span>相当于用<span class="token string">"OR"</span>逻辑连接<span class="token punctuation">)</span>。
-p, <span class="token parameter variable">--priority</span><span class="token operator">=</span>
  根据日志等级<span class="token punctuation">(</span>包括等级范围<span class="token punctuation">)</span>过滤输出结果。 日志等级数字与其名称之间的对应关系如下 <span class="token punctuation">(</span>参见 syslog<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">))</span>： <span class="token string">"emerg"</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>, <span class="token string">"alert"</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, <span class="token string">"crit"</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>, <span class="token string">"err"</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>,<span class="token string">"warning"</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>, <span class="token string">"notice"</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>, <span class="token string">"info"</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>, <span class="token string">"debug"</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> 。
  若设为一个单独的数字或日志等级名称， 则表示仅显示小于或等于此等级的日志<span class="token punctuation">(</span>也就是重要程度等于或高于此等级的日志<span class="token punctuation">)</span>。 若使用 FROM<span class="token punctuation">..</span>TO<span class="token punctuation">..</span> 设置一个范围，则表示仅显示指定的等级范围内<span class="token punctuation">(</span>含两端<span class="token punctuation">)</span>的日志。 此选项相当于添加了 <span class="token string">"PRIORITY="</span>匹配条件。
-c, <span class="token parameter variable">--cursor</span><span class="token operator">=</span>
  从指定的游标<span class="token punctuation">(</span>cursor<span class="token punctuation">)</span>开始显示日志。
  <span class="token punctuation">[</span>提示<span class="token punctuation">]</span>每条日志都有一个<span class="token string">"__CURSOR"</span>字段，类似于该条日志的指纹。
--after-cursor<span class="token operator">=</span>
  从指定的游标<span class="token punctuation">(</span>cursor<span class="token punctuation">)</span>之后开始显示日志。 如果使用了 --show-cursor 选项，则也会显示游标本身。
--show-cursor
  在最后一条日志之后显示游标， 类似下面这样，以<span class="token string">"--"</span>开头：
-- cursor: <span class="token assign-left variable">s</span><span class="token operator">=</span>0639<span class="token punctuation">..</span>.
  游标的具体格式是私有的<span class="token punctuation">(</span>也就是没有公开的规范<span class="token punctuation">)</span>， 并且会变化。
-S, <span class="token parameter variable">--since</span><span class="token operator">=</span>, -U, <span class="token parameter variable">--until</span><span class="token operator">=</span>
  显示晚于指定时间<span class="token punctuation">(</span>--since<span class="token operator">=</span><span class="token punctuation">)</span>的日志、显示早于指定时间<span class="token punctuation">(</span>--until<span class="token operator">=</span><span class="token punctuation">)</span>的日志。
  参数的格式类似 <span class="token string">"2012-10-30 18:17:16"</span> 这样。 如果省略了<span class="token string">"时:分:秒"</span>部分，则相当于设为 <span class="token string">"00:00:00"</span> 。 如果仅省略了<span class="token string">"秒"</span>的部分则相当于设为 <span class="token string">":00"</span> 。如果省略了<span class="token string">"年-月-日"</span>部分， 则相当于设为当前日期。 除了<span class="token string">"年-月-日 时:分:秒"</span>格式，参数还可以进行如下设置：
  <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>设为 <span class="token string">"yesterday"</span>, <span class="token string">"today"</span>, <span class="token string">"tomorrow"</span>以表示那一天的零点<span class="token punctuation">(</span>00:00:00<span class="token punctuation">)</span>。
  <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>设为 <span class="token string">"now"</span> 以表示当前时间。
  <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>可以在<span class="token string">"年-月-日 时:分:秒"</span>前加上 <span class="token string">"-"</span><span class="token punctuation">(</span>前移<span class="token punctuation">)</span> 或 <span class="token string">"+"</span><span class="token punctuation">(</span>后移<span class="token punctuation">)</span>前缀以表示相对于当前时间的偏移。 关于时间与日期的详细规范， 参见systemd.time<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
-F, <span class="token parameter variable">--field</span><span class="token operator">=</span>
  显示所有日志中某个字段的所有可能值。 <span class="token punctuation">[</span>译者注<span class="token punctuation">]</span>类似于SQL语句：<span class="token string">"SELECT DISTINCT 某字段 FROM 全部日志"</span>
-N, <span class="token parameter variable">--fields</span>
  输出所有日志字段的名称
--system, <span class="token parameter variable">--user</span>
  仅显示系统服务与内核的日志<span class="token punctuation">(</span>--system<span class="token punctuation">)</span>、 仅显示当前用户的日志<span class="token punctuation">(</span>--user<span class="token punctuation">)</span>。
  如果两个选项都未指定，则显示当前用户的所有可见日志。
-M, <span class="token parameter variable">--machine</span><span class="token operator">=</span>
  显示来自于正在运行的、特定名称的本地容器的日志。 参数必须是一个本地容器的名称。
<span class="token parameter variable">-D</span> DIR, <span class="token parameter variable">--directory</span><span class="token operator">=</span>DIR
  仅显示来自于特定目录中的日志， 而不是默认的运行时和系统日志目录中的日志。
<span class="token parameter variable">--file</span><span class="token operator">=</span>GLOB
  GLOB 是一个可以包含<span class="token string">"?"</span>与<span class="token string">"*"</span>的文件路径匹配模式。 表示仅显示来自与指定的 GLOB模式匹配的文件中的日志， 而不是默认的运行时和系统日志目录中的日志。可以多次使用此选项以指定多个匹配模式<span class="token punctuation">(</span>多个模式之间用<span class="token string">"OR"</span>逻辑连接<span class="token punctuation">)</span>。
<span class="token parameter variable">--root</span><span class="token operator">=</span>ROOT
  在对日志进行操作时， 将 ROOT 视为系统的根目录。 例如 --update-catalog 将会创建ROOT/var/lib/systemd/catalog/database
--new-id128
  此选项并不用于显示日志内容， 而是用于重新生成一个标识日志分类的 <span class="token number">128</span>-bit ID 。
  此选项的目的在于 帮助开发者生成易于辨别的日志消息， 以方便调试。
<span class="token parameter variable">--header</span>
  此选项并不用于显示日志内容， 而是用于显示日志文件内部的头信息<span class="token punctuation">(</span>类似于元数据<span class="token punctuation">)</span>。
--disk-usage
  此选项并不用于显示日志内容，而是用于显示所有日志文件<span class="token punctuation">(</span>归档文件与活动文件<span class="token punctuation">)</span>的磁盘占用总量。
--vacuum-size<span class="token operator">=</span>, --vacuum-time<span class="token operator">=</span>, --vacuum-files<span class="token operator">=</span>
  这些选项并不用于显示日志内容，而是用于清理日志归档文件<span class="token punctuation">(</span>并不清理活动的日志文件<span class="token punctuation">)</span>， 以释放磁盘空间。
--vacuum-size<span class="token operator">=</span> 可用于限制归档文件的最大磁盘使用量 <span class="token punctuation">(</span>可以使用 <span class="token string">"K"</span>, <span class="token string">"M"</span>, <span class="token string">"G"</span>, <span class="token string">"T"</span>后缀<span class="token punctuation">)</span>；
--vacuum-time<span class="token operator">=</span> 可用于清除指定时间之前的归档 <span class="token punctuation">(</span>可以使用 <span class="token string">"s"</span>, <span class="token string">"m"</span>, <span class="token string">"h"</span>,<span class="token string">"days"</span>, <span class="token string">"weeks"</span>, <span class="token string">"months"</span>, <span class="token string">"years"</span> 后缀<span class="token punctuation">)</span>；
--vacuum-files<span class="token operator">=</span> 可用于限制日志归档文件的最大数量。 注意，--vacuum-size<span class="token operator">=</span> 对 --disk-usage的输出仅有间接效果， 因为 --disk-usage 输出的是归档日志与活动日志的总量。同样，--vacuum-files<span class="token operator">=</span> 也未必一定会减少日志文件的总数，因为它同样仅作用于归档文件而不会删除活动的日志文件。此三个选项可以同时使用，以同时从三个维度去限制归档文件。若将某选项设为零，则表示取消此选项的限制。
--list-catalog <span class="token punctuation">[</span><span class="token number">128</span>-bit-ID<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
  简要列出日志分类信息， 其中包括对分类信息的简要描述。
  如果明确指定了分类ID<span class="token punctuation">(</span><span class="token number">128</span>-bit-ID<span class="token punctuation">)</span>， 那么仅显示指定的分类。
--dump-catalog <span class="token punctuation">[</span><span class="token number">128</span>-bit-ID<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
  详细列出日志分类信息 <span class="token punctuation">(</span>格式与 .catalog 文件相同<span class="token punctuation">)</span>。
  如果明确指定了分类ID<span class="token punctuation">(</span><span class="token number">128</span>-bit-ID<span class="token punctuation">)</span>， 那么仅显示指定的分类。
--update-catalog
  更新日志分类索引二进制文件。
  每当安装、删除、更新了分类文件，都需要执行一次此动作。
--setup-keys
  此选项并不用于显示日志内容， 而是用于生成一个新的FSS<span class="token punctuation">(</span>Forward Secure Sealing<span class="token punctuation">)</span>密钥对。 此密钥对包含一个<span class="token string">"sealing key"</span>与一个<span class="token string">"verification key"</span>。<span class="token string">"sealing key"</span>保存在本地日志目录中， 而<span class="token string">"verification key"</span>则必须保存在其他地方。详见 journald.conf<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> 中的 <span class="token assign-left variable">Seal</span><span class="token operator">=</span> 选项。
<span class="token parameter variable">--force</span>
  与 --setup-keys 连用， 表示即使已经配置了FSS<span class="token punctuation">(</span>Forward Secure Sealing<span class="token punctuation">)</span>密钥对，也要强制重新生成。
<span class="token parameter variable">--interval</span><span class="token operator">=</span>
  与 --setup-keys 连用，指定<span class="token string">"sealing key"</span>的变化间隔。
  较短的时间间隔会导致占用更多的CPU资源， 但是能够减少未检测的日志变化时间。
  默认值是 15min
<span class="token parameter variable">--verify</span>
  检查日志文件的内在一致性。 如果日志文件在生成时开启了FSS特性， 并且使用
--verify-key<span class="token operator">=</span> 指定了FSS的<span class="token string">"verification key"</span>，
  那么，同时还将验证日志文件的真实性。
--verify-key<span class="token operator">=</span>
  与 <span class="token parameter variable">--verify</span> 选项连用， 指定FSS的<span class="token string">"verification key"</span>
<span class="token parameter variable">--sync</span>
  要求日志守护进程将所有未写入磁盘的日志数据刷写到磁盘上，并且一直阻塞到刷写操作实际完成之后才返回。 因此该命令可以保证当它返回的时候，所有在调用此命令的时间点之前的日志， 已经全部安全的刷写到了磁盘中。
<span class="token parameter variable">--flush</span>
  要求日志守护进程 将 /run/log/journal 中的日志数据 刷写到 /var/log/journal 中<span class="token punctuation">(</span>如果持久存储设备当前可用的话<span class="token punctuation">)</span>。 此操作会一直阻塞到操作完成之后才会返回，因此可以确保在该命令返回时， 数据转移确实已经完成。
  注意，此命令仅执行一个单独的、一次性的转移动作， 若没有数据需要转移，则此命令什么也不做， 并且也会返回一个表示操作已正确完成的返回值。
<span class="token parameter variable">--rotate</span>
  要求日志守护进程滚动日志文件。 此命令会一直阻塞到滚动完成之后才会返回。
-h, <span class="token parameter variable">--help</span>
  显示简短的帮助信息并退出。
<span class="token parameter variable">--version</span>
  显示简短的版本信息并退出。
--no-pager
  不将程序的输出内容管道<span class="token punctuation">(</span>pipe<span class="token punctuation">)</span>给分页程序</code></pre>

<p>范例：journalctl 用法</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看所有日志（默认情况下 ，只保存本次启动的日志）</span>
journalctl
<span class="token comment">#查看内核日志（不显示应用日志）</span>
journalctl <span class="token parameter variable">-k</span>
<span class="token comment">#查看系统本次启动的日志</span>
journalctl <span class="token parameter variable">-b</span>
journalctl <span class="token parameter variable">-b</span> <span class="token parameter variable">-0</span>
<span class="token comment">#查看上一次启动的日志（需更改设置）</span>
journalctl <span class="token parameter variable">-b</span> <span class="token parameter variable">-1</span>
<span class="token comment">#查看指定时间的日志</span>
journalctl <span class="token parameter variable">--since</span><span class="token operator">=</span><span class="token string">"2017-10-30 18:10:30"</span>
journalctl <span class="token parameter variable">--since</span> <span class="token string">"20 min ago"</span>
journalctl <span class="token parameter variable">--since</span> yesterday
journalctl <span class="token parameter variable">--since</span> <span class="token string">"2017-01-10"</span> <span class="token parameter variable">--until</span> <span class="token string">"2017-01-11 03:00"</span>
journalctl <span class="token parameter variable">--since</span> 09:00 <span class="token parameter variable">--until</span> <span class="token string">"1 hour ago"</span>
<span class="token comment">#显示尾部的最新10行日志</span>
journalctl <span class="token parameter variable">-n</span>
<span class="token comment">#显示尾部指定行数的日志</span>
journalctl <span class="token parameter variable">-n</span> <span class="token number">20</span>
<span class="token comment">#实时滚动显示最新日志</span>
journalctl <span class="token parameter variable">-f</span>
<span class="token comment">#查看指定服务的日志</span>
journalctl /usr/lib/systemd/systemd
<span class="token comment">#查看指定进程的日志</span>
journalctl <span class="token assign-left variable">_PID</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#查看某个路径的脚本的日志</span>
journalctl /usr/bin/bash
<span class="token comment">#查看指定用户的日志</span>
journalctl <span class="token assign-left variable">_UID</span><span class="token operator">=</span><span class="token number">33</span> <span class="token parameter variable">--since</span> today
<span class="token comment">#查看某个 Unit 的日志</span>
journalctl <span class="token parameter variable">-u</span> nginx.service
journalctl <span class="token parameter variable">-u</span> nginx.service <span class="token parameter variable">--since</span> today
<span class="token comment">#实时滚动显示某个 Unit 的最新日志</span>
journalctl <span class="token parameter variable">-u</span> nginx.service <span class="token parameter variable">-f</span>
<span class="token comment">#合并显示多个 Unit 的日志</span>
journalctl <span class="token parameter variable">-u</span> nginx.service <span class="token parameter variable">-u</span> php-fpm.service <span class="token parameter variable">--since</span> today
<span class="token comment">#查看指定优先级（及其以上级别）的日志，共有8级</span>
<span class="token number">0</span>: emerg
<span class="token number">1</span>: alert
<span class="token number">2</span>: crit
<span class="token number">3</span>: err
<span class="token number">4</span>: warning
<span class="token number">5</span>: notice
<span class="token number">6</span>: info
<span class="token number">7</span>: debug
journalctl <span class="token parameter variable">-p</span> err <span class="token parameter variable">-b</span>
<span class="token comment">#日志默认分页输出，--no-pager 改为正常的标准输出</span>
journalctl --no-pager
<span class="token comment">#日志管理journalctl</span>
<span class="token comment">#以 JSON 格式（单行）输出</span>
journalctl <span class="token parameter variable">-b</span> <span class="token parameter variable">-u</span> nginx.service <span class="token parameter variable">-o</span> json
<span class="token comment">#以 JSON 格式（多行）输出，可读性更好</span>
journalctl <span class="token parameter variable">-b</span> <span class="token parameter variable">-u</span> nginx.serviceqq <span class="token parameter variable">-o</span> json-pretty
<span class="token comment">#显示日志占据的硬盘空间</span>
journalctl --disk-usage
<span class="token comment">#指定日志文件占据的最大空间</span>
journalctl --vacuum-size<span class="token operator">=</span>1G
<span class="token comment">#指定日志文件保存多久</span>
journalctl --vacuum-time<span class="token operator">=</span>1years</code></pre>

<h2 id="实战案例-1：利用-mysql-存储日志信息"><a href="#实战案例-1：利用-mysql-存储日志信息" class="headerlink" title="实战案例 1：利用 mysql 存储日志信息"></a>实战案例 1：利用 mysql 存储日志信息</h2><p>目标：将 rsyslog 收集的日志记录在 mysql 中</p>
<p>环境：两台主机</p>
<ol>
<li>rsyslog 日志服务器：10.0.0.71</li>
<li>mysql 数据库服务器：10.0.0.72</li>
</ol>
<p>实现：</p>
<ol>
<li>10.0.0.71 安装 rsyslog-mysql</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token function">install</span> rsyslog-mysql.x86_64
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-ql</span> rsyslog-mysql
/usr/lib64/rsyslog/ommysql.so
/usr/share/doc/rsyslog-8.24.0/mysql-createDB.sql	<span class="token comment"># sql文件</span>
<span class="token comment"># 拷贝到数据库服务器</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$scp</span> /usr/share/doc/rsyslog-8.24.0/mysql-createDB.sql root@10.0.0.72:/data</code></pre>

<ol start="2">
<li>10.0.0.72 配置 mysql</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token variable">$mysql</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span>
<span class="token punctuation">..</span>.
<span class="token number">11</span>:27:05<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">source</span> /data/mysql-createDB.sql	<span class="token comment"># 导入数据表</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
Database changed
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.06</span> sec<span class="token punctuation">)</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.06</span> sec<span class="token punctuation">)</span>
<span class="token comment"># 创建rsyslog用户，提供给日志服务，用来连接数据库</span>
08:25:34<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> CREATE <span class="token environment constant">USER</span> <span class="token string">'rsyslog'</span>@<span class="token string">'10.0.0.%'</span> IDENTIFIED BY <span class="token string">"123456"</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
08:25:39<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL ON *.* TO <span class="token string">'rsyslog'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre>

<ol start="3">
<li>10.0.0.71 修改 rsyslog 配置文件</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/rsyslog.conf
<span class="token punctuation">..</span>.
<span class="token comment"># 在MODULES下添加：</span>
<span class="token variable">$ModLoad</span> ommysql
<span class="token comment"># 在RULES下添加：</span>
<span class="token comment">#facility.priority	:ommysql:DBHOST,DBNAME,DBUSER, PASSWORD</span>
*.info				:ommysql:10.0.0.72,Syslog,rsyslog,123456
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart rsyslog.service</code></pre>

<ol start="4">
<li>测试</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$logger</span> <span class="token string">"this is a test log"</span>

<span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token variable">$mysql</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span>
08:45:43<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> Message from Syslog.SystemEvents order by <span class="token function">id</span> desc limit <span class="token number">1</span><span class="token punctuation">\</span>G<span class="token punctuation">;</span>
*************************** <span class="token number">1</span>. row ***************************
Message: this is a <span class="token builtin class-name">test</span> log
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>

<h2 id="实战案例-2：通过-loganalyzer-展示数据库中的日志"><a href="#实战案例-2：通过-loganalyzer-展示数据库中的日志" class="headerlink" title="实战案例 2：通过 loganalyzer 展示数据库中的日志"></a>实战案例 2：通过 loganalyzer 展示数据库中的日志</h2><p>loganalyzer 是用 php 语言实现的日志管理系统,可将 MySQL 数据库的日志用丰富的 WEB 方式进行展示</p>
<p>官网: <a target="_blank" rel="noopener" href="https://loganalyzer.adiscon.com/">https://loganalyzer.adiscon.com</a></p>
<p>目标：通过 loganalyzer 展示数据库中的日志</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605012422975.png"></p>
<h2 id="logrotate-日志转储"><a href="#logrotate-日志转储" class="headerlink" title="logrotate 日志转储"></a>logrotate 日志转储</h2><p>logrotate 程序是一个日志文件管理工具。用来把旧的日志文件删除，并创建新的日志文件，称为日志转储或滚动。可以根据日志文件的大小，也可以根据其天数来转储，这个过程一般通过 cron 程序来执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-ql</span> <span class="token function">logrotate</span>
/etc/cron.daily/logrotate					<span class="token comment"># 计划任务</span>
/etc/logrotate.conf							<span class="token comment"># 配置文件</span>
/etc/logrotate.d
/etc/rwtab.d/logrotate
/usr/sbin/logrotate							<span class="token comment"># 程序</span>
/usr/share/doc/logrotate-3.8.6
/usr/share/doc/logrotate-3.8.6/CHANGES
/usr/share/doc/logrotate-3.8.6/COPYING
/usr/share/man/man5/logrotate.conf.5.gz
/usr/share/man/man8/logrotate.8.gz
/var/lib/logrotate
/var/lib/logrotate/logrotate.status			<span class="token comment"># 日志文件</span></code></pre>

<p>配置文件主要参数如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">compress			<span class="token comment"># 通过 gzip 压缩转储以后的日志</span>
nocompress			<span class="token comment"># 不压缩</span>
copytruncate		<span class="token comment"># 把当前日志备份并截断，即 拷贝原来的日志，然后把原日志清空</span>
nocopytruncate		<span class="token comment"># 备份日志文件但是不截断，即	只拷贝原来的日志，但并不会在拷贝完后清空原日志</span>
create mode owner group		<span class="token comment"># 转储文件，使用指定的权限、所有者、所属组创建新的日志文件。注意 能用create就不用copytruncate</span>
nocreate			<span class="token comment"># 不建立新的日志文件，不知道这个选项的意义在哪里</span>
delaycompress		<span class="token comment"># 和 compress 一起使用时，转储的日志文件到下一次转储时才压缩</span>
nodelaycompress		<span class="token comment"># 覆盖 delaycompress 选项，转储同时压缩</span>
errors address		<span class="token comment"># 专储时的错误信息发送到指定的 Email 地址</span>
ifempty				<span class="token comment"># 即使是空文件也转储，此为默认选项</span>
notifempty			<span class="token comment"># 如果是空文件的话，不转储</span>
mail address		<span class="token comment"># 把转储的日志文件发送到指定的 E-mail 地址</span>
nomail				<span class="token comment"># 转储时不发送日志文件</span>
olddir directory		<span class="token comment"># 转储后的日志文件放入指定目录，必须和当前日志文件在同一个文件系统</span>
noolddir				<span class="token comment"># 转储后的日志文件和当前日志文件放在同一个目录下</span>
prerotate/endscript		<span class="token comment"># 在转储以前需要执行的命令，这两个关键字必须单独成行</span>
postrotate/endscript	<span class="token comment"># 在转储以后需要执行的命令，这两个关键字必须单独成行</span>
daily		<span class="token comment"># 指定转储周期为每天</span>
weekly		<span class="token comment"># 指定转储周期为每周</span>
monthly		<span class="token comment"># 指定转储周期为每月</span>
rotate count		<span class="token comment"># 指定日志文件删除之前转储的次数，0 指没有备份，5 指保留 5 个备份</span>
tabooext <span class="token punctuation">[</span>+<span class="token punctuation">]</span> list	<span class="token comment"># 让 logrotate 不转储指定扩展名的文件，缺省的扩展名是:.rpm-orig、.rpmsave、v 和 ~</span>
size size			<span class="token comment"># 当日志文件到达指定的大小时才转储，bytes(缺省)及 KB 或 MB</span>
sharedscripts		<span class="token comment"># 默认，对每个转储日志运行 prerotate 和 postrotate 脚本，日志文件的绝对路径作为第一个参数传递给脚本。 这意味着单个脚本可以针对与多个文件匹配的日志文件条目多次运行(例如/ var / log / news /\*.example)。 如果指定此项 sharedscripts，则无论有多少个日志与通配符模式匹配，脚本都只会运行一次</span>
nosharedscripts		<span class="token comment"># 针对每一个转储的日志文件，都执行一次 prerotate 和 postrotate 脚本，此为默认值</span>
missingok			<span class="token comment"># 如果日志不存在，不提示错误，继续处理下一个</span>
nomissingok			<span class="token comment"># 如果日志不存在，提示错误，此为默认值</span>
dateext				<span class="token comment"># 切换后的日志文件会附加上一个短横线和 YYYYMMDD 格式的日期，没有这个配置项会附加一个小数点加一个数字序号</span>
dateformat			<span class="token comment"># 配合 dateext 使用可以为切割后的日志加上 YYYYMMDD 格式的日期，如 dateformat -%Y%m%d</span>
<span class="token punctuation">..</span>.</code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># logrotate nginx log</span>
<span class="token function">cat</span> <span class="token operator">></span>/etc/logrotate.d/nginx <span class="token operator">&lt;&lt;</span><span class="token string">EOF
<span class="token variable">$&#123;wwwlogs_dir&#125;</span>/*nginx.log &#123;
  daily
  rotate 5
  missingok
  dateext
  compress
  notifempty
  sharedscripts
  postrotate
    [ -f /usr/local/nginx/run/nginx.pid ] &amp;&amp; kill -USR1 \<span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /usr/local/nginx/run/nginx.pid<span class="token punctuation">\</span><span class="token variable">`</span></span>
  endscript
&#125;
EOF</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Redis/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Redis/Redis/" class="post-title-link" itemprop="url">Redis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:32:20" itemprop="dateCreated datePublished" datetime="2020-12-09T23:32:20+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="缓存技术"><a href="#缓存技术" class="headerlink" title="缓存技术"></a>缓存技术</h2><h3 id="缓存-cache"><a href="#缓存-cache" class="headerlink" title="缓存 cache"></a>缓存 cache</h3><h4 id="buffer-和-cache"><a href="#buffer-和-cache" class="headerlink" title="buffer 和 cache"></a>buffer 和 cache</h4><ul>
<li>buffer：缓冲，写缓冲，先写到缓冲中，再输出到网络或者写入磁盘</li>
<li>cache：缓存</li>
</ul>
<h4 id="缓存保存位置及分层结构"><a href="#缓存保存位置及分层结构" class="headerlink" title="缓存保存位置及分层结构"></a>缓存保存位置及分层结构</h4><p>互联网领域，缓存为王</p>
<ul>
<li>用户层：浏览器 DNS 缓存,应用程序 DNS 缓存,操作系统 DNS 缓存客户端</li>
<li>代理层：CDN,反向代理缓存</li>
<li>Web 层：解释器 Opcache,Web 服务器缓存</li>
<li>应用层：页面静态化</li>
<li>数据层：分布式缓存,数据库</li>
<li>系统层：操作系统 cache</li>
<li>物理层：磁盘 cache, Raid Cache</li>
</ul>
<h4 id="cache-的特性"><a href="#cache-的特性" class="headerlink" title="cache 的特性"></a>cache 的特性</h4><p>自动过期、强制过期、命中率</p>
<h3 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h3><p><img data-src="//img.to2b.cn/blog/ljk/1604149204695.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604148984198.png"></p>
<p>利用 302 实现转发请求重定向至最优服务器集群</p>
<p>中国网络较为复杂，依赖 DNS 就近解析的调度，仍然会存在部分请求调度失效、调度生效慢等问题。腾讯云利用在全国部署的 302 重定向服务器集群，能够为每一个请求实时决策最优的服务器资源，精准解决小运营商的调度问题，提升用户访问质量, 能最快地把用户引导到最优的服务器节点上，避开性能差或者异常的节点。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604149248397.png"></p>
<h4 id="CDN-分层缓存"><a href="#CDN-分层缓存" class="headerlink" title="CDN 分层缓存"></a>CDN 分层缓存</h4><p><img data-src="//img.to2b.cn/blog/ljk/1604149332663.png"></p>
<h2 id="Redis-部署和使用"><a href="#Redis-部署和使用" class="headerlink" title="Redis 部署和使用"></a>Redis 部署和使用</h2><h3 id="Redis-基础"><a href="#Redis-基础" class="headerlink" title="Redis 基础"></a>Redis 基础</h3><p>注意事项：谨慎甚至禁止使用某些命令，例如 keys</p>
<h4 id="redis-对比-memcached"><a href="#redis-对比-memcached" class="headerlink" title="redis 对比 memcached"></a>redis 对比 memcached</h4><ul>
<li>支持数据的持久化：可以将内存中的数据保持在磁盘中，重启 redis 服务或者服务器之后可以从备份文件中恢复数据到内存继续使用</li>
<li>支持更多的数据类型：支持 string(字符串)、hash(哈希数据)、list(列表)、set(集合)、zset(有序集合)</li>
<li>支持数据的备份：可以实现类似于数据的 master-slave 模式的数据备份，另外也支持使用快照+AOF</li>
<li>支持更大的 value 数据：memcache 单个 key value 最大只支持 1MB，而 redis 最大支持 512MB(生产不建议超过 2M,性能受影响)</li>
<li>在 Redis6 版本前,Redis 是单线程，而 memcached 是多线程，所以单机情况下没有 memcached 并发高,性能更好,但 redis 支持分布式集群以实现更高的并发，单 Redis 实例可以实现数万并发</li>
<li>支持集群横向扩展：基于 redis cluster 的横向扩展，可以实现分布式集群，大幅提升性能和数据安全性</li>
<li>都是基于 C 语言开发</li>
</ul>
<h4 id="redis-典型应用场景"><a href="#redis-典型应用场景" class="headerlink" title="redis 典型应用场景"></a>redis 典型应用场景</h4><ul>
<li>Session 共享：常见于 web 集群中的 Tomcat 或者 PHP 中多 web 服务器 session 共享</li>
<li>缓存：数据查询、电商网站商品信息、新闻内容</li>
<li>计数器：访问排行榜、商品浏览数等和次数相关的数值统计场景</li>
<li>微博&#x2F;微信社交场合：共同好友,粉丝数,关注,点赞评论等</li>
<li>消息队列：ELK 的日志缓存、部分业务的订阅发布系统</li>
<li>地理位置: 基于 GEO(地理信息定位),实现摇一摇,附近的人,外卖等功能</li>
</ul>
<h3 id="Redis-安装及连接"><a href="#Redis-安装及连接" class="headerlink" title="Redis 安装及连接"></a>Redis 安装及连接</h3><h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><p>见脚本，注意 redis 不建议设置密码</p>
<h4 id="解决启动时的三个警告提示"><a href="#解决启动时的三个警告提示" class="headerlink" title="解决启动时的三个警告提示"></a>解决启动时的三个警告提示</h4><ol>
<li><p>tcp-backlog</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#vim /etc/sysctl.conf</span>
net.core.somaxconn <span class="token operator">=</span> <span class="token number">1024</span>
<span class="token comment">#sysctl -p</span></code></pre>
</li>
<li><p>vm.overcommit_memory</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 0、表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。</span>
<span class="token comment"># 1、表示内核允许分配所有的物理内存，而不管当前的内存状态如何</span>
<span class="token comment"># 2、表示内核允许分配超过所有物理内存和交换空间总和的内存</span>

<span class="token comment"># 范例：</span>
<span class="token comment">#vim /etc/sysctl.conf</span>
vm.overcommit_memory <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#sysctl -p</span></code></pre>
</li>
<li><p>transparent hugepage</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 警告：您在内核中启用了透明大页面（THP,不同于一般内存页的4k为2M）支持。 这将在Redis中造成延迟和内存使用问题。 要解决此问题，请以root 用户身份运行命令“echo never> /sys/kernel/mm/transparent_hugepage/enabled”，并将其添加到您的/etc/rc.local中，以便在重启后保留设置。禁用THP后，必须重新启动Redis。</span>

<span class="token builtin class-name">echo</span> <span class="token string">'echo never > /sys/kernel/mm/transparent_hugepage/enabled'</span> <span class="token operator">>></span> /etc/rc.d/rc.local</code></pre></li>
</ol>
<h3 id="Redis-配置和优化"><a href="#Redis-配置和优化" class="headerlink" title="Redis 配置和优化"></a>Redis 配置和优化</h3><h4 id="主要配置项"><a href="#主要配置项" class="headerlink" title="主要配置项"></a>主要配置项</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 绑定网卡，监听地址，可以用空格隔开后多个监听IP</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
<span class="token comment"># redis3.2之后加入的新特性，在没有设置bind IP和密码的时候,redis只允许访问127.0.0.1:6379，可以远程连接，但当访问将提示警告信息并拒绝远程访问</span>
protected-mode <span class="token function">yes</span>
<span class="token comment"># 监听端口,默认6379/tcp</span>
port <span class="token number">6379</span>
<span class="token comment"># 三次握手的时候server端收到client ack确认号之后的队列值，即全连接队列长度</span>
tcp-backlog <span class="token number">511</span>
<span class="token comment"># 客户端和Redis服务端的连接超时时间，默认是0，表示永不超时</span>
<span class="token function">timeout</span> <span class="token number">0</span>
<span class="token comment"># tcp 会话保持时间300s</span>
tcp-keepalive <span class="token number">300</span>
<span class="token comment"># 默认no,即直接运行redis-server程序时,不作为守护进程运行，而是以前台方式运行，如果想在后台运行需改成yes,当redis作为守护进程运行的时候，它会写一个pid 到/var/run/redis.pid 文件</span>
daemonize no
<span class="token comment"># 和OS相关参数，可设置通过upstart和systemd管理Redis守护进程，centos7后都使用systemd</span>
supervised no
<span class="token comment"># pid文件路径</span>
pidfile /var/run/redis_6379.pid
<span class="token comment"># 日志级别</span>
loglevel notice
<span class="token comment"># 日志路径,示例:logfile "/apps/redis/log/redis_6379.log"</span>
logfile <span class="token string">"/path/redis.log"</span>
<span class="token comment"># 设置数据库数量，默认：0-15，共16个库</span>
databases <span class="token number">16</span>
<span class="token comment"># 在启动redis时是否显示或在日志中记录记录redis的logo</span>
always-show-logo <span class="token function">yes</span>
<span class="token comment"># 在900秒内有1个key内容发生更改,就执行快照机制</span>
save <span class="token number">900</span> <span class="token number">1</span>
<span class="token comment"># 在300秒内有10个key内容发生更改,就执行快照机制</span>
save <span class="token number">300</span> <span class="token number">10</span>
<span class="token comment"># 60秒内如果有10000个key以上的变化，就自动快照备份</span>
save <span class="token number">60</span> <span class="token number">10000</span>
<span class="token comment"># 默认为yes时,可能会因空间满等原因快照无法保存出错时，会禁止redis写入操作，生产建议为no</span>
<span class="token comment"># 此项只针对配置文件中的自动save有效</span>
stop-writes-on-bgsave-error <span class="token function">yes</span>
<span class="token comment"># 持久化到RDB文件时，是否压缩，"yes"为压缩，"no"则反之</span>
rdbcompression <span class="token function">yes</span>
<span class="token comment"># 是否对备份文件开启RC64校验，默认是开启</span>
rdbchecksum <span class="token function">yes</span>
<span class="token comment"># 快照文件名</span>
dbfilename dump.rdb
<span class="token comment"># 快照文件保存路径，示例：dir "/apps/redis/data"</span>
<span class="token function">dir</span> ./

<span class="token comment">#主从复制相关</span>
<span class="token comment"># replicaof &lt;masterip> &lt;masterport> # 指定复制的master主机地址和端口，5.0版之前的指令为slaveof</span>
<span class="token comment"># masterauth &lt;master-password> # 指定复制的master主机的密码</span>

<span class="token comment"># 当从库同主库失去连接或者复制正在进行，从机库有两种运行方式：</span>
<span class="token comment"># 1、设置为yes(默认设置)，从库会继续响应客户端的读请求，此为建议值</span>
<span class="token comment"># 2、设置为no，除去特定命令外的任何请求都会返回一个错误"SYNC with master in progress"。</span>
replica-serve-stale-data <span class="token function">yes</span>
<span class="token comment"># 是否设置从库只读，建议值为yes,否则主库同步从库时可能会覆盖数据，造成数据丢失</span>
replica-read-only <span class="token function">yes</span>

<span class="token comment"># 是否使用socket方式复制数据(无盘同步)，新slave第一次连接master时需要做数据的全量同步，redis server就要从内存dump出新的RDB文件，然后从master传到slave，有两种方式把RDB文件传输给客户端：</span>
<span class="token comment"># 1、基于硬盘（disk-backed）：为no时，master创建一个新进程dump生成RDB磁盘文件，RDB完成之后由父进程（即主进程）将RDB文件发送给slaves，此为默认值</span>
<span class="token comment"># 2、基于socket（diskless）：master创建一个新进程直接dump RDB至slave的网络socket，不经过主进程和硬盘</span>
<span class="token comment"># 推荐使用基于硬盘（为no），是因为RDB文件创建后，可以同时传输给更多的slave，但是基于socket(为yes)，新slave连接到master之后得逐个同步数据。只有当磁盘I/O较慢且网络较快时，可用diskless(yes),否则一般建议使用磁盘(no)</span>
repl-diskless-sync no

<span class="token comment"># diskless时复制的服务器等待的延迟时间，设置0为关闭，在延迟时间内到达的客户端，会一起通过diskless方式同步数据，但是一旦复制开始，master节点不会再接收新slave的复制请求，直到下一次同步开始才再接收新请求。即无法为延迟时间后到达的新副本提供服务，新副本将排队等待下一次RDB传输，因此服务器会等待一段时间才能让更多副本到达。推荐值：30-60</span>
repl-diskless-sync-delay <span class="token number">5</span>
<span class="token comment"># slave根据master指定的时间进行周期性的PING master,用于监测master状态,默认10s</span>
repl-ping-replica-period <span class="token number">10</span>
<span class="token comment"># 复制连接的超时时间，需要大于repl-ping-slave-period，否则会经常报超时</span>
repl-timeout <span class="token number">60</span>
<span class="token comment"># 是否在slave套接字发送SYNC之后禁用TCP_NODELAY，如果选择"yes"，Redis将合并多个报文为一个大的报文，从而使用更少数量的包向slaves发送数据，但是将使数据传输到slave上有延迟，Linux内核的默认配置会达到40毫秒，如果 "no" ，数据传输到slave的延迟将会减少，但要使用更多的带宽</span>
repl-disable-tcp-nodelay no
<span class="token comment"># 复制缓冲区内存大小，当slave断开连接一段时间后，该缓冲区会累积复制副本数据，因此当slave重新连接时，通常不需要完全重新同步，只需传递在副本中的断开连接后没有同步的部分数据即可。只有在至少有一个slave连接之后才分配此内存空间,建议建立主从时此值要调大一些或在低峰期配置,否则会导致同步到slave失败</span>
repl-backlog-size 512mb

<span class="token comment"># 多长时间内master没有slave连接，就清空backlog缓冲区</span>
repl-backlog-ttl <span class="token number">3600</span>

<span class="token comment"># 当master不可用，哨兵Sentinel会根据slave的优先级选举一个master，此值最低的slave会优先当选master，而配置成0，永远不会被选举，一般多个slave都设为一样的值，让其自动选择</span>
replica-priority <span class="token number">100</span>

<span class="token comment"># 至少有3个可连接的slave，mater才接受写操作</span>
min-replicas-to-write <span class="token number">3</span>

<span class="token comment"># 和上面至少3个slave的ping延迟不能超过10秒，否则master也将停止写操作</span>
min-replicas-max-lag <span class="token number">10</span>

<span class="token comment"># 设置redis连接密码，之后需要AUTH pass,如果有特殊符号，用" "引起来,生产建议设置</span>
requirepass foobared

<span class="token comment"># 重命名一些高危命令，示例：rename-command FLUSHALL "" 禁用命令</span>
<span class="token comment"># rename-command del magedu</span>
rename-command CONFIG <span class="token string">""</span>

<span class="token comment"># Redis最大连接客户端</span>
maxclients <span class="token number">10000</span>

<span class="token comment"># redis使用的最大内存，单位为bytes字节，0为不限制，建议设为物理内存一半，8G内存的计算方式8(G)*1024(MB)1024(KB)*1024(Kbyte)，需要注意的是缓冲区是不计算在maxmemory内,生产中如果不设置此项,可能会导致OOM</span>
maxmemory <span class="token operator">&lt;</span>bytes<span class="token operator">></span>

<span class="token comment"># 是否开启AOF日志记录，默认redis使用的是rdb方式持久化，这种方式在许多应用中已经足够用了，但是redis如果中途宕机，会导致可能有几分钟的数据丢失(取决于dump数据的间隔时间)，根据save来策略进行持久化，Append Only File是另一种持久化方式，可以提供更好的持久化特性，Redis会把每次写入的数据在接收后都写入 appendonly.aof 文件，每次启动时Redis都会先把这个文件的数据读入内存里，先忽略RDB文件。默认不启用此功能</span>
appendonly no

<span class="token comment"># 文本文件AOF的文件名，存放在dir指令指定的目录中</span>
appendfilename <span class="token string">"appendonly.aof"</span>

<span class="token comment"># aof持久化策略的配置</span>
<span class="token comment"># no表示由操作系统保证数据同步到磁盘,Linux的默认fsync策略是30秒，最多会丢失30s的数据</span>
<span class="token comment"># always表示每次写入都执行fsync，以保证数据同步到磁盘,安全性高,性能较差</span>
<span class="token comment"># everysec表示每秒执行一次fsync，可能会导致丢失这1s数据,此为默认值,也生产建议值</span>
appendfsync everysec

<span class="token comment"># 同时在执行bgrewriteaof操作和主进程写aof文件的操作，两者都会操作磁盘，而bgrewriteaof往往会涉及大量磁盘操作，这样就会造成主进程在写aof文件的时候出现阻塞的情形,以下参数实现控制</span>
<span class="token comment"># 在aof rewrite期间,是否对aof新记录的append暂缓使用文件同步策略,主要考虑磁盘IO开支和请求阻塞时间。</span>
<span class="token comment"># no：默认设置，表示"不暂缓"，新aof记录仍然被立即同步到磁盘，是最安全的方式，不丢失数据，但要忍受阻塞的问题</span>
<span class="token comment"># yes：相当于将appendfsync设置为no，这说明并没有执行磁盘操作，只是写入了缓冲区，因此这样并不会造成阻塞（因为没有竞争磁盘），但是如果这个时候redis挂掉，就会丢失数据。丢失多少数据呢？Linux的默认fsync策略是30秒，最多会丢失30s的数据,但由于yes性能较好而且会避免出现阻塞，因此比较推荐</span>
<span class="token comment"># rewrite 即对aof文件进行整理,将空闲空间回收,从而可以减少恢复数据时间</span>
no-appendfsync-on-rewrite no

<span class="token comment"># 当Aof log增长超过指定百分比例时，重写AOF文件，设置为0表示不自动重写Aof日志，重写是为了使aof体积保持最小，但是还可以确保保存最完整的数据</span>
auto-aof-rewrite-percentage <span class="token number">100</span>
<span class="token comment"># 触发aof rewrite的最小文件大小</span>
auto-aof-rewrite-min-size 64mb
<span class="token comment"># 是否加载由于某些原因导致的末尾异常的AOF文件(主进程被kill/断电等)，建议yes</span>
aof-load-truncated <span class="token function">yes</span>
<span class="token comment"># redis4.0新增RDB-AOF混合持久化格式，在开启了这个功能之后，AOF重写产生的文件将同时包含RDB格式的内容和AOF格式的内容，其中RDB格式的内容用于记录已有的数据，而AOF格式的内容则用于记录最近发生了变化的数据，这样Redis就可以同时兼有RDB持久化和AOF持久化的优点（既能够快速地生成重写文件，也能够在出现问题时，快速地载入数据）,默认为no,即不启用此功能</span>
aof-use-rdb-preamble no

<span class="token comment"># lua脚本的最大执行时间，单位为毫秒</span>
lua-time-limit <span class="token number">5000</span>

<span class="token comment"># 是否开启集群模式，默认不开启,即单机模式</span>
cluster-enabled <span class="token function">yes</span>
<span class="token comment"># 由node节点自动生成的集群配置文件名称</span>
cluster-config-file nodes-6379.conf

<span class="token comment"># 集群中node节点连接超时时间，单位ms,超过此时间，会踢出集群</span>
cluster-node-timeout <span class="token number">15000</span>

<span class="token comment"># 单位为次,在执行故障转移的时候可能有些节点和master断开一段时间导致数据比较旧，这些节点就不适用于选举为master，超过这个时间的就不会被进行故障转移,不能当选master，计算公式：(node-timeout * replica-validity-factor) + repl-ping-replica-period</span>
cluster-replica-validity-factor <span class="token number">10</span>
<span class="token comment"># 集群迁移屏障，一个主节点至少拥有1个正常工作的从节点，即如果主节点的slave节点故障后会将多余的从节点分配到当前主节点成为其新的从节点</span>
cluster-migration-barrier <span class="token number">1</span>
<span class="token comment"># 集群请求槽位全部覆盖，如果一个主库宕机且没有备库就会出现集群槽位不全，那么yes时redis集群槽位验证不全,就不再对外提供服务(对key赋值时,会出现CLUSTERDOWN The cluster is down的提示,cluster_state:fail,但ping 仍PONG)，而no则可以继续使用,但是会出现查询数据查不到的情况(因为有数据丢失)。生产建议为no</span>
cluster-require-full-coverage <span class="token function">yes</span>
<span class="token comment"># 如果为yes,此选项阻止在主服务器发生故障时尝试对其主服务器进行故障转移。 但是，主服务器仍然可以执行手动强制故障转移，一般为no</span>
cluster-replica-no-failover no

<span class="token comment"># Slow log 是 Redis 用来记录超过指定执行时间的日志系统，执行时间不包括与客户端交谈，发送回复等I/O操作，而是实际执行命令所需的时间（在该阶段线程被阻塞并且不能同时为其它请求提供服务）,由于slow log 保存在内存里面，读写速度非常快，因此可放心地使用，不必担心因为开启 slow log 而影响Redis 的速度</span>
<span class="token comment"># 以微秒为单位的慢日志记录，为负数会禁用慢日志，为0会记录每个命令操作。默认值为10ms,一般一条命令执行都在微秒级,生产建议设为1ms-10ms之间</span>
slowlog-log-slower-than <span class="token number">10000</span>
<span class="token comment"># 最多记录多少条慢日志的保存队列长度，达到此长度后，记录新命令会将最旧的命令从命令队列中删除，以此滚动删除,即,先进先出,队列固定长度,默认128,值偏小,生产建议设为1000以上</span>
slowlog-max-len <span class="token number">128</span></code></pre>

<h4 id="动态修改配置"><a href="#动态修改配置" class="headerlink" title="动态修改配置"></a>动态修改配置</h4><p>config 命令用于查看当前 redis 配置、以及不重启 redis 服务实现动态更改 redis 配置等</p>
<p>注意：不是所有配置都可以动态修改,且此方式无法持久保存</p>
<ul>
<li><p>获取当前配置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 奇数行为键，偶数行为值</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> config get *
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"dbfilename"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"dump.rdb"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"requirepass"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">""</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"masterauth"</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">""</span>
<span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"cluster-announce-ip"</span>
<span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">""</span>
<span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">"unixsocket"</span>
<span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">""</span>
<span class="token number">11</span><span class="token punctuation">)</span> <span class="token string">"logfile"</span>
<span class="token number">12</span><span class="token punctuation">)</span> <span class="token string">"/var/log/redis/redis.log"</span>
<span class="token number">13</span><span class="token punctuation">)</span> <span class="token string">"pidfile"</span>
<span class="token number">14</span><span class="token punctuation">)</span> <span class="token string">"/var/run/redis_6379.pid"</span>
<span class="token number">15</span><span class="token punctuation">)</span> <span class="token string">"slave-announce-ip"</span>
<span class="token number">16</span><span class="token punctuation">)</span> <span class="token string">""</span>
<span class="token number">17</span><span class="token punctuation">)</span> <span class="token string">"replica-announce-ip"</span>
<span class="token number">18</span><span class="token punctuation">)</span> <span class="token string">""</span>
<span class="token number">19</span><span class="token punctuation">)</span> <span class="token string">"maxmemory"</span>
<span class="token number">20</span><span class="token punctuation">)</span> <span class="token string">"0"</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token comment"># 查看bind</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> config get <span class="token builtin class-name">bind</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"bind"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"0.0.0.0"</span>
<span class="token comment"># 有些设置无法修改</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CONFIG SET <span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR Unsupported CONFIG parameter: <span class="token builtin class-name">bind</span></code></pre>
</li>
<li><p>设置连接密码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置连接密码</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CONFIG SET requirepass <span class="token number">123456</span>
OK
<span class="token comment"># 查看连接密码</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CONFIG GET requirepass
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"requirepass"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"123456"</span></code></pre>
</li>
<li><p>更改最大内存</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CONFIG SET maxmemory <span class="token number">8589934592</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CONFIG GET maxmemory
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"maxmemory"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"8589934592"</span></code></pre></li>
</ul>
<h4 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h4><p><img data-src="//img.to2b.cn/blog/ljk/1604287025690.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">slowlog-log-slower-than <span class="token number">10000</span>
slowlog-max-len <span class="token number">1024</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SLOWLOG LEN <span class="token comment"># 查看慢日志的记录条数</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SLOWLOG GET <span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token comment"># 查看慢日志的n条记录</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SLOWLOG RESET <span class="token comment"># 清空慢日志</span></code></pre>

<h4 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h4><p>目前 redis 支持两种不同方式的数据持久化保存机制，分别是 RDB 和 AOF</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604287491602.png"></p>
<h5 id="RDB-模式"><a href="#RDB-模式" class="headerlink" title="RDB 模式"></a>RDB 模式</h5><p><img data-src="//img.to2b.cn/blog/ljk/1604287758331.png"></p>
<p>基于时间的快照，其默认只保留当前最新的一次快照，特点是执行速度比较快，缺点是可能会丢失从上次快照到当前时间点之间未做快照的数据</p>
<ul>
<li>save: 同步,会阻赛其它命令,不推荐使用</li>
<li>bgsave: 异步后台执行,不影响其它命令的执行</li>
<li>自动: 制定规则,自动执行</li>
</ul>
<p><strong>bgsave 过程：</strong>Redis 从 master 主进程先 fork 出一个子进程，使用写时复制(copy-on-write)机制，子进程将内存的数据保存为一个临时文件，比如:tmp-.rdb，当数据保存完成之后再将上一次保存的 RDB 文件替换掉，然后关闭子进程，这样可以保证每一次做 RDB 快照保存的数据都是完整的</p>
<p>因为直接替换 RDB 文件的时候,可能会出现突然断电等问题,而导致 RDB 文件还没有保存完整就因为突然关机停止保存,而导致数据丢失的情况.后续可以手动将每次生成的 RDB 文件进行备份，这样可以最大化保存历史数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">save <span class="token number">900</span> <span class="token number">1</span>
save <span class="token number">300</span> <span class="token number">10</span>
save <span class="token number">60</span> <span class="token number">10000</span>
dbfilename dump.rdb
<span class="token function">dir</span> ./
stop-writes-on-bgsave-error <span class="token function">yes</span>
rdbcompression <span class="token function">yes</span>
rdbchecksum <span class="token function">yes</span></code></pre>

<p><strong>RDB 模式的优缺点</strong></p>
<p>优点：</p>
<ul>
<li>RDB 快照保存了某个时间点的数据，可以通过脚本执行 redis 指令 bgsave(非阻塞，后台执行)或者 save(会阻塞写操作,不推荐)命令自定义时间点备份，可以保留多个备份，当出现问题可以恢复到不同时间点的版本,很适合备份,并且此文件格式也支持有不少第三方工具可以进行后续的数据分析<br>比如: 可以在最近的 24 小时内，每小时备份一次 RDB 文件，并且在每个月的每一天，也备份一个 ROB 文件。这样的话，即使遇上问题，也可以随时将数据集还原到不同的版本。</li>
<li>RDB 可以最大化 Redis 的性能，父进程在保存 RDB 文件时唯一要做的就是 fork 出一个子进程，然后<br>这个子进程就会处理接下来的所有保存工作，父进程无须执行任何磁盘工&#x2F;0 操作。</li>
<li>RDB 在大量数据,比如几个 G 的数据，恢复的速度比 AOF 的快</li>
</ul>
<p>缺点：</p>
<ul>
<li>不能实时保存数据，可能会丢失自上一次执行 RDB 备份到当前的内存数据<br>如果你需要尽量避免在服务器故障时丢失数据，那么 RDB 不适合你。虽然 Redis 允许你设置不同的保存点（save point）来控制保存 RDB 文件的频率，但是，因为 ROB 文件需要保存整个数据集的状态，所以它并不是一个轻松的操作。因此你可能会至少 5 分钟才保存一次 RDB 文件。在这种情况下，一旦发生故障停机，你就可能会丢失好几分钟的数据</li>
<li>当数据量非常大的时候，从父进程 fork 子进程进行保存至 RDB 文件时需要一点时间，可能是毫秒或者秒，取决于磁盘 IO 性能<br>在数据集比较庞大时，fork()可能会非常耗时，造成服务器在一定时间内停止处理客户端﹔如果数据集非常巨大，并且 CPU 时间非常紧张的话，那么这种停止时间甚至可能会长达整整一秒或更久。虽然 AOF 重写也需要进行 fork()，但无论 AOF 重写的执行间隔有多长，数据的持久性都不会有任何损失</li>
</ul>
<p><strong>范例: 手动备份 RDB 文件的脚本</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置项</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#vim /apps/redis/etc/redis.conf</span>
save <span class="token string">""</span>
dbfilename dump_6379.rdb
<span class="token function">dir</span> <span class="token string">"/data/redis"</span>
appendonly no

<span class="token comment"># 备份脚本</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#cat redis_backup_rdb.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token builtin class-name">.</span> /etc/init.d/functions
<span class="token assign-left variable">BACKUP</span><span class="token operator">=</span>/backup/redis-rdb
<span class="token assign-left variable">DIR</span><span class="token operator">=</span>/data/redis
<span class="token assign-left variable">FILE</span><span class="token operator">=</span>dump_6379.rdb
<span class="token assign-left variable">PASS</span><span class="token operator">=</span><span class="token number">123456</span>

redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-a</span> <span class="token variable">$PASS</span> --no-auth-warning bgsave
<span class="token assign-left variable">result</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>redis-cli <span class="token parameter variable">-a</span> <span class="token number">123456</span> --no-auth-warning info Persistence <span class="token operator">|</span> <span class="token function">grep</span> rdb_bgsave_in_progress <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-rn</span> <span class="token string">'s/.*:([0-9]+).*/\1/p'</span><span class="token variable">)</span></span>
<span class="token keyword">until</span> <span class="token punctuation">[</span> <span class="token variable">$result</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token function">sleep</span> <span class="token number">1</span>
    <span class="token assign-left variable">result</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>redis-cli <span class="token parameter variable">-a</span> <span class="token number">123456</span> --no-auth-warning info Persistence <span class="token operator">|</span> <span class="token function">grep</span> rdb_bgsave_in_progress <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-rn</span> <span class="token string">'s/.*:([0-9]+).*/\1/p'</span><span class="token variable">)</span></span>
<span class="token keyword">done</span>
<span class="token assign-left variable">DATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F_%H-%M-%S<span class="token variable">)</span></span>
<span class="token punctuation">[</span> <span class="token parameter variable">-e</span> <span class="token variable">$BACKUP</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span>
    <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$BACKUP</span>
    <span class="token function">chown</span> <span class="token parameter variable">-R</span> redis.redis <span class="token variable">$BACKUP</span>
<span class="token punctuation">&#125;</span>
<span class="token function">mv</span> <span class="token variable">$DIR</span>/<span class="token variable">$FILE</span> <span class="token variable">$BACKUP</span>/dump_6379-<span class="token variable">$&#123;DATE&#125;</span>.rdb
action <span class="token string">"Backup redis RDB"</span>

<span class="token comment"># 执行</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#bash redis_backup_rdb.sh</span>
Background saving started
Backup redis RDB <span class="token punctuation">[</span> OK <span class="token punctuation">]</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ll /backup/redis-rdb/ -h</span>
total 143M
-rw-r--r-- <span class="token number">1</span> redis redis 143M Oct <span class="token number">21</span> <span class="token number">11</span>:08 dump_6379-2020-10-21_11-08-47.rdb</code></pre>

<h5 id="AOF-模式"><a href="#AOF-模式" class="headerlink" title="AOF 模式"></a>AOF 模式</h5><p><img data-src="//img.to2b.cn/blog/ljk/1604288929556.png"></p>
<p>按照操作顺序依次将操作追加到指定的日志文件末尾</p>
<p>AOF 和 RDB 一样使用了写时复制机制，AOF 默认为每秒钟 fsync 一次，即将执行的命令保存到 AOF 文件当中，这样即使 redis 服务器发生故障的话最多只丢失 1 秒钟之内的数据，也可以设置不同的 fsync 策略 always，即设置每次执行命令的时候执行 fsync，fsync 会在后台执行线程，所以主线程可以继续处理用户的正常请求而不受到写入 AOF 文件的 I&#x2F;O 影响</p>
<p>同时启用 RDB 和 AOF，进行恢复时，默认 AOF 文件优先级高于 RDB 文件，即会使用 AOF 文件进行恢复</p>
<p>注意：AOF 模式默认是关闭的，第一次开启 AOF 后，并重启服务，因为 AOF 的优先级高于 RDB，而 AOF 默认没有文件存在，从而导致所有数据丢失</p>
<p><strong>AOF rewrite 重写</strong></p>
<p>将一些重复的，可以合并的，过期的数据重新写入一个新的 AOF 文件，从而节约 AOF 备份占用的硬盘空间，也能加速恢复过程，可以手动执行 bgrewriteaof 触发 AOF 或定义自动 rewrite 策略</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604289226435.png"></p>
<p>AOF 文件重写由 Redis 自行触发，我们可以使用 bgrewriteaof 命令手动触发</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启aof</span>
appendonly <span class="token function">yes</span>
appendfilename <span class="token string">"appendonly.aof"</span>
appendfsync everysec
<span class="token function">dir</span> ./
no-appendfsync-on-rewrite <span class="token function">yes</span>
auto-aof-rewrite-percentage <span class="token number">100</span>
auto-aof-rewrite-min-size 64mb
aof-load-truncated <span class="token function">yes</span></code></pre>

<p><strong>AOF 模式的优缺点</strong></p>
<p>优点：</p>
<ul>
<li>数据安全性相对较高，根据所使用的 fsync 策略（fsync 是同步内存中 redis 所有已经修改的文件到存储设备），默认是 appendfsync everysec，即每秒执行一次 fsync,在这种配置下，Redis 仍然可以保持良好的性能，并且就算发生故障停机，也最多只会丢失一秒钟的数据（fsync 会在后台线程执行，所以主线程可以继续努力地处理命令请求）</li>
<li>由于该机制对日志文件的写入操作采用的是 append 模式，因此在写入过程中不需要 seek，即使出现宕机现象，也不会破坏日志文件中已经存在的内容。然而如果本次操作只是写入了一半数据就出现了系统崩溃问题，不用担心，在 Redis 下一次启动之前，可以通过 redis-check-aof 工具来解决数据一致性的问题</li>
<li>AOF 文件体积变得过大时，可以自动在后台对 AOF 进行重写，重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合。整个重写操作是绝对安全的，因为 Redis 在创建新 AOF 文件的过程中，append 模式不断的将修改数据追加到现有的 AOF 文件里面，即使重写过程中发生停机，现有的 AOF 文件也不会丢失。而一旦新 AOF 文件创建完毕，Redis 就会从旧 AOF 文件切换到新 AOF 文件，并开始对新 AOF 文件进行追加操作</li>
<li>AOF 包含一个格式清晰、易于理解的日志文件用于记录所有的修改操作。事实上，也可以通过该文件完成数据的重建<br>AOF 文件有序地保存了对数据库执行的所有写入操作，这些写入操作以 Redis 协议的格式保存，因此 AOF 文件的内容非常容易被人读懂，对文件进行分析（parse）也很轻松。导出（export）AOF 文件也非常简单，举个例子：如果你不小心执行了 FLUSHALL 命令，但只要 AOF 文件未被重写，那么只要停止服务器，移除 AOF 文件末尾的 FLUSHAL 命令，并重启 Redis，就可以将数据集恢复到 FLUSHALL 执行之前的状态</li>
</ul>
<p>缺点：</p>
<ul>
<li>即使有些操作是重复的也会全部记录，AOF 的文件大小要大于 RDB 格式的文件</li>
<li>AOF 在恢复大数据集时的速度比 RDB 的恢复速度要慢</li>
<li>根据 fsync 策略不同,AOF 速度可能会慢于 RDB</li>
<li>bug 出现的可能性更多</li>
</ul>
<h5 id="RDB-和-AOF-的选择"><a href="#RDB-和-AOF-的选择" class="headerlink" title="RDB 和 AOF 的选择"></a>RDB 和 AOF 的选择</h5><p>如果主要充当缓存功能,或者可以承受数分钟数据的丢失, 通常生产环境一般只需启用 RDB 即可,此也是默认值</p>
<p>如果数据需要持久保存,一点不能丢失,可以选择同时开启 RDB 和 AOF,一般不建议只开启 AOF</p>
<h3 id="Redis-常用命令"><a href="#Redis-常用命令" class="headerlink" title="Redis 常用命令"></a>Redis 常用命令</h3><ul>
<li>info：显示当前节点 redis 运行状态信息</li>
<li>select：切换数据库，相当于在 MySQL 的 USE DBNAME 指令</li>
<li>keys：查看当前库下的所有 key，慎用！可以考虑禁用</li>
<li>bgsave：手动在后台执行 RDB 持久化操作</li>
<li>dbsize：返回当前库下的所有 key 数量</li>
<li>flushdb：强制清空当前库中的所有 key，慎用！可以考虑禁用</li>
<li>flushall：强制清空当前 redis 服务器所有数据库中的所有 key，即删除所有数据，慎用！可以考虑禁用</li>
<li>shutdown：安全关闭 redis<ol>
<li>停止所有客户端</li>
<li>如果有至少一个保存点在等待，执行 SAVE 命令</li>
<li>如果 AOF 选项被打开，更新 AOF 文件</li>
<li>关闭 redis 服务器（server）</li>
</ol>
</li>
</ul>
<h3 id="Redis-数据类型"><a href="#Redis-数据类型" class="headerlink" title="Redis 数据类型"></a>Redis 数据类型</h3><ul>
<li>字符串 string</li>
<li>列表 list</li>
<li>集合 set</li>
<li>有序集合 sorted set</li>
<li>哈希 hash</li>
</ul>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><p>消息队列主要分为两种，这两种模式 Redis 都支持</p>
<ul>
<li>生产者&#x2F;消费者模式</li>
<li>发布者&#x2F;订阅者模式</li>
</ul>
<h4 id="生产者消费者模式"><a href="#生产者消费者模式" class="headerlink" title="生产者消费者模式"></a>生产者消费者模式</h4><p>list</p>
<h4 id="发布者模式"><a href="#发布者模式" class="headerlink" title="发布者模式"></a>发布者模式</h4><p>在发布者订阅者模式下，发布者将消息发布到指定的 channel 里面，凡是监听该 channel 的消费者都会收到同样的</p>
<ul>
<li>Publisher：发布者</li>
<li>Subscriber：订阅者</li>
<li>Channel：频道</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SUBSCRIBE channel1 <span class="token comment"># 订阅频道</span>

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PUBLISH channel1 test1 <span class="token comment"># 发布消息，然后订阅者都能收到消息</span>

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> unsubscribe channel1 <span class="token comment"># 取消订阅</span></code></pre>

<h2 id="Redis-高可用和集群"><a href="#Redis-高可用和集群" class="headerlink" title="Redis 高可用和集群"></a>Redis 高可用和集群</h2><h3 id="Redis-主从复制"><a href="#Redis-主从复制" class="headerlink" title="Redis 主从复制"></a>Redis 主从复制</h3><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><ol>
<li><p>确保主从的配置文件（redis.conf）中 bind 设置为 0.0.0.0</p>
</li>
<li><p>从节点执行：<code>replicaof &lt;masterip&gt; &lt;masterport&gt;</code>，例如<code> REPLICAOF 10.0.0.72 6379</code></p>
<p>或者直接修改配置文件，如果使用命令配置，建议也修改配置文件，否则重启会失效</p>
</li>
<li><p><code>INFO replication</code> 查看主从复制信息，<code>REPLICAOF no one</code> 取消主从复制</p>
</li>
</ol>
<p>如果设置了<code>replica-read-only yes</code>，则从节点只读，不能写</p>
<p><strong>requirepass 和 masterauth：</strong></p>
<ul>
<li>requirepass：针对客户端，对登录权限做限制，redis 每个节点的 requirepass 可以是独立的，不同的</li>
<li>masterauth：master 设置，在 slave 节点数据库同步的时候用到</li>
</ul>
<h4 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h4><p>从节点故障：因为从节点只负责读，当从节点故障，修改代码，连接其他从节点即可</p>
<p>主节点故障：需要提升一个从节点为主节点，然后把其他从节点重新指向新的主节点</p>
<ol>
<li><p>提升主节点：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 10.0.0.18</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> REPLICAOF NO ONE</code></pre>
</li>
<li><p>其他从节点重新指向新的主节点</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> SLAVEOF <span class="token number">10.0</span>.0.18 <span class="token number">6379</span></code></pre></li>
</ol>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>主从复制分为全量同步和增量同步，全量复制一般发生在 Slave 首次初始化阶段，这时 Slave 需要将 Master 上的所有数据都复制一份</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 复制缓冲区大小,建议要设置足够大</span>
repl-backlog-size 1mb
<span class="token comment"># 当没有slave需要同步的时候，多久可以释放环形队列：</span>
repl-backlog-ttl <span class="token number">3600</span></code></pre>

<p><strong>避免全量复制：</strong></p>
<ul>
<li>第一次全量复制不可避免，后续的全量复制可以利用小主节点(内存小)，业务低峰时进行全量</li>
<li>节点运行 ID 不匹配：主节点重启会导致 RUNID 变化，可能会触发全量复制，可以利用故障转移，例如哨兵或集群，而从节点重启动，避免导致全量复制</li>
<li>复制积压缓冲区不足：当主节点生成的新数据大于缓冲区大小，从节点恢复和主节点连接后，会导致全量复制。解决方法可以将 repl-backlog-size 调大</li>
</ul>
<p><strong>避免全量复制：</strong></p>
<ul>
<li>当主节点重启，多从节点复制</li>
</ul>
<p><strong>优化配置：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 是否使用无盘同步RDB文件，默认为no，no为不使用无盘，需要将RDB文件保存到磁盘后再发送给slave，yes为支持无盘，支持无盘就是RDB文件不需要保存至本地磁盘，而且直接通过socket文件发送给slave</span>
repl-diskless-sync no

<span class="token comment"># diskless时复制的服务器等待的延迟时间</span>
repl-diskless-sync-delay <span class="token number">5</span>

<span class="token comment"># slave端向server端发送ping的时间间隔，默认为10秒</span>
repl-ping-slave-period <span class="token number">10</span>

<span class="token comment"># 设置主从ping连接超时时间,超过此值无法连接,master_link_status显示为down,并记录错误日志</span>
repl-timeout <span class="token number">60</span>

<span class="token comment"># 是否启用TCP_NODELAY，如设置成yes，则redis会合并小的TCP包从而节省带宽， 但会增加同步延迟（40ms），造成master与slave数据不一致，假如设置成no，则redismaster会立即发送同步数据，没有延迟，yes关注性能，no关注redis服务中的数据一致性</span>
repl-disable-tcp-nodelay no

<span class="token comment"># master的写入数据缓冲区，用于记录自上一次同步后到下一次同步过程中间的写入命令，计算公式：repl-backlog-size = 允许从节点最大中断时长 * 主实例offset每秒写入量，比如master每秒最大写入64mb，最大允许60秒，那么就要设置为64mb*60秒=3840MB(3.8G),建议此值是设置的足够大</span>
repl-backlog-size 1mb

<span class="token comment"># 一段时间后slave没有连接到master，则backlog size的内存将会被释放。如果值为0则 表示永远不释放这部份内存</span>
repl-backlog-ttl <span class="token number">3600</span>

<span class="token comment"># slave端的优先级设置，值是一个整数，数字越小表示优先级越高。当master故障时将会按照优先级来选择slave端进行恢复，如果值设置为0，则表示该slave永远不会被选择</span>
slave-priority <span class="token number">100</span>

<span class="token comment"># 设置一个master的可用slave不能少于多少个，否则master无法执行写</span>
min-replicas-to-write <span class="token number">1</span>

<span class="token comment"># 设置至少有上面数量的slave延迟时间都大于多少秒时，master不接收写操作(拒绝写入)</span>
min-slaves-max-lag <span class="token number">20</span></code></pre>

<h4 id="常见故障"><a href="#常见故障" class="headerlink" title="常见故障"></a>常见故障</h4><ul>
<li>master 密码不对</li>
<li>Redis 版本不一致</li>
<li>没有设置 bind 地址或者 密码，导致无法远程连接</li>
<li>配置不一致，例如：<ul>
<li>主从节点的 maxmemory 不一致,主节点内存大于从节点内存,主从复制可能丢失数据</li>
<li>rename-command 不一致,如在主节点定义了 flushdb，从节点没定义，结果执行 flushdb,不同步</li>
</ul>
</li>
</ul>
<h3 id="Redis-哨兵"><a href="#Redis-哨兵" class="headerlink" title="Redis 哨兵"></a>Redis 哨兵</h3><ul>
<li>sentinel 实际上是一个特殊的 redis 服务器，很多 redis 命令不支持，默认监听在 26379&#x2F;tcp 端口</li>
<li>哨兵可以不与 redis 部署在一起，但是一般都部署在一起</li>
<li>Sentinel 节点个数应该为大于等于 3 且最好为奇数</li>
<li>Sentinel 进程监控 redis 集群中 Master 主服务器工作的状态，在 Master 主服务器发生故障时，可以实现 Master 和 Slave 服务器的切换，保证系统的高可用</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
<span class="token comment"># 如果不设置密码，protected-mode需要设置为no，否则无法远程连接</span>
protected-mode no
port <span class="token number">26379</span>
daemonize no
pidfile /usr/local/redis/run/redis-sentinel.pid
logfile <span class="token string">"/usr/local/redis/var/sentinel.log"</span>

<span class="token comment"># sentinel announce-ip &lt;ip></span>
<span class="token comment"># sentinel announce-port &lt;port></span>
<span class="token comment"># sentinel announce-ip 1.2.3.4</span>

<span class="token function">dir</span> /tmp

<span class="token comment"># sentinel monitor &lt;master-name> &lt;ip> &lt;redis-port> &lt;quorum></span>
<span class="token comment"># 主从复制架构中，执行master的ip、端口，当2个哨兵标记master下线，则判定master客观下线</span>
sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span>

<span class="token comment"># sentinel auth-pass &lt;master-name> &lt;password></span>
<span class="token comment"># 指定master的账号密码</span>
<span class="token comment"># sentinel auth-pass mymaster MySUPER--secret-0123passw0rd</span>

<span class="token comment"># sentinel down-after-milliseconds &lt;master-name> &lt;milliseconds></span>
<span class="token comment"># 超时没有返回ping或者直接返回错误，则标记为下线，默认3秒</span>
sentinel down-after-milliseconds mymaster <span class="token number">30000</span>

<span class="token comment"># sentinel parallel-syncs &lt;master-name> &lt;numreplicas></span>
<span class="token comment"># 故障发生后，从节点需要从新的主节点同步数据，此项规定并发同步数，即同时允许几个slave从master同步数据，设置1同步时间最久，对主节点压力最小</span>
sentinel parallel-syncs mymaster <span class="token number">1</span>

<span class="token comment"># sentinel failover-timeout &lt;master-name> &lt;milliseconds></span>
<span class="token comment"># failover(故障转移)的超时时间，用于以下四种情况：</span>
<span class="token comment"># 1.同一个sentinel对同一个master两次failover之间的间隔时间</span>
<span class="token comment"># 2.当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时</span>
<span class="token comment"># 3.当想要取消一个正在进行的failover所需要的时间</span>
<span class="token comment"># 4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了</span>
sentinel failover-timeout mymaster <span class="token number">180000</span>

<span class="token comment"># sentinel notification-script &lt;master-name> &lt;script-path></span>
<span class="token comment"># sentinel notification-script mymaster /var/redis/notify.sh</span>
<span class="token comment"># sentinel client-reconfig-script &lt;master-name> &lt;script-path></span>
<span class="token comment"># &lt;master-name> &lt;role> &lt;state> &lt;from-ip> &lt;from-port> &lt;to-ip> &lt;to-port></span>
<span class="token comment"># sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</span>

<span class="token comment"># 禁止修改脚本</span>
sentinel deny-scripts-reconfig <span class="token function">yes</span>
</code></pre>

<p>启动服务后，redis 会对配置文件做一些修改</p>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>范例：master：10.0.0.71、slave：10.0.0.72 和 10.0.0.73</p>
<ol>
<li><p>修改配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 从节点修改 redis.conf</span>
replicaof <span class="token number">10.0</span>.0.71 <span class="token number">6379</span>

<span class="token comment"># 从节点修改 redis-sentinel.conf</span>
sentinel monitor mymaster <span class="token number">10.0</span>.0.71 <span class="token number">6379</span> <span class="token number">2</span></code></pre>
</li>
<li><p>启动 redis 和 redis-sentinel 服务</p>
</li>
<li><p>测试</p>
</li>
<li><p>手动下线主节点，让 10.0.0.72 提升为主节点</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/redis.conf</span>
replica-priority <span class="token number">10</span> <span class="token comment"># 指定优先级,值越小sentinel会优先将之选为新的master,默为值为100</span>

<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token comment">#redis-cli -p 26379</span>
<span class="token number">127.0</span>.0.1:2637<span class="token operator"><span class="token file-descriptor important">9</span>></span> sentinel failover mymaster	<span class="token comment"># 手动下线主节点，任意一个节点均可执行</span>
OK</code></pre></li>
</ol>
<h4 id="应用程序连接"><a href="#应用程序连接" class="headerlink" title="应用程序连接"></a>应用程序连接</h4><p>客户端不直接连接 redis，而是连接 sentinel，不过 sentinel 不是代理，以 python 为例：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python3</span>
<span class="token keyword">import</span> redis
<span class="token keyword">from</span> redis<span class="token punctuation">.</span>sentinel <span class="token keyword">import</span> Sentinel
<span class="token comment">#连接哨兵服务器(主机名也可以用域名)</span>
sentinel <span class="token operator">=</span> Sentinel<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">'10.0.0.8'</span><span class="token punctuation">,</span> <span class="token number">26379</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'10.0.0.18'</span><span class="token punctuation">,</span> <span class="token number">26379</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'10.0.0.28'</span><span class="token punctuation">,</span> <span class="token number">26379</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>socket_timeout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span></code></pre>

<h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h3><p>Sentinel 机制可以解决 master 和 slave 角色的自动切换问题，但单个 Master 的性能瓶颈问题无法解决，类似于 MySQL 中的 MHA 功能，redis 3.0 之前版本中，生产环境一般使用哨兵模式</p>
<p>redis 3.0 版本之后推出了无中心架构的 redis cluster 机制，在无中心的 redis 集群当中，其每个节点保存当前节点数据和整个集群状态,每个节点都和其他所有节点连接</p>
<p>Redis Cluster 特点：</p>
<ul>
<li>所有 Redis 节点使用(PING 机制)互联</li>
<li>集群中某个节点的是否失效，是由整个集群中超过半数的节点监测都失效，才能算真正的失效</li>
<li>客户端不需要代理即可直接连接 redis，应用程序中需要配置有全部的 redis 服务器 IP</li>
<li>redis cluster 把所有的 redis node 平均映射到 0-16383 个槽位(slot)上，读写需要到指定的 redisnode 上进行操作，因此有多少个 redis node 相当于 redis 并发扩展了多少倍，每个 redis node 承担 16384&#x2F;N 个槽位</li>
<li>Redis cluster 预先分配 16384 个(slot)槽位，当需要在 redis 集群中写入一个 key -value 的时候，会使用 CRC16(key) mod 16384 之后的值，决定将 key 写入值哪一个槽位从而决定写入哪一个 Redis 节点上，从而有效解决单机瓶颈</li>
</ul>
<h4 id="Redis-Cluster-架构"><a href="#Redis-Cluster-架构" class="headerlink" title="Redis Cluster 架构"></a>Redis Cluster 架构</h4><img data-src="//img.to2b.cn/blog/ljk/1604491086857.png" style="zoom:150%;" />

<p>当主节点出现故障，其从节点会自动提升</p>
<h4 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h4><p>6 个节点 10.0.0.[71-76]，其中 10.0.0.[71-73]是主节点、10.0.0.[74-76]是从节点</p>
<ol>
<li><p>修改 redis.conf 相关配置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启集群</span>
cluster-enabled <span class="token function">yes</span>
<span class="token comment"># 集群状态文件，记录主从关系及slot范围信息，由redis cluster集群自动创建和维护</span>
cluster-config-file nodes-6379.conf
<span class="token comment"># 默认yes，一个节点下线整个集群不可用；设置为no，则其他正常节点还可以继续提供对外访问</span>
cluster-require-full-coverage no</code></pre>
</li>
<li><p>启动 redis 服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动之前确保集群中的每个节点是干净的，需要清除dump.rdb、nodes-6379.conf等文件</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/local/redis/data/*
systemctl start redis.service</code></pre>
</li>
<li><p>创建集群</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># --cluster-replicas 1 表示每个master对应一个slave节点</span>
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">--cluster</span> create <span class="token number">10.0</span>.0.71:6379 <span class="token number">10.0</span>.0.72:6379 <span class="token number">10.0</span>.0.73:6379 <span class="token number">10.0</span>.0.74:6379 <span class="token number">10.0</span>.0.75:6379 <span class="token number">10.0</span>.0.76:6379 --cluster-replicas <span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> Performing <span class="token builtin class-name">hash</span> slots allocation on <span class="token number">6</span> nodes<span class="token punctuation">..</span>.
Master<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">0</span> - <span class="token number">5460</span>
Master<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">5461</span> - <span class="token number">10922</span>
Master<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">10923</span> - <span class="token number">16383</span>
Adding replica <span class="token number">10.0</span>.0.75:6379 to <span class="token number">10.0</span>.0.71:6379
Adding replica <span class="token number">10.0</span>.0.76:6379 to <span class="token number">10.0</span>.0.72:6379
Adding replica <span class="token number">10.0</span>.0.74:6379 to <span class="token number">10.0</span>.0.73:6379
M: 52c617ce1f5e67ee2da39beb8ae99240914f6f6d <span class="token number">10.0</span>.0.71:6379 <span class="token comment"># M：master</span>
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
M: 4fd60cab86be22d0a9edac1a8b7ac07b293e497d <span class="token number">10.0</span>.0.72:6379
   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
M: 8406e58b4d132960300074f431b0b4b9900c94a5 <span class="token number">10.0</span>.0.73:6379
   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
S: 6c7f8028a16d1f07e7be7a33fa23528e7e9d69c6 <span class="token number">10.0</span>.0.74:6379	<span class="token comment"># S：slave</span>
   replicates 8406e58b4d132960300074f431b0b4b9900c94a5
S: 01849d7567cee594e6ebe2b6f09d19008a1e625b <span class="token number">10.0</span>.0.75:6379
   replicates 52c617ce1f5e67ee2da39beb8ae99240914f6f6d
S: 461a59fd85df1839d77877e66aaa4a08ffff068f <span class="token number">10.0</span>.0.76:6379
   replicates 4fd60cab86be22d0a9edac1a8b7ac07b293e497d
Can I <span class="token builtin class-name">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span> <span class="token comment"># 输入yes自动创建集群</span>
<span class="token operator">>></span><span class="token operator">></span> Nodes configuration updated
<span class="token operator">>></span><span class="token operator">></span> Assign a different config epoch to each <span class="token function">node</span>
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER MEET messages to <span class="token function">join</span> the cluster
Waiting <span class="token keyword">for</span> the cluster to <span class="token function">join</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">10.0</span>.0.71:6379<span class="token punctuation">)</span>
M: 52c617ce1f5e67ee2da39beb8ae99240914f6f6d <span class="token number">10.0</span>.0.71:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master	<span class="token comment"># 分配的槽位</span>
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>	<span class="token comment"># 添加一个从节点</span>
S: 6c7f8028a16d1f07e7be7a33fa23528e7e9d69c6 <span class="token number">10.0</span>.0.74:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave	<span class="token comment"># 从节点没有分配槽位</span>
   replicates 8406e58b4d132960300074f431b0b4b9900c94a5
M: 8406e58b4d132960300074f431b0b4b9900c94a5 <span class="token number">10.0</span>.0.73:6379
   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 461a59fd85df1839d77877e66aaa4a08ffff068f <span class="token number">10.0</span>.0.76:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 4fd60cab86be22d0a9edac1a8b7ac07b293e497d
M: 4fd60cab86be22d0a9edac1a8b7ac07b293e497d <span class="token number">10.0</span>.0.72:6379
   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 01849d7567cee594e6ebe2b6f09d19008a1e625b <span class="token number">10.0</span>.0.75:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 52c617ce1f5e67ee2da39beb8ae99240914f6f6d
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.

<span class="token comment">#观察以上结果，可以看到3组master/slave</span>
master:10.0.0.71---slave:10.0.0.74
master:10.0.0.72---slave:10.0.0.75
master:10.0.0.73---slave:10.0.0.76</code></pre>
</li>
<li><p>在每个节点执行<code>info replication</code> 可以查看此节点的主从信息</p>
</li>
<li><p>在任意节点执行 <code>cluster nodes</code>可以查看所有节点的 ID 及连接信息</p>
</li>
<li><p>在任意节点执行 <code>cluster info</code>可以查看整个集群的状态信息</p>
</li>
<li><p>在任意节点执行 <code>redis-cli --cluster info 10.0.0.71:6379</code> 可以查看所有主节点的信息</p>
</li>
<li><p>在任意节点执行 <code>redis-cli --cluster check 10.0.0.71:6379</code> 可以查看所有节点的信息</p>
</li>
</ol>
<h4 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h4><h5 id="动态扩容"><a href="#动态扩容" class="headerlink" title="动态扩容"></a>动态扩容</h5><p>目前集群中有 6 个节点 10.0.0.[71-76]，三主三从，现在要将 10.0.0.77 添加到集群中</p>
<ol>
<li><p>添加节点：在任意一个节点上执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.0.77:6379  <span class="token operator">&lt;</span>当前任意集群节点<span class="token operator">></span>:6379</code></pre>

<p>新节点是 master，且没有分配槽位</p>
</li>
<li><p>给新 master 节点分配槽位</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> reshard <span class="token operator">&lt;</span>当前任意集群节点<span class="token operator">></span>:6379

<span class="token comment"># 需要移动多少槽位？ 16384/master个数，这里16384/4=4096</span>
How many slots <span class="token keyword">do</span> you want to move <span class="token punctuation">(</span>from <span class="token number">1</span> to <span class="token number">16384</span><span class="token punctuation">)</span>?4096
<span class="token comment"># 哪个节点接收移动的槽位？当然是新添加的master节点了，输入10.0.0.77的node ID</span>
What is the receiving <span class="token function">node</span> ID?defa5ca3d7aaecea240a79ad2c9b572ebf32464a
<span class="token comment"># 哪些节点提供槽位，all表示当前所有master节点，或者输入一个或多个node ID，最后输入done表示结束</span>
Please enter all the <span class="token builtin class-name">source</span> <span class="token function">node</span> IDs.
Type <span class="token string">'all'</span> to use all the nodes as <span class="token builtin class-name">source</span> nodes <span class="token keyword">for</span> the <span class="token builtin class-name">hash</span> slots.
Type <span class="token string">'done'</span> once you entered all the <span class="token builtin class-name">source</span> nodes IDs.
Source <span class="token function">node</span> <span class="token comment">#1:all</span>
<span class="token comment"># 确认分配</span>
Do you want to proceed with the proposed reshard plan <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? <span class="token function">yes</span></code></pre>

<ul>
<li><p>这样，新的 master 节点就分配了 4096 个槽位，由于这些槽位是其他三个 master 节点平均分配给新 master 节点的，所以避免不了槽位碎片化的问题</p>
</li>
<li><p>重新分配槽位后，之前节点的角色不变，但属关系可能发生改变，例如本来 10.0.0.71 的从节点是 10.0.0.74，扩容后它的从节点成了 10.0.0.75，而 10.0.0.74 成了 10.0.0.3 的从节点</p>
</li>
<li><p>这种扩容方法是在线的，不需要备份数据，如果数据量比较大的话，建议先备份</p>
</li>
</ul>
</li>
<li><p>为新的 master 添加新的 slave 节点</p>
<p>新的 master 节点没有 slave 节点，需要添加一个（10.0.0.78）以保证高可用，任意节点执行以下命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.0.78:6379 <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379 --cluster-slave --cluster-master-id defa5ca3d7aaecea240a79ad2c9b572ebf32464a</code></pre>

<p>或者先将新节点加入集群，再修改为 slave：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.0.78:6379 <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379
<span class="token punctuation">[</span>root@c78 ~<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli
<span class="token comment"># 查看当前集群节点，找到目标master 的ID</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CLUSTER NODES
<span class="token comment"># 将其设置slave，命令格式为cluster replicate MASTERID</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CLUSTER REPLICATE 8defa5ca3d7aaecea240a79ad2c9b572ebf32464a</code></pre></li>
</ol>
<h5 id="动态缩容"><a href="#动态缩容" class="headerlink" title="动态缩容"></a>动态缩容</h5><ul>
<li><p>从节点：在任意节点上执行<code>redis-cli --cluster del-node host:port node_id</code></p>
<p>删除 slave 节点 10.0.0.75：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604568641636.png"></p>
</li>
<li><p>主节点：需要在删除之前先把槽位移动到其他 master 节点上，可以使用交互式和命式两种方式</p>
<p>删除 master 节点 10.0.0.71：</p>
<ul>
<li><p>交互式：在任意节点上执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> reshard <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379
<span class="token punctuation">..</span>.
M: 52c617ce1f5e67ee2da39beb8ae99240914f6f6d <span class="token number">10.0</span>.0.71:6379
   slots:<span class="token punctuation">[</span><span class="token number">1364</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
<span class="token punctuation">..</span>.

<span class="token comment"># 需要移动多少槽位？ 10.0.0.71有4096个槽位，需要平均分给其他三个master节点，所以我们分1365、1365、1366三次移动</span>
How many slots <span class="token keyword">do</span> you want to move <span class="token punctuation">(</span>from <span class="token number">1</span> to <span class="token number">16384</span><span class="token punctuation">)</span>?1365
<span class="token comment"># 哪个节点接收移动的槽位？经过观察10.0.0.77适合接受，依据是尽量不造成槽位的碎片化</span>
What is the receiving <span class="token function">node</span> ID?defa5ca3d7aaecea240a79ad2c9b572ebf32464a
<span class="token comment"># 哪些节点提供槽位，当然是要删除的10.0.0.71了</span>
Please enter all the <span class="token builtin class-name">source</span> <span class="token function">node</span> IDs.
Type <span class="token string">'all'</span> to use all the nodes as <span class="token builtin class-name">source</span> nodes <span class="token keyword">for</span> the <span class="token builtin class-name">hash</span> slots.
Type <span class="token string">'done'</span> once you entered all the <span class="token builtin class-name">source</span> nodes IDs.
Source <span class="token function">node</span> <span class="token comment">#1:52c617ce1f5e67ee2da39beb8ae99240914f6f6d</span>
Source <span class="token function">node</span> <span class="token comment">#2:done</span>
<span class="token comment"># 确认分配</span>
<span class="token punctuation">..</span>.
Moving slot <span class="token number">2727</span> from <span class="token number">10.0</span>.0.71:6379 to <span class="token number">10.0</span>.0.77:6379: 	<span class="token comment"># 注意观察，不要出错</span>
<span class="token punctuation">..</span>.
Do you want to proceed with the proposed reshard plan <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? <span class="token function">yes</span></code></pre>
</li>
<li><p>命令式：在任意节点上执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 移动1365个槽位到10.0.0.72</span>
redis-cli <span class="token parameter variable">--cluster</span> reshard <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379 --cluster-slots <span class="token number">1365</span> --cluster-from 52c617ce1f5e67ee2da39beb8ae99240914f6f6d --cluster-to 4fd60cab86be22d0a9edac1a8b7ac07b293e497d --cluster-yes

<span class="token comment"># 移动最后的1366个槽位到10.0.0.73</span>
redis-cli <span class="token parameter variable">--cluster</span> reshard <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379 --cluster-slots <span class="token number">1366</span> --cluster-from 52c617ce1f5e67ee2da39beb8ae99240914f6f6d --cluster-to 8406e58b4d132960300074f431b0b4b9900c94a5 --cluster-yes</code></pre>

<p>10.0.0.71 上的槽位都移走了之后，其 slave 节点（如果有）也会变成了其他 master 节点的 slave 节点</p>
</li>
</ul>
<p>最后执行 <code>redis-cli --cluster del-node host:port node_id </code>即可将 10.0.0.71 节点删除</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">--cluster</span> del-node <span class="token number">10.0</span>.0.71:6379 52c617ce1f5e67ee2da39beb8ae99240914f6f6d
<span class="token operator">>></span><span class="token operator">></span> Removing <span class="token function">node</span> 52c617ce1f5e67ee2da39beb8ae99240914f6f6d from cluster <span class="token number">10.0</span>.0.71:6379
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER FORGET messages to the cluster<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> SHUTDOWN the node.</code></pre></li>
</ul>
<h5 id="导入现有数据至集群"><a href="#导入现有数据至集群" class="headerlink" title="导入现有数据至集群"></a>导入现有数据至集群</h5><p>在任意集群节点上执行：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> <span class="token function">import</span> <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379 --cluster-from <span class="token operator">&lt;</span>外部Redis<span class="token operator">></span>:6379 --cluster-copy --cluster-replace</code></pre>

<ul>
<li>–cluster-replace：当导入的数据和已有的数据有重复的 key，–cluster-replace 表示替换为导入的数据</li>
</ul>
<h5 id="集群偏斜"><a href="#集群偏斜" class="headerlink" title="集群偏斜"></a>集群偏斜</h5><p>redis cluster 多个节点运行一段时间后，可能会出现倾斜现象，某个节点数据偏多，内存消耗更大，或者接受用户请求访问更多，发生倾斜的原因可能如下：</p>
<ul>
<li>不同槽对应的键值数量差异较大</li>
<li>包含 bigkey，建议少用</li>
<li>内存相关配置不一致</li>
</ul>
<p>获取指定槽位中对应 key 值个数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli cluster countkeysinslot <span class="token punctuation">&#123;</span>slot的值<span class="token punctuation">&#125;</span></code></pre>

<p>执行自动的槽位重新平衡分布，但会影响客户端的访问，慎用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--cluster</span> rebalance <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379</code></pre>

<p>获取 bigkey，建议在 slave 节点运行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">--bigkeys</span></code></pre>

<h5 id="解散集群"><a href="#解散集群" class="headerlink" title="解散集群"></a>解散集群</h5><p><code>systemctl stop redis.service</code>关闭所有的 redis 服务，然后删除 nodes-6379.conf 文件，修改 redis.conf：<code>cluster-enabled no</code></p>
<h4 id="redis-cluster-的局限性"><a href="#redis-cluster-的局限性" class="headerlink" title="redis cluster 的局限性"></a>redis cluster 的局限性</h4><ul>
<li>命令无法跨节点使用，所以 mset、mget、sunion 等操作支持不友好</li>
<li>客户端维护更复杂，客户端为了可以直接定位某个具体的 key 所在的节点，它就需要缓存槽位相关信息，这样才可以准确快速地定位到相应的节点。同时因为槽位的信息可能会存在客户端与服务器不一致的情况，还需要纠正机制来实现槽位信息的校验调整</li>
<li>不支持多个数据库，集群模式下只有一个 db0</li>
<li>主从复制只有一层，不支持级联复制</li>
<li>节点因为某些原因发生阻塞（阻塞时间大于 clutser-node-timeout）被判断下线，这种 failover 是没有必要的</li>
</ul>
<p>以上缺点只有第一点是比较麻烦的</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/ANSIBLE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/ANSIBLE/" class="post-title-link" itemprop="url">ANSIBLE</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:30:58" itemprop="dateCreated datePublished" datetime="2020-12-09T23:30:58+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">运维自动化</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/" itemprop="url" rel="index"><span itemprop="name">ANSIBLE</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ansible-介绍和架构"><a href="#ansible-介绍和架构" class="headerlink" title="ansible 介绍和架构"></a>ansible 介绍和架构</h2><h3 id="ansible-特性"><a href="#ansible-特性" class="headerlink" title="ansible 特性"></a>ansible 特性</h3><ul>
<li>基于 python 实现</li>
<li>模块化：支持自定义模块，可以使用任何语言编写模块</li>
<li>安全：基于 OpenSSH</li>
<li>部署简单：被控端不需要配置环境</li>
<li>幂等性：一个任何执行一遍和执行 n 遍效果一样，不因重复执行带来意外情况，此特性非绝对</li>
<li>支持 playbook 编排任务，YAML 格式，编排任务，支持丰富的数据结构</li>
<li>较强大的多层解决方案 role</li>
</ul>
<h3 id="ansible-架构"><a href="#ansible-架构" class="headerlink" title="ansible 架构"></a>ansible 架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1603019949400.png"></p>
<ul>
<li>INVENTORY：Ansible 管理主机的清单&#x2F;etc&#x2F;anaible&#x2F;hosts</li>
<li>MODULES：Ansible 执行命令的功能模块，多数为内置核心模块，也可自定义</li>
<li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li>
<li>API：供第三方程序调用的应用程序编程接口</li>
</ul>
<h3 id="ansible-命令执行来源"><a href="#ansible-命令执行来源" class="headerlink" title="ansible 命令执行来源"></a>ansible 命令执行来源</h3><ul>
<li>USER：普通用户，即 SYSTEM ADMINISTRATOR</li>
<li>PLAYBOOKS：任务剧本（任务集），编排定义 Ansible 任务集的配置文件，由 Ansible 顺序依次执行，通常是 JSON 格式的 YML 文件</li>
<li>CMDB（配置管理数据库） API 调用</li>
<li>PUBLIC&#x2F;PRIVATE CLOUD API 调用</li>
<li>USER-&gt; Ansible Playbook -&gt; Ansibile</li>
</ul>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>执行 ansible 的主机一般称为管理端, 主控端，中控，master 或堡垒机</li>
<li>主控端 Python 版本需要 2.6 或以上</li>
<li>如果被控端 Python 版本小于 2.4，则需要安装 python-simplejson</li>
<li>被控端如开启 SELinux 需要安装 libselinux-python</li>
<li>windows 不能做为主控端</li>
</ul>
<h2 id="ansible-安装和入门"><a href="#ansible-安装和入门" class="headerlink" title="ansible 安装和入门"></a>ansible 安装和入门</h2><p>pip 安装后没有配置文件，需要手动创建，有以下四种方式：</p>
<ol>
<li>ANSIBLE_CONFIG (environment variable if set)</li>
<li>ansible.cfg (in the current directory)</li>
<li>~&#x2F;.ansible.cfg (in the home directory)</li>
<li>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</li>
</ol>
<h3 id="ansible-相关文件"><a href="#ansible-相关文件" class="headerlink" title="ansible 相关文件"></a>ansible 相关文件</h3><ul>
<li>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg 主配置文件，配置 ansible 工作特性</li>
<li>&#x2F;etc&#x2F;ansible&#x2F;hosts 主机清单</li>
<li>&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F; 存放角色的目录</li>
</ul>
<h4 id="ansible-主配置文件"><a href="#ansible-主配置文件" class="headerlink" title="ansible 主配置文件"></a>ansible 主配置文件</h4><p>默认为：&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</p>
<p>参考文档：<a target="_blank" rel="noopener" href="http://www.ansible.com.cn/docs/intro_configuration.html">http://www.ansible.com.cn/docs/intro_configuration.html</a></p>
<h4 id="inventory-主机清单"><a href="#inventory-主机清单" class="headerlink" title="inventory 主机清单"></a>inventory 主机清单</h4><p>默认为：&#x2F;etc&#x2F;ansible&#x2F;hosts</p>
<p>参考文档：<a target="_blank" rel="noopener" href="http://www.ansible.com.cn/docs/intro_inventory.html?highlight=hosts">http://www.ansible.com.cn/docs/intro_inventory.html?highlight=hosts</a></p>
<p>示例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini">ntp.magedu.com
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">webservers</span><span class="token punctuation">]</span></span>
www1.magedu.com:2222
www2.magedu.com
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">dbservers</span><span class="token punctuation">]</span></span>
db1.magedu.com
db2.magedu.com
db3.magedu.com
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">websrvs</span><span class="token punctuation">]</span></span>
www[1:100].example.com
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">dbsrvs</span><span class="token punctuation">]</span></span>
db-[a:f].example.com
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">appsrvs</span><span class="token punctuation">]</span></span>
<span class="token comment"># 表示 10.0.0.1 - 10.0.0.100</span>
10.0.0.[1:100]
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">ex-lb</span><span class="token punctuation">]</span></span>
<span class="token comment"># 定义主机变量，这些变量定义后可在 playbooks 中使用</span>
<span class="token key attr-name">10.0.2.1 LB_ROLE</span><span class="token punctuation">=</span><span class="token value attr-value">backup EX_APISERVER_VIP=10.0.2.188 EX_APISERVER_PORT=8443</span>
<span class="token key attr-name">10.0.2.2 LB_ROLE</span><span class="token punctuation">=</span><span class="token value attr-value">master EX_APISERVER_VIP=10.0.2.188 EX_APISERVER_PORT=8443</span></code></pre>

<p>给主机组设置变量，示例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">all:vars</span><span class="token punctuation">]</span></span>						# 为所有主机组设置变量
<span class="token key attr-name">CONTAINER_RUNTIME</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">docker</span>"</span>
<span class="token key attr-name">CLUSTER_NETWORK</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">calico</span>"</span>
<span class="token key attr-name">PROXY_MODE</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">ipvs</span>"</span>
<span class="token key attr-name">SERVICE_CIDR</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">192.168.0.0/16</span>"</span>
<span class="token key attr-name">CLUSTER_CIDR</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">10.10.0.0/16</span>"</span>
<span class="token key attr-name">NODE_PORT_RANGE</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">30000-60000</span>"</span>
<span class="token key attr-name">CLUSTER_DNS_DOMAIN</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">ljk.local.</span>"</span>
<span class="token key attr-name">bin_dir</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">/usr/local/bin</span>"</span>
<span class="token key attr-name">ca_dir</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">/etc/kubernetes/ssl</span>"</span>
<span class="token key attr-name">base_dir</span><span class="token punctuation">=</span><span class="token value attr-value">"<span class="token inner-value">/etc/ansible</span>"</span></code></pre>

<p>注意：ansible 会隐式创建一个 localhost 主机，只是 localhost 不能匹配 all</p>
<h3 id="ansible-相关工具"><a href="#ansible-相关工具" class="headerlink" title="ansible 相关工具"></a>ansible 相关工具</h3><ul>
<li>ansible：主程序，临时命令执行工具</li>
<li>ansible-doc：查看配置文档，模块功能查看工具,相当于 man</li>
<li>ansible-playbook：定制自动化任务，编排剧本工具,相当于脚本</li>
<li>ansible-pull：远程执行命令的工具</li>
<li>ansible-vault：文件加密工具</li>
<li>ansible-console：基于 Console 界面与用户交互的执行工具</li>
<li>ansible-galaxy：下载&#x2F;上传优秀代码或 Roles 模块的官网平台</li>
</ul>
<h4 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h4><p>通过 ssh 协议，实现对远程主机的配置管理、应用部署、任务执行等功能</p>
<p>注意：使用 ansible 之前，需要配置各个被控端基于 key 的密钥认证</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible <span class="token operator">&lt;</span>host-pattern<span class="token operator">></span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>.</code></pre>

<ul>
<li><p><a target="_blank" rel="noopener" href="http://www.ansible.com.cn/docs/intro_patterns.html">host-pattern</a>：匹配被控主机</p>
<ul>
<li>all：inventory 中的所有主机</li>
<li>支持通配符</li>
<li><a target="_blank" rel="noopener" href="http://www.ansible.com.cn/docs/intro_patterns.html">支持正则表达式</a>：需要以 ‘~’ 开头</li>
<li>使用:表示或关系</li>
<li>使用:&amp;表示与关系</li>
<li>使用:!表示非关系</li>
</ul>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># all</span>
ansible all –m <span class="token function">ping</span>
<span class="token comment"># 统配符</span>
ansible <span class="token string">"*"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
ansible <span class="token number">192.168</span>.1.* <span class="token parameter variable">-m</span> <span class="token function">ping</span>
ansible <span class="token string">"srvs"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
ansible <span class="token string">"10.0.0.6 10.0.0.7"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
<span class="token comment"># 或</span>
ansible <span class="token string">"websrvs:appsrvs"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
ansible <span class="token string">"192.168.1.10:192.168.1.20"</span> <span class="token parameter variable">-m</span> <span class="token function">ping</span>
<span class="token comment"># 与</span>
ansible <span class="token string">"websrvs:&amp;dbsrvs"</span> –m <span class="token function">ping</span>	<span class="token comment"># 在websrvs组并且在dbsrvs组中的主机</span>
<span class="token comment"># 非 注意此处为单引号</span>
ansible <span class="token string">'websrvs:!dbsrvs'</span> –m <span class="token function">ping</span>	<span class="token comment">#在websrvs组，但不在dbsrvs组中的主机</span>
<span class="token comment"># 综合逻辑</span>
ansible <span class="token string">'websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs'</span> –m <span class="token function">ping</span>
<span class="token comment"># 正则表达式</span>
ansible <span class="token string">"~(web|db).*\.magedu\.com"</span> –m <span class="token function">ping</span></code></pre>
</li>
<li><p>常用 option</p>
<ul>
<li>–version：显示版本等信息</li>
<li>-m module：指定模块，默认为 command</li>
<li>-a|–args MODULE_ARGS：指定模块的参数</li>
<li>–list-hosts：显示主机列表，可简写 –lists</li>
<li>-C|–check：检查，并不执行</li>
<li>-T|–timeout&#x3D;TIMEOUT：执行命令的超时时间，默认 10s</li>
<li>-k|–ask-pass：提示输入 ssh 连接密码，默认 Key 验证</li>
<li>-u| –user REMOTE_USER：指定远程执行的用户</li>
<li>-b|–become：代替旧版的 sudo 切换</li>
<li>–become-user&#x3D;USERNAME：指定 sudo 的 runas 用户，默认为 root</li>
<li>-K|–ask-become-pass：提示输入 sudo 时的口令</li>
</ul>
</li>
</ul>
<h5 id="ansible-命令执行顺序"><a href="#ansible-命令执行顺序" class="headerlink" title="ansible 命令执行顺序"></a>ansible 命令执行顺序</h5><ol>
<li>加载配置文件，默认&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</li>
<li>加载对应的模块文件，如：command</li>
<li>将模块或命令生成临时 py 文件，并将该文件传输至远程服务器远程服务器：$HOME&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-数字&#x2F;XXX.PY</li>
<li>给文件+x 权限</li>
<li>执行并返回结果</li>
<li>删除临时 py 文件，退出</li>
</ol>
<h5 id="ansible-执行状态"><a href="#ansible-执行状态" class="headerlink" title="ansible 执行状态"></a>ansible 执行状态</h5><p>在 ansible.cfg 的[colors]配置项中设置：</p>
<ul>
<li>绿色：执行成功且没有对目标主机做更改</li>
<li>黄色：执行成功且对目标主机做了更改</li>
<li>红色：执行失败</li>
</ul>
<h5 id="ansible-使用示例"><a href="#ansible-使用示例" class="headerlink" title="ansible 使用示例"></a>ansible 使用示例</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>venv<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@c71 bin<span class="token punctuation">]</span><span class="token variable">$ansible</span> all <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'ls ~'</span>
<span class="token number">10.0</span>.0.72 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
anaconda-ks.cfg
init.sh
original-ks.cfg
<span class="token number">10.0</span>.0.82 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
anaconda-ks.cfg
init.sh
original-ks.cfg
<span class="token number">10.0</span>.0.81 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
anaconda-ks.cfg
init.sh
original-ks.cfg
<span class="token punctuation">(</span>venv<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@c71 bin<span class="token punctuation">]</span><span class="token variable">$ansible</span> all <span class="token parameter variable">-m</span> <span class="token function">ping</span>
<span class="token number">10.0</span>.0.72 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
<span class="token number">10.0</span>.0.81 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/libexec/platform-python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
<span class="token number">10.0</span>.0.82 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/libexec/platform-python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="ansible-doc"><a href="#ansible-doc" class="headerlink" title="ansible-doc"></a>ansible-doc</h4><p>显示模块帮助，相当于 man</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible-doc <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>module<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<p>options：</p>
<ul>
<li>-l|–list：列出可用模块</li>
<li>-s|–snippet：显示指定模块的 playbook 片段</li>
</ul>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#列出所有模块</span>
ansible-doc <span class="token parameter variable">-l</span>
<span class="token comment">#查看指定模块帮助用法</span>
ansible-doc <span class="token function">ping</span>
<span class="token comment">#查看指定模块帮助用法</span>
ansible-doc <span class="token parameter variable">-s</span> <span class="token function">ping</span></code></pre>

<h4 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h4><p>执行编写好的 playbook 任务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible-playbook <span class="token operator">&lt;</span>filename.yml<span class="token operator">></span> <span class="token punctuation">..</span>. <span class="token punctuation">[</span>options<span class="token punctuation">]</span></code></pre>

<ul>
<li>–syntax-check：语法检查</li>
<li>-C|–check：只检测可能会发生的改变，但不真正执行操作</li>
<li>–list-hosts：列出运行任务的主机</li>
<li>–list-tags：列出 tag</li>
<li>–list-tasks：列出 task</li>
<li>–limit 主机列表：只针对主机列表中的特定主机执行</li>
<li>-v -vv -vvv：显示过程</li>
</ul>
<h4 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a>ansible-vault</h4><p>加密解密 yml 文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible-vault <span class="token punctuation">&#123;</span>create,decrypt,edit,view,encrypt,encrypt_string,rekey<span class="token punctuation">&#125;</span> <span class="token punctuation">..</span>.</code></pre>

<ul>
<li>encrypt：加密</li>
<li>decrypt：解密</li>
<li>view：查看</li>
<li>edit：编辑加密文件</li>
<li>rekey：修改口令</li>
<li>create：创建新文件</li>
</ul>
<h4 id="ansible-console"><a href="#ansible-console" class="headerlink" title="ansible-console"></a>ansible-console</h4><p>交互执行命令，支持 tab，ansible 2.0+新增</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">执行用户@当前操作的主机组 <span class="token punctuation">(</span>当前组的主机数量<span class="token punctuation">)</span><span class="token punctuation">[</span>f:并发数<span class="token punctuation">]</span>$</code></pre>

<p>常用子命令：</p>
<ul>
<li>设置并发数： forks n 例如： <code>forks 10</code></li>
<li>切换组： cd 主机组 例如： <code>cd web</code></li>
<li>列出当前组主机列表： <code>list</code></li>
<li>列出所有的内置命令： <code>?</code>或<code>help</code></li>
</ul>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>venv<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@c71 bin<span class="token punctuation">]</span><span class="token variable">$ansible</span>-console
Welcome to the ansible console.
Type <span class="token builtin class-name">help</span> or ? to list commands.

root@all <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span>f:5<span class="token punctuation">]</span>$ <span class="token function">ping</span>
<span class="token number">10.0</span>.0.72 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
<span class="token number">10.0</span>.0.82 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/libexec/platform-python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
<span class="token number">10.0</span>.0.81 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/libexec/platform-python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
root@all <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span>f:5<span class="token punctuation">]</span>$ list
<span class="token number">10.0</span>.0.72
<span class="token number">10.0</span>.0.81
<span class="token number">10.0</span>.0.82
root@all <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span>f:5<span class="token punctuation">]</span>$ <span class="token function">ls</span> ~
<span class="token number">10.0</span>.0.72 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
anaconda-ks.cfg
init.sh
original-ks.cfg
<span class="token number">10.0</span>.0.82 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
anaconda-ks.cfg
init.sh
original-ks.cfg
<span class="token number">10.0</span>.0.81 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
anaconda-ks.cfg
init.sh
original-ks.cfg
root@all <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span>f:5<span class="token punctuation">]</span>$ <span class="token builtin class-name">exit</span>

<span class="token punctuation">(</span>venv<span class="token punctuation">)</span> <span class="token punctuation">[</span>root@c71 bin<span class="token punctuation">]</span>$</code></pre>

<h4 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a>ansible-galaxy</h4><p>连接 <a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a> 下载相应的 roles</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#列出所有已安装的galaxy</span>
ansible-galaxy list
<span class="token comment">#安装galaxy</span>
ansible-galaxy <span class="token function">install</span> geerlingguy.mysql
ansible-galaxy <span class="token function">install</span> geerlingguy.redis
<span class="token comment">#删除galaxy</span>
ansible-galaxy remove geerlingguy.redis</code></pre>

<h3 id="ansible-常用模块"><a href="#ansible-常用模块" class="headerlink" title="ansible 常用模块"></a>ansible 常用模块</h3><p>本文以 ansible 2.10.5 为准</p>
<p>虽然模块众多，但最常用的模块也就 2，30 个而已，针对特定业务只用 10 几个模块</p>
<p>常用模块帮助文档参考：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 官网</span>
https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html
https://docs.ansible.com/ansible/latest/modules/modules_by_category.html
<span class="token comment"># 中文翻译</span>
http://www.ansible.com.cn/docs/modules.html</code></pre>

<p>使用 ansible-doc 可以查看每个模块的具体用法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以 command 模块为例</span>
ansible-doc <span class="token parameter variable">-s</span> <span class="token builtin class-name">command</span>			<span class="token comment"># 查看模块的可用选项</span>
ansible-doc <span class="token builtin class-name">command</span>				<span class="token comment"># 查看模块的详细帮助信息</span>

<span class="token comment"># ansible-doc module 的内容是包含 ansible-doc -s module 的</span>

<span class="token comment"># 打印模块的选项</span>
<span class="token variable">$ansible</span>-doc <span class="token parameter variable">-s</span> shell <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> +3 <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'^[[:space:]]&#123;6&#125;[^[:space:]]+:'</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">':'</span> <span class="token parameter variable">-f</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span>
chdir
cmd
creates
executable
free_form
removes
stdin
stdin_add_newline
warn</code></pre>

<h4 id="command"><a href="#command" class="headerlink" title="command"></a>command</h4><p>默认模块，可忽略 -m 选项<br>注意：此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，用 shell 模块实现</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以下两条命令是一样的，-m 可以省略，-a 不能省略</span>
<span class="token variable">$ansible</span> all <span class="token parameter variable">-a</span> <span class="token string">'hostname'</span>
<span class="token variable">$ansible</span> all <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'hostname'</span>

<span class="token variable">$ansible</span> all <span class="token parameter variable">-a</span> <span class="token string">'chdir=/etc pwd'</span>
<span class="token number">10.0</span>.2.2 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
/etc
<span class="token number">10.0</span>.2.3 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
/etc
<span class="token number">10.0</span>.2.1 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> <span class="token assign-left variable">rc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">>></span>
/etc</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 选项：ansible-doc -s command</span>
free_form  <span class="token comment"># 必须参数，指定需要远程执行的命令，free_form并不是一个"实际存在"的参数名，比如，当我们想要在远程主机上执行ls命令时，我们并不需要写成"free_form=ls" ，这样写反而是错误的，因为并没有任何参数的名字是free_form，当我们想要在远程主机中执行ls命令时，直接写成ls即可，这就是free_form参数的含义</span>
chdir  <span class="token comment"># 指定一个目录，在执行对应的命令之前，会先进入到chdir参数指定的目录中</span>
creates  <span class="token comment"># 当指定的文件存在时，就不执行对应命令</span>
removes  <span class="token comment"># 与creates参数的作用正好相反，它的作用是当指定的文件不存在时，就不执行对应命令</span>
stdin  <span class="token comment">#</span></code></pre>

<h4 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h4><p>和 command 相似，但是功能更丰富，支持各种符号，比如 *、$、&gt;</p>
<p>注意：类似 <code>cat /tmp/test.md | awk -F&#39;|&#39; &#39;&#123;print $1,$2&#125;&#39; &amp;&gt; /tmp/example.txt</code> 这<br>些复杂命令，即使使用 shell 也可能会失败，解决办法：写到脚本时，copy 到远程，执行，再把需要的<br>结果拉回执行命令的机器</p>
<p>建议将 shell 模块替换 command，设为默认模块</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$vim</span> /etc/ansible/ansible.cfg
module_name <span class="token operator">=</span> shell</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ansible</span>-doc <span class="token parameter variable">-s</span> shell <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> +3 <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'^[[:space:]]&#123;6&#125;[^[:space:]]+:'</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">':'</span> <span class="token parameter variable">-f</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span>
chdir
cmd
creates
executable  <span class="token comment"># 指定执行程序，默认是 /bin/bash</span>
free_form
removes
stdin
stdin_add_newline
warn</code></pre>

<h4 id="script"><a href="#script" class="headerlink" title="script"></a>script</h4><p>在远程主机上运行 ansible 服务器上的脚本（无需执行权限）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ansible</span>-doc <span class="token parameter variable">-s</span> script <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> +3 <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'^[[:space:]]&#123;6&#125;[^[:space:]]+:'</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">':'</span> <span class="token parameter variable">-f</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span>
chdir
cmd
creates
decrypt
executable
free_form
removes</code></pre>

<h4 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h4><p>从 ansible 服务器主控端复制文件到远程主机</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">src  <span class="token comment"># 需要copy的文件或目录</span>
dest  <span class="token comment"># 文件将被拷贝到远程主机的哪个目录中，dest为必须参数</span>
content  <span class="token comment"># 当不指定src时，可以使用content直接指定文件内容，src与content两个参数必有其一，否则会报错</span>
force  <span class="token comment"># 当远程主机的目标路径中已经存在同名文件，并且与ansible主机中的文件内容不同时，是否强制覆盖，可选值有yes和no，默认值为yes，表示覆盖，如果设置为no，则不会执行覆盖拷贝操作，远程主机中的文件保持不变</span>
backup  <span class="token comment">#  当远程主机的目标路径中已经存在同名文件，并且与ansible主机中的文件内容不同时，是否对远程主机的文件进行备份，可选值有yes和no，当设置为yes时，会先备份远程主机中的文件，然后再将ansible主机中的文件拷贝到远程主机</span>
owner  <span class="token comment"># 指定文件拷贝到远程主机后的属主，但是远程主机上必须有对应的用户，否则会报错</span>
group  <span class="token comment"># 指定文件拷贝到远程主机后的属组，但是远程主机上必须有对应的组，否则会报错</span>
mode  <span class="token comment"># 指定文件拷贝到远程主机后的权限，如果你想将权限设置为"rw-r--r--"，则可以使用mode=0644表示，如果你想要在user对应的权限位上添加执行权限，则可以使用mode=u+x表示</span>
attributes
checksum
decrypt
directory_mode
follow
local_follow
remote_src
selevel
serole
setype
seuser
unsafe_writes
validate</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible test70 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">"src=/testdir/copytest dest=/opt/"</span>
ansible test70 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">'content="aaa\nbbb\n" dest=/opt/test'</span>
ansible test70 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">"src=/testdir/copytest dest=/opt/ force=no"</span>
ansible test70 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">"src=/testdir/copytest dest=/opt/ backup=yes"</span>
ansible test70 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">"src=/testdir/copytest dest=/opt/ owner=zsy"</span>
ansible test70 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">"src=/testdir/copytest dest=/opt/ group=zsy"</span>
ansible test70 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">"src=/testdir/copytest dest=/opt/ mode=0640"</span></code></pre>

<h4 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h4><p>从远程主机提取文件至 ansible 的主控端，和 copy 相反，目前不支持目录</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ansible</span>-doc <span class="token parameter variable">-s</span> fetch <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> +3 <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'^[[:space:]]&#123;6&#125;[^[:space:]]+:'</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">':'</span> <span class="token parameter variable">-f</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span>
dest  <span class="token comment"># 保存文件的目录</span>
fail_on_missing  <span class="token comment"># bool，当源文件不存在的时候，标识为失败</span>
flat  <span class="token comment"># bool，文件覆盖</span>
src  <span class="token comment"># 从远程主机上获取的文件，必须是文件，不能为目录</span>
validate_checksum  <span class="token comment"># bool，文件fetch之后进行md5检查</span></code></pre>

<h4 id="file"><a href="#file" class="headerlink" title="file"></a>file</h4><p>file 模块可以帮助我们完成一些对文件的基本操作，比如，创建文件或目录、删除文件或目录、修改文件权限等</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">path  <span class="token comment"># 指定要操作的文件或目录，在之前版本的ansible中，使用dest或者name</span>
state  <span class="token comment"># 此参数非常灵活，此参数对应的值需要根据情况设定，比如，当我们需要在远程主机中创建一个目录的时候，我们需要使用path参数指定对应的目录路径，假设，我想要在远程主机上创建/testdir/a/b目录，那么我则需要设置path=/testdir/a/b，但是，我们无法从"/testdir/a/b"这个路径看出b是一个文件还是一个目录，ansible也同样无法单单从一个字符串就知道你要创建文件还是目录，所以，我们需要通过state参数进行说明，当我们想要创建的/testdir/a/b是一个目录时，需要将state的值设置为directory，"directory"为目录之意，当它与path结合，ansible就能知道我们要操作的目标是一个目录，同理，当我们想要操作的/testdir/a/b是一个文件时，则需要将state的值设置为touch，当我们想要创建软链接文件时，需将state设置为link，想要创建硬链接文件时，需要将state设置为hard，当我们想要删除一个文件时（删除时不用区分目标是文件、目录、还是链接），则需要将state的值设置为absent，"absent"为缺席之意，当我们想让操作的目标"缺席"时，就表示我们想要删除目标</span>
src  <span class="token comment"># 当state设置为link或者hard时，表示我们想要创建一个软链或者硬链，所以，我们必须指明软链或硬链链接的哪个文件，通过src参数即可指定链接源</span>
force  <span class="token comment"># 当state=link的时候，可配合此参数强制创建链接文件，当force=yes时，表示强制创建链接文件，不过强制创建链接文件分为两种情况，情况一：当你要创建的链接文件指向的源文件并不存在时，使用此参数，可以先强制创建出链接文件。情况二：当你要创建链接文件的目录中已经存在与链接文件同名的文件时，将force设置为yes，回将同名文件覆盖为链接文件，相当于删除同名文件，创建链接文件。情况三：当你要创建链接文件的目录中已经存在与链接文件同名的文件，并且链接文件指向的源文件也不存在，这时会强制替换同名文件为链接文件</span>
owner  <span class="token comment"># 用于指定被操作文件的属主，属主对应的用户必须在远程主机中存在，否则会报错</span>
group  <span class="token comment"># 用于指定被操作文件的属组，属组对应的组必须在远程主机中存在，否则会报错</span>
mode  <span class="token comment"># 用于指定被操作文件的权限，比如，如果想要将文件权限设置为"rw-r-x---"，则可以使用mode=650进行设置，或者使用mode=0650，效果也是相同的，如果你想要设置特殊权限，比如为二进制文件设置suid，则可以使用mode=4700，很方便吧</span>
recurse  <span class="token comment"># 当要操作的文件为目录，将recurse设置为yes，可以递归的修改目录中文件的属性</span>
access_time
access_time_format
attributes
follow
modification_time
modification_time_format
selevel
serole
setype
seuser
unsafe_writes</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#创建空文件</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'path=/data/test.txt state=touch'</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'path=/data/test.txt state=absent'</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/root/test.sh owner=wang mode=755"</span>
<span class="token comment">#创建目录</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql"</span>
<span class="token comment">#创建软链接</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'src=/data/testfile path|dest|name=/data/testfile-link state=link'</span>
<span class="token comment">#创建目录</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">'path=/data/testdir state=directory'</span>
<span class="token comment">#递归修改目录属性</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql recurse=yes"</span>

<span class="token comment"># 在test70主机上创建一个名为testfile的文件，如果testfile文件已经存在，则会更新文件的时间戳，与touch命令的作用相同</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/testfile state=touch"</span>
<span class="token comment"># 在test70主机上创建一个名为testdir的目录，如果testdir目录已经存在，则不进行任何操作</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/testdir state=directory"</span>
<span class="token comment"># 在test70上为testfile文件创建软链接文件，软链接名为linkfile，执行下面命令的时候，testfile已经存在</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/linkfile state=link src=/testdir/testfile"</span>
<span class="token comment"># 在test70上为testfile文件创建硬链接文件，硬链接名为hardfile，执行下面命令的时候，testfile已经存在</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/hardfile state=hard src=/testdir/testfile"</span>
<span class="token comment"># 在创建链接文件时，如果源文件不存在，或者链接文件与其他文件同名时，强制覆盖同名文件或者创建链接文件，参考上述force参数的解释</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/linkfile state=link src=sourcefile force=yes"</span>
<span class="token comment"># 删除远程机器上的指定文件或目录</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/testdir state=absent"</span>
<span class="token comment"># 在创建文件或目录的时候指定属主，或者修改远程主机上的文件或目录的属主</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abc state=touch owner=zsy"</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abc owner=zsy"</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abc state=directory owner=zsy"</span>
<span class="token comment"># 在创建文件或目录的时候指定属组，或者修改远程主机上的文件或目录的属组</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abb state=touch group=zsy"</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abb group=zsy"</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abb state=directory group=zsy"</span>
<span class="token comment"># 在创建文件或目录的时候指定权限，或者修改远程主机上的文件或目录的权限</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abb state=touch mode=0644"</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abb mode=0644"</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/binfile mode=4700"</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abb state=directory mode=0644"</span>
<span class="token comment"># 当操作远程主机中的目录时，同时递归的将目录中的文件的属主属组都设置为zsy</span>
ansible test70 <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/testdir/abd state=directory owner=zsy group=zsy recurse=yes"</span></code></pre>

<h4 id="unarchive"><a href="#unarchive" class="headerlink" title="unarchive"></a>unarchive</h4><p>解包解压缩</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">copy  <span class="token comment"># 默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy=no，会在远程主机上寻找src源文件</span>
remote_src  <span class="token comment"># 和copy功能一样且互斥，yes表示在远程主机，不在ansible主机，no表示文件在ansible主机上</span>
src  <span class="token comment"># 源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置copy=no</span>
dest  <span class="token comment"># 远程主机上的目标路径</span>
mode  <span class="token comment"># 设置解压缩后的文件权限</span>
attributes
creates
decrypt
exclude
extra_opts
group
keep_newer
list_files
owner
selevel
serole
setype
seuser
unsafe_writes
validate_certs</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible all <span class="token parameter variable">-m</span> unarchive <span class="token parameter variable">-a</span> <span class="token string">'src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin'</span>
ansible all <span class="token parameter variable">-m</span> unarchive <span class="token parameter variable">-a</span> <span class="token string">'src=/tmp/foo.zip dest=/data copy=no mode=0777'</span>
ansible all <span class="token parameter variable">-m</span> unarchive <span class="token parameter variable">-a</span> <span class="token string">'src=https://example.com/example.zip dest=/data copy=no'</span>
ansible websrvs <span class="token parameter variable">-m</span> unarchive <span class="token parameter variable">-a</span> <span class="token string">'src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/data/ owner=mysql remote_src=yes'</span></code></pre>

<h4 id="archive"><a href="#archive" class="headerlink" title="archive"></a>archive</h4><p>打包压缩保存在被管理节点</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ansible</span>-doc <span class="token parameter variable">-s</span> archive <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> +3 <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'^[[:space:]]&#123;6&#125;[^[:space:]]+:'</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">':'</span> <span class="token parameter variable">-f</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span>
attributes
dest
exclude_path
force_archive
<span class="token function">format</span>
group
mode
owner
path
remove
selevel
serole
setype
seuser
unsafe_writes</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible websrvs <span class="token parameter variable">-m</span> archive <span class="token parameter variable">-a</span> <span class="token string">'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600'</span></code></pre>

<h4 id="hostname"><a href="#hostname" class="headerlink" title="hostname"></a>hostname</h4><p>管理主机名</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible <span class="token number">10.0</span>.0.18 <span class="token parameter variable">-m</span> <span class="token function">hostname</span> <span class="token parameter variable">-a</span> <span class="token string">'name=node18.magedu.com'</span></code></pre>

<h4 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h4><p>计划任务，支持时间：minute，hour，day，month，weekday</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例1 每天的1点5分输出 test 字符</span>
<span class="token number">5</span> <span class="token number">1</span> * * * <span class="token builtin class-name">echo</span> <span class="token builtin class-name">test</span>
<span class="token comment"># 示例2 每3天执行一次计划任务，于当天的1点1分执行，具体任务为输出 test 字符</span>
<span class="token number">1</span> <span class="token number">1</span> */3 * * <span class="token builtin class-name">echo</span> <span class="token builtin class-name">test</span>
<span class="token comment"># 示例3 每次系统启动后需要执行一次计划任务，具体任务为输出 test 字符</span>
@reboot <span class="token builtin class-name">echo</span> <span class="token builtin class-name">test</span>
<span class="token comment"># 示例4 每小时执行一次计划任务，具体任务为输出 test 字符</span>
@hourly <span class="token builtin class-name">echo</span> <span class="token builtin class-name">test</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">backup  <span class="token comment"># yes|no，当修改或者删除对应的计划任务时，是否先对计划任务进行备份，如果设置为yes，cron 模块会在远程主机的 /tmp 目录下创建备份文件</span>
cron_file
disabled  <span class="token comment"># 当计划任务有名称时，我们可以根据名称使对应的任务”失效”（注释掉对应的任务）。注意，使用此参数时，除了需要指定任务的名称，还需要同时指定任务的job 以及任务的时间设定，而且任务的时间设定必须和对应任务完全相同，否则在注释任务的同时，任务的时间设定会被修改</span>
<span class="token function">env</span>
minute  <span class="token comment"># 设置计划任务中分钟设定位的值，当不使用此参数时，分钟设定位的值默认为”*”</span>
hour  <span class="token comment"># 设置计划任务中小时设定位的值，当不使用此参数时，小时设定位的值默认为”*”</span>
day  <span class="token comment"># 设置计划任务中日设定位的值，当不使用此参数时，日设定位的值默认为”*”</span>
month  <span class="token comment"># 设置计划任务中月设定位的值，当不使用此参数时，月设定位的值默认为”*”</span>
weekday  <span class="token comment"># 设置计划任务中周几设定位的值，当不使用此参数时，周几设定位的值默认为”*”</span>
insertafter
insertbefore
job  <span class="token comment"># 此参数用于指定计划的任务中需要实际执行的命令或者脚本，比如上例中的 “echo test” 命令</span>
name  <span class="token comment"># 此参数用于设置计划任务的名称，计划任务的名称会在注释中显示，当不指定计划任务的名称时，ansible 会默认为计划任务加入注释，注释的内容为 #Ansible: None，假设指定计划任务的名称为 test，那么注释的内容为#Ansible: test，在一台机器中，计划任务的名称应该具有唯一性，方便我们以后根据名称修改或删除计划任务</span>
<span class="token function">reboot</span>
special_time  <span class="token comment"># 在上述示例3与示例4中，计划任务的时间设定格式为 @reboot 或者@hourly。@reboot 表示重启时执行，@hourly 表示每小时执行一次，相当于设置成”0 0 * * *” ，这种@开头的时间设定格式则需要使用 special_time 参数进行设置，special_time 参数的可用值有 reboot(重启后)、yearly(每年)、annually(每年，与yearly相同)、monthly(每月)、weekly(每周)、daily(每天)、hourly(每时)</span>
<span class="token comment"># 注意：当上述时间单位设定参数都未指定时，计划任务的时间设定默认会被设定为”* * * * *”，这样表示每秒都会执行一次计划任务，所以，在使用cron模块时，我们应该确定对应的时间参数设置正确</span>
state  <span class="token comment"># 当计划任务有名称时，我们可以根据名称修改或删除对应的任务，当删除计划任务时，需要将 state 的值设置为 absent</span>
user  <span class="token comment"># 此参数用于设置当前计划任务属于哪个用户，当不使用此参数时，默认为管理员用户</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#备份数据库脚本</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#cat /root/mysql_backup.sh</span>
<span class="token comment">#!/bin/bash</span>
mysqldump <span class="token parameter variable">-A</span> <span class="token parameter variable">-F</span> --single-transaction --master-data<span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-uroot</span> <span class="token operator">|</span><span class="token function">gzip</span> <span class="token operator">></span> /data/mysql_<span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%F_%T<span class="token variable">`</span></span>.sql.gz
<span class="token comment">#创建任务</span>
ansible <span class="token number">10.0</span>.0.8 <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">'hour=2 minute=30 weekday=1-5 name="backup mysql" job=/root/mysql_backup.sh'</span>
ansible websrvs <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com &amp;>/dev/null' name=Synctime"</span>
<span class="token comment">#禁用计划任务</span>
ansible websrvs <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">"minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 &amp;>/dev/null' name=Synctime disabled=yes"</span>
<span class="token comment">#启用计划任务</span>
ansible websrvs <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">"minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 &amp;>/dev/null' name=Synctime disabled=no"</span>
<span class="token comment">#删除任务</span>
ansible websrvs <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">"name='backup mysql' state=absent"</span>
ansible websrvs <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">'state=absent name=Synctime'</span></code></pre>

<h4 id="yum、apt"><a href="#yum、apt" class="headerlink" title="yum、apt"></a>yum、apt</h4><p>yum：管理软件包，只支持 RHEL，CentOS，fedora<br>apt：模块管理 Debian 相关版本的软件包</p>
<h5 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h5><pre class="language-bash" data-language="bash"><code class="language-bash">allow_downgrade
autoremove
bugfix
conf_file
disable_excludes
disable_gpg_check
disable_plugin
disablerepo
download_dir
download_only
enable_plugin
enablerepo
exclude
install_repoquery
install_weak_deps
installroot
list
lock_timeout
name
releasever
security
skip_broken
state  <span class="token comment"># present|installed|latest|absent|removed，installed 和 present等效，表示安装；absent 和 removed 等效，表示卸载；latest 表示安装最新版本</span>
update_cache
update_only
use_backend
validate_certs</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible websrvs <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=httpd state=present'</span> <span class="token comment">#安装，state可以省略</span>
ansible websrvs <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=httpd state=absent'</span> <span class="token comment">#删除</span>
ansible websrvs <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">'name=sl,cowsay'</span>	<span class="token comment"># 安装</span></code></pre>

<h5 id="apt"><a href="#apt" class="headerlink" title="apt"></a>apt</h5><pre class="language-bash" data-language="bash"><code class="language-bash">allow_unauthenticated
autoclean
autoremove
cache_valid_time
deb
default_release
dpkg_options
force
force_apt_get
install_recommends
name
only_upgrade
policy_rc_d
purge
state
update_cache
update_cache_retries
update_cache_retry_max_delay
upgrade</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible <span class="token number">10.0</span>.0.100 <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=bb,sl,cowsay,cmatrix,oneko,hollywood,boxes,libaa-bin,x11-apps'</span>
ansible websrvs <span class="token parameter variable">-m</span> <span class="token function">apt</span> <span class="token parameter variable">-a</span> <span class="token string">'name=rsync,psmisc state=absent'</span></code></pre>

<h4 id="serivce"><a href="#serivce" class="headerlink" title="serivce"></a>serivce</h4><p>管理服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">arguments
enabled
name
pattern
runlevel
<span class="token function">sleep</span>
state
use</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> <span class="token string">'name=httpd state=started enabled=yes'</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> <span class="token string">'name=httpd state=stopped'</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> <span class="token string">'name=httpd state=reloaded'</span>
ansible all <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf"</span>
ansible all <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> <span class="token string">'name=httpd state=restarted'</span></code></pre>

<h4 id="user"><a href="#user" class="headerlink" title="user"></a>user</h4><p>管理用户</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">append
authorization
comment
create_home
expires
force
generate_ssh_key
group
<span class="token function">groups</span>
hidden
home
<span class="token builtin class-name">local</span>
login_class
move_home
name
non_unique
password
password_lock
profile
remove
role
seuser
shell
skeleton
ssh_key_bits
ssh_key_comment
ssh_key_file
ssh_key_passphrase
ssh_key_type
state
system
uid
update_password</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#创建用户</span>
ansible all <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">'name=user1 comment="test user" uid=2048 home=/app/user1 group=root'</span>
ansible all <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">'name=nginx comment=nginx uid=88 group=nginx groups="root,daemon" shell=/sbin/nologin system=yes create_home=no home=/data/nginx non_unique=yes'</span>

<span class="token comment">#remove=yes表示删除用户及家目录等数据,默认remove=no</span>
ansible all <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">'name=nginx state=absent remove=yes'</span></code></pre>

<h4 id="group"><a href="#group" class="headerlink" title="group"></a>group</h4><p>管理组</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">gid
<span class="token builtin class-name">local</span>
name
non_unique
state
system</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#创建组</span>
ansible websrvs <span class="token parameter variable">-m</span> group <span class="token parameter variable">-a</span> <span class="token string">'name=nginx gid=88 system=yes'</span>
<span class="token comment">#删除组</span>
ansible websrvs <span class="token parameter variable">-m</span> group <span class="token parameter variable">-a</span> <span class="token string">'name=nginx state=absent'</span></code></pre>

<h4 id="lineinfile"><a href="#lineinfile" class="headerlink" title="lineinfile"></a>lineinfile</h4><p>参考：<a target="_blank" rel="noopener" href="http://www.zsythink.net/archives/2542">http://www.zsythink.net/archives/2542</a></p>
<p>我们可以借助 lineinfile 模块，确保”某一行文本”存在于指定的文件中，或者确保从文件中删除指定的”文本”（即确保指定的文本不存在于文件中），还可以根据正则表达式，替换”某一行文本”</p>
<p>ansible 在使用 sed 进行替换时，经常会遇到需要转义的问题，而且 ansible 在遇到特殊符号进行替换时，存在问题，无法正常进行替换 。所以 ansible 提供了两个模块：lineinfile 模块和 replace 模块，可以方便的进行替换</p>
<p>一般在 ansible 当中去修改某个文件的单行进行替换的时候需要使用 lineinfile 模块</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">attributes
backrefs  <span class="token comment"># backrefs=yes 表示开启后向引用，并且当正则没有匹配到任何的行时，则不会对文件进行任何操作</span>
backup  <span class="token comment"># 是否在修改文件之前对文件进行备份</span>
create  <span class="token comment"># 当要操作的文件并不存在时，是否创建对应的文件</span>
firstmatch
group
insertafter  <span class="token comment"># 将文本插入到“指定的行”之后</span>
insertbefore  <span class="token comment"># 将文本插入到“指定的行”之前</span>
line  <span class="token comment"># 使用此参数指定文本内容</span>
mode
others
owner
path  <span class="token comment"># 必须参数，指定要操作的文件</span>
regexp  <span class="token comment"># 使用正则表达式匹配对应的行，当替换文本时，如果有多行文本都能被匹配，则只有最后面被匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除</span>
selevel
serole
setype
seuser
state  <span class="token comment"># 默认值为present，absent表示删除</span>
unsafe_writes
validate</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查找内容为‘xxx’的行是否存在于文件/data/test/test.sh，如果不存在，则追加此行到此文件</span>
ansible localhost <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">'path=/data/test/test.sh line=xxx'</span>

<span class="token comment"># 正则匹配，然后替换，如果匹配到多行，但是只能替换最后一行</span>
ansible websrvs <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">"path=/etc/httpd/conf/httpd.conf regexp='^Listen' line='Listen 80'"</span>
ansible all <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">"path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=disabled'"</span>

<span class="token comment"># 正则匹配，然后删除，如果匹配到多行，就全部删除</span>
ansible all <span class="token parameter variable">-m</span> lineinfile <span class="token parameter variable">-a</span> <span class="token string">'path=/etc/fstab state=absent regexp="^#"'</span></code></pre>

<h4 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h4><p>lineinfile 模块的主要功能是操作 in file 的 line，只能替换单行文本，多行匹配进行替换需要使用 replace 模块</p>
<p>该模块有点类似于 sed 命令，主要也是基于正则进行匹配和替换，建议使用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">after
attributes
backup
before
encoding
group
mode
others
owner
path
regexp
replace
selevel
serole
setype
seuser
unsafe_writes
validate</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ansible all <span class="token parameter variable">-m</span> replace <span class="token parameter variable">-a</span> <span class="token string">"path=/etc/fstab regexp='^(UUID.*)' replace='#<span class="token entity" title="\1">\1</span>'"</span>
ansible all <span class="token parameter variable">-m</span> replace <span class="token parameter variable">-a</span> <span class="token string">"path=/etc/fstab regexp='^#(UUID.*)' replace='<span class="token entity" title="\1">\1</span>'"</span></code></pre>

<h4 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h4><p>setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机较多，会影响执行速度，可以使用 gather_facts: no 来禁止 ansible 收集 facts 信息</p>
<h2 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h2><p><img data-src="//img.to2b.cn/blog/ljk/1603026608236.png"></p>
<ul>
<li>playbook 剧本是由一个或多个”play”组成的列表</li>
<li>play 的主要功能在于将预定义的一组主机，装扮成事先通过 ansible 中的 task 定义好的角色。Task 实际是调用 ansible 的一个 module，将多个 play 组织在一个 playbook 中，即可以让它们联合起来，按事先编排的机制执行预定义的动作</li>
<li>Playbook 文件是采用 YAML 语言编写的</li>
</ul>
<h3 id="playbook-核心组件"><a href="#playbook-核心组件" class="headerlink" title="playbook 核心组件"></a><a target="_blank" rel="noopener" href="http://www.ansible.com.cn/docs/playbooks_intro.html">playbook 核心组件</a></h3><ul>
<li>hosts：执行的远程主机<strong>列表</strong></li>
<li>tasks：任务集</li>
<li>variables：内置变量或自定义变量在 playbook 中调用</li>
<li>templates：模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li>
<li>handlers 和 notify：两者结合使用，特定条件出发操作</li>
<li>tags：标签，指定某条任务执行，用于选择运行 playbook 中的部分代码。ansible 具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常长。此时，如果确信其没有变化，就可以通过 tags 跳过此些代码片断</li>
</ul>
<h4 id="hosts-组件"><a href="#hosts-组件" class="headerlink" title="hosts 组件"></a>hosts 组件</h4><p>playbook 中的每一个 play 的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts 用于指定要执行指定任务的主机，须事先定义在 inventory 主机清单中</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">- hosts: websrvs:appsrvs</code></pre>

<h4 id="remote-user、sudo、sudo-user-组件"><a href="#remote-user、sudo、sudo-user-组件" class="headerlink" title="remote_user、sudo、sudo_user 组件"></a>remote_user、sudo、sudo_user 组件</h4><ul>
<li>remote_usr：指定远程主机执行任务的用户</li>
<li>sudo：支持使用 sudo，默认切换到 root</li>
<li>sudo_user：指定使用 sudo 时切换的用户</li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> websrvs
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test connection
    <span class="token key atrule">ping</span><span class="token punctuation">:</span>
    <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> magedu
    <span class="token key atrule">sudo</span><span class="token punctuation">:</span> yes
    sudo_user<span class="token punctuation">:</span>lujinkai</code></pre>

<h4 id="tasks-和-action"><a href="#tasks-和-action" class="headerlink" title="tasks 和 action"></a>tasks 和 action</h4><p>tasks 是 task 列表，每个 task 的类型是字典</p>
<p>play 的主体部分是 tasks，所有 task<strong>依次</strong>在所有远程主机上执行，注意是同步执行而非异步执行；</p>
<p>task 的目的是使用指定的参数执行模块，</p>
<p>未完待续…</p>
<h4 id="handlers-和-notify"><a href="#handlers-和-notify" class="headerlink" title="handlers 和 notify"></a>handlers 和 notify</h4><h4 id="tags-组件"><a href="#tags-组件" class="headerlink" title="tags 组件"></a>tags 组件</h4><h3 id="Playbook-中使用变量"><a href="#Playbook-中使用变量" class="headerlink" title="Playbook 中使用变量"></a>Playbook 中使用变量</h3><p>两类变量：</p>
<ol>
<li><p>ansible 内置变量 和 自定义变量，这些变量不仅可以在 playbook 中使用，在 ansible 中任何地方都可以使用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用debug模块可以格式化输出变量</span>
<span class="token variable">$ansible</span> localhost <span class="token parameter variable">-m</span> debug <span class="token parameter variable">-a</span> <span class="token string">"msg=&#123;&#123;hostvars&#125;&#125;"</span></code></pre>
</li>
<li><p>facts 信息，来自 setup 模块收集（允许自定义），可以禁止收集，这些变量只能在 playbook 中使用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ansible</span> localhost <span class="token parameter variable">-m</span> setup</code></pre></li>
</ol>
<h4 id="内置变量-hostvars"><a href="#内置变量-hostvars" class="headerlink" title="内置变量 hostvars"></a>内置变量 hostvars</h4><p>在 playbook 中，自己主机的变量，无论是 ansible 内置、自定义还是 facts，都可以直接调用，其他主机的变量，可以通过 hostvars 间接调用，例如：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 具体事例，待补充...</span></code></pre>

<h4 id="常用变量"><a href="#常用变量" class="headerlink" title="常用变量"></a>常用变量</h4><ul>
<li>groups：来自 ansible 内置，主机列表</li>
<li>group_names：来自 ansible 内置，当前主机在主机列表中的所属组</li>
</ul>
<h3 id="playbook-中使用-when"><a href="#playbook-中使用-when" class="headerlink" title="playbook 中使用 when"></a>playbook 中使用 when</h3><h3 id="playbook-使用迭代-with-items-loop"><a href="#playbook-使用迭代-with-items-loop" class="headerlink" title="playbook 使用迭代 with_items(loop)"></a>playbook 使用迭代 with_items(loop)</h3><p>当有需要重复性执行的任务时，可以使用迭代机制</p>
<p>对迭代项的引用，固定内置变量名为”item”</p>
<p>要在 task 中使用 with_items 给定要迭代的元素列表</p>
<p>注意: ansible2.5 版本后，可以用 loop 代替 with_items</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">- name: 下载 kube-master 二进制
  copy: <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> base_dir <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/bin/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token assign-left variable">dest</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> bin_dir <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token assign-left variable">mode</span><span class="token operator">=</span>0755
  with_items:
  - kube-apiserver
  - kube-controller-manager
  - kube-scheduler
  - kubectl
  tags: upgrade_k8s</code></pre>

<p><strong>迭代嵌套子变量</strong>：在迭代中，还可以嵌套子变量，关联多个变量在一起使用</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">- name: <span class="token function">add</span> some <span class="token function">users</span>
user: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item.name <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item.group <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>present
with_items:
- <span class="token punctuation">&#123;</span> name: <span class="token string">'nginx'</span>, group: <span class="token string">'nginx'</span> <span class="token punctuation">&#125;</span>
- <span class="token punctuation">&#123;</span> name: <span class="token string">'mysql'</span>, group: <span class="token string">'mysql'</span> <span class="token punctuation">&#125;</span>
- <span class="token punctuation">&#123;</span> name: <span class="token string">'apache'</span>, group: <span class="token string">'apache'</span> <span class="token punctuation">&#125;</span></code></pre>

<h3 id="管理节点过多导致的超时问题解决方法"><a href="#管理节点过多导致的超时问题解决方法" class="headerlink" title="管理节点过多导致的超时问题解决方法"></a>管理节点过多导致的超时问题解决方法</h3><h2 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h2><p>roles 目录结构如下所示：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611764134262.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/my.conf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/my.conf/" class="post-title-link" itemprop="url">my.conf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:20:51" itemprop="dateCreated datePublished" datetime="2020-12-09T23:20:51+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="my-conf"><a href="#my-conf" class="headerlink" title="my.conf"></a>my.conf</h2><p>配置文件生成工具参考链接：<a target="_blank" rel="noopener" href="https://imysql.com/my_cnf_generator">https://imysql.com/my_cnf_generator</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>client<span class="token punctuation">]</span>
<span class="token comment">#password=your_password</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
default-character-set<span class="token operator">=</span>utf8mb4

<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
no-auto-rehash
<span class="token assign-left variable">prompt</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span><span class="token entity" title="\r">\r</span>:<span class="token entity" title="\\">\\</span>\m:<span class="token entity" title="\\">\\</span>\s(<span class="token entity" title="\\">\\</span>\u@<span class="token entity" title="\\">\\</span>\h) [<span class="token entity" title="\\">\\</span>\d]><span class="token entity" title="\\">\\</span>\_"</span>

<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token assign-left variable">basedir</span><span class="token operator">=</span><span class="token variable">$&#123;install_dir&#125;</span>
<span class="token assign-left variable">datadir</span><span class="token operator">=</span><span class="token variable">$&#123;data_dir&#125;</span>
pid-file<span class="token operator">=</span><span class="token variable">$&#123;data_dir&#125;</span>/mysql.pid
<span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token variable">$&#123;user&#125;</span>
bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0
server-id<span class="token operator">=</span><span class="token number">1</span>

init-connect<span class="token operator">=</span><span class="token string">'SET NAMES utf8mb4'</span>
character-set-server<span class="token operator">=</span>utf8mb4

<span class="token comment"># 跳过NDS解析</span>
skip-name-resolve
<span class="token comment">#skip-networking</span>
<span class="token assign-left variable">back_log</span><span class="token operator">=</span><span class="token number">300</span>

<span class="token assign-left variable">max_connections</span><span class="token operator">=</span><span class="token number">1000</span>
<span class="token assign-left variable">max_connect_errors</span><span class="token operator">=</span><span class="token number">6000</span>
<span class="token assign-left variable">open_files_limit</span><span class="token operator">=</span><span class="token number">65535</span>
<span class="token assign-left variable">table_open_cache</span><span class="token operator">=</span><span class="token number">128</span>
<span class="token assign-left variable">max_allowed_packet</span><span class="token operator">=</span>500M
<span class="token assign-left variable">binlog_cache_size</span><span class="token operator">=</span>1M
<span class="token assign-left variable">max_heap_table_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">tmp_table_size</span><span class="token operator">=</span>16M

<span class="token assign-left variable">read_buffer_size</span><span class="token operator">=</span>2M
<span class="token assign-left variable">read_rnd_buffer_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">sort_buffer_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">net_buffer_length</span><span class="token operator">=</span>8K
<span class="token assign-left variable">join_buffer_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">key_buffer_size</span><span class="token operator">=</span>4M
<span class="token assign-left variable">performance_schema_max_table_instances</span><span class="token operator">=</span><span class="token number">500</span>

<span class="token assign-left variable">thread_cache_size</span><span class="token operator">=</span><span class="token number">8</span>

<span class="token assign-left variable">ft_min_word_len</span><span class="token operator">=</span><span class="token number">4</span>

<span class="token assign-left variable">log_bin</span><span class="token operator">=</span>mysql-bin
<span class="token assign-left variable">binlog_format</span><span class="token operator">=</span>mixed
<span class="token assign-left variable">expire_logs_days</span><span class="token operator">=</span><span class="token number">7</span>

<span class="token assign-left variable">log_error</span><span class="token operator">=</span><span class="token variable">$&#123;data_dir&#125;</span>/mysql-error.log
<span class="token assign-left variable">slow_query_log</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">long_query_time</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">slow_query_log_file</span><span class="token operator">=</span><span class="token variable">$&#123;data_dir&#125;</span>/mysql-slow.log

<span class="token assign-left variable">performance_schema</span><span class="token operator">=</span><span class="token number">0</span>
explicit_defaults_for_timestamp

<span class="token comment">#lower_case_table_names=1</span>

skip-external-locking

<span class="token assign-left variable">default_storage_engine</span><span class="token operator">=</span>InnoDB
<span class="token comment">#default-storage-engine=MyISAM</span>
<span class="token assign-left variable">innodb_file_per_table</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 开启独立表空间</span>
<span class="token assign-left variable">innodb_data_home_dir</span><span class="token operator">=</span><span class="token variable">$&#123;data_dir&#125;</span>
<span class="token assign-left variable">innodb_data_file_path</span><span class="token operator">=</span>ibdata1:12M:autoextend
<span class="token assign-left variable">innodb_log_group_home_dir</span><span class="token operator">=</span><span class="token variable">$&#123;data_dir&#125;</span>
<span class="token assign-left variable">innodb_open_files</span><span class="token operator">=</span><span class="token number">500</span>
<span class="token assign-left variable">innodb_buffer_pool_size</span><span class="token operator">=</span>64M
<span class="token assign-left variable">innodb_write_io_threads</span><span class="token operator">=</span><span class="token number">4</span>
<span class="token assign-left variable">innodb_read_io_threads</span><span class="token operator">=</span><span class="token number">4</span>
<span class="token assign-left variable">innodb_thread_concurrency</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">innodb_purge_threads</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">innodb_flush_log_at_trx_commit</span><span class="token operator">=</span><span class="token number">2</span>
<span class="token assign-left variable">innodb_log_buffer_size</span><span class="token operator">=</span>2M
<span class="token assign-left variable">innodb_log_file_size</span><span class="token operator">=</span>32M
<span class="token assign-left variable">innodb_log_files_in_group</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">innodb_max_dirty_pages_pct</span><span class="token operator">=</span><span class="token number">90</span>
<span class="token assign-left variable">innodb_lock_wait_timeout</span><span class="token operator">=</span><span class="token number">120</span>	<span class="token comment"># 事务锁超时时长</span>

<span class="token assign-left variable">bulk_insert_buffer_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">myisam_sort_buffer_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">myisam_max_sort_file_size</span><span class="token operator">=</span>10G
<span class="token assign-left variable">myisam_repair_threads</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token comment"># 这个参数对于后端连接毫无作用，什么是interactive？是你拿着键盘在mysql命令行下敲select, 这个叫interactive</span>
<span class="token assign-left variable">interactive_timeout</span><span class="token operator">=</span><span class="token number">28800</span>
<span class="token assign-left variable">wait_timeout</span><span class="token operator">=</span><span class="token number">28800</span>

<span class="token punctuation">[</span>mysqldump<span class="token punctuation">]</span>
quick
<span class="token assign-left variable">max_allowed_packet</span><span class="token operator">=</span>500M

<span class="token punctuation">[</span>myisamchk<span class="token punctuation">]</span>
<span class="token assign-left variable">key_buffer_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">sort_buffer_size</span><span class="token operator">=</span>8M
<span class="token assign-left variable">read_buffer</span><span class="token operator">=</span>4M
<span class="token assign-left variable">write_buffer</span><span class="token operator">=</span>4M</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/58%E5%88%B0%E5%AE%B6%E6%95%B0%E6%8D%AE%E5%BA%9330%E6%9D%A1%E5%86%9B%E8%A7%84%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/58%E5%88%B0%E5%AE%B6%E6%95%B0%E6%8D%AE%E5%BA%9330%E6%9D%A1%E5%86%9B%E8%A7%84%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">58到家数据库30条军规解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:20:38" itemprop="dateCreated datePublished" datetime="2020-12-09T23:20:38+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>军规适用场景</strong>：并发量大、数据量大的互联网业务</p>
<p><strong>军规</strong>：介绍内容</p>
<p><strong>解读</strong>：讲解原因，解读比军规更重要</p>
<p><strong>一、基础规范</strong></p>
<p><strong>（1）必须使用 InnoDB 存储引擎</strong></p>
<p>解读：支持事务、行级锁、并发性能更好、CPU 及内存缓存页优化使得资源利用率更高</p>
<p><strong>（2）必须使用 UTF8 字符集</strong></p>
<p>解读：万国码，无需转码，无乱码风险，节省空间</p>
<p><strong>（3）数据表、数据字段必须加入中文注释</strong></p>
<p>解读：N 年后谁 tm 知道这个 r1,r2,r3 字段是干嘛的</p>
<p><strong>（4）禁止使用存储过程、视图、触发器、Event</strong></p>
<p>解读：高并发大数据的互联网业务，架构设计思路是“解放数据库 CPU，将计算转移到服务层”，并发量大的情况下，这些功能很可能将数据库拖死，业务逻辑放到服务层具备更好的扩展性，能够轻易实现“增机器就加性能”。数据库擅长存储与索引，CPU 计算还是上移吧</p>
<p><strong>（5）禁止存储大文件或者大照片</strong></p>
<p>解读：为何要让数据库做它不擅长的事情？大文件和照片存储在文件系统，数据库里存 URI 多好</p>
<p><strong>二、命名规范</strong></p>
<p><strong>（6）只允许使用内网域名，而不是 ip 连接数据库</strong></p>
<p><strong>（7）线上环境、开发环境、测试环境数据库内网域名遵循命名规范</strong></p>
<p>业务名称：xxx</p>
<p>线上环境：dj.xxx.db</p>
<p>开发环境：dj.xxx.rdb</p>
<p>测试环境：dj.xxx.tdb</p>
<p><strong>从库</strong>在名称后加-s 标识，<strong>备库</strong>在名称后加-ss 标识</p>
<p>线上从库：dj.xxx-s.db</p>
<p>线上备库：dj.xxx-sss.db</p>
<p><strong>（8）库名、表名、字段名：小写，下划线风格，不超过 32 个字符，必须见名知意，禁止拼音英文混用</strong></p>
<p><strong>（9）表名 t_xxx，非唯一索引名 idx_xxx，唯一索引名 uniq_xxx</strong></p>
<p><strong>三、表设计规范</strong></p>
<p><strong>（10）单实例表数目必须小于 500</strong></p>
<p><strong>（11）单表列数目必须小于 30</strong></p>
<p><strong>（12）表必须有主键，例如自增主键</strong></p>
<p>解读：</p>
<p>a）主键递增，数据行写入可以提高插入性能，可以避免 page 分裂，减少表碎片提升空间和内存的使用</p>
<p>b）主键要选择较短的数据类型， Innodb 引擎普通索引都会保存主键的值，较短的数据类型可以有效的减少索引的磁盘空间，提高索引的缓存效率</p>
<p>c） 无主键的表删除，在 row 模式的主从架构，会导致备库夯住</p>
<p><strong>（13）禁止使用外键，如果有外键完整性约束，需要应用程序控制</strong></p>
<p>解读：外键会导致表与表之间耦合，update 与 delete 操作都会涉及相关联的表，十分影响 sql 的性能，甚至会造成死锁。高并发情况下容易造成数据库性能，大数据高并发业务场景数据库使用以性能优先</p>
<p><strong>四、字段设计规范</strong></p>
<p><strong>（14）必须把字段定义为 NOT NULL 并且提供默认值</strong></p>
<p>解读：</p>
<p>a）null 的列使索引&#x2F;索引统计&#x2F;值比较都更加复杂，对 MySQL 来说更难优化</p>
<p>b）null 这种类型 MySQL 内部需要进行特殊处理，增加数据库处理记录的复杂性；同等条件下，表中有较多空字段的时候，数据库的处理性能会降低很多</p>
<p>c）null 值需要更多的存储空，无论是表还是索引中每行中的 null 的列都需要额外的空间来标识</p>
<p>d）对 null 的处理时候，只能采用 is null 或 is not null，而不能采用&#x3D;、in、&lt;、&lt;&gt;、!&#x3D;、not in 这些操作符号。如：where name!&#x3D;’shenjian’，如果存在 name 为 null 值的记录，查询结果就不会包含 name 为 null 值的记录</p>
<p><strong>（15）禁止使用 TEXT、BLOB 类型</strong></p>
<p>解读：会浪费更多的磁盘和内存空间，非必要的大量的大字段查询会淘汰掉热数据，导致内存命中率急剧降低，影响数据库性能</p>
<p><strong>（16）禁止使用小数存储货币</strong></p>
<p>解读：使用整数吧，小数容易导致钱对不上</p>
<p><strong>（17）必须使用 varchar(20)存储手机号</strong></p>
<p>解读：</p>
<p>a）涉及到区号或者国家代号，可能出现+-()</p>
<p>b）手机号会去做数学运算么？</p>
<p>c）varchar 可以支持模糊查询，例如：like“138%”</p>
<p><strong>（18）禁止使用 ENUM，可使用 TINYINT 代替</strong></p>
<p>解读：</p>
<p>a）增加新的 ENUM 值要做 DDL 操作</p>
<p>b）ENUM 的内部实际存储就是整数，你以为自己定义的是字符串？</p>
<p><strong>五、索引设计规范</strong></p>
<p><strong>（19）单表索引建议控制在 5 个以内</strong></p>
<p><strong>（20）单索引字段数不允许超过 5 个</strong></p>
<p>解读：字段超过 5 个时，实际已经起不到有效过滤数据的作用了</p>
<p><strong>（21）禁止在更新十分频繁、区分度不高的属性上建立索引</strong></p>
<p>解读：</p>
<p>a）更新会变更 B+树，更新频繁的字段建立索引会大大降低数据库性能</p>
<p>b）“性别”这种区分度不大的属性，建立索引是没有什么意义的，不能有效过滤数据，性能与全表扫描类似</p>
<p><strong>（22）建立组合索引，必须把区分度高的字段放在前面</strong></p>
<p>解读：能够更加有效的过滤数据</p>
<p><strong>六、SQL 使用规范</strong></p>
<p><strong>（23）禁止使用 SELECT *，只获取必要的字段，需要显示说明列属性</strong></p>
<p>解读：</p>
<p>a）读取不需要的列会增加 CPU、IO、NET 消耗</p>
<p>b）不能有效的利用覆盖索引</p>
<p>c）使用 SELECT *容易在增加或者删除字段后出现程序 BUG</p>
<p><strong>（24）禁止使用 INSERT INTO t_xxx VALUES(xxx)，必须显示指定插入的列属性</strong></p>
<p>解读：容易在增加或者删除字段后出现程序 BUG</p>
<p><strong>（25）禁止使用属性隐式转换</strong></p>
<p>解读：SELECT uid FROM t_user WHERE phone&#x3D;13812345678 会导致全表扫描，而不能命中 phone 索引，猜猜为什么？（这个线上问题不止出现过一次）</p>
<p><strong>（26）禁止在 WHERE 条件的属性上使用函数或者表达式</strong></p>
<p>解读：SELECT uid FROM t_user WHERE from_unixtime(day)&gt;&#x3D;’2017-02-15’ 会导致全表扫描</p>
<p>正确的写法是：SELECT uid FROM t_user WHERE day&gt;&#x3D; unix_timestamp(‘2017-02-15 00:00:00’)</p>
<p><strong>（27）禁止负向查询，以及%开头的模糊查询</strong></p>
<p>解读：</p>
<p>a）负向查询条件：NOT、!&#x3D;、&lt;&gt;、!&lt;、!&gt;、NOT IN、NOT LIKE 等，会导致全表扫描</p>
<p>b）%开头的模糊查询，会导致全表扫描</p>
<p><strong>（28）禁止大表使用 JOIN 查询，禁止大表使用子查询</strong></p>
<p>解读：会产生临时表，消耗较多内存与 CPU，极大影响数据库性能</p>
<p><strong>（29）禁止使用 OR 条件，必须改为 IN 查询</strong></p>
<p>解读：旧版本 Mysql 的 OR 查询是不能命中索引的，即使能命中索引，为何要让数据库耗费更多的 CPU 帮助实施查询优化呢？</p>
<p><strong>（30）应用程序必须捕获 SQL 异常，并有相应处理</strong></p>
<p>总结：大数据量高并发的互联网业务，极大影响数据库性能的都不让用，不让用哟。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/OpenVPN/OpenVPN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/OpenVPN/OpenVPN/" class="post-title-link" itemprop="url">OpenVPN</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:19:16" itemprop="dateCreated datePublished" datetime="2020-12-09T23:19:16+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/OpenVPN/" itemprop="url" rel="index"><span itemprop="name">OpenVPN</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="OpenVPN-简介"><a href="#OpenVPN-简介" class="headerlink" title="OpenVPN 简介"></a>OpenVPN 简介</h2><h3 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a>VPN</h3><p>专用网：需要向电信运行商申请租用专线，在这条专用的线路上只传输自己的信息，安全稳定，但费用高昂。</p>
<p>VPN：Virtual Private Network，虚拟私有网络，又称为虚拟专用网络，用于在不安全的线路上安全的传输数据。</p>
<h3 id="OpenVPN"><a href="#OpenVPN" class="headerlink" title="OpenVPN"></a>OpenVPN</h3><p>OpenVPN：一个实现 VPN 的开源软件，OpenVPN 是一个健壮的、高度灵活的 VPN 守护进程。它支持 SSL&#x2F;TLS 安全、Ethernet bridging、经由代理的 TCP 或 UDP 隧道和 NAT。另外，它也支持动态 IP 地址以及 DHCP，可伸缩性足以支持数百或数千用户的使用场景，同时可移植至大多数主流操作系统平台上。<br>官网：<a target="_blank" rel="noopener" href="https://openvpn.net/">https://openvpn.net</a><br>GitHub 地址：<a target="_blank" rel="noopener" href="https://github.com/OpenVPN/openvpn">https://github.com/OpenVPN/openvpn</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1601385275341.png"></p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/OpenVPN">https://baike.baidu.com/item/OpenVPN</a><br><a target="_blank" rel="noopener" href="https://www.bbsmax.com/A/MAzAkpvq59/">https://www.bbsmax.com/A/MAzAkpvq59/</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28727570">https://zhuanlan.zhihu.com/p/28727570</a></p>
<p>客户端和服务端都需要安装 OpenVPN，OpenVPN 的技术核心是虚拟网卡和 SSL 协议，我们知道，物理网卡工作在数据链路层，而虚拟网卡即可以工作在数据链路层，也可以工作在网络层，这取决于设置 tun 模式还是 tap 模式，客户端和服务端的虚拟网卡配置的 IP 处于同一个网段（10.8.0.0&#x2F;24），客户端和服务端通过虚拟网卡通信，这样虽然中间隔着互联网，但就好像在一个局域网中一样</p>
<h4 id="通信过程"><a href="#通信过程" class="headerlink" title="通信过程"></a>通信过程</h4><ol>
<li>服务器 OpenVPN 配置一个静态的虚拟 IP（10.8.0.1）和一个虚拟 IP 池（10.8.0.2 - 1.0.8.254），为每一个成功建立 SSL 连接的客户端 OpenVPN 分配一个虚拟 IP 池中的 IP，然后将局域网网段、路由设置等信息推送给客户端 OpenVPN，这样，客户端就成功加入了虚拟的局域网</li>
<li>在 OpenVpn 中，如果用户访问一个远程的虚拟地址（属于虚拟网卡配用的地址系列，区别于真实地址），则操作系统会通过路由机制将数据包（TUN 模式）或数据帧（TAP 模式）发送到虚拟网卡上，服务程序接收该数据并进行相应的处理后，通过 SOCKET 从外网上发送出去，远程服务程序通过 SOCKET 从外网上接收数据，并进行相应的处理后，发送给虚拟网卡，则应用软件可以接收到，完成了一个单向传输的过程，反之亦然。</li>
<li>通信过程加密，支持 TCP 和 UDP</li>
</ol>
<h4 id="VPN-和-SSH"><a href="#VPN-和-SSH" class="headerlink" title="VPN 和 SSH"></a><a target="_blank" rel="noopener" href="http://www.howtoip.com/vpn-vs-ssh-tunnel-which-is-more-secure/">VPN 和 SSH</a></h4><p>我们知道，SSH 具有隧道转发的功能，它和 VPN 一样，都可以加密网络流量，实现安全通信，但是两者还是有很大的不同：….</p>
<h2 id="OpenVPN-部署"><a href="#OpenVPN-部署" class="headerlink" title="OpenVPN 部署"></a>OpenVPN 部署</h2><p>10.0.0.2 56hpnM</p>
<h3 id="准备-OpenVPN-部署环境"><a href="#准备-OpenVPN-部署环境" class="headerlink" title="准备 OpenVPN 部署环境"></a>准备 OpenVPN 部署环境</h3><p>需要四台主机，一台客户端，一台 OpenVPN 服务器，两台内网服务器。</p>
<p>三台服务从阿里云购买，OpenVPN 服务器需要配置公网 IP，两台内网服务器不需要配置公网 IP。</p>
<h4 id="配置-OpenVPN-服务器"><a href="#配置-OpenVPN-服务器" class="headerlink" title="配置 OpenVPN 服务器"></a>配置 OpenVPN 服务器</h4><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ol>
<li>编译安装的 openvpn 总是无法启动，每次都启动超时，不知道为什么，所以还是通过 yum 来安装吧</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># OpenVPN</span>
<span class="token punctuation">[</span>root@4710419222 /<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> openvpn
<span class="token comment"># 证书管理工具</span>
<span class="token punctuation">[</span>root@4710419222 /<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/src
<span class="token punctuation">[</span>root@4710419222 src<span class="token punctuation">]</span><span class="token variable">$wget</span> https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.8/EasyRSA-3.0.8.tgz
<span class="token punctuation">[</span>root@4710419222 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxvf EasyRSA-3.0.8.tgz</code></pre>

<p>easy-rsa：证书管理工具，负责建立私有 CA、颁发管理证书等工作，通过调用 openssl 来实现功能，所以 easy-rsa 能实现的功能，openssl 都能实现，只是更麻烦一些</p>
<ol start="2">
<li>准备相关配置文件</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置文件</span>
<span class="token function">cp</span> /usr/share/doc/openvpn-2.4.9/sample/sample-config-files/server.conf /etc/openvpn
<span class="token comment"># 证书签发相关文件</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/openvpn/easy-rsa-<span class="token punctuation">&#123;</span>server,client<span class="token punctuation">&#125;</span>
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /usr/local/src/EasyRSA-3.0.8/<span class="token punctuation">&#123;</span>easyrsa,vars.example,x509-types,openssl-easyrsa.cnf<span class="token punctuation">&#125;</span> /etc/openvpn/easy-rsa-server/
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /usr/local/src/EasyRSA-3.0.8/<span class="token punctuation">&#123;</span>easyrsa,vars.example,x509-types,openssl-easyrsa.cnf<span class="token punctuation">&#125;</span> /etc/openvpn/easy-rsa-client/
<span class="token function">mv</span> /etc/openvpn/easy-rsa-server/vars.example /etc/openvpn/easy-rsa-server/vars
<span class="token function">mv</span> /etc/openvpn/easy-rsa-client/vars.example /etc/openvpn/easy-rsa-client/vars
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── client
├── easy-rsa-client
│   ├── easyrsa
│   ├── openssl-easyrsa.cnf
│   ├── vars
│   └── x509-types
│       ├── ca
│       ├── client
│       ├── code-signing
│       ├── COMMON
│       ├── email
│       ├── kdc
│       ├── server
│       └── serverClient
├── easy-rsa-server
│   ├── easyrsa
│   ├── openssl-easyrsa.cnf
│   ├── vars
│   └── x509-types
│       ├── ca
│       ├── client
│       ├── code-signing
│       ├── COMMON
│       ├── email
│       ├── kdc
│       ├── server
│       └── serverClient
├── server
└── server.conf

<span class="token number">7</span> directories, <span class="token number">23</span> files</code></pre>

<h4 id="准备证书相关文件"><a href="#准备证书相关文件" class="headerlink" title="准备证书相关文件"></a>准备证书相关文件</h4><h5 id="1-查看初始文件"><a href="#1-查看初始文件" class="headerlink" title="1. 查看初始文件"></a>1. 查看初始文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cd</span> easy-rsa-server/
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">100</span>
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">76946</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 easyrsa
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4616</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 openssl-easyrsa.cnf
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">8925</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 vars
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 x509-types
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa <span class="token parameter variable">--version</span>
EasyRSA Version Information
Version:     <span class="token number">3.0</span>.8
Generated:   Wed Sep  <span class="token number">9</span> <span class="token number">15</span>:59:45 CDT <span class="token number">2020</span>
SSL Lib:     OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Git Commit:  f12e00e53b4f486ce3d119ca429198780fa694ac
Source Repo: https://github.com/OpenVPN/easy-rsa
</code></pre>

<h5 id="2-初始化-PKI，生成-PKI-相关目录和文件"><a href="#2-初始化-PKI，生成-PKI-相关目录和文件" class="headerlink" title="2. 初始化 PKI，生成 PKI 相关目录和文件"></a>2. 初始化 PKI，生成 PKI 相关目录和文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa init-pki

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars

init-pki complete<span class="token punctuation">;</span> you may now create a CA or requests.
Your newly created PKI <span class="token function">dir</span> is: /etc/openvpn/easy-rsa-server/pki


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── easyrsa
├── openssl-easyrsa.cnf
├── pki		<span class="token comment"># 生成一个新目录及相关文件</span>
│   ├── openssl-easyrsa.cnf
│   ├── private
│   ├── reqs
│   └── safessl-easyrsa.cnf
├── vars
└── x509-types
    ├── ca
    ├── client
    ├── code-signing
    ├── COMMON
    ├── email
    ├── kdc
    ├── server
    └── serverClient

<span class="token number">4</span> directories, <span class="token number">13</span> files
</code></pre>

<h5 id="3-创建私有-CA-机构"><a href="#3-创建私有-CA-机构" class="headerlink" title="3. 创建私有 CA 机构"></a>3. 创建私有 CA 机构</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa build-ca nopass

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating RSA private key, <span class="token number">2048</span> bit long modulus
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Common Name <span class="token punctuation">(</span>eg: your user, host, or server name<span class="token punctuation">)</span> <span class="token punctuation">[</span>Easy-RSA CA<span class="token punctuation">]</span>:	<span class="token comment"># 接受默认值,直接回车</span>

CA creation complete and you may now <span class="token function">import</span> and sign cert requests.
Your new CA certificate <span class="token function">file</span> <span class="token keyword">for</span> publishing is at:
/etc/openvpn/easy-rsa-server/pki/ca.crt		<span class="token comment"># 生成自签名的证书文件</span>



<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── easyrsa
├── openssl-easyrsa.cnf
├── pki
│   ├── ca.crt				<span class="token comment"># 生成自签名的证书文件</span>
│   ├── certs_by_serial
│   ├── index.txt			<span class="token comment"># 数据库文件</span>
│   ├── index.txt.attr
│   ├── issued
│   ├── openssl-easyrsa.cnf
│   ├── private
│   │   └── ca.key			<span class="token comment"># 生成私钥文件</span>
│   ├── renewed
│   │   ├── certs_by_serial
│   │   ├── private_by_serial
│   │   └── reqs_by_serial
│   ├── reqs
│   ├── revoked
│   │   ├── certs_by_serial
│   │   ├── private_by_serial
│   │   └── reqs_by_serial
│   ├── safessl-easyrsa.cnf
│   └── serial				<span class="token comment"># CA serial number file</span>
├── vars
└── x509-types
    ├── ca
    ├── client
    ├── code-signing
    ├── COMMON
    ├── email
    ├── kdc
    ├── server
    └── serverClient

<span class="token number">14</span> directories, <span class="token number">18</span> files</code></pre>

<h5 id="4-创建服务端证书申请"><a href="#4-创建服务端证书申请" class="headerlink" title="4. 创建服务端证书申请"></a>4. 创建服务端证书申请</h5><p>首先生成私钥，然后使用私钥生成证书申请文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa gen-req server nopass

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating a <span class="token number">2048</span> bit RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
writing new private key to <span class="token string">'/etc/openvpn/easy-rsa-server/pki/easy-rsa-2906.nnaLFU/tmp.yVgZX9'</span>
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Common Name <span class="token punctuation">(</span>eg: your user, host, or server name<span class="token punctuation">)</span> <span class="token punctuation">[</span>server<span class="token punctuation">]</span>: <span class="token comment"># 默认值,直接回车</span>

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-server/pki/reqs/server.req		<span class="token comment"># 生成请求文件</span>
key: /etc/openvpn/easy-rsa-server/pki/private/server.key	<span class="token comment"># 生成私钥文件</span>



<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki
pki
├── ca.crt
├── certs_by_serial
├── index.txt
├── index.txt.attr
├── issued
├── openssl-easyrsa.cnf
├── private
│   ├── ca.key
│   └── server.key			<span class="token comment"># 生成私钥文件</span>
├── renewed
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── reqs
│   └── server.req			<span class="token comment"># 生成请求文件</span>
├── revoked
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── safessl-easyrsa.cnf
└── serial

<span class="token number">12</span> directories, <span class="token number">9</span> files</code></pre>

<h5 id="5-颁发服务端证书"><a href="#5-颁发服务端证书" class="headerlink" title="5. 颁发服务端证书"></a>5. 颁发服务端证书</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看命令用法，</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa <span class="token builtin class-name">help</span> sign

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars

  sign-req <span class="token operator">&lt;</span>type<span class="token operator">></span> <span class="token operator">&lt;</span>filename_base<span class="token operator">></span>
      Sign a certificate request of the defined type. <span class="token operator">&lt;</span>type<span class="token operator">></span> must be a known
      <span class="token builtin class-name">type</span> such as <span class="token string">'client'</span>, <span class="token string">'server'</span>, <span class="token string">'serverClient'</span>, or <span class="token string">'ca'</span> <span class="token punctuation">(</span>or a user-added type.<span class="token punctuation">)</span>

      This request <span class="token function">file</span> must exist <span class="token keyword">in</span> the reqs/ <span class="token function">dir</span> and have a .req <span class="token function">file</span>
      extension. See import-req below <span class="token keyword">for</span> importing reqs from other sources.

<span class="token comment"># 颁发服务端证书</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa sign server server

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>


You are about to sign the following certificate.
Please check over the details shown below <span class="token keyword">for</span> accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span class="token builtin class-name">source</span> or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate <span class="token keyword">for</span> <span class="token number">825</span> days:

<span class="token assign-left variable">subject</span><span class="token operator">=</span>
    commonName                <span class="token operator">=</span> server


Type the word <span class="token string">'yes'</span> to continue, or any other input to abort.
  Confirm request details: <span class="token function">yes</span>		<span class="token comment"># 输入yes，回车</span>
Using configuration from /etc/openvpn/easy-rsa-server/pki/easy-rsa-3000.Ova1sM/tmp.xCpj0p
Check that the request matches the signature
Signature ok
The Subject<span class="token string">'s Distinguished Name is as follows
commonName            :ASN.1 12:'</span>server'
Certificate is to be certified <span class="token keyword">until</span> Jan  <span class="token number">7</span> <span class="token number">14</span>:03:25 <span class="token number">2023</span> GMT <span class="token punctuation">(</span><span class="token number">825</span> days<span class="token punctuation">)</span>

Write out database with <span class="token number">1</span> new entries
Data Base Updated

Certificate created at: /etc/openvpn/easy-rsa-server/pki/issued/server.crt <span class="token comment"># 生成的证书</span>


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki
pki
├── ca.crt
├── certs_by_serial
│   └── 61A86BA6C8B9482479FEF411570C8654.pem	<span class="token comment"># 服务器证书文件</span>
├── index.txt
├── index.txt.attr
├── index.txt.attr.old
├── index.txt.old
├── issued
│   └── server.crt
├── openssl-easyrsa.cnf
├── private
│   ├── ca.key
│   └── server.key		<span class="token comment"># 服务器证书文件，这两个文件是一样的</span>
├── renewed
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── reqs
│   └── server.req
├── revoked
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── safessl-easyrsa.cnf
├── serial
└── serial.old

<span class="token number">12</span> directories, <span class="token number">14</span> files</code></pre>

<h5 id="6-创建-Diffie-Hellman-密钥"><a href="#6-创建-Diffie-Hellman-密钥" class="headerlink" title="6. 创建 Diffie-Hellman 密钥"></a>6. 创建 Diffie-Hellman 密钥</h5><p>DH 密钥，用于 SSL 加密通信</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa gen-dh

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating DH parameters, <span class="token number">2048</span> bit long safe prime, generator <span class="token number">2</span>
This is going to take a long <span class="token function">time</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.	<span class="token comment"># 需要等一会</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$ll</span> ./pki/dh.pem
-rw------- <span class="token number">1</span> root root <span class="token number">424</span> Oct  <span class="token number">4</span> <span class="token number">22</span>:09 ./pki/dh.pem</code></pre>

<h5 id="7-准备客户端证书环境"><a href="#7-准备客户端证书环境" class="headerlink" title="7. 准备客户端证书环境"></a>7. 准备客户端证书环境</h5><p>上面服务端证书配置完成，下面是配置客户端证书</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$cd</span> <span class="token punctuation">..</span>/easy-rsa-client/
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn/easy-rsa-client
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">100</span>
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">76946</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 easyrsa
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4616</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 openssl-easyrsa.cnf
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">8925</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 vars
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 x509-types
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── easyrsa
├── openssl-easyrsa.cnf
├── vars
└── x509-types
    ├── ca
    ├── client
    ├── code-signing
    ├── COMMON
    ├── email
    ├── kdc
    ├── server
    └── serverClient

<span class="token number">1</span> directory, <span class="token number">11</span> files
<span class="token comment"># 初始化pki，和上面步骤一样，就不详细介绍了</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span>$./easyrsa init-pki</code></pre>

<h5 id="8-创建客户端证书申请"><a href="#8-创建客户端证书申请" class="headerlink" title="8. 创建客户端证书申请"></a>8. 创建客户端证书申请</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span>$./easyrsa gen-req lujinkai nopass

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating a <span class="token number">2048</span> bit RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++
writing new private key to <span class="token string">'/etc/openvpn/easy-rsa-client/pki/easy-rsa-3187.Tyzo2P/tmp.KswAlv'</span>
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Common Name <span class="token punctuation">(</span>eg: your user, host, or server name<span class="token punctuation">)</span> <span class="token punctuation">[</span>lujinkai<span class="token punctuation">]</span>:	<span class="token comment"># 默认，回车</span>

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-client/pki/reqs/lujinkai.req		<span class="token comment"># 申请文件</span>
key: /etc/openvpn/easy-rsa-client/pki/private/lujinkai.key	<span class="token comment"># 私钥</span>
</code></pre>

<h5 id="9-签发客户端证书"><a href="#9-签发客户端证书" class="headerlink" title="9. 签发客户端证书"></a>9. 签发客户端证书</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 回到easy-rsa-server</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$cd</span> <span class="token punctuation">..</span>/easy-rsa-server/
<span class="token comment"># 将客户端证书请求文件复制到CA的工作目录，也可以使用cp命令</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa import-req /etc/openvpn/easy-rsa-client/pki/reqs/lujinkai.req lujinkai

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>

The request has been successfully imported with a short name of: lujinkai
You may now use this name to perform signing operations on this request.


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki/reqs/
pki/reqs/
├── lujinkai.req	<span class="token comment"># 复制过来的申请文件</span>
└── server.req

<span class="token number">0</span> directories, <span class="token number">2</span> files
<span class="token comment"># 签发客户端证书</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa sign client lujinkai

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>


You are about to sign the following certificate.
Please check over the details shown below <span class="token keyword">for</span> accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span class="token builtin class-name">source</span> or that you have verified the request checksum with the sender.

Request subject, to be signed as a client certificate <span class="token keyword">for</span> <span class="token number">825</span> days:

<span class="token assign-left variable">subject</span><span class="token operator">=</span>
    commonName                <span class="token operator">=</span> lujinkai


Type the word <span class="token string">'yes'</span> to continue, or any other input to abort.
  Confirm request details: <span class="token function">yes</span>	<span class="token comment"># 输入yes，回车</span>
Using configuration from /etc/openvpn/easy-rsa-server/pki/easy-rsa-3291.YugvYL/tmp.xXkvue
Check that the request matches the signature
Signature ok
The Subject<span class="token string">'s Distinguished Name is as follows
commonName            :ASN.1 12:'</span>lujinkai'
Certificate is to be certified <span class="token keyword">until</span> Jan  <span class="token number">7</span> <span class="token number">14</span>:24:14 <span class="token number">2023</span> GMT <span class="token punctuation">(</span><span class="token number">825</span> days<span class="token punctuation">)</span>

Write out database with <span class="token number">1</span> new entries
Data Base Updated

Certificate created at: /etc/openvpn/easy-rsa-server/pki/issued/lujinkai.crt


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki/issued/
pki/issued/
├── lujinkai.crt	<span class="token comment"># 签发的客户端证书</span>
└── server.crt

<span class="token number">0</span> directories, <span class="token number">2</span> files</code></pre>

<h5 id="10-将-ca-和服务器相关文件复制到服务器相应的目录"><a href="#10-将-ca-和服务器相关文件复制到服务器相应的目录" class="headerlink" title="10. 将 ca 和服务器相关文件复制到服务器相应的目录"></a>10. 将 ca 和服务器相关文件复制到服务器相应的目录</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token parameter variable">-r</span> ./easy-rsa-server/pki/<span class="token punctuation">&#123;</span>ca.crt,issued/server.crt,private/server.key,dh.pem<span class="token punctuation">&#125;</span> ./certs/
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$ll</span> ./certs/
total <span class="token number">20</span>
-rw------- <span class="token number">1</span> root root <span class="token number">1172</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 ca.crt
-rw------- <span class="token number">1</span> root root  <span class="token number">424</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 dh.pem
-rw------- <span class="token number">1</span> root root <span class="token number">4547</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 server.crt
-rw------- <span class="token number">1</span> root root <span class="token number">1704</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 server.key</code></pre>

<h5 id="11-将-ca-和客户端相关文件复制到服务器相关的目录"><a href="#11-将-ca-和客户端相关文件复制到服务器相关的目录" class="headerlink" title="11. 将 ca 和客户端相关文件复制到服务器相关的目录"></a>11. 将 ca 和客户端相关文件复制到服务器相关的目录</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cp</span> easy-rsa-server/pki/<span class="token punctuation">&#123;</span>ca.crt,issued/lujinkai.crt<span class="token punctuation">&#125;</span> client/
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cp</span> easy-rsa-client/pki/private/lujinkai.key client/
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$ll</span> client/
total <span class="token number">16</span>
-rw------- <span class="token number">1</span> root root <span class="token number">1172</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:52 ca.crt
-rw------- <span class="token number">1</span> root root <span class="token number">4431</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:52 lujinkai.crt
-rw------- <span class="token number">1</span> root root <span class="token number">1708</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:52 lujinkai.key</code></pre>

<h4 id="准备-OpenVPN-服务端配置文件"><a href="#准备-OpenVPN-服务端配置文件" class="headerlink" title="准备 OpenVPN 服务端配置文件"></a>准备 OpenVPN 服务端配置文件</h4><h5 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># grep -Ev '^#|^$' server.conf 或：</span>
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/^#/d'</span> <span class="token parameter variable">-e</span> <span class="token string">'/^$/d'</span> server.conf
<span class="token punctuation">;</span><span class="token builtin class-name">local</span> a.b.c.d	<span class="token comment"># 本机监听IP,默认为本机所有IP</span>
port <span class="token number">1194</span>
<span class="token punctuation">;</span>proto tcp
proto udp
<span class="token punctuation">;</span>dev tap	<span class="token comment"># 创建一个以太网隧道，tap模拟以太网设备，工作在第二层</span>
dev tun		<span class="token comment"># 创建一个路由IP隧道，tun模拟网络层设备，工作在第三层</span>
<span class="token punctuation">;</span>dev-node MyTap		<span class="token comment"># TAP-Win32适配器。非windows不需要配置</span>
ca ca.crt			<span class="token comment"># ca证书文件</span>
cert server.crt		<span class="token comment"># 服务器证书文件</span>
key server.key		<span class="token comment"># 服务器私钥文件  # This file should be kept secret</span>
dh dh2048.pem		<span class="token comment"># dh参数文件</span>
<span class="token punctuation">;</span>topology subnet	<span class="token comment"># 拓扑类型：默认是net30模式，很浪费IP地址，建议开启subnet模式</span>
server <span class="token number">10.8</span>.0.0 <span class="token number">255.255</span>.255.0 <span class="token comment"># 客户端建立ssl连接后分配IP的连接池，服务器默认占用第一个IP 10.8.0.1</span>
ifconfig-pool-persist ipp.txt	<span class="token comment"># 为客户端分配固定的IP</span>
<span class="token punctuation">;</span>server-bridge <span class="token number">10.8</span>.0.4 <span class="token number">255.255</span>.255.0 <span class="token number">10.8</span>.0.50 <span class="token number">10.8</span>.0.100	<span class="token comment"># 配置网桥模式</span>
<span class="token punctuation">;</span>server-bridge
<span class="token punctuation">;</span>push <span class="token string">"route 192.168.10.0 255.255.255.0"</span>	<span class="token comment"># 推送路由设置给客户端，设置私网地址</span>
<span class="token punctuation">;</span>push <span class="token string">"route 192.168.20.0 255.255.255.0"</span>
<span class="token punctuation">;</span>client-config-dir ccd		<span class="token comment"># 指定的客户端添加路由，此路由通常是客户端后面的内网网段</span>
<span class="token punctuation">;</span>route <span class="token number">192.168</span>.40.128 <span class="token number">255.255</span>.255.248
<span class="token punctuation">;</span>client-config-dir ccd
<span class="token punctuation">;</span>route <span class="token number">10.9</span>.0.0 <span class="token number">255.255</span>.255.252
<span class="token punctuation">;</span>learn-address ./script		<span class="token comment"># 运行外部脚本，创建不同组的iptables规则</span>
<span class="token punctuation">;</span>push <span class="token string">"redirect-gateway def1 bypass-dhcp"</span>	<span class="token comment"># 启用后，客户端所有流量都将通过VPN服务器</span>
<span class="token punctuation">;</span>push <span class="token string">"dhcp-option DNS 208.67.222.222"</span>		<span class="token comment"># 推送DNS服务器</span>
<span class="token punctuation">;</span>push <span class="token string">"dhcp-option DNS 208.67.220.220"</span>
<span class="token punctuation">;</span>client-to-client		<span class="token comment"># 允许不同的client直接通信,不安全,生产环境一般不配置</span>
<span class="token punctuation">;</span>duplicate-cn		<span class="token comment"># 多个用户共用一个证书，一般用于测试环境，生产环境都是一个用户一个证书</span>
keepalive <span class="token number">10</span> <span class="token number">120</span>	<span class="token comment"># 心跳，10秒ping一次，120秒没有回应则认为对方已经down</span>
<span class="token comment"># 访止DoS等攻击的安全增强配置，可以使用openvpn命令生成：openvpn --genkey --secret ta.key</span>
<span class="token comment"># 服务器和每个客户端都需要拥有该密钥的一个拷贝。第二个参数在服务器端应该为’0’，在客户端应该为’1’</span>
tls-auth ta.key <span class="token number">0</span> <span class="token comment"># This file is secret</span>
cipher AES-256-CBC	<span class="token comment"># 加密算法</span>
<span class="token punctuation">;</span>compress lz4-v2	<span class="token comment"># 启用Openvpn2.4.X新版压缩算法</span>
<span class="token punctuation">;</span>push <span class="token string">"compress lz4-v2"</span>	<span class="token comment"># 推送客户端使用新版压缩算法,和下面的comp-lzo不要同时使用</span>
<span class="token punctuation">;</span>comp-lzo	<span class="token comment"># 旧户端兼容的压缩配置，需要客户端配置开启压缩,openvpn2.4.X等新版可以不用开启</span>
<span class="token punctuation">;</span>max-clients <span class="token number">100</span>	<span class="token comment"># 最大客户端数</span>
<span class="token punctuation">;</span>user nobody	<span class="token comment"># 运行openvpn服务的用户和组</span>
<span class="token punctuation">;</span>group nobody
persist-key		<span class="token comment"># 重启VPN服务时默认会重新读取key文件</span>
persist-tun		<span class="token comment"># 重启vpn服务时，一直保持tun或者tap设备是up的，否则会先down然后再up</span>
status openvpn-status.log	<span class="token comment"># openVPN状态记录文件，每分钟会记录一次</span>
<span class="token punctuation">;</span>log         openvpn.log	<span class="token comment"># 指定日志路径，log会在openvpn启动的时候清空日志文件</span>
<span class="token punctuation">;</span>log-append  openvpn.log	<span class="token comment"># 指定日志路径，重启openvpn后在之前的日志后面追加新的日志</span>
<span class="token comment"># 设置日志级别，0-9，级别越高记录的内容越详细,0 表示静默运行，只记录致命错误,4 表示合理的常规用法,5 和 6 可以帮助调试连接错误。9 表示极度冗余，输出非常详细的日志信息</span>
verb <span class="token number">3</span>
<span class="token punctuation">;</span>mute <span class="token number">20</span>	<span class="token comment"># 相同类别的信息只有前20条会输出到日志文件中</span>
<span class="token comment"># 通知客户端，在服务端重启后自动重新连接，仅能用于udp模式，tcp模式不需要配置即可实现断开重新连接,且开启此项后tcp配置后将导致openvpn服务无法启动,所以tcp时必须不能开启此项</span>
explicit-exit-notify <span class="token number">1</span></code></pre>

<h5 id="修改服务端配置文件"><a href="#修改服务端配置文件" class="headerlink" title="修改服务端配置文件"></a>修改服务端配置文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash">port <span class="token number">1194</span>
proto tcp
dev tun
ca /etc/openvpn/certs/ca.crt
cert /etc/openvpn/certs/server.crt
key /etc/openvpn/certs/server.key  <span class="token comment"># This file should be kept secret</span>
dh /etc/openvpn/certs/dh.pem
topology subnet
server <span class="token number">10.8</span>.0.0 <span class="token number">255.255</span>.255.0
push <span class="token string">"route 10.0.0.0 255.255.255.0"</span>
keepalive <span class="token number">10</span> <span class="token number">120</span>
max-clients <span class="token number">1024</span>
user openvpn
group openvpn
status /var/log/openvpn/openvpn-status.log
log-append  /var/log/openvpn/openvpn.log
verb <span class="token number">9</span>
mute <span class="token number">20</span></code></pre>

<h5 id="准备日志相关"><a href="#准备日志相关" class="headerlink" title="准备日志相关"></a>准备日志相关</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$getent</span> <span class="token function">passwd</span> openvpn
openvpn:x:995:993:OpenVPN:/etc/openvpn:/sbin/nologin
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /var/log/openvpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$chown</span> openvpn.openvpn /var/log/openvpn</code></pre>

<h4 id="配置防火墙和内核参数"><a href="#配置防火墙和内核参数" class="headerlink" title="配置防火墙和内核参数"></a>配置防火墙和内核参数</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启ip_forward</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/net/ipv4/ip_forward
<span class="token comment"># 添加snat规则</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list ruleset
table <span class="token function">ip</span> nat <span class="token punctuation">&#123;</span>
        chain postrouting <span class="token punctuation">&#123;</span>
                <span class="token builtin class-name">type</span> nat hook postrouting priority srcnat<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
                <span class="token function">ip</span> saddr <span class="token number">10.8</span>.0.0/24 masquerade
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>比较奇怪的是以上设置不对，好像 nftables 不行，只能使用 iptables，于是关掉 nftables，设置 iptables：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 nftables<span class="token punctuation">]</span><span class="token variable">$iptables</span> <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">10.8</span>.0.0/24 <span class="token parameter variable">-j</span> MASQUERADE</code></pre>

<h4 id="启动-OpenVPN"><a href="#启动-OpenVPN" class="headerlink" title="启动 OpenVPN"></a>启动 OpenVPN</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start openvpn@server
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> status openvpn@server
● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/openvpn@.service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Wed <span class="token number">2020</span>-10-07 <span class="token number">17</span>:41:08 CST<span class="token punctuation">;</span> 2s ago
 Main PID: <span class="token number">10185</span> <span class="token punctuation">(</span>openvpn<span class="token punctuation">)</span>
   Status: <span class="token string">"Initialization Sequence Completed"</span>
   CGroup: /system.slice/system-openvpn.slice/openvpn@server.service
           └─10185 /usr/sbin/openvpn <span class="token parameter variable">--cd</span> /etc/openvpn/ <span class="token parameter variable">--config</span> server.conf

Oct 07 <span class="token number">17</span>:41:08 <span class="token number">4710419222</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Starting OpenVPN Robust And Highly Flexible Tunneling Application On server<span class="token punctuation">..</span>.
Oct 07 <span class="token number">17</span>:41:08 <span class="token number">4710419222</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started OpenVPN Robust And Highly Flexible Tunneling Application On server.
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$ss</span> <span class="token parameter variable">-ntl</span>
State      Recv-Q Send-Q                                     Local Address:Port                                                    Peer Address:Port
LISTEN     <span class="token number">0</span>      <span class="token number">32</span>                                                     *:1194                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:3306                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                            <span class="token number">127.0</span>.0.1:6379                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:80                                                                 *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:22                                                                 *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:443                                                                *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:9501                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:8000                                                               *:*
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> openvpn
openvpn  <span class="token number">10185</span>  <span class="token number">0.0</span>  <span class="token number">0.3</span>  <span class="token number">75036</span>  <span class="token number">7420</span> ?        Ss   <span class="token number">17</span>:41   <span class="token number">0</span>:00 /usr/sbin/openvpn <span class="token parameter variable">--cd</span> /etc/openvpn/ <span class="token parameter variable">--config</span> server.conf
root     <span class="token number">10232</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>   <span class="token number">9096</span>   <span class="token number">848</span> pts/1    R+   <span class="token number">17</span>:41   <span class="token number">0</span>:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span> openvpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$ip</span> a
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span>
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:16:3e:05:9f:fc brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.0</span>.0.1/24 brd <span class="token number">10.0</span>.0.255 scope global dynamic eth0
       valid_lft 315108100sec preferred_lft 315108100sec
    inet6 fe80::216:3eff:fe05:9ffc/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: tun0: <span class="token operator">&lt;</span>POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UNKNOWN group default qlen <span class="token number">100</span>
    link/none
    inet <span class="token number">10.8</span>.0.1/24 brd <span class="token number">10.8</span>.0.255 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::2fa5:3d20:6dff:99d9/64 scope <span class="token function">link</span> flags <span class="token number">800</span>
       valid_lft forever preferred_lft forever</code></pre>

<h4 id="准备-OpenVPN-客户端配置文件"><a href="#准备-OpenVPN-客户端配置文件" class="headerlink" title="准备 OpenVPN 客户端配置文件"></a>准备 OpenVPN 客户端配置文件</h4><h5 id="配置文件说明-1"><a href="#配置文件说明-1" class="headerlink" title="配置文件说明"></a>配置文件说明</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 客户端配置文件，后缀必须是.ovpn</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token parameter variable">-v</span> <span class="token string">'^#'</span> /usr/share/doc/openvpn-2.4.9/sample/sample-config-files/client.conf <span class="token operator">></span> /etc/openvpn/client/lujinkai/client.ovpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/^$/d'</span> /etc/openvpn/client/lujinkai/client.ovpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/openvpn/client/lujinkai/client.ovpn
client		<span class="token comment"># 声明客户端</span>
<span class="token punctuation">;</span>dev tap	<span class="token comment"># 接口类型，必须和服务端一致</span>
dev tun
<span class="token punctuation">;</span>dev-node MyTap
<span class="token punctuation">;</span>proto tcp	<span class="token comment"># 协议类型，必须和服务端一致</span>
proto udp
remote my-server-1 <span class="token number">1194</span>		<span class="token comment"># server端的ip和端口，可以写域名但是需要可以解析成IP</span>
<span class="token punctuation">;</span>remote my-server-2 <span class="token number">1194</span>
<span class="token punctuation">;</span>remote-random
resolv-retry infinite		<span class="token comment"># 如果写域名，就始终解析，当域名发生变化，会重新连接到新的域名对应的IP</span>
nobind		<span class="token comment"># 本机不绑定监听端口，客户端是随机打开端口连接到服务端的1194</span>
<span class="token punctuation">;</span>user nobody
<span class="token punctuation">;</span>group nobody
persist-key
persist-tun
<span class="token punctuation">;</span>http-proxy-retry <span class="token comment"># retry on connection failures</span>
<span class="token punctuation">;</span>http-proxy <span class="token punctuation">[</span>proxy server<span class="token punctuation">]</span> <span class="token punctuation">[</span>proxy port <span class="token comment">#]</span>
<span class="token punctuation">;</span>mute-replay-warnings
ca ca.crt
cert client.crt
key client.key
remote-cert-tls server	<span class="token comment"># 指定采用服务器证书校验方式</span>
tls-auth ta.key <span class="token number">1</span>
cipher AES-256-CBC
verb <span class="token number">3</span>
<span class="token punctuation">;</span>mute <span class="token number">20</span></code></pre>

<h5 id="修改客户端配置文件"><a href="#修改客户端配置文件" class="headerlink" title="修改客户端配置文件"></a>修改客户端配置文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash">client
dev tun
proto tcp
remote <span class="token number">47.104</span>.192.22 <span class="token number">1194</span>
resolv-retry infinite
nobind
ca ca.crt
cert lujinkai.crt
key lujinkai.key
remote-cert-tls server
<span class="token punctuation">;</span>tls-auth ta.key <span class="token number">1</span>
<span class="token punctuation">;</span>cipher AES-256-CBC
verb <span class="token number">3</span>
mute <span class="token number">20</span></code></pre>

<h4 id="Windows-配置部署-OpenVPN-客户端"><a href="#Windows-配置部署-OpenVPN-客户端" class="headerlink" title="Windows 配置部署 OpenVPN 客户端"></a>Windows 配置部署 OpenVPN 客户端</h4><p>将客户端相关文件下载下来：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 lujinkai<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn/client/lujinkai
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$ll</span> lujinkai
total <span class="token number">20</span>
-rw------- <span class="token number">1</span> root root <span class="token number">1172</span> Oct  <span class="token number">4</span> <span class="token number">19</span>:25 ca.crt
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">436</span> Oct  <span class="token number">7</span> <span class="token number">18</span>:05 client.ovpn
-rw------- <span class="token number">1</span> root root <span class="token number">4438</span> Oct  <span class="token number">4</span> <span class="token number">19</span>:25 lujinkai.crt
-rw------- <span class="token number">1</span> root root <span class="token number">1704</span> Oct  <span class="token number">4</span> <span class="token number">19</span>:25 lujinkai.key
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$tar</span> cvf lujinkai.tar lujinkai/
lujinkai/
lujinkai/lujinkai.key
lujinkai/client.ovpn
lujinkai/ca.crt
lujinkai/lujinkai.crt
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">24</span>
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Oct  <span class="token number">7</span> <span class="token number">18</span>:28 lujinkai
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">20480</span> Oct  <span class="token number">8</span> <span class="token number">10</span>:57 lujinkai.tar
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$sz</span> lujinkai.tar
rz
Starting zmodem transfer.  Press Ctrl+C to cancel.
Transferring lujinkai.tar<span class="token punctuation">..</span>.
  <span class="token number">100</span>%      <span class="token number">20</span> KB      <span class="token number">20</span> KB/sec    00:00:01       <span class="token number">0</span> Errors</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1602126060938.png"></p>
<p>注意：tap 网卡驱动可能因为缺少数字签名无法启动，可以在开机的时候按 F8，然后禁用校验驱动的数字签名，可是这样只能当次开机有效，不知道怎么彻底解决。。。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1602126241434.png"></p>
<h4 id="Mac-OS-配置部署-OpenVPN-客户端"><a href="#Mac-OS-配置部署-OpenVPN-客户端" class="headerlink" title="Mac OS 配置部署 OpenVPN 客户端"></a>Mac OS 配置部署 OpenVPN 客户端</h4><p>略。。。</p>
<h2 id="故障排错"><a href="#故障排错" class="headerlink" title="故障排错"></a>故障排错</h2><h2 id="OpenVPN-高级功能"><a href="#OpenVPN-高级功能" class="headerlink" title="OpenVPN 高级功能"></a>OpenVPN 高级功能</h2><h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E9%98%B2%E7%81%AB%E5%A2%99/iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E9%98%B2%E7%81%AB%E5%A2%99/iptables/" class="post-title-link" itemprop="url">iptables</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:17:52" itemprop="dateCreated datePublished" datetime="2020-12-09T23:17:52+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E9%98%B2%E7%81%AB%E5%A2%99/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安全技术和防火墙"><a href="#安全技术和防火墙" class="headerlink" title="安全技术和防火墙"></a>安全技术和防火墙</h2><h3 id="安全技术"><a href="#安全技术" class="headerlink" title="安全技术"></a>安全技术</h3><ul>
<li>入侵检测系统</li>
<li>入侵防御系统</li>
<li>防火墙</li>
</ul>
<blockquote>
<p>防水墙<br>广泛意义上的防水墙：防水墙（Waterwall），与防火墙相对，是一种防止内部信息泄漏的安全产品。网络、外设接口、存储介质和打印机构成信息泄漏的全部途径。防水墙针对这四种泄密途径，在事前、事中、事后进行全面防护。其与防病毒产品、外部安全产品一起构成完整的网络安全体系。</p>
</blockquote>
<h3 id="防火墙的分类"><a href="#防火墙的分类" class="headerlink" title="防火墙的分类"></a>防火墙的分类</h3><p><strong>按保护范围分类：</strong></p>
<ul>
<li>主机防火墙：服务范围为当前一台主机</li>
<li>网络防火墙：服务范围为防火墙一侧的局域网</li>
</ul>
<p><strong>按实现方式划分：</strong></p>
<ul>
<li>硬件防火墙</li>
<li>软件防火墙</li>
</ul>
<p><strong>按网络协议划分：</strong></p>
<ul>
<li>网络层防火墙：OSI 模型下四层，又称为包过滤防火墙</li>
<li>应用层防火墙&#x2F;代理服务器：代理网关，OSI 模型七层</li>
</ul>
<p>现实生产环境中所使用的防火墙一般都是二者结合体，即先检查网络数据，通过之后再送到应用层去检查</p>
<h2 id="Linux-防火墙的基本认识"><a href="#Linux-防火墙的基本认识" class="headerlink" title="Linux 防火墙的基本认识"></a>Linux 防火墙的基本认识</h2><p>Linux 防火墙是由<a target="_blank" rel="noopener" href="https://netfilter.org/documentation/">Netfilter</a>组件提供的，Netfilter 工作在内核空间，集成在 linux 内核中</p>
<p>Netfilter 是 Linux 2.4.x 之后新一代的 Linux 防火墙机制，是 linux 内核的一个子系统。Netfilter 采用模块化设计，具有良好的可扩充性，提供扩展各种网络服务的结构化底层框架。Netfilter 与 IP 协议栈是无缝契合，并允许对数据报进行过滤、地址转换、处理等操作</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token parameter variable">-m</span> <span class="token number">10</span> NETFILTER /boot/config-4.18.0-193.el8.x86_64
<span class="token assign-left variable">CONFIG_NETFILTER</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_NETFILTER_ADVANCED</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_BRIDGE_NETFILTER</span><span class="token operator">=</span>m
<span class="token assign-left variable">CONFIG_NETFILTER_INGRESS</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_NETFILTER_NETLINK</span><span class="token operator">=</span>m
<span class="token assign-left variable">CONFIG_NETFILTER_FAMILY_BRIDGE</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_NETFILTER_FAMILY_ARP</span><span class="token operator">=</span>y
<span class="token comment"># CONFIG_NETFILTER_NETLINK_ACCT is not set</span>
<span class="token assign-left variable">CONFIG_NETFILTER_NETLINK_QUEUE</span><span class="token operator">=</span>m
<span class="token assign-left variable">CONFIG_NETFILTER_NETLINK_LOG</span><span class="token operator">=</span>m</code></pre>

<h3 id="防火墙工具介绍"><a href="#防火墙工具介绍" class="headerlink" title="防火墙工具介绍"></a>防火墙工具介绍</h3><ul>
<li><p>iptables：工作在用户空间，用来编写规则，写好的规则被送往 netfilter，告诉内核如何去处理包</p>
</li>
<li><p>firewalld：CentOS7 引入</p>
</li>
<li><p>nftables：CentOS 8 新特性，2013 年末合并到 Linux 内核中，自 2014 年以来已在内核 3.13 中可用。</p>
<p>它重用了 netfilter 框架的许多部分，例如连接跟踪和 NAT 功能。它还保留了命名法和基本 iptables 设计<br>的几个部分，例如表，链和规则。就像 iptables 一样，表充当链的容器，并且链包含单独的规则，这些<br>规则可以执行操作，例如丢弃数据包，移至下一个规则或跳至新链。</p>
<p>从用户的角度来看，nftables 添加了一个名为 nft 的新工具，该工具替代了 iptables，arptables 和<br>ebtables 中的所有其他工具。从体系结构的角度来看，它还替换了内核中处理数据包过滤规则集运行时<br>评估的那些部分。</p>
<p>总之：nftables 应该是未来的主流，现在 iptables 还是要重点学习，firewalld 了解即可</p>
</li>
</ul>
<h3 id="netfilter-中五个勾子函数（hook）"><a href="#netfilter-中五个勾子函数（hook）" class="headerlink" title="netfilter 中五个勾子函数（hook）"></a>netfilter 中五个勾子函数（hook）</h3><p>netfilter 在内核的五个位置放了钩子函数（hook）：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING</code></pre>

<p>提示：从 Linux kernel 4.2 版以后，Netfilter 在 prerouting 前加了一个 ingress 勾子函数。可以使用这个新的入口挂钩来过滤来自第 2 层的流量，这个新挂钩比预路由要早，基本上是 tc 命令（流量控制工具）的替代品</p>
<h3 id="iptables-的组成"><a href="#iptables-的组成" class="headerlink" title="iptables 的组成"></a>iptables 的组成</h3><p>iptables 由五张 表（table） 组成：</p>
<ul>
<li>filter 表：过滤规则表，根据预定义的规则过滤符合条件的数据包,默认表</li>
<li>nat 表：network address translation 地址转换规则表；修改数据包中的源、目标 iP 和端口</li>
<li>mangle：修改数据标记位规则表</li>
<li>raw：关闭启用的连接跟踪机制，加快封包穿越防火墙速度</li>
<li>security：用于强制访问控制（MAC）网络规则，由 Linux 安全模块（如 SELinux）实现</li>
</ul>
<p>五张表的优先级：security –&gt;raw–&gt;mangle–&gt;nat–&gt;filter，我们重点研究后面四张表</p>
<p>每张表由若干功能类似的 链（chain）组成，每条链上有若干类似的 规则（rule）</p>
<p>表不能自定义，链可以自定义，但是 iptables 也内置了 5 种链，与 5 个钩子函数同名，内置链上每条过滤规则都调用与链同名的钩子函数。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING</code></pre>

<p><strong>注意：</strong>自定义的链不能直接添加到表中，只能作为 target 添加到内置链上，间接的实现添加到表中</p>
<h4 id="内核中数据的传输流程"><a href="#内核中数据的传输流程" class="headerlink" title="内核中数据的传输流程"></a>内核中数据的传输流程</h4><p>在每个 hook 放置若干表，按照表的优先级，依次执行表内的同名链上的规则，例如 INPUT 钩子函数会依次执行 mangle、nat、filter 表中的 INPUT 链上的规则。</p>
<p>标注：红色的表示钩子函数或者内置链，黄色的表示 table</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600500456338.png"></p>
<p>显然，内置链和内置表的关系：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600505953650.png"></p>
<h4 id="netfilter-完整流程"><a href="#netfilter-完整流程" class="headerlink" title="netfilter 完整流程"></a>netfilter 完整流程</h4><p><img data-src="//img.to2b.cn/blog/ljk/1600484323103.png"></p>
<h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><p>mysql：数据库中有表，表中有一条条的数据</p>
<p>iptables：表中有链，链上有一条条的规则</p>
<h3 id="规则-rule"><a href="#规则-rule" class="headerlink" title="规则 rule"></a>规则 rule</h3><p>规则由 匹配条件 和 处理动作组成，规则在链上的顺序即其检查时生效的顺序</p>
<h4 id="匹配条件"><a href="#匹配条件" class="headerlink" title="匹配条件"></a>匹配条件</h4><ul>
<li>基本匹配：IP，端口，TCP 的 Flags（SYN,ACK 等）</li>
<li>扩展匹配：调用 netfilter 中的模块，实现各种复杂匹配</li>
</ul>
<h4 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作"></a>处理动作</h4><p>处理动作称为 target，跳转目标，分为两种：内建的处理动作 和 自定义链。</p>
<p>常用的内建处理动作：</p>
<ul>
<li><p>ACCEPT：允许数据包通过</p>
</li>
<li><p>DROP：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应</p>
</li>
<li><p>REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息</p>
</li>
<li><p>SNAT：源地址转换，解决内网用户用同一个公网地址上网的问题</p>
</li>
<li><p>MASQUERADE：是 SNAT 的一种特殊形式，适用于动态的、临时会变的 ip 上</p>
</li>
<li><p>DNAT：目标地址转换</p>
</li>
<li><p>REDIRECT：在本机做端口映射</p>
</li>
<li><p>LOG：非中断 target，本身不拒绝和允许，放在拒绝和允许规则前，并将日志记在&#x2F;var&#x2F;log&#x2F;messages 系统日志中</p>
<ul>
<li>–log-level level 级别： debug、info、notice、warning、error、crit、alert、emerg</li>
<li>–log-prefix prefix 日志前缀，用于区别不同的日志，最多 29 个字符</li>
</ul>
</li>
</ul>
<h4 id="iptables-添加规则使要考虑"><a href="#iptables-添加规则使要考虑" class="headerlink" title="iptables 添加规则使要考虑"></a>iptables 添加规则使要考虑</h4><ol>
<li>要实现哪种功能：判断添加在哪张表上</li>
<li>报文流经的路径：判断添加在哪条链上</li>
<li>报文的流向：判断源和目的</li>
<li>匹配规则：业务需要</li>
</ol>
<h3 id="iptables-命令用法"><a href="#iptables-命令用法" class="headerlink" title="iptables 命令用法"></a>iptables 命令用法</h3><pre class="language-bash" data-language="bash"><code class="language-bash">iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>-A<span class="token operator">|</span>-C<span class="token operator">|</span>-D<span class="token punctuation">&#125;</span> chain rule-specification
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-D</span> chain rulenum
ip6tables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>-A<span class="token operator">|</span>-C<span class="token operator">|</span>-D<span class="token punctuation">&#125;</span> chain rule-specification
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-I</span> chain <span class="token punctuation">[</span>rulenum<span class="token punctuation">]</span> rule-specification
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-R</span> chain rulenum rule-specification
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-S</span> <span class="token punctuation">[</span>chain <span class="token punctuation">[</span>rulenum<span class="token punctuation">]</span><span class="token punctuation">]</span>
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>-F<span class="token operator">|</span>-L<span class="token operator">|</span>-Z<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>chain <span class="token punctuation">[</span>rulenum<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-N</span> chain
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-X</span> <span class="token punctuation">[</span>chain<span class="token punctuation">]</span>
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-P</span> chain target
iptables <span class="token punctuation">[</span>-t table<span class="token punctuation">]</span> <span class="token parameter variable">-E</span> old-chain-name new-chain-name

<span class="token comment"># 补充说明</span>
rule-specification <span class="token operator">=</span> <span class="token punctuation">[</span>matches<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>target<span class="token punctuation">]</span>
match <span class="token operator">=</span> <span class="token parameter variable">-m</span> matchname <span class="token punctuation">[</span>per-match-options<span class="token punctuation">]</span>
target <span class="token operator">=</span> <span class="token parameter variable">-j</span> targetname <span class="token punctuation">[</span>per-target-options<span class="token punctuation">]</span></code></pre>

<ul>
<li><p>-t：指定表，默认 filter 表</p>
</li>
<li><p>-A：以 append 的方式添加 rule，iptables 添加 rule 后会立马生效</p>
</li>
<li><p>-I：以 insert 的方式添加 rule</p>
</li>
<li><p>-C：检查 rule 是否存在</p>
</li>
<li><p>-D ：删除 rule，可以通过 指明规则序号 或 指明规则本身 两种方式</p>
</li>
<li><p>-R：replace，替换指定链上的指定规则编号</p>
</li>
<li><p>-S：打印指定链上的所有 rule，不指定链则打印表中所有 rule</p>
</li>
<li><p>-L：list, 列出指定链上的所有规则，不指定链则列出表中所有 rule</p>
</li>
<li><p>-F：flush，清空指定的链</p>
</li>
<li><p>-Z：zero，置零。每条 rule 都有两个计数器</p>
<ul>
<li>匹配到的报文数</li>
<li>匹配到的所有报文的大小之和</li>
</ul>
</li>
<li><p>-N：new, 自定义一条新的链</p>
</li>
<li><p>-X：delete，删除自定义的空的链</p>
</li>
<li><p>-P：Policy，设置默认策略；对 filter 表中的链而言，其默认策略有：ACCEPT：接受, DROP：丢弃</p>
</li>
<li><p>-E：重命名自定义链，引用计数不为 0 的自定义链不能够被重命名，也不能被删除</p>
</li>
</ul>
<p>参数：</p>
<ul>
<li>-m：match</li>
<li>-j：jump target</li>
</ul>
<p>其他选项：</p>
<ul>
<li>-v：verbose，显示更详细的信息</li>
<li>-n：numeric，数字输出。IP 地址和端口会以数字的形式打印</li>
<li>-w：</li>
<li>-W：</li>
<li>-x：扩展数字。显示包和字节计数器的精确值，代替用 K,M,G 表示的约数。 这个选项仅能用于 -L 命令。</li>
<li><code>--line-numbers</code>：当列表显示规则时，在每个规则的前面加上行号，与该规则在链中的位置相对应，这个常用</li>
<li>–modprobe&#x3D;command：</li>
</ul>
<h3 id="iptables-基本匹配条件"><a href="#iptables-基本匹配条件" class="headerlink" title="iptables 基本匹配条件"></a>iptables 基本匹配条件</h3><p><font color=red>注意：当一条规则中有多个匹配条件时，这多个匹配条件之间，默认存在”与”的关系。</font>也就是说当一条规则中存在多个匹配条件时，报文必须同时满足这些条件，才算做被规则匹配</p>
<p>无需加载模块，由 iptables&#x2F;netfilter 自行提供，! 是取反的意思</p>
<table>
<thead>
<tr>
<th>基本匹配条件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>[!] -s address[&#x2F;mask][,…]</td>
<td>源地址</td>
</tr>
<tr>
<td>[!] -d address[&#x2F;mask][,…]</td>
<td>目标地址</td>
</tr>
<tr>
<td>[!] -p protocol</td>
<td>指定协议，tcp、udp、icmp 等，可以指定哪些协议参考&#x2F;etc&#x2F;protocols，<br/>还可以使用数字 0，相当于 all，匹配所有协议</td>
</tr>
<tr>
<td>[!] -i inter_name</td>
<td>in interface，报文流入的接口；只能应用于数据报文流入环节，<br/>只应用于 INPUT、FORWARD、PREROUTING 链</td>
</tr>
<tr>
<td>[!] -o inter_name</td>
<td>out interface，报文流出的接口；只能应用于数据报文流出的环节，<br/>只应用于 FORWARD、OUTPUT、POSTROUTING 链</td>
</tr>
</tbody></table>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加规则，并指定规则号：禁止10.0.0.6的ping请求</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#iptables -I INPUT 2 -s 10.0.0.6 -p icmp -j REJECT</span></code></pre>

<h3 id="iptables-扩展匹配条件"><a href="#iptables-扩展匹配条件" class="headerlink" title="iptables 扩展匹配条件"></a>iptables 扩展匹配条件</h3><p>需要加载扩展模块（&#x2F;usr&#x2F;lib64&#x2F;xtables&#x2F;*）方可生效，扩展模块可以使用 man 命令查看，扩展匹配条件分为 隐式扩展 和 显式扩展</p>
<h4 id="隐式扩展"><a href="#隐式扩展" class="headerlink" title="隐式扩展"></a>隐式扩展</h4><p>iptables 在使用 -p 指定了特定协议时，可以省略协议同名扩展，直接写扩展匹配条件即可，这类扩展就是隐式扩展，例如 tcp、udp、icmp</p>
<h5 id="tcp-扩展模块-匹配条件"><a href="#tcp-扩展模块-匹配条件" class="headerlink" title="tcp 扩展模块 匹配条件"></a>tcp 扩展模块 匹配条件</h5><ul>
<li><p>[!] –sport port[:port]：匹配 tcp 报文的源端口或端口范围</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 范例：</span>
iptables <span class="token parameter variable">-t</span> filter <span class="token parameter variable">-I</span> OUTPUT <span class="token parameter variable">-d</span> <span class="token number">192.168</span>.1.146 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--sport</span> <span class="token number">22</span>:25 <span class="token parameter variable">-j</span> REJECT</code></pre>
</li>
<li><p>[!] –dport port[:port]：匹配 tcp 报文的目标端口或端口范围</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 范例</span>
iptables <span class="token parameter variable">-t</span> filter <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.1.146 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">22</span>:25 <span class="token parameter variable">-j</span> REJECT</code></pre>
</li>
<li><p>[!] –tcp-flags mask comp：</p>
<ul>
<li>mask： 需检查的标志位列表，用,分隔 , 例如 SYN,ACK,FIN,RST</li>
<li>comp：在 mask 列表中必须为 1 的标志位列表，无指定则必须为 0，用,分隔 tcp 协议的扩展选项</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 范例：</span>
<span class="token comment"># 要检查的标志位为SYN,ACK,FIN,RST四个，其中SYN必须为1，余下的必须为0，第一次握手</span>
--tcp-flags SYN,ACK,FIN,RST SYN
<span class="token comment"># 以上写法可以简写</span>
 <span class="token parameter variable">--syn</span></code></pre></li>
</ul>
<h5 id="udp-扩展模块-匹配条件"><a href="#udp-扩展模块-匹配条件" class="headerlink" title="udp 扩展模块 匹配条件"></a>udp 扩展模块 匹配条件</h5><ul>
<li>[!] –sport port[:port]：匹配报文的源端口或端口范围</li>
<li>[!] –dport port[:port]：匹配报文的目标端口或端口范围</li>
</ul>
<h5 id="icmp-扩展模块-匹配条件"><a href="#icmp-扩展模块-匹配条件" class="headerlink" title="icmp 扩展模块 匹配条件"></a>icmp 扩展模块 匹配条件</h5><ul>
<li>[!] –icmp-type {type[&#x2F;code]|typename}：<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/itcomputer/p/4939399.html">type&#x2F;code</a><ul>
<li>0&#x2F;0 echo-reply icmp 应答</li>
<li>8&#x2F;0 echo-request icmp 请求</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 范例：不允许其他人ping我，而我可以ping其他人</span>
iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> icmp <span class="token parameter variable">-m</span> icmp --icmp-type <span class="token number">8</span> <span class="token parameter variable">-j</span> REJECT</code></pre>

<h4 id="显式扩展"><a href="#显式扩展" class="headerlink" title="显式扩展"></a>显式扩展</h4><p>必须使用-m 指定使用的扩展，下面是常用的显式扩展：</p>
<h5 id="multiport-扩展-匹配条件"><a href="#multiport-扩展-匹配条件" class="headerlink" title="multiport 扩展 匹配条件"></a>multiport 扩展 匹配条件</h5><p>以离散方式定义多端口匹配,最多指定 15 个端口</p>
<ul>
<li>[!] –sports port[,port|,port:port]…：指定多个源端口</li>
<li>[!] –dports port[,port|,port:port]…：指定多个目标端口</li>
<li>[!] –ports port[,port|,port:port]…：指定多个源或目标端口</li>
</ul>
<h5 id="iprange-扩展-匹配条件"><a href="#iprange-扩展-匹配条件" class="headerlink" title="iprange 扩展 匹配条件"></a>iprange 扩展 匹配条件</h5><p>指明连续的（但一般不是整个网络）ip 地址范围</p>
<ul>
<li>[!] –src-range from[-to] 源 IP 地址范围</li>
<li>[!] –dst-range from[-to] 目标 IP 地址范围</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 范例</span>
iptables <span class="token parameter variable">-t</span> filter <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-m</span> iprange --src-range <span class="token number">192.168</span>.1.127-192.168.1.146 <span class="token parameter variable">-j</span> DROP</code></pre>

<h5 id="mac-扩展-匹配条件"><a href="#mac-扩展-匹配条件" class="headerlink" title="mac 扩展 匹配条件"></a>mac 扩展 匹配条件</h5><p>指定源 MAC 地址,，适用于：PREROUTING, FORWARD，INPUT chains<br>注意不能指定目标 MAC 地址，因为无法指定，也没有意义</p>
<ul>
<li>[!] –mac-source XX:XX:XX:XX:XX:XX</li>
</ul>
<h5 id="string-扩展-匹配条件"><a href="#string-扩展-匹配条件" class="headerlink" title="string 扩展 匹配条件"></a>string 扩展 匹配条件</h5><p>对报文中的应用层数据做字符串模式匹配检测</p>
<ul>
<li>–algo {bm|kmp}：字符串匹配算法</li>
<li>–from offset：开始偏移</li>
<li>–to offset：结束偏移</li>
<li>[!] –string pattern：模式匹配要检测的字符串</li>
<li>[!] –hex-string pattern：模式匹配要检测的字符串，16 进制格式</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 范例</span>
iptables <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--sport</span> <span class="token number">80</span> <span class="token parameter variable">-m</span> string <span class="token parameter variable">--algo</span> bm <span class="token parameter variable">--from</span> <span class="token number">62</span> <span class="token parameter variable">--string</span> <span class="token string">"google"</span> <span class="token parameter variable">-j</span> REJECT</code></pre>

<h5 id="time-扩展-匹配条件"><a href="#time-扩展-匹配条件" class="headerlink" title="time 扩展 匹配条件"></a>time 扩展 匹配条件</h5><p>注意：CentOS 8 此模块有问题</p>
<p>根据将报文到达的时间与指定的时间范围进行匹配</p>
<ul>
<li>–datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] 日期</li>
<li>–datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</li>
<li>–timestart hh:mm[:ss] 时间</li>
<li>–timestop hh:mm[:ss]</li>
<li>[!] –monthdays day[,day…] 每个月的几号</li>
<li>[!] –weekdays day[,day…] 星期几，1 – 7 分别表示星期一到星期日</li>
<li>–kerneltz：内核时区（当地时间），非常不建议使用</li>
</ul>
<h5 id="connlimit-扩展-匹配条件"><a href="#connlimit-扩展-匹配条件" class="headerlink" title="connlimit 扩展 匹配条件"></a>connlimit 扩展 匹配条件</h5><p>对每 IP 所能够发起并发连接数做限制；可防止 Dos（Denial of Service，拒绝服务）攻击</p>
<ul>
<li>–connlimit-upto N：连接的数量小于等于 N 时匹配</li>
<li>–connlimit-above N：连接的数量大于 N 时匹配</li>
</ul>
<h5 id="limit-扩展-匹配条件"><a href="#limit-扩展-匹配条件" class="headerlink" title="limit 扩展 匹配条件"></a><a target="_blank" rel="noopener" href="https://www.zsythink.net/archives/1564">limit 扩展 匹配条件</a></h5><p>”令牌桶“算法，对 报文到达速率 进行限制，即限制单位时间内流入的包的数量</p>
<p>–limit-burst N：前 N 个包不限制，</p>
<p>–limit N[&#x2F;second|&#x2F;minute|&#x2F;hour|&#x2F;day]：单位时间内通过 N 个包</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 范例：下面两条规则配合使用，限制每分钟ping10次，即每6秒ping一次</span>
iptables <span class="token parameter variable">-t</span> filter <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-p</span> icmp <span class="token parameter variable">-m</span> limit --limit-burst <span class="token number">3</span> <span class="token parameter variable">--limit</span> <span class="token number">10</span>/minute <span class="token parameter variable">-j</span> ACCEPT
iptables <span class="token parameter variable">-t</span> filter <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> icmp <span class="token parameter variable">-j</span> REJECT</code></pre>

<h5 id="state-扩展-匹配条件"><a href="#state-扩展-匹配条件" class="headerlink" title="state 扩展 匹配条件"></a>state 扩展 匹配条件</h5><p>state 直译为 状态，state 模块可以让 iptables 实现”连接追踪“机制，英文名是 conntrack 机制。<br>简单说就是追踪本机的请求和相应之间的状态。</p>
<p>state 扩展实现“连接追踪”需要依赖 nf_conntrack_ipv4 等内核模块，可以通过 modprobe 命令手动把所需内核模块加载到内存中，但实际上没有这个必要，因为 iptables 会自动加载所需内核模块</p>
<p>state 模块有 5 中状态：<strong>NEW、ESTABLISHED、RELATED、INVALID、UNTRACKED</strong></p>
<ul>
<li>NEW：新发出请求；只要连接追踪信息库（&#x2F;proc&#x2F;net&#x2F;nf_conntrack）中不存在此连接的相关信息条目，就识别为第一次发出的请求</li>
<li>ESTABLISHED：NEW 状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态</li>
<li>RELATED：新发起的但与已有连接相关联的连接，如：ftp 协议中的数据连接与命令连接之间的关系</li>
<li>INVALID：无效的连接，如 flag 标记不正确</li>
<li>UNTRACKED：未进行追踪的连接，如：raw 表中关闭追踪</li>
</ul>
<p>注意：state 模块的状态和 TCP 的状态没有关系，对于 state 模块而言，只要两台机器在”你来我往”的通信，就算建立起了连接。所以在 TCP&#x2F;IP 协议中，UDP 和 ICMP 是没有连接状态的，而在 state 模块中，所有的协议都是有连接状态的</p>
<p><strong>查看连接追踪信息库：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /proc/net/nf_conntrack</code></pre>

<p><strong>调整连接追踪功能所能够容纳的最大连接数量：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用sysctl修改</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /proc/sys/net/netfilter/nf_conntrack_max
<span class="token number">65536</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /proc/sys/net/nf_conntrack_max
<span class="token number">65536</span></code></pre>

<p><strong>查看目前连接跟踪有多少条目：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /proc/sys/net/netfilter/nf_conntrack_count
<span class="token number">28</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /proc/net/nf_conntrack <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
<span class="token number">28</span></code></pre>

<p><strong>不同的协议的连接追踪时长：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$ll</span> /proc/sys/net/netfilter/ <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">timeout</span></code></pre>

<p><strong>说明：</strong></p>
<ul>
<li>当服务器连接多于最大连接数时，报错 ：<code>kernel: ip_conntrack: table full, dropping packet</code>,并且导致建立 TCP 连接很慢</li>
<li>各种状态超时后，链接会从表中删除</li>
</ul>
<p>连接过多的解决方法有两个：</p>
<ol>
<li><p>加大 nf_conntrack_max 值</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /etc/sysctl.conf
net.nf_conntrack_max <span class="token operator">=</span> <span class="token number">393216</span>
net.netfilter.nf_conntrack_max <span class="token operator">=</span> <span class="token number">393216</span></code></pre>
</li>
<li><p>降低 tcp 各种状态的超时时间</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /etc/sysctl.conf
net.netfilter.nf_conntrack_tcp_timeout_established <span class="token operator">=</span> <span class="token number">300</span>
net.netfilter.nf_conntrack_tcp_timeout_time_wait <span class="token operator">=</span> <span class="token number">120</span>
net.netfilter.nf_conntrack_tcp_timeout_close_wait <span class="token operator">=</span> <span class="token number">60</span>
net.netfilter.nf_conntrack_tcp_timeout_fin_wait <span class="token operator">=</span> <span class="token number">120</span>

iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-nvL</span></code></pre></li>
</ol>
<h6 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h6><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> <span class="token parameter variable">--state</span> state,state<span class="token punctuation">..</span>.</code></pre>

<p>范例：不允许 10.0.0.79 访问本机，但是本机能访问 10.0.0.79</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$iptables</span> <span class="token parameter variable">-t</span> filter <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> ESTABLISHED <span class="token parameter variable">-j</span> ACCEPT
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$iptables</span> <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.0.79 <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> NEW <span class="token parameter variable">-j</span> REJECT</code></pre>

<h3 id="rule-优化"><a href="#rule-优化" class="headerlink" title="rule 优化"></a>rule 优化</h3><ol>
<li><p>安全放行所有入站和出站的状态为 ESTABLISHED 状态连接,建议放在第一条，效率更高</p>
</li>
<li><p>谨慎放行入站的新请求</p>
</li>
<li><p>有特殊目的限制访问功能，要在放行规则之前加以拒绝</p>
</li>
<li><p>同类规则（访问同一应用，比如：http ），匹配范围小的放在前面，用于特殊处理</p>
</li>
<li><p>不同类的规则（访问不同应用，一个是 http，另一个是 mysql ），匹配范围大的放在前面，效率更高</p>
</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-s</span> <span class="token number">10.0</span>.0.6 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">3306</span> <span class="token parameter variable">-j</span> REJECT
<span class="token parameter variable">-s</span> <span class="token number">172.16</span>.0.0/16 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> REJECT</code></pre>

<ol start="6">
<li><p>应该将那些可由一条规则能够描述的多个规则合并为一条,减少规则数量,提高检查效率</p>
</li>
<li><p>设置默认策略，建议白名单（只放行特定连接）</p>
</li>
<li><p>iptables -P，不建议，容易出现“自杀现象”</p>
</li>
<li><p>规则的最后定义规则做为默认策略，推荐使用，放在最后一条</p>
</li>
</ol>
<h3 id="rule-保存"><a href="#rule-保存" class="headerlink" title="rule 保存"></a>rule 保存</h3><p>使用 iptables 命令定义的规则，，其生效期限为 kernel 存活期限，即重启失效</p>
<p><strong>持久保存规则：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># CentOS6 将规则覆盖保存至/etc/sysconfig/iptables文件中</span>
<span class="token function">service</span> iptables save

<span class="token comment"># CentOS7、8</span>
iptables-save <span class="token operator">></span> <span class="token function">file</span></code></pre>

<p><strong>加载规则：</strong></p>
<p>CentOS6 自动从&#x2F;etc&#x2F;sysconfig&#x2F;iptables 重新载入规则</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> iptables restart</code></pre>

<p>CentOS7、8</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">iptables-restore <span class="token operator">&lt;</span> <span class="token function">file</span></code></pre>

<ul>
<li>-n：noflush，清除原有规则</li>
<li>-t：–test，仅分析生成规则集，但不提交</li>
</ul>
<p><strong>开机自动重载规则</strong></p>
<p>CentOS6 只要设置 iptables 开机自启，然后关机前使用保存规则即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chkconfig</span> iptables on
<span class="token function">service</span> iptables save		<span class="token comment"># 注意：如果不保存，关机就没了</span></code></pre>

<p>CentOS7、8 有两种方式</p>
<p>方法一：将自动载入规则的命令写入开机自启脚本&#x2F;etc&#x2F;rc.d&#x2F;rc.local 文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将自动载入规则的命令写入开机自启脚本/etc/rc.d/rc.local文件</span>
<span class="token function">vim</span> /etc/rc.d/rc.local
iptables-restore <span class="token operator">&lt;</span> /<span class="token environment constant">PATH</span>/FROM/IPTABLES_RULES_FILE

<span class="token comment"># 关机前保存规则</span>
iptables-save <span class="token operator">></span> /etc/sysconfig/iptables</code></pre>

<p>方法二：使用 iptables-services</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装软件</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#yum -y install iptables-services</span>

<span class="token comment"># 设置开机启动</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#systemctl enable iptables.service</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#systemctl mask firewalld.service nftables.service</span>

<span class="token comment"># 保存规则到文件，iptables.init 来自 iptables-services</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span>$/usr/libexec/iptables/iptables.init save
iptables: Saving firewall rules to /etc/sysconfig/iptables:<span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
<span class="token comment"># 或者</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$iptables</span>-save <span class="token operator">></span> /etc/sysconfig/iptables</code></pre>

<h3 id="网络防火墙"><a href="#网络防火墙" class="headerlink" title="网络防火墙"></a>网络防火墙</h3><h4 id="FORWARD"><a href="#FORWARD" class="headerlink" title="FORWARD"></a>FORWARD</h4><p>利用 filter 表的 FORWARD 链,可以充当网络防火墙</p>
<ol>
<li>请求 - 响应报文均会经由 FORWARD 链，要注意规则的方向性</li>
<li>如果要启用 conntrack 机制，建议将双方状态为 ESTABLISHED 的报文直接放行</li>
</ol>
<p>[实验：FORWARD 链实现内外网络的流量控制](16.1 实验 FORWARD 链实现内外网络的流量控制.md)</p>
<h4 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a><a target="_blank" rel="noopener" href="http://www.zsythink.net/archives/1764">NAT</a></h4><p>客户机和服务器都在局域网中，躲在防火墙后面，通过路由器连接网络。</p>
<p>NAT 是地址转换表，表中规则的常用 target：</p>
<ul>
<li>SNAT：负责将局域网 IP 转成公网 IP，S 是源地址的意思，适用于固定的公网 IP</li>
<li>MASQUERADE：相较与 SNAT，MASQUERADE 适用于动态的公网 IP，如：拨号网络</li>
<li>DNAT：负责将公网 IP 转成局域网 IP，D 是目标地址的意思；</li>
<li>REDIRECT：</li>
</ul>
<p>这么说有些抽象，我们看下面的例子：</p>
<h5 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h5><p>我本机的 IP 是 172.16.135.189&#x2F;16，对外的公网 IP 是 39.164.140.134，当我访问互联网中的网站时，防火墙负责将 172.16.135.189 转成 39.164.140.134，等返回数据的时候，再把 39.164.140.134 转成 172.16.135.189。</p>
<p>有一个问题，局域网中的 ip 成百上千，大家对外的公网 IP 却都是 39.164.140.134，如果多台主机同时访问同一网站，路由器是如何做到准确的转发消息呢？<br>答案是对目标 IP 相同的请求分别绑定不同的端口号，例如 PC1 和 PC2 两台主机同时访问网站 <a href="http://lujinkai.cn，防火墙会把PC1的IP转成39.164.140.134:1234，把PC2的IP转成39.164.140.134:2345（1234和2345是随便写的，只要两个端口不一样就行）">http://lujinkai.cn，防火墙会把PC1的IP转成39.164.140.134:1234，把PC2的IP转成39.164.140.134:2345（1234和2345是随便写的，只要两个端口不一样就行）</a></p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">172.16</span>.0.0/16 <span class="token parameter variable">-j</span> SNAT --to-source <span class="token number">39.164</span>.140.134</code></pre>

<ul>
<li>–to-source：将报文的源 IP 修改为公网 IP</li>
</ul>
<p>SNAT 中隐含了另一个技术：PNAT，即自动分配端口，只不过我们不单独说它。</p>
<h5 id="MASQUERADE"><a href="#MASQUERADE" class="headerlink" title="MASQUERADE"></a>MASQUERADE</h5><p>如果家里拨号上网，外网 IP 不固定，可以使用 MASQUERADE</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.1.0/24 <span class="token parameter variable">-j</span> MASQUERADE</code></pre>

<p>可以把 MASQUERADE 理解为动态的、自动化的 SNAT，如果没有动态 SNAT 的需求，没有必要使 MASQUERADE，因为 SNAT 更加高效。</p>
<h5 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h5><p><a target="_blank" rel="noopener" href="http://lujinkai.cn/">http://lujinkai.cn</a> 网站的 IP 是 47.105.171.233，这个公网 IP 的后面可能是一台服务器，也可能是服务器集群，总之无论有多少服务器，防火墙外的人看不出来。当我访问去访问网站时，阿里云的防火墙会将 39.164.140.134 转成局域网 IP，然后将请求转发到真实的服务器。</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$iptables</span> <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-d</span> <span class="token number">192.168</span>.248.2 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">10.0</span>.0.175:80</code></pre>

<ul>
<li>–to-destination：将报文的目标地址修改为内网 IP，并指定端口号</li>
</ul>
<h5 id="REDIRECT"><a href="#REDIRECT" class="headerlink" title="REDIRECT"></a>REDIRECT</h5><p>DNAT 可以对 IP 和端口进行映射，REDIRECT 只能应用在本机，对本机的端口进行映射，比如将本机的 80 端口映射到 8080 端口上，当别的机器访问本机的 80 端口时，报文会被重定向到本机的 8080 端口上，此时本机只需要监听 8080 端口，不需要监听 80 端口</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> REDIRECT --to-ports <span class="token number">8080</span></code></pre>

<ul>
<li>–to-ports：端口转换</li>
</ul>
<p>REDIRECT 规则只能定义在 PREROUTING 链或者 OUTPUT 链中</p>
<h2 id="firewalld-服务"><a href="#firewalld-服务" class="headerlink" title="firewalld 服务"></a>firewalld 服务</h2><p>CentOS6 不支持 firewalld，CentOS8 支持 firewalld，但是官方推荐使用 ntf，所有 firewalld 了解即可。</p>
<p>在 iptables 的基础上，预定义了一些链（zone）和服务，以下以 CentOS7 中的 firewalld 为例：</p>
<h3 id="zone"><a href="#zone" class="headerlink" title="zone"></a>zone</h3><table>
<thead>
<tr>
<th>zone 名称</th>
<th>默认配置</th>
</tr>
</thead>
<tbody><tr>
<td>trusted</td>
<td>允许所有流量</td>
</tr>
<tr>
<td>home</td>
<td>拒绝除和传出流量相关的，以及 ssh,mdsn,ipp-client,samba-client,dhcpv6-client 预定义服务之外其它所有传入流量</td>
</tr>
<tr>
<td>internal</td>
<td>和 home 相同</td>
</tr>
<tr>
<td>work</td>
<td>拒绝除和传出流量相关的，以及 ssh,ipp-client,dhcpv6-client 预定义服务之外的其它所有传入流量</td>
</tr>
<tr>
<td>public</td>
<td>拒绝除和传出流量相关的，以及 ssh,dhcpv6-client 预定义服务之外的其它所有传入流量，新加的网卡默认属于 public zone</td>
</tr>
<tr>
<td>external</td>
<td>拒绝除和传出流量相关的，以及 ssh 预定义服务之外的其它所有传入流量，属于 external zone 的传出 ipv4 流量的源地址将被伪装为传出网卡的地址。</td>
</tr>
<tr>
<td>dmz</td>
<td>拒绝除和传出流量相关的，以及 ssh 预定义服务之外的其它所有传入流量</td>
</tr>
<tr>
<td>block</td>
<td>拒绝除和传出流量相关的所有传入流量</td>
</tr>
<tr>
<td>drop</td>
<td>拒绝除和传出流量相关的所有传入流量（甚至不以 ICMP 错误进行回应）</td>
</tr>
</tbody></table>
<h3 id="firewall-cmd"><a href="#firewall-cmd" class="headerlink" title="firewall-cmd"></a>firewall-cmd</h3><p>firewall-cmd 是 firewalld 的命令行工具。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">firewall-cmd <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<p>常见选项：</p>
<ul>
<li>–get-zones：列出所有可用区域</li>
<li>–get-default-zone：查询默认区域</li>
<li>–set-default-zone&#x3D;<ZONE> ：设置默认区域</li>
<li>–get-active-zones：列出当前正使用的区域</li>
<li>–add-source&#x3D;<CIDR>[–zone&#x3D;<ZONE>]：添加源地址的流量到指定区域，如果无–zone&#x3D; 选项，使用默认区域</li>
<li>–remove-source&#x3D;<CIDR> [–zone&#x3D;<ZONE>]：从指定区域删除源地址的流量，如无–zone&#x3D; 选项，使用默认区域</li>
<li>–add-interface&#x3D;<INTERFACE>[–zone&#x3D;<ZONE>]：添加来自于指定接口的流量到特定区域，如果无–zone&#x3D; 选项，使用默认区域</li>
<li>–change-interface&#x3D;<INTERFACE>[–zone&#x3D;<ZONE>]：改变指定接口至新的区域，如果无–zone&#x3D;选项，使用默认区域</li>
<li>–add-service&#x3D;<SERVICE> [–zone&#x3D;<ZONE>]：允许服务的流量通过，如果无–zone&#x3D; 选项，使用默认区域</li>
<li>–add-port&#x3D;&lt;PORT&#x2F;PROTOCOL&gt;[–zone&#x3D;<ZONE>]：允许指定端口和协议的流量，如果无–zone&#x3D; 选项，使用默认区域</li>
<li>–remove-service&#x3D;<SERVICE> [–zone&#x3D;<ZONE>]：从区域中删除指定服务，禁止该服务流量，如果无–zone&#x3D; 选项，使用默认区域</li>
<li>–remove-port&#x3D;&lt;PORT&#x2F;PROTOCOL&gt;[–zone&#x3D;<ZONE>]：从区域中删除指定端口和协议，禁止该端口的流量，如果无–zone&#x3D; 选项，使用默认区域</li>
<li>–reload：删除当前运行时配置，应用加载永久配置</li>
<li>–list-services：查看开放的服务</li>
<li>–list-ports：查看开放的端口</li>
<li>–list-all [–zone&#x3D;<ZONE>]：列出指定区域的所有配置信息，包括接口，源地址，端口，服务等，如果无–zone&#x3D; 选项，使用默认区域</li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看默认zone</span>
firewall-cmd --get-default-zone
<span class="token comment">#默认zone设为dmz</span>
firewall-cmd --set-default-zone<span class="token operator">=</span>dmz
<span class="token comment">#在internal zone中增加源地址192.168.0.0/24的永久规则</span>
firewall-cmd <span class="token parameter variable">--permanent</span> <span class="token parameter variable">--zone</span><span class="token operator">=</span>internal --add-source<span class="token operator">=</span><span class="token number">192.168</span>.0.0/24
<span class="token comment">#在internal zone中增加协议mysql的永久规则</span>
firewall-cmd <span class="token parameter variable">--permanent</span> <span class="token parameter variable">--zone</span><span class="token operator">=</span>internal --add-service<span class="token operator">=</span>mysql
<span class="token comment">#加载新规则以生效</span>
firewall-cmd <span class="token parameter variable">--reload</span></code></pre>

<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/system-config-kickstart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/system-config-kickstart/" class="post-title-link" itemprop="url">system-config-kickstart</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:09:30" itemprop="dateCreated datePublished" datetime="2020-12-09T23:09:30+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">运维自动化</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">系统部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>如果是 SecureCRT，需要安装 Xming：<a target="_blank" rel="noopener" href="https://nchc.dl.sourceforge.net/project/xming/Xming/6.9.0.31/Xming-6-9-0-31-setup.exe">下载地址</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605603235299.png"></p>
<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605604297828.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌────────────────────────────────────────────────────────┐
│<span class="token comment">#Basic Configuration</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment">#platform=x86, AMD64, or Intel EM64T</span>
│<span class="token comment">#Default Language默认语言</span>
│lang en_US
│<span class="token comment"># Keyboard 键盘</span>
│keyboard <span class="token string">'us'</span>
│<span class="token comment"># timezone 时区(勾选了"Use UTC clock" 会追加[--isUtc])</span>
│timezone Asia/Shanghai
│<span class="token comment"># Root password</span>
│rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$1</span><span class="token variable">$DBk7xfJp</span><span class="token variable">$Agxd303XUAfRKIf7gB8DG</span>/
└──────────────────────────────────────────────────────────┘
┌────────────────────────────────────────────────────────┐
│<span class="token comment">#Advanced Configuration</span>
│勾选就有，不勾没有
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment"># Reboot after installation</span>
│reboot
│<span class="token comment"># Use text mode install</span>
│text
└────────────────────────────────────────────────────────┘</code></pre>

<h2 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605604995204.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌────────────────────────────────────────────────────────┐
│<span class="token comment">#Installation Method</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment"># Install OS instead of upgrade</span>
│install
│<span class="token comment"># Upgrade existing installation</span>
│upgrade
└────────────────────────────────────────────────────────┘
┌────────────────────────────────────────────────────────┐
│<span class="token comment">#Installation source</span>
│选了哪项就写哪项
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment"># Use CDROM installation media</span>
│cdrom
│<span class="token comment"># Use NFS installation media</span>
│nfs <span class="token parameter variable">--server</span><span class="token operator">=</span>服务器 <span class="token parameter variable">--dir</span><span class="token operator">=</span>目录
│<span class="token comment"># Use network installation</span>
│url <span class="token parameter variable">--url</span><span class="token operator">=</span><span class="token string">"ftp://用户名:密码@服务器/目录"</span>
│<span class="token comment"># Use network installation</span>
│url <span class="token parameter variable">--url</span><span class="token operator">=</span><span class="token string">"http://服务器/目录"</span>
│<span class="token comment"># Use hard drive installation media</span>
│harddrive <span class="token parameter variable">--dir</span><span class="token operator">=</span>目录 <span class="token parameter variable">--partition</span><span class="token operator">=</span>分区└────────────────────────────────────────────────────────┘</code></pre>

<h2 id="引导选项"><a href="#引导选项" class="headerlink" title="引导选项"></a>引导选项</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605605007045.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌────────────────────────────────────────────────────────────────┐
│<span class="token comment">#Installation Method&amp;GRUB options&amp;Install Options</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
│ ┌────────────────────────────────────┐
│ │ 选择了Do not <span class="token function">install</span> a boot loader │
│ └────────────────────────────────────┘
│ <span class="token comment"># System bootloader configuration</span>
│ bootloader <span class="token parameter variable">--location</span><span class="token operator">=</span>none
│
│ ┌────────────────────────────────────┐
│ │ 选择了install new boot loader │
│ └────────────────────────────────────┘
│ bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">"ker"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token string">"123"</span>
│<span class="token comment">#append是内核参数，location是bootloader安装位置，password是GRUB密码</span>
└────────────────────────────────────────────────────────────────┘</code></pre>

<h2 id="分区信息"><a href="#分区信息" class="headerlink" title="分区信息"></a>分区信息</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605605013325.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌─────────────────────────────────────────────────────┐
│<span class="token comment"># Master Boot Record</span>
│<span class="token comment">#Master Boot Record选择了clear... 否则就没有</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment"># Clear the Master Boot Record</span>
│zerombr
└─────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────┐
│<span class="token comment"># Partitions&amp;Disk Label</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment"># Partition clearing information</span>
│clearpart <span class="token parameter variable">--linux</span> <span class="token parameter variable">--initlabel</span>
└─────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────┐
│<span class="token comment"># Layout 分区</span>
│part 挂载点 <span class="token parameter variable">--fstype</span><span class="token operator">=</span>文件系统 <span class="token parameter variable">--size</span><span class="token operator">=</span>大小<span class="token punctuation">(</span>单位M<span class="token punctuation">)</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment"># Disk partitioning information</span>
│part / <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"xfs"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">10240</span>
│part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1024</span>
│part swap <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"swap"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">2048</span>
└─────────────────────────────────────────────────────┘</code></pre>

<h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605605017757.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌─────────────────────────────────────────────────────┐
│<span class="token comment"># Network Configuration</span>
│Centos7如果要写eth0,要加内核参数net.ifnames<span class="token operator">=</span><span class="token number">0</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
│<span class="token comment"># Network information</span>
│network <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0
└─────────────────────────────────────────────────────┘</code></pre>

<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605605021748.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌───────────────────────────────────────────────────────────────┐
│<span class="token comment"># Authentication</span>
│如果勾选Enable Fingerprint reader则追加参数 <span class="token parameter variable">--enablefingerprint</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
│<span class="token comment"># System authorization information</span>
│auth <span class="token parameter variable">--useshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>md5
└───────────────────────────────────────────────────────────────┘</code></pre>

<h2 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605605025941.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌───────────────────────────────────────────────────────────────┐
│<span class="token comment"># Firewall Configuration</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
│<span class="token comment"># SELinux configuration</span>
│selinux --disabled或permissive或enforcing
│
│<span class="token comment"># Firewall configuration</span>
│firewall --disabled或enabled
│<span class="token comment">#如果是enable,可以在追加：--http --ftp --telnet --smtp --ssh</span>
│<span class="token comment">#还可以追加端口：--port=555:tcp,444:udp</span>
└───────────────────────────────────────────────────────────────┘</code></pre>

<h2 id="Display-Configuration"><a href="#Display-Configuration" class="headerlink" title="Display Configuration"></a>Display Configuration</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605605030028.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">┌───────────────────────────────────────────────────────────────┐
│<span class="token comment"># Display Configuration</span>
│<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
│如果选了安装图形界面，就没有下面这句话
│<span class="token comment"># Do not configure the X Window System</span>
│skipx
│<span class="token comment"># Run the Setup Agent on first boot</span>
│firstboot --enable或disable
└───────────────────────────────────────────────────────────────┘</code></pre>

<h2 id="Package-Selection"><a href="#Package-Selection" class="headerlink" title="Package Selection"></a>Package Selection</h2><p><img data-src="//img.to2b.cn/blog/ljk/1605605033940.png"></p>
<p>如果包安装的界面不出现可选的包信息，那么需要修改 yum 仓库配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/yum.repos.d/***.repo</span>
<span class="token punctuation">[</span>development<span class="token punctuation">]</span>
<span class="token comment">#把原来"[]"内的内容改成development，其它不变</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/CentOS6%E3%80%817%E3%80%818kickstart%E5%BA%94%E7%AD%94%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/CentOS6%E3%80%817%E3%80%818kickstart%E5%BA%94%E7%AD%94%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">CentOS6、7、8kickstart应答文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:08:52" itemprop="dateCreated datePublished" datetime="2020-12-09T23:08:52+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">运维自动化</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">系统部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>当不知道应答文件怎么写的时候，可以先手动安装一遍，然后参考其 anaconda-ks.cfg 文件</p>
<p>以下所有的用户密码都是 ljkk</p>
<h2 id="CentOS-6"><a href="#CentOS-6" class="headerlink" title="CentOS 6"></a>CentOS 6</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">install</span>
text
<span class="token function">reboot</span>
url <span class="token parameter variable">--url</span><span class="token operator">=</span>http://10.0.0.8/centos/6/os/x86_64/
lang en_US.UTF-8
keyboard us
network <span class="token parameter variable">--onboot</span> <span class="token function">yes</span> <span class="token parameter variable">--device</span> eth0 <span class="token parameter variable">--bootproto</span> dhcp <span class="token parameter variable">--noipv6</span>
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$6</span><span class="token variable">$CTxlVPMx</span>.O7NW6To<span class="token variable">$Ahp5HPWLJgKZguGM0</span>/48EBGmfo/6wLwiUIHkpHdM9g4TOt6onfiy1Xk1FlMMpJIsp4guQfp5OLLOdLs5rSGmX1
authconfig <span class="token parameter variable">--enableshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>sha512
firewall <span class="token parameter variable">--disabled</span>
selinux <span class="token parameter variable">--disabled</span>
timezone Asia/Shanghai
bootloader <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr <span class="token parameter variable">--driveorder</span><span class="token operator">=</span>sda <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">"crashkernel=auto rhgb quiet"</span>
zerombr
clearpart <span class="token parameter variable">--all</span> <span class="token parameter variable">--initlabel</span>
part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>sda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1024</span>
part pv.01 <span class="token parameter variable">--size</span> <span class="token number">1</span> <span class="token parameter variable">--grow</span>
volgroup volgrp pv.01
logvol swap <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>swap <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"swap"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">2048</span>
logvol /data <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>data <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">51200</span>
logvol / <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>root <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--grow</span>
%packages
@core
@server-policy
@workstation-policy
autofs
vim-enhanced
%end
%post
<span class="token function">useradd</span> lujinkai
<span class="token builtin class-name">echo</span> <span class="token number">123456</span> <span class="token operator">|</span> <span class="token function">passwd</span> <span class="token parameter variable">--stdin</span> lujinkai <span class="token operator">&amp;></span> /dev/null
<span class="token function">mkdir</span> /etc/yum.repos.d/bak
<span class="token function">mv</span> /etc/yum.repos.d/* /etc/yum.repos.d/bak
<span class="token function">cat</span> <span class="token operator">></span> /etc/yum.repos.d/base.repo <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[base]
name=base
baseurl=file:///misc/cd
gpgcheck=0
EOF</span>
%end</code></pre>

<h2 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS 7"></a>CentOS 7</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">install</span>
xconfig <span class="token parameter variable">--startxonboot</span>
keyboard <span class="token parameter variable">--vckeymap</span><span class="token operator">=</span>us <span class="token parameter variable">--xlayouts</span><span class="token operator">=</span><span class="token string">'us'</span>
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$1</span><span class="token variable">$YyodG</span>.X7<span class="token variable">$LzhHqxWONgSh0NBoC730o0</span>
url <span class="token parameter variable">--url</span><span class="token operator">=</span><span class="token string">"http://10.0.0.8/centos/7/os/x86_64"</span>
lang en_US
auth <span class="token parameter variable">--useshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>sha512
text
firstboot <span class="token parameter variable">--enable</span>
selinux <span class="token parameter variable">--disabled</span>
skipx
services <span class="token parameter variable">--disabled</span><span class="token operator">=</span><span class="token string">"chronyd"</span>
ignoredisk --only-use<span class="token operator">=</span>sda
firewall <span class="token parameter variable">--disabled</span>
network <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0
network <span class="token parameter variable">--hostname</span><span class="token operator">=</span>centos7.magedu.org
<span class="token function">reboot</span>
timezone Asia/Shanghai <span class="token parameter variable">--nontp</span>
bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">"net.ifnames=0"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr --boot-drive<span class="token operator">=</span>sda
zerombr
clearpart <span class="token parameter variable">--all</span> <span class="token parameter variable">--initlabel</span>
part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>sda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1024</span>
part pv.01 <span class="token parameter variable">--size</span> <span class="token number">1</span> <span class="token parameter variable">--grow</span>
volgroup volgrp pv.01
logvol swap <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>swap <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"swap"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">2048</span>
logvol /data <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>data <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">51200</span>
logvol / <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>root <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--grow</span>
%post
<span class="token function">useradd</span> lujinkai
%end
%packages
@core
%end</code></pre>

<h2 id="CentOS-8"><a href="#CentOS-8" class="headerlink" title="CentOS 8"></a>CentOS 8</h2><pre class="language-bash" data-language="bash"><code class="language-bash">ignoredisk --only-use<span class="token operator">=</span>sda
zerombr
text
<span class="token function">reboot</span>
clearpart <span class="token parameter variable">--all</span> <span class="token parameter variable">--initlabel</span>
selinux <span class="token parameter variable">--disabled</span>
firewall <span class="token parameter variable">--disabled</span>
url <span class="token parameter variable">--url</span><span class="token operator">=</span>http://10.0.0.8/centos/8/os/x86_64/
keyboard <span class="token parameter variable">--vckeymap</span><span class="token operator">=</span>us <span class="token parameter variable">--xlayouts</span><span class="token operator">=</span><span class="token string">'us'</span>
lang en_US.UTF-8
network <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0 <span class="token parameter variable">--ipv6</span><span class="token operator">=</span>auto <span class="token parameter variable">--activate</span>
bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">"net.ifnames=0"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr --boot-drive<span class="token operator">=</span>sda
network <span class="token parameter variable">--hostname</span><span class="token operator">=</span>centos8.magedu.org
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$6</span><span class="token variable">$CTxlVPMx</span>.O7NW6To<span class="token variable">$Ahp5HPWLJgKZguGM0</span>/48EBGmfo/6wLwiUIHkpHdM9g4TOt6onfiy1Xk1FlMMpJIsp4guQfp5OLLOdLs5rSGmX1
firstboot <span class="token parameter variable">--enable</span>
skipx
services <span class="token parameter variable">--disabled</span><span class="token operator">=</span><span class="token string">"chronyd"</span>
timezone Asia/Shanghai <span class="token parameter variable">--isUtc</span> <span class="token parameter variable">--nontp</span>
user <span class="token parameter variable">--name</span><span class="token operator">=</span>lujinkai <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token variable">$6</span><span class="token variable">$CTxlVPMx</span>.O7NW6To<span class="token variable">$Ahp5HPWLJgKZguGM0</span>/48EBGmfo/6wLwiUIHkpHdM9g4TOt6onfiy1Xk1FlMMpJIsp4guQfp5OLLOdLs5rSGmX1 <span class="token parameter variable">--iscrypted</span> <span class="token parameter variable">--gecos</span><span class="token operator">=</span><span class="token string">"lujinkai"</span>
part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>sda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1024</span>
part pv.01 <span class="token parameter variable">--size</span> <span class="token number">1</span> <span class="token parameter variable">--grow</span>
volgroup volgrp pv.01
logvol swap <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>swap <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"swap"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">2048</span>
logvol /data <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>data <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">51200</span>
logvol / <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>root <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--grow</span>
%packages
@^minimal-environment
kexec-tools
%end
%addon com_redhat_kdump <span class="token parameter variable">--enable</span> --reserve-mb<span class="token operator">=</span><span class="token string">'auto'</span>
%end
%anaconda
pwpolicy root <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--notempty</span>
pwpolicy user <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--emptyok</span>
pwpolicy luks <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--notempty</span>
%end</code></pre>

<h2 id="kvm-自动应答文件-centos7"><a href="#kvm-自动应答文件-centos7" class="headerlink" title="kvm 自动应答文件(centos7)"></a>kvm 自动应答文件(centos7)</h2><p>系统安装完后，在家目录会有两个 cfg 文件，original-ks.cfg 是自己编辑的自动应答文件，anaconda-ks.cfg 是系统根据 original-ks.cfg 自动生成的应答文件</p>
<ul>
<li>original-ks.cfg</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">install</span>
xconfig <span class="token parameter variable">--startxonboot</span>
keyboard <span class="token parameter variable">--vckeymap</span><span class="token operator">=</span>us <span class="token parameter variable">--xlayouts</span><span class="token operator">=</span><span class="token string">'us'</span>
lang en_US.UTF-8
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$1</span><span class="token variable">$YyodG</span>.X7<span class="token variable">$LzhHqxWONgSh0NBoC730o0</span>
url <span class="token parameter variable">--url</span><span class="token operator">=</span><span class="token string">"http://10.0.0.1/centos/7/os/x86_64"</span>
auth <span class="token parameter variable">--useshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>sha512
text
firstboot <span class="token parameter variable">--enable</span>
selinux <span class="token parameter variable">--disabled</span>
skipx
services <span class="token parameter variable">--disabled</span><span class="token operator">=</span><span class="token string">"chronyd"</span>
ignoredisk --only-use<span class="token operator">=</span>vda
firewall <span class="token parameter variable">--disabled</span>
network <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0
network <span class="token parameter variable">--hostname</span><span class="token operator">=</span>c7
<span class="token function">reboot</span>
timezone Asia/Shanghai <span class="token parameter variable">--nontp</span>
bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">"net.ifnames=0"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr --boot-drive<span class="token operator">=</span>vda
zerombr
clearpart <span class="token parameter variable">--all</span> <span class="token parameter variable">--initlabel</span>
part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>vda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">300</span>
part pv.01 <span class="token parameter variable">--size</span> <span class="token number">1</span> <span class="token parameter variable">--grow</span>
volgroup volgrp pv.01
logvol swap <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>swap <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"swap"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">2048</span>
logvol / <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>root <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--grow</span>
%post
<span class="token function">useradd</span> lujinkai
%end
%packages
@^minimal
@core
%end</code></pre>

<ul>
<li>anaconda-ks.cfg</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#version=DEVEL</span>
<span class="token comment"># System authorization information</span>
auth <span class="token parameter variable">--useshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>sha512
<span class="token comment"># Install OS instead of upgrade</span>
<span class="token function">install</span>
<span class="token comment"># Use text mode install</span>
text
<span class="token comment"># Firewall configuration</span>
firewall <span class="token parameter variable">--disabled</span>
<span class="token comment"># Run the Setup Agent on first boot</span>
firstboot <span class="token parameter variable">--enable</span>
ignoredisk --only-use<span class="token operator">=</span>vda
<span class="token comment"># Keyboard layouts</span>
keyboard <span class="token parameter variable">--vckeymap</span><span class="token operator">=</span>us <span class="token parameter variable">--xlayouts</span><span class="token operator">=</span><span class="token string">'us'</span>
<span class="token comment"># System language</span>
lang en_US.UTF-8

<span class="token comment"># Network information</span>
network  <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0 <span class="token parameter variable">--activate</span>
network  <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--hostname</span><span class="token operator">=</span>c7
<span class="token comment"># Reboot after installation</span>
<span class="token function">reboot</span>
<span class="token comment"># Use network installation</span>
url <span class="token parameter variable">--url</span><span class="token operator">=</span><span class="token string">"http://10.0.0.1/centos/7/os/x86_64"</span>
<span class="token comment"># Root password</span>
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$1</span><span class="token variable">$YyodG</span>.X7<span class="token variable">$LzhHqxWONgSh0NBoC730o0</span>
<span class="token comment"># SELinux configuration</span>
selinux <span class="token parameter variable">--disabled</span>
<span class="token comment"># System services</span>
services <span class="token parameter variable">--disabled</span><span class="token operator">=</span><span class="token string">"chronyd"</span>
<span class="token comment"># Do not configure the X Window System</span>
skipx
<span class="token comment"># System timezone</span>
timezone Asia/Shanghai <span class="token parameter variable">--nontp</span>
<span class="token comment"># X Window System configuration information</span>
xconfig  <span class="token parameter variable">--startxonboot</span>
<span class="token comment"># System bootloader configuration</span>
bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">"net.ifnames=0 crashkernel=auto"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr --boot-drive<span class="token operator">=</span>vda
<span class="token comment"># Clear the Master Boot Record</span>
zerombr
<span class="token comment"># Partition clearing information</span>
clearpart <span class="token parameter variable">--all</span> <span class="token parameter variable">--initlabel</span>
<span class="token comment"># Disk partitioning information</span>
part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>vda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">300</span>
part pv.60 <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"lvmpv"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">20179</span>
volgroup volgrp <span class="token parameter variable">--pesize</span><span class="token operator">=</span><span class="token number">4096</span> pv.60
logvol /  <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--grow</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>root <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp
logvol swap  <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"swap"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">2048</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>swap <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp

%post
<span class="token function">useradd</span> lujinkai
%end

%packages
@^minimal
@core
kexec-tools

%end

%addon com_redhat_kdump <span class="token parameter variable">--enable</span> --reserve-mb<span class="token operator">=</span><span class="token string">'auto'</span>

%end</code></pre>

<h3 id="kvm-安装在逻辑卷"><a href="#kvm-安装在逻辑卷" class="headerlink" title="kvm 安装在逻辑卷"></a>kvm 安装在逻辑卷</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#version=DEVEL</span>
<span class="token comment"># System authorization information</span>
auth <span class="token parameter variable">--enableshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>sha512
<span class="token comment"># Use CDROM installation media</span>
cdrom
<span class="token comment"># Use graphical install</span>
graphical
<span class="token comment"># Run the Setup Agent on first boot</span>
firstboot <span class="token parameter variable">--enable</span>
ignoredisk --only-use<span class="token operator">=</span>vda
<span class="token comment"># Keyboard layouts</span>
keyboard <span class="token parameter variable">--vckeymap</span><span class="token operator">=</span>us <span class="token parameter variable">--xlayouts</span><span class="token operator">=</span><span class="token string">'us'</span>
<span class="token comment"># System language</span>
lang en_US.UTF-8

<span class="token comment"># Network information</span>
network  <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0 <span class="token parameter variable">--ipv6</span><span class="token operator">=</span>auto <span class="token parameter variable">--activate</span>
network  <span class="token parameter variable">--hostname</span><span class="token operator">=</span>localhost.localdomain

<span class="token comment"># Root password</span>
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$6</span><span class="token variable">$FyziLpCibU</span>/RQPqp<span class="token variable">$G56mBV90w0lM1xVCK6Bwsg4ANZd</span>/Gj8hKsENU3mfQAPoqBevdCyw.Dw88OkOHBUxpIoq7Zi.NQ6890l5Otzev.
<span class="token comment"># System services</span>
services <span class="token parameter variable">--disabled</span><span class="token operator">=</span><span class="token string">"chronyd"</span>
<span class="token comment"># System timezone</span>
timezone Asia/Shanghai <span class="token parameter variable">--isUtc</span> <span class="token parameter variable">--nontp</span>
user <span class="token parameter variable">--name</span><span class="token operator">=</span>lujinkai <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token variable">$6</span><span class="token variable">$oKgYyszaGm2rHnk</span>/<span class="token variable">$cDyAFysw5bhQTT18sGCREat6ZkIfo9</span>/BlluiPlWmAfTk/48x9KukRepXoRelKqiA9tjRYFcWEmHivHjl2TOrR0 <span class="token parameter variable">--iscrypted</span> <span class="token parameter variable">--gecos</span><span class="token operator">=</span><span class="token string">"lujinkai"</span>
<span class="token comment"># System bootloader configuration</span>
bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">" crashkernel=auto"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr --boot-drive<span class="token operator">=</span>vda
<span class="token comment"># Partition clearing information</span>
clearpart <span class="token parameter variable">--none</span> <span class="token parameter variable">--initlabel</span>
<span class="token comment"># Disk partitioning information</span>
part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>vda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">300</span>
part pv.428 <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"lvmpv"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>vda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">4819</span>
volgroup centos <span class="token parameter variable">--pesize</span><span class="token operator">=</span><span class="token number">4096</span> pv.428
logvol /  <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">4816</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>root <span class="token parameter variable">--vgname</span><span class="token operator">=</span>centos

%packages
@^minimal
@core
kexec-tools

%end

%addon com_redhat_kdump <span class="token parameter variable">--enable</span> --reserve-mb<span class="token operator">=</span><span class="token string">'auto'</span>

%end

%anaconda
pwpolicy root <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--notempty</span>
pwpolicy user <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--emptyok</span>
pwpolicy luks <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--notempty</span>
%end</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">系统部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:08:04" itemprop="dateCreated datePublished" datetime="2020-12-09T23:08:04+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">运维自动化</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">系统部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="系统安装过程"><a href="#系统安装过程" class="headerlink" title="系统安装过程"></a>系统安装过程</h2><h3 id="Linux-安装过程"><a href="#Linux-安装过程" class="headerlink" title="Linux 安装过程"></a>Linux 安装过程</h3><ol>
<li>加载 boot loader</li>
<li>加载启动安装菜单</li>
<li>加载内核和 initrd 文件</li>
<li>加载根系统</li>
<li>运行 anaconda 的安装向导</li>
</ol>
<h4 id="isolinux-目录下安装相关文件"><a href="#isolinux-目录下安装相关文件" class="headerlink" title="isolinux 目录下安装相关文件"></a>isolinux 目录下安装相关文件</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将光盘挂载到/mnt/sro目录下</span>
<span class="token punctuation">[</span>root@centos8 mnt<span class="token punctuation">]</span><span class="token variable">$mount</span> /dev/sr0 /mnt/sr0/
mount: /mnt/sr0: WARNING: device write-protected, mounted read-only.
<span class="token comment"># 查看isolinux目录下的文件</span>
<span class="token punctuation">[</span>root@centos8 isolinux<span class="token punctuation">]</span><span class="token variable">$ll</span> /mnt/sr0/isolinux/
total <span class="token number">72859</span>
-r--r--r--. <span class="token number">1</span> root root     <span class="token number">2048</span> Jun  <span class="token number">8</span> <span class="token number">18</span>:08 boot.cat
-r--r--r--. <span class="token number">1</span> root root       <span class="token number">84</span> Jun  <span class="token number">8</span> <span class="token number">17</span>:26 boot.msg
-r--r--r--. <span class="token number">1</span> root root      <span class="token number">293</span> Jun  <span class="token number">8</span> <span class="token number">17</span>:26 grub.conf
-r--r--r--. <span class="token number">2</span> root root <span class="token number">65114136</span> Jun  <span class="token number">8</span> <span class="token number">17</span>:25 initrd.img
-r--r--r--. <span class="token number">1</span> root root    <span class="token number">38912</span> Jun  <span class="token number">8</span> <span class="token number">17</span>:26 isolinux.bin
-r--r--r--. <span class="token number">1</span> root root     <span class="token number">3075</span> Jun  <span class="token number">8</span> <span class="token number">17</span>:26 isolinux.cfg
-r--r--r--. <span class="token number">1</span> root root   <span class="token number">116096</span> Nov  <span class="token number">8</span>  <span class="token number">2019</span> ldlinux.c32
-r--r--r--. <span class="token number">1</span> root root   <span class="token number">180700</span> Nov  <span class="token number">8</span>  <span class="token number">2019</span> libcom32.c32
-r--r--r--. <span class="token number">1</span> root root    <span class="token number">22804</span> Nov  <span class="token number">8</span>  <span class="token number">2019</span> libutil.c32
-r--r--r--. <span class="token number">1</span> root root   <span class="token number">182704</span> May <span class="token number">12</span>  <span class="token number">2019</span> memtest
-r--r--r--. <span class="token number">1</span> root root      <span class="token number">186</span> Jul <span class="token number">30</span>  <span class="token number">2019</span> splash.png
-r--r--r--. <span class="token number">1</span> root root     <span class="token number">2885</span> Jun  <span class="token number">8</span> <span class="token number">18</span>:08 TRANS.TBL
-r--r--r--. <span class="token number">1</span> root root    <span class="token number">26788</span> Nov  <span class="token number">8</span>  <span class="token number">2019</span> vesamenu.c32
-r-xr-xr-x. <span class="token number">2</span> root root  <span class="token number">8913656</span> May  <span class="token number">8</span> 07:07 vmlinuz</code></pre>

<ul>
<li>boot.cat: 相当于 grub 的第一阶段</li>
<li>isolinux.bin：光盘引导程序，在 mkisofs 的选项中需要明确给出文件路径，这个文件属于 SYSLINUX 项目</li>
<li>isolinux.cfg：启动菜单的配置文件，当光盘启动后（即运行 isolinux.bin），会自动去找 isolinux.cfg 文件</li>
<li>vesamenu.c32：是光盘启动后的启动菜单图形界面，也属于 SYSLINUX 项目，menu.c32 提供纯文本的菜单</li>
<li>memtest：内存检测程序</li>
<li>splash.png：光盘启动菜单界面的背景图</li>
<li>vmlinuz：是内核映像</li>
<li>initrd.img：ramfs 文件</li>
</ul>
<h4 id="安装菜单的内核参数"><a href="#安装菜单的内核参数" class="headerlink" title="安装菜单的内核参数"></a>安装菜单的内核参数</h4><p>安装光盘的启动菜单配置文件：isolinux&#x2F;isolinux.cfg，每个 label 就是一个菜单项，主菜单或者二级菜单。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600091290280.png"></p>
<p>isolinux.cfg 中部分内容：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 默认使用vesamenu.c32：图形化菜单界面。menu.32提供纯文本的菜单</span>
default vesamenu.c32
<span class="token comment"># 默认等待时间，单位是十分之一秒</span>
<span class="token function">timeout</span> <span class="token number">600</span>
<span class="token comment"># 标题</span>
menu title CentOS Linux <span class="token number">8</span>

<span class="token comment"># 菜单选项</span>
label linux
  menu label ^Install CentOS Linux <span class="token number">8</span>	<span class="token comment"># 菜单标签</span>
  kernel vmlinuz	<span class="token comment"># 加载的内核，这里是相对路径</span>
  <span class="token comment"># 向内核传递参数，除了菜单文件指定，在安装界面还可以tab键后 手动输入，常见内核参数见下表</span>
  append <span class="token assign-left variable">initrd</span><span class="token operator">=</span>initrd.img <span class="token assign-left variable">inst.stage2</span><span class="token operator">=</span>hd:LABEL<span class="token operator">=</span>CentOS-8-2-2004-x86_64-dvd quiet

<span class="token comment"># menu begin 设置Troubleshooting的二级菜单 开始</span>
menu begin ^Troubleshooting
  menu title Troubleshooting

<span class="token comment"># menu begin 和 menu begin end 之间的内容，属于二级菜单</span>
<span class="token punctuation">..</span>.

<span class="token comment"># menu begin 设置二级菜单 结束</span>
menu end
</code></pre>

<h4 id="常见内核参数"><a href="#常见内核参数" class="headerlink" title="常见内核参数"></a>常见内核参数</h4><ul>
<li><p>text：指定文本方式的安装界面</p>
</li>
<li><p>rescue：进入救援模式</p>
</li>
<li><p>inst.repo&#x3D;path：指定安装源文件的路径，可以是以下格式</p>
<p><strong>Centos 6：</strong></p>
<ul>
<li>DVD drive repo&#x3D;cdrom :device</li>
<li>Hard Drive repo&#x3D;hd:device&#x2F;path</li>
<li>HTTP Server repo&#x3D;<a target="_blank" rel="noopener" href="http://host/path">http://host/path</a></li>
<li>HTTPS Server repo&#x3D;<a target="_blank" rel="noopener" href="https://host/path">https://host/path</a></li>
<li>FTP Server repo&#x3D;<a href="ftp://username:password@host/path">ftp://username:password@host/path</a></li>
<li>NFS Server repo&#x3D;nfs:server:&#x2F;path</li>
<li>ISO images on an NFS Server repo&#x3D;nfsiso:server:&#x2F;path<br><strong>Centos 7：</strong></li>
<li>Any CD&#x2F;DVD drive inst.repo&#x3D;cdrom</li>
<li>Hard Drive inst.repo&#x3D;hd:device:&#x2F;path</li>
<li>HTTP Server inst.repo&#x3D;<a target="_blank" rel="noopener" href="http://host/path">http://host/path</a></li>
<li>HTTPS Server inst.repo&#x3D;<a target="_blank" rel="noopener" href="https://host/path">https://host/path</a></li>
<li>FTP Server inst.repo&#x3D;<a href="ftp://username:password@host/path">ftp://username:password@host/path</a></li>
<li>NFS Server inst.repo&#x3D;nfs:[options:]server:&#x2F;path</li>
</ul>
</li>
<li><p>inst.ks&#x3D;path：指定自动化安装应答文件路径，例如</p>
<ul>
<li>inst.ks&#x3D;<a target="_blank" rel="noopener" href="http://192.168.8.8/ksdir/ks8.cfg">http://192.168.8.8/ksdir/ks8.cfg</a></li>
<li>DVD drive：inst.ks&#x3D;cdrom:&#x2F;PATH&#x2F;TO&#x2F;KICKSTART_FILE</li>
<li>Hard drive：inst.ks&#x3D;hd:device:&#x2F;directory&#x2F;KICKSTART_FILE</li>
<li>HTTP server：inst.ks&#x3D;<a href="http://host:port/path/to/KICKSTART_FILE">http://host:port/path/to/KICKSTART_FILE</a></li>
<li>FTP server：inst.ks&#x3D;<a href="ftp://host:port/path/to/KICKSTART_FILE">ftp://host:port/path/to/KICKSTART_FILE</a></li>
<li>HTTPS server：inst.ks&#x3D;<a href="https://host:port/path/to/KICKSTART_FILE">https://host:port/path/to/KICKSTART_FILE</a></li>
<li>NFS server：inst.ks&#x3D;nfs:host:&#x2F;path&#x2F;to&#x2F;KICKSTART_FILE</li>
</ul>
</li>
<li><p>ip&#x3D; : 指定 IP 地址信息，例如</p>
<ul>
<li>ip&#x3D;dhcp 自动获取</li>
<li>id&#x3D;eth0:dhcp 指定网卡接口</li>
<li>ip&#x3D;ip::gateway:netmask:hostname:interface:none 静态 IP</li>
</ul>
</li>
</ul>
<p>注意：安装程序的引导参数都使用 inst. 作为前缀。目前这个前缀是可选的，例如 inst.ks&#x3D; 和 ks&#x3D; 的效果完全一样。但预期在未来会强制使用 inst. 前缀。</p>
<h3 id="自动安装的应答文件"><a href="#自动安装的应答文件" class="headerlink" title="自动安装的应答文件"></a>自动安装的应答文件</h3><p>实现自动化安装前，需要制作对应的应答文件，称为 kickstart 文件，用于保存安装过程中的需要指定的选项</p>
<p>如果是图形化手动一步步安装，系统会自动生成应答文件：&#x2F;root&#x2F;anaconda-ks.cfg</p>
<p>kickstart 文件格式的官方说明：<a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/installation_guide/s1-kickstart2-options">centos6</a>、<a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">centos7</a>、<a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/performing_an_advanced_rhel_installation/index">centos8</a></p>
<h4 id="kickstart-文件格式说明"><a href="#kickstart-文件格式说明" class="headerlink" title="kickstart 文件格式说明"></a>kickstart 文件格式说明</h4><p>kickstart 文件主要包括三个部分：命令段、程序包段、脚本段</p>
<h5 id="命令段"><a href="#命令段" class="headerlink" title="命令段"></a>命令段</h5><p>指明各种安装前配置，如键盘类型等</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>keyboard</td>
<td>设定键盘类型</td>
</tr>
<tr>
<td>lang</td>
<td>语言类型</td>
</tr>
<tr>
<td>zerombr</td>
<td>清除 mbr</td>
</tr>
<tr>
<td>clearpart</td>
<td>清除分区</td>
</tr>
<tr>
<td>part</td>
<td>创建分区</td>
</tr>
<tr>
<td>rootpw</td>
<td>指明 root 的密码</td>
</tr>
<tr>
<td>timezone</td>
<td>时区</td>
</tr>
<tr>
<td>text</td>
<td>文本安装界面</td>
</tr>
<tr>
<td>network</td>
<td>指定网络设置</td>
</tr>
<tr>
<td>firewall</td>
<td>设置防火墙设置</td>
</tr>
<tr>
<td>selinux</td>
<td>设置 selinux 设置</td>
</tr>
<tr>
<td>reboot</td>
<td>安装完自动重启</td>
</tr>
<tr>
<td>user</td>
<td>安装完成后为系统创建新用户</td>
</tr>
<tr>
<td>url</td>
<td>指明安装源</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<h5 id="程序包段"><a href="#程序包段" class="headerlink" title="程序包段"></a>程序包段</h5><p>%packages：指定要安装的程序包组或程序包、指定不安装的程序包等。以%end 结尾。范例：</p>
<pre class="language-none"><code class="language-none">%packages
@^environment group		# 环境包组，如：@^minimal-environment
@group_name		# 程序包组
package		# 程序包
-package	# 不安装的程序包
%end</code></pre>

<h5 id="脚本段"><a href="#脚本段" class="headerlink" title="脚本段"></a>脚本段</h5><ul>
<li>%pre: 安装前脚本，%end 结尾</li>
<li>%post: 安装后脚本，%end 结尾</li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">%post
<span class="token function">useradd</span> mage
<span class="token builtin class-name">echo</span> magedu <span class="token operator">|</span> <span class="token function">passwd</span> <span class="token parameter variable">--stdin</span> mage <span class="token operator">&amp;></span> /dev/null
%end</code></pre>

<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><ul>
<li><p>%addon：安装插件，%end 结尾，范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">%addon com_redhat_kdump <span class="token parameter variable">--enable</span> --reserve-mb<span class="token operator">=</span><span class="token number">128</span>
%end</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">%addon org_fedora_oscap
content-type <span class="token operator">=</span> datastream
content-url <span class="token operator">=</span> http://www.example.com/scap/testing_ds.xml
datastream-id <span class="token operator">=</span> scap_example.com_datastream_testing
xccdf-id <span class="token operator">=</span> scap_example.com_cref_xccdf.xml
profile <span class="token operator">=</span>  xccdf_example.com_profile_my_profile
fingerprint <span class="token operator">=</span> 240f2f18222faa98856c3b4fc50c4195
%end</code></pre>
</li>
<li><p>%anaconda：控制安装系统的用户界面的行为。此部分必须放在 kickstart 文件的末尾。目前，在%anaconda 部分中，pwplicy 是唯一可以使用的命令，范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置密码策略，要求root密码至少为10个字符长，并严格禁止与此要求不匹配的密码</span>
%anaconda
pwpolicy root <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">10</span> <span class="token parameter variable">--strict</span>
%end</code></pre></li>
</ul>
<p>注意：CentOS6、7、8 的 kickstart 文件格式不尽相同，不可混用</p>
<h4 id="kickstart-文件创建"><a href="#kickstart-文件创建" class="headerlink" title="kickstart 文件创建"></a>kickstart 文件创建</h4><ul>
<li>可使用创建工具：system-config-kickstart ，注意：此方法 CentOS 8 不再支持</li>
<li>CentOS 安装完后，会根据当前系统的安装过程，自动生成一个 kickstart 文件：&#x2F;root&#x2F;anaconda-ks.cfg，可以根据此文件修改并生成新配置</li>
</ul>
<p>推荐使用第二种方式，手动编辑，最后使用 ksvalidator（来自于 pykickstart 包） 工具检查一下文件格式是否有语法错误。</p>
<pre class="language-none"><code class="language-none">[root@centos8 ~]$yum install pykickstart.noarch
[root@centos8 ~]$ksvalidator .&#x2F;anaconda-ks.cfg</code></pre>

<h2 id="制作引导-U-盘"><a href="#制作引导-U-盘" class="headerlink" title="制作引导 U 盘"></a>制作引导 U 盘</h2><p>制作应答文件、修改 iso 的启动菜单配置文件 isolinux.cfg，然后把 iso 制作成引导 U 盘，就可以实现半自动化安装。</p>
<p>应答文件可以放在 iso 中，也可以放在 http 服务器，只需要在 isolinux.cfg 中配置好 ks&#x3D;path 即可。</p>
<h2 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h2><p>主机获取网络配置可以通过两种方式：</p>
<ul>
<li>静态指定</li>
<li>动态获取<ul>
<li>bootp：boot protocol，IP 与 MAC 一一静态对应</li>
<li>dhcp：增强的 bootp，IP 与 MAC 既可以静态绑定，也可以动态分配</li>
</ul>
</li>
</ul>
<h3 id="DHCP-工作原理"><a href="#DHCP-工作原理" class="headerlink" title="DHCP 工作原理"></a>DHCP 工作原理</h3><p>DHCP: Dynamic Host Configuration Protocol，动态主机配置协议。基于 UDP 协议，DHCP Server 默认 67 端口号，DHCP Client 默认 68（ipv4）和 546（ipv6）端口号。</p>
<p>主要用途：</p>
<ul>
<li>用于内部网络和网络服务供应商自动分配 IP 地址给用户</li>
<li>用于内部网络管理员作为对所有电脑作集中管理的手段</li>
<li>自动化安装系统</li>
<li>解决 IPV4 资源不足问题</li>
</ul>
<h3 id="DHCP-实现"><a href="#DHCP-实现" class="headerlink" title="DHCP 实现"></a>DHCP 实现</h3><p>实现 DHCP 服务的软件：</p>
<ul>
<li>dhcp（centos7） 或 dhcp server（centos8）</li>
<li>dnsmasq：小型服务软件，可以提供 dhcp 和 dns 服务</li>
</ul>
<h4 id="DHCP-相关文件组成"><a href="#DHCP-相关文件组成" class="headerlink" title="DHCP 相关文件组成"></a>DHCP 相关文件组成</h4><p><strong>dhcp 或 dhcp server 包文件组成：</strong></p>
<ul>
<li>&#x2F;usr&#x2F;sbin&#x2F;dhcpd：dhcp 服务主程序</li>
<li>&#x2F;etc&#x2F;dhcp&#x2F;dhcpd.conf：dhcp 服务配置文件</li>
<li>&#x2F;usr&#x2F;share&#x2F;doc&#x2F;dhcp-server&#x2F;dhcpd.conf.example：dhcp 服务配置范例文件</li>
<li>&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;dhcpd.service：dhcp 服务 service 文件</li>
<li>&#x2F;var&#x2F;lib&#x2F;dhcpd&#x2F;dhcpd.leases：DHCP 服务器日志，记录了地址分配记录</li>
</ul>
<p><strong>dhcp-client 客户端包：</strong></p>
<ul>
<li>&#x2F;usr&#x2F;sbin&#x2F;dhclient：客户端程序</li>
<li>&#x2F;var&#x2F;lib&#x2F;dhclient&#x2F;dhclient.leases：DHCP 客户端日志，</li>
</ul>
<h4 id="DHCP-服务器配置文件"><a href="#DHCP-服务器配置文件" class="headerlink" title="DHCP 服务器配置文件"></a>DHCP 服务器配置文件</h4><p>帮助参考：man 5 dhcpd.conf</p>
<p>dhcpd.conf 配置信息： subnet 网段设置； host 主机设置。 范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">option domain-name <span class="token string">"magedu.org"</span><span class="token punctuation">;</span>	<span class="token comment"># 分配给用户域名，就是/etc/resolve.conf中的domain</span>
<span class="token comment"># 分配给用户DNS，就是/etc/resolve.conf中的nameserver</span>
option domain-name-servers <span class="token number">180.76</span>.76.76, <span class="token number">223.6</span>.6.6<span class="token punctuation">;</span>
<span class="token comment"># 默认租约时间，以秒为单位，十分钟，五分钟就要续约，所以一般我们需要把这个值调长一些</span>
default-lease-time <span class="token number">600</span><span class="token punctuation">;</span>
max-lease-time <span class="token number">7200</span><span class="token punctuation">;</span>    <span class="token comment"># 最长续约时间，两个小时</span>
log-facility local7<span class="token punctuation">;</span>	<span class="token comment"># 日志类型，具体什么含义后面的日志章节会详细学习，这里先不用管它</span>
<span class="token comment"># 网段设置</span>
subnet <span class="token number">10.0</span>.0.0 netmask <span class="token number">255.255</span>.255.0 <span class="token punctuation">&#123;</span>
  range <span class="token number">10.0</span>.0.10 <span class="token number">10.0</span>.0.100<span class="token punctuation">;</span>   <span class="token comment"># ip 范围</span>
  range <span class="token number">10.0</span>.0.110 <span class="token number">10.0</span>.0.200<span class="token punctuation">;</span>    <span class="token comment"># ip 范围</span>
  option routers <span class="token number">10.0</span>.0.2<span class="token punctuation">;</span>    <span class="token comment"># 路由</span>
  <span class="token comment"># 提供引导文件的服务器IP地址，一般是一个tftp服务器。与pxe自动化安装有关</span>
  next-server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
  <span class="token comment"># 指明引导文件名称：pxelinux.0</span>
  filename <span class="token string">"pxelinux.0"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># 主机设置，DHCP服务器给指定主机分配固定IP</span>
<span class="token function">host</span> testclient <span class="token punctuation">&#123;</span>
  hardware ethernet 00:0c:29:33:b4:1a<span class="token punctuation">;</span>
  fixed-address <span class="token number">10.0</span>.0.106<span class="token punctuation">;</span>		<span class="token comment"># 指定ip，与MAC地址绑定</span>
  default-lease-time <span class="token number">86400</span><span class="token punctuation">;</span>
  max-lease-time <span class="token number">864000</span><span class="token punctuation">;</span>
  option routers <span class="token number">10.0</span>.0.254<span class="token punctuation">;</span>
  option domain-name-servers <span class="token number">114.114</span>.114.114,8.8.8.8 <span class="token punctuation">;</span>
  option domain-name <span class="token string">"magedu.net"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="dhclient-命令"><a href="#dhclient-命令" class="headerlink" title="dhclient 命令"></a>dhclient 命令</h4><pre class="language-bash" data-language="bash"><code class="language-bash">dhclient <span class="token parameter variable">-d</span>		<span class="token comment"># 强制dhclient作为前台进程运行</span>
dhclient <span class="token parameter variable">-l</span>		<span class="token comment"># 尝试获得一次租约</span>
dhclient <span class="token parameter variable">-r</span>		<span class="token comment"># 释放当前租约并停止正在运行的DHCP客户端</span></code></pre>

<h2 id="TFTP"><a href="#TFTP" class="headerlink" title="TFTP"></a>TFTP</h2><p>OpenSSH 服务中，我们学习了 SFTP 是安全版的 FTP，而 TFTP 是简化版的 FTP：</p>
<ol>
<li><p>FTP 基于 TCP、TFTP 基于 UDP</p>
</li>
<li><p>FTP 支持账号登录，TFTP 不支持账号登录</p>
</li>
<li><p>FTP 使用 2 个端口：TCP 端口 21，是个侦听端口；TCP 端口 20 或更高 TCP 端口 1024 以上用于源连接。</p>
<p>FTP 仅使用一个具有停止和等待模式的端口：端口：69&#x2F;udp</p>
</li>
<li><p>FTP 有许多可以执行的命令（get，put，ls，dir，lcd）并且可以列出目录等<br>TFTP 只有 5 个指令可以执行（rrq，wrq，data，ack，error）</p>
</li>
</ol>
<h3 id="安装和使用-TFTP"><a href="#安装和使用-TFTP" class="headerlink" title="安装和使用 TFTP"></a>安装和使用 TFTP</h3><p>服务器包 tftp-server：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$dnf</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> tftp-server		<span class="token comment"># 安装dftp服务器包</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-ql</span> tftp-server
/usr/lib/.build-id
/usr/lib/.build-id/8c
/usr/lib/.build-id/8c/6921a9fb21d66da4fb299d516bce9ee6afea34
/usr/lib/systemd/system/tftp.service	<span class="token comment"># tftp service文件</span>
/usr/lib/systemd/system/tftp.socket		<span class="token comment"># tftp socket文件</span>
/usr/sbin/in.tftpd						<span class="token comment"># tftp主程序</span>
/usr/share/doc/tftp-server
/usr/share/doc/tftp-server/CHANGES
/usr/share/doc/tftp-server/README
/usr/share/doc/tftp-server/README.security
/usr/share/man/man8/in.tftpd.8.gz
/usr/share/man/man8/tftpd.8.gz
/var/lib/tftpboot		<span class="token comment"># TFTP服务数据目录</span>

<span class="token comment"># 启动服务并设置开机自启</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> tftp.service
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$ss</span> <span class="token parameter variable">-ntulp</span>

<span class="token comment"># 准备测试文件</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /var/lib/tftpboot/
<span class="token punctuation">[</span>root@centos8 tftpboot<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token string">'hello tftp'</span> <span class="token operator">></span> test.txt</code></pre>

<p>客户端包 tftp：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#yum -y install tftp</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#tftp 10.0.0.8</span>
tftp<span class="token operator">></span> ?
tftp-hpa <span class="token number">5.2</span>
Commands may be abbreviated.  Commands are:

connect         connect to remote tftp
mode            <span class="token builtin class-name">set</span> <span class="token function">file</span> transfer mode
put             send <span class="token function">file</span>
get             receive <span class="token function">file</span>
quit            <span class="token builtin class-name">exit</span> tftp
verbose         toggle verbose mode
trace           toggle packet tracing
literal         toggle literal mode, ignore <span class="token string">':'</span> <span class="token keyword">in</span> <span class="token function">file</span> name
status          show current status
binary          <span class="token builtin class-name">set</span> mode to octet
ascii           <span class="token builtin class-name">set</span> mode to netascii
rexmt           <span class="token builtin class-name">set</span> per-packet transmission <span class="token function">timeout</span>
<span class="token function">timeout</span>         <span class="token builtin class-name">set</span> total retransmission <span class="token function">timeout</span>
?               print <span class="token builtin class-name">help</span> information
<span class="token builtin class-name">help</span>            print <span class="token builtin class-name">help</span> information
tftp<span class="token operator">></span> get test.txt		<span class="token comment"># 注意，目录不能get，ftp也不行</span>
tftp<span class="token operator">></span> quit
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ll test.txt</span>
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">12</span> Sep <span class="token number">15</span> <span class="token number">19</span>:12 test.txt
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#cat test.txt</span>
hello tftp</code></pre>

<h2 id="利用-PXE-实现自动化安装部署"><a href="#利用-PXE-实现自动化安装部署" class="headerlink" title="利用 PXE 实现自动化安装部署"></a>利用 PXE 实现自动化安装部署</h2><p>PXE：Preboot Excution Environment，预启动执行环境，是由 Intel 公司研发，基于 Client&#x2F;Server 的网络模式。</p>
<p>Intel PXE 规范定义了一些机制和协议，可让 PXE 设备使用其网络接口卡 (NIC) 来查找<strong>位于网络服务器上的引导程序</strong>。在 PXE 规范中，这些程序被称为“网络引导程序”(NBP)。</p>
<p><font style="background:#ccc">复习：MBR 硬盘的 0 号扇区的前 446 个字符是主引导程序 BootLoader，作用是查找和装载可引导的操作系统。</font><br>NBP 类似 BootLoader，只不过 NMP 是在网络中查找配置文件，根据配置文件引导系统。</p>
<p>syslinux 是一个启动加载器集合，支持从硬盘、光盘或通过 PXE 的网络引导启动系统，支持 ext4、FAT 等文件系统。Server 安装 syslinux 后，会在&#x2F;usr&#x2F;share&#x2F;syslinux 目录下生成很多文件，其中 pxelinux.0 就是 NBP，pxelinux.cfg 就是配置文件。</p>
<p>PXE 启动工作原理：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600169193361.png"></p>
<h3 id="在-CentOS8-上实现-PXE-自动化安装-CentOS6、7、8"><a href="#在-CentOS8-上实现-PXE-自动化安装-CentOS6、7、8" class="headerlink" title="在 CentOS8 上实现 PXE 自动化安装 CentOS6、7、8"></a>在 CentOS8 上实现 PXE 自动化安装 CentOS6、7、8</h3><p>安装前准备：</p>
<ul>
<li>关闭 Vmware 软件中的 DHCP 服务，设置为基于 NAT 模式</li>
<li>关闭 CentOS 8 的防火墙和 SELINUX</li>
<li>确保 CentOS 8 的 IP 是静态指定，不是 DHCP 获取</li>
<li>使用 1G 以下内存的主机安装 CentOS 7，8 会提示空间不足，建议 2G 以上</li>
</ul>
<ol>
<li>安装相关软件包并启动</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#dnf -y install dhcp-server tftp-server httpd syslinux-nonlinux</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#systemctl enable --now httpd tftp dhcpd</span></code></pre>

<ol start="2">
<li>配置 DHCP 服务</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash">option domain-name <span class="token string">"magedu.org"</span><span class="token punctuation">;</span>
option domain-name-servers <span class="token number">180.76</span>.76.76, <span class="token number">223.6</span>.6.6<span class="token punctuation">;</span>
default-lease-time <span class="token number">600</span><span class="token punctuation">;</span>
max-lease-time <span class="token number">7200</span><span class="token punctuation">;</span>
log-facility local7<span class="token punctuation">;</span>
subnet <span class="token number">10.0</span>.0.0 netmask <span class="token number">255.255</span>.255.0 <span class="token punctuation">&#123;</span>
  range <span class="token number">10.0</span>.0.10 <span class="token number">10.0</span>.0.100<span class="token punctuation">;</span>
  range <span class="token number">10.0</span>.0.110 <span class="token number">10.0</span>.0.200<span class="token punctuation">;</span>
  option routers <span class="token number">10.0</span>.0.2<span class="token punctuation">;</span>
  next-server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
  filename <span class="token string">"pxelinux.0"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="3">
<li>配置 TFTP 服务，参考上文</li>
<li>准备 yum 源和相关目录</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mkdir -pv /var/www/html/centos/&#123;6,7,8&#125;/os/x86_64/</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mount /dev/sr0 /var/www/html/centos/6/os/x86_64/</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mount /dev/sr1 /var/www/html/centos/8/os/x86_64/</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mount /dev/sr2 /var/www/html/centos/7/os/x86_64/</span></code></pre>

<ol start="5">
<li>准备应答文件</li>
</ol>
<p>centos6：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 参考 14.1 CentOS6、7、8应答文件.md</span></code></pre>

<p>centos7：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 参考 14.1 CentOS6、7、8应答文件.md</span></code></pre>

<p>centos8：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 参考 14.1 CentOS6、7、8应答文件.md</span></code></pre>

<ol start="6">
<li>准备 PXE 启动相关文件</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 tftpboot<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /var/lib/tftpboot/centos<span class="token punctuation">&#123;</span><span class="token number">6,7</span>,8<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/var/www/html/centos
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token number">6</span>/os/x86_64/isolinux/<span class="token punctuation">&#123;</span>vmlinuz,initrd.img<span class="token punctuation">&#125;</span> /var/lib/tftpboot/centos6/
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token number">7</span>/os/x86_64/isolinux/<span class="token punctuation">&#123;</span>vmlinuz,initrd.img<span class="token punctuation">&#125;</span> /var/lib/tftpboot/centos7/
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token number">8</span>/os/x86_64/isolinux/<span class="token punctuation">&#123;</span>vmlinuz,initrd.img<span class="token punctuation">&#125;</span> /var/lib/tftpboot/centos8/
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$cp</span> /usr/share/syslinux/<span class="token punctuation">&#123;</span>pxelinux.0,menu.c32<span class="token punctuation">&#125;</span> /var/lib/tftpboot/

<span class="token comment">#以下三个文件是CentOS8安装所必须文件，CentOS6，7则不需要</span>
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token number">8</span>/os/x86_64/isolinux/<span class="token punctuation">&#123;</span>ldlinux.c32,libcom32.c32,libutil.c32<span class="token punctuation">&#125;</span> /var/lib/tftpboot/

<span class="token comment">#生成安装菜单文件</span>
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /var/lib/tftpboot/pxelinux.cfg
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token number">8</span>/os/x86_64/isolinux/<span class="token punctuation">&#123;</span>ldlinux.c32,libcom32.c32,libutil.c32<span class="token punctuation">&#125;</span> /var/lib/tftpboot/

<span class="token comment">#最终目录结构如下</span>
<span class="token punctuation">[</span>root@centos8 centos<span class="token punctuation">]</span><span class="token variable">$cd</span> /var/lib/tftpboot/
<span class="token punctuation">[</span>root@centos8 tftpboot<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── centos6
│   ├── initrd.img
│   └── vmlinuz
├── centos7
│   ├── initrd.img
│   └── vmlinuz
├── centos8
│   ├── initrd.img
│   └── vmlinuz
├── ldlinux.c32
├── libcom32.c32
├── libutil.c32
├── menu.c32
├── pxelinux.0
└── pxelinux.cfg
    └── default

<span class="token number">4</span> directories, <span class="token number">12</span> files</code></pre>

<ol start="7">
<li><p>准备启动菜单文件</p>
<p>修改&#x2F;var&#x2F;lib&#x2F;tftpboot&#x2F;pxelinux.cfg&#x2F;default</p>
</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash">default menu.c32
<span class="token function">timeout</span> <span class="token number">600</span>
menu title Install CentOS Linux

label linux8
	menu label Auto Install CentOS Linux ^8
	kernel centos8/vmlinuz
	append <span class="token assign-left variable">initrd</span><span class="token operator">=</span>centos8/initrd.img <span class="token assign-left variable">inst.ks</span><span class="token operator">=</span>http://10.0.0.8/ks/centos8.cfg

label linux7
	menu label Auto Install CentOS Linux ^7
	kernel centos7/vmlinuz
	append <span class="token assign-left variable">initrd</span><span class="token operator">=</span>centos7/initrd.img <span class="token assign-left variable">inst.ks</span><span class="token operator">=</span>http://10.0.0.8/ks/centos7.cfg

label linux6
	menu label Auto Install CentOS Linux ^6
	kernel centos6/vmlinuz
	append <span class="token assign-left variable">initrd</span><span class="token operator">=</span>centos6/initrd.img <span class="token assign-left variable">inst.ks</span><span class="token operator">=</span>http://10.0.0.8/ks/centos6.cfg

label manual
	menu label ^Manual Install CentOS Linux <span class="token number">8.0</span>
	kernel centos8/vmlinuz
	append <span class="token assign-left variable">initrd</span><span class="token operator">=</span>centos8/initrd.img <span class="token assign-left variable">inst.repo</span><span class="token operator">=</span>http://10.0.0.8/centos/8/os/x86_64/

label rescue
	menu label ^Rescue a CentOS Linux system <span class="token number">8</span>
	kernel centos8/vmlinuz
	append <span class="token assign-left variable">initrd</span><span class="token operator">=</span>centos8/initrd.img <span class="token assign-left variable">inst.repo</span><span class="token operator">=</span>http://10.0.0.8/centos/8/os/x86_64/ rescue

label <span class="token builtin class-name">local</span>
	menu default
	menu label Boot from ^local drive
	localboot 0xffff</code></pre>

<ol start="8">
<li><p>新准备一台主机，设置网卡引导，可看到看启动菜单，并实现自动安装</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600181464577.png"></p>
<p>安装成功：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600182537433.png"></p>
</li>
</ol>
<h2 id="利用-cobbler-实现自动安装"><a href="#利用-cobbler-实现自动安装" class="headerlink" title="利用 cobbler 实现自动安装"></a>利用 cobbler 实现自动安装</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/ulimit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/ulimit/" class="post-title-link" itemprop="url">ulimit</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:04:11" itemprop="dateCreated datePublished" datetime="2020-12-09T23:04:11+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">加密和安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>控制 shell 程序的资源</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">ulimit</span> <span class="token punctuation">[</span>-SHacdefilmnpqrstuvx<span class="token punctuation">]</span> <span class="token punctuation">[</span>limit<span class="token punctuation">]</span></code></pre>

<img data-src="//img.to2b.cn/blog/ljk/1599967263678.png"  />

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>ulimit 命令，立即生效，但无法保存，永久保存需要修改配置文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/security/limits.conf
/etc/security/limits.d/*.conf

<span class="token comment"># 配置文件格式：每行一个定义</span>
<span class="token operator">&lt;</span>domain<span class="token operator">></span> <span class="token operator">&lt;</span>type<span class="token operator">></span> <span class="token operator">&lt;</span>item<span class="token operator">></span> <span class="token operator">&lt;</span>value<span class="token operator">></span>

*          soft    nproc     <span class="token number">4096</span>
root       soft    nproc     unlimited</code></pre>

<p>配置文件详细信息：<code>man 5 limits.conf</code></p>
<h3 id="domain"><a href="#domain" class="headerlink" title="domain"></a>domain</h3><table>
<thead>
<tr>
<th>domain</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>一个用户</td>
</tr>
<tr>
<td>@group</td>
<td>组内所有用户</td>
</tr>
<tr>
<td>*</td>
<td>所有用户</td>
</tr>
<tr>
<td>%</td>
<td>限制最多有多少用户登录，%对*生效，限制组使用%group</td>
</tr>
<tr>
<td><min_uid>:<max_uid></td>
<td></td>
</tr>
<tr>
<td>@<min_gid>:<max_gid></td>
<td></td>
</tr>
<tr>
<td>%:<gid></td>
<td></td>
</tr>
</tbody></table>
<h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><table>
<thead>
<tr>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>hard</td>
<td>软限制,普通用户自己可以修改</td>
</tr>
<tr>
<td>soft</td>
<td>硬限制,由 root 用户设定，且通过 kernel 强制生效</td>
</tr>
<tr>
<td>-</td>
<td>二者同时限定</td>
</tr>
</tbody></table>
<h3 id="item"><a href="#item" class="headerlink" title="item"></a>item</h3><table>
<thead>
<tr>
<th>item</th>
<th>default</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>core</td>
<td></td>
<td></td>
</tr>
<tr>
<td>data</td>
<td></td>
<td></td>
</tr>
<tr>
<td>fsize</td>
<td></td>
<td></td>
</tr>
<tr>
<td>memlock</td>
<td></td>
<td>最大锁定内存地址空间</td>
</tr>
<tr>
<td>nofile</td>
<td>1024</td>
<td>所能够同时打开的最大文件数量</td>
</tr>
<tr>
<td>rss</td>
<td></td>
<td></td>
</tr>
<tr>
<td>stack</td>
<td></td>
<td></td>
</tr>
<tr>
<td>cpu</td>
<td></td>
<td></td>
</tr>
<tr>
<td>nproc</td>
<td>1024</td>
<td>所能够同时运行的进程的最大数量</td>
</tr>
<tr>
<td>as</td>
<td></td>
<td></td>
</tr>
<tr>
<td>maxlogins</td>
<td></td>
<td></td>
</tr>
<tr>
<td>maxsyslogins</td>
<td></td>
<td></td>
</tr>
<tr>
<td>priority</td>
<td></td>
<td></td>
</tr>
<tr>
<td>locks</td>
<td></td>
<td></td>
</tr>
<tr>
<td>sigpending</td>
<td></td>
<td></td>
</tr>
<tr>
<td>msgqueue</td>
<td></td>
<td>POSIX 消息队列所使用的最大内存</td>
</tr>
<tr>
<td>nice</td>
<td></td>
<td></td>
</tr>
<tr>
<td>rtprio</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">*               soft    core            <span class="token number">0</span>
*               hard    nofile          <span class="token number">512</span>
@student        hard    nproc           <span class="token number">20</span>
@faculty        soft    nproc           <span class="token number">20</span>
@faculty        hard    nproc           <span class="token number">50</span>
<span class="token function">ftp</span>             hard    nproc           <span class="token number">0</span>
@student        -       maxlogins       <span class="token number">4</span>
:123            hard    cpu             <span class="token number">5000</span>
@500:           soft    cpu             <span class="token number">10000</span>
<span class="token number">600</span>:700         hard    locks           <span class="token number">10</span></code></pre>

<p>生产案例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">* - core unlimited
* - nproc <span class="token number">1000000</span>
* - nofile <span class="token number">1000000</span>
* - memlock <span class="token number">32000</span>
* - msgqueue <span class="token number">8192000</span></code></pre>

<p>案例：ulimit 命令修改用户打开的文件个数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ulimit -n</span>
<span class="token number">1024</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ulimit -n 1048577</span>
-bash: ulimit: <span class="token function">open</span> files: cannot modify limit: Operation not permitted
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ulimit -n 1048576</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ulimit -a</span>
core <span class="token function">file</span> size <span class="token punctuation">(</span>blocks, -c<span class="token punctuation">)</span> unlimited
data seg size <span class="token punctuation">(</span>kbytes, -d<span class="token punctuation">)</span> unlimited
scheduling priority <span class="token punctuation">(</span>-e<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token function">file</span> size <span class="token punctuation">(</span>blocks, -f<span class="token punctuation">)</span> unlimited
pending signals <span class="token punctuation">(</span>-i<span class="token punctuation">)</span> <span class="token number">7111</span>
max locked memory <span class="token punctuation">(</span>kbytes, -l<span class="token punctuation">)</span> <span class="token number">16384</span>
max memory size <span class="token punctuation">(</span>kbytes, -m<span class="token punctuation">)</span> unlimited
<span class="token function">open</span> files <span class="token punctuation">(</span>-n<span class="token punctuation">)</span> <span class="token number">1048576</span>
pipe size <span class="token punctuation">(</span><span class="token number">512</span> bytes, -p<span class="token punctuation">)</span> <span class="token number">8</span>
POSIX message queues <span class="token punctuation">(</span>bytes, -q<span class="token punctuation">)</span> <span class="token number">819200</span>
real-time priority <span class="token punctuation">(</span>-r<span class="token punctuation">)</span> <span class="token number">0</span>
stack size <span class="token punctuation">(</span>kbytes, -s<span class="token punctuation">)</span> <span class="token number">8192</span>
cpu <span class="token function">time</span> <span class="token punctuation">(</span>seconds, -t<span class="token punctuation">)</span> unlimited
max user processes <span class="token punctuation">(</span>-u<span class="token punctuation">)</span> <span class="token number">7111</span>
virtual memory <span class="token punctuation">(</span>kbytes, -v<span class="token punctuation">)</span> unlimited
<span class="token function">file</span> locks <span class="token punctuation">(</span>-x<span class="token punctuation">)</span> unlimited
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#echo 2^20|bc</span>
<span class="token number">1048576</span>
</code></pre>

<p>案例：限制用户最多打开的文件数和运行进程数，并持久保存</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/pam.d/system-auth
session required pam_limits.so

<span class="token function">vim</span> /etc/security/limits.conf
<span class="token comment">#用户apache可打开10240个文件</span>
apache - nofile <span class="token number">10240</span>
<span class="token comment">#用户student不能运行超过20个进程</span>
student hard nproc <span class="token number">10</span>

<span class="token comment">#用student登录多次运行bash，观察结果</span>

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/security/limits.conf</span>
wang - nofile <span class="token number">66666</span>
wang - nproc <span class="token number">5</span>
mage - nofile <span class="token number">88888</span>

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#su - wang</span>
Last login: Mon May <span class="token number">25</span> <span class="token number">14</span>:40:38 CST <span class="token number">2020</span> on pts/0
<span class="token punctuation">[</span>wang@centos8 ~<span class="token punctuation">]</span><span class="token variable">$ulimit</span> <span class="token parameter variable">-n</span>
<span class="token number">66666</span></code></pre>

<p>案例：限制 mage 用户最大的同时登录次数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#tail -n1 /etc/security/limits.conf</span>
mage - maxlogins <span class="token number">2</span>

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#who</span>
mage tty1 <span class="token number">2020</span>-05-25 <span class="token number">14</span>:35
root pts/0 <span class="token number">2020</span>-05-25 <span class="token number">14</span>:35 <span class="token punctuation">(</span><span class="token number">10.0</span>.0.1<span class="token punctuation">)</span>
root pts/3 <span class="token number">2020</span>-05-25 <span class="token number">14</span>:06 <span class="token punctuation">(</span><span class="token number">10.0</span>.0.1<span class="token punctuation">)</span>
mage tty3 <span class="token number">2020</span>-05-25 <span class="token number">14</span>:35</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1599923961894.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSL%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSL%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">OpenSSL命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:03:59" itemprop="dateCreated datePublished" datetime="2020-12-09T23:03:59+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">加密和安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img data-src="//img.to2b.cn/blog/ljk/1599473431892.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">openssl <span class="token builtin class-name">command</span> <span class="token punctuation">[</span> command_opts <span class="token punctuation">]</span> <span class="token punctuation">[</span> command_args <span class="token punctuation">]</span></code></pre>

<p>两种运行模式：交互模式、<strong>批处理模式</strong></p>
<p>直接输入 openssl 回车进入交互模式，输入带命令选项的 openssl 进入批处理模式。</p>
<p>OpenSSL 整个软件包大概可以分成三个主要的功能部分：<strong>密码算法库</strong>、<strong>SSL 协议库</strong>以及<strong>应用程序</strong>。OpenSSL 的目录结构自然也是围绕这三个功能部分进行规划的。</p>
<p>openssl 子命令分为三类：1、标准命令、2、消息摘要命令、3、加密命令</p>
<p>标准命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> list <span class="token parameter variable">-commands</span>
asn1parse         ca                ciphers           cms
crl               crl2pkcs7         dgst              dhparam
dsa               dsaparam          ec                ecparam
enc               engine            errstr            gendsa
genpkey           genrsa            <span class="token builtin class-name">help</span>              list
nseq              ocsp              <span class="token function">passwd</span>            pkcs12
pkcs7             pkcs8             pkey              pkeyparam
pkeyutl           prime             rand              rehash
req               rsa               rsautl            s_client
s_server          s_time            sess_id           smime
speed             spkac             srp               storeutl
ts                verify            version           x509</code></pre>

<p>消息摘要命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> list -digest-commands
blake2b512        blake2s256        gost              md2
md4               md5               rmd160            sha1
sha224            sha256            sha3-224          sha3-256
sha3-384          sha3-512          sha384            sha512
sha512-224        sha512-256        shake128          shake256
sm3</code></pre>

<p>加密命令：对称加密和 base64 编码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> list -cipher-commands
aes-128-cbc       aes-128-ecb       aes-192-cbc       aes-192-ecb
aes-256-cbc       aes-256-ecb       aria-128-cbc      aria-128-cfb
aria-128-cfb1     aria-128-cfb8     aria-128-ctr      aria-128-ecb
aria-128-ofb      aria-192-cbc      aria-192-cfb      aria-192-cfb1
aria-192-cfb8     aria-192-ctr      aria-192-ecb      aria-192-ofb
aria-256-cbc      aria-256-cfb      aria-256-cfb1     aria-256-cfb8
aria-256-ctr      aria-256-ecb      aria-256-ofb      base64
bf                bf-cbc            bf-cfb            bf-ecb
bf-ofb            camellia-128-cbc  camellia-128-ecb  camellia-192-cbc
camellia-192-ecb  camellia-256-cbc  camellia-256-ecb  cast
cast-cbc          cast5-cbc         cast5-cfb         cast5-ecb
cast5-ofb         des               des-cbc           des-cfb
des-ecb           des-ede           des-ede-cbc       des-ede-cfb
des-ede-ofb       des-ede3          des-ede3-cbc      des-ede3-cfb
des-ede3-ofb      des-ofb           des3              desx
idea              idea-cbc          idea-cfb          idea-ecb
idea-ofb          rc2               rc2-40-cbc        rc2-64-cbc
rc2-cbc           rc2-cfb           rc2-ecb           rc2-ofb
rc4               rc4-40            rc5               rc5-cbc
rc5-cfb           rc5-ecb           rc5-ofb           seed
seed-cbc          seed-cfb          seed-ecb          seed-ofb
zlib</code></pre>

<p>消息摘要命令和加密命令初学不推荐直接使用，推荐通过标准命令 dgst 和 enc 调用。</p>
<h2 id="command"><a href="#command" class="headerlink" title="command"></a>command</h2><pre class="language-bash" data-language="bash"><code class="language-bash">version  <span class="token comment"># 查看版本信息</span>
enc      <span class="token comment"># 对称加密</span>
dgst     <span class="token comment"># 摘要</span>
dhparam  <span class="token comment"># 生成DH参数文件</span>
dsaparam <span class="token comment"># 生成DSA参数文件</span>
gendsa   <span class="token comment"># 从DSA参数文件生成DSA私钥</span>
dsa      <span class="token comment"># 管理DSA密钥，可以给解密加密的私钥，可以给私钥设置密码，还可以从DSA私钥中生成公钥</span>
<span class="token function">passwd</span>   <span class="token comment"># 生成密码</span>
rand     <span class="token comment"># 生成随机数</span>
ca       <span class="token comment"># CA管理，例如对证书进行签名</span>
req      <span class="token comment"># 主要用于创建和处理PKCS#10格式的证书请求，可以创建自签名证书</span>
x509     <span class="token comment"># 显示证书信息、将证书转换为各种形式、签署类似“迷你CA”的证书请求或编辑证书信任设置</span></code></pre>

<p><a target="_blank" rel="noopener" href="http://linux.51yip.com/search/openssl">http://linux.51yip.com/search/openssl</a></p>
<p><strong>1. 对称加密：</strong></p>
<blockquote>
<p>OpenSSL 一共提供了 8 种对称加密算法，DES 是最常用的。</p>
</blockquote>
<p><strong>2. 非对称加密：</strong></p>
<blockquote>
<p>OpenSSL 一共实现了 4 种非对称加密算法，包括 DH 算法、RSA 算法、DSA 算法和椭圆曲线算法（EC）。DH 算法一般用户密钥交换。RSA 算法既可以用于密钥交换，也可以用于数字签名，当然，如果你能够忍受其缓慢的速度，那么也可以用于数据加密。DSA 算法则一般只用于数字签名。</p>
</blockquote>
<p><strong>3. 信息摘要算法：</strong></p>
<blockquote>
<p>OpenSSL 实现了 5 种信息摘要算法，分别是 MD2、MD5、MDC2、SHA（SHA1）和 RIPEMD。SHA 算法事实上包括了 SHA 和 SHA1 两种信息摘要算法，此外，OpenSSL 还实现了 DSS 标准中规定的两种信息摘要算法 DSS 和 DSS1。</p>
</blockquote>
<p><strong>4. 密钥和证书管理：</strong></p>
<p>OpenSSL 为密钥和证书提供了丰富的功能，支持多种标准。</p>
<blockquote>
<p>首先，OpenSSL 实现了 ASN.1 的证书和密钥相关标准，提供了对证书、公钥、私钥、证书请求以及 CRL 等数据对象的 DER、PEM 和 BASE64 的编解码功能。OpenSSL 提供了产生各种公开密钥对和对称密钥的方法、函数和应用程序，同时提供了对公钥和私钥的 DER 编解码功能。并实现了私钥的 PKCS#12 和 PKCS#8 的编解码功能。OpenSSL 在标准中提供了对私钥的加密保护功能，使得密钥可以安全地进行存储和分发。</p>
<p>在此基础上，OpenSSL 实现了对证书的 X.509 标准编解码、PKCS#12 格式的编解码以及 PKCS#7 的编解码功能。并提供了一种文本数据库，支持证书的管理功能，包括证书密钥产生、请求产生、证书签发、吊销和验证等功能。</p>
<p><strong>事实上，OpenSSL 提供的 CA 应用程序就是一个小型的证书管理中心（CA），实现了证书签发的整个流程和证书管理的大部分机制。</strong></p>
</blockquote>
<h3 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h3><p>openssl 提供了两种方式调用对称加密算法：</p>
<p>一种就是直接调用对称加密指令；一种是使用 enc，对称加密指令作为 enc 的参数。例如下面两种写法是完全一样的：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">openssl des-cbc <span class="token parameter variable">-in</span> plain.txt <span class="token parameter variable">-out</span> encrypt.txt <span class="token parameter variable">-pass</span> pass:12345678</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">openssl enc -des-cbc <span class="token parameter variable">-in</span> plain.txt <span class="token parameter variable">-out</span> encrypt.txt <span class="token parameter variable">-pass</span> pass:12345678</code></pre>

<p>初学推荐使用 enc，更宜读</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">openssl enc <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>.</code></pre>

<ul>
<li><p>-help</p>
</li>
<li><p>-ciphers：列出所有 enc 的对称加密算法 option，上面的示例中的 -des-cba 就在其中</p>
</li>
<li><p>-in file：从 file 中读取内容，默认是从标准输入中读取</p>
</li>
<li><p>-out file：输出到 file，默认是输出到标准输出</p>
</li>
<li><p>-pass arg：设置加密或解密密码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 加密</span>
openssl enc <span class="token parameter variable">-des3</span> <span class="token parameter variable">-in</span> a.log <span class="token parameter variable">-out</span> b.bin <span class="token parameter variable">-pass</span> pass:123456
<span class="token comment"># 解密</span>
openssl enc <span class="token parameter variable">-des3</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-in</span> b.bin <span class="token parameter variable">-out</span> b.log <span class="token parameter variable">-pass</span> pass:123456
<span class="token comment"># 命令行输入密码</span>
pass:123456
<span class="token comment"># 文件输入密码</span>
file:passwd.txt
<span class="token comment"># 环境变量输入密码</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token number">123456</span>
env:passwd
<span class="token comment"># 从文件描述符输入密码</span>
fd:1
<span class="token comment"># 从标准输入输入密码</span>
<span class="token comment"># stdin</span></code></pre>
</li>
<li><p>-e：加密，默认选项，可以省略</p>
</li>
<li><p>-d：解密</p>
</li>
<li><p>-a：base64 虽然不是加密，但是 enc 也支持了 base64 编码</p>
</li>
<li><p>-base64：同 -a</p>
</li>
<li><p>-A：如果设置了-a，则-A 让 base64 输出的结果不分行</p>
</li>
<li><p>-k：已淘汰</p>
</li>
<li><p>-md：指定 hash 算法，将 hash 处理后的 passwd 作为密码</p>
</li>
<li><p>-S：手动指定盐值</p>
</li>
</ul>
<h3 id="摘要算法"><a href="#摘要算法" class="headerlink" title="摘要算法"></a>摘要算法</h3><p>支持的摘要算法命令使用<code>openssl list -digest-commands</code>查看，可以作为 openssl 的子命令直接调用，也可以作为 dgst 的<strong>短选项</strong>调用。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> list -digest-commands
blake2b512        blake2s256        gost              md2
md4               md5               rmd160            sha1
sha224            sha256            sha3-224          sha3-256
sha3-384          sha3-512          sha384            sha512
sha512-224        sha512-256        shake128          shake256
sm3</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">dgst <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>file<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<p>file…：files to digest (default is stdin)</p>
<ul>
<li>-help Display this summary</li>
<li>-c 输出的摘要信息以分号隔离，和-hex 同时使用</li>
<li>-out outfile 指定输出文件，默认标准输出</li>
<li>-、、、</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 标准输入 生成摘要</span>
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span><span class="token punctuation">&#125;</span> <span class="token operator">|</span> openssl md5
<span class="token punctuation">(</span>stdin<span class="token punctuation">)</span><span class="token operator">=</span> da0feb828a99053332f6d08e0a58f33e
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span><span class="token punctuation">&#125;</span> <span class="token operator">|</span> openssl dgst <span class="token parameter variable">-md5</span>
<span class="token punctuation">(</span>stdin<span class="token punctuation">)</span><span class="token operator">=</span> da0feb828a99053332f6d08e0a58f33e
<span class="token comment"># 文件内容 生成摘要</span>
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> a.log
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> dgst <span class="token parameter variable">-md5</span> ./a.log
MD5<span class="token punctuation">(</span>./a.log<span class="token punctuation">)</span><span class="token operator">=</span> da0feb828a99053332f6d08e0a58f33e
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> dgst <span class="token parameter variable">-out</span> a.md5 <span class="token parameter variable">-md5</span> ./a.log
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$cat</span> a.md5
MD5<span class="token punctuation">(</span>./a.log<span class="token punctuation">)</span><span class="token operator">=</span> da0feb828a99053332f6d08e0a58f33e</code></pre>

<p>补充：coreutils 包提供了很多核心工具，例如 cat、cp、ls 等等，其中也有摘要算法相关的工具：md5sum，sha1sum，sha224sum，sha256sum ，sha384sum，sha512sum 等，以 md5 为例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">md5sum <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.</code></pre>

<h3 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h3><p>非对称加密相关命令都是 openssl 的标准命令，没有额外再单独设置一个命令管理它们。</p>
<ul>
<li>dhparam：生成 DH 参数文件</li>
<li>dsaparam：生成 DSA 参数文件</li>
<li>gendsa：从 DSA 参数文件生成 DSA 私钥</li>
<li>dsa：管理 DSA 密钥，可以给解密加密的私钥，可以给私钥设置密码，还可以从 DSA 私钥中生成公钥</li>
<li>genrsa：生成 RSA 私钥</li>
<li>rsa：管理 RSA 密钥</li>
</ul>
<h4 id="DH（Diffie-Hellman）"><a href="#DH（Diffie-Hellman）" class="headerlink" title="DH（Diffie-Hellman）"></a>DH（Diffie-Hellman）</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用生成因子2和随机的1024-bit的素数产生D0ffie-Hellman参数</span>
<span class="token comment"># 输出保存到文件dhparam.pem</span>
openssl dhparam <span class="token parameter variable">-out</span> dhparam.pem <span class="token parameter variable">-2</span> <span class="token number">1024</span>

<span class="token comment"># 从dhparam.pem中读取Diffie-Hell参数，以C代码的形式</span>
<span class="token comment"># 输出到stdout</span>
penssl dhparam <span class="token parameter variable">-in</span> dhparam.pem <span class="token parameter variable">-noout</span> <span class="token parameter variable">-C</span></code></pre>

<h4 id="DSA"><a href="#DSA" class="headerlink" title="DSA"></a>DSA</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 生成1024位DSA参数集，并输出到文件dsaparam.pem</span>
openssl dsaparam <span class="token parameter variable">-out</span> dsaparam.pem <span class="token number">1024</span>

<span class="token comment"># 使用参数文件dsaparam.pem生成DSA私钥匙，</span>
<span class="token comment"># 采用3DES加密后输出到文件dsaprivatekey.pem</span>
openssl gendsa <span class="token parameter variable">-out</span> dsaprivatekey.pem <span class="token parameter variable">-des3</span> dsaparam.pem

<span class="token comment"># 使用私钥匙dsaprivatekey.pem生成公钥匙，</span>
<span class="token comment"># 输出到dsapublickey.pem</span>
openssl dsa <span class="token parameter variable">-in</span> dsaprivatekey.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> dsapublickey.pem

<span class="token comment"># 从dsaprivatekey.pem中读取私钥匙，解密并输入新口令进行加密，</span>
<span class="token comment"># 然后写回文件dsaprivatekey.pem</span>
openssl dsa <span class="token parameter variable">-in</span> dsaprivatekey.pem <span class="token parameter variable">-out</span> dsaprivatekey.pem <span class="token parameter variable">-des3</span> <span class="token parameter variable">-passin</span></code></pre>

<h3 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h3><p>生成私钥，并 3des 加密：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> genrsa <span class="token parameter variable">-out</span> rsa.key <span class="token parameter variable">-des3</span> <span class="token number">1024</span>
Generating RSA private key, <span class="token number">1024</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span>
Enter pass phrase <span class="token keyword">for</span> rsa.key:
Verifying - Enter pass phrase <span class="token keyword">for</span> rsa.key:
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$cat</span> rsa.key
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: <span class="token number">4</span>,ENCRYPTED
DEK-Info: DES-EDE3-CBC,B81F9992681E3346

fi2XSHajJUAhKHNeUFB+nJqog0R8qiBfQ3yEljQHadyq7U7P+7evDV9JQxpwtDC1
gZ3BpjY1+4NmN1lXbzoADLwx/tRIgHqQXgkIgY/tSeKTOtaaFbRsg7DZXjcq3YMX
seo8DoZEbyyzAVIYVdR/Z40niYNoaEWiXiwzT8Wz11BORftqJER+07s2NRDSpQNj
8Q7R9L6uT+RWnde5IeCZjZ9X9cj9ZBlMw1trKpiwbqTeq1YtRHcpKLSyg69f5ERy
sW9qaf00qNHR6LTHL3Hgw+EBo9JYmspflvhGWO0QmWKNbBLnjEGS6QgbxgxQT0mP
d0Imwn/3Xit8c/ACdoHZiqwYkzrreR9K7CHD2USiMlun08vcWyal3EzPOAfshZWq
g6MXdLSs3nOA03dkP4mjjb3iCca8xxSFKQPWb3viZzg14gWRAlVo1Fp9+0d+U1An
hHpqX/64MiPZakRPyGfPA6uycJgxIxKzhnam/mKSAFkQoxt61zKst9JFKWwCnEAv
ucKZXIGPJGsMW5bXkVFdMdnx3iUZDHFBQmFLuA5+w8CQTBw3wLY1PKfvtpoLY2S3
qP9xnqqjPzg+RzBgNvWPIQ+y5SECZq5CdnGK/vLrysUBy3eUdfgiyZ5h7i2Bugnu
wieFH5FvaGHAljN6tcGo4xPjfPb+SEujkl+Ot6R1lCzHXvEgvaCBVBN5qx5rFH9H
CQ8ZeIKjs/jscCvgMhqhzRfOkhzvKruShQ1G3t1prvZ5JNZCy0ePkh/g9PMxIaVv
DIZbEiA+Yy5NrXmkCxHmVIACg4mxetPJCtg7yTG4P/dQKE/3PPLwZA<span class="token operator">==</span>
-----END RSA PRIVATE KEY-----</code></pre>

<p>解密私钥：</p>
<p>不需要指定加密用的算法</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> rsa <span class="token parameter variable">-in</span> rsa.key
Enter pass phrase <span class="token keyword">for</span> rsa.key:
writing RSA key
-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQC3SFoUHD+Jk8dt2l7MWqDvhDUF/jMlzCMs2VhnWytPdWWjTHeO
zNj0rt6L8uMq45C3CmTzaBz6v6fdAH5RKLkv78ZqjhxfRwIgRtUCRCa+b+lqq0qc
9paKTFl+gAnSAkx0ua90XAx65DAs9XpL5HkGHI7Jj7Cb0ERluZNV0Sv8YwIDAQAB
AoGAfB61UfUnWiYH4m8Fz+J4Jnwj5GEXhjtOfurZoXTuSas5H3ODa+Nx8ZITCDd+
e+cMc8jIQMZ7CZyNM29IG/I2JgkXEk6apyLy7UAiQF0CbYljLOy7qBkrcYCo2RBa
IGUoTX7RJwC+3Dxa3/12Tx4ufqZ5/+RAJoqqV90rx8EFLnECQQDat+/KaEte9xJ0
+NgmOGna68p4B1zNR/LQ5/n3yEweBLaseOke2o3BnsIAcL5LLNC5d3jun9UWyl2R
Xtflcly/AkEA1oYgAs//M4M/o3bZxYBaQkWiC+u+YsKMwMA+DPYs/H2fzwprP+4N
mjoKYrjL214nchuDE1fM1YErcvkn5AN1XQJBAJCDVBbizloS2ckb2oV2ZMrXXNHt
221vioppnAoR9+klqCVRRoayVVOHOBveYn19QPQqcmcIiF0knKo+hlv+MjUCQDw/
syHXFM983xSjvomvgKn4MIi0juXhyfIgi8zMHtpS1d0qCfEMhJl6D4ymZeqYSO/N
NkTqdcbI3lEOFNv+9KkCQHGLnBuVcZ6IaneTIl6Dj5fuSH4JcTgWpeXJNbfWO+iR
<span class="token assign-left variable">7bpy5LnVqTM2rrvEjAdhMOD5xLbaxwRxSAMnG9lDyD8</span><span class="token operator">=</span>
-----END RSA PRIVATE KEY-----</code></pre>

<p>从私钥中生成公钥：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> rsa <span class="token parameter variable">-in</span> rsa.key <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> rsa.key.pub
Enter pass phrase <span class="token keyword">for</span> rsa.key:
writing RSA key
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$cat</span> rsa.key.pub
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC3SFoUHD+Jk8dt2l7MWqDvhDUF
/jMlzCMs2VhnWytPdWWjTHeOzNj0rt6L8uMq45C3CmTzaBz6v6fdAH5RKLkv78Zq
jhxfRwIgRtUCRCa+b+lqq0qc9paKTFl+gAnSAkx0ua90XAx65DAs9XpL5HkGHI7J
j7Cb0ERluZNV0Sv8YwIDAQAB
-----END PUBLIC KEY-----</code></pre>

<h3 id="生成用户密码"><a href="#生成用户密码" class="headerlink" title="生成用户密码"></a>生成用户密码</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">passwd</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>passwords<span class="token punctuation">&#125;</span></code></pre>

<p>默认使用 标准 Unix 密码算法 生成密码：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> <span class="token function">passwd</span> <span class="token number">123456</span>
pPVKzob9muWhI
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> <span class="token function">passwd</span> <span class="token number">123456</span>
RGMogKjCYuqRo
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> <span class="token function">passwd</span> <span class="token number">123456</span> admin
RmxJ4CJbLmGUs
ziknRF1V5vFSs</code></pre>

<p><strong>options：</strong></p>
<ul>
<li>-in file：从文件中读入密码，默认交互式输入</li>
<li>-stdin：从标准输入读取密码，默认交互式输入</li>
<li>-salt val：加盐，指定盐值</li>
<li>-6：SHA512</li>
<li>-5：SHA256</li>
<li>-1：MD5</li>
<li>-、、、</li>
</ul>
<h3 id="生成随机数"><a href="#生成随机数" class="headerlink" title="生成随机数"></a>生成随机数</h3><p>&#x2F;dev&#x2F;random 和&#x2F;dev&#x2F;urandom 根据硬件信息生成随机数，是伪随机数生成器，openssl rand 是真随机数生成器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">rand <span class="token punctuation">[</span>options<span class="token punctuation">]</span> num</code></pre>

<p>num：指定随机数的字节数。</p>
<p><strong>options：</strong></p>
<ul>
<li>-out file：将输出的随机数写入到文件</li>
<li>-base64：将输出的随机数转成 base64 格式</li>
<li>-hex：将输出的随机数转成 16 进制格式</li>
</ul>
<p>范例：生成 10 位随机数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#openssl rand -hex 5</span>
2ce882e4e7
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#openssl rand -base64 9 |head -c10</span>
7yTjuE+FAC</code></pre>

<h3 id="在-CentOS8-上实现私有-CA-和证书申请颁发"><a href="#在-CentOS8-上实现私有-CA-和证书申请颁发" class="headerlink" title="在 CentOS8 上实现私有 CA 和证书申请颁发"></a>在 CentOS8 上实现私有 CA 和证书申请颁发</h3><p>相关文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 tls<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-ql</span> openssl-libs
/etc/pki/tls
/etc/pki/tls/certs
/etc/pki/tls/ct_log_list.cnf
/etc/pki/tls/misc
/etc/pki/tls/openssl.cnf	<span class="token comment"># 配置文件</span>
/etc/pki/tls/private</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 私有CA 目录</span>

./demoCA                       - main CA directory
./demoCA/cacert.pem            - 证书，也就是自签名公钥
./demoCA/private/cakey.pem     - 自签名私钥
./demoCA/serial                - CA serial number <span class="token function">file</span>
./demoCA/serial.old            - CA serial number backup <span class="token function">file</span>
./demoCA/index.txt             - 数据库文件
./demoCA/index.txt.old         - CA text database backup <span class="token function">file</span>
./demoCA/certs                 - 颁发的证书存放目录
./demoCA/.rnd                  - CA random seed information</code></pre>

<h4 id="1-创建私有-CA"><a href="#1-创建私有-CA" class="headerlink" title="1. 创建私有 CA"></a>1. 创建私有 CA</h4><p>私有 CA 的目录位置在 openssl.conf 中可以更改，默认设置如下，我们就不改了。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span> CA_default <span class="token punctuation">]</span>

<span class="token function">dir</span>             <span class="token operator">=</span> /etc/pki/CA           <span class="token comment"># Where everything is kept</span>
certs           <span class="token operator">=</span> <span class="token variable">$dir</span>/certs            <span class="token comment"># Where the issued certs are kept</span>
crl_dir         <span class="token operator">=</span> <span class="token variable">$dir</span>/crl              <span class="token comment"># Where the issued crl are kept</span>
database        <span class="token operator">=</span> <span class="token variable">$dir</span>/index.txt        <span class="token comment"># database index file.</span>
<span class="token comment">#unique_subject = no                    # Set to 'no' to allow creation of</span>
                                        <span class="token comment"># several certs with same subject.</span>
new_certs_dir   <span class="token operator">=</span> <span class="token variable">$dir</span>/newcerts         <span class="token comment"># default place for new certs.</span>

certificate     <span class="token operator">=</span> <span class="token variable">$dir</span>/cacert.pem       <span class="token comment"># The CA certificate</span>
serial          <span class="token operator">=</span> <span class="token variable">$dir</span>/serial           <span class="token comment"># The current serial number</span>
crlnumber       <span class="token operator">=</span> <span class="token variable">$dir</span>/crlnumber        <span class="token comment"># the current crl number</span>
                                        <span class="token comment"># must be commented out to leave a V1 CRL</span>
crl             <span class="token operator">=</span> <span class="token variable">$dir</span>/crl.pem          <span class="token comment"># The current CRL</span>
private_key     <span class="token operator">=</span> <span class="token variable">$dir</span>/private/cakey.pem<span class="token comment"># The private key</span></code></pre>

<ol>
<li>按照 openssl.conf 中的设置，创建私有 CA 目录及相关文件</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /etc/pki/CA
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /etc/pki/CA
<span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span><span class="token variable">$mkdir</span> certs crl newcerts private
<span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span><span class="token variable">$touch</span> index.txt
<span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span><span class="token variable">$echo</span> 01 <span class="token operator">></span> serial	<span class="token comment"># 指定第一个颁发证书的序列号</span></code></pre>

<ol start="2">
<li>生成私钥，这里选择 RSA 私钥，比较简单</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span><span class="token variable">$openssl</span> genrsa <span class="token parameter variable">-out</span> private/cakey.pem <span class="token number">2048</span>
Generating RSA private key, <span class="token number">2048</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span></code></pre>

<ol start="3">
<li>生成 CA 自签名证书</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span><span class="token variable">$openssl</span> req <span class="token parameter variable">-new</span> <span class="token parameter variable">-x509</span> <span class="token parameter variable">-key</span> private/cakey.pem <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-out</span> cacert.pem
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Country Name <span class="token punctuation">(</span><span class="token number">2</span> letter code<span class="token punctuation">)</span> <span class="token punctuation">[</span>XX<span class="token punctuation">]</span>:CN
State or Province Name <span class="token punctuation">(</span>full name<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:henan
Locality Name <span class="token punctuation">(</span>eg, city<span class="token punctuation">)</span> <span class="token punctuation">[</span>Default City<span class="token punctuation">]</span>:
Organization Name <span class="token punctuation">(</span>eg, company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Default Company Ltd<span class="token punctuation">]</span>:
Organizational Unit Name <span class="token punctuation">(</span>eg, section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:
Common Name <span class="token punctuation">(</span>eg, your name or your server's <span class="token function">hostname</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:ljk
Email Address <span class="token punctuation">[</span><span class="token punctuation">]</span>:ljk@qq.com
<span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span><span class="token variable">$openssl</span> x509 <span class="token parameter variable">-noout</span> <span class="token parameter variable">-in</span> cacert.pem <span class="token parameter variable">-text</span>
Certificate:
    Data:
        Version: <span class="token number">3</span> <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
        Serial Number:
            <span class="token number">26</span>:c2:97:d3:b0:0e:f4:8d:d7:3e:1c:a1:e2:95:08:31:20:aa:f1:b7
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C <span class="token operator">=</span> CN, ST <span class="token operator">=</span> henan, L <span class="token operator">=</span> Default City, O <span class="token operator">=</span> Default Company Ltd, CN <span class="token operator">=</span> ljk, emailAddress <span class="token operator">=</span> ljk@qq.com
        Validity
            Not Before: Sep  <span class="token number">8</span> 08:17:04 <span class="token number">2020</span> GMT
            Not After <span class="token builtin class-name">:</span> Sep  <span class="token number">6</span> 08:17:04 <span class="token number">2030</span> GMT
        Subject: C <span class="token operator">=</span> CN, ST <span class="token operator">=</span> henan, L <span class="token operator">=</span> Default City, O <span class="token operator">=</span> Default Company Ltd, CN <span class="token operator">=</span> ljk, emailAddress <span class="token operator">=</span> ljk@qq.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: <span class="token punctuation">(</span><span class="token number">2048</span> bit<span class="token punctuation">)</span>
                Modulus:
                    00:bc:30:93:e4:81:8f:aa:ed:c7:27:c3:66:6b:17:
                    7d:f2:40:f2:1c:5e:12:86:89:5a:ca:e1:d2:6d:61:
                    fa:3c:0e:36:d6:88:bc:c3:1c:e9:a3:a4:f7:28:14:
                    4b:7f:5a:48:e0:1f:3e:3a:dc:45:12:27:a9:ef:94:
                    <span class="token number">51</span>:95:1b:84:79:ae:6b:11:3d:77:92:a4:72:ee:4a:
                    <span class="token number">47</span>:c9:c6:13:84:03:f7:be:48:48:8d:ac:d4:b5:7b:
                    fd:36:04:6a:90:22:6f:5d:06:cc:52:c6:21:a2:0f:
                    <span class="token number">48</span>:fb:d1:cb:5b:66:f7:05:e5:35:10:14:6a:07:bc:
                    <span class="token number">35</span>:66:fd:d9:c4:30:35:91:bb:ca:6c:bb:77:79:4d:
                    e2:9e:03:71:72:e4:bd:7b:cf:2e:96:30:0e:7e:2d:
                    <span class="token number">10</span>:c4:5a:b3:66:03:7a:68:95:78:e1:31:28:86:35:
                    <span class="token number">43</span>:f6:be:7c:b8:d2:36:8f:ed:d0:0e:0a:98:49:59:
                    <span class="token number">63</span>:42:45:70:f2:a1:8d:30:b9:6b:6f:b2:49:c9:e2:
                    ae:0c:08:b2:47:bf:48:c7:be:d6:e8:26:8c:21:07:
                    e4:a9:16:e9:f1:c6:30:e0:41:de:3c:d8:81:fd:fe:
                    <span class="token number">86</span>:b2:6f:b1:04:35:73:ac:67:36:a8:39:ee:ff:15:
                    6b:4c:30:7e:6f:dd:9e:02:16:af:ae:46:e1:5c:e9:
                    b1:e5
                Exponent: <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                <span class="token number">62</span>:CE:34:13:29:DA:F0:67:D8:CB:8D:6C:90:1A:3C:C8:E5:15:4D:D9
            X509v3 Authority Key Identifier:
                keyid:62:CE:34:13:29:DA:F0:67:D8:CB:8D:6C:90:1A:3C:C8:E5:15:4D:D9

            X509v3 Basic Constraints: critical
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
         4c:87:4d:25:3f:3d:5f:b9:9e:b1:35:2f:7e:be:26:da:6b:e0:
         4a:77:56:79:80:9e:a7:8b:80:02:71:75:1c:12:28:e7:73:49:
         c8:b4:44:41:3f:1a:b4:b6:db:8e:33:8e:29:8f:01:2f:9e:dc:
         <span class="token number">34</span>:1c:45:78:a2:8c:82:25:9e:da:5f:69:fb:3c:15:98:db:36:
         d7:a7:41:09:bc:b0:36:b7:ae:77:10:7a:7a:0e:00:ed:cd:22:
         <span class="token number">28</span>:99:d3:a1:28:47:cd:6a:01:88:e5:d4:cc:42:be:d5:2a:16:
         <span class="token number">72</span>:af:44:d8:b0:b9:83:99:e9:f3:08:c1:ea:f6:b1:11:ee:51:
         d7:83:b8:1e:7c:45:47:25:0d:bc:5e:9d:78:cc:c1:26:0c:33:
         5b:78:e5:1a:5f:31:79:11:54:a7:42:3a:dc:ed:43:66:b5:6c:
         e1:f5:61:82:d5:92:19:f6:6c:e8:20:01:b4:0a:07:9f:5b:63:
         1e:29:49:f0:58:4a:ed:ef:1a:67:a3:f1:ec:e3:e6:b3:50:3a:
         c4:5b:ef:23:55:13:69:0a:ac:42:77:22:4b:0b:34:c1:f4:e9:
         <span class="token number">80</span>:89:ff:ff:43:af:84:4e:a7:ef:f0:28:7a:14:c0:ce:f9:4b:
         aa:db:29:4b:fb:5c:ac:bf:c9:5f:ce:cd:45:62:dc:6e:18:a0:
         cc:f5:07:e9
<span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@centos8 CA<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── cacert.pem
├── certs
├── crl
├── index.txt
├── newcerts
├── private
│   └── cakey.pem
└── serial

<span class="token number">4</span> directories, <span class="token number">4</span> files</code></pre>

<p><strong>req</strong>：主要用于创建和处理 PKCS#10 格式的证书请求，可以创建自签名证书</p>
<ul>
<li>-new：生成新证书签署请求</li>
<li>-x509：专用于 CA 生成自签证书</li>
<li>-key：生成请求时用到的私钥文件</li>
<li>-days n：证书的有效期限</li>
<li>-out &#x2F;PATH&#x2F;TO&#x2F;SOMECERTFILE: 证书的保存路径</li>
<li>-key val：指定已有的秘钥文件生成秘钥请求，只与-new 配合</li>
<li>-newkey：与 <code>-key</code> 互斥，在生成证书请求或者自签名证书的时候自动生成密钥，生成的密钥名称由 <code>-keyout</code> 参数指定。当指定<code>-newkey</code> 选项时，后面指定 <code>rsa:bits</code> 说明产生 <code>rsa</code> 密钥，位数由 <code>bits</code> 指定。 <strong>如果没有指定选项<code>-key</code> 和<code>-newkey</code>，默认<code>-newkey</code></strong></li>
<li>-nodes：如果指定 <code>-newkey</code>，那么 <code>-nodes</code> 选项说明生成的秘钥不需要加密</li>
</ul>
<p><strong>x509</strong>：显示证书信息、将证书转换为各种形式、签署类似“迷你 CA”的证书请求或编辑证书信任设置</p>
<h4 id="2-申请证书并颁发证书"><a href="#2-申请证书并颁发证书" class="headerlink" title="2. 申请证书并颁发证书"></a>2. 申请证书并颁发证书</h4><ol>
<li>申请证书，就是申请一个认证过的公钥，首先生成私钥</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> genrsa <span class="token parameter variable">-out</span> test.key <span class="token number">2048</span>
Generating RSA private key, <span class="token number">2048</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span></code></pre>

<ol start="2">
<li>使用私钥生成证书申请文件</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> req <span class="token parameter variable">-new</span> <span class="token parameter variable">-key</span> ./test.key <span class="token parameter variable">-out</span> ./test.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Country Name <span class="token punctuation">(</span><span class="token number">2</span> letter code<span class="token punctuation">)</span> <span class="token punctuation">[</span>XX<span class="token punctuation">]</span>:CN
State or Province Name <span class="token punctuation">(</span>full name<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:henan
Locality Name <span class="token punctuation">(</span>eg, city<span class="token punctuation">)</span> <span class="token punctuation">[</span>Default City<span class="token punctuation">]</span>:
Organization Name <span class="token punctuation">(</span>eg, company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Default Company Ltd<span class="token punctuation">]</span>:
Organizational Unit Name <span class="token punctuation">(</span>eg, section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:
Common Name <span class="token punctuation">(</span>eg, your name or your server<span class="token string">'s hostname) []:ljk
Email Address []:ljk@qq.com

Please enter the following '</span>extra' attributes
to be sent with your certificate request
A challenge password <span class="token punctuation">[</span><span class="token punctuation">]</span>:123456
An optional company name <span class="token punctuation">[</span><span class="token punctuation">]</span>:ljk
</code></pre>

<p>三种策略：默认是 match</p>
<ul>
<li>match：要求申请填写的信息跟 CA 设置信息必须一致，</li>
<li>optional：可有可无，跟 CA 设置信息可不一致</li>
<li>supplied：必须填写这项申请信息</li>
</ul>
<ol start="3">
<li>CA 签署证书</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> ca <span class="token parameter variable">-in</span> ./test.csr <span class="token parameter variable">-out</span> /etc/pki/CA/certs/test.pem <span class="token parameter variable">-days</span> <span class="token number">100</span></code></pre>

<ol start="4">
<li>吊销证书</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看serial与subject信息，对比检验是否与index.txt文件中的信息一致，一致则删除</span>
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$openssl</span> x509 <span class="token parameter variable">-in</span> ./test.crt <span class="token parameter variable">-noout</span> <span class="token parameter variable">-serial</span> <span class="token parameter variable">-subject</span>
<span class="token assign-left variable">serial</span><span class="token operator">=</span>01
<span class="token assign-left variable">subject</span><span class="token operator">=</span>C <span class="token operator">=</span> CN, ST <span class="token operator">=</span> henan, O <span class="token operator">=</span> Default Company Ltd, CN <span class="token operator">=</span> ljk, emailAddress <span class="token operator">=</span> ljk@qq.com
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$cat</span> <span class="token punctuation">..</span>/index.txt
V       201217092506Z           01      unknown /C<span class="token operator">=</span>CN/ST<span class="token operator">=</span>henan/O<span class="token operator">=</span>Default Company Ltd/CN<span class="token operator">=</span>ljk/emailAddress<span class="token operator">=</span>ljk@qq.com

<span class="token comment"># 吊销之前，查看一下状态</span>
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$openssl</span> ca <span class="token parameter variable">-status</span> <span class="token number">1</span>
Using configuration from /etc/pki/tls/openssl.cnf
<span class="token assign-left variable">01</span><span class="token operator">=</span>Valid <span class="token punctuation">(</span>V<span class="token punctuation">)</span>

<span class="token comment"># 吊销，注意目录</span>
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$openssl</span> ca <span class="token parameter variable">-revoke</span> <span class="token punctuation">..</span>/newcerts/01.pem
Using configuration from /etc/pki/tls/openssl.cnf
Revoking Certificate 01.
Data Base Updated

<span class="token comment"># 吊销之后，再看一下状态</span>
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$openssl</span> ca <span class="token parameter variable">-status</span> <span class="token number">1</span>
Using configuration from /etc/pki/tls/openssl.cnf
<span class="token assign-left variable">01</span><span class="token operator">=</span>Revoked <span class="token punctuation">(</span>R<span class="token punctuation">)</span>

<span class="token comment"># 指定第一个吊销证书的编号,注意：第一次更新证书吊销列表前，才需要执行</span>
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$echo</span> 01 <span class="token operator">></span> /etc/pki/CA/crlnumber
<span class="token comment"># 更新证书吊销列表</span>
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$openssl</span> ca <span class="token parameter variable">-gencrl</span> <span class="token parameter variable">-out</span> /etc/pki/CA/crl.pem
Using configuration from /etc/pki/tls/openssl.cnf

<span class="token comment"># 查看crl文件</span>
<span class="token punctuation">[</span>root@centos8 certs<span class="token punctuation">]</span><span class="token variable">$openssl</span> crl <span class="token parameter variable">-in</span> /etc/pki/CA/crl.pem <span class="token parameter variable">-noout</span> <span class="token parameter variable">-text</span>
Certificate Revocation List <span class="token punctuation">(</span>CRL<span class="token punctuation">)</span>:
        Version <span class="token number">2</span> <span class="token punctuation">(</span>0x1<span class="token punctuation">)</span>
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C <span class="token operator">=</span> CN, ST <span class="token operator">=</span> henan, L <span class="token operator">=</span> Default City, O <span class="token operator">=</span> Default Company Ltd, CN <span class="token operator">=</span> ljk, emailAddress <span class="token operator">=</span> ljk@qq.com
        Last Update: Sep  <span class="token number">8</span> 09:39:42 <span class="token number">2020</span> GMT
        Next Update: Oct  <span class="token number">8</span> 09:39:42 <span class="token number">2020</span> GMT
        CRL extensions:
            X509v3 CRL Number:
                <span class="token number">1</span>
Revoked Certificates:
    Serial Number: 01
        Revocation Date: Sep  <span class="token number">8</span> 09:35:55 <span class="token number">2020</span> GMT
    Signature Algorithm: sha256WithRSAEncryption
         09:a1:00:89:ed:5a:4d:71:3d:39:f0:34:72:7a:df:49:91:a1:
         <span class="token number">82</span>:86:4f:76:7f:f9:b9:54:13:b1:b5:05:18:aa:4b:88:28:33:
         7a:cf:0e:e5:ff:e4:41:36:33:62:95:82:20:aa:de:1e:76:f5:
         <span class="token number">61</span>:10:11:d7:1e:da:19:2e:cc:b5:3a:96:17:4d:98:b2:f3:23:
         <span class="token number">78</span>:1a:af:20:7b:e9:f9:eb:3a:a7:b5:58:46:67:c1:60:8c:e6:
         2f:79:3b:16:24:f6:09:fc:09:12:96:de:60:09:2e:78:60:e4:
         <span class="token number">18</span>:1a:36:aa:b2:eb:a1:31:23:7c:33:9a:dc:59:7c:b0:dd:a6:
         fa:a6:72:23:9b:35:b7:4e:d3:98:44:49:44:66:9c:d4:82:56:
         07:0d:23:da:1e:62:3e:6e:87:de:9e:6e:88:0f:0d:e7:50:3f:
         <span class="token number">67</span>:9f:3f:86:89:c3:6a:bc:b8:bc:89:c4:8e:e8:d6:7b:12:81:
         7f:85:07:3b:e0:34:d7:29:fd:67:fb:cb:7f:f3:51:f2:3f:a4:
         <span class="token number">68</span>:ce:e2:f1:3c:c2:49:fd:72:e0:27:f5:e6:23:e8:ae:a6:8f:
         b4:ba:eb:bc:1b:c3:4b:dd:1b:9e:39:5e:a8:ed:87:1d:5b:9f:
         ef:42:02:68:2a:b4:c3:2d:31:24:3c:85:e7:d7:66:40:e2:07:
         2e:61:77:0f</code></pre>

<h4 id="3-说明"><a href="#3-说明" class="headerlink" title="3. 说明"></a>3. 说明</h4><p>以上是常规的步骤，为了方便，还有其他简单的操作，例如在一个目录中创建 CA，并给 harbor 主机颁发证书，只需要三步：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@u1:~$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/harbor/certs
root@u1:~$ <span class="token builtin class-name">cd</span> /usr/local/harbor/certs
root@u1:/usr/local/harbor/certs$
<span class="token comment"># 1. 创建私有CA</span>
root@u1:/usr/local/harbor/certs$ openssl req <span class="token punctuation">\</span>
<span class="token parameter variable">-newkey</span> rsa:1024 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-keyout</span> ca.key <span class="token parameter variable">-x509</span> <span class="token parameter variable">-subj</span> <span class="token string">"/CN=ca.ljk.org"</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-out</span> ca.crt
Generating a RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
writing new private key to <span class="token string">'ca.key'</span>
-----
root@u1:/usr/local/harbor/certs$ <span class="token function">ls</span>
ca.crt  ca.key
<span class="token comment"># 2. 生成harbor主机的证书申请</span>
root@u1:/usr/local/harbor/certs$ openssl req <span class="token punctuation">\</span>
<span class="token parameter variable">-newkey</span> rsa:1024 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-subj</span> <span class="token string">"/CN=harbor.ljk.org"</span> <span class="token parameter variable">-keyout</span> harbor.ljk.org.key <span class="token parameter variable">-out</span> harbor.ljk.org.csr
Generating a RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
writing new private key to <span class="token string">'harbor.ljk.org.key'</span>
-----
root@u1:/usr/local/harbor/certs$ <span class="token function">ls</span>
ca.crt  ca.key  harbor.ljk.org.csr  harbor.ljk.org.key
<span class="token comment"># 3. 给harbor主机颁发证书</span>
root@u1:/usr/local/harbor/certs$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-in</span> harbor.ljk.org.csr <span class="token parameter variable">-CA</span> ca.crt <span class="token parameter variable">-CAkey</span> ca.key <span class="token parameter variable">-CAcreateserial</span> <span class="token parameter variable">-out</span> harbor.ljk.org.crt
Signature ok
<span class="token assign-left variable">subject</span><span class="token operator">=</span>CN <span class="token operator">=</span> harbor.ljk.org
Getting CA Private Key
root@u1:/usr/local/harbor/certs$ tree
<span class="token builtin class-name">.</span>
├── ca.crt
├── ca.key
├── ca.srl
├── harbor.ljk.org.crt
├── harbor.ljk.org.csr
└── harbor.ljk.org.key

<span class="token number">0</span> directories, <span class="token number">6</span> files</code></pre>

<h3 id="CentOS7-创建自签名证书"><a href="#CentOS7-创建自签名证书" class="headerlink" title="CentOS7 创建自签名证书"></a>CentOS7 创建自签名证书</h3><p>CentOS7 和 8 步骤不一样。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSH%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSH%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">OpenSSH服务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:03:35" itemprop="dateCreated datePublished" datetime="2020-12-09T23:03:35+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">加密和安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>说明：ssh 客户端（后面简称 ssh）、ssh 服务端（后面简称 sshd）</p>
<h2 id="SSH-认证过程"><a href="#SSH-认证过程" class="headerlink" title="SSH 认证过程"></a><a target="_blank" rel="noopener" href="https://blog.51cto.com/wchrt/1650552">SSH 认证过程</a></h2><img data-src="//img.to2b.cn/blog/ljk/1599574238261.png"  />

<p>Client 10.0.0.8 ssh 远程连接 Server 10.0.0.7：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$ssh</span> <span class="token number">10.0</span>.0.7
The authenticity of <span class="token function">host</span> <span class="token string">'10.0.0.7 (10.0.0.7)'</span> can<span class="token string">'t be established.
ECDSA key fingerprint is SHA256:CfDVSb/UU590ZKQ0DZhZp7/76rLHeKak/pHGp2af4kw.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span><span class="token number">10.0</span>.0.7<span class="token string">' (ECDSA) to the list of known hosts.
root@10.0.0.7'</span>s password:
Last login: Wed Sep  <span class="token number">9</span> <span class="token number">19</span>:05:15 <span class="token number">2020</span> from <span class="token number">10.0</span>.0.8
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1599660530199.png"></p>
<ol>
<li><p>no.6、no.8：协商版本号，可以看到 Client 的 OpenSSH 版本更高，则以 Server 为准</p>
</li>
<li><p>no.10、no.11：相互交换各自支持的算法，协商各种算法，以 Client 优先</p>
</li>
<li><p>no.12 - 14：使用 DH 算法交换密钥，之后的通信都使用会话密钥加密，具体参考笔记[13.2 DH.md](.&#x2F;13.2 DH.md)，</p>
</li>
<li><p>认证：SSH 支持多种认证，最常用的是口令认证和密钥认证，这个过程已经加密了，用 Wireshark 抓包看不出任何信息</p>
</li>
</ol>
<h2 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h2><p>一台主机，既可以是 ssh Client，也可以是 ssh Server</p>
<h3 id="ssh-Client-相关文件"><a href="#ssh-Client-相关文件" class="headerlink" title="ssh Client 相关文件"></a>ssh Client 相关文件</h3><table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;ssh&#x2F;ssh_config</td>
<td>客户端全局配置文件</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;config</td>
<td>客户端的用户配置文件，默认不存在，权限只能是 644</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;known_hosts</td>
<td>保存服务端的公钥</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;id_rsa</td>
<td>客户端私钥，由 ssh-keygen 生成，权限只能是 600</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;id_rsa.pub</td>
<td>客户端公钥，由 ssh-keygen 生成</td>
</tr>
</tbody></table>
<p><strong>&#x2F;etc&#x2F;ssh&#x2F;ssh_config：</strong></p>
<p>需要说明的是，客户端配置文件有很多配置项和服务端配置项名称相同，但它们一个是在连接时采取的配置(客户端配置文件)，一个是 sshd 启动时开关性的设置(服务端配置文件)。例如，两配置文件都有 GSSAPIAuthentication 项，在客户端将其设置为 no，表示连接时将直接跳过该身份验证机制，而在服务端设置为 no 则表示 sshd 启动时不开启 GSSAPI 身份验证的机制。即使客户端使用了 GSSAPI 认证机制，只要服务端没有开启，就绝对不可能认证通过。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>PasswordAuthentication</td>
<td>yes</td>
<td>是否启用基于密码的身份认证机制</td>
</tr>
<tr>
<td>HostbasedAuthentication</td>
<td>no</td>
<td>是否启用基于主机的身份认证机制</td>
</tr>
<tr>
<td>GSSAPIAuthentication</td>
<td>no</td>
<td>是否启用基于 GSSAPI 的身份认证机制</td>
</tr>
<tr>
<td>BatchMode</td>
<td>no</td>
<td>yes：将禁止 passphrase&#x2F;password 询问</td>
</tr>
<tr>
<td>StrictHostKeyChecking</td>
<td>ask</td>
<td>yes：拒绝连接那些未知的主机，它将强制用户手动添加 host key 到~&#x2F;.ssh&#x2F;known_hosts 中； <br/>ask：询问是否保存到~&#x2F;.ssh&#x2F;known_hosts 文件； <br/>no：自动添加到~&#x2F;.ssh&#x2F;known_hosts 文件</td>
</tr>
<tr>
<td>Port</td>
<td>22</td>
<td>当命令行中不指定端口时，默认连接的远程主机上的端口</td>
</tr>
</tbody></table>
<h3 id="ssh-Server-相关文件"><a href="#ssh-Server-相关文件" class="headerlink" title="ssh Server 相关文件"></a>ssh Server 相关文件</h3><table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;ssh&#x2F;sshd_config</td>
<td>服务端全局配置文件</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;ssh&#x2F;ssh<em>host</em>*</td>
<td>sshd 启动时生成的服务端公钥和私钥文件，其中私钥文件权限只能是 600</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;authorized_keys</td>
<td>保存客户端的公钥，用于 key 验证，免密登录</td>
</tr>
</tbody></table>
<p><strong>&#x2F;etc&#x2F;ssh&#x2F;sshd_config：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#Port 22                # 服务端SSH端口，可以指定多条表示监听在多个端口上</span>
<span class="token comment">#ListenAddress 0.0.0.0  # 监听的IP地址。0.0.0.0表示监听所有IP</span>
Protocol <span class="token number">2</span>              <span class="token comment"># 使用SSH 2版本</span>

<span class="token comment">#####################################</span>
<span class="token comment">#          私钥保存位置               #</span>
<span class="token comment">#####################################</span>
<span class="token comment"># HostKey for protocol version 1</span>
<span class="token comment">#HostKey /etc/ssh/ssh_host_key      # SSH 1保存位置/etc/ssh/ssh_host_key</span>
<span class="token comment"># HostKeys for protocol version 2</span>
<span class="token comment">#HostKey /etc/ssh/ssh_host_rsa_key  # SSH 2保存RSA位置/etc/ssh/ssh_host_rsa _key</span>
<span class="token comment">#HostKey /etc/ssh/ssh_host_dsa_key  # SSH 2保存DSA位置/etc/ssh/ssh_host_dsa _key</span>


<span class="token comment">###################################</span>
<span class="token comment">#           杂项配置               #</span>
<span class="token comment">###################################</span>
<span class="token comment">#PidFile /var/run/sshd.pid        # 服务程序sshd的PID的文件路径</span>
<span class="token comment">#ServerKeyBits 1024               # 服务器生成的密钥长度</span>
<span class="token comment">#SyslogFacility AUTH              # 使用哪个syslog设施记录ssh日志。日志路径默认为/var/log/secure</span>
<span class="token comment">#LogLevel INFO                    # 记录SSH的日志级别为INFO</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下项影响认证速度               #</span>
<span class="token comment">###################################</span>
<span class="token comment">#UseDNS yes                       # 指定是否将客户端主机名解析为IP，以检查此主机名是否与其IP地址真实									  对应。默认yes。</span>
                                  <span class="token comment"># 由此可知该项影响的是主机验证阶段。建议在未配置DNS解析时，将其设置									  为no，否则主机验证阶段会很慢</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下是和安全有关的配置           #</span>
<span class="token comment">###################################</span>
<span class="token comment">#PermitRootLogin yes              # 是否允许root用户登录</span>
<span class="token comment">#GSSAPIAuthentication no          # 是否开启GSSAPI身份认证机制，默认为yes</span>
<span class="token comment">#PubkeyAuthentication yes         # 是否开启基于公钥认证机制</span>
<span class="token comment">#AuthorizedKeysFile  .ssh/authorized_keys  # 基于公钥认证机制时，来自客户端的公钥的存放位置</span>
PasswordAuthentication <span class="token function">yes</span>        <span class="token comment"># 是否使用密码验证，如果使用密钥对验证可以关了它</span>
<span class="token comment">#PermitEmptyPasswords no          # 是否允许空密码，如果上面的那项是yes，这里最好设置no</span>
<span class="token comment">#MaxSessions 10                   # 最大客户端连接数量</span>
<span class="token comment">#LoginGraceTime 2m                # 身份验证阶段的超时时间，若在此超时期间内未完成身份验证将自动断开</span>
<span class="token comment">#MaxAuthTries 6                   # 指定每个连接最大允许的认证次数。默认值是6。</span>
                                  <span class="token comment"># 如果失败认证次数超过该值一半，将被强制断开，且生成额外日志消息。</span>
MaxStartups <span class="token number">10</span>                    <span class="token comment"># 最大允许保持多少个未认证的连接。默认值10。</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下可以自行添加到配置文件        #</span>
<span class="token comment">###################################</span>
DenyGroups  hellogroup testgroup  <span class="token comment"># 表示hellogroup和testgroup组中的成员不允许使用sshd服务，即拒绝              					   这些用户连接</span>
DenyUsers   hello <span class="token builtin class-name">test</span>            <span class="token comment"># 表示用户hello和test不能使用sshd服务，即拒绝这些用户连接</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下一项和远程端口转发有关        #</span>
<span class="token comment">###################################</span>
<span class="token comment">#GatewayPorts no                  # 设置为yes表示sshd允许被远程主机所设置的本地转发端口绑定在非环回 									地址上</span>
                                  <span class="token comment"># 默认值为no，表示远程主机设置的本地转发端口只能绑定在环回地址上，见									  后文"远程端口转发"</span></code></pre>

<p>一般来说，如非有特殊需求，只需修改下监听端口和 UseDNS 为 no 以加快主机验证阶段的速度即可。</p>
<h2 id="ssh-客户端工具"><a href="#ssh-客户端工具" class="headerlink" title="ssh 客户端工具"></a>ssh 客户端工具</h2><h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>user@<span class="token punctuation">]</span>remote_host <span class="token punctuation">[</span>command<span class="token punctuation">]</span>

<span class="token parameter variable">-p</span> port      <span class="token comment"># 远程服务监听的端口，默认是22</span>
<span class="token parameter variable">-o</span> option    <span class="token comment"># 临时修改配置</span>
<span class="token parameter variable">-i</span> <span class="token operator">&lt;</span>file <span class="token operator">></span>   <span class="token comment"># 指定私钥文件，默认使用 ~/.ssh/id_xxx</span></code></pre>

<h4 id="ssh-keygen"><a href="#ssh-keygen" class="headerlink" title="ssh-keygen"></a>ssh-keygen</h4><p>在客户端生成密钥对，默认存放在~&#x2F;.ssh 目录下</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa	<span class="token comment"># 提示保存位置，输入密码</span>

ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-P</span> <span class="token string">''</span> <span class="token parameter variable">-f</span> ~/.ssh/id_rsa	<span class="token comment"># 不提示直接生成密钥</span></code></pre>

<h4 id="ssh-copy-id"><a href="#ssh-copy-id" class="headerlink" title="ssh-copy-id"></a>ssh-copy-id</h4><p>使用 SSH 协议，将公钥追加到服务器的 ~&#x2F;.ssh&#x2F;authorized_keys 文件中</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ssh-copy-id <span class="token parameter variable">-i</span> ~/.ssh/id_rsa.pub remote_host</code></pre>

<h3 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h3><p>scp 命令用于 Linux 之间复制文件和目录，基于 SSH 协议。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> SRC<span class="token punctuation">..</span>. DEST/

<span class="token parameter variable">-C</span>    <span class="token comment"># 压缩数据流</span>
<span class="token parameter variable">-r</span>    <span class="token comment"># 递归复制</span>
<span class="token parameter variable">-p</span>    <span class="token comment"># 保持原文件的属性信息</span>
<span class="token parameter variable">-q</span>    <span class="token comment"># 静默模式</span>
<span class="token parameter variable">-P</span>    <span class="token comment"># PORT 指明remote host的监听的端口</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 从本地复制到远程：</span>
<span class="token function">scp</span> local_file root@to2b.cn:remote_file
<span class="token function">scp</span> local_file root@lujinkai:remote_file
<span class="token function">scp</span> local_file root@test.to2b.cn:remote_file

<span class="token comment"># 从远程复制到本地：</span>
<span class="token function">scp</span> root@to2b.cn:remote_file local_file
<span class="token function">scp</span> root@lujinkai.cn:remote_file local_file
<span class="token function">scp</span> root@test.to2b.cn:remote_file local_file</code></pre>

<h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><p>rsync 工具基于 SSH 和 RSYNC 协议实现高效率的远程系统之间复制文件，比 scp 更快，基于增量数据同步，此工具来自于 rsync 包</p>
<p>注意：通信双方都需要安装 rsync 软件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">rsync</span> <span class="token parameter variable">-av</span> /etc server1:/tmp <span class="token comment">#复制目录和目录下文件</span>
<span class="token function">rsync</span> <span class="token parameter variable">-av</span> /etc/ server1:/tmp <span class="token comment">#只复制目录下文件</span>

<span class="token parameter variable">-n</span>                    <span class="token comment"># 模拟复制过程</span>
<span class="token parameter variable">-v</span>                    <span class="token comment"># 显示详细过程，-vvvv显示更详细的信息</span>
<span class="token parameter variable">-r</span>                    <span class="token comment"># 递归复制目录树</span>
<span class="token parameter variable">-p</span>                    <span class="token comment"># 保留权限（不包括特殊权限）</span>
<span class="token parameter variable">-t</span>                    <span class="token comment"># 保留修改时间戳（mtime），强烈建议任何时候都加上"-t",否则目标文件mtime会设置为系统时间,导致下次更新</span>
<span class="token parameter variable">-g</span>                    <span class="token comment"># 保留组信息</span>
<span class="token parameter variable">-o</span>                    <span class="token comment"># 保留所有者信息</span>
<span class="token parameter variable">-l</span>                    <span class="token comment"># 将软链接文件本身进行复制（默认）</span>
<span class="token parameter variable">-L</span>                    <span class="token comment"># 将软链接文件指向的文件复制</span>
<span class="token parameter variable">-u</span>                    <span class="token comment"># 如果接收者的文件比发送者的文件较新，将忽略同步</span>
<span class="token parameter variable">-z</span>                    <span class="token comment"># 压缩，节约网络带宽</span>
<span class="token parameter variable">-D</span>                    <span class="token comment"># "--device --specials"选项的组合,即也拷贝设备文件和特殊文件</span>
<span class="token parameter variable">-a</span>                    <span class="token comment"># 存档，相当于-rlptgoD，但不保留ACL（-A）和SELinux属性（-X）</span>
<span class="token parameter variable">-b</span>                    <span class="token comment"># 对目标上已存在的文件做一个备份,备份的文件名后默认使用"~"做后缀</span>
<span class="token parameter variable">--delete</span>              <span class="token comment"># 源数据删除，目标数据也自动同步删除</span>
--max-size            <span class="token comment">#</span>
--min-size            <span class="token comment"># 限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件</span>
<span class="token parameter variable">--exclude</span>             <span class="token comment"># 排除不需要传输的文件</span>
<span class="token parameter variable">--port</span>                <span class="token comment"># 连接daemon时使用的端口号,默认为873端口</span>
<span class="token parameter variable">--existing</span>            <span class="token comment"># 只更新目标端已存在的文件，注意：使用相对路径时如果上层目录不存在也不会传输</span>
--ignore-existing     <span class="token comment"># 要求只更新目标端不存在的文件。和"--existing"结合使用有特殊功能</span>
--remove-source-files <span class="token comment"># 要求删除源端已经成功传输的文件</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#rsync -auv --delete /data/test 10.0.0.7:/data</span></code></pre>

<h3 id="sftp"><a href="#sftp" class="headerlink" title="sftp"></a>sftp</h3><p><strong>交互式</strong>文件传输工具，利用 ssh 服务实现安全的文件上传和下载，使用 ls cd mkdir rmdir pwd get put 等指令，详细说明可以使用 help 查看</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>lujinkai@ubuntu1804 data<span class="token punctuation">]</span><span class="token variable">$sftp</span> root@10.0.0.7
root@10.0.0.7<span class="token string">'s password:
Connected to 10.0.0.7.
sftp> help	# 查看帮助
Available commands:
bye                                Quit sftp
cd path                            Change remote directory to '</span>path<span class="token string">'
chgrp grp path                     Change group of file '</span>path<span class="token string">' to '</span>grp<span class="token string">'
chmod mode path                    Change permissions of file '</span>path<span class="token string">' to '</span>mode<span class="token string">'
chown own path                     Change owner of file '</span>path<span class="token string">' to '</span>own<span class="token string">'
df [-hi] [path]                    Display statistics for current directory or
                                   filesystem containing '</span>path<span class="token string">'
exit                               Quit sftp
get [-afPpRr] remote [local]       Download file
reget [-fPpRr] remote [local]      Resume download file
reput [-fPpRr] [local] remote      Resume upload file
help                               Display this help text
lcd path                           Change local directory to '</span>path<span class="token string">'
lls [ls-options [path]]            Display local directory listing
lmkdir path                        Create local directory
ln [-s] oldpath newpath            Link remote file (-s for symlink)
lpwd                               Print local working directory
ls [-1afhlnrSt] [path]             Display remote directory listing
lumask umask                       Set local umask to '</span><span class="token builtin class-name">umask</span><span class="token string">'
mkdir path                         Create remote directory
progress                           Toggle display of progress meter
put [-afPpRr] local [remote]       Upload file
pwd                                Display remote working directory
quit                               Quit sftp
rename oldpath newpath             Rename remote file
rm path                            Delete remote file
rmdir path                         Remove remote directory
symlink oldpath newpath            Symlink remote file
version                            Show SFTP version
!command                           Execute '</span>command' <span class="token keyword">in</span> <span class="token builtin class-name">local</span> shell
<span class="token operator">!</span>                                  Escape to <span class="token builtin class-name">local</span> shell
?                                  Synonym <span class="token keyword">for</span> <span class="token builtin class-name">help</span>
sftp<span class="token operator">></span> <span class="token builtin class-name">pwd</span>	<span class="token comment"># 查看远程服务器目录</span>
Remote working directory: /root
sftp<span class="token operator">></span> lpwd	<span class="token comment"># 查看本机目录</span>
Local working directory: /home/lujinkai/data
sftp<span class="token operator">></span> <span class="token function">ls</span>
ELS.txt  a.log
sftp<span class="token operator">></span> get a.log /tmp/	<span class="token comment"># get 下载文件</span>
Fetching /root/data/a.log to /tmp/a.log
/root/data/a.log                                        <span class="token number">100</span>%   <span class="token number">21</span>     <span class="token number">6</span>.5KB/s   00:00
sftp<span class="token operator">></span> put /etc/passwd ./	<span class="token comment"># 上传文件</span>
Uploading /etc/passwd to /root/data/./passwd
/etc/passwd                                             <span class="token number">100</span>% <span class="token number">1567</span>   <span class="token number">544</span>.2KB/s   00:00</code></pre>

<h2 id="高级应用"><a href="#高级应用" class="headerlink" title="高级应用"></a><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/12/ssh_port_forwarding.html">高级应用</a></h2><p>SSH 端口转发能够提供两大功能：</p>
<ul>
<li>加密 SSH Client 端至 SSH Server 端之间的通讯数据</li>
<li>突破防火墙的限制完成一些之前无法建立的 TCP 连接</li>
</ul>
<h3 id="SSH-本地端口转发"><a href="#SSH-本地端口转发" class="headerlink" title="SSH 本地端口转发"></a>SSH 本地端口转发</h3><p>三台主机：</p>
<p>host1：家用电脑，公网中<br>host2：业务服务器，内网中<br>host3：中转服务器，内网中</p>
<p>host1 不能直接连接 host2，但是可以通过 host3 中转，在 host1 上执行下面命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-fNL</span> <span class="token number">1234</span>:host2_ip:80 <span class="token punctuation">[</span>host3_user@<span class="token punctuation">]</span>host3_ip

<span class="token parameter variable">-N</span>                                   <span class="token comment"># 不打开远程shell，适用于转发端口</span>
<span class="token parameter variable">-f</span>                                   <span class="token comment"># 后台启用，避免占用终端前台</span>
<span class="token parameter variable">-L</span> <span class="token punctuation">[</span>bind_address:<span class="token punctuation">]</span>port:host:hostport <span class="token comment"># 本机端口：目标主机：目标主机端口，默认ssh只监听127.0.0.1的port，指定bind_address，则监听bind_address的port，如果bind_address设置为0.0.0.0，表示监听本机全部地址的port</span>
host3                                <span class="token comment"># 中转服务器</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># host1：CentOS6 10.0.0.6</span>
<span class="token comment"># host2：CentOS7 10.0.0.7</span>
<span class="token comment"># host3：CentOS 10.0.0.8</span>

<span class="token comment"># host1 ssh监听本机的1234端口，将1234端口的请求通过10.0.0.8转发到10.0.0.7的80端口</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># ssh -fNL 1234:10.0.0.7:80 root@10.0.0.8</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># curl 127.0.0.1:1234</span>
hello nginx<span class="token operator">!</span>

<span class="token comment"># host2</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#cat /usr/local/nginx/html/index.html</span>
hello nginx<span class="token operator">!</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#tail -f /usr/local/nginx/logs/access.log</span>
<span class="token number">10.0</span>.0.8 - - <span class="token punctuation">[</span><span class="token number">12</span>/Sep/2020:14:15:53 +0800<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">13</span> <span class="token string">"-"</span> <span class="token string">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2"</span></code></pre>

<p>绑定本地端口，指定数据传送的目标主机，们把这种情况称为”本地端口转发”（Local forwarding）。</p>
<p>因为 host1 和 host3 通信使用 SSH 加密，仿佛形成一个数据传输的秘密隧道，因此又被称为”SSH 隧道”。</p>
<h3 id="SSH-远程端口转发"><a href="#SSH-远程端口转发" class="headerlink" title="SSH 远程端口转发"></a>SSH 远程端口转发</h3><p>三台主机：</p>
<p>host1：家用电脑，公网中<br>host2：业务服务器，内网中<br>host3：中转服务器，内网中</p>
<p>host1 不能直接连接 host2，也不能直接连接 host3，但是 host3 既可以连接 host1，又可以连接 host2，所有使用 host3 做中转。</p>
<p>远程端口转发 和 本地端口转发 逻辑上刚好相反：</p>
<ul>
<li>本地端口转发是 host1 主动监听本机的 1234 端口（因为主动，所以是 ssh 监听 1234），要求 host3 帮忙转发；</li>
<li>远程端口转发是 host3 通知 host1，让其监听自身的 1234 端口（因为被动，所以是 sshd 监听 1234），host3 主动拿帮 host1 转发。</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-fNR</span> <span class="token number">1234</span>:host2_ip:80 <span class="token punctuation">[</span>host1_user@<span class="token punctuation">]</span>host1_ip

<span class="token parameter variable">-R</span> <span class="token punctuation">[</span>bind_address:<span class="token punctuation">]</span>port:host:hostport   <span class="token comment"># 远程主机端口：目标主机：目标主机端口</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># host1：CentOS6 10.0.0.6</span>
<span class="token comment"># host2：CentOS7 10.0.0.7</span>
<span class="token comment"># host3：CentOS 10.0.0.8</span>

<span class="token comment"># host3</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$ssh</span> <span class="token parameter variable">-fNR</span> <span class="token number">1234</span>:10.0.0.7:80 root@10.0.0.6

<span class="token comment"># host1，成功访问到host2，</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># curl 127.0.0.1:1234</span>
hello nginx<span class="token operator">!</span></code></pre>

<h3 id="SSH-动态端口转发"><a href="#SSH-动态端口转发" class="headerlink" title="SSH 动态端口转发"></a>SSH 动态端口转发</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-D</span> <span class="token number">1080</span> root@10.0.0.8</code></pre>

<p>SSH 创建 SOCKS 代理服务，去监听本地的 1080 端口。一旦有数据传向那个端口，就自动把它转移到 SSH 连接上面，发往远程主机 10.0.0.8。可以想象，如果 1080 端口原来是一个不加密端口，现在将变成一个加密端口。</p>
<p>目前 SOCKS4 和 SOCKS5 协议支持端口转发：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># CentOS6 配置 SOCKS代理</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># ssh -fND 1080 root@10.0.0.8</span>
<span class="token comment"># CentOS8替CentOS6访问http://10.0.0.7，将返回数据加密，发送回CentOS6</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># curl --socks5 127.0.0.1:1080 http://10.0.0.7</span>
hello nginx<span class="token operator">!</span></code></pre>

<h3 id="X-协议转发"><a href="#X-协议转发" class="headerlink" title="X 协议转发"></a>X 协议转发</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/DSA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/DSA/" class="post-title-link" itemprop="url">DSA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:03:22" itemprop="dateCreated datePublished" datetime="2020-12-09T23:03:22+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">加密和安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="同余定理"><a href="#同余定理" class="headerlink" title="同余定理"></a>同余定理</h2><p>两个不同的整数 a、b，被一个整数 m 相除时，得到相同的余数，那么我就可以称 a、b 对 m 同余。</p>
<p>换言之，(a-b)&#x2F;m 得到一个整数，因为 a、b 相减时把余数抵消掉了。</p>
<p>a、b 对 m 同余，记做 a≡b(mod m)</p>
<p>例如：4≡7(mod 3)</p>
<h2 id="欧拉函数"><a href="#欧拉函数" class="headerlink" title="欧拉函数"></a>欧拉函数</h2><p><img data-src="//img.to2b.cn/blog/ljk/1599288622837.png" style="vertical-align: middle;"><span>  (其中 p1, p2……pn 为 x 的所有质因数，x 是不为 0 的整数)</span></p>
<p>欧拉函数表示小于或等于 n 的正整数中与 n 互质的数的数目。定义：φ(1) &#x3D; 1</p>
<p>举例：φ(8)&#x3D;4，因为 1,3,5,7 均和 8 互质</p>
<h2 id="阶"><a href="#阶" class="headerlink" title="阶"></a>阶</h2><p>设 m&gt;1，且 a、m 互质，那么使得 a<sup>r</sup>≡1(mod m)成立的最小的正整数 r 称为 a 对模 m 的阶，记为 δm(a)</p>
<h2 id="原根"><a href="#原根" class="headerlink" title="原根"></a>原根</h2><p>原根是一种数学符号，设 m 是正整数，a 是整数，若 a 模 m 的阶等于 φ(m)，则称 a 为模 m 的一个原根</p>
<h2 id="离散对数"><a href="#离散对数" class="headerlink" title="离散对数"></a>离散对数</h2><p>离散 就是 不连续的意思</p>
<p>在整数中，离散对数（英语：Discrete logarithm）是一种基于同余运算和原根的一种对数运算</p>
<p>log<sub>b</sub>a：对于给定的 a 和 b 实数，有一个实数 x，使得 b<sup>x</sup>&#x3D;a</p>
<p>log<sub>b</sub>a：对于给定的 a 和 b 整数，有一个整数 k，使得 b<sup>k</sup>&#x3D;a</p>
<h2 id="DSA-算法"><a href="#DSA-算法" class="headerlink" title="DSA 算法"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e2051d6fe4d3">DSA 算法</a></h2><p>该算法的安全性依赖于计算模数的离散对数的难度。</p>
<h3 id="公开参数："><a href="#公开参数：" class="headerlink" title="公开参数："></a>公开参数：</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>p</td>
<td>512~1024 位的素数（可以在一组用户中共享）</td>
</tr>
<tr>
<td>q</td>
<td>160 位长，并与 p-1 互素的因子（可以在一组用户中共享）</td>
</tr>
<tr>
<td>g</td>
<td>g&#x3D;h<sup>(p-1)&#x2F;q</sup> mod p，其中 h 小于 p-1 并且 h<sup>(p-1)&#x2F;q</sup> mod p &gt; 1</td>
</tr>
<tr>
<td>y</td>
<td>y&#x3D;g<sup>x</sup> mod p （一个 p 位的数）</td>
</tr>
</tbody></table>
<h3 id="私密参数："><a href="#私密参数：" class="headerlink" title="私密参数："></a>私密参数：</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>x</td>
<td>x&lt;q</td>
</tr>
</tbody></table>
<h3 id="签名过程："><a href="#签名过程：" class="headerlink" title="签名过程："></a>签名过程：</h3><ol>
<li>对于报文 m, 挑选秘密随机数 k: k ∈ (0, q)</li>
<li>r &#x3D; ( g^k mod p ) mod q</li>
<li>s &#x3D; ( k^(-1) (H(m) + xr)) mod q，H()应该是 hash 算法，dsa 只支持 sha</li>
<li>签名结果即为(m, r, s)</li>
</ol>
<h3 id="校验过程："><a href="#校验过程：" class="headerlink" title="校验过程："></a>校验过程：</h3><ol>
<li>w &#x3D; s^(-1)mod q</li>
<li>a &#x3D; ( H( m ) * w ) mod q</li>
<li>b &#x3D; ( r * w ) mod q</li>
<li>v &#x3D; (( g^a * y^b ) mod p ) mod q</li>
<li>若 v &#x3D; r，则认为签名有效。</li>
</ol>
<h3 id="openssl-实现"><a href="#openssl-实现" class="headerlink" title="openssl 实现"></a>openssl 实现</h3><p>生成 1024 位 DSA 参数集 p、q、g，并输出到参数文件 dsa.param：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> dsaparam <span class="token parameter variable">-out</span> dsa.param <span class="token number">1024</span>
Generating DSA parameters, <span class="token number">1024</span> bit long prime
This could take some <span class="token function">time</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span>.+<span class="token punctuation">..</span>.+.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+.+.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span>+.+<span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+.+.+<span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+.+<span class="token punctuation">..</span><span class="token punctuation">..</span>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$cat</span> dsa.param
-----BEGIN DSA PARAMETERS-----
MIIBHgKBgQCXWtR0zjsNLT010pR/Oelvbk1N+vSv2k3bUahkWMuZ6Z5BYQP7+QvK
6D1/+RWD/zHIicOLGYNkOFnX3PBPlx218KqFX1wNkmYz0vqPu1+RYeIVqaVFDEB2
dibqiFhKDhKipR7G3tCwqC94AkTJtduQNnBiM/YRz86nE6nqYVTfrwIVAK+NYZGg
cv5MtoJVdu/rr2wEypp1AoGAZgDa/zIKudSI99nlIUJOODkS064l+rT0JdEIbdcv
TEKeCmWhRMzWdU8y56AWsiTCmChuXHlMsgt6VKcgBMO7FgGTPeIiDegGZvZmXG8B
bL6/gejSrMQmEG1CrJZ6vCqkDRkaKvVSX6ysOMbPk9GcjqAw8KwdkUi4Bxv2wyNL
<span class="token assign-left variable">JK8</span><span class="token operator">=</span>
-----END DSA PARAMETERS-----
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> dsaparam <span class="token parameter variable">-in</span> dsa.param <span class="token parameter variable">--noout</span> <span class="token parameter variable">-C</span>
static DSA *get_dsa1024<span class="token punctuation">(</span>void<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    static unsigned char dsap_1024<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        0x97, 0x5A, 0xD4, 0x74, 0xCE, 0x3B, 0x0D, 0x2D, 0x3D, 0x35,
        0xD2, 0x94, 0x7F, 0x39, 0xE9, 0x6F, 0x6E, 0x4D, 0x4D, 0xFA,
        0xF4, 0xAF, 0xDA, 0x4D, 0xDB, 0x51, 0xA8, 0x64, 0x58, 0xCB,
        0x99, 0xE9, 0x9E, 0x41, 0x61, 0x03, 0xFB, 0xF9, 0x0B, 0xCA,
        0xE8, 0x3D, 0x7F, 0xF9, 0x15, 0x83, 0xFF, 0x31, 0xC8, 0x89,
        0xC3, 0x8B, 0x19, 0x83, 0x64, 0x38, 0x59, 0xD7, 0xDC, 0xF0,
        0x4F, 0x97, 0x1D, 0xB5, 0xF0, 0xAA, 0x85, 0x5F, 0x5C, 0x0D,
        0x92, 0x66, 0x33, 0xD2, 0xFA, 0x8F, 0xBB, 0x5F, 0x91, 0x61,
        0xE2, 0x15, 0xA9, 0xA5, 0x45, 0x0C, 0x40, 0x76, 0x76, 0x26,
        0xEA, 0x88, 0x58, 0x4A, 0x0E, 0x12, 0xA2, 0xA5, 0x1E, 0xC6,
        0xDE, 0xD0, 0xB0, 0xA8, 0x2F, 0x78, 0x02, 0x44, 0xC9, 0xB5,
        0xDB, 0x90, 0x36, 0x70, 0x62, 0x33, 0xF6, 0x11, 0xCF, 0xCE,
        0xA7, 0x13, 0xA9, 0xEA, 0x61, 0x54, 0xDF, 0xAF
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    static unsigned char dsaq_1024<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        0xAF, 0x8D, 0x61, 0x91, 0xA0, 0x72, 0xFE, 0x4C, 0xB6, 0x82,
        0x55, 0x76, 0xEF, 0xEB, 0xAF, 0x6C, 0x04, 0xCA, 0x9A, 0x75
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    static unsigned char dsag_1024<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        0x66, 0x00, 0xDA, 0xFF, 0x32, 0x0A, 0xB9, 0xD4, 0x88, 0xF7,
        0xD9, 0xE5, 0x21, 0x42, 0x4E, 0x38, 0x39, 0x12, 0xD3, 0xAE,
        0x25, 0xFA, 0xB4, 0xF4, 0x25, 0xD1, 0x08, 0x6D, 0xD7, 0x2F,
        0x4C, 0x42, 0x9E, 0x0A, 0x65, 0xA1, 0x44, 0xCC, 0xD6, 0x75,
        0x4F, 0x32, 0xE7, 0xA0, 0x16, 0xB2, 0x24, 0xC2, 0x98, 0x28,
        0x6E, 0x5C, 0x79, 0x4C, 0xB2, 0x0B, 0x7A, 0x54, 0xA7, 0x20,
        0x04, 0xC3, 0xBB, 0x16, 0x01, 0x93, 0x3D, 0xE2, 0x22, 0x0D,
        0xE8, 0x06, 0x66, 0xF6, 0x66, 0x5C, 0x6F, 0x01, 0x6C, 0xBE,
        0xBF, 0x81, 0xE8, 0xD2, 0xAC, 0xC4, 0x26, 0x10, 0x6D, 0x42,
        0xAC, 0x96, 0x7A, 0xBC, 0x2A, 0xA4, 0x0D, 0x19, 0x1A, 0x2A,
        0xF5, 0x52, 0x5F, 0xAC, 0xAC, 0x38, 0xC6, 0xCF, 0x93, 0xD1,
        0x9C, 0x8E, 0xA0, 0x30, 0xF0, 0xAC, 0x1D, 0x91, 0x48, 0xB8,
        0x07, 0x1B, 0xF6, 0xC3, 0x23, 0x4B, 0x24, 0xAF
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    DSA *dsa <span class="token operator">=</span> DSA_new<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BIGNUM *p, *q, *g<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dsa <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> NULL<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DSA_set0_pqg<span class="token punctuation">(</span>dsa, p <span class="token operator">=</span> BN_bin2bn<span class="token punctuation">(</span>dsap_1024, sizeof<span class="token punctuation">(</span>dsap_1024<span class="token punctuation">)</span>, NULL<span class="token punctuation">)</span>,
                           q <span class="token operator">=</span> BN_bin2bn<span class="token punctuation">(</span>dsaq_1024, sizeof<span class="token punctuation">(</span>dsaq_1024<span class="token punctuation">)</span>, NULL<span class="token punctuation">)</span>,
                           g <span class="token operator">=</span> BN_bin2bn<span class="token punctuation">(</span>dsag_1024, sizeof<span class="token punctuation">(</span>dsag_1024<span class="token punctuation">)</span>, NULL<span class="token punctuation">))</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        DSA_free<span class="token punctuation">(</span>dsa<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BN_free<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BN_free<span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BN_free<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token builtin class-name">return</span> dsa<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>使用参数文件 dsa.param 生成 DSA 私钥文件 dsa.key，并将私钥 3DES 加密：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> gendsa <span class="token parameter variable">-out</span> dsa.key <span class="token parameter variable">-des3</span> dsa.param
Generating DSA key, <span class="token number">1024</span> bits
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$cat</span> dsa.key
-----BEGIN DSA PRIVATE KEY-----
Proc-Type: <span class="token number">4</span>,ENCRYPTED
DEK-Info: DES-EDE3-CBC,5E11A0F348D0EAB7

xlH02528Xuza/YkK4jMWiFoFTMkfvLEPFPdhlh1Zpdb4MGi6pWeHsQf0bXkQ7s1H
JNrcsiPNvYK6eiyYw0QTvGivmSs1IvkeGJPJQnHPkclzn7A6QYG4PXFGQGWxSNr9
6kbSMrlBqSZyo05TN+Hkv76HFIb2Haszo6b5n+h0LMqancDh8hzO4qCLtgL2GSp1
WcsjjVlox7askeZPMHA0FKKx2Sku0yGQtxqBIR2Z/Rf2ePW2aJd3gLRYMTWZO/B2
lIz+ttBZJ84LJsfAZ0oRyRUTpse3pHlp4ohdwFJf4mVkZMbg4BIqGhZjamOuLJeP
RhnfM4MXeI1JZGViUanpipAHmuSxDH12+/UsFdGMeqY2PXIenpLCVna443BV3avh
sP3srdYcKxhOgRa8XAJsrJ/K/T6xR28uE3zAVQ52USo5ifgx4gtu3rEZ0/XqUJ1q
T5I8WwInPzvCMEhyIFL/n/gqhMMaRkAJXaMrZvhnFnCYQg7fFvgKbhJB7CEu1+j3
lfFod1Sb3/IgMlMmwMG87N3DpDn4Q7P+ypY4KDIScc7OJQy+Oy1y7Mm7aWB4xP/R
i/AAXrsOWcdeY2zt/LSWzg<span class="token operator">==</span>
-----END DSA PRIVATE KEY-----</code></pre>

<p>使用私钥生成公钥文件 dsapublickey.pem：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> dsa <span class="token parameter variable">-in</span> dsa.key <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> dsa.key.pub
<span class="token builtin class-name">read</span> DSA key
Enter pass phrase <span class="token keyword">for</span> dsa.key:
writing DSA key
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$cat</span> dsa.key.pub
-----BEGIN PUBLIC KEY-----
MIIBtjCCASsGByqGSM44BAEwggEeAoGBAJda1HTOOw0tPTXSlH856W9uTU369K/a
TdtRqGRYy5npnkFhA/v5C8roPX/5FYP/MciJw4sZg2Q4Wdfc8E+XHbXwqoVfXA2S
ZjPS+o+7X5Fh4hWppUUMQHZ2JuqIWEoOEqKlHsbe0LCoL3gCRMm125A2cGIz9hHP
zqcTqephVN+vAhUAr41hkaBy/ky2glV27+uvbATKmnUCgYBmANr/Mgq51Ij32eUh
Qk44ORLTriX6tPQl0Qht1y9MQp4KZaFEzNZ1TzLnoBayJMKYKG5ceUyyC3pUpyAE
w7sWAZM94iIN6AZm9mZcbwFsvr+B6NKsxCYQbUKslnq8KqQNGRoq9VJfrKw4xs+T
0ZyOoDDwrB2RSLgHG/bDI0skrwOBhAACgYBJ3oCNHNh7xflq3VaHL30MMl+4Qqrm
Jv0WfHTiOqhYWkezA/ueMcJe/X/pW05ARESVbkrrQx/wxPuR8CO1pFTCPqyI02Rc
AXCz7ejp4OmrdF6RNHds+uT2YZ5sRI7zWX1YXdSIG0TGJ9+jOgeRVpPdNGgVdUxS
<span class="token assign-left variable">SgeCn5UKw6nJew</span><span class="token operator">==</span>
-----END PUBLIC KEY-----</code></pre>

<p>从 dsa.key 中读取私钥，解密并输入新口令进行加密，然后写回文件 dsa.key</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">openssl dsa <span class="token parameter variable">-in</span>  dsa.key <span class="token parameter variable">-out</span>  dsa.key <span class="token parameter variable">-des3</span> <span class="token parameter variable">-passin</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/DH%20(Diffie-Hellman)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/DH%20(Diffie-Hellman)/" class="post-title-link" itemprop="url">DH (Diffie-Hellman)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:03:13" itemprop="dateCreated datePublished" datetime="2020-12-09T23:03:13+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">加密和安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>RSA 既可以用于密钥交换,又可以用于数字签名；ECC 这边就分得比较清楚了：ECDHE 用于密钥交换，ECDSA 用于数字签名。</p>
<p>ECDHE 密钥交换使用的是 DH（Diffie-Hellman）算法。</p>
<p>Deffie-Hellman(简称 DH) 密钥交换是最早的密钥交换算法之一，它使得通信的双方能在非安全的信道中安全的交换密钥，用于加密后续的通信消息。 Whitfield Diffie 和 Martin Hellman 于 1976 提出该算法，之后被应用于安全领域，比如 Https 协议的 TSL(Transport Layer Security)以 DH 算法作为密钥交换算法。</p>
<p>session key 是主密钥，HTTPS 建立连接时使用 SSL&#x2F;TLS 来交换 session key，后续的传输数据使用的是对称加密，对称加密的密钥就是通过 session key 生成的。</p>
<p>前面我们说过，session key 需要使用非对称加密的方式来传送，非对称加密算法常用的是 RSA，RSA 会把一方生成的 session key 用公钥加密后再发送给对方，可是，万一私钥泄露了，那 session key 也就泄露了。所以 SSL&#x2F;TLS 使用另一种非对称加密算法来传送 session key，这种算法就是<strong>HD</strong>，RSA 是“传送”，而 HD 描述为“交换”更准确一些。</p>
<h2 id="HD-的实现机制："><a href="#HD-的实现机制：" class="headerlink" title="HD 的实现机制："></a>HD 的实现机制：</h2><p>假设 A、B 通信</p>
<ol>
<li>A、B 相互通信一次，确定两个参数：整数 g 和 大素数 p，这个过程叫做“协商”</li>
<li>A 生成隐私数据 a，a &lt; p，计算得出 g<sup>a</sup> mod p，发送给 B</li>
<li>B 生成隐私数据 b，b &lt; p，计算得出 g<sup>b</sup> mod p，发送给 A</li>
<li>A 计算 [(g<sup>b</sup> mod p)^a] %p，得到的结果是预备主密钥 session key</li>
<li>B 计算 [(g<sup>a</sup> mod p)^b] %p，得到的结果是预备主密钥 session key</li>
</ol>
<p>[(g<sup>b</sup> mod p)^a] %p &#x3D; [(g<sup>a</sup> mod p)^b] %p &#x3D; g<sup>ab</sup> mod p，证明过程略，总之 A、B 生成的 session key 是相同的。</p>
<p>通信过程不加密，就是说 g、p、g<sup>a</sup> mod p、g<sup>b</sup> mod p 都是公开的，只有公开的这个四个数据，没有 a、b 就算不出来 g<sup>ab</sup> mod p，这样就做到了 session key 由通信双方各自生成，不经过网络传递。</p>
<p>可以抽象的认为：A 的私钥是 a，公钥是 g<sup>a</sup> mod p；B 的私钥是 b，公钥是 g<sup>b</sup> mod p，g<sup>ab</sup> mod p 是预备主密钥 session key，最终用于加密的密钥是会话密钥，通过 session key 和 H 派生出来，具体参看下面的 <strong>SSHv2 协议中的 DH</strong></p>
<h2 id="openssl-实现"><a href="#openssl-实现" class="headerlink" title="openssl 实现"></a>openssl 实现</h2><p>使用生成因子（generator，即整数 g，2 或者 5，默认是 2）2 和随机的 1024-bit 的素数（大素数 p）产生 D0ffie-Hellman 参数，输出保存到参数文件 dh.param：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> dhparam <span class="token parameter variable">-out</span> dh.param <span class="token parameter variable">-2</span> <span class="token number">1024</span>
Generating DH parameters, <span class="token number">1024</span> bit long safe prime, generator <span class="token number">2</span>
This is going to take a long <span class="token function">time</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>++*++*++*++*++*
<span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$cat</span> dh.param
-----BEGIN DH PARAMETERS-----
MIGHAoGBAIHnVCwnbBAsIz43ylC5jSXdvbEysPNhe51MiYhjOYiIphx3eKgKOf9h
w47mAlaL9pFTsgtCfwq0gPOOABufWZY3cO0Xqwazfv84LFOH5BcH8M3trGyAc4C5
0kDJ3A2L5pmlVDYXrBhikCtfEMgixqbbMkCpqmKvk1YHvRfSarejAgEC
-----END DH PARAMETERS-----</code></pre>

<p>从 dh.param 中读取 Diffie-Hell 参数，以 C 代码的形式输出到 stdout：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 data<span class="token punctuation">]</span><span class="token variable">$openssl</span> dhparam <span class="token parameter variable">-in</span> dh.param <span class="token parameter variable">-noout</span> <span class="token parameter variable">-C</span>
static DH *get_dh1024<span class="token punctuation">(</span>void<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    static unsigned char dhp_1024<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        0x81, 0xE7, 0x54, 0x2C, 0x27, 0x6C, 0x10, 0x2C, 0x23, 0x3E,
        0x37, 0xCA, 0x50, 0xB9, 0x8D, 0x25, 0xDD, 0xBD, 0xB1, 0x32,
        0xB0, 0xF3, 0x61, 0x7B, 0x9D, 0x4C, 0x89, 0x88, 0x63, 0x39,
        0x88, 0x88, 0xA6, 0x1C, 0x77, 0x78, 0xA8, 0x0A, 0x39, 0xFF,
        0x61, 0xC3, 0x8E, 0xE6, 0x02, 0x56, 0x8B, 0xF6, 0x91, 0x53,
        0xB2, 0x0B, 0x42, 0x7F, 0x0A, 0xB4, 0x80, 0xF3, 0x8E, 0x00,
        0x1B, 0x9F, 0x59, 0x96, 0x37, 0x70, 0xED, 0x17, 0xAB, 0x06,
        0xB3, 0x7E, 0xFF, 0x38, 0x2C, 0x53, 0x87, 0xE4, 0x17, 0x07,
        0xF0, 0xCD, 0xED, 0xAC, 0x6C, 0x80, 0x73, 0x80, 0xB9, 0xD2,
        0x40, 0xC9, 0xDC, 0x0D, 0x8B, 0xE6, 0x99, 0xA5, 0x54, 0x36,
        0x17, 0xAC, 0x18, 0x62, 0x90, 0x2B, 0x5F, 0x10, 0xC8, 0x22,
        0xC6, 0xA6, 0xDB, 0x32, 0x40, 0xA9, 0xAA, 0x62, 0xAF, 0x93,
        0x56, 0x07, 0xBD, 0x17, 0xD2, 0x6A, 0xB7, 0xA3
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    static unsigned char dhg_1024<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        0x02
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    DH *dh <span class="token operator">=</span> DH_new<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    BIGNUM *p, *g<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dh <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> NULL<span class="token punctuation">;</span>
    p <span class="token operator">=</span> BN_bin2bn<span class="token punctuation">(</span>dhp_1024, sizeof<span class="token punctuation">(</span>dhp_1024<span class="token punctuation">)</span>, NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g <span class="token operator">=</span> BN_bin2bn<span class="token punctuation">(</span>dhg_1024, sizeof<span class="token punctuation">(</span>dhg_1024<span class="token punctuation">)</span>, NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> NULL <span class="token operator">||</span> g <span class="token operator">==</span> NULL
            <span class="token operator">||</span> <span class="token operator">!</span>DH_set0_pqg<span class="token punctuation">(</span>dh, p, NULL, g<span class="token punctuation">))</span> <span class="token punctuation">&#123;</span>
        DH_free<span class="token punctuation">(</span>dh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BN_free<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BN_free<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token builtin class-name">return</span> dh<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="SSHv2-协议中的-DH"><a href="#SSHv2-协议中的-DH" class="headerlink" title="SSHv2 协议中的 DH"></a><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/2563a7af53d380eb6294dd88d0d233d4b14e3f96.html#">SSHv2 协议中的 DH</a></h2><ol>
<li>Client 发送 e 值给 Server：</li>
</ol>
<p><img data-src="//img.to2b.cn/blog/ljk/1599657043148.png"></p>
<p>SSHv2 中 DH 的 p 和 g 固定，没有协商阶段</p>
<p>e &#x3D; g<sup>a</sup> mod p</p>
<ol start="2">
<li>Server 发送自身公钥、f、s 给 Client</li>
</ol>
<p><img data-src="//img.to2b.cn/blog/ljk/1599659538959.png"></p>
<p>f &#x3D; g<sup>b</sup> mod p</p>
<p>H &#x3D; hash(V_C||V_S||I_C||I_S||K_S||e||f||K)</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>string</td>
<td>V_C</td>
<td>客户端的初始报文（版本信息：SSH-2.0-xxx，不含结尾的 CR 和 LF）</td>
</tr>
<tr>
<td>string</td>
<td>V_S</td>
<td>服务器的初始报文</td>
</tr>
<tr>
<td>string</td>
<td>I_C</td>
<td>客户端 SSH_MSG_KEX_INIT 的有效载荷（不含开头的数据长度值）</td>
</tr>
<tr>
<td>string</td>
<td>I_S</td>
<td>服务器的同上</td>
</tr>
<tr>
<td>string</td>
<td>K_S</td>
<td>主机秘钥（dh gex reply（33)过程服务器发送 host key (RSA 公钥)）</td>
</tr>
<tr>
<td>mpint</td>
<td>e</td>
<td>客户端 DH 公钥</td>
</tr>
<tr>
<td>mpint</td>
<td>f</td>
<td>服务器 DH 公钥</td>
</tr>
<tr>
<td>mpint</td>
<td>K</td>
<td>共同 DH 计算结果</td>
</tr>
</tbody></table>
<p>s 是用 Server 私钥对 H 加密后的结果</p>
<ol start="3">
<li>Client 根据<del>&#x2F;.ssh&#x2F;known_hosts 文件，匹配 Server 公钥，如果</del>&#x2F;.ssh&#x2F;known_hosts 文件中没有 Server 公钥，说明是第一次建立连接，需要用户手动允许保存 Server 公钥</li>
<li>Client 计算预备主密钥 session key、同样的方式计算 H。使用 Server 公钥解密 s，解密得出的 H 和自己算出的 H 如果一样，则向 Server 发送 NEW KEYS，标志着密钥交换成功</li>
<li>自此，Client 和 Server 交换了 预备主密钥 K 和 H 值，通过前面协商的算法中的 <strong>密钥派生算法</strong> 导出各个业务的密钥：加密、MAC、IV，同时把 H 作为会话 ID（session ID）</li>
</ol>
<h2 id="TLS1-2-协议中的-DH"><a href="#TLS1-2-协议中的-DH" class="headerlink" title="TLS1.2 协议中的 DH"></a>TLS1.2 协议中的 DH</h2><ol>
<li>Client 和 Server 相互协商版本号 和 各种算法，并互相发送随机数 和 session ID</li>
</ol>
<p><img data-src="//img.to2b.cn/blog/ljk/1599723360793.png"></p>
<ol start="2">
<li>Server 发送数字证书给 Client</li>
<li>Server 发送 Pubkey 值给 Client，数字签名用来确保 Pubkey 的合法完整</li>
</ol>
<p><img data-src="//img.to2b.cn/blog/ljk/1599723599841.png"></p>
<p>TLS1.2 中 DH 的 p 和 g 固定，没有协商阶段</p>
<p>Pubkey &#x3D; g<sup>b</sup> mod p</p>
<ol start="4">
<li>Client 校验证书的合法性；Client 计算出预备主密钥 session key；Client 发送 Pubkey 值给 Server</li>
</ol>
<p>Pubkey &#x3D; g<sup>a</sup> mod p</p>
<ol start="5">
<li><p>Server 计算出预备主密钥 session key；Server 发送 New Session Ticket、Change Cipher Spec、Encrypted Handshake Message 给 Client：</p>
<ol>
<li><p>Encrypted Handshake Message：使用密钥加密的信息，目的一个是告诉服务端整个握手过程收到了什么数据，发送了什么数据，保证中间没人篡改报文，二是确认密钥的正确性，如果这个报文加解密校验成功，那么对称密钥就是正确的</p>
</li>
<li><p>Change Cipher Spec：编码改变通知，告知客户端，服务端已经切换到选定的加密套件（Cipher Suite），表示随后的信息都将用双方商定的加密方法和密钥发送。</p>
</li>
<li><p>New Session Ticket：这里有必要比较一下 session ticket 和 session ID 这两个角色：</p>
<p>如果出于某种原因，对话中断，就需要建立 SSL 连接，Client 在 client hello 阶段携带之前的 session ID，服务端确认 session ID 存在，双方就不再进行握手阶段剩余的步骤，而直接用已有的对话密钥进行加密通信，提高了重连的效率。</p>
<p>可是，session ID 往往只保留在一台服务器上（session ID 的存储及复用共享需要使用 redis 或 memcache 来实现），假如轮询到集群中其它服务器，无法识别该 session id，就无法恢复对话，session ticket 就是为了解决这个问题而诞生的，目前只有 Firefox 和 Chrome 浏览器支持。客户端不再发送 session ID，而是发送一个服务器在上一次对话中发送过来的 session ticket。这个 session ticket 是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方法。当服务器收到 session ticket 以后，解密后就不必重新生成对话密钥了。</p>
</li>
</ol>
</li>
<li><p>自此 Client 和 Server 都有了三个值：Client 随机数、Server 随机数、session key。这三个值可以计算出会话密钥，后面的通信使用会话密钥加密。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" class="post-title-link" itemprop="url">加密和安全</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:02:30" itemprop="dateCreated datePublished" datetime="2020-12-09T23:02:30+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">加密和安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安全机制"><a href="#安全机制" class="headerlink" title="安全机制"></a>安全机制</h2><h3 id="加密算法"><a href="#加密算法" class="headerlink" title="加密算法"></a>加密算法</h3><ul>
<li>对称加密</li>
<li>非对称(公钥)加密</li>
<li>单向加密</li>
<li>认证协议</li>
</ul>
<h4 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h4><p>将原始数据分割成固定大小的块，逐个进行加密；加密和解密使用同一个密钥。</p>
<p>优点：效率高。</p>
<p>缺点：因为加密和解密使用同一个密钥，所以需要通信的一方生成密钥并发送给对方，才能进行通信。万一密钥被截获，那别人就即可以给你发送加密信息，也可以破解你的加密信息。</p>
<p>常见的对称加算法：DES、3DES、AES、Blowfish,Twofish、IDEA,RC6,CAST5。</p>
<h4 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h4><p>密钥成对出现：公钥和私钥成，公钥加密只有对应的私钥才能解密，反之依然。</p>
<ol>
<li>通信双方 A 和 B，分别生成自己的公钥和私钥。</li>
<li>A 将公钥 A 发送给 B，B 将公钥 B 发送给 A。</li>
<li>A 将发送给 B 的信息用公钥 B 加密；B 将发送给 A 的信息用公钥 A 加密。</li>
<li>B 收到信息后用私钥 B 解密；A 接收到信息用私钥 A 解密。</li>
</ol>
<p>默认：数据使用公钥加密，私钥解密，签名使用私钥加密，公钥解密。</p>
<p>优点：私钥只存储在本机不发送给任何人，所以即使公钥被截获，没有对应的私钥也无法破解信息。可以说非对称加密是绝对安全的。</p>
<p>缺点：密钥长，算法复杂；加密解密效率低。</p>
<p>常见非对称加密算法：RSA、ECC、DSA<br>RSA：国际标准算法，算法简单，应用早，兼容性好，一般采用 2048 位的加密长度。<br>ECC：椭圆加密算法，算法复杂，除了兼容性，其他各方面都优于 RSA，未来肯定会取代 RSA。<br>DSA：只能用于签名&#x2F;认证，不能用于加密&#x2F;解密，性能比 RSA 好，RSA 既能签名&#x2F;认证，也能加密&#x2F;解密。</p>
<p><strong>综上：</strong>使用对称加密加密信息，效率高，只有在发送密钥的时候使用非对称加密，保证安全。</p>
<p>加密过的信息即使被截获，也看不懂里面的内容，因为没有对应的私钥，是无法解密的，但是因为公钥是公开的，所以非法用户可以冒充正常用户发送信息，这个问题可以使用数字签名解决。</p>
<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><p>哈希算法:也称为散列算法,将任意数据缩小成固定大小的“指纹”,称为 digest,即摘要。</p>
<p>特性:</p>
<ul>
<li>任意长度输入,固定长度输出</li>
<li>若修改数据,指纹也会改变,且有雪崩效应,数据的一点微小改变,生成的指纹值变化非常大。</li>
<li>无法从指纹中重新生成数据,即不要逆,具有单向性</li>
</ul>
<p>功能:数据完整性</p>
<p>常见算法：md5: 128bits、sha1: 160bits、sha224、sha256、sha384、sha512</p>
<h3 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h3><p>B 收到信息后，使用私钥 B 解密，解密后的信息中有 token 或 id 或 cookie 证明这条信息来自 A，但这是不可信的，因为这条信息完全可能是 C 发送的。而数字签名可以解决这问题。</p>
<p>生成数字签名的算法有两种：RSA 和<a target="_blank" rel="noopener" href="https://blog.csdn.net/aaqian1/article/details/89299520">DSA</a>。</p>
<p>数字签名有两个作用：1.证明消息来源；2.校验发送数据的完整性。</p>
<p>A 把发送的数据的哈希值使用私钥 A 加密，生成数字签名。数字签名和数据拼接在一起发送给 B，有两种方式拼接方式：1. 数字签名和加密后的数据拼接；2. 数字签名和明文拼接，再总体加密。</p>
<p>假设使用第一种拼接方式，那 B 收到信息后把数字签名取下，使用公钥 A 进行校验，下面以 DSA 算法为例简要介绍生成数字签名和校验数字签名的过程：</p>
<p>公钥 A 中包含 p<sub>A</sub>、g<sub>A</sub>、q<sub>A</sub>、y<sub>A</sub> 四个值<br>私钥 A 是 x<sub>A</sub> 一个值<br>发送的数据是 m</p>
<p>生成数字签名：<br>针对 m 生成一个随机数 k(key)，把 p<sub>A</sub>、g<sub>A</sub>、q<sub>A</sub>、y<sub>A</sub>、k 带入生成算法中出 r、s 两个值，所以数字签名由 r、s、k 三部分组成</p>
<p>校验数字签名：<br>把 p<sub>A</sub>、g<sub>A</sub>、q<sub>A</sub>、y<sub>A</sub>、r、s、m 带入校验算法中得出 v，如果 v&#x3D;r 则说明校验通过，否则校验不通过。<br>因为 p<sub>A</sub>、g<sub>A</sub>、q<sub>A</sub>、y<sub>A</sub>、r、s、m 中有公钥 A、数据 m 以及基于 m 和 k 生成的 r、s，所以如果通过校验，就说明信息一定来自 A（除非 A 把自己的私钥泄露了）、数据一定是完整的。</p>
<p>注意：每次个签名都需要一个新值 k，并且该值必须是随机选择的。如果不同的 m 使用了重复的 k，那么就会被破解出 k 值，然后推算出私钥 x</p>
<p><strong>综上：</strong>使用对称加密加密信息，效率高，只有在发送对称加密密钥的时候使用非对称加密（RSA）加密密钥，为密钥生成数字签名，确保密钥安全发送。</p>
<h3 id="签名证书-CA"><a href="#签名证书-CA" class="headerlink" title="签名证书 CA"></a>签名证书 CA</h3><p>数字签名通过校验的公钥确定信息来源。可是如果公钥被替换了呢，例如中间人攻击：</p>
<img data-src="//img.to2b.cn/blog/ljk/1599297423578.png" style="zoom: 80%;" />

<p>数字证书一般由数字证书认证机构（certificate authority，简称 CA）颁发，数字证书使用 CA 的私钥加密，其中包含了申请者的公钥和网址等信息。</p>
<p>A 给 B 发送证书，B 用 CA 公钥解密后取出公钥，以及网址等其他信息，进行校验，如果证书中的公钥 A 和本机存储的公钥 A 一致，然后网址等其他信息都对，说明本机存储的公钥 A 确实是真正的公钥 A，以后只要用公钥 A 校验通过的数字签名，就能证明信息来源是真的 A。</p>
<p>有同学问了，如果 B 储存的公钥 A 被替换成了公钥 C，然后 C 把 A 的证书截获下来，给 B 发送自己的证书 C，以此来冒充 A 不可以吗？答：显然不可以，因为证书中不只有公钥，即使证书中的公钥和 B 本机的公钥一致，其他的信息也校验不过关。</p>
<h4 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h4><p><code>lujinkai.com</code>使用 openssl 生成了一对证书和私钥，证书中包含了以下信息：</p>
<ul>
<li>公钥</li>
<li>host</li>
<li>地区</li>
<li>过期时间</li>
<li>…</li>
<li>使用私钥（注意是此证书签发机构的私钥，而非此证书中公钥对应的私钥）加密以上所有信息的哈希，生成签名</li>
</ul>
<h4 id="https"><a href="#https" class="headerlink" title="https"></a>https</h4><ol>
<li><p>用户浏览器访问<code>https://lujinkai.com</code>，<code>lujinkai.com</code>将以下数据返回给浏览器：</p>
<ol>
<li>证书</li>
<li>server 随机数</li>
<li>server DH 参数：这里应该是不用私钥加密的，毕竟公钥是公开的，加密没有意义。</li>
<li>server DH 参数的签名：使用私钥加密 server DH 参数的哈希值。签名保证了 server DH 合法完整。</li>
</ol>
</li>
<li><p>浏览器确认证书的有效性，如果证书有问题，浏览器会告警提示用户；</p>
</li>
<li><p>如果证书没有问题，浏览器从证书中解析出公钥，使用公钥对 server DH 参数进行验签，确认 server DH 参数没问题后，将以下数据发送给服务器：</p>
<ol>
<li>client DH 参数：用公钥解密 server DH 参数，使用 server DH 参数生成 client DH 参数</li>
<li>client 随机数</li>
</ol>
<p>这里不太清楚 client DH 参数和 client 随机数是否需要公钥加密。我估计应该是加密的。</p>
</li>
<li><p>双方现在都有以下数据：</p>
<ul>
<li>client 随机数</li>
<li>server 随机数</li>
<li>client DH 参数</li>
<li>server DH 参数</li>
</ul>
<p>双方根据 client DH 参数和 server DH 参数生成 Session key，然后 Session key、client 随机数、server 随机数生成“对话密钥”，这个“对话密钥”其实就是对称加密的口令。</p>
</li>
<li><p>后续的通信均使用“对话密钥”进行加解密。</p>
</li>
</ol>
<h3 id="gpg"><a href="#gpg" class="headerlink" title="gpg"></a>gpg</h3><p>gpg 实现加密通信，对称加密和非对称加密。下面的示范是 centos7 下的 gpg</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">gpg <span class="token punctuation">[</span>--homedir dir<span class="token punctuation">]</span> <span class="token punctuation">[</span>--options file<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token builtin class-name">command</span> <span class="token punctuation">[</span>args<span class="token punctuation">]</span></code></pre>

<p>–homedir dir：指定家目录</p>
<p>-option file：因为 gpg 的 option 众多，所以支持从文件中读取 options</p>
<p><strong>options：</strong></p>
<p>gpg.conf：在 homefir 下新建 gpg.conf，将长 option 写入其中，以后每次执行 gpg 命令都会自动加上 gpg.conf 中的 option，但是不能将 command 写入其中，没有意义。</p>
<p>范例：默认加密成二进制，修改为默认加密成 ASCII</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~/data/test$ gpg <span class="token parameter variable">-c</span> a.log
lujinkai@Z510:~/data/test$ <span class="token function">cat</span> a.log.gpg
	H���ݒ��O�v<span class="token operator">=</span>��F���<span class="token comment">#�`u&amp;����in��1��P_14޷1�N��kh�D�>�4���</span>
                                                                     ��F��v�i����I�<span class="token punctuation">]</span>�$����
lujinkai@Z510:~/data/test$ <span class="token builtin class-name">echo</span> <span class="token string">'armor'</span> <span class="token operator">>></span> ~/.gnupg/gpg.conf
lujinkai@Z510:~/data/test$ <span class="token function">cat</span> a.log.asc
-----BEGIN PGP MESSAGE-----

jA0ECQMCJBg8BY1yU6H/0k8BkJltvEvtfDi1XjjUfcRg6UC+TBU+YPighRYT9KXD
7pzT6/vdM46wigfOLHB33Ip8rlvl2tALTAt/YMcUKyEEKbnnf/b3j9K/RhGd5t3c
<span class="token operator">=</span>VKIs
-----END PGP MESSAGE-----</code></pre>

<ul>
<li>-a|–armor：Create ASCII armored output. The default is to create the binary OpenPGP format.</li>
<li>–cipher-algo name：指定对称加密的算法，算法列表使用<code>--version</code>查看</li>
<li>-r|–recipient name name：指定加密使用的公钥，为了防止重名，不要使用 uid，推荐使用 uid 加密后的字符串代替 uid。如果不指定则使用默认公钥，如果没有设置默认公钥，则交互式要求指定公钥</li>
<li>-o|–output file：输出到文件</li>
</ul>
<p><strong>command：</strong></p>
<ul>
<li>–version：查看 gpg 版本、支持的加密算法等信息</li>
<li>–dump-options：列出所有的 command 和 options</li>
<li>-e|–encrypt [file]：非对称加密，如果指定 file 则表示加密文件，如果不指定，我也不知道。。。</li>
<li>-c|–symmetric [file]：对称加密</li>
<li>-d|–decrypt：解密，会自动判读对称加密还是非对称加密，对称加密会自动识加密算法，非对称加密会自动判断使用哪个私钥解密（一台主机可以生成多个密钥对）</li>
<li>-k|–list-keys|–list-public-keys：列出已有公钥</li>
<li>-K|–list-secret-keys：列出已有私钥</li>
<li>–export [name]：导出公钥，不指定公钥则导出所有公钥到一个文件</li>
<li>–export-secret-keys|–export-secret-subkeys：导出私钥，注意只有 root 用户才能导出私钥，普通用户使用 sudo 也不行</li>
<li>–impor|–fast-import [密钥文件]：除了生成自己的密钥，还需要将他人的公钥或者你的其他密钥输入系统</li>
<li>–delete-keys name：删除指定公钥</li>
<li>–delete-secret-keys name：删除指定私钥</li>
<li>–delete-secret-and-public-key name：删除指定的密钥对，即公钥和私钥都删除</li>
</ul>
<p>对称加密：指定对称加密的算法，然后输入密码即可生成加密文件，解密的时候指定同样的算法，然后输入密码即可生成解密文件。可以认为对称加密的密钥就是 算法 + 密码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用AES 加密 a.log</span>
gpg --cipher-algo AES <span class="token parameter variable">-c</span> a.log

<span class="token comment"># 解密</span>
gpg <span class="token parameter variable">-d</span> a.log</code></pre>

<p>非对称加密：公钥加密，私钥解密，加密需要指定公钥，解密不需要指定私钥，会自动判断</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导出公钥lujinkai到文件lujinkai.pubkey</span>
lujinkai@Z510:~/data/test$ gpg <span class="token parameter variable">-o</span> lujinkai.pubkey  <span class="token parameter variable">--export</span> lujinkai
<span class="token comment"># 导出私钥lujinkai到文件lujinkai.subkey</span>
lujinkai@Z510:~/data/test$ gpg <span class="token parameter variable">-o</span> lujinkai.subkey  --export-secret-keys lujinkai

<span class="token comment"># 将公钥发送给centos7</span>
lujinkai@Z510:~/data/test$ <span class="token function">scp</span> lujinkai.pubkey root@10.0.0.7:~/data
<span class="token comment"># centos7将公钥导入自己的系统，然后用它加密文件，再将文件发给Z510</span>
<span class="token punctuation">[</span>root@centos7 data<span class="token punctuation">]</span><span class="token comment">#gpg --import ./lujinkai.pubkey</span>
<span class="token punctuation">[</span>root@centos7 data<span class="token punctuation">]</span><span class="token comment">#seq 10 > a.log</span>
lujinkai@Z510:~/data/test$ <span class="token function">scp</span> root@10.0.0.7:/root/data/a.log.asc ./
a.log.asc                                                                             <span class="token number">100</span>%  <span class="token number">409</span>   <span class="token number">804</span>.2KB/s   00:00

<span class="token comment"># Z510解密成功</span>
lujinkai@Z510:~/data/test$ gpg <span class="token parameter variable">-d</span> a.log.asc
gpg: encrypted with <span class="token number">1024</span>-bit RSA key, ID 1BB25A5FFEAB69DD, created <span class="token number">2020</span>-09-06
      <span class="token string">"lujinkai &lt;ljkk@qq.com>"</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">4</span>
<span class="token number">5</span>
<span class="token number">6</span>
<span class="token number">7</span>
<span class="token number">8</span>
<span class="token number">9</span>
<span class="token number">10</span></code></pre>

<h2 id="SSL-x2F-TLS"><a href="#SSL-x2F-TLS" class="headerlink" title="SSL &#x2F; TLS"></a><a target="_blank" rel="noopener" href="https://www.sohu.com/a/117550504_505818">SSL &#x2F; TLS</a></h2><h3 id="PKI"><a href="#PKI" class="headerlink" title="PKI"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30136885">PKI</a></h3><p>PKI：Public Key Infrastructure 公共密钥加密体系，构成 PKI 的三个要素：</p>
<ol>
<li>证书：一对密钥，通常把公钥叫做证书</li>
<li>认证机关：CA</li>
<li>证书库：</li>
</ol>
<p><strong>证书类型：</strong></p>
<ul>
<li>证书授权机构的证书：根证书和中间证书，跟证书颁发中间证书，机构给自己颁发根证书。</li>
<li>服务器证书：ssl 证书，就是一对密钥，私钥保存，公钥公开，通常把公钥叫做证书。</li>
<li>用户证书：以支付宝的数字证书为例，是支付宝签发给用户的一对密钥，使用的是 RSA 算法，2048 位，私钥安装到 windows 系统，所以只能安装到 ie 浏览器，不可到处，所以只能在这一台电脑上使用。</li>
</ul>
<p><strong>X.509：</strong>定义证书的结构以及认证协议标准</p>
<ul>
<li>版本号</li>
<li>序列号</li>
<li>签名算法</li>
<li>颁发者</li>
<li>有效期限</li>
<li>主体名称</li>
</ul>
<p><strong>获取证书两种方法：</strong></p>
<ol>
<li><p>自签名的证书： 自已签发自己的公钥</p>
</li>
<li><p>使用证书授权机构：</p>
<ol>
<li><p>生成证书请求（csr）</p>
</li>
<li><p>将证书请求 csr 发送给 CA</p>
</li>
<li><p>CA 签名颁发证书</p>
</li>
</ol>
</li>
</ol>
<h3 id="SSL-x2F-TLS-组成："><a href="#SSL-x2F-TLS-组成：" class="headerlink" title="SSL&#x2F;TLS 组成："></a>SSL&#x2F;TLS 组成：</h3><p>SSL&#x2F;TLS 位于传输层与应用层之间，主要是传输层，对网络传输进行加密。</p>
<img data-src="//img.to2b.cn/blog/ljk/1599395635747.png"  />

<ul>
<li><p>Handshake 协议:包括协商安全参数和密码套件、服务器身份认证(客户端身份认证可选)、密钥交换</p>
</li>
<li><p>ChangeCipherSpec 协议:一条消息表明握手协议已经完成</p>
</li>
<li><p>Alert 协议:对握手协议中一些异常的错误提醒,分为 fatal 和 warning 两个级别,fatal 类型错误会直接中断 SSL 链接,而 warning 级别的错误 SSL 链接仍可继续,只是会给出错误警告</p>
</li>
<li><p>Record 协议:包括对消息的分段、压缩、消息认证和完整性保护、加密等</p>
</li>
</ul>
<h3 id="TLS-实现过程"><a href="#TLS-实现过程" class="headerlink" title="TLS 实现过程"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lv6965/p/7859925.html">TLS 实现过程</a></h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 data<span class="token punctuation">]</span><span class="token comment">#curl https://www.baidu.com</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1599398161213.png"></p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p><img data-src="//img.to2b.cn/blog/ljk/1599483726731.png"></p>
<h2 id="Base64-编码"><a href="#Base64-编码" class="headerlink" title="Base64 编码"></a>Base64 编码</h2><p>base64 是编码，不是加密。</p>
<img data-src="//img.to2b.cn/blog/ljk/1599483856018.png"  />

<p>编号 0-63，一共 64 个，2<sup>6</sup>&#x3D;64，将数据的二进制以每 6 位一组划分，高位添俩 0，凑 8 位就是一个字节，将字节转成十进制，然后对照上表，生成 base64 编码。</p>
<h2 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h2><p>OpenSSL 是一个开放源代码的软件库包，应用程序可以使用这个包来进行安全通信，避免窃听，同时确认另一端连线者的身份。这个包广泛被应用在互联网的网页服务器上。</p>
<p>其主要库是以 C 语言所写成，实现了基本的加密功能，实现了 SSL 与 TLS 协议。</p>
<p>包括三个组件：</p>
<ul>
<li>libcrypto：用于实现加密和解密的库</li>
<li>libssl：用于实现 ssl 通信协议的安全库</li>
<li>openssl：多用途命令行工具</li>
</ul>
<h3 id="openssl"><a href="#openssl" class="headerlink" title="openssl"></a>openssl</h3><p>openssl 是 OpenSSL 的命令行工具。</p>
<h2 id="ssh-服务"><a href="#ssh-服务" class="headerlink" title="ssh 服务"></a>ssh 服务</h2><p>知识补充：</p>
<ul>
<li>MAC: Message Authentication Code，单向加密的一种延伸应用，用于实现网络通信中保证所传输数据的完整性机制</li>
<li>HMAC：hash-based MAC，使用哈希算法</li>
</ul>
<p>SSH: secure shell protocol, 22&#x2F;tcp, 安全的远程登录，实现加密通信，代替传统的 telnet 协议。</p>
<p>SSH 协议位于应用层与传输层之间，默认监听 22 端口号，安全的远程登录。</p>
<p>软件实现：1. OpenSSH，CentOS 默认安装；2. dropbear，更加轻量级。</p>
<h3 id="SSH-协议-和-SSL-x2F-TLS-协议"><a href="#SSH-协议-和-SSL-x2F-TLS-协议" class="headerlink" title="SSH 协议 和 SSL&#x2F;TLS 协议"></a>SSH 协议 和 SSL&#x2F;TLS 协议</h3><p><strong>SSH：</strong></p>
<p>SSH 协议比较简单，简单的代价就是 SSH 无法判断 Server 公钥的真伪，需要人工判断，手动保存。</p>
<p>SSH 是专为 shell 设计的一种通信协议，只有 SSH 客户端和 SSH 服务端之间通信才使用这个协议。</p>
<p><strong>SSL&#x2F;TLS：</strong></p>
<p>SSL&#x2F;LTS 依赖 KPI 体系，利用数字证书确保 Server 公钥的合法性。</p>
<p>而 SSL&#x2F;TLS 是一种更加通用的安全协议，它的目标是建立一种对上层应用协议透明的，可以依赖的安全协议。</p>
<p>HTTP、FTP、电子邮件协议以及其他所有应用层协议，都可结合 SSL&#x2F;TLS 实现加密通信。</p>
<h3 id="OpenSSH"><a href="#OpenSSH" class="headerlink" title="OpenSSH"></a>OpenSSH</h3><p>CentOS 默认安装 OpenSSH，比较常用</p>
<h3 id="Dropbear"><a href="#Dropbear" class="headerlink" title="Dropbear"></a>Dropbear</h3><p>Dropbear 是一个相对较小的 SSH 服务器和客户端。它运行在一个基于 POSIX 的各种平台。 Dropbear 是开源软件，期望在存储器与运算能力有限的情况下取代 OpenSSH，尤其是嵌入式系统</p>
<h3 id="ssh-其他相关工具"><a href="#ssh-其他相关工具" class="headerlink" title="ssh 其他相关工具"></a>ssh 其他相关工具</h3><h4 id="sshfs"><a href="#sshfs" class="headerlink" title="sshfs"></a>sshfs</h4><p>EPEL 源提供，目前 CentOS8 还没有提供，可以利用 ssh 协议挂载远程目录</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#yum install fuse-sshfs</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#sshfs 10.0.0.8:/data /mnt</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#df /mnt</span>
Filesystem 1K-blocks Used Available Use% Mounted on
<span class="token number">10.0</span>.0.8:/data <span class="token number">52403200</span> <span class="token number">398576</span> <span class="token number">52004624</span> <span class="token number">1</span>% /mnt</code></pre>

<h4 id="sshpass"><a href="#sshpass" class="headerlink" title="sshpass"></a>sshpass</h4><p>EPEL 源提供，ssh 登陆不能在命令行中指定密码。sshpass 的出现，解决了这一问题。sshpass 用于非交互 SSH 的密码验证，一般用在 sh 脚本中，无须再次输入密码（本机 known_hosts 文件中有的主机才能生效）。使用 -p 参数指定明文密码，然后直接登录远程服务器，支持密码从命令行、文件、环境变量中读取</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">sshpass <span class="token punctuation">[</span>option<span class="token punctuation">]</span> <span class="token builtin class-name">command</span> parameters</code></pre>

<ul>
<li>-p password #后跟密码它允许你用 -p 参数指定明文密码，然后直接登录远程服务器</li>
<li>-f filename #后跟保存密码的文件名，密码是文件内容的第一行。</li>
<li>-e #将环境变量 SSHPASS 作为密码</li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$sshpass</span> <span class="token parameter variable">-p</span> <span class="token number">123456</span> <span class="token function">ssh</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no root@10.0.0.7
Warning: Permanently added <span class="token string">'10.0.0.7'</span> <span class="token punctuation">(</span>ECDSA<span class="token punctuation">)</span> to the list of known hosts.
Last login: Thu Sep <span class="token number">10</span> <span class="token number">14</span>:59:43 <span class="token number">2020</span> from <span class="token number">10.0</span>.0.1
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<p>范例：批量修改多台主机的 root 密码为随机密码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#cat sshpass.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">HOSTS</span><span class="token operator">=</span><span class="token string">"
10.0.0.6
10.0.0.7
10.0.0.18
10.0.0.28
"</span>
<span class="token assign-left variable">PASS</span><span class="token operator">=</span>magedu
ssh-keygen <span class="token parameter variable">-P</span> <span class="token string">""</span> <span class="token parameter variable">-f</span> /root/.ssh/id_rsa <span class="token operator">&amp;></span>/dev/null
<span class="token function">rpm</span> <span class="token parameter variable">-q</span> sshpass <span class="token operator">&amp;></span>/dev/null <span class="token operator">||</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> sshpass <span class="token operator">&amp;></span>/dev/null
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$HOSTS</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
	<span class="token punctuation">&#123;</span>
		sshpass <span class="token parameter variable">-p</span> <span class="token variable">$PASS</span> ssh-copy-id <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token parameter variable">-i</span> /root/.ssh/id_rsa.pub <span class="token variable">$i</span> <span class="token operator">&amp;></span>/dev/null
	<span class="token punctuation">&#125;</span> <span class="token operator">&amp;</span>
<span class="token keyword">done</span>
<span class="token function">wait</span>	<span class="token comment"># 等待所有子后台进程结束</span>
<span class="token comment"># 说明：使用 &amp; + wait 实现“多进程”并发执行</span></code></pre>

<h4 id="自动化运维工具-pssh"><a href="#自动化运维工具-pssh" class="headerlink" title="自动化运维工具 pssh"></a>自动化运维工具 pssh</h4><p>EPEL 源中提供了多个自动化运维工具：pssh、pdsh、mussh</p>
<p>如果机器不多，这些自动化运维工具还是好用的。</p>
<h5 id="pssh"><a href="#pssh" class="headerlink" title="pssh"></a>pssh</h5><p>基于 python 编写，可在多台服务器上执行命令的工具，也可实现文件复制，提供了基于 ssh 和 scp 的多个并行工具，项目：<a target="_blank" rel="noopener" href="http://code.google.com/p/parallel-ssh/">http://code.google.com/p/parallel-ssh/</a></p>
<p>ssh 能用的选项 pssh 也能用，pssh 命令选项如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-H</span>        <span class="token comment"># 主机字符串，内容格式”[user@]host[:port]”</span>
<span class="token parameter variable">-h</span> <span class="token function">file</span>   <span class="token comment"># 主机列表文件，内容格式”[user@]host[:port]”</span>
<span class="token parameter variable">-A</span>        <span class="token comment"># 手动输入密码模式</span>
<span class="token parameter variable">-i</span>        <span class="token comment"># 每个服务器内部处理信息输出</span>
<span class="token parameter variable">-l</span>        <span class="token comment"># 登录使用的用户名</span>
<span class="token parameter variable">-p</span>        <span class="token comment"># 并发的线程数【可选】</span>
<span class="token parameter variable">-o</span>        <span class="token comment"># 输出的文件目录【可选】</span>
<span class="token parameter variable">-e</span>        <span class="token comment"># 错误输出文件【可选】</span>
<span class="token parameter variable">-t</span>        <span class="token comment"># TIMEOUT 超时时间设置，0无限制【可选】</span>
<span class="token parameter variable">-O</span>        <span class="token comment"># SSH的选项</span>
<span class="token parameter variable">-P</span>        <span class="token comment"># 打印出服务器返回信息</span>
<span class="token parameter variable">-v</span>        <span class="token comment"># 详细模式</span>
<span class="token parameter variable">--version</span> <span class="token comment"># 查看版本</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 最好先设置免密登录，否则需要使用sshpass</span>

<span class="token comment"># 一台主机：用 ssh remote_host command 也能实现同样的效果</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$pssh</span> <span class="token parameter variable">-H</span> root@10.0.0.7 <span class="token parameter variable">-i</span> <span class="token function">hostname</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 05:56:05 <span class="token punctuation">[</span>SUCCESS<span class="token punctuation">]</span> root@10.0.0.7
centos7.magedu.org

<span class="token comment"># 多台主机</span>
<span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token variable">$cat</span> host.list
root@10.0.0.7:22
lujinkai@10.0.0.101:22
<span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token variable">$pssh</span> <span class="token parameter variable">-h</span> host.list <span class="token parameter variable">-i</span> <span class="token function">hostname</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 06:05:10 <span class="token punctuation">[</span>SUCCESS<span class="token punctuation">]</span> root@10.0.0.7:22
centos7.magedu.org
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> 06:05:10 <span class="token punctuation">[</span>SUCCESS<span class="token punctuation">]</span> lujinkai@10.0.0.101:22
ubuntu1804</code></pre>

<h5 id="pdsh"><a href="#pdsh" class="headerlink" title="pdsh"></a>pdsh</h5><p>Parallel remote shell program，是一个多线程远程 shell 客户端，可以并行执行多个远程主机上的命令。 可使用几种不同的远程 shell 服务，包括 rsh，Kerberos IV 和 ssh，项目： <a target="_blank" rel="noopener" href="https://pdsh.googlecode.com/">https://pdsh.googlecode.com/</a></p>
<h5 id="mussh"><a href="#mussh" class="headerlink" title="mussh"></a>mussh</h5><p>Multihost SSH wrapper，是一个 shell 脚本，允许使用命令在多个主机上通过 ssh 执行命令。 可使用 ssh-agent 和 RSA&#x2F;DSA 密钥，以减少输入密码，项目：<a target="_blank" rel="noopener" href="http://www.sourceforge.net/projects/mussh">http://www.sourceforge.net/projects/mussh</a></p>
<h5 id="pscp-pssh"><a href="#pscp-pssh" class="headerlink" title="pscp.pssh"></a>pscp.pssh</h5><p>pscp.pssh 功能是将本地文件批量复制到远程主机</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#将本地curl.sh 复制到/app/目录</span>
pscp.pssh <span class="token parameter variable">-h</span> host.txt /root/test/curl.sh /app/
<span class="token comment">#将本地多个文件批量复制到/app/目录</span>
pscp.pssh <span class="token parameter variable">-h</span> host.txt /root/f1.sh /root/f2.sh /app/
<span class="token comment">#将本地目录批量复制到/app/目录</span>
pscp.pssh <span class="token parameter variable">-h</span> host.txt <span class="token parameter variable">-r</span> /root/test/ /app/</code></pre>

<h5 id="pslurp"><a href="#pslurp" class="headerlink" title="pslurp"></a>pslurp</h5><p>pslurp 功能是将远程主机的文件批量复制到本地</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

<h2 id="文件完整性调查-AIDE"><a href="#文件完整性调查-AIDE" class="headerlink" title="文件完整性调查 AIDE"></a>文件完整性调查 AIDE</h2><p>AIDE（Advanced Intrusion Detection Environment 高级入侵检测环境）是一个入侵检测工具，主要用途是检查文件的完整性，审计计算机上的那些文件被更改过了</p>
<p>AIDE 能够构造一个指定文件的数据库，它使用 aide.conf 作为其配置文件。AIDE 数据库能够保存文件的各种属性，包括：权限(permission)、索引节点序号(inode number)、所属用户(user)、所属用户组(group)、文件大小、最后修改时间(mtime)、创建时间(ctime)、最后访问时间(atime)、增加的大小以及连接数。AIDE 还能够使用下列算法：sha1、md5、rmd160、tiger，以密文形式建立每个文件的校验码或散列号</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1599738636243.png"></p>
<p>这个数据库不应该保存那些经常变动的文件信息，例如：日志文件、邮件、&#x2F;proc 文件系统、用户起始目录以及临时目录</p>
<p>配置文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/aide.conf</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">@@define DBDIR /var/lib/aide	<span class="token comment"># 数据库目录</span>
@@define LOGDIR /var/log/aide	<span class="token comment"># 日志目录</span>

<span class="token assign-left variable">database</span><span class="token operator">=</span>file:@@<span class="token punctuation">&#123;</span>DBDIR<span class="token punctuation">&#125;</span>/aide.db.gz	<span class="token comment"># 数据库文件，真正生效的文件</span>
<span class="token assign-left variable">database_out</span><span class="token operator">=</span>file:@@<span class="token punctuation">&#123;</span>DBDIR<span class="token punctuation">&#125;</span>/aide.db.new.gz	<span class="token comment"># 命令生成数据库文件，需要改成aide.db.gz才能生效</span>

<span class="token comment"># 默认属性</span>
<span class="token comment">#p:      permissions</span>
<span class="token comment">#i:      inode:</span>
<span class="token comment">#n:      number of links</span>
<span class="token comment">#u:      user</span>
<span class="token comment">#g:      group</span>
<span class="token comment">#s:      size</span>
<span class="token comment">#b:      block count</span>
<span class="token comment">#m:      mtime</span>
<span class="token comment">#a:      atime</span>
<span class="token comment">#c:      ctime</span>
<span class="token comment">#S:      check for growing size</span>
<span class="token comment">#acl:           Access Control Lists</span>
<span class="token comment">#selinux        SELinux security context</span>
<span class="token comment">#xattrs:        Extended file attributes</span>
<span class="token comment">#md5:    md5 checksum</span>
<span class="token comment">#sha1:   sha1 checksum</span>
<span class="token comment">#sha256:        sha256 checksum</span>
<span class="token comment">#sha512:        sha512 checksum</span>
<span class="token comment">#rmd160: rmd160 checksum</span>
<span class="token comment">#tiger:  tiger checksum</span>

<span class="token comment">#haval:  haval checksum (MHASH only)</span>
<span class="token comment">#gost:   gost checksum (MHASH only)</span>
<span class="token comment">#crc32:  crc32 checksum (MHASH only)</span>
<span class="token comment">#whirlpool:     whirlpool checksum (MHASH only)</span>
<span class="token comment">#R:             p+i+n+u+g+s+m+c+acl+selinux+xattrs+md5</span>
<span class="token comment">#L:             p+i+n+u+g+acl+selinux+xattrs</span>
<span class="token comment">#E:             Empty group</span>
<span class="token comment">#>:             Growing logfile p+u+g+i+n+S+acl+selinux+xattrs</span>


<span class="token comment"># 各种预定义规则，指定需要保存的属性，可以删除，可以参考格式自定义</span>
ALLXTRAHASHES <span class="token operator">=</span> sha1+rmd160+sha256+sha512+tiger
EVERYTHING <span class="token operator">=</span> R+ALLXTRAHASHES
NORMAL <span class="token operator">=</span> p+i+n+u+g+s+m+c+acl+selinux+xattrs+sha512
DIR <span class="token operator">=</span> p+i+n+u+g+acl+selinux+xattrs
<span class="token punctuation">..</span>.

<span class="token comment"># 默认监控的文件和目录，按照指定的规则保存文件的各种属性，可以删除，可以自定义</span>
/boot        CONTENT_EX
/opt/        CONTENT
/root/<span class="token punctuation">\</span><span class="token punctuation">..</span>* PERMS	<span class="token comment"># 支持正则</span>
/usr/    CONTENT_EX
<span class="token operator">!</span>/usr/src/	<span class="token comment"># ！表示不监控此文件或目录</span>
<span class="token operator">!</span>/usr/tmp/
/etc/hosts$      CONTENT_EX		<span class="token comment"># $匹配结尾，说明只监控单个文件</span>
/etc/host.conf$  CONTENT_EX
/etc/hostname$   CONTENT_EX</code></pre>

<h3 id="aide"><a href="#aide" class="headerlink" title="aide"></a>aide</h3><pre class="language-bash" data-language="bash"><code class="language-bash">aide <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token builtin class-name">command</span></code></pre>

<p>command：</p>
<ul>
<li>-i：初始化，按照 aide.conf 中的设置 对指定目录 按照指定规则 保存快照到数据库</li>
<li>-C：检查，把数据库中保存的文件状态 和 现在的文件 做对比，发现那些文件的那些属性发生了变化</li>
<li>-u：更新数据库</li>
<li>-E：比较两个数据库</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 初始化默认的AIDE的库</span>
/usr/local/bin/aide <span class="token parameter variable">-i</span> <span class="token operator">|</span> <span class="token parameter variable">--init</span>

<span class="token comment"># 生成检查数据库（建议初始数据库存放到安全的地方）</span>
<span class="token builtin class-name">cd</span> /var/lib/aide
<span class="token function">mv</span> aide.db.new.gz aide.db.gz

<span class="token comment"># 检测</span>
/usr/local/bin/aide <span class="token parameter variable">-C</span> <span class="token operator">|</span> <span class="token parameter variable">--check</span>

<span class="token comment"># 更新数据库</span>
aide <span class="token parameter variable">-u</span> <span class="token operator">|</span> <span class="token parameter variable">--update</span></code></pre>

<h2 id="sudo"><a href="#sudo" class="headerlink" title="sudo"></a>sudo</h2><p>sudo 即 superuser do，允许系统管理员让普通用户执行一些或者全部的 root 命令的一个工具，相比 su 命令，sudo 不需要告知普通用户 root 用户的密码。</p>
<h3 id="sudo-特性"><a href="#sudo-特性" class="headerlink" title="sudo 特性"></a>sudo 特性</h3><ul>
<li>sudo 能够授权指定用户在指定主机上运行某些命令。如果未授权用户尝试使用 sudo，会提示联系管理员</li>
<li>sudo 提供了丰富的日志，详细地记录了每个用户干了什么。它能够将日志传到中心主机或者日志服务器</li>
<li>sudo 使用时间戳文件来执行类似的“检票”系统。当用户调用 sudo 并且输入它的密码时，用户获得了一张存活期为 5 分钟的票</li>
<li>sudo 的配置文件是 sudoers 文件，它允许系统管理员集中的管理用户的使用权限和使用的主机。它所存放的位置默认是在&#x2F;etc&#x2F;sudoers，属性必须为 0440</li>
</ul>
<h3 id="sudo-组成"><a href="#sudo-组成" class="headerlink" title="sudo 组成"></a>sudo 组成</h3><ul>
<li><p>配置文件：&#x2F;etc&#x2F;sudo.conf</p>
</li>
<li><p>授权规则配置文件：&#x2F;etc&#x2F;sudoers、&#x2F;etc&#x2F;sudoers.d</p>
</li>
<li><p>安全编辑授权规则文件和语法检查工具：&#x2F;usr&#x2F;sbin&#x2F;visudo</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查语法</span>
visudo <span class="token parameter variable">-c</span>

<span class="token comment"># 检查指定配置文件语法</span>
visudo <span class="token parameter variable">-f</span> /etc/sudoers.d/test</code></pre>
</li>
<li><p>授权编辑规则文件的工具：&#x2F;usr&#x2F;bin&#x2F;sudoedit</p>
<p>相当于用默认编辑器（可以修改）打开配置文件，只不过有检查语法格式的功能</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@ubuntu1804:~<span class="token comment"># export EDITOR=vim	# 修改ubuntu的visudo的默认编辑器为vim</span></code></pre>
</li>
<li><p>执行授权命令：&#x2F;usr&#x2F;bin&#x2F;sudo</p>
</li>
<li><p>时间戳文件：&#x2F;var&#x2F;db&#x2F;sudo</p>
</li>
<li><p>日志文件：&#x2F;var&#x2F;log&#x2F;secure</p>
</li>
</ul>
<h3 id="sudo-命令"><a href="#sudo-命令" class="headerlink" title="sudo 命令"></a>sudo 命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token parameter variable">-h</span> <span class="token operator">|</span> <span class="token parameter variable">-K</span> <span class="token operator">|</span> <span class="token parameter variable">-k</span> <span class="token operator">|</span> <span class="token parameter variable">-V</span>
<span class="token function">sudo</span> <span class="token parameter variable">-l</span> <span class="token punctuation">[</span>-AknS<span class="token punctuation">]</span> <span class="token punctuation">[</span>-g group<span class="token punctuation">]</span> <span class="token punctuation">[</span>-h host<span class="token punctuation">]</span> <span class="token punctuation">[</span>-p prompt<span class="token punctuation">]</span> <span class="token punctuation">[</span>-U user<span class="token punctuation">]</span> <span class="token punctuation">[</span>-u user<span class="token punctuation">]</span> <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
<span class="token function">sudo</span> <span class="token punctuation">[</span>-u user<span class="token punctuation">]</span> COMMAND
<span class="token function">sudo</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-u</span> wang</code></pre>

<ul>
<li>-V：显示版本信息等配置信息</li>
<li>-K：第一次使用 sudo 需要输入密码，输入密码后会在&#x2F;run&#x2F;sudo&#x2F;ts 目录下生成一个时间戳文件，这个时间戳文件缓存密码，超时缓存会失效。-K 会删除对应的时间戳缓存文件，也就是说下次使用 sudo 需要输入密码。</li>
<li>-k：让对应的时间戳文件失效，也是也是下次使用 sudo 需要输入密码。</li>
<li>-i：登录，默认登录到 root 用户，如果是登录到其它用户，需配合 -u user 指定用户</li>
<li>-l|ll：列出用户在主机上可用的和被禁止的命令</li>
<li>-u：指定用户，默认是 root 用户</li>
<li>-b：后台执行命令</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 etc<span class="token punctuation">]</span><span class="token variable">$whoami</span>
root
<span class="token punctuation">[</span>root@centos8 etc<span class="token punctuation">]</span><span class="token variable">$sudo</span> <span class="token parameter variable">-u</span> lujinkai <span class="token function">whoami</span>	<span class="token comment"># 指定lujinkai用户执行whoami命令</span>
lujinkai

<span class="token punctuation">[</span>root@centos8 etc<span class="token punctuation">]</span><span class="token variable">$sudo</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-u</span> lujinkai	<span class="token comment"># 切换到lujinkai用户</span>
<span class="token punctuation">[</span>lujinkai@centos8 ~<span class="token punctuation">]</span>$</code></pre>

<h3 id="sudo-授权规则配置"><a href="#sudo-授权规则配置" class="headerlink" title="sudo 授权规则配置"></a>sudo 授权规则配置</h3><p>配置文件格式说明：&#x2F;etc&#x2F;sudoers, &#x2F;etc&#x2F;sudoers.d&#x2F;</p>
<p>配置文件中支持使用通配符 glob</p>
<p>配置文件规则有两类：</p>
<ol>
<li>别名定义：用于应对比较复杂的授权情况，不是必须的</li>
<li>授权规则：必须的</li>
</ol>
<p>sudoers 授权规则格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">用户 登入主机<span class="token operator">=</span><span class="token punctuation">(</span>代表用户<span class="token punctuation">)</span> 命令
user <span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token punctuation">(</span>runas<span class="token punctuation">)</span> <span class="token builtin class-name">command</span></code></pre>

<ul>
<li>user 和 (runas)</li>
<li>用户： 用户名 <code>username</code>，或者 uid <code>#uid</code><ul>
<li>用户组：组名 <code>%group_name</code>，或者 gid <code>%#id</code></li>
<li>user_alias|runas_alias</li>
</ul>
</li>
<li>host<ul>
<li>ip 或 域名</li>
<li>网段，例如：10.0.0.0&#x2F;24 表示 10 网段</li>
<li>host_alias</li>
</ul>
</li>
<li>command<ul>
<li>命令</li>
<li>directory</li>
<li>sudoedit</li>
<li>Cmnd_Alias</li>
</ul>
</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># root用户可以登入任何主机，代表任何用户，执行任何命令，当然这条规则是多余的，root用户本来就拥有无限的权限</span>
root <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span> ALL</code></pre>

<p>别名有四种，别名必须是大写字母开头：</p>
<ul>
<li>User_Alias</li>
<li>Runas_Alias</li>
<li>Host_Alias</li>
<li>Cmnd_Alias</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">Alias_Type NAME1 <span class="token operator">=</span> item1,item2,item3 <span class="token builtin class-name">:</span> NAME2 <span class="token operator">=</span> item4, item5</code></pre>

<h3 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">Student <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span> ALL	<span class="token comment"># Student用户</span>
%wheel <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span> ALL	<span class="token comment"># wheel用户组</span>

User_Alias <span class="token assign-left variable">NETADMIN</span><span class="token operator">=</span> netuser1,netuser2		<span class="token comment"># 定义用户别名：NETADMIN</span>
Cmnd_Alias NETCMD <span class="token operator">=</span> /usr/sbin/ip,/usr/sbin/ifconfig		<span class="token comment"># 定义命令别名：NETCMD</span>
NETADMIN <span class="token assign-left variable">ALL</span><span class="token operator">=</span>（root） NETCMD	<span class="token comment"># NETADMIN 中的用户可以在所有主机上，代表root执行NETCMD 中的命令</span>

User_Alias <span class="token assign-left variable">SYSADER</span><span class="token operator">=</span>wang,mage,%admins	<span class="token comment"># 定义用户别名：SYSADER</span>
User_Alias <span class="token assign-left variable">DISKADER</span><span class="token operator">=</span>tom		<span class="token comment"># 定义用户别名：DISKADER</span>
Host_Alias <span class="token assign-left variable">SERS</span><span class="token operator">=</span>www.magedu.com,172.16.0.0/24	<span class="token comment"># 定义主机别名：SERS</span>
Runas_Alias <span class="token assign-left variable">OP</span><span class="token operator">=</span>root		<span class="token comment"># 定义代表用户：OP</span>
Cmnd_Alias <span class="token assign-left variable">SYDCMD</span><span class="token operator">=</span>/bin/chown,/bin/chmod		<span class="token comment"># 定义命令别名：SYDCMD</span>
Cmnd_Alias <span class="token assign-left variable">DSKCMD</span><span class="token operator">=</span>/sbin/parted,/sbin/fdisk	<span class="token comment"># 定义命令别名：DSKCMD</span>
<span class="token comment"># wang,mage,%admins 这三个用户可以在 www.magedu.com,172.16.0.0/24 主机上代表任何用户（空缺表示ALL）执行 /bin/chown,/bin/chmod 和 /sbin/parted,/sbin/fdisk 这些命令</span>
SYSADER <span class="token assign-left variable">SERS</span><span class="token operator">=</span> SYDCMD,DSKCMD
<span class="token comment"># tom 可以在所有主机上代表 root 执行 /sbin/parted,/sbin/fdisk 这两个命令</span>
DISKADER <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>OP<span class="token punctuation">)</span> DSKCMD

User_Alias ADMINUSER <span class="token operator">=</span> adminuser1,adminuser2
<span class="token comment"># 可以使用正则，！表示禁止执行这条命令</span>
Cmnd_Alias ADMINCMD <span class="token operator">=</span> /usr/sbin/useradd，/usr/sbin/usermod, /usr/bin/passwd <span class="token punctuation">[</span>a-zA-Z<span class="token punctuation">]</span>*, <span class="token operator">!</span>/usr/bin/passwd root
<span class="token comment"># NOPASSWD: 表示不需要输入密码</span>
<span class="token comment"># adminuser1,adminuser2 可以在任何主机代表root执行useradd、usermod、passwd这三个命令（passwd命令修改的密码只能是字母开头，且不能修改root的密码），而且不需要输入密码</span>
ADMINUSER <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> NOPASSWD:ADMINCMD，PASSWD:/usr/sbin/userdel

<span class="token comment"># wang用户可以代表tom和jerry用户，如果-u不指定则默认表示tom</span>
Defaults:wang <span class="token assign-left variable">runas_default</span><span class="token operator">=</span>tom
wang <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>tom,jerry<span class="token punctuation">)</span> ALL

<span class="token comment"># wang可以代表root在192.168.1.6,192.168.1.8两台主机上执行/usr/sbin/目录下的所有命令，除了useradd</span>
wang <span class="token number">192.168</span>.1.6,192.168.1.8<span class="token operator">=</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> /usr/sbin/,<span class="token operator">!</span>/usr/sbin/useradd</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 这时一条危险的授权命令，如何解决？</span>
wang <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span> /bin/cat /var/log/messages*</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># wang可以使用sudoedit命令，表示wang可以修改授权文件，通过修改授权文件，wang可以拥有所有权限</span>
Wang <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span> sudoedit</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>wang@centos8 ~<span class="token punctuation">]</span><span class="token variable">$sudo</span> <span class="token function">cat</span> /var/log/messages
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> wang:
<span class="token comment"># 修改sudo 提示符格式</span>
<span class="token punctuation">[</span>wang@centos8 ~<span class="token punctuation">]</span><span class="token variable">$sudo</span> <span class="token parameter variable">-p</span> <span class="token string">"password on %h for user %p: "</span> <span class="token function">cat</span> /var/log/messages
password on centos8 <span class="token keyword">for</span> user wang:</code></pre>

<p>ubuntu 用户默认拥有 sudo 权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># admin组的成员可以获得root权限</span>
<span class="token comment"># sudo组的成员可以执行任何命令</span>
<span class="token punctuation">[</span>lujinkai@ubuntu1804 sudo<span class="token punctuation">]</span><span class="token variable">$sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-n</span> <span class="token string">'/^[^#]/p'</span> /etc/sudoers
Defaults        env_reset
Defaults        mail_badpass
Defaults        <span class="token assign-left variable">secure_path</span><span class="token operator">=</span><span class="token string">"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"</span>
root    <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL:ALL<span class="token punctuation">)</span> ALL
%admin <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span> ALL
%sudo   <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL:ALL<span class="token punctuation">)</span> ALL
<span class="token punctuation">[</span>lujinkai@ubuntu1804 sudo<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>lujinkai@ubuntu1804 sudo<span class="token punctuation">]</span><span class="token variable">$getent</span> group <span class="token function">sudo</span>
sudo:x:27:lujinkai</code></pre>

<h2 id="PAM"><a href="#PAM" class="headerlink" title="PAM"></a>PAM</h2><p>PAM：Pluggable Authentication Modules，插件式的验证模块，Sun 公司于 1995 年开发的一种与认证相关的通用框架机制。PAM 只关注如何为服务验证用户的 API，通过提供一些动态链接库和一套统一的 API，将系统提供的服务和该服务的认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序一种认证框架，自身不做认证。</p>
<h3 id="PAM-架构"><a href="#PAM-架构" class="headerlink" title="PAM 架构"></a>PAM 架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1599903443135.png"></p>
<p>PAM 提供了对所有服务进行认证的中央机制，适用于本地登录，远程登录，如：telnet、rlogin、fsh、ftp、点对点协议 PPP、su 等应用程序中。系统管理员通过 PAM 配置文件来制定不同应用程序的不同认证策略；应用程序开发者通过在服务程序中使用 PAM API(pam_xxxx( ))来实现对认证方法的调用；而 PAM 服务模块的开发者则利用 PAM SPI 来编写模块（主要调用函数 pam_sm_xxxx( )供 PAM 接口库调用，将不同的认证机制加入到系统中；PAM 接口库（libpam）则读取配置文件，将应用程序和相应的 PAM 服务模块联系起来</p>
<h3 id="PAM-相关文件"><a href="#PAM-相关文件" class="headerlink" title="PAM 相关文件"></a>PAM 相关文件</h3><ul>
<li>&#x2F;lib64&#x2F;security&#x2F;*.so</li>
<li>&#x2F;etc&#x2F;security&#x2F;</li>
<li>&#x2F;etc&#x2F;pam.conf</li>
<li>&#x2F;etc&#x2F;pam.d&#x2F;APP_NAME</li>
</ul>
<h4 id="x2F-lib64-x2F-security-x2F-so"><a href="#x2F-lib64-x2F-security-x2F-so" class="headerlink" title="&#x2F;lib64&#x2F;security&#x2F;*.so"></a>&#x2F;lib64&#x2F;security&#x2F;*.so</h4><p>模块文件，使用 man 可以查看模块的详细信息，例如：<code>man 8 pam_ftp.so</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ls /lib64/security/</span>
pam_access.so     pam_ftp.so        pam_permit.so          pam_tally2.so
pam_cap.so        pam_group.so      pam_postgresok.so      pam_time.so
pam_chroot.so     pam_issue.so      pam_pwhistory.so       pam_timestamp.so
pam_console.so    pam_keyinit.so    pam_pwquality.so       pam_tty_audit.so
pam_cracklib.so   pam_lastlog.so    pam_rhosts.so          pam_umask.so
pam_debug.so      pam_limits.so     pam_rootok.so          pam_unix_acct.so
pam_deny.so       pam_listfile.so   pam_securetty.so       pam_unix_auth.so
pam_echo.so       pam_localuser.so  pam_selinux_permit.so  pam_unix_passwd.so
pam_env.so        pam_loginuid.so   pam_selinux.so         pam_unix_session.so
pam_exec.so       pam_mail.so       pam_sepermit.so        pam_unix.so
pam_faildelay.so  pam_mkhomedir.so  pam_shells.so          pam_userdb.so
pam_faillock.so   pam_motd.so       pam_stress.so          pam_warn.so
pam_filter        pam_namespace.so  pam_succeed_if.so      pam_wheel.so
pam_filter.so     pam_nologin.so    pam_systemd.so         pam_xauth.so</code></pre>

<h4 id="x2F-etc-x2F-security-x2F"><a href="#x2F-etc-x2F-security-x2F" class="headerlink" title="&#x2F;etc&#x2F;security&#x2F;"></a>&#x2F;etc&#x2F;security&#x2F;</h4><p>有些模块比较复杂，需要配备专门的配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ls /etc/security/</span>
access.conf       console.perms    limits.d        opasswd         time.conf
chroot.conf       console.perms.d  namespace.conf  pam_env.conf
console.apps      group.conf       namespace.d     pwquality.conf
console.handlers  limits.conf      namespace.init  sepermit.conf</code></pre>

<h4 id="x2F-etc-x2F-pam-conf"><a href="#x2F-etc-x2F-pam-conf" class="headerlink" title="&#x2F;etc&#x2F;pam.conf"></a>&#x2F;etc&#x2F;pam.conf</h4><p>主配置文件，默认不存在，一般不使用主配置</p>
<h4 id="x2F-etc-x2F-pam-d-x2F-APP-NAME"><a href="#x2F-etc-x2F-pam-d-x2F-APP-NAME" class="headerlink" title="&#x2F;etc&#x2F;pam.d&#x2F;APP_NAME"></a>&#x2F;etc&#x2F;pam.d&#x2F;APP_NAME</h4><p>应用程序单独的 pam 认证配置文件，以应用名命名；<br>&#x2F;etc&#x2F;pam.d 目录存在，&#x2F;etc&#x2F;pam.conf 将失效。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ls /etc/pam.d/</span>
chfn                 <span class="token function">passwd</span>            runuser-l          sudo-i
chsh                 password-auth     smartcard-auth     su-l
config-util          password-auth-ac  smartcard-auth-ac  system-auth
crond                polkit-1          smtp               system-auth-ac
fingerprint-auth     postlogin         smtp.postfix       systemd-user
fingerprint-auth-ac  postlogin-ac      sshd               vlock
login                remote            <span class="token function">su</span>
other                runuser           <span class="token function">sudo</span></code></pre>

<h3 id="PAM-工作原理"><a href="#PAM-工作原理" class="headerlink" title="PAM 工作原理"></a>PAM 工作原理</h3><p>PAM 认证一般遵循这样的顺序：Service(服务)→PAM(配置文件)→pam_*.so</p>
<p>PAM 认证首先要确定那一项服务，然后加载相应的 PAM 的配置文件(位于&#x2F;etc&#x2F;pam.d 下)，最后调用认证文件(位于&#x2F;lib64&#x2F;security 下)进行安全认证</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1599904397703.png"></p>
<p>查看程序是否支持 PAM：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 支持PAM</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ldd `which sshd` |grep libpam</span>
libpam.so.0 <span class="token operator">=</span><span class="token operator">></span> /lib64/libpam.so.0 <span class="token punctuation">(</span>0x00007fea8e70d000<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ldd `which passwd` |grep pam</span>
libpam.so.0 <span class="token operator">=</span><span class="token operator">></span> /lib64/libpam.so.0 <span class="token punctuation">(</span>0x00007f045b805000<span class="token punctuation">)</span>
libpam_misc.so.0 <span class="token operator">=</span><span class="token operator">></span> /lib64/libpam_misc.so.0 <span class="token punctuation">(</span>0x00007f045b601000<span class="token punctuation">)</span>
<span class="token comment"># 不支持PAM</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment">#ldd /usr/sbin/httpd |grep pam</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<p>以 passwd 命令为例，说明 pam 认证过程：</p>
<ol>
<li>使用者执行&#x2F;usr&#x2F;bin&#x2F;passwd 程序，并输入密码</li>
<li>passwd 根据其 PAM 配置文件（一般是&#x2F;etc&#x2F;pam.d&#x2F;passwd），调用相关 PAM 模块</li>
<li>将验证结果回传给 passwd 这个程序，而 passwd 这个程序会根据 PAM 回传的结果决定下一个动作（重新输入密码或者通过验证）</li>
</ol>
<h3 id="PAM-配置文件格式说明"><a href="#PAM-配置文件格式说明" class="headerlink" title="PAM 配置文件格式说明"></a>PAM 配置文件格式说明</h3><p>通用配置文件&#x2F;etc&#x2F;pam.conf 格式,此格式不使用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> <span class="token builtin class-name">type</span> control module-path arguments</code></pre>

<p>专用配置文件&#x2F;etc&#x2F;pam.d&#x2F; 格式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">type</span> control module-path module-arguments</code></pre>

<ul>
<li>service：指服务名，如：telnet、login、ftp 等，服务名字“OTHER”代表所有没有在该文件中明确配置的其它服务</li>
<li>type：module-type，指模块类型，即功能</li>
<li>control ：PAM 库该如何处理与该服务相关的 PAM 模块的成功或失败情况，一个关健词实现</li>
<li>module-path： 指定模块，绝对路径和相对路径都可以，相对路径是相对于&#x2F;lib64&#x2F;security&#x2F;</li>
<li>arguments： 用来传递给该模块的参数</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 pam.d<span class="token punctuation">]</span><span class="token comment">#cat passwd</span>
<span class="token comment">#%PAM-1.0</span>
auth       include      system-auth
account    include      system-auth
password   substack     system-auth
<span class="token parameter variable">-password</span>   optional    pam_gnome_keyring.so use_authtok
password   substack     postlogin

<span class="token punctuation">[</span>root@centos7 pam.d<span class="token punctuation">]</span><span class="token comment">#cat system-auth</span>
<span class="token comment">#%PAM-1.0</span>
<span class="token comment"># This file is auto-generated.</span>
<span class="token comment"># User changes will be destroyed the next time authconfig is run.</span>
auth        required      pam_env.so
auth        required      pam_faildelay.so <span class="token assign-left variable">delay</span><span class="token operator">=</span><span class="token number">2000000</span>
auth        sufficient    pam_unix.so nullok try_first_pass
auth        requisite     pam_succeed_if.so uid <span class="token operator">>=</span> <span class="token number">1000</span> quiet_success
auth        required      pam_deny.so

account     required      pam_unix.so
account     sufficient    pam_localuser.so
account     sufficient    pam_succeed_if.so uid <span class="token operator">&lt;</span> <span class="token number">1000</span> quiet
account     required      pam_permit.so

password    requisite     pam_pwquality.so try_first_pass local_users_only <span class="token assign-left variable">retry</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">authtok_type</span><span class="token operator">=</span>
password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
password    required      pam_deny.so

session     optional      pam_keyinit.so revoke
session     required      pam_limits.so
<span class="token parameter variable">-session</span>     optional      pam_systemd.so
session     <span class="token punctuation">[</span>success<span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">default</span><span class="token operator">=</span>ignore<span class="token punctuation">]</span> pam_succeed_if.so <span class="token function">service</span> <span class="token keyword">in</span> crond quiet use_uid
session     required      pam_unix.so</code></pre>

<h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><ul>
<li>auth：账号的认证和授权</li>
<li>account：帐户的有效性，与账号管理相关的非认证类的功能，如：用来限制&#x2F;允许用户对某个服务的访问时间，限制用户的位置(例如：root 用户只能从控制台登录)</li>
<li>password：用户修改密码时密码复杂度检查机制等功能</li>
<li>session：用户会话期间的控制，如：最多打开的文件数，最多的进程数等</li>
</ul>
<p>-type：表示因为缺失而不能加载的模块将不记录到系统日志,对于那些不总是安装在系统上的模块有用，例如-password、-session</p>
<h4 id="control"><a href="#control" class="headerlink" title="control"></a>control</h4><ul>
<li>required：必要条件。此关不过，仍需检测同一个栈中的其他模块，最后返回 failure，认证失败。拥有参考其他模块意见基础之上的一票否决权。可以通过其它模块来检查为什么验证没有通过。</li>
<li>requisite：必要条件。一票否决，该模块必须返回成功才能通过认证，但是一旦该模块返回失败，将不再执行同一 type 内的任何模块，而是直接将控制权返回给应用程序。</li>
<li>sufficient：充分条件，验证成功则立即返回 OK，不再继续验证，否则忽略 sufficient 的结果并继续其它。换句话说，sufficient 的验证失败对整个验证没有任何影响。</li>
<li>optional：可选条件，无论验证结果如何，均不会影响。通常用于 session 类型。</li>
<li>include：包含另外一个配置文件中类型相同的行。换句话说，包含进来指定的其他配置文件中同名栈中的规则，并以之进行验证。</li>
<li>substack：俗称子栈，这个控制流程俺没有用过，基本上也用不到，我们可以忽略。</li>
</ul>
<h4 id="arguments"><a href="#arguments" class="headerlink" title="arguments"></a>arguments</h4><ul>
<li>debug ：该模块应当用 syslog( )将调试信息写入到系统日志文件中</li>
<li>no_warn ：表明该模块不应把警告信息发送给应用程序</li>
<li>use_first_pass ：该模块不能提示用户输入密码，只能从前一个模块得到输入密码</li>
<li>try_first_pass ：该模块首先用前一个模块从用户得到密码，如果该密码验证不通过，再提示用户输入新密码</li>
<li>use_mapped_pass 该模块不能提示用户输入密码，而是使用映射过的密码</li>
<li>expose_account 允许该模块显示用户的帐号名等信息，一般只能在安全的环境下使用，因为泄漏用户名会对安全造成一定程度的威胁</li>
</ul>
<p>注意：修改 PAM 配置文件将马上生效<br>建议：编辑 pam 规则时，保持至少打开一个 root 会话，以防止 root 身份验证错误</p>
<h3 id="常用的-PAM-模块"><a href="#常用的-PAM-模块" class="headerlink" title="常用的 PAM 模块"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yinzhengjie/p/8395279.html">常用的 PAM 模块</a></h3><h4 id="pam-rootok-so"><a href="#pam-rootok-so" class="headerlink" title="pam_rootok.so"></a>pam_rootok.so</h4><p>功能：用户 UID 是 0，返回成功</p>
<p>案例展示：（限制 root 切换用户也需要密码）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># more /etc/pam.d/su | grep  pam_rootok.so</span>
 <span class="token number">2</span> <span class="token comment">#auth           sufficient      pam_rootok.so</span>
 <span class="token number">3</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span>
 <span class="token number">4</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># su yinzhengjie</span>
 <span class="token number">5</span> Password:
 <span class="token number">6</span> <span class="token punctuation">[</span>yinzhengjie@yinzhengjie root<span class="token punctuation">]</span>$ <span class="token builtin class-name">exit</span>
 <span class="token number">7</span> <span class="token builtin class-name">exit</span>
 <span class="token number">8</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span>
 <span class="token number">9</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># more /etc/pam.d/su | grep  pam_rootok.so</span>
<span class="token number">10</span> auth            sufficient      pam_rootok.so
<span class="token number">11</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># su yinzhengjie</span>
<span class="token number">12</span> <span class="token punctuation">[</span>yinzhengjie@yinzhengjie root<span class="token punctuation">]</span>$
<span class="token number">13</span> <span class="token punctuation">[</span>yinzhengjie@yinzhengjie root<span class="token punctuation">]</span>$ <span class="token builtin class-name">exit</span>
<span class="token number">14</span> <span class="token builtin class-name">exit</span>
<span class="token number">15</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<h4 id="pam-access-so"><a href="#pam-access-so" class="headerlink" title="pam_access.so"></a>pam_access.so</h4><p>功能：访问控制，默认配置文件为“&#x2F;etc&#x2F;security&#x2F;access.conf ”，通常作用于登陆程序，如 su、login、gdm、sshd 等等。</p>
<p>案例展示：（控制访问的源 IP 地址）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># more /etc/pam.d/sshd | grep pam_access.so</span>
<span class="token number">2</span> auth       required     pam_access.so
<span class="token number">3</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token number">4</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># tail -4 /etc/security/access.conf</span>
<span class="token number">5</span> <span class="token comment">#Add by yinzhengjie</span>
<span class="token number">6</span> -:root:ALL EXCEPT <span class="token number">10.0</span>.0.0/24            <span class="token comment">#只让root从10.0.0.0/24的网段访问</span>
<span class="token number">7</span> <span class="token comment">#-:root:10.0.0.0/24                    #拒绝从10.0.0.0/24这个C的地址访问过来。</span>
<span class="token number">8</span> <span class="token comment">#-:root:ALL EXCEPT 10.10.0.161        #拒绝从10.10.0.161这个IP访问过来。</span>
<span class="token number">9</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<h4 id="pam-listfile-so"><a href="#pam-listfile-so" class="headerlink" title="pam_listfile.so"></a>pam_listfile.so</h4><p>功能：基于自定义文件允许或拒绝访问资源限制</p>
<p>案例展示：（sshd 的黑名单或白名单）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># grep listfile /etc/pam.d/sshd</span>
 <span class="token number">2</span> auth       required     pam_listfile.so <span class="token assign-left variable">item</span><span class="token operator">=</span>user <span class="token assign-left variable">sense</span><span class="token operator">=</span>allow <span class="token assign-left variable">file</span><span class="token operator">=</span>/etc/yinzhengjie_ssh_users <span class="token assign-left variable">onerr</span><span class="token operator">=</span>fail             <span class="token comment">#注意，“onerr=fail”表示当文件“/etc/yinzhengjie_ssh_users”不存在时，默认为fail。</span>
 <span class="token number">3</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># > /var/log/secure</span>
 <span class="token number">4</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># tail -10f /var/log/secure</span>
 <span class="token number">5</span> Feb  <span class="token number">4</span> <span class="token number">23</span>:13:36 yinzhengjie sshd<span class="token punctuation">[</span><span class="token number">6509</span><span class="token punctuation">]</span>: reverse mapping checking getaddrinfo <span class="token keyword">for</span> bogon <span class="token punctuation">[</span><span class="token number">10.0</span>.0.161<span class="token punctuation">]</span> failed - POSSIBLE BREAK-IN ATTEMPT<span class="token operator">!</span>
 <span class="token number">6</span> Feb  <span class="token number">4</span> <span class="token number">23</span>:13:36 yinzhengjie sshd<span class="token punctuation">[</span><span class="token number">6509</span><span class="token punctuation">]</span>: pam_listfile<span class="token punctuation">(</span>sshd:auth<span class="token punctuation">)</span>: Couldn<span class="token string">'t open /etc/yinzhengjie_ssh_users
 7 Feb  4 23:13:38 yinzhengjie sshd[6509]: Failed password for root from 10.0.0.161 port 55937 ssh2
 8 Feb  4 23:13:44 yinzhengjie sshd[6510]: Received disconnect from 10.0.0.161: 13: The user canceled authentication.
 9 ^C
10 [root@yinzhengjie ~]# echo root > /etc/yinzhengjie_ssh_users
11 [root@yinzhengjie ~]#
12 [root@yinzhengjie ~]# tail -10f /var/log/secure
13 Feb  4 23:13:36 yinzhengjie sshd[6509]: reverse mapping checking getaddrinfo for bogon [10.0.0.161] failed - POSSIBLE BREAK-IN ATTEMPT!
14 Feb  4 23:13:36 yinzhengjie sshd[6509]: pam_listfile(sshd:auth): Couldn'</span>t <span class="token function">open</span> /etc/yinzhengjie_ssh_users
<span class="token number">15</span> Feb  <span class="token number">4</span> <span class="token number">23</span>:13:38 yinzhengjie sshd<span class="token punctuation">[</span><span class="token number">6509</span><span class="token punctuation">]</span>: Failed password <span class="token keyword">for</span> root from <span class="token number">10.0</span>.0.161 port <span class="token number">55937</span> ssh2
<span class="token number">16</span> Feb  <span class="token number">4</span> <span class="token number">23</span>:13:44 yinzhengjie sshd<span class="token punctuation">[</span><span class="token number">6510</span><span class="token punctuation">]</span>: Received disconnect from <span class="token number">10.0</span>.0.161: <span class="token number">13</span>: The user canceled authentication.
<span class="token number">17</span> Feb  <span class="token number">4</span> <span class="token number">23</span>:14:13 yinzhengjie sshd<span class="token punctuation">[</span><span class="token number">6513</span><span class="token punctuation">]</span>: Accepted password <span class="token keyword">for</span> root from <span class="token number">10.0</span>.0.161 port <span class="token number">55960</span> ssh2
<span class="token number">18</span> Feb  <span class="token number">4</span> <span class="token number">23</span>:14:13 yinzhengjie sshd<span class="token punctuation">[</span><span class="token number">6513</span><span class="token punctuation">]</span>: pam_unix<span class="token punctuation">(</span>sshd:session<span class="token punctuation">)</span>: session opened <span class="token keyword">for</span> user root by <span class="token punctuation">(</span>uid<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">19</span> ^C
<span class="token number">20</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre>

<h4 id="pam-time-so"><a href="#pam-time-so" class="headerlink" title="pam_time.so"></a>pam_time.so</h4><p>功能：基于时间的访问控制，默认文件“&#x2F;etc&#x2F;security&#x2F;time.conf ”</p>
<p>案例展示：（基于时间限制 sshd 的访问）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># tail -2 /etc/security/time.conf</span>
<span class="token number">2</span> <span class="token comment">#Add by yinzhengjie</span>
<span class="token number">3</span> sshd<span class="token punctuation">;</span>*<span class="token punctuation">;</span>*<span class="token punctuation">;</span>SaSu0900-1800        <span class="token comment">#表示sshd服务的所有终端的所有用户只能在8-18点可以正登陆。</span>
<span class="token number">4</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<h4 id="pam-tally2-so"><a href="#pam-tally2-so" class="headerlink" title="pam_tally2.so"></a>pam_tally2.so</h4><p>功能：登陆统计</p>
<p>案例展示：（实现防止对 sshd 暴力破解）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># grep pam_tally2.so /etc/pam.d/sshd</span>
<span class="token number">2</span> auth       required     pam_tally2.so <span class="token assign-left variable">deny</span><span class="token operator">=</span><span class="token number">2</span> even_deny_root <span class="token assign-left variable">root_unlock_time</span><span class="token operator">=</span><span class="token number">60</span> <span class="token assign-left variable">unlock_time</span><span class="token operator">=</span><span class="token number">60</span>   <span class="token comment">#表示当用户输入次数超过2次时，锁定用户60秒，因此这里的“even_deny_root ”表示包括root用户，“root_unlock_time”表示root用户锁定的时间，“unlock_time”表示其他用户锁定的时间。</span>
<span class="token number">3</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token number">4</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment"># pam_tally2 --reset -u root            #这里表示手动解锁。</span>
<span class="token number">5</span> Login           Failures Latest failure     From
<span class="token number">6</span> root                <span class="token number">0</span>
<span class="token number">7</span> <span class="token punctuation">[</span>root@yinzhengjie ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<h4 id="pam-limits-so"><a href="#pam-limits-so" class="headerlink" title="pam_limits.so"></a>pam_limits.so</h4><p>功能：限制用户会话过程中对各种资源的使用情况。缺省情况下该模块的配置文件是<code>/etc/security/limits.conf</code>和<code>/etc/security/limits.d/*.conf</code>。在用户级别实现对其可使用的资源的限制，例如：可打开的文件数量，可运行的进程数量，可用内存空间</p>
<h4 id="pam-shells-so"><a href="#pam-shells-so" class="headerlink" title="pam_shells.so"></a>pam_shells.so</h4><p>功能：检查有效 shell，登录用户的 shell 不在&#x2F;etc&#x2F;shells 中则为非法 shell</p>
<p>案例：不允许使用&#x2F;bin&#x2F;csh 的用户本地登录</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#yum -y install csh</span>

<span class="token comment"># 新建用户并设置密码</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#useradd -s /bin/csh testuser</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token number">123456</span> <span class="token operator">|</span> <span class="token function">passwd</span> <span class="token parameter variable">--stdin</span> testuser

<span class="token comment"># auth required pam_shells.so 表示校验登录用户的shell</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#echo "auth required pam_shells.so" >> /etc/pam.d/login</span>

<span class="token comment"># 将shells中的csh注释</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-Ei</span> <span class="token string">'s/^\/bin\/csh/#&amp;/'</span> /etc/shells

<span class="token comment"># testuser因为shell为csh，不在/etc/shells中，pam_shells.so模块校验不通过，所以无法登录</span>
</code></pre>

<h4 id="pam-securetty-so"><a href="#pam-securetty-so" class="headerlink" title="pam_securetty.so"></a>pam_securetty.so</h4><p>功能：只允许 root 用户在&#x2F;etc&#x2F;securetty 列出的安全终端上登陆</p>
<h4 id="pam-nologin-so"><a href="#pam-nologin-so" class="headerlink" title="pam_nologin.so"></a>pam_nologin.so</h4><p>功能：如果&#x2F;etc&#x2F;nologin 文件存在,将导致非 root 用户不能登陆,当该用户登陆时，会显示&#x2F;etc&#x2F;nologin 文<br>件内容，并拒绝登陆</p>
<h4 id="pam-succeed-if-so"><a href="#pam-succeed-if-so" class="headerlink" title="pam_succeed_if.so"></a>pam_succeed_if.so</h4><p>功能：根据参数中的所有条件都满足才返回成功</p>
<p>案例：ubuntu 默认不允许 root 登录桌面图形</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">用root登录桌面失败，查看日志，可看到Pam原因
Vim /etc/pam.d/gdm-passwd
<span class="token comment">#将下面行注释</span>
<span class="token comment">#auth requried pam_succeed_if.so user !=root quiet_success</span></code></pre>

<h4 id="pam-google-authenticator"><a href="#pam-google-authenticator" class="headerlink" title="pam_google_authenticator"></a>pam_google_authenticator</h4><p>实现 SSH 登录的两次身份验证，先验证 APP 的数字码，再验证 root 用户的密码，都通过才可以登录。目前只支持口令验证，不支持基于 key 验证</p>
<p>需要安装，官方网站：<a target="_blank" rel="noopener" href="https://github.com/google/google-authenticator-android">https://github.com/google/google-authenticator-android</a></p>
<h2 id="时间同步服务"><a href="#时间同步服务" class="headerlink" title="时间同步服务"></a>时间同步服务</h2><p>多主机协作工作时，各个主机的时间同步很重要，时间不一致会造成很多重要应用的故障，如：加密协议，日志，集群等， 利用 NTP（Network Time Protocol） 协议使网络中的各个计算机时间达到同步。目前 NTP 协议属于运维基础架构中必备的基本服务之一。</p>
<p>ntp 和 chrony 都可以搭建时间同步服务，chrony 更优秀。</p>
<h3 id="chrony"><a href="#chrony" class="headerlink" title="chrony"></a>chrony</h3><h4 id="chrony-组成文件"><a href="#chrony-组成文件" class="headerlink" title="chrony 组成文件"></a>chrony 组成文件</h4><p>两个主要程序：chronyc、chronyd</p>
<ul>
<li>&#x2F;usr&#x2F;bin&#x2F;chronyc：命令行用户工具，用于监控性能并进行多样化的配置。</li>
<li>&#x2F;usr&#x2F;sbin&#x2F;chronyd：后台运行的守护进程，调整内核中运行的系统时钟和时钟服务器同步。它确定计算机增减时间的比率，并对此进行补偿。</li>
</ul>
<p>服务 unit 文件： &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;chronyd.service<br>监听端口： 323&#x2F;udp，123&#x2F;udp<br>配置文件： &#x2F;etc&#x2F;chrony.conf</p>
<h4 id="配置文件-chrony-conf"><a href="#配置文件-chrony-conf" class="headerlink" title="配置文件 chrony.conf"></a><a target="_blank" rel="noopener" href="https://chrony.tuxfamily.org/doc/3.5/chrony.conf.html">配置文件 chrony.conf</a></h4><ul>
<li><p>server hostname [option]…</p>
<p>指定单个 NTP 服务器。iburst：可加快初始同步速度</p>
</li>
<li><p>pool name [option]…</p>
<p>指定 NTP 服务器池</p>
</li>
<li><p>rtcsync</p>
<p>启用内核模式，系统时间每 11 分钟会拷贝到实时时钟（RTC）</p>
</li>
<li><p>allow [all] [subnet]</p>
<p>指定一台主机、子网，或者网络以允许或拒绝访问本服务器</p>
</li>
<li><p>…</p>
</li>
</ul>
<h4 id="chronyc"><a href="#chronyc" class="headerlink" title="chronyc"></a>chronyc</h4><p>ntp 客户端工具，chronyc 可以运行在交互式和非交互式两种方式，支持以下命令：</p>
<ul>
<li>help 命令可以查看更多 chronyc 的交互命令</li>
<li>accheck 检查是否对特定主机可访问当前服务器</li>
<li>activity 显示有多少 NTP 源在线&#x2F;离线</li>
<li>sources [-v] 显示当前时间源的同步信息</li>
<li>sourcestats [-v]显示当前时间源的同步统计信息</li>
<li>add server 手动添加一台新的 NTP 服务器</li>
<li>clients 报告已访问本服务器的客户端列表</li>
<li>delete 手动移除 NTP 服务器或对等服务器</li>
<li>settime 手动设置守护进程时间</li>
<li>tracking 显示系统时间信息</li>
</ul>
<h4 id="公共-ntp-服务"><a href="#公共-ntp-服务" class="headerlink" title="公共 ntp 服务"></a>公共 ntp 服务</h4><ul>
<li>阿里云公共 NTP 服务器：ntp.aliyun.com，ntp1-7.aliyun.com</li>
<li>腾讯公共 NTP 服务器：time1-5.cloud.tencent.com</li>
<li>大学 ntp 服务：<ul>
<li>s1a.time.edu.cn 北京邮电大学</li>
<li>s1b.time.edu.cn 清华大学</li>
<li>s1c.time.edu.cn 北京大学</li>
</ul>
</li>
<li>国家授时中心服务器：210.72.145.44</li>
</ul>
<p>范例：centos7 和 8 作为 ntp 服务器，其他服务器就不从公共 ntp 服务器同步时间，而是从 centos7 和 8 同步时间</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># centos7、8</span>
<span class="token comment"># 修改/etc/chrony.conf的server为公共ntp服务器，allow为允许同步的其他服务器</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-n</span> <span class="token string">'/^[^#]/p'</span> /etc/chrony.conf
server ntp.aliyun.com iburst
server time1.cloud.tencent.com iburst
driftfile /var/lib/chrony/drift
makestep <span class="token number">1.0</span> <span class="token number">3</span>
rtcsync
allow <span class="token number">10.0</span>.0.0/24
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony

<span class="token comment"># 其他服务器，修改/etc/chrony.conf的server为centos7、8</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment">#grep '^[^#]' /etc/chrony.conf</span>
server <span class="token number">10.0</span>.0.7 iburst
server <span class="token number">10.0</span>.0.8 iburst
driftfile /var/lib/chrony/drift
makestep <span class="token number">1.0</span> <span class="token number">3</span>
rtcsync
logdir /var/log/chrony</code></pre>

<h2 id="TCP-Warpper"><a href="#TCP-Warpper" class="headerlink" title="TCP Warpper"></a>TCP Warpper</h2><h2 id="SELinux"><a href="#SELinux" class="headerlink" title="SELinux"></a>SELinux</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">计划任务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 22:55:45" itemprop="dateCreated datePublished" datetime="2020-12-09T22:55:45+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">进程和计划任务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E7%9A%84pid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E7%9A%84pid/" class="post-title-link" itemprop="url">进程和线程的pid</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 22:55:44" itemprop="dateCreated datePublished" datetime="2020-12-09T22:55:44+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">进程和计划任务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>程序创建进程，一个进程至少创建一个线程，程序的运行最终是靠线程来完成的。</p>
<p>有人说在 Linux 中，进程和线程是一样的，这种说法是不对的，线程和进程都有自己的 id</p>
<p>初步理解各种 id</p>
<ul>
<li><p>pid: 进程 id</p>
</li>
<li><p>lwp: 线程 id，light weight process (thread) ID，也叫 <strong>spid</strong> 或 tid</p>
<p>使用 ps 等工具查询的时候，线程的的 PID 是线程所在进程 id，SPID 才是线程 id</p>
</li>
<li><p>tgid: 线程组 id, 也就是线程组 leader 的进程 id, 等于 pid</p>
</li>
<li><p>——- 分割线（以下内容不重要）———</p>
</li>
<li><p>pgid: 进程组 id, 也就是进程 leader 的进程 id</p>
</li>
<li><p>pthread id: pthread 库提供的 id, 生效范围不在系统级别, 可以忽略</p>
</li>
<li><p>sid: ession ID for the session leader</p>
</li>
<li><p>tpgid: tty process group ID for the process group leader</p>
</li>
</ul>
<p>从上面可以看出: 各种 id 最后都归结到 pid 和 lwp 上。所以理解各种 id，最终归结为理解 pid 和 lwd 的联系和区别</p>
<p>描述父子进程，线程之间关系图：</p>
<pre class="language-python" data-language="python"><code class="language-python">               USER VIEW
 <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> PID <span class="token number">43</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> PID <span class="token number">42</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>
                     <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
                     <span class="token operator">|</span> process <span class="token operator">|</span>
                    _<span class="token operator">|</span> pid<span class="token operator">=</span><span class="token number">42</span>  <span class="token operator">|</span>_
                  _<span class="token operator">/</span> <span class="token operator">|</span> tgid<span class="token operator">=</span><span class="token number">42</span> <span class="token operator">|</span> \_ <span class="token punctuation">(</span>new thread<span class="token punctuation">)</span> _
       _ <span class="token punctuation">(</span>fork<span class="token punctuation">)</span> _<span class="token operator">/</span>   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>                  \
      <span class="token operator">/</span>                                        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>                                    <span class="token operator">|</span> process <span class="token operator">|</span>
<span class="token operator">|</span> process <span class="token operator">|</span>                                    <span class="token operator">|</span> pid<span class="token operator">=</span><span class="token number">44</span>  <span class="token operator">|</span>
<span class="token operator">|</span> pid<span class="token operator">=</span><span class="token number">43</span>  <span class="token operator">|</span>                                    <span class="token operator">|</span> tgid<span class="token operator">=</span><span class="token number">42</span> <span class="token operator">|</span>
<span class="token operator">|</span> tgid<span class="token operator">=</span><span class="token number">43</span> <span class="token operator">|</span>                                    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span>
 <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> PID <span class="token number">43</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> PID <span class="token number">42</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> PID <span class="token number">44</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>
                     KERNEL VIEW</code></pre>

<p>上图很好地描述了用户视角(user view)和内核视角(kernel view)看到线程的差别：</p>
<ul>
<li>从用户视角出发，在 pid 42 中产生的 tid 44 线程，属于 tgid(线程组 leader 的进程 ID) 42。甚至用 ps 和 top 的默认参数，你都无法看到 tid 44 线程</li>
<li>从内核视角出发，tid 42 和 tid 44 是独立的调度单元，可以把他们视为”pid 42”和”pid 44”</li>
</ul>
<p>需要指出的是，有时候在 Linux 中进程和线程的区分也是不是十分严格的。即使线程和进程混用，pid 和 tid 混用，根据上下文，还是可以清楚地区分对方想要表达的意思。上图中，从内核视角出发看到了 pid 44，是从调度单元的角度出发，但是在 top 或 ps 命令中，你是绝对找不到一个 pid 为 44 的进程的，只能看到一个 lwp(tid)为 44 的线程 </p>
<p>Linux 通过进程查看线程的方法</p>
<ol>
<li><code>htop</code>按 t(显示进程线程嵌套关系)和 H(显示线程) ，然后 F4 过滤进程名</li>
<li><code>ps -eLf | grep java</code>(快照，带线程命令，e 是显示全部进程，L 是显示线程，f 全格式输出)</li>
<li><code>pstree -p &lt;pid&gt;</code>(显示进程树，不加 pid 显示所有)</li>
<li><code>top -Hp &lt;pid&gt;</code> (实时)</li>
<li><code>ps -T -p &lt;pid&gt;</code>(快照) <strong>推荐程度按数字从小到大</strong></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">进程相关命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 22:55:44" itemprop="dateCreated datePublished" datetime="2020-12-09T22:55:44+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">进程和计划任务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>pstree, ps, pidof, pgrep, top, htop, glance, pmap, vmstat, dstat,kill, pkill, job, bg, fg, nohup</p>
<h2 id="pstree"><a href="#pstree" class="headerlink" title="pstree"></a>pstree</h2><p>进程树，来自 psmisc 软件包（fuser 和 killall 也来自 psmisc ） <a href="../../../../../../data/wwwroot/go-elasticsearch/.doc/connecting.asciidoc">connecting.asciidoc</a> </p>
<pre class="language-bash" data-language="bash"><code class="language-bash">pstree <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> <span class="token punctuation">[</span> PID <span class="token operator">|</span> <span class="token environment constant">USER</span> <span class="token punctuation">]</span>

OPTION：
<span class="token parameter variable">-p</span>       <span class="token comment"># 显示PID</span>
<span class="token parameter variable">-T</span>       <span class="token comment"># 不显示线程，只显示进程</span>
<span class="token parameter variable">-u</span>       <span class="token comment"># 显示进程所属用户</span>
<span class="token parameter variable">-H</span> pid   <span class="token comment"># 高亮显示指定进程及其前辈进程</span></code></pre>

<h2 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h2><p>process state，默认显示当前终端中的进程，Linux 系统各进程的相关信息均保存在<code>/proc/PID</code>目录下的各个文件中。ps 显示的是进程快照，如果要动态显示实时的进程信息，可以使用 top 命令</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span></code></pre>

<p>ps 的参数有非常多，三种风格都支持</p>
<p>大致分以下五类，这五类是我划分的，和 man 文档不太一样，下面是常见的 option：</p>
<ol>
<li><p>简单选择范围</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">a     <span class="token comment"># 显示所有终端的进程</span>
x     <span class="token comment"># 显示不链接终端的进程</span>
<span class="token parameter variable">-e</span>    <span class="token comment"># 显示所有进程，和ax显示的进程一样多，但是不如ax显示的属性多</span></code></pre>
</li>
<li><p>按条件查询<br>查询条件之间用逗号分割</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-p</span> <span class="token operator">|</span> p pidlist  <span class="token comment"># 指定pid列表</span>
<span class="token parameter variable">--ppid</span> pidlist  <span class="token comment"># 显示属于pid的子进程</span>
<span class="token parameter variable">-C</span> cmdlist      <span class="token comment"># 指定命令列表</span>
<span class="token parameter variable">-u</span> userlist     <span class="token comment"># 指定 effective user 列表，可以写用户名或用户id</span>
<span class="token parameter variable">-U</span> userlist     <span class="token comment"># 指定 real user 列表</span>
<span class="token parameter variable">-g</span> grplist      <span class="token comment">#  指定effective group 列表，可以写组名或组id</span>
<span class="token parameter variable">-G</span> grplist      <span class="token comment">#  指定real group 列表</span>
<span class="token parameter variable">-t</span> ttylist      <span class="token comment"># 指定tty</span></code></pre>
</li>
<li><p>控制输出属性</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">o 属性列表  <span class="token comment"># 指定属性，属性之间用逗号分割</span>
u          <span class="token comment"># 显示user，以及%cpu、%mem等信息，适合面向用户</span>
<span class="token parameter variable">-f</span>         <span class="token comment"># 显示UID、PPID、C与STIME</span>
<span class="token parameter variable">-F</span>         <span class="token comment"># 比-f多显示SZ、RSS、PSR</span></code></pre>
</li>
<li><p>格式化输出</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">f                                   <span class="token comment"># 显示进程树，相当于 --forest</span>
k<span class="token operator">|</span>--sort <span class="token punctuation">[</span>+<span class="token operator">|</span>-<span class="token punctuation">]</span>key<span class="token punctuation">[</span>,<span class="token punctuation">[</span>+<span class="token operator">|</span>-<span class="token punctuation">]</span>key<span class="token punctuation">[</span>,<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 按照属性排序，如果多个属性，用逗号分割，属性前加-表示倒序</span>
<span class="token parameter variable">-H</span>                                  <span class="token comment"># 显示进程层级格式，和 f 差不多</span>

<span class="token function">ps</span> aux k %cpu   等于   <span class="token function">ps</span> aux <span class="token parameter variable">--sort</span> %cpu    等于   <span class="token function">ps</span> aux <span class="token parameter variable">--sort</span><span class="token operator">=</span>%cpu
<span class="token function">ps</span> aux k -%cpu  等于   <span class="token function">ps</span> aux <span class="token parameter variable">--sort</span> -%cpu   等于   <span class="token function">ps</span> aux <span class="token parameter variable">--sort</span><span class="token operator">=</span>-%cpu</code></pre>
</li>
<li><p>显示线程</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-L</span>    <span class="token comment"># 显示线程</span></code></pre>
</li>
<li><p>其他</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-L</span>   <span class="token comment"># 显示所有属性，小写的那列是属性code，大写的是属性header，`ps | head -1`输出的就是header</span></code></pre></li>
</ol>
<p>很多 option 是冲突的，有的冲突会报错，有的结果无意义我也算它冲突，大概有以下两种情况：</p>
<ol>
<li><p>按条件查询 和 简单选择范围：我们的预期是从指定的范围内按条件查询，然后输出查询的结果，有的命令确实是这个逻辑，但是 ps 会把所有的进程和查询到的进程都输出，这样的结果是没有意义的</p>
</li>
<li><p>控制输出的属性：当多个这种类型的 option 组合在一起，如果指定的属性列表是包含关系，则正常，否则报错，例如-f 和-F 会按照-F 输出结果，但是-f 和 u 就会报错。<br>简单选择范围 的 option 默认展示若干属性，它们和控制输出的属性不冲突</p>
</li>
</ol>
<h3 id="常用组合"><a href="#常用组合" class="headerlink" title="常用组合"></a>常用组合</h3><h3 id="常见属性"><a href="#常见属性" class="headerlink" title="常见属性"></a>常见属性</h3><p><code>ps L</code>可以查看所有进程属性，有 170 个，我叫它属性，实际 man 文档称之为 SPECIFIERS（说明符），o 选项可以指定 ps 输出哪些进程属性，下面是常用的进程属性：</p>
<ul>
<li>user|euser：effective user，有效的用户</li>
<li>ruser：real user 真正的用户，例如普通用户 lujinkai 使用 sudo 执行命令，那 effective user 就是 lujinkai，real user 就是 root</li>
<li>fuser：</li>
<li>suser：</li>
<li>%cpu：cpu 占用率，精确到小数点后一位</li>
<li>c：cpu 占有率，精确到个位数</li>
<li>%mem：内存占有率</li>
<li>pid：进程 id，如果是线程，则是线程所在进程的 id</li>
<li>ppid：父进程 id</li>
<li>lwp|spid|tid：线程 id</li>
<li>s|state：minimal state display (one character)</li>
<li>stat：multi-character process state</li>
<li>ni|nice：nice 优先级</li>
<li>pri：priority 优先级</li>
<li>rtprio：rtprio 优先级</li>
<li>sz：物理内存大小，包括文本、数据和堆栈空间</li>
<li>psr：processor，CPU 编号，表示进程占用哪个 CPU 核心</li>
<li>vsz：虚拟内存大小，单位 k</li>
<li>rss：常驻内存大小，包括了共享库内存的大小（不同进程引用同一个库文件，那这些进程的 rss 中都包含了这个共享库的大小），单位 k</li>
<li><strong>comm：进程名，例如：<code>mysqld</code></strong></li>
<li>command：完整命令，例如：<code>/usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/data/mysql --plugin-dir</code></li>
<li>time|cputiime：进程占用 CPU 的累计时间</li>
<li><strong>lstart：开始时间</strong></li>
<li>etime：运行时间</li>
<li>stime：启动进程的时间</li>
</ul>
<h3 id="进程状态码"><a href="#进程状态码" class="headerlink" title="进程状态码"></a>进程状态码</h3><pre class="language-bash" data-language="bash"><code class="language-bash">D    <span class="token comment"># 睡眠状态，不可中断 (通常是IO)</span>
R    <span class="token comment"># 可执行状态，进程处于运行或就绪状态 (on run queue)</span>
S    <span class="token comment"># 睡眠状态（sleeping） 可中断 (waiting for an event to complete)</span>
T    <span class="token comment"># stopped by job control signal</span>
t    <span class="token comment"># stopped by debugger during the tracing</span>
W    <span class="token comment"># paging (not valid since the 2.6.xx kernel)</span>
X    <span class="token comment"># 退出状态，进程即将被销毁 (should never be seen)</span>
Z    <span class="token comment"># 退出状态（zombie），终止但是未被父进程收回，进程成为僵尸进程</span>
I    <span class="token comment"># Idle kernel thread,CentOS 8 新特性</span></code></pre>

<p>对于 BSD 风格，stat 还会显示下面的状态码：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>    <span class="token comment"># 高优先级(对其他用户不好)</span>
N    <span class="token comment"># 低优先级(对其他用户很好)</span>
L    <span class="token comment"># 内存分页并带锁(用于实时和自定义IO)</span>
s    <span class="token comment"># is a session leader</span>
l    <span class="token comment"># 多线程 (using CLONE_THREAD, like NPTL pthreads do)</span>
+    <span class="token comment"># 在前台进程组中，前台进程</span></code></pre>

<h2 id="prtstat"><a href="#prtstat" class="headerlink" title="prtstat"></a>prtstat</h2><p>查看进程详细信息，ps 适合查找进程，确定 pid，然后使用 prtstat 查看详细信息。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">prtstat <span class="token punctuation">[</span>options<span class="token punctuation">]</span> PID <span class="token punctuation">..</span>.

<span class="token parameter variable">-r</span>    <span class="token comment"># raw格式显示</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># prtstat 24954</span>
Process: php-fpm       		State: S <span class="token punctuation">(</span>sleeping<span class="token punctuation">)</span>
  CPU<span class="token comment">#:  0  		TTY: 0:0	Threads: 1</span>
Process, Group and Session IDs
  Process ID: <span class="token number">24954</span>		  Parent ID: <span class="token number">24953</span>
    Group ID: <span class="token number">24953</span>		 Session ID: <span class="token number">24953</span>
  T Group ID: <span class="token parameter variable">-1</span>

Page Faults
  This Process    <span class="token punctuation">(</span>minor major<span class="token punctuation">)</span>:     <span class="token number">8195</span>         <span class="token number">0</span>
  Child Processes <span class="token punctuation">(</span>minor major<span class="token punctuation">)</span>:        <span class="token number">0</span>         <span class="token number">0</span>
CPU Times
  This Process    <span class="token punctuation">(</span>user system guest blkio<span class="token punctuation">)</span>:   <span class="token number">0.15</span>   <span class="token number">0.02</span>   <span class="token number">0.00</span>   <span class="token number">0.00</span>
  Child processes <span class="token punctuation">(</span>user system guest<span class="token punctuation">)</span>:         <span class="token number">0.00</span>   <span class="token number">0.00</span>   <span class="token number">0.00</span>
Memory
  Vsize:       <span class="token number">185</span> MB
  RSS:         <span class="token number">17</span> MB      		 RSS Limit: <span class="token number">18446744073709</span> MB
  Code Start:  0x400000  		 Code Stop:  0xeab9c1
  Stack Start: 0x7fff3beae6e0
  Stack Pointer <span class="token punctuation">(</span>ESP<span class="token punctuation">)</span>: 0x7fff3beae198	 Inst Pointer <span class="token punctuation">(</span>EIP<span class="token punctuation">)</span>: 0x7f67ad7f8840
Scheduling
  Policy: normal
  Nice:   <span class="token number">0</span> 		 RT Priority: <span class="token number">0</span> <span class="token punctuation">(</span>non RT<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># prtstat -r 24954</span>
         pid: <span class="token number">24954</span>          	                  comm: php-fpm
       state: S              	                  ppid: <span class="token number">24953</span>
        pgrp: <span class="token number">24953</span>          	               session: <span class="token number">24953</span>
      tty_nr: <span class="token number">0</span>              	                 tpgid: <span class="token parameter variable">-1</span>
       flags: <span class="token number">402140</span>         	                minflt: <span class="token number">8195</span>
     cminflt: <span class="token number">0</span>              	                majflt: <span class="token number">0</span>
     cmajflt: <span class="token number">0</span>              	                 utime: <span class="token number">15</span>
       stime: <span class="token number">2</span>              	                cutime: <span class="token number">0</span>
      cstime: <span class="token number">0</span>              	              priority: <span class="token number">20</span>
        nice: <span class="token number">0</span>              	           num_threads: <span class="token number">1</span>
 itrealvalue: <span class="token number">0</span>              	             starttime: <span class="token number">2798685522</span>
       vsize: <span class="token number">185421824</span>      	                   rss: <span class="token number">4316</span>
      rsslim: <span class="token number">18446744073709551615</span>	             startcode: <span class="token number">4194304</span>
     endcode: <span class="token number">15382977</span>       	            startstack: <span class="token number">140734198638304</span>
     kstkesp: 7FFF3BEAE198   	               kstkeip: 7F67AD7F8840
       wchan: <span class="token number">18446744071584583552</span>	                 nswap: <span class="token number">0</span>
      cnswap: <span class="token number">18446744071584583552</span>	           exit_signal: <span class="token number">17</span>
   processor: <span class="token number">0</span>              	           rt_priority: <span class="token number">0</span>
      policy: <span class="token number">0</span>              	 delayaccr_blkio_ticks: <span class="token number">0</span>
  guest_time: <span class="token number">0</span>              	           cguest_time: <span class="token number">0</span>
</code></pre>

<h2 id="设置和调整进程优先级"><a href="#设置和调整进程优先级" class="headerlink" title="设置和调整进程优先级"></a>设置和调整进程优先级</h2><p>静态优先级：在创建进程时确定的，且在进程的整个运行期间保持不变，静态优先级的范围是 100 到 139</p>
<h3 id="nice"><a href="#nice" class="headerlink" title="nice"></a>nice</h3><p>进程默认启动时的 nice 值是 0，对应 的优先级是 120，只有根用户才能降低 nice 值</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">nice</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND <span class="token punctuation">[</span>ARG<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token parameter variable">-n</span>    <span class="token comment"># 指定优先级， -20到19</span></code></pre>

<p>以指定的优先级来启动进程：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#nice -n -10 ping 127.0.0.1</span></code></pre>

<h3 id="renice"><a href="#renice" class="headerlink" title="renice"></a>renice</h3><p>调整正在执行中的进程的优先级</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#renice -n -20 2118</span></code></pre>

<h2 id="搜索进程"><a href="#搜索进程" class="headerlink" title="搜索进程"></a>搜索进程</h2><p>按条件搜索进程：</p>
<ul>
<li><code>ps options | grep &#39;pattern&#39; </code> 最灵活</li>
<li>pgrep 按预定义的模式</li>
<li>pidof 按确切的程序名称查看 pid</li>
</ul>
<h3 id="pgrep"><a href="#pgrep" class="headerlink" title="pgrep"></a>pgrep</h3><p>顾名思义，过滤进程</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"> pgrep <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>pattern<span class="token operator">></span>

<span class="token parameter variable">-u</span> uidlist  <span class="token comment"># effective user</span>
<span class="token parameter variable">-U</span> uidlist  <span class="token comment"># real user</span>
<span class="token parameter variable">-t</span> terminal <span class="token comment"># 与指定终端相关的进程</span>
<span class="token parameter variable">-l</span>          <span class="token comment"># 显示进程名</span>
<span class="token parameter variable">-a</span>          <span class="token comment"># 显示完整格式的进程名</span>
<span class="token parameter variable">-P</span> pid      <span class="token comment"># 显示指定进程的子进程</span></code></pre>

<h3 id="pidof"><a href="#pidof" class="headerlink" title="pidof"></a>pidof</h3><pre class="language-bash" data-language="bash"><code class="language-bash">pidof <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>program <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token parameter variable">-x</span>    <span class="token comment"># 按脚本名称查找pid</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#pidof -x ping.sh</span>
<span class="token number">19035</span></code></pre>

<h2 id="uptime-和-w"><a href="#uptime-和-w" class="headerlink" title="uptime 和 w"></a>uptime 和 w</h2><p>uptime 显示：当前时间、系统启动时间、当前在线人数、系统负载（1、5、15 分钟的平均负载,一般不会超过 1,超过 5 时建议警报）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># uptime</span>
 <span class="token number">22</span>:04:28 up <span class="token number">325</span> days,  <span class="token number">4</span>:05,  <span class="token number">2</span> users,  load average: <span class="token number">0.01</span>, <span class="token number">0.04</span>, <span class="token number">0.05</span></code></pre>

<p>w 除了显示 uptime 显示的内容外，还可以在线人员的信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># w</span>
 <span class="token number">22</span>:07:46 up <span class="token number">325</span> days,  <span class="token number">4</span>:08,  <span class="token number">2</span> users,  load average: <span class="token number">0.05</span>, <span class="token number">0.03</span>, <span class="token number">0.05</span>
<span class="token environment constant">USER</span>     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     pts/1    <span class="token number">39.164</span>.140.134   <span class="token number">20</span>:17    <span class="token number">3</span>:14   <span class="token number">0</span>.49s  <span class="token number">0</span>.49s <span class="token parameter variable">-bash</span>
root     pts/4    <span class="token number">39.164</span>.140.134   <span class="token number">21</span>:17    <span class="token number">2</span>.00s  <span class="token number">0</span>.04s  <span class="token number">0</span>.00s w</code></pre>

<h2 id="mpstat"><a href="#mpstat" class="headerlink" title="mpstat"></a>mpstat</h2><p>来自于 sysstat 包，显示 CPU 相关统计</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mpstat <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span> interval <span class="token punctuation">[</span> count <span class="token punctuation">]</span>

<span class="token parameter variable">-p</span>    <span class="token comment"># 指定查看的cpu核心</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~$ mpstat
Linux <span class="token number">5.4</span>.0-46-generic <span class="token punctuation">(</span>Z510<span class="token punctuation">)</span> 	09/03/20 	_x86_64_	<span class="token punctuation">(</span><span class="token number">4</span> CPU<span class="token punctuation">)</span>

<span class="token number">22</span>:15:39     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
<span class="token number">22</span>:15:39     all   <span class="token number">10.43</span>    <span class="token number">0.51</span>    <span class="token number">3.06</span>    <span class="token number">0.07</span>    <span class="token number">0.00</span>    <span class="token number">0.86</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">85.08</span>
lujinkai@Z510:~$ mpstat <span class="token number">1</span> <span class="token number">3</span>
Linux <span class="token number">5.4</span>.0-46-generic <span class="token punctuation">(</span>Z510<span class="token punctuation">)</span> 	09/03/20 	_x86_64_	<span class="token punctuation">(</span><span class="token number">4</span> CPU<span class="token punctuation">)</span>

<span class="token number">22</span>:15:45     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
<span class="token number">22</span>:15:46     all   <span class="token number">10.97</span>    <span class="token number">0.00</span>    <span class="token number">3.83</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.51</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">84.69</span>
<span class="token number">22</span>:15:47     all    <span class="token number">6.72</span>    <span class="token number">0.00</span>    <span class="token number">3.98</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">1.99</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">87.31</span>
<span class="token number">22</span>:15:48     all    <span class="token number">6.08</span>    <span class="token number">0.00</span>    <span class="token number">3.54</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">1.27</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">89.11</span>
Average:     all    <span class="token number">7.91</span>    <span class="token number">0.00</span>    <span class="token number">3.78</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">1.26</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">87.05</span>
lujinkai@Z510:~$ mpstat <span class="token parameter variable">-P</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span>
Linux <span class="token number">5.4</span>.0-46-generic <span class="token punctuation">(</span>Z510<span class="token punctuation">)</span> 	09/03/20 	_x86_64_	<span class="token punctuation">(</span><span class="token number">4</span> CPU<span class="token punctuation">)</span>

<span class="token number">22</span>:15:52     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
<span class="token number">22</span>:15:53       <span class="token number">0</span>    <span class="token number">7.22</span>    <span class="token number">0.00</span>    <span class="token number">5.15</span>    <span class="token number">1.03</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">86.60</span>

<span class="token number">22</span>:15:53     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
<span class="token number">22</span>:15:54       <span class="token number">0</span>    <span class="token number">7.14</span>    <span class="token number">0.00</span>    <span class="token number">7.14</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">1.02</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">84.69</span>

Average:     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
Average:       <span class="token number">0</span>    <span class="token number">7.18</span>    <span class="token number">0.00</span>    <span class="token number">6.15</span>    <span class="token number">0.51</span>    <span class="token number">0.00</span>    <span class="token number">0.51</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.00</span>   <span class="token number">85.64</span></code></pre>

<h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><p>查看进程实时状态</p>
<h2 id="htop"><a href="#htop" class="headerlink" title="htop"></a>htop</h2><p>top 的升级版</p>
<p>cpu4 核 4 线程和 4 核 8 线程的区别：</p>
<pre class="language-none"><code class="language-none">4核 就是有4个物理核心，4线程 就是一个核心对应一个线程，8线程就是两个线程对应一个核心，是intel使用超线程技术，把一个物理核心模拟成两个逻辑核心。所以任务管理器或者htop会显示会显示出8张CPU表</code></pre>

<p>关于 PR、NI、PRI：</p>
<pre class="language-none"><code class="language-none">PR：priority 优先级，系统调节
NI：nice	反应一个进程“优先级”状态的值，其取值范围是-20至19，一共40个级别。这个值越小，表示进程“优先级”越高。就像人一样，越nice的人，抢占资源的能力就越差，而越不nice的人抢占能力就越强。这个值用户可以调节
PRI：PR + NI，PRI才是进程最终的优先级，用户可以通过调节NI来影响它</code></pre>

<p><img data-src="//img.lujinkai.cn/note/htop.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>-8             <span class="token comment"># cpu每个核心负载</span>
Mem             <span class="token comment"># 物理内存，共计7.51G，已用4.95G</span>
Swp             <span class="token comment"># 交换内存，共计2G，已使用4M</span>
Tasks           <span class="token comment"># 进程、线程、正在运行的进程，当前系统有268个进程，910个线程，正在运行的进程有1个</span>
Load average    <span class="token comment"># 系统1分钟、5分钟、10分钟的平均负载情况</span>
Uptime          <span class="token comment"># 系统运行时间</span>

PID             <span class="token comment"># 进程id</span>
<span class="token environment constant">USER</span>            <span class="token comment"># 运行此进程的用户</span>
PRI             <span class="token comment"># 运行此进程的优先级</span>
NI              <span class="token comment"># 进程的优先级别值，默认的为0，可以进行调整</span>
VIRT            <span class="token comment"># 进程占用的虚拟内存</span>
RES             <span class="token comment"># 进程当前使用的内存大小，但不包括swap out，包含其他进程的共享，如果申请100m，实际只使用10m，它只增长10m，与virt相反</span>
SHR             <span class="token comment"># 进程占用的共享内存值，计算某个进程所占用的物理内存大小公式：RES - SHRS </span>
<span class="token comment"># 进程的状态，其中S表示休眠，R表示正在运行，Z表示僵死状态，N表示该进程优先值是负数</span>
    O               <span class="token comment"># 进程正在处理器运行</span>
    S               <span class="token comment"># 睡眠状态（sleeping） 可中断</span>
    D               <span class="token comment"># 睡眠状态（disk sleep），有时候也叫不可中断睡眠状态，在这个状态的进程通常会等待I/O的结束</span>
    R               <span class="token comment"># 可执行状态（runable）Running or runnable (on run queue) 进程处于运行或就绪状态</span>
    I               <span class="token comment"># 空闲状态（idle）</span>
    Z               <span class="token comment"># 退出状态（zombie）进程成为僵尸进程</span>
    T               <span class="token comment"># 暂停状态或跟踪状态（stoped or traced）  </span>
    B               <span class="token comment"># 进程正在等待更多的内存页</span>
    X               <span class="token comment"># 退出状态，进程即将被销毁</span>
%CPU            <span class="token comment"># 该进程占用的CPU使用率</span>
%MEM            <span class="token comment"># 该进程占用的物理内存和总内存的百分比</span>
TIME+           <span class="token comment"># 该进程启动后占用的总的CPU时间</span>
COMMAND         <span class="token comment"># 进程启动的启动命令名称</span></code></pre>

<p>VIRT：进程占用的虚拟内存，这个虚拟内存和 swp 没有关系，是进程“需要的”虚拟内存大小，包括进程使用的库，代码，数据等。</p>
<p>假如进程申请 100m 的内存，但实际上只使用 了 10m，那么它会增长 100m，而不是实际的使用量</p>
<p>现代操作系统里面分配虚拟地址空间操作不同于分配物理内存。在 64 位操作系统上，可用的最大虚拟地址空间有 16EB，即大概 180 亿 GB。那么在一台只有 16G 的物理内存的机器上，我也能要求获得 4TB 的地址空间以备将来使用。例如：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span>ul <span class="token operator">*</span> <span class="token number">1024</span>ul <span class="token operator">*</span> <span class="token number">1024</span>ul <span class="token operator">*</span> <span class="token number">1024</span>ul <span class="token operator">*</span> <span class="token number">1024</span>ul<span class="token punctuation">,</span> <span class="token constant">PROT_READ</span> <span class="token operator">|</span> <span class="token constant">PROT_WRITE</span><span class="token punctuation">,</span> <span class="token constant">MAP_PRIVATE</span> <span class="token operator">|</span> <span class="token constant">MAP_ANONYMOUS</span> <span class="token operator">|</span> <span class="token constant">MAP_NORESERVE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>当使用 mmap 并设置 MAP_NORESERVE 标志时，并不会要求实际的物理内存和 swap 空间存在。所以上述代码可以在 top 中看到使用了 4096g 的 VIRT 虚拟内存，这当然是不可能的，它只是表示使用了 4096GB 的地址空间而已</p>
<p>一般来说不用太在意 VIRT 太高，因为你有 16EB 的空间可以使用</p>
<h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>显示内存使用情况</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">free</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token parameter variable">-b</span>    <span class="token comment">#以字节为单位</span>
<span class="token parameter variable">-m</span>    <span class="token comment">#以MB为单位</span>
<span class="token parameter variable">-g</span>    <span class="token comment">#以GB为单位</span>
<span class="token parameter variable">-h</span>    <span class="token comment">#易读格式</span>
<span class="token parameter variable">-o</span>    <span class="token comment">#不显示-/+buffers/cache行</span>
<span class="token parameter variable">-t</span>    <span class="token comment">#显示RAM + swap的总和</span>
<span class="token parameter variable">-s</span> n  <span class="token comment">#刷新间隔为n秒</span>
<span class="token parameter variable">-c</span> n  <span class="token comment">#刷新n次后即退出</span></code></pre>

<h2 id="pmap"><a href="#pmap" class="headerlink" title="pmap"></a>pmap</h2><p>进程对应的内存映射</p>
<h2 id="vmstat"><a href="#vmstat" class="headerlink" title="vmstat"></a>vmstat</h2><p>虚拟内存信息</p>
<h2 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a>iostat</h2><p>统计 CPU 和设备 IO 信息</p>
<h2 id="dstat"><a href="#dstat" class="headerlink" title="dstat"></a>dstat</h2><p>系统资源统计</p>
<h2 id="iotop"><a href="#iotop" class="headerlink" title="iotop"></a>iotop</h2><p>监视磁盘 I&#x2F;O</p>
<h2 id="iftop"><a href="#iftop" class="headerlink" title="iftop"></a>iftop</h2><p>显示网络带宽使用情况</p>
<h3 id="iftop-和-nethogs"><a href="#iftop-和-nethogs" class="headerlink" title="iftop 和 nethogs"></a>iftop 和 nethogs</h3><p>…</p>
<h2 id="nload"><a href="#nload" class="headerlink" title="nload"></a>nload</h2><p>查看网络实时吞吐量</p>
<h2 id="glances"><a href="#glances" class="headerlink" title="glances"></a>glances</h2><p>综合监控工具</p>
<h2 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h2><p>查看进程打开文件</p>
<h2 id="cockpit"><a href="#cockpit" class="headerlink" title="cockpit"></a>cockpit</h2><p>CentOS8 新特性</p>
<h2 id="kill"><a href="#kill" class="headerlink" title="kill"></a>kill</h2><p>信号发送</p>
<h2 id="作业管理"><a href="#作业管理" class="headerlink" title="作业管理"></a>作业管理</h2><h3 id="nohup"><a href="#nohup" class="headerlink" title="nohup"></a>nohup</h3><p>no hang up，不挂断的意思，如果当前 terminal 关闭了，命令就转为后台继续运行</p>
<p>nohup 和 &amp; 的区别：</p>
<p>如果不是通过 exit 退出 terminal，而是点击 × 强行关闭 terminal，通过 &amp; 进入后台的命令会被杀死，而通过 nohup 会将命令转后台继续运行，所以二者通常搭配一起使用</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk2-ljk bin<span class="token punctuation">]</span><span class="token variable">$nohup</span> ./cerebro <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">4149</span></code></pre>

<h3 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h3><ul>
<li>创建新会话: <code>screen -S &lt;session-name&gt;</code></li>
<li>加入会话：<code>screen -x &lt;session-name&gt;</code></li>
<li>退出并关闭会话：<code>exit</code></li>
<li>剥离当前会话：<code>ctrl + a,d</code></li>
<li>显示所有已经打开的会话：<code>screen -ls</code></li>
<li>恢复某会话：<code>screen -r &lt;session-name&gt;</code></li>
</ul>
<p>关于 <code>-x</code> 和 <code>-r</code> : -x 是加入会话，多个终端都可以加入，-r 是恢复会话，当一个终端恢复会话，其他终端就无法恢复，只能加入</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">screen</span> <span class="token parameter variable">-S</span> new
<span class="token comment"># ctrl + a,d</span>
<span class="token function">screen</span> <span class="token parameter variable">-r</span> new
<span class="token comment"># 另起一个终端</span>
<span class="token function">screen</span> <span class="token parameter variable">-x</span> new</code></pre>

<h3 id="tmux"><a href="#tmux" class="headerlink" title="tmux"></a>tmux</h3><p>Tmux 是一个终端复用器（terminal multiplexer），类似 screen，但是更易用，也更强大</p>
<p>tmux 好像不能共享会话</p>
<ul>
<li><p>新建会话：<code>tmux new -s &lt;session-name&gt;</code></p>
</li>
<li><p>查看所有会话：<code>tmux ls</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 lujinkai<span class="token punctuation">]</span><span class="token comment"># tmux ls</span>
jin: <span class="token number">1</span> windows <span class="token punctuation">(</span>created Sat Jul <span class="token number">25</span> <span class="token number">13</span>:51:23 <span class="token number">2020</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>80x45<span class="token punctuation">]</span> <span class="token punctuation">(</span>attached<span class="token punctuation">)</span>	<span class="token comment">#当前所处的会话是jin</span>
kai: <span class="token number">1</span> windows <span class="token punctuation">(</span>created Sat Jul <span class="token number">25</span> <span class="token number">13</span>:51:34 <span class="token number">2020</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>80x45<span class="token punctuation">]</span>
lu: <span class="token number">1</span> windows <span class="token punctuation">(</span>created Sat Jul <span class="token number">25</span> <span class="token number">13</span>:49:33 <span class="token number">2020</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>80x45<span class="token punctuation">]</span></code></pre>
</li>
<li><p>退出会话：<code>exit</code></p>
</li>
<li><p>分离会话：ctrl + b d 或者<code>tmux detach</code></p>
</li>
<li><p>接入会话：<code>tmux attach -t &lt;session-name&gt; </code> 用于重新接入某个已经存在的会话。</p>
</li>
<li><p>切换会话：<code>tmux switch -t &lt;session-name&gt;</code></p>
</li>
<li><p>杀死会话：<code>tmux kill-session -t &lt;session-name&gt; </code></p>
</li>
</ul>
<h2 id="并行运行"><a href="#并行运行" class="headerlink" title="并行运行"></a>并行运行</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/12/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/14/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.to2b.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.to2b.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.to2b.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.to2b.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
