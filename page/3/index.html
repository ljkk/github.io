<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.lujinkai.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.lujinkai.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/3/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%97%A5%E5%BF%97zap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%97%A5%E5%BF%97zap/" class="post-title-link" itemprop="url">日志zap</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:40:15" itemprop="dateCreated datePublished" datetime="2022-09-24T14:40:15+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">搭建gin脚手架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="zap日志级别"><a href="#zap日志级别" class="headerlink" title="zap日志级别"></a>zap日志级别</h2><p>zap日志级别，一共7级：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	<span class="comment">// DebugLevel logs are typically voluminous, and are usually disabled in production.</span></span><br><span class="line">	DebugLevel Level = <span class="literal">iota</span> - <span class="number">1</span></span><br><span class="line">	<span class="comment">// InfoLevel is the default logging priority.</span></span><br><span class="line">	InfoLevel</span><br><span class="line">	<span class="comment">// WarnLevel logs are more important than Info, but don&#x27;t need individual human review.</span></span><br><span class="line">	WarnLevel</span><br><span class="line">	<span class="comment">// ErrorLevel logs are high-priority. If an application is running smoothly, it shouldn&#x27;t generate any error-level logs.</span></span><br><span class="line">	ErrorLevel</span><br><span class="line">	<span class="comment">// DPanicLevel logs are particularly important errors. In development the logger panics after writing the message.</span></span><br><span class="line">	DPanicLevel</span><br><span class="line">	<span class="comment">// PanicLevel logs a message, then panics.</span></span><br><span class="line">	PanicLevel</span><br><span class="line">	<span class="comment">// FatalLevel logs a message, then calls os.Exit(1).</span></span><br><span class="line">	FatalLevel</span><br><span class="line"></span><br><span class="line">	_minLevel = DebugLevel</span><br><span class="line">	_maxLevel = FatalLevel</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="zap官方案例"><a href="#zap官方案例" class="headerlink" title="zap官方案例"></a>zap官方案例</h2><p>zap 的官方案例中，介绍了三种使用方式：</p>
<ul>
<li>AdvancedConfiguration：高级配置</li>
<li>BasicConfiguration：基本配置</li>
<li>Presets：预置</li>
</ul>
<h3 id="Presets"><a href="#Presets" class="headerlink" title="Presets"></a>Presets</h3><p>Presets（预置函数） 是 zap 日志包最简单的用法，不需要过多的自定义配置就可以用起来。</p>
<p>Presets 官网示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logger := zap.NewExample() <span class="comment">// or NewProduction, or NewDevelopment</span></span><br><span class="line">	<span class="keyword">defer</span> logger.Sync()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> url = <span class="string">&quot;http://example.com&quot;</span></span><br><span class="line"></span><br><span class="line">	sugar := logger.Sugar()</span><br><span class="line">	sugar.Infow(<span class="string">&quot;Failed to fetch URL.&quot;</span>,</span><br><span class="line">		<span class="string">&quot;url&quot;</span>, url,</span><br><span class="line">		<span class="string">&quot;attempt&quot;</span>, <span class="number">3</span>,</span><br><span class="line">		<span class="string">&quot;backoff&quot;</span>, time.Second,</span><br><span class="line">	)</span><br><span class="line">	sugar.Infof(<span class="string">&quot;Failed to fetch URL: %s&quot;</span>, url)</span><br><span class="line"></span><br><span class="line">	logger.Info(<span class="string">&quot;Failed to fetch URL.&quot;</span>,</span><br><span class="line">		zap.String(<span class="string">&quot;url&quot;</span>, url),</span><br><span class="line">		zap.Int(<span class="string">&quot;attempt&quot;</span>, <span class="number">3</span>),</span><br><span class="line">		zap.Duration(<span class="string">&quot;backoff&quot;</span>, time.Second),</span><br><span class="line">	)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BasicConfiguration"><a href="#BasicConfiguration" class="headerlink" title="BasicConfiguration"></a>BasicConfiguration</h3><p>当预置函数的logger配置不满足我们的需求时，可以自定义配置logger </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// For some users, the presets offered by the NewProduction, NewDevelopment,</span></span><br><span class="line">	<span class="comment">// and NewExample constructors won&#x27;t be appropriate. For most of those</span></span><br><span class="line">	<span class="comment">// users, the bundled Config struct offers the right balance of flexibility</span></span><br><span class="line">	<span class="comment">// and convenience. (For more complex needs, see the AdvancedConfiguration</span></span><br><span class="line">	<span class="comment">// example.)</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// See the documentation for Config and zapcore.EncoderConfig for all the</span></span><br><span class="line">	<span class="comment">// available options.</span></span><br><span class="line">	rawJSON := []<span class="type">byte</span>(<span class="string">`&#123;</span></span><br><span class="line"><span class="string">	  &quot;level&quot;: &quot;debug&quot;,</span></span><br><span class="line"><span class="string">	  &quot;encoding&quot;: &quot;json&quot;,</span></span><br><span class="line"><span class="string">	  &quot;outputPaths&quot;: [&quot;stdout&quot;, &quot;/tmp/logs&quot;],</span></span><br><span class="line"><span class="string">	  &quot;errorOutputPaths&quot;: [&quot;stderr&quot;],</span></span><br><span class="line"><span class="string">	  &quot;initialFields&quot;: &#123;&quot;foo&quot;: &quot;bar&quot;&#125;,</span></span><br><span class="line"><span class="string">	  &quot;encoderConfig&quot;: &#123;</span></span><br><span class="line"><span class="string">	    &quot;messageKey&quot;: &quot;message&quot;,</span></span><br><span class="line"><span class="string">	    &quot;levelKey&quot;: &quot;level&quot;,</span></span><br><span class="line"><span class="string">	    &quot;levelEncoder&quot;: &quot;lowercase&quot;</span></span><br><span class="line"><span class="string">	  &#125;</span></span><br><span class="line"><span class="string">	&#125;`</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> cfg zap.Config</span><br><span class="line">	<span class="keyword">if</span> err := json.Unmarshal(rawJSON, &amp;cfg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	logger, err := cfg.Build()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> logger.Sync()</span><br><span class="line"></span><br><span class="line">	logger.Info(<span class="string">&quot;logger construction succeeded&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AdvancedConfiguration"><a href="#AdvancedConfiguration" class="headerlink" title="AdvancedConfiguration"></a>AdvancedConfiguration</h3><p>如果需要更多的功能，例如：分隔文件、将日志发送到消息队列等，需要引入 <code>go.uber.org/zap/zapcore</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">	<span class="string">&quot;go.uber.org/zap/zapcore&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// The bundled Config struct only supports the most common configuration</span></span><br><span class="line">	<span class="comment">// options. More complex needs, like splitting logs between multiple files</span></span><br><span class="line">	<span class="comment">// or writing to non-file outputs, require use of the zapcore package.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// In this example, imagine we&#x27;re both sending our logs to Kafka and writing</span></span><br><span class="line">	<span class="comment">// them to the console. We&#x27;d like to encode the console output and the Kafka</span></span><br><span class="line">	<span class="comment">// topics differently, and we&#x27;d also like special treatment for</span></span><br><span class="line">	<span class="comment">// high-priority logs.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// First, define our level-handling logic.</span></span><br><span class="line">	highPriority := zap.LevelEnablerFunc(<span class="function"><span class="keyword">func</span><span class="params">(lvl zapcore.Level)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> lvl &gt;= zapcore.ErrorLevel</span><br><span class="line">	&#125;)</span><br><span class="line">	lowPriority := zap.LevelEnablerFunc(<span class="function"><span class="keyword">func</span><span class="params">(lvl zapcore.Level)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> lvl &lt; zapcore.ErrorLevel</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Assume that we have clients for two Kafka topics. The clients implement</span></span><br><span class="line">	<span class="comment">// zapcore.WriteSyncer and are safe for concurrent use. (If they only</span></span><br><span class="line">	<span class="comment">// implement io.Writer, we can use zapcore.AddSync to add a no-op Sync</span></span><br><span class="line">	<span class="comment">// method. If they&#x27;re not safe for concurrent use, we can add a protecting</span></span><br><span class="line">	<span class="comment">// mutex with zapcore.Lock.)</span></span><br><span class="line">	topicDebugging := zapcore.AddSync(ioutil.Discard)</span><br><span class="line">	topicErrors := zapcore.AddSync(ioutil.Discard)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// High-priority output should also go to standard error, and low-priority</span></span><br><span class="line">	<span class="comment">// output should also go to standard out.</span></span><br><span class="line">	consoleDebugging := zapcore.Lock(os.Stdout)</span><br><span class="line">	consoleErrors := zapcore.Lock(os.Stderr)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Optimize the Kafka output for machine consumption and the console output</span></span><br><span class="line">	<span class="comment">// for human operators.</span></span><br><span class="line">	kafkaEncoder := zapcore.NewJSONEncoder(zap.NewProductionEncoderConfig())</span><br><span class="line">	consoleEncoder := zapcore.NewConsoleEncoder(zap.NewDevelopmentEncoderConfig())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Join the outputs, encoders, and level-handling functions into</span></span><br><span class="line">	<span class="comment">// zapcore.Cores, then tee the four cores together.</span></span><br><span class="line">	core := zapcore.NewTee(</span><br><span class="line">		zapcore.NewCore(kafkaEncoder, topicErrors, highPriority),</span><br><span class="line">		zapcore.NewCore(consoleEncoder, consoleErrors, highPriority),</span><br><span class="line">		zapcore.NewCore(kafkaEncoder, topicDebugging, lowPriority),</span><br><span class="line">		zapcore.NewCore(consoleEncoder, consoleDebugging, lowPriority),</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// From a zapcore.Core, it&#x27;s easy to construct a Logger.</span></span><br><span class="line">	logger := zap.New(core)</span><br><span class="line">	<span class="keyword">defer</span> logger.Sync()</span><br><span class="line">	logger.Info(<span class="string">&quot;constructed a logger&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zap-amp-zapcore知识点详解"><a href="#zap-amp-zapcore知识点详解" class="headerlink" title="zap&amp;zapcore知识点详解"></a>zap&amp;zapcore知识点详解</h2><h2 id="生产配置参考"><a href="#生产配置参考" class="headerlink" title="生产配置参考"></a>生产配置参考</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E4%BB%A4%E7%89%8C%E6%A1%B6%E9%99%90%E6%B5%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E4%BB%A4%E7%89%8C%E6%A1%B6%E9%99%90%E6%B5%81/" class="post-title-link" itemprop="url">令牌桶限流</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:40:10" itemprop="dateCreated datePublished" datetime="2022-09-24T14:40:10+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">搭建gin脚手架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%90%AD%E5%BB%BAgin%E8%84%9A%E6%89%8B%E6%9E%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/time/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/time/" class="post-title-link" itemprop="url">time</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:40:06" itemprop="dateCreated datePublished" datetime="2022-09-24T14:40:06+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/template/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/template/" class="post-title-link" itemprop="url">template</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:40:01" itemprop="dateCreated datePublished" datetime="2022-09-24T14:40:01+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="text-x2F-template"><a href="#text-x2F-template" class="headerlink" title="text&#x2F;template"></a>text&#x2F;template</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/strings/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/strings/" class="post-title-link" itemprop="url">strings</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:39:53" itemprop="dateCreated datePublished" datetime="2022-09-24T14:39:53+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/strconv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/strconv/" class="post-title-link" itemprop="url">strconv</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:39:48" itemprop="dateCreated datePublished" datetime="2022-09-24T14:39:48+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/reflect/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/reflect/" class="post-title-link" itemprop="url">reflect</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:39:45" itemprop="dateCreated datePublished" datetime="2022-09-24T14:39:45+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/context/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/context/" class="post-title-link" itemprop="url">context</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:39:29" itemprop="dateCreated datePublished" datetime="2022-09-24T14:39:29+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Context 包定义了上下文类型，该上下文类型跨越 API 边界和进程之间传递截止期限，取消信号和其他请求范围值。</p>
<p>对服务器的传入请求应创建一个 Context，对服务器的传出调用应接受 Context。它们之间的函数调用链必须传播 Context，可以用使用 WithCancel，WithDeadline，WithTimeout 或 WithValue 创建的派生上下文替换。当 Context 被取消时，从它派生的所有 Context 也被取消。</p>
<p>WithCancel，WithDeadline 和 WithTimeout 函数采用 Context（父级）并返回派生的 Context（子级）和 CancelFunc。调用 CancelFunc 将取消子对象及其子对象，删除父对子对象的引用，并停止任何关联的定时器。未能调用 CancelFunc 会泄漏子项及其子项，直至父项被取消或计时器激发。go vet 工具检查在所有控制流路径上使用 CancelFuncs。</p>
<p>使用 Contexts 的程序应该遵循这些规则来保持包之间的接口一致，并使静态分析工具能够检查上下文传播：</p>
<p>不要将上下文存储在结构类型中；相反，将一个 Context 明确地传递给每个需要它的函数。上下文应该是第一个参数，通常命名为 ctx：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoSomething</span><span class="params">(ctx context.Context, arg Arg)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// ... use ctx ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即使函数允许，也不要传递 nil Context。如果您不确定要使用哪个 Context，请传递 context.TODO。</p>
<p>使用上下文值仅适用于传输进程和 API 的请求范围数据，而不用于将可选参数传递给函数。</p>
<p>相同的上下文可以传递给在不同 goroutine 中运行的函数; 上下文对于多个 goroutine 同时使用是安全的。</p>
<p>有关使用 Contexts 的服务器的示例代码，请参阅<a target="_blank" rel="noopener" href="https://blog.golang.org/context%E3%80%82">https://blog.golang.org/context。</a></p>
<h2 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h2><h3 id="Canceled"><a href="#Canceled" class="headerlink" title="Canceled"></a>Canceled</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Canceled = errors.New(<span class="string">&quot;context canceled&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Canceled is the error returned by Context.Err when the context is canceled.</p>
<h3 id="DeadlineExceeded"><a href="#DeadlineExceeded" class="headerlink" title="DeadlineExceeded"></a>DeadlineExceeded</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var DeadlineExceeded error = deadlineExceededError&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>DeadlineExceeded is the error returned by Context.Err when the context’s deadline passes. 截止时间过后返回的错误</p>
<h2 id="type-CancelFunc"><a href="#type-CancelFunc" class="headerlink" title="type CancelFunc"></a>type CancelFunc</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CancelFunc <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<h2 id="func-WithCancel"><a href="#func-WithCancel" class="headerlink" title="func WithCancel"></a>func WithCancel</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span></span> (ctx Context, cancel CancelFunc)</span><br></pre></td></tr></table></figure>

<p><code>WithCancel</code>函数用来创建一个可取消的<code>context</code>，返回一个<code>context</code>和一个<code>CancelFunc</code>，调用<code>CancelFunc</code>即可触发<code>cancel</code>操作。</p>
<p>取消 Context 会释放与它相关的资源，所以只要完成在 Context 中运行的操作，代码就应该调用 cancel。</p>
<p>示例：</p>
<p>这个例子演示了如何使用可取消的 context 来防止 goroutine 泄漏。在示例函数结束时，由 gen 启动的 goroutine 将返回而不会泄漏。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	gen := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> &lt;-<span class="keyword">chan</span> <span class="type">int</span> &#123;</span><br><span class="line">		dst := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">		n := <span class="number">1</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">					<span class="keyword">return</span> <span class="comment">// returning not to leak the goroutine	返回不泄漏goroutine</span></span><br><span class="line">				<span class="keyword">case</span> dst &lt;- n:</span><br><span class="line">					n++</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="keyword">return</span> dst</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	<span class="keyword">defer</span> cancel() <span class="comment">// cancel when we are finished consuming integers</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> n := <span class="keyword">range</span> gen(ctx) &#123;</span><br><span class="line">		fmt.Println(n)</span><br><span class="line">		<span class="keyword">if</span> n == <span class="number">5</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output:</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<h2 id="func-WithDeadline"><a href="#func-WithDeadline" class="headerlink" title="func WithDeadline"></a>func WithDeadline</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, deadline time.Time)</span></span> (Context, CancelFunc)</span><br></pre></td></tr></table></figure>

<p><code>WithDeadline</code>返回一个基于<code>parent</code>的可取消的<code>context</code>，并且其过期时间<code>deadline</code>不晚于所设置时间<code>d</code>。</p>
<p>如果父节点<code>parent</code>有过期时间并且过期时间早于给定时间<code>d</code>，那么新建的子节点<code>context</code>无需设置过期时间，使用<code>WithCancel</code>创建一个可取消的<code>context</code>即可；</p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">d := time.Now().Add(<span class="number">50</span> * time.Millisecond)</span><br><span class="line">ctx, cancel := context.WithDeadline(context.Background(), d)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Even though ctx will be expired, it is good practice to call its</span></span><br><span class="line"><span class="comment">// cancelation function in any case. Failure to do so may keep the</span></span><br><span class="line"><span class="comment">// context and its parent alive longer than necessary.</span></span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">    fmt.Println(<span class="string">&quot;overslept&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">    fmt.Println(ctx.Err())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="func-WithTimeout"><a href="#func-WithTimeout" class="headerlink" title="func WithTimeout"></a>func WithTimeout</h2><p>与<code>WithDeadline</code>类似，<code>WithTimeout</code>也是创建一个定时取消的<code>context</code>，只不过<code>WithDeadline</code>是接收一个过期时间点，而<code>WithTimeout</code>接收一个相对当前时间的过期时长<code>timeout</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span></span> (Context, CancelFunc) &#123;</span><br><span class="line">    <span class="keyword">return</span> WithDeadline(parent, time.Now().Add(timeout))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="type-Context"><a href="#type-Context" class="headerlink" title="type Context"></a>type Context</h2><p>context 包含<strong>截止日期</strong>，<strong>取消信号</strong>以及<strong>跨越 API 边界的其他值</strong>。</p>
<p>上下文的方法可能会被多个 goroutine 同时调用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="type">bool</span>)</span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    Err() <span class="type">error</span></span><br><span class="line">    Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Deadline</code>返回绑定当前<code>context</code>的任务被取消的截止时间；如果没有设定期限，将返回<code>ok == false</code>。</li>
<li><code>Done</code> 当绑定当前<code>context</code>的任务被取消时，将返回一个关闭的<code>channel</code>；如果当前<code>context</code>不会被取消，将返回<code>nil</code>。</li>
<li><code>Err</code> 如果<code>Done</code>返回的<code>channel</code>没有关闭，将返回<code>nil</code>;如果<code>Done</code>返回的<code>channel</code>已经关闭，将返回非空的值表示任务结束的原因。如果是<code>context</code>被取消，<code>Err</code>将返回<code>Canceled</code>；如果是<code>context</code>超时，<code>Err</code>将返回<code>DeadlineExceeded</code>。</li>
<li><code>Value</code> 返回<code>context</code>存储的键值对中当前<code>key</code>对应的值，如果没有对应的<code>key</code>,则返回<code>nil</code>。</li>
</ul>
<h2 id="func-Background"><a href="#func-Background" class="headerlink" title="func Background"></a>func Background</h2><p><code>emptyCtx</code>是一个<code>int</code>类型的变量，但实现了<code>context</code>的接口。<code>emptyCtx</code>没有超时时间，不能取消，也不能存储任何额外信息，所以<code>emptyCtx</code>用来作为<code>context</code>树的根节点。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// An emptyCtx is never canceled, has no values, and has no deadline. It is not</span></span><br><span class="line"><span class="comment">// struct&#123;&#125;, since vars of this type must have distinct addresses.</span></span><br><span class="line"><span class="keyword">type</span> emptyCtx <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span></span> Deadline() (deadline time.Time, ok <span class="type">bool</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span></span> Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span></span> Err() <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*emptyCtx)</span></span> Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *emptyCtx)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> e &#123;</span><br><span class="line">    <span class="keyword">case</span> background:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;context.Background&quot;</span></span><br><span class="line">    <span class="keyword">case</span> todo:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;context.TODO&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;unknown empty Context&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    background = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">    todo       = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Background</span><span class="params">()</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">return</span> background</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TODO</span><span class="params">()</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">return</span> todo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但我们一般不会直接使用<code>emptyCtx</code>，而是使用由<code>emptyCtx</code>实例化的两个变量，分别可以通过调用<code>Background</code>和<code>TODO</code>方法得到，这两个<code>context</code>在实现上是一样的。</p>
<h2 id="func-TODO"><a href="#func-TODO" class="headerlink" title="func TODO"></a>func TODO</h2><p><code>Background</code> 和 <code>TODO</code> 方法在某种层面上看其实也只是互为别名，两者没有太大的差别，不过 <code>context.Background()</code> 是上下文中最顶层的默认值，所有其他的上下文都应该从 <code>context.Background()</code> 演化出来。</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1646475452775.png" alt="1646128337346"></p>
<p>我们应该只在不确定时使用 <code>context.TODO()</code>，在多数情况下如果函数没有上下文作为入参，我们往往都会使用 <code>context.Background()</code> 作为起始的 <code>Context</code> 向下传递。</p>
<h2 id="func-WithValue"><a href="#func-WithValue" class="headerlink" title="func WithValue"></a>func WithValue</h2><p><code>WithValue</code>用以向<code>context</code>添加键值对：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val <span class="keyword">interface</span>&#123;&#125;)</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">if</span> key == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;nil key&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !reflect.TypeOf(key).Comparable() &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;key is not comparable&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;valueCtx&#123;parent, key, val&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里添加键值对不是在原<code>context</code>结构体上直接添加，而是以此<code>context</code>作为父节点，重新创建一个新的<code>valueCtx</code>子节点，将键值对添加在子节点上，由此形成一条<code>context</code>链。获取<code>value</code>的过程就是在这条<code>context</code>链上由尾部上前搜寻。</p>
<p>返回<code>parent</code>的一个副本，调用该副本的 Value(key)方法将得到 val。这样我们不光将根节点原有的值保留了，还在子孙节点中加入了新的值，注意若存在 Key 相同，则会被覆盖。</p>
<p>注意：<strong>为了避免使用 context 的包之间发生冲突，key 必须具有可比性（ comparable ），不应该是 string 或者其他任何内置类型。应该使用自定义类型。</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Go 语言中的 <code>Context</code> 的主要作用还是在多个 Goroutine 或者模块之间同步取消信号或者截止日期，用于减少对资源的消耗和长时间占用，避免资源浪费，虽然传值也是它的功能之一，但是这个功能我们还是很少用到。</p>
<p>在真正使用传值的功能时我们也应该非常谨慎，不能将请求的所有参数都使用 <code>Context</code> 进行传递，这是一种非常差的设计，比较常见的使用场景是传递请求对应用户的认证令牌以及用于进行分布式追踪的请求 ID。</p>
<p><code>context</code>包通过构建树型关系的 Context，来达到上一层 Goroutine 能对传递给下一层 Goroutine 的控制。对于处理一个 Request 请求操作，需要采用<code>context</code>来层层控制 Goroutine，以及传递一些变量来共享。</p>
<ul>
<li>Context 对象的生存周期一般仅为一个请求的处理周期。即针对一个请求创建一个 Context 变量（它为 Context 树结构的根）；在请求处理结束后，撤销此 ctx 变量，释放资源。</li>
<li>每次创建一个 Goroutine，要么将原有的 Context 传递给 Goroutine，要么创建一个子 Context 并传递给 Goroutine。</li>
<li>Context 能灵活地存储不同类型、不同数目的值，并且使多个 Goroutine 安全地读写其中的值。</li>
<li>当通过父 Context 对象创建子 Context 对象时，可同时获得子 Context 的一个撤销函数，这样父 Context 对象的创建环境就获得了对子 Context 将要被传递到的 Goroutine 的撤销权。</li>
</ul>
<h3 id="使用原则"><a href="#使用原则" class="headerlink" title="使用原则"></a>使用原则</h3><ul>
<li>不要把 Context 存在一个结构体当中，显式地传入函数。Context 变量需要作为第一个参数使用，一般命名为 ctx；</li>
<li>即使方法允许，也不要传入一个 nil 的 Context，如果你不确定你要用什么 Context 的时候传一个 context.TODO；</li>
<li>使用 context 的 Value 相关方法只应该用于在程序和接口中传递的和请求相关的元数据，不要用它来传递一些可选的参数；</li>
<li>同样的 Context 可以用来传递到不同的 goroutine 中，Context 在多个 goroutine 中是安全的；</li>
<li>在子 Context 被传递到的 goroutine 中，应该对该子 Context 的 Done 信道（channel）进行监控，一旦该信道被关闭（即上层运行环境撤销了本 goroutine 的执行），应主动终止对当前请求信息的处理，释放资源并返回。</li>
</ul>
<p>通常，<code>context.Background()</code>作为最顶层的 Context，在此基础上创建可撤销的 Context。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/sync/sync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/sync/sync/" class="post-title-link" itemprop="url">sync</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:38:59" itemprop="dateCreated datePublished" datetime="2022-09-24T14:38:59+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/sync/" itemprop="url" rel="index"><span itemprop="name">sync</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>读锁：读读不互斥。加了读锁，其他协程仍然可以读，但是不能写<br>写锁：独占。加了写锁，其他协程无论读写，都不被允许</p>
<p>sync包我们一般不用，推荐使用channel，但是我们也要熟悉。</p>
<h2 id="互斥锁和自旋锁"><a href="#互斥锁和自旋锁" class="headerlink" title="互斥锁和自旋锁"></a>互斥锁和自旋锁</h2><h3 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h3><blockquote>
<p>共享资源的使用是互斥的，即一个线程获得资源的使用权后就会将该资源加锁，使用完后会将其解锁，如果在使用过程中有其他线程想要获取该资源的锁，那么它就会被阻塞陷入睡眠状态，直到该资源被解锁才会被唤醒，如果被阻塞的资源不止一个，那么它们都会被唤醒，但是获得资源使用权的是第一个被唤醒的线程，其它线程又陷入沉睡。</p>
</blockquote>
<p>互斥锁在各个语言中定义都不太相同，在大多数语言中，互斥锁使用线程调度来实现的，假如现在锁被锁住了，那么后面的线程就会进入”休眠”状态，直到解锁之后，又会唤醒线程继续执行。这也叫空等待(sleep-waiting)。</p>
<p>但<strong>严格来说，只要是同一时刻只能被拿到一次的锁都叫互斥锁</strong>，自旋锁也是</p>
<p>在golang中, sync.Mutex就是一个开箱即用的互斥锁，它能保证在同一时刻只有一个”协程”能拿到锁，golang中就同时使用了”自旋”和”休眠”两种方式来实现互斥锁。</p>
<h3 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h3><p>自旋锁也是广义上的互斥锁，是互斥锁的实现方式之一，它不会产生线程的调度，而是通过”循环”来尝试获取锁，优点是能很快的获取锁，缺点是会占用过多的CPU时间，这被称为忙等待(busy-waiting)。</p>
<h2 id="interface-Locker"><a href="#interface-Locker" class="headerlink" title="interface Locker"></a>interface Locker</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Locker <span class="keyword">interface</span> &#123;</span><br><span class="line">    Lock()</span><br><span class="line">    Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Locker接口代表一个可以加锁和解锁的对象。 </p>
<h2 id="type-Once"><a href="#type-Once" class="headerlink" title="type Once"></a>type Once</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Once <span class="keyword">struct</span> &#123;</span><br><span class="line">    done <span class="type">uint32</span></span><br><span class="line">	m    Mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Once是只执行一次动作的对象。 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> once sync.Once</span><br><span class="line">	onceBody := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Only once&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		once.Do(onceBody)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only once</span></span><br></pre></td></tr></table></figure>

<h3 id="func-o-Once-Do-f-func"><a href="#func-o-Once-Do-f-func" class="headerlink" title="func (o *Once) Do(f func())"></a>func (o *Once) Do(f func())</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Once)</span></span> Do(f <span class="function"><span class="keyword">func</span><span class="params">()</span></span>)</span><br></pre></td></tr></table></figure>

<p>Do方法当且仅当第一次被调用时才执行函数f。换句话说，给定变量： <code>var once sync.Once</code>， 如果<code>once.Do(f)</code>被多次调用，只有第一次调用会执行<code>f</code>，即使<code>f</code>每次调用<code>Do</code>提供的<code>f</code>值不同。</p>
<p>Do用于必须刚好运行一次的初始化。因为<code>f</code>是没有参数的，因此可能需要使用闭包来提供给Do方法调用： </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; config.init(filename) &#125;)</span><br></pre></td></tr></table></figure>

<p>因为只有<code>f</code>返回后Do方法才会返回，<code>f</code>若引起了Do的调用，会导致死锁。 </p>
<h2 id="type-Mutex"><a href="#type-Mutex" class="headerlink" title="type Mutex"></a>type Mutex</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</span><br><span class="line">	state <span class="type">int32</span></span><br><span class="line">	sema  <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Mutex是一个互斥锁，又叫拍他锁或者写锁，零值为解锁状态。Mutex类型的锁和线程无关，可以由不同的goroutine加锁和解锁。 </p>
<p>如果想要区分读、写锁，可以使用sync.RWMutex类型，见后文。 </p>
<p><strong>在Lock()和Unlock()之间的代码段称为资源的临界区(critical section)，在这一区间内的代码是严格被Lock()保护的，是线程安全的，任何一个时间点都只能有一个goroutine执行这段区间的代码</strong>。 </p>
<h3 id="func-m-Mutex-Lock"><a href="#func-m-Mutex-Lock" class="headerlink" title="func (m *Mutex) Lock()"></a>func (m *Mutex) Lock()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Lock()</span><br></pre></td></tr></table></figure>

<p>声明互斥锁m：<code>var m sync.Mutex</code></p>
<p><code>m.Lock()</code> 对m加互斥锁，如果再次执行<code>m.Lock()</code>，则会阻塞，直到<code>m.Unlock()</code>对m解锁，第二次对m加锁才会生效。以此实现对数据的保护。</p>
<h3 id="func-m-Mutex-Unlock"><a href="#func-m-Mutex-Unlock" class="headerlink" title="func (m *Mutex) Unlock()"></a>func (m *Mutex) Unlock()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Unlock()</span><br></pre></td></tr></table></figure>

<p>声明互斥锁m：<code>var m sync.Mutex</code></p>
<p><code>m.Unlock()</code>对m解锁，如果m未加锁会导致运行时错误：<code>panic: sync: unlock of unlocked mutex</code></p>
<h2 id="type-RWMutex"><a href="#type-RWMutex" class="headerlink" title="type RWMutex"></a>type RWMutex</h2><p>读锁：又叫共享锁，可以并发读</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RWMutex <span class="keyword">struct</span> &#123;</span><br><span class="line">	w           Mutex  <span class="comment">// held if there are pending writers</span></span><br><span class="line">	writerSem   <span class="type">uint32</span> <span class="comment">// 写锁需要等待读锁释放的信号量</span></span><br><span class="line">	readerSem   <span class="type">uint32</span> <span class="comment">// 读锁需要等待写锁释放的信号量</span></span><br><span class="line">	readerCount <span class="type">int32</span>  <span class="comment">// 读锁后面挂起了多少个写锁申请</span></span><br><span class="line">	readerWait  <span class="type">int32</span>  <span class="comment">// 已释放了多少个读锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RWMutex是读写锁。 该锁可以加多个读锁或者一个写锁，其经常用于读次数远远多于写次数的场景；零值为解锁状态。RWMutex类型的锁也和线程无关，可以由不同的goroutine加读取锁&#x2F;写入和解读取锁&#x2F;写入锁。 </p>
<p>RWMutex是基于Mutex的，在Mutex的基础之上增加了读、写的信号量，并使用了类似引用计数的读锁数量。</p>
<p>声明一个读写锁：<code>var rw sync.RWMutex</code></p>
<ul>
<li><strong>rw 可以同时加多个读锁</strong></li>
<li><strong>rw 加读锁时再加写锁将阻塞，有写锁时再加读锁将阻塞</strong></li>
<li><strong>rw 加写锁，后续再加读锁和写锁都将阻塞</strong></li>
</ul>
<h3 id="func-rw-RWMutex-Lock"><a href="#func-rw-RWMutex-Lock" class="headerlink" title="func (rw *RWMutex) Lock()"></a>func (rw *RWMutex) Lock()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> Lock()</span><br></pre></td></tr></table></figure>

<p>对 rw 加写锁，后续再加读锁和写锁都将阻塞</p>
<h3 id="func-rw-RWMutex-Unlock"><a href="#func-rw-RWMutex-Unlock" class="headerlink" title="func (rw *RWMutex) Unlock()"></a>func (rw *RWMutex) Unlock()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> Unlock()</span><br></pre></td></tr></table></figure>

<p>对 rw 解写锁</p>
<h3 id="func-rw-RWMutex-RLock"><a href="#func-rw-RWMutex-RLock" class="headerlink" title="func (rw *RWMutex) RLock()"></a>func (rw *RWMutex) RLock()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> RLock()</span><br></pre></td></tr></table></figure>

<p>对 rw 加读锁，在执行RUnlock解读锁之前，后续可以再加读锁，但是加写锁会阻塞</p>
<h3 id="func-rw-RWMutex-RUnlock"><a href="#func-rw-RWMutex-RUnlock" class="headerlink" title="func (rw *RWMutex) RUnlock()"></a>func (rw *RWMutex) RUnlock()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> RUnlock()</span><br></pre></td></tr></table></figure>

<p>对 rw 解读锁</p>
<h3 id="func-rw-RWMutex-RLocker-Locker"><a href="#func-rw-RWMutex-RLocker-Locker" class="headerlink" title="func (rw *RWMutex) RLocker() Locker"></a>func (rw *RWMutex) RLocker() Locker</h3><p>返回一个实现了Lock()和Unlock()方法的Locker接口</p>
<h2 id="type-Cond"><a href="#type-Cond" class="headerlink" title="type Cond"></a>type Cond</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Cond <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 在观测或更改条件时L会冻结</span></span><br><span class="line">	L Locker</span><br><span class="line">	<span class="comment">// 包含隐藏或非导出字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://studygolang.com/articles/28072">https://studygolang.com/articles/28072</a><br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000038319116">https://segmentfault.com/a/1190000038319116</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/351776260">https://zhuanlan.zhihu.com/p/351776260</a></p>
<h3 id="func-NewCond-l-Locker"><a href="#func-NewCond-l-Locker" class="headerlink" title="func NewCond(l Locker)"></a>func NewCond(l Locker)</h3><h3 id="func-c-Cond-Broadcast"><a href="#func-c-Cond-Broadcast" class="headerlink" title="func (c *Cond) Broadcast()"></a>func (c *Cond) Broadcast()</h3><h3 id="func-c-Cond-Signal"><a href="#func-c-Cond-Signal" class="headerlink" title="func (c *Cond) Signal()"></a>func (c *Cond) Signal()</h3><h3 id="func-c-Cond-Wait"><a href="#func-c-Cond-Wait" class="headerlink" title="func (c *Cond) Wait()"></a>func (c *Cond) Wait()</h3><h2 id="type-Map"><a href="#type-Map" class="headerlink" title="type Map"></a>type Map</h2><p>Go中的map不是并发安全的，在Go1.9之后，引入了<code>sync.Map</code>：并发安全的map</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ricklz/p/13659397.html">https://www.cnblogs.com/ricklz/p/13659397.html</a><br><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/34.html">http://c.biancheng.net/view/34.html</a></p>
<h3 id="func-m-Map-Delete-key-interface"><a href="#func-m-Map-Delete-key-interface" class="headerlink" title="func (m *Map) Delete(key interface{})"></a>func (m *Map) Delete(key interface{})</h3><h3 id="func-m-Map-Load-key-interface-value-interface-ok-bool"><a href="#func-m-Map-Load-key-interface-value-interface-ok-bool" class="headerlink" title="func (m *Map) Load(key interface{}) (value interface{}, ok bool)"></a>func (m *Map) Load(key interface{}) (value interface{}, ok bool)</h3><h3 id="func-m-Map-LoadAndDelete-key-interface-value-interface-loaded-bool"><a href="#func-m-Map-LoadAndDelete-key-interface-value-interface-loaded-bool" class="headerlink" title="func (m *Map) LoadAndDelete(key interface{}) (value interface{}, loaded bool)"></a>func (m *Map) LoadAndDelete(key interface{}) (value interface{}, loaded bool)</h3><h3 id="func-m-Map-LoadOrStore-key-value-interface-actual-interface-loaded-bool"><a href="#func-m-Map-LoadOrStore-key-value-interface-actual-interface-loaded-bool" class="headerlink" title="func (m *Map) LoadOrStore(key, value interface{}) (actual interface{}, loaded bool)"></a>func (m *Map) LoadOrStore(key, value interface{}) (actual interface{}, loaded bool)</h3><h3 id="func-m-Map-Range-f-func-key-value-interface-bool"><a href="#func-m-Map-Range-f-func-key-value-interface-bool" class="headerlink" title="func (m *Map) Range(f func(key, value interface{}) bool)"></a>func (m *Map) Range(f func(key, value interface{}) bool)</h3><h3 id="func-m-Map-Store-key-value-interface"><a href="#func-m-Map-Store-key-value-interface" class="headerlink" title="func (m *Map) Store(key, value interface{})"></a>func (m *Map) Store(key, value interface{})</h3><h2 id="type-Pool"><a href="#type-Pool" class="headerlink" title="type Pool"></a>type Pool</h2><p>pool：资源池</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8fbbf6c012b2">https://www.jianshu.com/p/8fbbf6c012b2</a></p>
<ul>
<li>临时对象</li>
<li>自动移除</li>
<li>当这个对象的引用只有sync.Pool持有时，这个对象内存会被释放</li>
<li>多线程安全</li>
<li>目的就是缓存并重用对象，减少GC的压力</li>
<li>自动扩容、缩容</li>
<li>不要去拷贝pool，也就是说最好单例</li>
</ul>
<p> Pool的合理用法是用于管理一组静静的被多个独立并发线程共享并可能重用的临时item。</p>
<h3 id="func-p-Pool-Get"><a href="#func-p-Pool-Get" class="headerlink" title="func (p *Pool) Get"></a>func (p *Pool) Get</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span></span> Get() <span class="keyword">interface</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Get方法从池中选择任意一个item，删除其在池中的引用计数，并提供给调用者。Get方法也可能选择无视内存池，将其当作空的。调用者不应认为Get的返回这和传递给Put的值之间有任何关系。</p>
<p>假使Get方法没有取得item：如p.New非nil，Get返回调用p.New的结果；否则返回nil。</p>
<h3 id="func-p-Pool-Put"><a href="#func-p-Pool-Put" class="headerlink" title="func (p *Pool) Put"></a>func (p *Pool) Put</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span></span> Put(x <span class="keyword">interface</span>&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>Put方法将x放入池中。 </p>
<h2 id="type-WaitGroup"><a href="#type-WaitGroup" class="headerlink" title="type WaitGroup"></a>type WaitGroup</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WaitGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">	noCopy noCopy</span><br><span class="line">	state1 [<span class="number">3</span>]<span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WaitGroup用于等待一组goroutine的结束。父goroutine调用Add方法来设定应等待的goroutine的数量。每个被等待的goroutine在结束时应调用Done方法。同时，主线程里可以调用Wait方法阻塞至所有线程结束。 </p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    wg.Add(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">            fmt.Println(i)</span><br><span class="line">            wg.Done()</span><br><span class="line">        &#125;(i)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>- </p>
<h3 id="func-wg-WaitGroup-Add"><a href="#func-wg-WaitGroup-Add" class="headerlink" title="func (wg *WaitGroup) Add"></a>func (wg *WaitGroup) Add</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span></span> Add(delta <span class="type">int</span>)</span><br></pre></td></tr></table></figure>

<p>Add方法向内部计数加上delta，delta可以是负数；如果内部计数器变为0，Wait方法阻塞等待的所有goroutine都会释放，如果计数器小于0，方法panic。注意Add调用应在Wait之前，否则Wait可能只会等待很少的goroutine。一般来说本方法应在创建新的goroutine或者其他应等待的事件之前调用。 </p>
<h3 id="func-wg-WaitGroup-Done"><a href="#func-wg-WaitGroup-Done" class="headerlink" title="func (wg *WaitGroup) Done"></a>func (wg *WaitGroup) Done</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span></span> Done() &#123;</span><br><span class="line">	wg.Add(<span class="number">-1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Done方法减少WaitGroup计数器的值，应在每个等待的goroutine的最后执行。 </p>
<h3 id="func-wg-WaitGroup-Wait"><a href="#func-wg-WaitGroup-Wait" class="headerlink" title="func (wg *WaitGroup) Wait"></a>func (wg *WaitGroup) Wait</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span></span> Wait()</span><br></pre></td></tr></table></figure>

<p> Wait方法阻塞直到WaitGroup计数器减为0。 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/sync/atomic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/sync/atomic/" class="post-title-link" itemprop="url">atomic</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:38:52" itemprop="dateCreated datePublished" datetime="2022-09-24T14:38:52+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/sync/" itemprop="url" rel="index"><span itemprop="name">sync</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/Golang/%E6%A0%87%E5%87%86%E5%BA%93/database/sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Golang/%E6%A0%87%E5%87%86%E5%BA%93/database/sql/" class="post-title-link" itemprop="url">sql</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:38:46" itemprop="dateCreated datePublished" datetime="2022-09-24T14:38:46+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">标准库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang/%E6%A0%87%E5%87%86%E5%BA%93/database/" itemprop="url" rel="index"><span itemprop="name">database</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h2><h3 id="ErrConnDone"><a href="#ErrConnDone" class="headerlink" title="ErrConnDone"></a>ErrConnDone</h3><p> 在已经提交或回滚的连接上执行的任何操作都会返回 ErrConnDone。 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ErrConnDone = errors.New(<span class="string">&quot;database/sql: connection is already closed&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="ErrNoRows"><a href="#ErrNoRows" class="headerlink" title="ErrNoRows"></a>ErrNoRows</h3><p> 当 QueryRow 没有返回行时，Scan 返回 ErrNoRows。在这种情况下，QueryRow 会返回一个占位符* Row 值，该值将推迟发生此错误直到扫描。 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ErrNoRows = errors.New(<span class="string">&quot;sql: no rows in result set&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="ErrTxDone"><a href="#ErrTxDone" class="headerlink" title="ErrTxDone"></a>ErrTxDone</h3><p> 对已经提交或回滚的事务执行的任何操作都会返回 ErrTxDone。 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ErrTxDone = errors.New(<span class="string">&quot;sql: Transaction has already been committed or rolled back&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="func-Drivers-string"><a href="#func-Drivers-string" class="headerlink" title="func Drivers() []string"></a>func Drivers() []string</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Drivers</span><span class="params">()</span></span> []<span class="type">string</span></span><br></pre></td></tr></table></figure>

<p> 驱动程序返回已注册驱动程序名称的排序列表。 </p>
<h2 id="func-Register-name-string-driver-driver-Driver"><a href="#func-Register-name-string-driver-driver-Driver" class="headerlink" title="func Register(name string, driver driver.Driver)"></a>func Register(name string, driver driver.Driver)</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">(name <span class="type">string</span>, driver driver.Driver)</span></span></span><br></pre></td></tr></table></figure>

<p> Register 使用提供的名称提供数据库驱动程序。如果使用相同的名称调用 Register 两次，或者驱动程序为零，则会发生混乱。 </p>
<h2 id="type-ColumnType"><a href="#type-ColumnType" class="headerlink" title="type ColumnType"></a>type ColumnType</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rs *Rows)</span></span> ColumnTypes() ([]*ColumnType, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ColumnType <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 包含过滤或未导出的字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ColumnType 包含列的名称和类型。 </p>
<h3 id="func-ColumnType-DatabaseTypeName"><a href="#func-ColumnType-DatabaseTypeName" class="headerlink" title="func (*ColumnType) DatabaseTypeName"></a>func (*ColumnType) DatabaseTypeName</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ci *ColumnType)</span></span> DatabaseTypeName() <span class="type">string</span></span><br></pre></td></tr></table></figure>

<p>DatabaseTypeName 返回列类型的数据库系统名称。如果返回空字符串，则不支持驱动程序类型名称。请查阅您的驱动程序文档以获取驱动程序数据类型列表 不包括长度说明符。常见类型包括 “VARCHAR”，“TEXT”，“NVARCHAR”，“DECIMAL”，“BOOL”，“INT”，“BIGINT”。</p>
<h3 id="func-ColumnType-DecimalSize"><a href="#func-ColumnType-DecimalSize" class="headerlink" title="func (*ColumnType) DecimalSize"></a>func (*ColumnType) DecimalSize</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ci *ColumnType)</span></span> DecimalSize() (precision, scale <span class="type">int64</span>, ok <span class="type">bool</span>)</span><br></pre></td></tr></table></figure>

<p> DecimalSize 返回小数类型的比例和精度。如果不适用或者不支持，那么ok 是错误的。 </p>
<h3 id="func-ColumnType-Length"><a href="#func-ColumnType-Length" class="headerlink" title="func (*ColumnType) Length"></a>func (*ColumnType) Length</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ci *ColumnType)</span></span> Length() (length <span class="type">int64</span>, ok <span class="type">bool</span>)</span><br></pre></td></tr></table></figure>

<p> Length 返回可变长度列类型（如文本和二进制字段类型）的列类型长度。如果类型长度没有限制，则数值为 math.MaxInt64（任何数据库限制仍将适用）。如果列类型不是可变长度，例如 int，或者如果驱动程序不支持，那么 ok 是 false。 </p>
<h3 id="func-ColumnType-Name"><a href="#func-ColumnType-Name" class="headerlink" title="func (*ColumnType) Name"></a>func (*ColumnType) Name</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (ci *<span class="title class_">ColumnType</span>) <span class="title class_">Name</span>() string</span><br></pre></td></tr></table></figure>

<p>Name 返回列的名称或别名。</p>
<h3 id="func-ColumnType-Nullable"><a href="#func-ColumnType-Nullable" class="headerlink" title="func (*ColumnType) Nullable"></a>func (*ColumnType) Nullable</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (ci *<span class="title class_">ColumnType</span>) <span class="title class_">Nullable</span>() (nullable, ok bool)</span><br></pre></td></tr></table></figure>

<p>Nullable 返回列是否可以为 null。如果一个驱动程序不支持这个属性，ok 将会是 false。</p>
<h3 id="func-ColumnType-ScanType"><a href="#func-ColumnType-ScanType" class="headerlink" title="func (*ColumnType) ScanType"></a>func (*ColumnType) ScanType</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (ci *<span class="title class_">ColumnType</span>) <span class="title class_">ScanType</span>() reflect.<span class="property">Type</span></span><br></pre></td></tr></table></figure>

<p>ScanType 使用 Rows.Scan 返回适合扫描的 Go 类型。如果驱动程序不支持此属性，ScanType 将返回空接口的类型。</p>
<h2 id="type-Conn"><a href="#type-Conn" class="headerlink" title="type Conn"></a>type Conn</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Conn(ctx context.Context) (*Conn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Conn <span class="keyword">struct</span> &#123;        </span><br><span class="line">    <span class="comment">// 包含过滤或未导出的字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Conn 代表一个数据库会话而不是一个数据库会话池。除非特别需要连续的单个数据库会话，否则首选运行 DB 查询。</strong></p>
<p>Conn 必须调用 Close 来将连接返回到数据库池，并且可以与正在运行的查询同时进行。</p>
<p>在调用 Close 之后，连接上的所有操作都会因 ErrConnDone 而失败。</p>
<h3 id="func-Conn-BeginTx"><a href="#func-Conn-BeginTx" class="headerlink" title="func (*Conn) BeginTx"></a>func (*Conn) BeginTx</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *<span class="title class_">Conn</span>) <span class="title class_">BeginTx</span>(ctx context.<span class="property">Context</span>, opts *<span class="title class_">TxOptions</span>) (*<span class="title class_">Tx</span>, error)</span><br></pre></td></tr></table></figure>

<p>BeginTx 开始一个事务。</p>
<p>提供的上下文用于事务提交或回滚之前。如果上下文被取消，sql包将回滚事务。如果提供给 BeginTx 的上下文被取消，则Tx.Commit 将返回错误。</p>
<p>提供的 TxOptions 是可选的，如果应该使用默认值，则可能为零。如果使用驱动程序不支持的非默认隔离级别，则会返回错误。</p>
<h3 id="func-Conn-Close"><a href="#func-Conn-Close" class="headerlink" title="func (*Conn) Close"></a>func (*Conn) Close</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *<span class="title class_">Conn</span>) <span class="title class_">Close</span>() error</span><br></pre></td></tr></table></figure>

<p>Close 将连接返回到连接池。Close 后的所有操作都将返回ErrConnDone。Close 是安全地与其他操作同时进行，并会阻止，直到所有其他操作完成。首先取消使用的上下文，然后直接调用 close 可能会很有用。</p>
<h3 id="func-Conn-ExecContext"><a href="#func-Conn-ExecContext" class="headerlink" title="func (*Conn) ExecContext"></a>func (*Conn) ExecContext</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *<span class="title class_">Conn</span>) <span class="title class_">ExecContext</span>(ctx context.<span class="property">Context</span>, query string, args ...interface&#123;&#125;) (<span class="title class_">Result</span>, error)</span><br></pre></td></tr></table></figure>

<p> ExecContext 执行查询而不返回任何行。这些参数用于查询中的任何占位符参数。 </p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	ctx context.Context</span><br><span class="line">	db  *sql.DB</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// A *DB is a pool of connections. Call Conn to reserve a connection for</span></span><br><span class="line">	<span class="comment">// exclusive use.</span></span><br><span class="line">	conn, err := db.Conn(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close() <span class="comment">// Return the connection to the pool.</span></span><br><span class="line">	id := <span class="number">41</span></span><br><span class="line">	result, err := conn.ExecContext(ctx, <span class="string">`UPDATE balances SET balance = balance + 10 WHERE user_id = ?;`</span>, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	rows, err := result.RowsAffected()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> rows != <span class="number">1</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;expected single row affected, got %d rows affected&quot;</span>, rows)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="func-Conn-PingContext"><a href="#func-Conn-PingContext" class="headerlink" title="func (*Conn) PingContext"></a>func (*Conn) PingContext</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *<span class="title class_">Conn</span>) <span class="title class_">PingContext</span>(ctx context.<span class="property">Context</span>) error</span><br></pre></td></tr></table></figure>

<p>PingContext 验证到数据库的连接是否仍然存在。</p>
<h3 id="func-Conn-PrepareContext"><a href="#func-Conn-PrepareContext" class="headerlink" title="func (*Conn) PrepareContext"></a>func (*Conn) PrepareContext</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *<span class="title class_">Conn</span>) <span class="title class_">PrepareContext</span>(ctx context.<span class="property">Context</span>, query string) (*<span class="title class_">Stmt</span>, error)</span><br></pre></td></tr></table></figure>

<p>PrepareContext 为以后的查询或执行创建一个准备好的语句。可以从返回的语句中同时运行多个查询或执行。当语句不再需要时，调用者必须调用语句的 Close 方法。</p>
<p>提供的上下文用于编写声明，而不用于执行声明。</p>
<h3 id="func-Conn-QueryContext"><a href="#func-Conn-QueryContext" class="headerlink" title="func (*Conn) QueryContext"></a>func (*Conn) QueryContext</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *<span class="title class_">Conn</span>) <span class="title class_">QueryContext</span>(ctx context.<span class="property">Context</span>, query string, args ...interface&#123;&#125;) (*<span class="title class_">Rows</span>, error)</span><br></pre></td></tr></table></figure>

<p>QueryContext 执行一个返回行的查询，通常是一个 SELECT。该参数适用于查询中的任何占位符参数。</p>
<h3 id="func-Conn-QueryRowContext"><a href="#func-Conn-QueryRowContext" class="headerlink" title="func (*Conn) QueryRowContext"></a>func (*Conn) QueryRowContext</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *<span class="title class_">Conn</span>) <span class="title class_">QueryRowContext</span>(ctx context.<span class="property">Context</span>, query string, args ...interface&#123;&#125;) *<span class="title class_">Row</span></span><br></pre></td></tr></table></figure>

<p>QueryRowContext 执行一个预计最多只返回一行的查询。QueryRowContext 总是返回一个非零值。错误被推迟到行的扫描方法被调用。如果查询未选择行，则*Row 的扫描将返回错误号。否则，*Row 的扫描将扫描第一个选定的行并丢弃其余行。</p>
<h4 id="func-Conn-Raw"><a href="#func-Conn-Raw" class="headerlink" title="func (*Conn) Raw"></a>func (*Conn) Raw</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (c *Conn) Raw(f func(driverConn interface&#123;&#125;) error) (err error)</span><br></pre></td></tr></table></figure>

<p>Raw executes f exposing the underlying driver connection for the duration of f. The driverConn must not be used outside of f. </p>
<p>Once f returns and err is nil, the Conn will continue to be usable until Conn.Close is called. </p>
<p>Raw执行f暴露底层驱动连接的持续时间。driverConn不能在f之外使用。一旦f返回并且err为nil, Conn将继续可用，直到Conn. close被调用。</p>
<h2 id="type-DB-★★★★★"><a href="#type-DB-★★★★★" class="headerlink" title="type DB  ★★★★★"></a>type DB  ★★★★★</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DB <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// contains filtered or unexported fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DB是一个数据库句柄，表示一个包含零个或多个底层连接的池。多个 goroutine 并发使用是安全的。</p>
<p>sql 包自动创建并释放连接；它也保持空闲连接的空闲池。如果数据库具有每个连接状态的概念，则只能在事务内可靠地观察到这种状态。一旦 DB.Begin  被调用，返回的 Tx 就绑定到单个连接。在事务上调用 Commit 或 Rollback  后，该事务的连接将返回到数据库的空闲连接池。池的大小可以通过  SetMaxIdleConns 进行控制。</p>
<h3 id="func-Open"><a href="#func-Open" class="headerlink" title="func Open"></a>func Open</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">(driverName, dataSourceName <span class="type">string</span>)</span></span> (*DB, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>Open 打开一个由其数据库驱动程序名称和驱动程序特定的数据源名称指定的数据库，通常由至少一个数据库名称和连接信息组成。</p>
<p>大多数用户将通过驱动程序特定的连接帮助程序函数打开数据库，该函数返回一个 *DB。Go标准库中不包含数据库驱动程序。有关第三方驱动程序的列表，请参阅<a target="_blank" rel="noopener" href="https://golang.org/s/sqldrivers%E3%80%82">https://golang.org/s/sqldrivers。</a></p>
<p>Open 可能只是验证其参数而不创建与数据库的连接。要验证数据源名称是否有效，请调用 Ping。</p>
<p>返回的数据库对于多个 goroutine 的并发使用是安全的，并保持其自己的空闲连接池。因此，Open 函数应该只调用一次。很少有必要关闭数据库。</p>
<h3 id="func-DB-Begin"><a href="#func-DB-Begin" class="headerlink" title="func (*DB) Begin"></a>func (*DB) Begin</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Begin() (*Tx, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> db.BeginTx(context.Background(), <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Begin 开始一个事务。默认隔离级别取决于驱动程序。 </p>
<h3 id="func-DB-BeginTx"><a href="#func-DB-BeginTx" class="headerlink" title="func (*DB) BeginTx"></a>func (*DB) BeginTx</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> BeginTx(ctx context.Context, opts *TxOptions) (*Tx, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>BeginTx 开始一个事务。</p>
<p>提供的上下文用于事务提交或回滚之前。如果上下文被取消，sql包将回滚事务。如果提供给 BeginTx 的上下文被取消，则Tx.Commit 将返回错误。</p>
<p>提供的 TxOptions 是可选的，如果应该使用默认值，则可能为零。如果使用驱动程序不支持的非默认隔离级别，则会返回错误。</p>
<h3 id="func-DB-Close"><a href="#func-DB-Close" class="headerlink" title="func (*DB) Close"></a>func (*DB) Close</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Close() <span class="type">error</span></span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-Conn"><a href="#func-db-DB-Conn" class="headerlink" title="func (db *DB) Conn"></a>func (db *DB) Conn</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Conn(ctx context.Context) (*Conn, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>返回单个连接。</p>
<h3 id="func-db-DB-Driver"><a href="#func-db-DB-Driver" class="headerlink" title="func (db *DB) Driver"></a>func (db *DB) Driver</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Driver() driver.Driver</span><br></pre></td></tr></table></figure>

<p> Driver 返回数据库的底层驱动程序。 </p>
<h3 id="func-db-DB-Exec"><a href="#func-db-DB-Exec" class="headerlink" title="func (db *DB) Exec"></a>func (db *DB) Exec</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Exec(query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) (Result, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> db.ExecContext(context.Background(), query, args...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Exec 执行写语句，不返回任何rows。该参数适用于查询中的任何占位符参数。 </p>
<h3 id="func-db-DB-ExecContext"><a href="#func-db-DB-ExecContext" class="headerlink" title="func (db *DB) ExecContext"></a>func (db *DB) ExecContext</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> ExecContext(ctx context.Context, query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) (Result, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-Ping"><a href="#func-db-DB-Ping" class="headerlink" title="func (db *DB) Ping"></a>func (db *DB) Ping</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Ping() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> db.PingContext(context.Background())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ping 验证与数据库的连接仍然存在，并在必要时建立连接。 </p>
<h3 id="func-db-DB-PingContext"><a href="#func-db-DB-PingContext" class="headerlink" title="func (db *DB) PingContext"></a>func (db *DB) PingContext</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> PingContext(ctx context.Context) <span class="type">error</span></span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-Prepare"><a href="#func-db-DB-Prepare" class="headerlink" title="func (db *DB) Prepare"></a>func (db *DB) Prepare</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Prepare(query <span class="type">string</span>) (*Stmt, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> db.PrepareContext(context.Background(), query)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Prepare</code> 方法实现<strong>预处理</strong>操作：先将sql语句发送给MySQL服务端，返回一个准备好的状态用于之后的查询和命令。返回值可以同时执行多个查询和命令。 </p>
<p>读操作 预处理示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理查询示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareQueryDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sqlStr := <span class="string">&quot;select id, name, age from user where id &gt; ?&quot;</span></span><br><span class="line">	stmt, err := db.Prepare(sqlStr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;prepare failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> stmt.Close()</span><br><span class="line">	rows, err := stmt.Query(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;query failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> rows.Close()</span><br><span class="line">	<span class="comment">// 循环读取结果集中的数据</span></span><br><span class="line">	<span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">		<span class="keyword">var</span> u user</span><br><span class="line">		err := rows.Scan(&amp;u.id, &amp;u.name, &amp;u.age)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;scan failed, err:%v\n&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;id:%d name:%s age:%d\n&quot;</span>, u.id, u.name, u.age)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写操作 预处理也时分类似，示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理插入示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareInsertDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sqlStr := <span class="string">&quot;insert into user(name, age) values (?,?)&quot;</span></span><br><span class="line">	stmt, err := db.Prepare(sqlStr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;prepare failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> stmt.Close()</span><br><span class="line">	_, err = stmt.Exec(<span class="string">&quot;小王子&quot;</span>, <span class="number">18</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;insert failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	_, err = stmt.Exec(<span class="string">&quot;沙河娜扎&quot;</span>, <span class="number">18</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;insert failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;insert success.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-PrepareContext"><a href="#func-db-DB-PrepareContext" class="headerlink" title="func (db *DB) PrepareContext"></a>func (db *DB) PrepareContext</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> PrepareContext(ctx context.Context, query <span class="type">string</span>) (*Stmt, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-Query"><a href="#func-db-DB-Query" class="headerlink" title="func (db *DB) Query"></a>func (db *DB) Query</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Query(query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) (*Rows, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> db.QueryContext(context.Background(), query, args...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>多行查询</strong>：执行一次查询，返回多行结果（即Rows），一般用于执行select命令。参数args表示query中的占位参数。 </p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询多条数据示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryMultiRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sqlStr := <span class="string">&quot;select id, name, age from user where id &gt; ?&quot;</span></span><br><span class="line">	rows, err := db.Query(sqlStr, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;query failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 非常重要：关闭rows释放持有的数据库链接</span></span><br><span class="line">	<span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 循环读取结果集中的数据</span></span><br><span class="line">	<span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">		<span class="keyword">var</span> u user</span><br><span class="line">		err := rows.Scan(&amp;u.id, &amp;u.name, &amp;u.age)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;scan failed, err:%v\n&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;id:%d name:%s age:%d\n&quot;</span>, u.id, u.name, u.age)</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-QueryContext"><a href="#func-db-DB-QueryContext" class="headerlink" title="func (db *DB) QueryContext"></a>func (db *DB) QueryContext</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> QueryContext(ctx context.Context, query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) (*Rows, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-QueryRow"><a href="#func-db-DB-QueryRow" class="headerlink" title="func (db *DB) QueryRow"></a>func (db *DB) QueryRow</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> QueryRowContext(ctx context.Context, query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) *Row &#123;</span><br><span class="line">	rows, err := db.QueryContext(ctx, query, args...)</span><br><span class="line">	<span class="keyword">return</span> &amp;Row&#123;rows: rows, err: err&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>单行查询</strong>：执行一次查询，并期望返回最多一行结果（即Row）。QueryRow总是返回非nil的值，直到返回值的Scan方法被调用时，才会返回被延迟的错误。（如：未找到结果） </p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询单条数据示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">queryRowDemo</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sqlStr := <span class="string">&quot;select id, name, age from user where id=?&quot;</span></span><br><span class="line">	<span class="keyword">var</span> u user</span><br><span class="line">	<span class="comment">// 非常重要：确保QueryRow之后调用Scan方法，否则持有的数据库链接不会被释放</span></span><br><span class="line">	err := db.QueryRow(sqlStr, <span class="number">1</span>).Scan(&amp;u.id, &amp;u.name, &amp;u.age)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;scan failed, err:%v\n&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;id:%d name:%s age:%d\n&quot;</span>, u.id, u.name, u.age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-QueryRowContext"><a href="#func-db-DB-QueryRowContext" class="headerlink" title="func (db *DB) QueryRowContext"></a>func (db *DB) QueryRowContext</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> QueryRowContext(ctx context.Context, query <span class="type">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) *Row</span><br></pre></td></tr></table></figure>

<h3 id="func-db-DB-SetConnMaxIdleTime"><a href="#func-db-DB-SetConnMaxIdleTime" class="headerlink" title="func (db *DB) SetConnMaxIdleTime"></a>func (db *DB) SetConnMaxIdleTime</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SetConnMaxIdleTime(d time.Duration)</span><br></pre></td></tr></table></figure>

<p>设置连接空闲的最大时间。过期的连接在复用之前可能会被延迟关闭。如果d &lt;&#x3D; 0，则连接不会因为空闲时间而关闭。</p>
<h3 id="func-db-DB-SetConnMaxLifetime"><a href="#func-db-DB-SetConnMaxLifetime" class="headerlink" title="func (db *DB) SetConnMaxLifetime"></a>func (db *DB) SetConnMaxLifetime</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SetConnMaxLifetime(d time.Duration)</span><br></pre></td></tr></table></figure>

<p>设置连接的存活时间。过期的连接在复用之前可能会被延迟关闭。如果d &lt;&#x3D; 0，则连接不会因为连接的年龄而关闭。</p>
<h3 id="func-db-DB-SetMaxIdleConns"><a href="#func-db-DB-SetMaxIdleConns" class="headerlink" title="func (db *DB) SetMaxIdleConns"></a>func (db *DB) SetMaxIdleConns</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SetMaxIdleConns(n <span class="type">int</span>)</span><br></pre></td></tr></table></figure>

<p>设置空闲连接池中的最大连接数。如果MaxOpenConns大于0但小于新的MaxIdleConns，那么新的MaxIdleConns将被减少以匹配MaxOpenConns限制。</p>
<p>如果n &lt;&#x3D; 0，则不保留空闲连接。</p>
<p>缺省的最大空闲连接数是2。这可能会在未来的版本中改变。</p>
<h3 id="func-db-DB-SetMaxOpenConns"><a href="#func-db-DB-SetMaxOpenConns" class="headerlink" title="func (db *DB) SetMaxOpenConns"></a>func (db *DB) SetMaxOpenConns</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> SetMaxOpenConns(n <span class="type">int</span>)</span><br></pre></td></tr></table></figure>

<p>设置到数据库的最大打开连接数。</p>
<p>如果MaxIdleConns大于0并且新的MaxOpenConns小于MaxIdleConns，那么MaxIdleConns将被减少以匹配新的MaxOpenConns限制。</p>
<p>如果n &lt;&#x3D; 0，则没有打开连接的数量限制。默认值是0(无限)。</p>
<h3 id="func-db-DB-Stats-DBStats"><a href="#func-db-DB-Stats-DBStats" class="headerlink" title="func (db *DB) Stats() DBStats"></a>func (db *DB) Stats() DBStats</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Stats() DBStats</span><br></pre></td></tr></table></figure>

<p> Stats 返回数据库统计信息 </p>
<h2 id="关于-Conn-和-DB"><a href="#关于-Conn-和-DB" class="headerlink" title="关于 Conn 和 DB"></a>关于 Conn 和 DB</h2><p>Conn是一个连接，而DB是一个连接池，一般情况下使用DB就行，例如 <code>db.Begin()</code> ，查看源码实现可知：等同于 <code>conn.BeginTx(Context.Background(), nil)</code> ，后者需要手动调用<code>conn.Close()</code>，前者会自动调用<code>conn.Close()</code>。</p>
<h2 id="type-DBStats"><a href="#type-DBStats" class="headerlink" title="type DBStats"></a>type DBStats</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Stats() DBStats</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DBStats <span class="keyword">struct</span> &#123;</span><br><span class="line">	MaxOpenConnections <span class="type">int</span> <span class="comment">// Maximum number of open connections to the database.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pool Status</span></span><br><span class="line">	OpenConnections <span class="type">int</span> <span class="comment">// The number of established connections both in use and idle.</span></span><br><span class="line">	InUse           <span class="type">int</span> <span class="comment">// The number of connections currently in use.</span></span><br><span class="line">	Idle            <span class="type">int</span> <span class="comment">// The number of idle connections.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Counters</span></span><br><span class="line">	WaitCount         <span class="type">int64</span>         <span class="comment">// The total number of connections waited for.</span></span><br><span class="line">	WaitDuration      time.Duration <span class="comment">// The total time blocked waiting for a new connection.</span></span><br><span class="line">	MaxIdleClosed     <span class="type">int64</span>         <span class="comment">// The total number of connections closed due to SetMaxIdleConns.</span></span><br><span class="line">	MaxIdleTimeClosed <span class="type">int64</span>         <span class="comment">// The total number of connections closed due to SetConnMaxIdleTime.</span></span><br><span class="line">	MaxLifetimeClosed <span class="type">int64</span>         <span class="comment">// The total number of connections closed due to SetConnMaxLifetime.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> DBStats 包含数据库统计信息。 </p>
<h2 id="type-IsolationLevel"><a href="#type-IsolationLevel" class="headerlink" title="type IsolationLevel"></a>type IsolationLevel</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> IsolationLevel <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	LevelDefault IsolationLevel = <span class="literal">iota</span></span><br><span class="line">	LevelReadUncommitted</span><br><span class="line">	LevelReadCommitted</span><br><span class="line">	LevelWriteCommitted</span><br><span class="line">	LevelRepeatableRead</span><br><span class="line">	LevelSnapshot</span><br><span class="line">	LevelSerializable</span><br><span class="line">	LevelLinearizable</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p> IsolationLevel 是 TxOptions 中使用的事务隔离级别。 </p>
<p> BeginTx 中驱动程序可能支持的各种隔离级别。如果驱动程序不支持给定的隔离级别，则可能会返回错误。 </p>
<p> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Isolation_levels">https://en.wikipedia.org/wiki/Isolation_(database_systems)#Isolation_levels</a>.  </p>
<h3 id="func-i-IsolationLevel-String-string"><a href="#func-i-IsolationLevel-String-string" class="headerlink" title="func (i IsolationLevel) String() string"></a>func (i IsolationLevel) String() string</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i IsolationLevel)</span></span> String() <span class="type">string</span></span><br></pre></td></tr></table></figure>

<p>返回事务隔离级别的名称。 </p>
<h2 id="type-NamedArg"><a href="#type-NamedArg" class="headerlink" title="type NamedArg"></a>type NamedArg</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NamedArg <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NamedArg 是一个命名参数。NamedArg 值可以用作 Query 或Exec 的参数，并绑定到 SQL 语句中的相应命名参数。 </p>
<h3 id="func-Named"><a href="#func-Named" class="headerlink" title="func Named"></a>func Named</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Named</span><span class="params">(name <span class="type">string</span>, value <span class="keyword">interface</span>&#123;&#125;)</span></span> NamedArg</span><br></pre></td></tr></table></figure>

<p>Named 提供了一种更简洁的方式来创建 NamedArg 值。 </p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.ExecContext(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">    delete from Invoice</span></span><br><span class="line"><span class="string">    where</span></span><br><span class="line"><span class="string">        TimeCreated &lt; @end</span></span><br><span class="line"><span class="string">        and TimeCreated &gt;= @start;`</span>,</span><br><span class="line">    sql.Named(<span class="string">&quot;start&quot;</span>, startTime),</span><br><span class="line">    sql.Named(<span class="string">&quot;end&quot;</span>, endTime),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="type-NullBool"><a href="#type-NullBool" class="headerlink" title="type NullBool"></a>type NullBool</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NullBool <span class="keyword">struct</span> &#123;</span><br><span class="line">	Bool  <span class="type">bool</span></span><br><span class="line">	Valid <span class="type">bool</span> <span class="comment">// Valid is true if Bool is not NULL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="func-n-NullBool-Scan-value-interface-error"><a href="#func-n-NullBool-Scan-value-interface-error" class="headerlink" title="func (n *NullBool) Scan(value interface{}) error"></a>func (n *NullBool) Scan(value interface{}) error</h3><h3 id="func-n-NullBool-Value-driver-Value-error"><a href="#func-n-NullBool-Value-driver-Value-error" class="headerlink" title="func (n NullBool) Value() (driver.Value, error)"></a>func (n NullBool) Value() (driver.Value, error)</h3><h2 id="type-NullByte"><a href="#type-NullByte" class="headerlink" title="type NullByte"></a>type NullByte</h2><h3 id="func-n-NullByte-Scan-value-interface-error"><a href="#func-n-NullByte-Scan-value-interface-error" class="headerlink" title="func (n *NullByte) Scan(value interface{}) error"></a>func (n *NullByte) Scan(value interface{}) error</h3><h3 id="func-n-NullByte-Value-driver-Value-error"><a href="#func-n-NullByte-Value-driver-Value-error" class="headerlink" title="func (n NullByte) Value() (driver.Value, error)"></a>func (n NullByte) Value() (driver.Value, error)</h3><h2 id="type-NullFloat64"><a href="#type-NullFloat64" class="headerlink" title="type NullFloat64"></a>type NullFloat64</h2><h3 id="func-n-NullFloat64-Scan-value-interface-error"><a href="#func-n-NullFloat64-Scan-value-interface-error" class="headerlink" title="func (n *NullFloat64) Scan(value interface{}) error"></a>func (n *NullFloat64) Scan(value interface{}) error</h3><h3 id="func-n-NullFloat64-Value-driver-Value-error"><a href="#func-n-NullFloat64-Value-driver-Value-error" class="headerlink" title="func (n NullFloat64) Value() (driver.Value, error)"></a>func (n NullFloat64) Value() (driver.Value, error)</h3><h2 id="type-NullInt16"><a href="#type-NullInt16" class="headerlink" title="type NullInt16"></a>type NullInt16</h2><h3 id="func-n-NullInt16-Scan-value-interface-error"><a href="#func-n-NullInt16-Scan-value-interface-error" class="headerlink" title="func (n *NullInt16) Scan(value interface{}) error"></a>func (n *NullInt16) Scan(value interface{}) error</h3><h3 id="func-n-NullInt16-Value-driver-Value-error"><a href="#func-n-NullInt16-Value-driver-Value-error" class="headerlink" title="func (n NullInt16) Value() (driver.Value, error)"></a>func (n NullInt16) Value() (driver.Value, error)</h3><h2 id="type-NullInt32"><a href="#type-NullInt32" class="headerlink" title="type NullInt32"></a>type NullInt32</h2><h3 id="func-n-NullInt32-Scan-value-interface-error"><a href="#func-n-NullInt32-Scan-value-interface-error" class="headerlink" title="func (n *NullInt32) Scan(value interface{}) error"></a>func (n *NullInt32) Scan(value interface{}) error</h3><h3 id="func-n-NullInt32-Value-driver-Value-error"><a href="#func-n-NullInt32-Value-driver-Value-error" class="headerlink" title="func (n NullInt32) Value() (driver.Value, error)"></a>func (n NullInt32) Value() (driver.Value, error)</h3><h2 id="type-NullInt64"><a href="#type-NullInt64" class="headerlink" title="type NullInt64"></a>type NullInt64</h2><h3 id="func-n-NullInt64-Scan-value-interface-error"><a href="#func-n-NullInt64-Scan-value-interface-error" class="headerlink" title="func (n *NullInt64) Scan(value interface{}) error"></a>func (n *NullInt64) Scan(value interface{}) error</h3><h3 id="func-n-NullInt64-Value-driver-Value-error"><a href="#func-n-NullInt64-Value-driver-Value-error" class="headerlink" title="func (n NullInt64) Value() (driver.Value, error)"></a>func (n NullInt64) Value() (driver.Value, error)</h3><h2 id="type-NullString"><a href="#type-NullString" class="headerlink" title="type NullString"></a>type NullString</h2><h3 id="func-ns-NullString-Scan-value-interface-error"><a href="#func-ns-NullString-Scan-value-interface-error" class="headerlink" title="func (ns *NullString) Scan(value interface{}) error"></a>func (ns *NullString) Scan(value interface{}) error</h3><h3 id="func-ns-NullString-Value-driver-Value-error"><a href="#func-ns-NullString-Value-driver-Value-error" class="headerlink" title="func (ns NullString) Value() (driver.Value, error)"></a>func (ns NullString) Value() (driver.Value, error)</h3><h2 id="type-NullTime"><a href="#type-NullTime" class="headerlink" title="type NullTime"></a>type NullTime</h2><h3 id="func-n-NullTime-Scan-value-interface-error"><a href="#func-n-NullTime-Scan-value-interface-error" class="headerlink" title="func (n *NullTime) Scan(value interface{}) error"></a>func (n *NullTime) Scan(value interface{}) error</h3><h3 id="func-n-NullTime-Value-driver-Value-error"><a href="#func-n-NullTime-Value-driver-Value-error" class="headerlink" title="func (n NullTime) Value() (driver.Value, error)"></a>func (n NullTime) Value() (driver.Value, error)</h3><h2 id="type-Out"><a href="#type-Out" class="headerlink" title="type Out"></a>type Out</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Out <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Dest is a pointer to the value that will be set to the result of the</span></span><br><span class="line">	<span class="comment">// stored procedure&#x27;s OUTPUT parameter.</span></span><br><span class="line">	Dest <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// In is whether the parameter is an INOUT parameter. If so, the input value to the stored</span></span><br><span class="line">	<span class="comment">// procedure is the dereferenced value of Dest&#x27;s pointer, which is then replaced with</span></span><br><span class="line">	<span class="comment">// the output value.</span></span><br><span class="line">	In <span class="type">bool</span></span><br><span class="line">	<span class="comment">// contains filtered or unexported fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Out 可用于从存储过程中检索 OUTPUT 值参数。</p>
<p>并非所有驱动程序和数据库都支持 OUTPUT 值参数。</p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> outArg <span class="type">string</span></span><br><span class="line">_, err := db.ExecContext(ctx, <span class="string">&quot;ProcName&quot;</span>, sql.Named(<span class="string">&quot;Arg1&quot;</span>, sql.Out&#123;Dest: &amp;outArg&#125;))</span><br></pre></td></tr></table></figure>

<h2 id="type-RawBytes"><a href="#type-RawBytes" class="headerlink" title="type RawBytes"></a>type RawBytes</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RawBytes []<span class="type">byte</span></span><br></pre></td></tr></table></figure>

<p>RawBytes 保存对数据库本身拥有的内存的引用。在扫描到RawBytes后，该切片只有在下一次调用next、Scan或Close时才有效。 </p>
<h2 id="type-Result"><a href="#type-Result" class="headerlink" title="type Result"></a>type Result</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Result <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// LastInsertId returns the integer generated by the database</span></span><br><span class="line">	<span class="comment">// in response to a command. Typically this will be from an</span></span><br><span class="line">	<span class="comment">// &quot;auto increment&quot; column when inserting a new row. Not all</span></span><br><span class="line">	<span class="comment">// databases support this feature, and the syntax of such</span></span><br><span class="line">	<span class="comment">// statements varies.</span></span><br><span class="line">	LastInsertId() (<span class="type">int64</span>, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// RowsAffected returns the number of rows affected by an</span></span><br><span class="line">	<span class="comment">// update, insert, or delete. Not every database or database</span></span><br><span class="line">	<span class="comment">// driver may support this.</span></span><br><span class="line">	RowsAffected() (<span class="type">int64</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Result  汇总了已执行的SQL语句。</p>
<h2 id="type-Row"><a href="#type-Row" class="headerlink" title="type Row"></a>type Row</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Row <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// One of these two will be non-nil:</span></span><br><span class="line">	err  <span class="type">error</span> <span class="comment">// deferred error for easy chaining</span></span><br><span class="line">	rows *Rows</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单行查询<code>db.QueryRow()</code>执行一次查询，并期望返回最多一行结果（即Row）。QueryRow总是返回非nil的值，直到返回值的Scan方法被调用时，才会返回被延迟的错误。（如：未找到结果） </p>
<h3 id="func-r-Row-Err-error"><a href="#func-r-Row-Err-error" class="headerlink" title="func (r *Row) Err() error"></a>func (r *Row) Err() error</h3><h3 id="func-r-Row-Scan-dest-…interface-error"><a href="#func-r-Row-Scan-dest-…interface-error" class="headerlink" title="func (r *Row) Scan(dest …interface{}) error"></a>func (r *Row) Scan(dest …interface{}) error</h3><h2 id="type-Rows"><a href="#type-Rows" class="headerlink" title="type Rows"></a>type Rows</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Rows <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 包含过滤或未导出的字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多行查询<code>db.Query()</code>执行一次查询，返回多行结果（即Rows），一般用于执行select命令。参数args表示query中的占位参数。 </p>
<p>Rows is the result of a query. It’s cursor starts before the first row of the result set. Use Next to advance from row to row.  </p>
<h3 id="func-rs-Rows-Close-error"><a href="#func-rs-Rows-Close-error" class="headerlink" title="func (rs *Rows) Close() error"></a>func (rs *Rows) Close() error</h3><h3 id="func-rs-Rows-ColumnTypes-ColumnType-error"><a href="#func-rs-Rows-ColumnTypes-ColumnType-error" class="headerlink" title="func (rs *Rows) ColumnTypes() ([]*ColumnType, error)"></a>func (rs *Rows) ColumnTypes() ([]*ColumnType, error)</h3><h3 id="func-rs-Rows-Columns-string-error"><a href="#func-rs-Rows-Columns-string-error" class="headerlink" title="func (rs *Rows) Columns() ([]string, error)"></a>func (rs *Rows) Columns() ([]string, error)</h3><h3 id="func-rs-Rows-Err-error"><a href="#func-rs-Rows-Err-error" class="headerlink" title="func (rs *Rows) Err() error"></a>func (rs *Rows) Err() error</h3><h3 id="func-rs-Rows-Next-bool"><a href="#func-rs-Rows-Next-bool" class="headerlink" title="func (rs *Rows) Next() bool"></a>func (rs *Rows) Next() bool</h3><h3 id="func-rs-Rows-NextResultSet-bool"><a href="#func-rs-Rows-NextResultSet-bool" class="headerlink" title="func (rs *Rows) NextResultSet() bool"></a>func (rs *Rows) NextResultSet() bool</h3><h3 id="func-rs-Rows-Scan-dest-…interface-error"><a href="#func-rs-Rows-Scan-dest-…interface-error" class="headerlink" title="func (rs *Rows) Scan(dest …interface{}) error"></a>func (rs *Rows) Scan(dest …interface{}) error</h3><h2 id="type-Scanner"><a href="#type-Scanner" class="headerlink" title="type Scanner"></a>type Scanner</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Scanner <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Scan方法从数据库驱动获取一个值。</span></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="comment">// 参数src的类型保证为如下类型之一：</span></span><br><span class="line">    <span class="comment">//    int64</span></span><br><span class="line">    <span class="comment">//    float64</span></span><br><span class="line">    <span class="comment">//    bool</span></span><br><span class="line">    <span class="comment">//    []byte</span></span><br><span class="line">    <span class="comment">//    string</span></span><br><span class="line">    <span class="comment">//    time.Time</span></span><br><span class="line">    <span class="comment">//    nil - 表示NULL值</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 如果不能不丢失信息的保存一个值，应返回错误。</span></span><br><span class="line">	Scan(src <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Scanner接口会被Rows或Row等的Scan方法使用。</p>
<p>任何实现了Scanner接口的类型，都可以通过定义自己的Scan函数来处理空值问题，比如：</p>
<ul>
<li>Rows或Row的Scan方法其实就是实现从数据库驱动中获取一个值(该值会转换成src的类型)，并将其存储到src，src满足driver.Value类型</li>
<li>而NullString、NullBool等的Scan方法则是将输入的值转换成对应的NullString、NullBool类型并存储下来</li>
</ul>
<h2 id="type-Stmt-★★★"><a href="#type-Stmt-★★★" class="headerlink" title="type Stmt ★★★"></a>type Stmt ★★★</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stmt <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// contains filtered or unexported fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>stmt &#x3D; statement，声明，Stmt是一个准备好的声明。Stmt 对于多个 goroutines 并发使用是安全的。 </p>
<h3 id="func-s-Stmt-Close-error"><a href="#func-s-Stmt-Close-error" class="headerlink" title="func (s *Stmt) Close() error"></a>func (s *Stmt) Close() error</h3><h3 id="func-s-Stmt-Exec-args-…interface-Result-error"><a href="#func-s-Stmt-Exec-args-…interface-Result-error" class="headerlink" title="func (s *Stmt) Exec(args …interface{}) (Result, error)"></a>func (s *Stmt) Exec(args …interface{}) (Result, error)</h3><h3 id="func-s-Stmt-ExecContext-ctx-context-Context-args-…interface-Result-error"><a href="#func-s-Stmt-ExecContext-ctx-context-Context-args-…interface-Result-error" class="headerlink" title="func (s *Stmt) ExecContext(ctx context.Context, args …interface{}) (Result, error)"></a>func (s *Stmt) ExecContext(ctx context.Context, args …interface{}) (Result, error)</h3><h3 id="func-s-Stmt-Query-args-…interface-Rows-error"><a href="#func-s-Stmt-Query-args-…interface-Rows-error" class="headerlink" title="func (s *Stmt) Query(args …interface{}) (*Rows, error)"></a>func (s *Stmt) Query(args …interface{}) (*Rows, error)</h3><h3 id="func-s-Stmt-QueryContext-ctx-context-Context-args-…interface-Rows-error"><a href="#func-s-Stmt-QueryContext-ctx-context-Context-args-…interface-Rows-error" class="headerlink" title="func (s *Stmt) QueryContext(ctx context.Context, args …interface{}) (*Rows, error)"></a>func (s *Stmt) QueryContext(ctx context.Context, args …interface{}) (*Rows, error)</h3><h3 id="func-s-Stmt-QueryRow-args-…interface-Row"><a href="#func-s-Stmt-QueryRow-args-…interface-Row" class="headerlink" title="func (s *Stmt) QueryRow(args …interface{}) *Row"></a>func (s *Stmt) QueryRow(args …interface{}) *Row</h3><h3 id="func-s-Stmt-QueryRowContext-ctx-context-Context-args-…interface-Row"><a href="#func-s-Stmt-QueryRowContext-ctx-context-Context-args-…interface-Row" class="headerlink" title="func (s *Stmt) QueryRowContext(ctx context.Context, args …interface{}) *Row"></a>func (s *Stmt) QueryRowContext(ctx context.Context, args …interface{}) *Row</h3><h2 id="type-Tx-★★★★★"><a href="#type-Tx-★★★★★" class="headerlink" title="type Tx ★★★★★"></a>type Tx ★★★★★</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Tx <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// contains filtered or unexported fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tx 是正在进行的数据库事务。</p>
<p>Transaction 必须以对 Commit 或 Rollback 的调用结束。</p>
<p>在调用 Commit 或 Rollback 之后，事务上的所有操作都会因ErrTxDone而失败。</p>
<h3 id="func-tx-Tx-Commit-error"><a href="#func-tx-Tx-Commit-error" class="headerlink" title="func (tx *Tx) Commit() error"></a>func (tx *Tx) Commit() error</h3><h3 id="func-tx-Tx-Exec-query-string-args-…interface-Result-error"><a href="#func-tx-Tx-Exec-query-string-args-…interface-Result-error" class="headerlink" title="func (tx *Tx) Exec(query string, args …interface{}) (Result, error)"></a>func (tx *Tx) Exec(query string, args …interface{}) (Result, error)</h3><h3 id="func-tx-Tx-ExecContext-ctx-context-Context-query-string-args-…interface-Result-error"><a href="#func-tx-Tx-ExecContext-ctx-context-Context-query-string-args-…interface-Result-error" class="headerlink" title="func (tx *Tx) ExecContext(ctx context.Context, query string, args …interface{}) (Result, error)"></a>func (tx *Tx) ExecContext(ctx context.Context, query string, args …interface{}) (Result, error)</h3><h3 id="func-tx-Tx-Prepare-query-string-Stmt-error"><a href="#func-tx-Tx-Prepare-query-string-Stmt-error" class="headerlink" title="func (tx *Tx) Prepare(query string) (*Stmt, error)"></a>func (tx *Tx) Prepare(query string) (*Stmt, error)</h3><h3 id="func-tx-Tx-PrepareContext-ctx-context-Context-query-string-Stmt-error"><a href="#func-tx-Tx-PrepareContext-ctx-context-Context-query-string-Stmt-error" class="headerlink" title="func (tx *Tx) PrepareContext(ctx context.Context, query string) (*Stmt, error)"></a>func (tx *Tx) PrepareContext(ctx context.Context, query string) (*Stmt, error)</h3><h3 id="func-tx-Tx-Query-query-string-args-…interface-Rows-error"><a href="#func-tx-Tx-Query-query-string-args-…interface-Rows-error" class="headerlink" title="func (tx *Tx) Query(query string, args …interface{}) (*Rows, error)"></a>func (tx *Tx) Query(query string, args …interface{}) (*Rows, error)</h3><h3 id="func-tx-Tx-QueryContext-ctx-context-Context-query-string-args-…interface-Rows-error"><a href="#func-tx-Tx-QueryContext-ctx-context-Context-query-string-args-…interface-Rows-error" class="headerlink" title="func (tx *Tx) QueryContext(ctx context.Context, query string, args …interface{}) (*Rows, error)"></a>func (tx *Tx) QueryContext(ctx context.Context, query string, args …interface{}) (*Rows, error)</h3><h3 id="func-tx-Tx-QueryRow-query-string-args-…interface-Row"><a href="#func-tx-Tx-QueryRow-query-string-args-…interface-Row" class="headerlink" title="func (tx *Tx) QueryRow(query string, args …interface{}) *Row"></a>func (tx *Tx) QueryRow(query string, args …interface{}) *Row</h3><h3 id="func-tx-Tx-QueryRowContext-ctx-context-Context-query-string-args-…interface-Row"><a href="#func-tx-Tx-QueryRowContext-ctx-context-Context-query-string-args-…interface-Row" class="headerlink" title="func (tx *Tx) QueryRowContext(ctx context.Context, query string, args …interface{}) *Row"></a>func (tx *Tx) QueryRowContext(ctx context.Context, query string, args …interface{}) *Row</h3><h3 id="func-tx-Tx-Rollback-error"><a href="#func-tx-Tx-Rollback-error" class="headerlink" title="func (tx *Tx) Rollback() error"></a>func (tx *Tx) Rollback() error</h3><h3 id="func-tx-Tx-Stmt-stmt-Stmt-Stmt"><a href="#func-tx-Tx-Stmt-stmt-Stmt-Stmt" class="headerlink" title="func (tx *Tx) Stmt(stmt *Stmt) *Stmt"></a>func (tx *Tx) Stmt(stmt *Stmt) *Stmt</h3><h3 id="func-tx-Tx-StmtContext-ctx-context-Context-stmt-Stmt-Stmt"><a href="#func-tx-Tx-StmtContext-ctx-context-Context-stmt-Stmt-Stmt" class="headerlink" title="func (tx *Tx) StmtContext(ctx context.Context, stmt *Stmt) *Stmt"></a>func (tx *Tx) StmtContext(ctx context.Context, stmt *Stmt) *Stmt</h3><h2 id="type-TxOptions"><a href="#type-TxOptions" class="headerlink" title="type TxOptions"></a>type TxOptions</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TxOptions <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Isolation is the transaction isolation level.</span></span><br><span class="line">	<span class="comment">// If zero, the driver or database&#x27;s default level is used.</span></span><br><span class="line">	Isolation IsolationLevel</span><br><span class="line">	ReadOnly  <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> TxOptions保存要在DB.BeginTx中使用的事务选项。 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%89%8D%E7%AB%AF/React/git%20commit%E8%A7%84%E8%8C%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%89%8D%E7%AB%AF/React/git%20commit%E8%A7%84%E8%8C%83/" class="post-title-link" itemprop="url">git commit规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:35:57" itemprop="dateCreated datePublished" datetime="2022-09-24T14:35:57+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Angular-js-项目所使用的git-commit规范"><a href="#Angular-js-项目所使用的git-commit规范" class="headerlink" title="Angular.js 项目所使用的git commit规范"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/343739047">Angular.js 项目所使用的git commit规范</a></h2><p>每次提交，Commit message 都包括三个部分：Header，Body 和 Footer。其中，Header 是必需的，Body 和 Footer 可以省略</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header部分只有一行，包括三个字段：type（必需）、scope（可选）和subject（必需）</p>
<h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><ul>
<li>build：编译相关的修改，例如发布版本、对项目构建或者依赖的改动</li>
<li>chore：其他修改, 比如改变构建流程、或者增加依赖库、工具等</li>
<li>ci：持续集成修改</li>
<li>docs：文档修改</li>
<li>feat：新特性、新功能 feature</li>
<li>fix：修补bug</li>
<li>perf：优化相关，比如提升性能、体验</li>
<li>refactor：代码重构</li>
<li>revert：当前commit用于撤销以前的commit</li>
<li>style：代码格式修改，注意不是 css 修改</li>
<li>test：测试用例修改</li>
</ul>
<h4 id="scope"><a href="#scope" class="headerlink" title="[scope]"></a>[scope]</h4><p>scope用于说明 commit 影响的范围，比如数据层、控制层、视图层等等，视项目不同而不同。</p>
<p>例如在<code>Angular</code>，可以是<code>$location</code>, <code>$browser</code>, <code>$compile</code>, <code>$rootScope</code>, <code>ngHref</code>, <code>ngClick</code>, <code>ngView</code>等。</p>
<p>如果你的修改影响了不止一个<code>scope</code>，你可以使用<code>*</code>代替。</p>
<h4 id="subject"><a href="#subject" class="headerlink" title="subject"></a>subject</h4><p><code>subject</code>是 commit 目的的简短描述，不超过50个字符。</p>
<p>其他注意事项：</p>
<ul>
<li>以动词开头，使用第一人称现在时，比如change，而不是changed或changes</li>
<li>第一个字母小写</li>
<li>结尾不加句号（.）</li>
</ul>
<h3 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h3><p>Body 部分是对本次 commit 的详细描述，可以分成多行。下面是一个范例。</p>
<blockquote>
<p>More detailed explanatory text, if necessary. Wrap it to about 72 characters or so. Further paragraphs come after blank lines. - Bullet points are okay, too - Use a hanging indent</p>
</blockquote>
<p>注意点:</p>
<ul>
<li>使用第一人称现在时，比如使用change而不是changed或changes。</li>
<li>永远别忘了第2行是空行</li>
<li>应该说明代码变动的动机，以及与以前行为的对比。</li>
</ul>
<h3 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h3><p>Footer 部分只用于以下两种情况：</p>
<h4 id="不兼容变动"><a href="#不兼容变动" class="headerlink" title="不兼容变动"></a>不兼容变动</h4><p>如果当前代码与上一个版本不兼容，则 Footer 部分以BREAKING CHANGE开头，后面是对变动的描述、以及变动理由和迁移方法。</p>
<blockquote>
<p>BREAKING CHANGE: isolate scope bindings definition has changed. To migrate the code follow the example below: Before: scope: { myAttr: ‘attribute’, } After: scope: { myAttr: ‘@’, } The removed <code>inject</code> wasn’t generaly useful for directives so there should be no code using it.</p>
</blockquote>
<h4 id="关闭-Issue"><a href="#关闭-Issue" class="headerlink" title="关闭 Issue"></a>关闭 Issue</h4><p>如果当前 commit 针对某个issue，那么可以在 Footer 部分关闭这个 issue 。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Closes #234</span><br></pre></td></tr></table></figure>

<h2 id="revert"><a href="#revert" class="headerlink" title="revert"></a>revert</h2><p>如果当前 commit 用于撤销以前的 commit，则必须以revert:开头，后面跟着被撤销 Commit 的 Header。</p>
<blockquote>
<p>revert: feat(pencil): add ‘graphiteWidth’ option </p>
<p>This reverts commit 667ecc1654a317a13331b17617d973392f415f02.</p>
</blockquote>
<p>Body部分的格式是固定的，必须写成<code>This reverts commit &lt;hash&gt;</code>.，其中的hash是被撤销 commit 的 SHA 标识符。</p>
<p>如果当前 commit 与被撤销的 commit，在同一个发布（release）里面，那么它们都不会出现在 Change log 里面。如果两者在不同的发布，那么当前 commit，会出现在 Change log 的Reverts小标题下面。</p>
<h2 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h2><p>例如一个新功能，添加登陆模块 git commit 中的信息可以这样写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feat[login] add login module</span><br></pre></td></tr></table></figure>

<p>其中feat为提交类型type，login为域scope，“<code>add login module</code>”为 commit 目的的简短描述</p>
<h2 id="git-cz工具"><a href="#git-cz工具" class="headerlink" title="git cz工具"></a>git cz工具</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局安装</span></span><br><span class="line">yarn global add commitizen</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入项目</span></span><br><span class="line">commitizen init cz-conventional-changelog --save --save-exact</span><br></pre></td></tr></table></figure>

<h2 id="commitlint-husky"><a href="#commitlint-husky" class="headerlink" title="commitlint + husky"></a>commitlint + husky</h2><ol>
<li><p>安装配置prettier</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yarn add --dev --exact prettier</span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">.prettierrc.js</span><br><span class="line">.prettierignore</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装配置 Pre-commit Hook，用于提交代码之前自动格式化，这里会自动安装 husky</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx mrm@2 lint-staged</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 eslint-config-prettier，解决prettier和eslint的冲突</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yarn add eslint-config-prettier -D</span><br><span class="line"></span><br><span class="line"><span class="comment"># vim package.json</span></span><br><span class="line">...</span><br><span class="line">  <span class="string">&quot;eslintConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;extends&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;react-app&quot;</span>,</span><br><span class="line">      <span class="string">&quot;react-app/jest&quot;</span>,</span><br><span class="line">      <span class="string">&quot;prettier&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装并配置 commitlint</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.</span></span><br><span class="line">yarn add @commitlint/&#123;config-conventional,cli&#125; -D</span><br><span class="line"><span class="comment"># 2.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;module.exports = &#123;extends: [&#x27;@commitlint/config-conventional&#x27;]&#125;&quot;</span> &gt; commitlint.config.js</span><br><span class="line"><span class="comment"># 3.</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EEE &gt; .husky/commit-msg</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">. &quot;\$(dirname &quot;\$0&quot;)/_/husky.sh&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">npx --no -- commitlint --edit &quot;\$&#123;1&#125;&quot;</span></span><br><span class="line"><span class="string">EEE</span></span><br><span class="line"><span class="comment"># 4.</span></span><br><span class="line"><span class="built_in">chmod</span> a+x .husky/commit-msg</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E6%B1%87%E7%BC%96/edb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B1%87%E7%BC%96/edb/" class="post-title-link" itemprop="url">edb</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:15:47" itemprop="dateCreated datePublished" datetime="2022-09-24T14:15:47+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h2><h2 id="设置条件断点"><a href="#设置条件断点" class="headerlink" title="设置条件断点"></a>设置条件断点</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E6%B1%87%E7%BC%96/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B1%87%E7%BC%96/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/" class="post-title-link" itemprop="url">通用寄存器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:15:40" itemprop="dateCreated datePublished" datetime="2022-09-24T14:15:40+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在汇编世界里，我们主要通过汇编指令来操纵两种东西：</p>
<ul>
<li>寄存器</li>
<li>内存地址</li>
</ul>
<h2 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h2><h3 id="寄存器的位数"><a href="#寄存器的位数" class="headerlink" title="寄存器的位数"></a>寄存器的位数</h3><p>由于 x86-64 架构惊人的后向兼容性，同一个寄存器，我们可以使用其中的 8bit、16bit、32bit、64bit，以 ax 寄存器为例，分别是 ah&#x2F;al、ax、eax、rax，如下图所示：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1656389225852.png"></p>
<p>通用寄存器的逻辑结构一定要记住：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1656389247635.png"></p>
<p>这就导致一个问题，从大的寄存器上往小的寄存器上 mov 没有问题，而从小的寄存器往大的寄存器上 mov 就需要使用 movsxd 或者 movsx 指令了：</p>
<p>寄存器有两种概念，逻辑上的和物理上的，分别是架构相关寄存器（architectural register）和物理寄存器（physical register）。前者是指令集（ISA）提供给编译器可见的，相当于 API 接口规范，一共 16 个通用寄存器；后者是硬件上实际设计的，软件领域不直接接触。最新的 CPU 可能有上百个实际的物理寄存器。当然了，对软件开发人员来说，我们只需要关注逻辑上的通用寄存器。</p>
<p>这 16 个逻辑上的通用寄存器如下所示：</p>
<table>
<thead>
<tr>
<th><span style="display:inline-block;width: 250px">寄存器 16bit &#x2F; 32bit &#x2F; 64bit</span></th>
<th>主要用途</th>
<th><span style="display:inline-block;width: 100px">编号</span></th>
</tr>
</thead>
<tbody><tr>
<td>ax &#x2F; eax &#x2F; rax</td>
<td>累加器</td>
<td>0</td>
</tr>
<tr>
<td>cx &#x2F; ecx &#x2F; rcx</td>
<td>计数</td>
<td>1</td>
</tr>
<tr>
<td>dx &#x2F; edx &#x2F; rdx</td>
<td>I&#x2F;O 指针</td>
<td>2</td>
</tr>
<tr>
<td>bx &#x2F; ebx &#x2F; rbx</td>
<td>DS 段的数据指针</td>
<td>3</td>
</tr>
<tr>
<td>sp &#x2F; esp &#x2F; rsp</td>
<td>堆栈指针寄存器在堆栈操作中使用，PUSH 和 POP 指令是从 SP 寄存器得到现行堆栈段的段内偏移量，所以称 SP 寄存器为堆栈指针：<strong>stack pointer</strong>，SP 始终指向栈顶。</td>
<td>4</td>
</tr>
<tr>
<td>bp &#x2F; ebp &#x2F; rbp</td>
<td>BP 与 SS 连用，为访问现行堆栈段提供方便。通常 BP 寄存器在间接寻址中使用，操作数在堆栈段中，由 SS 段寄存器和 BP 组合形成操作数的地址，即 BP 中存放现行堆栈段中一个数据区的“基址”的偏移量，所以称 BP 为基址指针：<strong>base pointer</strong></td>
<td>5</td>
</tr>
<tr>
<td>si &#x2F; esi &#x2F; rsi</td>
<td>变址寄存器(IndexRegister)，它们主要用于存放存储单元在段内的偏移量，用它们可实现多种存储器操作数的寻址方式，为以不同的地址形式访问存储单元提供方便。变址寄存器不可分割成 8 位寄存器。作为通用寄存器，也可存储算术逻辑运算的操作数和运算结果。它们可作一般的存储器指针使用。在字符串操作指令的执行过程中，对它们有特定的要求，而且还具有特殊的功能。<br/>存储器指针，串指令中的源操作数指针：<strong>source indexRegister</strong></td>
<td>6</td>
</tr>
<tr>
<td>di &#x2F; edi &#x2F; rdi</td>
<td>存储器指针，串指令中的目的操作数指针：<strong>destination indexRegister</strong></td>
<td>7</td>
</tr>
<tr>
<td>r8</td>
<td></td>
<td></td>
</tr>
<tr>
<td>r9</td>
<td></td>
<td></td>
</tr>
<tr>
<td>r10</td>
<td></td>
<td></td>
</tr>
<tr>
<td>r11</td>
<td></td>
<td></td>
</tr>
<tr>
<td>r12</td>
<td></td>
<td></td>
</tr>
<tr>
<td>r13</td>
<td></td>
<td></td>
</tr>
<tr>
<td>r14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>r15</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>编号一定要记住，后面有用</p>
<p><font color=red>汇编就是在“寄存器与寄存器”或者“寄存器与内存”之间来回移动数据。</font></p>
<h3 id="寄存器和内存编号-内存地址-的区别"><a href="#寄存器和内存编号-内存地址-的区别" class="headerlink" title="寄存器和内存编号(内存地址)的区别"></a>寄存器和内存编号(内存地址)的区别</h3><p>没有区别，唯一的区别就是前者位于 cpu，后者位于内存</p>
<p>每个寄存器指向 16&#x2F;32&#x2F;64 位的空间</p>
<p>每个内存编号指向 8 位的空间，这也就是为什么说操作内存的最小单位是字节</p>
<h2 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h2><h3 id="MOV-指令"><a href="#MOV-指令" class="headerlink" title="MOV 指令"></a>MOV 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MOV DST,SRC			; DST:目标操作数		SRC:源操作数</span><br><span class="line"></span><br><span class="line">MOV r/m8,r8 			r 通用寄存器</span><br><span class="line">MOV r/m16,r16			m 代表内存</span><br><span class="line">MOV r/m32,r32			imm 代表立即数</span><br><span class="line">MOV r8,r/m8				r8 代表8位通用寄存器</span><br><span class="line">MOV r16,r/m16			m8 代表8位内存</span><br><span class="line">MOV r32,r/m32			imm8 代表8位立即数</span><br><span class="line">MOV r8, imm8</span><br><span class="line">MOV r16, imm16</span><br><span class="line">MOV r32, imm32</span><br></pre></td></tr></table></figure>

<p>作用：<strong>拷贝</strong>源操作数到目标操作数</p>
<ol>
<li>源操作数可以是立即数、通用寄存器、段寄存器、或者内存单元.</li>
<li>目标操作数可以是通用寄存器、段寄存器或者内存单元.</li>
<li>操作数的宽度必须一样.</li>
<li><strong>源操作数和目标操作数不能同时为内存单元.</strong></li>
</ol>
<h3 id="ADD-指令"><a href="#ADD-指令" class="headerlink" title="ADD 指令"></a>ADD 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ADD DST,SRC			; DST:目标操作数		SRC:源操作数</span><br><span class="line"></span><br><span class="line">ADD AL, imm8</span><br><span class="line">ADD AX, imm16</span><br><span class="line">ADD EAX, imm32</span><br><span class="line">ADD r/m8, imm8</span><br><span class="line">ADD r/m16,imm16</span><br><span class="line">ADD r/m32,imm32</span><br><span class="line">ADD r/m16, imm8</span><br><span class="line">ADD r/m32, imm8</span><br><span class="line">ADD r/m8, r8</span><br><span class="line">ADD r/m16, r16</span><br><span class="line">ADD r/m32, r32</span><br><span class="line">ADD r8, r/m8</span><br><span class="line">ADD r16, r/m16</span><br><span class="line">ADD r32, r/m32</span><br></pre></td></tr></table></figure>

<p>作用：目标操作数与源操作数相加，将结果存回目标操作数</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax,1</span><br><span class="line">mov ebx,2</span><br><span class="line">add eax,ebx		; eax = 3</span><br></pre></td></tr></table></figure>

<h3 id="SUB-指令"><a href="#SUB-指令" class="headerlink" title="SUB 指令"></a>SUB 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SUB DST,SRC</span><br><span class="line"></span><br><span class="line">SUB AL, imm8</span><br><span class="line">SUB AX, imm16</span><br><span class="line">SUB EAX, imm32</span><br><span class="line">SUB r/m8, imm8</span><br><span class="line">SUB r/m16,imm16</span><br><span class="line">SUB r/m32,imm32</span><br><span class="line">SUB r/m16, imm8</span><br><span class="line">SUB r/m32, imm8</span><br><span class="line">SUB r/m8, r8</span><br><span class="line">SUB r/m16, r16</span><br><span class="line">SUB r/m32, r32</span><br><span class="line">SUB r8, r/m8</span><br><span class="line">SUB r16, r/m16</span><br><span class="line">SUB r32, r/m32</span><br></pre></td></tr></table></figure>

<p>作用：目标操作数减去源操作数，将结果存回目标操作数</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax,3</span><br><span class="line">mov ebx,1</span><br><span class="line">sub eax,ebx		; eax = 2</span><br></pre></td></tr></table></figure>

<h3 id="AND-指令"><a href="#AND-指令" class="headerlink" title="AND 指令"></a>AND 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">AND DST,SRC</span><br><span class="line"></span><br><span class="line">AND AL, imm8</span><br><span class="line">AND AX, imm16</span><br><span class="line">AND EAX, imm32</span><br><span class="line">AND r/m8, imm8</span><br><span class="line">AND r/m16,imm16</span><br><span class="line">AND r/m32,imm32</span><br><span class="line">AND r/m16, imm8</span><br><span class="line">AND r/m32, imm8</span><br><span class="line">AND r/m8, r8</span><br><span class="line">AND r/m16, r16</span><br><span class="line">AND r/m32, r32</span><br><span class="line">AND r8, r/m8</span><br><span class="line">AND r16, r/m16</span><br><span class="line">AND r32, r/m32</span><br></pre></td></tr></table></figure>

<p>作用：目标操作数和源操作数按位<strong>逻辑与</strong>操作，将结果存回目标操作数</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax,111		; eax = 0x00000111 = 0000000000000000000000000000000111</span><br><span class="line">mov ebx,101		; ebx = 0x00000101 = 0000000000000000000000000000000101</span><br><span class="line">and eax,ebx		; eax = 0x00000101</span><br></pre></td></tr></table></figure>

<h3 id="OR-指令"><a href="#OR-指令" class="headerlink" title="OR 指令"></a>OR 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OR DST,SRC</span><br><span class="line"></span><br><span class="line">OR AL, imm8</span><br><span class="line">OR AX, imm16</span><br><span class="line">OR EAX, imm32</span><br><span class="line">OR r/m8, imm8</span><br><span class="line">OR r/m16,imm16</span><br><span class="line">OR r/m32,imm32</span><br><span class="line">OR r/m16, imm8</span><br><span class="line">OR r/m32, imm8</span><br><span class="line">OR r/m8, r8</span><br><span class="line">OR r/m16, r16</span><br><span class="line">OR r/m32, r32</span><br><span class="line">OR r8, r/m8</span><br><span class="line">OR r16, r/m16</span><br><span class="line">OR r32, r/m32</span><br></pre></td></tr></table></figure>

<p>作用：DST 和 SRC 按位<strong>逻辑或</strong>操作，将结果存回 DST</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax,100</span><br><span class="line">mov ebx,1</span><br><span class="line">or eax,ebx		; eax = 0x00000101</span><br></pre></td></tr></table></figure>

<h3 id="XOR-指令"><a href="#XOR-指令" class="headerlink" title="XOR 指令"></a>XOR 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">XOR DST,SRC</span><br><span class="line"></span><br><span class="line">XOR AL, imm8</span><br><span class="line">XOR AX, imm16</span><br><span class="line">XOR EAX, imm32</span><br><span class="line">XOR r/m8, imm8</span><br><span class="line">XOR r/m16,imm16</span><br><span class="line">XOR r/m32,imm32</span><br><span class="line">XOR r/m16, imm8</span><br><span class="line">XOR r/m32, imm8</span><br><span class="line">XOR r/m8, r8</span><br><span class="line">XOR r/m16, r16</span><br><span class="line">XOR r/m32, r32</span><br><span class="line">XOR r8, r/m8</span><br><span class="line">XOR r16, r/m16</span><br><span class="line">XOR r32, r/m32</span><br></pre></td></tr></table></figure>

<p>作用：DST 和 SRC 按位<strong>逻辑异或</strong>操作，将结果存回 DST。异或是不同则真</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax,101</span><br><span class="line">mov ebx,1</span><br><span class="line">xor eax,ebx		; eax = 0x00000100</span><br></pre></td></tr></table></figure>

<h3 id="NOT-指令"><a href="#NOT-指令" class="headerlink" title="NOT 指令"></a>NOT 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">not DST</span><br><span class="line"></span><br><span class="line">NOT r/m8</span><br><span class="line">NOT r/m16</span><br><span class="line">NOT r/m32</span><br></pre></td></tr></table></figure>

<p>作用：对 DST 按位取反，将结果存回 DST</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov eax,ffffffff</span><br><span class="line">mov [56fee4],eax				; [56fee4] = 0xffffffff</span><br><span class="line">not eax							; eax = 0x00000000</span><br><span class="line">not dword ptr ds:[56fee4]		; [56fee4] = 0x00000000</span><br></pre></td></tr></table></figure>

<h3 id="LEA"><a href="#LEA" class="headerlink" title="LEA"></a>LEA</h3><p>Load Effective Address：加载有效地址，将源操作数的地址加载到目的寄存器中</p>
<p>MOV 指令可以通过内存地址读取数据，如果只是需要内存地址，就可以使用 LEA 指令</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E6%B1%87%E7%BC%96/cpu%E5%A6%82%E4%BD%952+3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B1%87%E7%BC%96/cpu%E5%A6%82%E4%BD%952+3/" class="post-title-link" itemprop="url">cpu如何2+3</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:15:14" itemprop="dateCreated datePublished" datetime="2022-09-24T14:15:14+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="数据宽度和逻辑运算"><a href="#数据宽度和逻辑运算" class="headerlink" title="数据宽度和逻辑运算"></a>数据宽度和逻辑运算</h2><p>圆 体现 正负数</p>
<p>cpu加法</p>
<p>示例：2+3</p>
<p>0010 xor 0011 &#x3D; 0001</p>
<p>0010 &amp; 0011 &#x3D; 0010 </p>
<p>0010 &lt;&lt; 1 &#x3D; 0100	 判断0100是否等于0，如果等于，则结果为0001，显然不等于，则继续</p>
<p>0001 xor 0100 &#x3D; 0101</p>
<p>0001 &amp; 0010 &#x3D; 0000 等于0 ，则结果为 0101，即5</p>
<p>示例：2-3</p>
<p>-3 &#x3D; 14 &#x3D; 1110</p>
<p>0010 xor 1101 &#x3D; 1111</p>
<p>0010 &amp; 1101 &#x3D; 0000 &lt;&lt; 1 &#x3D; 0000 等于0</p>
<p>结果为1111 对应有符号的-1</p>
<p>总结：a + b</p>
<ol>
<li>a xor b &#x3D; c1</li>
<li>a &amp; b &lt;&lt; 1 &#x3D; c2</li>
<li>if c2 &#x3D;&#x3D; 0 则结果为 c1，否则a &#x3D; c1，b&#x3D;c2，然后重复1、2、3，直到c2&#x3D;&#x3D;&#x3D;0，返回c1</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E6%B1%87%E7%BC%96/%E5%86%85%E5%AD%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B1%87%E7%BC%96/%E5%86%85%E5%AD%98/" class="post-title-link" itemprop="url">内存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:15:09" itemprop="dateCreated datePublished" datetime="2022-09-24T14:15:09+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>X86CPU 和 AMD64(X86-64)CPU 的区别：</strong></p>
<ul>
<li><p><strong>通用寄存器</strong>的位宽不同：AMD64 通用寄存器是 64 位，而 X86 通用寄存器是 32 位，所以 AMD64 一次能处理 64 位数据，而 X86 一次只能处理 32 位数据。</p>
</li>
<li><p>支持的<strong>寻址空间</strong>不同：操作内存的最小单位是字节，<strong>每个内存地址（内存编号）指向一个字节</strong>，2^32 &#x3D; 4294967296，所以 X86 支持的最大寻址空间就是 4294967296 字节，也就是 4GB。</p>
</li>
<li><p>AMD65 兼容 32 位操作系统，而 X86 不支持 64 位操作系统。</p>
<ul>
<li>32 位操作系统 内存地址是 32 位</li>
<li>64 位操作系统 内存地址是 64 位</li>
</ul>
</li>
</ul>
<h2 id="寄存器与内存"><a href="#寄存器与内存" class="headerlink" title="寄存器与内存"></a>寄存器与内存</h2><p>寄存器与内存的区别：</p>
<ol>
<li><p>寄存器位于 CPU 内部，执行速度快，但比较贵。</p>
</li>
<li><p>内存速度相对较慢，但成本较低，所以可以做的很大。</p>
</li>
<li><p>寄存器和内存没有本质区别，都是用于存储数据的容器，都是定宽的。</p>
</li>
<li><p>寄存器常用的有 8 个：EAX、ECX、EDX、EBX、ESP、EBP、ESI、EDI。</p>
</li>
<li><p>计算机中的几个常用计量单位：BYTE WORD DWORD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BYTE	字节  8bit</span><br><span class="line">WORD	字	 16bit</span><br><span class="line">DWORD	双字   32bit</span><br></pre></td></tr></table></figure>
</li>
<li><p>内存的数量特别庞大，无法每个内存单元都起一个名字，所以用编号来代替，我们称计算机 CPU 是 32 位或者 64 位，主要指的就是内存编号的宽度，而不是寄存器的宽度。有很多书上说之所以叫 32 位计算机是因为寄存器的宽度是 32 位，是不准确的，因为还有很多寄存器是大于 32 位的。</p>
<p>计算机内存的每一个字节会有一个编号(即内存编号的单位是字节)，如下图：</p>
<table>
<thead>
<tr>
<th>内存编号</th>
<th>编号对应的字节字节</th>
</tr>
</thead>
<tbody><tr>
<td>0x00000000</td>
<td>第 0 个字节</td>
</tr>
<tr>
<td>0x00000001</td>
<td>第 1 个字节</td>
</tr>
<tr>
<td>0x00000002</td>
<td>第 2 个字节</td>
</tr>
<tr>
<td>….</td>
<td></td>
</tr>
<tr>
<td>….</td>
<td></td>
</tr>
<tr>
<td>….</td>
<td></td>
</tr>
<tr>
<td>0xFFFFFFFF</td>
<td>第 2^32 个字节，2^32&#x3D;4294967296，4294967296BYTE &#x3D; 4GB</td>
</tr>
</tbody></table>
</li>
<li><p>32 位操作系统最多识别内存 4G，对吗？不对，通过 PAE 物理内存扩展技术，可以使处理器能够从 32 位寻址提升到 36 位，也就是说理论上最大的物理内存可达 64GB。</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1656501132856.png"></p>
</li>
</ol>
<h2 id="内存编号"><a href="#内存编号" class="headerlink" title="内存编号"></a>内存编号</h2><h3 id="内存格式"><a href="#内存格式" class="headerlink" title="内存格式"></a>内存格式</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1656501215560.png"></p>
<ol>
<li>每个内存单元的宽度为 8</li>
<li>[编号]称为地址</li>
<li>地址的作用：当我们想从内存中读取数据或者想向内存中写入数据，首先应该找到要读、写的位置。就像写信要写地址一样。</li>
</ol>
<h3 id="从指定内存中写入-x2F-读取数据"><a href="#从指定内存中写入-x2F-读取数据" class="headerlink" title="从指定内存中写入&#x2F;读取数据"></a>从指定内存中写入&#x2F;读取数据</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov dword ptr ds:[0x0012FF34],0x12345678</span><br><span class="line"></span><br><span class="line">mov eax,dword ptr ds:[0x0012FF34]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>dword ptr：要读&#x2F;写多少 此时是 4 字节 byte &#x3D;&#x3D; 1 字节 word &#x3D;&#x3D; 2 字节</p>
<ul>
<li>ptr：代表后面是一个指针 (指针的意思就是里面存的不是普通的值，而是个地址)</li>
</ul>
</li>
<li><p>[]：中括号表示里面的数据是一个地址值，和 ptr 的作用一样</p>
</li>
<li><p>ds：段寄存器 先不用管 记住就行</p>
</li>
<li><p>0x0012FF34：内存编号，必须是 32 位的 前面 0 可以省略</p>
<p>注意：地址编号不要随便写，因为内存是有保护的，并不是所有的内存都可以直接读写(需要特别处理)</p>
<p>建议地址编号写成 esp 的值</p>
</li>
</ul>
<h2 id="内存读写的-5-个公式"><a href="#内存读写的-5-个公式" class="headerlink" title="内存读写的 5 个公式"></a>内存读写的 5 个公式</h2><p>深刻理解内存寻址方式</p>
<h3 id="寻址公式一-立即数"><a href="#寻址公式一-立即数" class="headerlink" title="寻址公式一 [立即数]"></a>寻址公式一 [立即数]</h3><h4 id="读取内存的值"><a href="#读取内存的值" class="headerlink" title="读取内存的值"></a>读取内存的值</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV EAX,DWORD PTR DS:[0x13FFC4]		; 将0x13FFC4中的值读出来，写到EAX中</span><br></pre></td></tr></table></figure>

<h4 id="向内存中写入数据"><a href="#向内存中写入数据" class="headerlink" title="向内存中写入数据"></a>向内存中写入数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV DWORD PTR DS:[0x13FFC4],eax		; 将eax中的值读出来，写到eax中</span><br></pre></td></tr></table></figure>

<h4 id="获取内存编号"><a href="#获取内存编号" class="headerlink" title="获取内存编号"></a>获取内存编号</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LEA EAX,DWORD PTR DS:[0X13FFC4]		; 将0X13FFC4这个内存编号(也就是0X13FFC4本身)写到EAX中</span><br><span class="line"></span><br><span class="line"># LEA 与 MOV 的区别:</span><br><span class="line">MOV EAX,DWORD PTR DS:[0X13FFC4]		; PTR表示后面是内存地址，MOV会读取内存地址中的值，而LEA只要这个内存地址</span><br></pre></td></tr></table></figure>

<h3 id="寻址公式二-reg"><a href="#寻址公式二-reg" class="headerlink" title="寻址公式二 [reg]"></a>寻址公式二 [reg]</h3><p>reg 代表寄存器，可以是 8 个通用寄存器中的任何一个</p>
<p>这种方式相比第一种，只是要先读取 reg</p>
<h3 id="寻址公式三-reg-立即数"><a href="#寻址公式三-reg-立即数" class="headerlink" title="寻址公式三 [reg+立即数]"></a>寻址公式三 [reg+立即数]</h3><h3 id="寻址公式四-reg-reg-1-2-4-8"><a href="#寻址公式四-reg-reg-1-2-4-8" class="headerlink" title="寻址公式四 [reg+reg*{1,2,4,8}]"></a>寻址公式四 [reg+reg*{1,2,4,8}]</h3><p>用来寻址数组，有些数组元素占用不止一个内存单元，所以在计算数组元素的地址时需要用这种方式来计算：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数组元素地址 = 数组首地址 + 元素索引 * 数组元素占用空间</span><br></pre></td></tr></table></figure>

<p>比如一个字形的数组,它的首地址是 6000H,那么它的第 4 个(索引从 0 开始)元素的地址就是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6000H + 4 * 2 = 6008H</span><br></pre></td></tr></table></figure>

<p>在高级的 CPU 中,这种比例因子的寻址方式是在指令级别上提供支持的，所以可以直接用这种方式寻址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov ebx,offset a</span><br><span class="line">mov edx,4</span><br><span class="line">mov ax,[ebx+edx*2]</span><br></pre></td></tr></table></figure>

<h3 id="寻址公式五-reg-reg-1-2-4-8-立即数"><a href="#寻址公式五-reg-reg-1-2-4-8-立即数" class="headerlink" title="寻址公式五 [reg+reg*{1,2,4,8}+立即数]"></a>寻址公式五 [reg+reg*{1,2,4,8}+立即数]</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E6%B1%87%E7%BC%96/%E5%A0%86%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B1%87%E7%BC%96/%E5%A0%86%E6%A0%88/" class="post-title-link" itemprop="url">堆栈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:14:59" itemprop="dateCreated datePublished" datetime="2022-09-24T14:14:59+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="什么是堆栈"><a href="#什么是堆栈" class="headerlink" title="什么是堆栈"></a>什么是堆栈</h2><p>堆栈 在有些文章中也叫做 栈</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1664173380272.png"></p>
<p>可读、可写 这些都是针对正向的，编译器限制的，对于逆向而言，没有这些限制。</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1656839237231.png"></p>
<p>BASE 是栈底，TOP 是栈顶</p>
<p>栈底是高位，栈顶是低位，以 4G 内存为例，最高位 FFFFFFFF，最低位 00000000</p>
<p>栈底固定，栈顶不固定</p>
<h2 id="RSP-和-RBP-通用寄存器"><a href="#RSP-和-RBP-通用寄存器" class="headerlink" title="RSP 和 RBP 通用寄存器"></a>RSP 和 RBP 通用寄存器</h2><p>rsp 存储栈顶，rbp 存储栈底。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mov rdi,rsp</span><br><span class="line">call 0x7f51189ef050</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">endbr64				# 0x7f51189ef050</span><br><span class="line">push rbp</span><br><span class="line">mov rbp,rsp</span><br><span class="line">push r15</span><br><span class="line">push r14</span><br><span class="line">push r13</span><br><span class="line">push r12</span><br><span class="line">push rbx</span><br><span class="line">sub rsp, 0x88</span><br><span class="line">mov [rbp-0x88],rdi</span><br><span class="line">rdtsc</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="堆栈操作"><a href="#堆栈操作" class="headerlink" title="堆栈操作"></a>堆栈操作</h2><h3 id="push"><a href="#push" class="headerlink" title="push"></a>push</h3><p>压栈，可以将寄存器 push 到堆栈，也可以将内存 push 到堆栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUSH r32</span><br><span class="line">PUSH r16</span><br><span class="line">PUSH m16</span><br><span class="line">PUSH m32</span><br><span class="line">PUSH imm8/imm16/imm32</span><br></pre></td></tr></table></figure>

<p>push 最少 16 位，不能是 8 位</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push rax			# 将rax复制到堆栈，然后rsp(栈顶)减8，为什么减而不是加，因为栈底在高位，栈顶在低位</span><br><span class="line">push eax 			# 将eax复制到堆栈，然后esp(栈顶)减4</span><br><span class="line">push ax				# 将ax复制到堆栈，然后sp(栈顶)减2</span><br></pre></td></tr></table></figure>

<h3 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h3><p>出栈，可以 pop 到寄存器，也可以 pop 到内存。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POP r32</span><br><span class="line">POP r16</span><br><span class="line">POP m16</span><br><span class="line">POP m32</span><br></pre></td></tr></table></figure>

<p>pop 最少 16 位，不能是 8 位</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pop rax				# 将栈顶8个字节复制到rax，然后rsp加8</span><br></pre></td></tr></table></figure>

<h3 id="pushad"><a href="#pushad" class="headerlink" title="pushad"></a>pushad</h3><p>把当前寄存器全部 push 到栈中，其入栈顺序是:EAX、ECX、EDX、EBX、ESP、EBP、ESI、EDI</p>
<h3 id="popad"><a href="#popad" class="headerlink" title="popad"></a>popad</h3><p>POPAD 指令则是 PUSHAD 指令的逆操作。以此 pop 出保存的寄存器，顺序为 EDI、ESI、EBP、ESP、EBX、EDX、ECX、EAX.</p>
<p>pushad 和 popad 通常成对出现，作用 <strong>保护现场</strong>：</p>
<p>先使用 pushad 把寄存器保存起来，然后就可以随便修改寄存器了（破坏现场），最后使用 popad 恢复保存的寄存器（恢复现场）</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E6%B1%87%E7%BC%96/%E6%A0%87%E5%BF%97%E5%AF%84%E5%AD%98%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B1%87%E7%BC%96/%E6%A0%87%E5%BF%97%E5%AF%84%E5%AD%98%E5%99%A8/" class="post-title-link" itemprop="url">标志寄存器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:14:53" itemprop="dateCreated datePublished" datetime="2022-09-24T14:14:53+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>请问 SI,DI 的区别？<br>在用法上的区别？</p>
<p>最重要的是他们的默认段寄存器不同，SI 是 DS，DI 是 ES。</p>
<hr>
<ol>
<li>PE</li>
<li>下断点</li>
<li>WIN32 API</li>
<li>什么是函数调用</li>
<li>熟悉堆栈</li>
<li>Call JCC 标志寄存器</li>
</ol>
<p>一个函数开始执行的时候，栈顶存储的是这个函数的地址：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1657528215513.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E6%B1%87%E7%BC%96/7%E7%A7%8D%E5%AF%BB%E5%9D%80%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B1%87%E7%BC%96/7%E7%A7%8D%E5%AF%BB%E5%9D%80%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">7种寻址方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:14:34" itemprop="dateCreated datePublished" datetime="2022-09-24T14:14:34+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012928324/article/details/69334931">https://blog.csdn.net/u012928324/article/details/69334931</a></p>
<ol>
<li>立即寻址</li>
<li>寄存器寻址</li>
<li>直接寻址</li>
<li>寄存器间接寻址</li>
<li>寄存器相对寻址</li>
<li>基址加变址寻址</li>
<li>相对基址加变址寻址</li>
</ol>
<h2 id="寄存器间接寻址"><a href="#寄存器间接寻址" class="headerlink" title="寄存器间接寻址"></a>寄存器间接寻址</h2><p><img data-src="//img.to2b.cn/blog/lujinkai/1656656865396.png"></p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1656656901044.png"></p>
<h2 id="寄存器相对寻址"><a href="#寄存器相对寻址" class="headerlink" title="寄存器相对寻址"></a>寄存器相对寻址</h2><p><img data-src="//img.to2b.cn/blog/lujinkai/1656657080443.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%B7%A5%E5%85%B7/Firefox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B7%A5%E5%85%B7/Firefox/" class="post-title-link" itemprop="url">Firefox</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-24 14:14:01" itemprop="dateCreated datePublished" datetime="2022-09-24T14:14:01+08:00">2022-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>视频全屏黑一秒：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">full-screen-api.transition-duration.enter		0 0</span><br><span class="line">full-screen-api.transition-duration.leave		0 0</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.lujinkai.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.lujinkai.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.lujinkai.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.lujinkai.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
