<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.lujinkai.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.lujinkai.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/10/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/10/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/10/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/SQL%E8%AF%AD%E8%A8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/SQL%E8%AF%AD%E8%A8%80/" class="post-title-link" itemprop="url">SQL语言</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 22:59:23" itemprop="dateCreated datePublished" datetime="2020-12-31T22:59:23+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="数据库组件（对象）"><a href="#数据库组件（对象）" class="headerlink" title="数据库组件（对象）"></a>数据库组件（对象）</h2><p>数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器等</p>
<h2 id="SQL-语言语法标准"><a href="#SQL-语言语法标准" class="headerlink" title="SQL 语言语法标准"></a>SQL 语言语法标准</h2><h3 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h3><ul>
<li><p>必须以字母开头，可包括数字和三个特殊字符（# _ $）；</p>
</li>
<li><p>不要使用 MySQL 的保留字</p>
</li>
</ul>
<h3 id="SQL-语句分类"><a href="#SQL-语句分类" class="headerlink" title="SQL 语句分类"></a>SQL 语句分类</h3><ul>
<li><p>DDL：Data Defination Language 数据定义语言</p>
<p>CREATE，DROP，ALTER</p>
</li>
<li><p>DML：Data Manipulation Language 数据操纵语言</p>
<p>INSERT，DELETE，UPDATE</p>
</li>
<li><p>DQL：Data Query Language 数据查询语言</p>
<p>SELECT</p>
</li>
<li><p>DCL：Data Control Language 数据控制语言</p>
<p>GRANT，REVOKE，COMMIT，ROLLBACK</p>
</li>
</ul>
<h3 id="字符集和排序"><a href="#字符集和排序" class="headerlink" title="字符集和排序"></a>字符集和排序</h3><p>uft8 最长占用 3 个字节，utf8mb4 最长占用 4 个字节，为了获取更好的兼容性，推荐使用 uft8mb4</p>
<p>以下排序规则：</p>
<ul>
<li><p>utf8mb4_unicode_ci：基于标准的 Unicode 来排序和比较，能够在各种语言之间精确排序</p>
</li>
<li><p>utf8mb4_general_ci：没有实现 Unicode 排序规则，在遇到某些特殊语言或者字符集，排序结果可能不一致</p>
</li>
<li><p>utf8mb4_0900_ai_ci：比以上两种都好，mysql8.0 默认的排序规则，mysql8.0 以下版本不支持</p>
</li>
</ul>
<p>所以：mysql8.0 使用默认排序，mysql8.0 以下版本设置 utf8mb4_general_ci</p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><ul>
<li><p>创建数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database [if <span class="keyword">not</span> <span class="keyword">exists</span>] <span class="string">&#x27;db_name&#x27;</span> <span class="type">character</span> <span class="keyword">set</span> <span class="string">&#x27;utf8mb4&#x27;</span> <span class="keyword">collate</span> <span class="string">&#x27;utf8mb4_general_ci&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">20</span>:<span class="number">30</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> blog <span class="type">character</span> <span class="keyword">set</span> utf8mb4 <span class="keyword">collate</span> utf8mb4_general_ci;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="number">10</span>:<span class="number">20</span>:<span class="number">36</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database blog;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Create</span> Database                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> blog     <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `blog` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="number">10</span>:<span class="number">20</span>:<span class="number">40</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit</span><br><span class="line">Bye</span><br><span class="line">[root<span class="variable">@centos7</span> script]$cat <span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>blog<span class="operator">/</span>db.opt</span><br><span class="line"><span class="keyword">default</span><span class="operator">-</span><span class="type">character</span><span class="operator">-</span><span class="keyword">set</span><span class="operator">=</span>utf8mb4</span><br><span class="line"><span class="keyword">default</span><span class="operator">-</span><span class="keyword">collation</span><span class="operator">=</span>utf8mb4_general_ci</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> database <span class="string">&#x27;db_name&#x27;</span> <span class="type">character</span> <span class="keyword">set</span> <span class="string">&#x27;utf8mb4&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>只能修改字符集，不能修改排序</p>
<ul>
<li><p>删除数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> database [if <span class="keyword">exists</span>] <span class="string">&#x27;db_name&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看数据库列表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p><img data-src="//img.to2b.cn/blog/ljk/1602904434815.png"></p>
<p><strong>选择数据类型三大原则：</strong></p>
<ol>
<li>更小的通常更好，尽量使用可正确存储数据的最小数据类型</li>
<li>简单就好，简单数据类型的操作通常需要更少的 CPU 周期</li>
<li>尽量避免 NULL，包含为 NULL 的列，对 MySQL 更难优化</li>
</ol>
<p><strong>1. 整数</strong></p>
<ul>
<li>int(m)里的 m 表示 select 查询结果集中的显示宽度，并不影响实际的取值范围，规定了 MySQL 的一些交互工具（例如 MySQL 命令行客户端）用来显示字符的个数。对于存储和计算来说，Int(1)和 Int(20)是相同的</li>
<li>BOOL，BOOLEAN：布尔型，是 TINYINT(1)的同义词。zero 值被视为假，非 zero 值视为真</li>
</ul>
<p><strong>2. 浮点</strong></p>
<p>float(m,d) 单精度浮点型 8 位精度(4 字节) m 总个数，d 小数位<br>double(m,d) 双精度浮点型 16 位精度(8 字节) m 总个数，d 小数位</p>
<p><strong>3. 定点数</strong></p>
<p>decimal(m,d) 十进制，精确值，总个数 m&lt;65，小数位 d&lt;30 且 d&lt;\m</p>
<p>MySQL5.0 和更高版本将数字打包保存到一个二进制字符串中（每 4 个字节存 9 个数字）。</p>
<p>例如:<br>decimal(18,9)小数点两边将各存储 9 个数字，一共使用 9 个字节：其中，小数点前的 9 个数字用 4 个字节，小数点后的 9 个数字用 4 个字节，小数点本身占 1 个字节<br>浮点类型在存储同样范围的值时，通常比 decimal 使用更少的空间。float 使用 4 个字节存储。double 占用 8 个字节<br>因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时才使用 decimal，例如存储财务数据。但在数据量比较大的时候，可以考虑使用 bigint 代替 decimal</p>
<p><strong>4. 字符串</strong></p>
<p>char(n)：固定长度，最多 255 个字符</p>
<p>varchar(n)：可变长度，最多 65535 个字符，很多人以为 n 最大是 255，其实不然，只是 varchar(255)是习惯性写法</p>
<p>tinytext：可变长度，最多 255 个字符</p>
<p>text：可变长度，最多 65535 个字符</p>
<p>mediumtext：可变长度，最多 2^24-1 个字符</p>
<p>longtext：可变长度，最多 2^32-1 个字符</p>
<p>BINARY(M)：固定长度，可存储二进制或字符，长度为 0-M 字节</p>
<p>VARBINARY(M)：可变长度，可存二进制或字符，允许长度为 0-M 字节</p>
<p>ENUM：枚举</p>
<p>SET：集合</p>
<p><strong>char 和 varchar</strong></p>
<ol>
<li><p>char(n) 若存入字符数小于 n，则以空格补于其后，查询之时再将空格去掉，所以 char 类型存储的字符串末尾不能有空格，varchar 不限于此</p>
</li>
<li><p>.char(n) 固定长度，char(4)不管是存入几个字符，都将占用 4 个字节，varchar 是存入的实际字符数+1 个字节所以 varchar(4)，存入 3 个字符将占用 4 个字节</p>
</li>
<li><p>char 比 varchar 快</p>
</li>
</ol>
<p><strong>varchar 和 text</strong></p>
<ol>
<li>varchar 可指定 n，text 不能指定，内部存储 varchar 是存入的实际字符数+1 个字节（n&lt; n&gt;255)，text 是实际字符数+2 个字节。</li>
<li>text 类型不能有默认值</li>
<li>varchar 可直接创建索引，text 创建索引要指定前多少个字符。varchar 查询速度快于 text</li>
</ol>
<p><strong>5. 二进制 BLOB</strong></p>
<ul>
<li>TEXT 以文本方式存储，英文存储区分大小写，而 Blob 以二进制方式存储，不分大小写</li>
<li>BLOB 存储的数据只能整体读出</li>
<li>TEXT 可以指定字符集，BLOB 不用指定字符集</li>
</ul>
<p><strong>6. 日期时间</strong></p>
<ul>
<li>date：日期 ‘2008-12-2’</li>
<li>time：时间 ‘12:25:36’</li>
<li>datetime：日期时间 ‘2008-12-2 22:06:44’</li>
<li>timestamp：自动存储记录修改时间</li>
<li>YEAR(2), YEAR(4)：年份</li>
<li>timestamp：字段里的时间数据会随其他字段修改的时候自动刷新，这个数据类型的字段可以存放这条记录最后被修改的时间</li>
</ul>
<p><strong>7. 修饰符</strong></p>
<p>适用所有类型的修饰符：</p>
<ul>
<li>DEFAULT 默认值、</li>
<li>NULL 数据列可包含 NULL 值，默认值</li>
<li>NOT NULL 数据列不允许包含 NULL 值，*为必填选项</li>
<li>PRIMARY KEY 主键，所有记录中此字段的值不能重复，且不能为 NULL</li>
<li>UNIQUE KEY 唯一键，所有记录中此字段的值不能重复，但可以为 NULL</li>
<li>CHARACTER SET name 指定一个字符集</li>
</ul>
<p>适用数值型的修饰符：</p>
<ul>
<li>AUTO_INCREMENT 自动递增，适用于整数类型</li>
<li>UNSIGNED 无符号</li>
</ul>
<h2 id="insert、update、select、delete"><a href="#insert、update、select、delete" class="headerlink" title="insert、update、select、delete"></a>insert、update、select、delete</h2><h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><ul>
<li><p>插入单条数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 <span class="keyword">values</span>(值列表, 注意: 值的顺序一定要和表结构中的顺序保持一致);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 (字段列表) <span class="keyword">values</span>(值列表);</span><br></pre></td></tr></table></figure>

<p>注意：插入字段的个数,必须要与值的个数一致，字段的顺序可以与表结构中的字段顺序不一致，插入字段可以省略，但是省略的字段必须要有 default 值</p>
</li>
<li><p>插入多条数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 <span class="keyword">values</span>(),(),()...;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名(字段列表) <span class="keyword">values</span>(),(),()...;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从其他表中 copy 数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 目标表 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 数据来源表;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 目标表(字段列表) <span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 数据来源表;</span><br></pre></td></tr></table></figure>

<p>蠕虫复制：将自己表中的数据插入到自己表中，可以用来测试数据库性能</p>
</li>
<li><p>replace into</p>
<p>主要是用来解决在添加数据时, 与主键或唯一键冲突的情况下,数据如何变化的问题</p>
</li>
</ul>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表名 <span class="keyword">set</span> 字段<span class="number">1</span><span class="operator">=</span> 值<span class="number">1</span>, 字段<span class="number">2</span><span class="operator">=</span> 值<span class="number">2</span>,... <span class="keyword">where</span> 条件;</span><br><span class="line"></span><br><span class="line"># <span class="keyword">update</span>：更新的关键字</span><br><span class="line"># <span class="keyword">set</span>： 设置 字段 <span class="operator">=</span> 值</span><br></pre></td></tr></table></figure>

<p>注意：一定要指定更新的条件，如果没有指定则更新的是整张表</p>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件；    # 如果不加条件，则为清空表</span><br></pre></td></tr></table></figure>

<p>另外：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> 表名；    # 清空表，主键也会被摧毁，重新开始</span><br></pre></td></tr></table></figure>

<h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><ul>
<li><p><strong>单表操作</strong></p>
<p>select 五子句，每个子句都可以省略， 但是位置不能乱</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件 <span class="keyword">group</span> <span class="keyword">by</span> 字段 <span class="keyword">having</span> 条件 <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span> limit m,n;</span><br><span class="line"></span><br><span class="line"># <span class="keyword">group</span> <span class="keyword">by</span> : 按照字段进行分组, 目的是为了统计, 通常配合MySQL中的聚合函数来使用。</span><br><span class="line"># <span class="keyword">having</span> : 对分组之后的结果, 在进行一次过滤。</span><br><span class="line"># <span class="keyword">order</span> <span class="keyword">by</span> ： <span class="keyword">asc</span>是升序，<span class="keyword">desc</span>是降序</span><br><span class="line"># limit： limit n 是显示n条数据， limit m，n 是从m开始(不包含m),显示n条数据。</span><br></pre></td></tr></table></figure>

<p>别名： as<br>运算符： &#x3D;，&gt;，＜，＜&#x3D;，&gt;&#x3D;，！＝<br>is null 和 is not null<br>in 和 not in<br>between and 和 not between and<br>逻辑判断: and（&amp;&amp;） or（||）<br>聚合函数：聚合函数对一组值执行计算并返回单一的值。除了 count 以外，聚合函数会忽略空值。聚合函数经常和 group by 子句一起使用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">count（<span class="operator">*</span>）    统计数量</span><br><span class="line">sum（字段）    求和</span><br><span class="line">avg（字段）    平均值</span><br><span class="line">min（字段）    求最小值</span><br><span class="line">max（字段）    求最大值</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>多表操作</strong></p>
<p>join</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">from</span> 表A  <span class="keyword">cross</span><span class="operator">|</span><span class="keyword">inner</span> <span class="operator">|</span><span class="keyword">left</span> <span class="keyword">outer</span><span class="operator">|</span><span class="keyword">right</span> <span class="keyword">outer</span>  <span class="operator">|</span> <span class="keyword">natural</span> <span class="operator">|</span>  <span class="keyword">join</span> 表B  <span class="keyword">on</span> 表A.字段名<span class="operator">=</span> 表B.字段名</span><br><span class="line"></span><br><span class="line"># 最常用的是左连接</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 表A <span class="keyword">left</span> <span class="keyword">join</span> 表B <span class="keyword">on</span> 表A.字段名 <span class="operator">=</span> 表B.字段名;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>select 语句处理顺序：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1603096520488.png"></p>
<p>练习：</p>
<p>练习<br>导入 hellodb.sql 生成数据库</p>
<ol>
<li>在 students 表中，查询年龄大于 25 岁，且为男性的同学的名字和年龄</li>
<li>以 ClassID 为分组依据，显示每组的平均年龄</li>
<li>显示第 2 题中平均年龄大于 30 的分组及平均年龄</li>
<li>显示以 L 开头的名字的同学的信息</li>
<li>显示 TeacherID 非空的同学的相关信息</li>
<li>以年龄排序后，显示年龄最大的前 10 位同学的信息</li>
<li>查询年龄大于等于 20 岁，小于等于 25 岁的同学的信息</li>
<li>以 ClassID 分组，显示每班的同学的人数</li>
<li>以 Gender 分组，显示其年龄之和</li>
<li>以 ClassID 分组，显示其平均年龄大于 25 的班级</li>
<li>以 Gender 分组，显示各组中年龄大于 25 的学员的年龄之和</li>
<li>显示前 5 位同学的姓名、课程及成绩</li>
<li>显示其成绩高于 80 的同学的名称及课程</li>
<li>取每位同学各门课的平均成绩，显示成绩前三名的同学的姓名和平均成绩</li>
<li>显示每门课程课程名称及学习了这门课的同学的个数</li>
<li>显示其年龄大于平均年龄的同学的名字</li>
<li>显示其学习的课程为第 1、2，4 或第 7 门课的同学的名字</li>
<li>显示其成员数最少为 3 个的班级的同学中年龄大于同班同学平均年龄的同学</li>
<li>统计各班级中年龄大于全校同学平均年龄的同学</li>
</ol>
<h2 id="SHOW-语句"><a href="#SHOW-语句" class="headerlink" title="SHOW 语句"></a>SHOW 语句</h2><p>常用 show 语句：</p>
<ul>
<li><p>显示所有数据库</p>
</li>
<li><p>显示数据库中所有表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">from</span> database_name;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示数据表中所有列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> columns <span class="keyword">from</span> database_name.table_name</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示一个用户的权限，结果显示类似 grant 命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>:<span class="number">04</span>:<span class="number">50</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> root<span class="variable">@localhost</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> root<span class="variable">@localhost</span>                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> PROXY <span class="keyword">ON</span> <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示表的索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> mysql.user;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示一些系统特定资源的信息，例如，正在运行的线程数量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> status;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示系统变量的名称和值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示系统中正在运行的所有进程，也就是当前正在执行的查询。大多数用户可以查看他们自己的进程，但是如果他们拥有 process 权限，就可以查看所有人的进程，包括密码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> processlist;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示 database 中的每个表的信息。信息包括表类型和表的最新更新时间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">table</span> status <span class="keyword">from</span> mysql;</span><br></pre></td></tr></table></figure>
</li>
<li><p>示服务器所支持的不同权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> privileges;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示创建数据库的语句</p>
</li>
<li><p>显示创建数据表的语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>:<span class="number">16</span>:<span class="number">18</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database mysql;</span><br><span class="line"><span class="number">08</span>:<span class="number">16</span>:<span class="number">18</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> mysql.user;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示可用的存储引擎和默认引擎</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>:<span class="number">19</span>:<span class="number">02</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> engines;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示 innoDB 存储引擎的状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>:<span class="number">21</span>:<span class="number">11</span>(root<span class="variable">@localhost</span>) [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> engine innodb status;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示最后一个执行的语句所产生的错误、警告和通知</p>
</li>
<li><p>显示最后一个执行语句所产生的错误</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> warnings;</span><br><span class="line"><span class="keyword">show</span> errors;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看视图定义</p>
</li>
</ul>
<h2 id="VIEW-视图"><a href="#VIEW-视图" class="headerlink" title="VIEW 视图"></a>VIEW 视图</h2><p>虚拟表，保存实表的查询结果，相当于别名</p>
<ul>
<li><p>创建视图：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> 视图名称 <span class="keyword">as</span> 查询语句;</span><br><span class="line"># 例如</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v_age <span class="keyword">as</span> <span class="operator">*</span> <span class="keyword">from</span> tb_stu <span class="keyword">where</span> age <span class="operator">&lt;</span> <span class="number">25</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看视图</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> view_name #只能看视图定义</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> view_name # 可以查看表和视图</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除视图</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> [IF <span class="keyword">EXISTS</span>] view_name</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="FUNCTION-函数"><a href="#FUNCTION-函数" class="headerlink" title="FUNCTION 函数"></a>FUNCTION 函数</h2><p>分为系统内置函数和自定义函数</p>
<h3 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h3><p>参考：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/sql-function-reference.html">mysql8.0</a>、<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/sql-function-reference.html">mysql5.7</a>，注意：从 mysql5.7 开始，取消了 password()函数</p>
<p>常见内置函数：</p>
<ul>
<li><p>database()：当前所在数据库</p>
</li>
<li><p>now()</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>:<span class="number">53</span>:<span class="number">59</span>(root<span class="variable">@localhost</span>) [mysql]<span class="operator">&gt;</span> <span class="keyword">select</span> now();</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> now()               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-10</span><span class="number">-19</span> <span class="number">20</span>:<span class="number">56</span>:<span class="number">46</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>curdate()：当前日期</p>
</li>
<li><p>curtime()：当前时间</p>
</li>
<li><p>datediff()：时间差</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">08:53:42(root@localhost) [mysql]&gt; <span class="keyword">select</span> datediff(<span class="string">&#x27;2020-10-19&#x27;</span>,<span class="string">&#x27;2020-7-27&#x27;</span>);</span><br><span class="line">------------------------------------+</span><br><span class="line">| datediff(<span class="string">&#x27;2020-10-19&#x27;</span>,<span class="string">&#x27;2020-7-27&#x27;</span>) |</span><br><span class="line">+------------------------------------+</span><br><span class="line">|                                 84 |</span><br><span class="line">+------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>version()</p>
</li>
<li><p>from_unixtime()：时间戳转日期</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>:<span class="number">48</span>:<span class="number">39</span>(root<span class="variable">@localhost</span>) [mysql]<span class="operator">&gt;</span> <span class="keyword">select</span> from_unixtime(<span class="number">1603111741</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+</span></span><br><span class="line"><span class="operator">|</span> from_unixtime(<span class="number">1603111741</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-10</span><span class="number">-19</span> <span class="number">20</span>:<span class="number">49</span>:<span class="number">01</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="number">08</span>:<span class="number">50</span>:<span class="number">10</span>(root<span class="variable">@localhost</span>) [mysql]<span class="operator">&gt;</span> <span class="keyword">select</span> from_unixtime(<span class="number">1603111741</span>,<span class="string">&#x27;%Y-%m-%d %T&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> from_unixtime(<span class="number">1603111741</span>,<span class="string">&#x27;%Y-%m-%d %T&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-10</span><span class="number">-19</span> <span class="number">20</span>:<span class="number">49</span>:<span class="number">01</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>文本处理函数：</p>
<ul>
<li>trim()：去除两边的空格</li>
<li>upper()：返回大写字符</li>
<li>lower()：返回小写字符</li>
<li>concat()：返回连接字符串 ★★★</li>
<li>substring()：返回截取的字符</li>
<li>repace(str, str1, str2)：在 str 中, 将字符串 str1 替换为 str2</li>
</ul>
<p>数学函数：</p>
<ul>
<li>abs(x)：返回 x 的绝对值</li>
<li>bin(x)：返回 x 的二进制(oct 八进制, hex 返回十六进制)</li>
<li>ceiling(x)：向上取整</li>
<li>floor(x)：向下取整</li>
<li>mod(被除数, 除数)：返回余数, 取模</li>
<li>pow(底数, 指数)：返回求指数值</li>
</ul>
<h3 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h3><p>user-defined function，UDF，保存在 mysq.proc 表中</p>
<p>…</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>两种变量：系统内置变量和用户自定义变量</p>
<ul>
<li>系统变量：MySQL 数据库中内置的变量，可用@@var_name 引用</li>
<li>用户自定义变量分为以下两种<ul>
<li>普通变量：在当前会话中有效，可用@var_name 引用</li>
<li>局部变量：在函数或存储过程内才有效，需要用 DECLARE 声明，之后直接用 var_name 引用</li>
</ul>
</li>
</ul>
<h2 id="PROCEDURE-存储过程"><a href="#PROCEDURE-存储过程" class="headerlink" title="PROCEDURE 存储过程"></a>PROCEDURE 存储过程</h2><p>多表 SQL 语句的集合，可以独立执行，存储过程保存在 mysql.proc 表中</p>
<h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><p><strong>存储过程</strong> 和 <strong>函数</strong> 中可以使用流程控制来控制语句的执行</p>
<ul>
<li>IF：用来进行条件判断。根据是否满足条件，执行不同语句</li>
<li>CASE：用来进行条件判断，可实现比 IF 语句更复杂的条件判断</li>
<li>LOOP：重复执行特定的语句，实现一个简单的循环</li>
<li>LEAVE：用于跳出循环控制，相当于 SHELL 中 break</li>
<li>ITERATE：跳出本次循环，然后直接进入下一次循环，相当于 SHELL 中 continue</li>
<li>REPEAT：有条件控制的循环语句。当满足特定条件时，就会跳出循环语句</li>
<li>WHILE：有条件控制的循环语句</li>
</ul>
<h2 id="TRIGGER-触发器"><a href="#TRIGGER-触发器" class="headerlink" title="TRIGGER 触发器"></a>TRIGGER 触发器</h2><p>触发器是由事件来触发某个操作, 这些事件包括 insert、update 和 delete 语句。当执行这些事件时，就会激活触发器执行响应的操作</p>
<h2 id="Event-事件"><a href="#Event-事件" class="headerlink" title="Event 事件"></a>Event 事件</h2><h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/account-management-statements.html">用户管理</a></h2><ul>
<li><p>用户创建，新建用户默认权限：USAGE</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] <span class="string">&#x27;USERNAME&#x27;</span>@<span class="string">&#x27;HOST&#x27;</span> [IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>]；</span><br></pre></td></tr></table></figure>
</li>
<li><p>用户重命名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RENAME <span class="keyword">USER</span> old_user_name <span class="keyword">TO</span> new_user_name;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> [IF <span class="keyword">EXISTS</span>] <span class="string">&#x27;USERNAME&#x27;</span>@<span class="string">&#x27;HOST&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改密码</p>
<p>如果 mysql.user 表的 authentication_string 和 password 字段都保存密码，authentication_string 优先生效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 方法一</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> [IF <span class="keyword">EXISTS</span>] <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> \&quot;$&#123;rootpwd&#125;\&quot;;</span><br><span class="line"># 其他方法，略...</span><br></pre></td></tr></table></figure>
</li>
<li><p>忘记管理员密码的解决方法</p>
<ol>
<li>重启 mysqld 时，使用选项 <code>--skip-grant-tables --skip-networking</code></li>
<li>使用 update 命令修改 mysql.user 表，把管理员密码去掉</li>
<li>移除上述两个选项，然后重启</li>
<li>使用<code>ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY \&quot;$&#123;rootpwd&#125;\&quot;;</code>设置密码</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-grant-tables</span><br><span class="line">skip-networking  <span class="comment"># MySQL8.0不需要此选项</span></span><br><span class="line">...</span><br><span class="line">[root@c71 ~]<span class="variable">$systemctl</span> restart mysqld.service</span><br><span class="line">[root@c71 ~]<span class="variable">$msyql</span> -e <span class="string">&quot;update mysql.user set authentication_string=&#x27;&#x27; where user=&#x27;root&#x27; and host=&#x27;localhost&#x27;;&quot;</span></span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># skip-grant-tables</span></span><br><span class="line"><span class="comment"># skip-networking  # MySQL8.0不需要此选项</span></span><br><span class="line">...</span><br><span class="line">[root@c71 ~]<span class="variable">$systemctl</span> restart mysqld.service</span><br><span class="line">[root@c71 ~]<span class="variable">$mysql</span> -e <span class="string">&quot;alter user &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY \&quot;123456\&quot;;&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="角色管理"><a href="#角色管理" class="headerlink" title="角色管理"></a>角色管理</h2><p>给账户分配角色，更加方便管理多个同样权限的账户</p>
<table>
<thead>
<tr>
<th>语句</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>CREATE ROLE</code> 和 <code>DROP ROLE</code></td>
<td>创建和删除角色</td>
</tr>
<tr>
<td><code>GRANT</code> 和 <code>REVOKE</code></td>
<td>给角色授权和取消授权</td>
</tr>
<tr>
<td><code>SHOW GRANTS</code></td>
<td>查看角色权限</td>
</tr>
<tr>
<td><code>SET DEFAULT ROLE</code></td>
<td>设置账户默认使用什么角色</td>
</tr>
<tr>
<td><code>SET ROLE</code></td>
<td>改变当前会话角色</td>
</tr>
<tr>
<td><code>CURRENT_ROLE()</code>函数</td>
<td>显示当前会话的角色</td>
</tr>
<tr>
<td>mandatory_roles 和 activate_all_roles_on_login 系统变量</td>
<td>允许定义用户登陆时强制的或者激活授权的角色</td>
</tr>
</tbody></table>
<h2 id="权限管理-GRANT-x2F-REVOKE"><a href="#权限管理-GRANT-x2F-REVOKE" class="headerlink" title="权限管理 GRANT&#x2F;REVOKE"></a>权限管理 GRANT&#x2F;REVOKE</h2><p><strong>三种授权方式：</strong></p>
<ol>
<li><p>给用户分配权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span></span><br><span class="line">    priv_type [(column_list)][, priv_type [(column_list)]] ...</span><br><span class="line">    <span class="keyword">ON</span> [object_type] priv_level</span><br><span class="line">    <span class="keyword">TO</span> user_or_role [, user_or_role] ...</span><br><span class="line">    [<span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION]</span><br><span class="line">    [<span class="keyword">AS</span> <span class="keyword">user</span></span><br><span class="line">        [<span class="keyword">WITH</span> ROLE</span><br><span class="line">            <span class="keyword">DEFAULT</span></span><br><span class="line">          <span class="operator">|</span> <span class="keyword">NONE</span></span><br><span class="line">          <span class="operator">|</span> <span class="keyword">ALL</span></span><br><span class="line">          <span class="operator">|</span> <span class="keyword">ALL</span> <span class="keyword">EXCEPT</span> role [, role ] ...</span><br><span class="line">          <span class="operator">|</span> role [, role ] ...</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<ul>
<li>priv_type：权限类型，有很多种<ul>
<li>column_list：有些权限作用与数据表的字段</li>
</ul>
</li>
<li>object_type：表（TABLE）|函数（FUNCTION）|存储过程（PROCEDURE）<ul>
<li>priv_level：<ul>
<li>* | *.*：所有数据库</li>
<li>db_name.*：指定数据库中所有表</li>
<li>db_name.tbl_name：指定数据库的指定数据表</li>
<li>db_name.routine_name：指定数据库的函数、存储过程、触发器</li>
</ul>
</li>
</ul>
</li>
<li>with_option：设置权限某些参数，例如：<ul>
<li>MAX_QUERIES_PER_HOUR count</li>
<li>MAX_UPDATES_PER_HOUR count</li>
<li>MAX_CONNECTIONS_PER_HOUR count</li>
<li>MAX_USER_CONNECTIONS count</li>
</ul>
</li>
</ul>
</li>
<li><p>给用户分配角色</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> role [, role] ...</span><br><span class="line">    <span class="keyword">TO</span> user_or_role [, user_or_role] ...</span><br><span class="line">    [<span class="keyword">WITH</span> ADMIN OPTION]</span><br></pre></td></tr></table></figure>
</li>
<li><p>代理其他用户：这种情况暂时不研究</p>
</li>
</ol>
<p><strong>查看用户权限：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="built_in">CURRENT_USER</span>[()];</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> root<span class="variable">@localhost</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> root<span class="variable">@localhost</span>                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> PROXY <span class="keyword">ON</span> <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;127.0.0.1&#x27;</span> <span class="operator">|</span> # 没有操作用户的权限</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<p><strong>取消授权：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span></span><br><span class="line">    priv_type [(column_list)][, priv_type [(column_list)]] ...</span><br><span class="line">    <span class="keyword">ON</span> [object_type] priv_level</span><br><span class="line">    <span class="keyword">FROM</span> user_or_role [, user_or_role] ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALL</span> [PRIVILEGES], <span class="keyword">GRANT</span> OPTION</span><br><span class="line">    <span class="keyword">FROM</span> user_or_role [, user_or_role] ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">REVOKE</span> PROXY <span class="keyword">ON</span> user_or_role</span><br><span class="line">    <span class="keyword">FROM</span> user_or_role [, user_or_role] ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">REVOKE</span> role [, role ] ...</span><br><span class="line">    <span class="keyword">FROM</span> user_or_role [, user_or_role ] ...</span><br><span class="line"></span><br><span class="line">user_or_role: &#123;</span><br><span class="line">    <span class="keyword">user</span> (see Section <span class="number">6.2</span><span class="number">.4</span>, “Specifying Account Names”)</span><br><span class="line">  <span class="operator">|</span> role (see Section <span class="number">6.2</span><span class="number">.5</span>, “Specifying Role Names”.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 范例</span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;testuser&#x27;</span>@<span class="string">&#x27;172.16.0.%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>设置权限后需要刷新权限：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p><strong>权限类型：</strong></p>
<p>所有权限、管理类、程序类、数据库级别、表级别、字段级别</p>
<ul>
<li><p>所有权限：<code>ALL PRIVILEGES</code> 或 <code>ALL</code></p>
</li>
<li><p>管理类：<code>CREATE USER</code>、<code>FILE</code>、<code>SUPER</code>、<code>SHOW DATABASES</code>、<code>RELOAD</code>、<code>SHUTDOWN</code>、<code>REPLICATION SLAVE</code>、<code>REPLICATION CLIENT</code>、<code>LOCK TABLES</code>、<code>PROCESS</code>、<code>CREATE TEMPORARY TABLES</code></p>
</li>
<li><p>程序类：针对 FUNCTION、PROCEDURE、TRIGGER</p>
<p><code>CREATE</code>、<code>ALTER</code>、<code>DROP</code>、<code>EXCUTE</code></p>
</li>
<li><p>库和表级别：针对 DATABASE、TABLE</p>
<p><code>ALTER</code>、<code>CREATE</code>、<code>CREATE VIEW</code>、<code>DROP INDEX</code>、<code>SHOW VIEW</code>、</p>
<p><code>WITH GRANT OPTION</code>：能将自己获得的权限转赠给其他用户</p>
</li>
<li><p>数据操作：<code>SELECT</code>、<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code></p>
</li>
<li><p>字段级别：<code>SELECT(col1,col2,...)</code>、<code>UPDATE(col1,col2,...)</code>、<code>INSERT(col1,col2,...)</code></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/%E8%8C%83%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/%E8%8C%83%E5%BC%8F/" class="post-title-link" itemprop="url">范式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 22:58:36" itemprop="dateCreated datePublished" datetime="2020-12-31T22:58:36+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>了解范式之前需要先了解依赖的概念：</p>
<p>完全依赖：如果只有一个主键，其他字段通过主键查询，如果是联合主键，其他字段通过所有主键查询</p>
<p>部分依赖：只针对联合主键，其他字段仅需要部分主键就能查询</p>
<p>传递依赖：假如字段 B 除了可以通过主键查询，也可以通过字段 A 查询，主键 –&gt; 字段 A –&gt; 字段 B，这样字段 B 和主键之间存在传递依赖关系</p>
<ol>
<li>第一范式：无重复的列，确保每一列的原子性</li>
<li>第二范式：基于第一范式，消除部分依赖</li>
<li>第三范式：基于第二范式，消除传递依赖</li>
</ol>
<p>范式的优点是避免数据冗余，节约空间。关于范式，要了解理论。<br>实际生产中，常第二范式和第三范式混用，也不会刻意保持字段的原子性，会根据业务添加冗余字段，这就是“反范式“。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">MySQL安装和基本使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 22:58:27" itemprop="dateCreated datePublished" datetime="2020-12-31T22:58:27+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>安装方式可以选择：</p>
<ul>
<li>源码编译：手动指定各种编译参数，生产推荐使用</li>
<li>二进制：解压并简单配置即可使用</li>
</ul>
<h2 id="初始化脚本提高安全性"><a href="#初始化脚本提高安全性" class="headerlink" title="初始化脚本提高安全性"></a>初始化脚本提高安全性</h2><p>mysql_secure_installation</p>
<ul>
<li>设置数据库管理员 root 口令</li>
<li>禁止 root 远程登录</li>
<li>删除 anonymous 用户帐号</li>
<li>删除 test 数据库</li>
</ul>
<h2 id="MySQL-组成"><a href="#MySQL-组成" class="headerlink" title="MySQL 组成"></a>MySQL 组成</h2><h3 id="1-客户端程序"><a href="#1-客户端程序" class="headerlink" title="1. 客户端程序"></a>1. 客户端程序</h3><ul>
<li>mysql：交互式 CLI 工具</li>
<li>mysqldump：备份工具，基于 mysql 协议向 mysqld 发起查询请求，并将查询得到的所有数据转换成 insert 等写操作语句保存在文本文件中</li>
<li>mysqladmin：基于 mysql 协议管理 mysqld</li>
<li>mysqlimport：数据导入工具</li>
</ul>
<p>MyISAM 存储引擎管理工具：</p>
<ul>
<li>myisamchk：检查 MyISAM 库</li>
<li>myisampack：打包 MyISAM 表，只读</li>
</ul>
<p><strong>msyql 运行命令类型</strong></p>
<p>mysql 客户端可以运行两种命令：客户端命令和服务端命令</p>
<ul>
<li><p>客户端命令：本地执行，每个命令都有完整形式和简写形式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; \h, <span class="built_in">help</span></span><br><span class="line">mysql&gt; \u，use</span><br><span class="line">mysql&gt; \s，status</span><br><span class="line">mysql&gt; \!，system</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务端命令：通过 mysql 协议发往服务器执行并取回结果，命令末尾都必须使用命令结束符号，默认为分号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;SELECT VERSION();</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>mysql 使用模式</strong></p>
<p>mysql 客户端有两种使用模式：交互模式和脚本模式</p>
<ul>
<li><p>交互模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@4710419222 <span class="built_in">test</span>]<span class="comment"># mysql -uUserName -pPassWord</span></span><br><span class="line"><span class="comment"># 或使用 -e 参数</span></span><br><span class="line">[root@4710419222 <span class="built_in">test</span>]<span class="comment"># mysql -uUserName -pPassWord -e &quot;sql command&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>脚本模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将sql语句写入文件</span></span><br><span class="line">[root@4710419222 <span class="built_in">test</span>]<span class="comment"># mysql -uUserName -pPassWord &lt; test.sql</span></span><br><span class="line"><span class="comment"># 在交互模式下，使用source也可以调用文件，执行文件中的sql语句</span></span><br><span class="line">[root@4710419222 <span class="built_in">test</span>]<span class="comment"># mysql -uUserName -pPassWord</span></span><br><span class="line">MySQL [(none)]&gt; <span class="built_in">source</span> ~/test/test.sql</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>mysql 命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql [OPTIONS] [database]</span><br></pre></td></tr></table></figure>

<p>常用 OPTIONS：</p>
<ul>
<li>-A, –no-auto-rehash 禁止补全</li>
<li>-u, –user&#x3D; 用户名,默认为 root</li>
<li>-h, –host&#x3D; 服务器主机,默认为 localhost</li>
<li>-p, –passowrd&#x3D; 用户密码,建议使用-p,默认为空密码</li>
<li>-P, –port&#x3D; 服务器端口</li>
<li>-S, –socket&#x3D; 指定连接 socket 文件路径</li>
<li>-D, –database&#x3D; 指定默认数据库</li>
<li>-C, –compress 启用压缩</li>
<li>-e “SQL“ 执行 SQL 命令</li>
<li>-V, –version 显示版本</li>
<li>-v –verbose 显示详细信息</li>
<li>–print-defaults 获取程序默认使用的配置</li>
</ul>
<h3 id="2-服务端程序"><a href="#2-服务端程序" class="headerlink" title="2. 服务端程序"></a>2. 服务端程序</h3><ul>
<li>mysqld_safe：</li>
<li>mysqld：</li>
<li>mysqld_multi：多实例，示例：mysqld_multi –example</li>
</ul>
<p><strong>服务端配置</strong></p>
<p>三种配置方式：1. 启动时配置命令行选项； 2. 配置文件；3. set 变量</p>
<p>配置文件：</p>
<ul>
<li>&#x2F;etc&#x2F;my.cnf # 全局配置</li>
<li>&#x2F;etc&#x2F;mysql&#x2F;my.cnf # 全局配置</li>
<li>~&#x2F;.my.cnf # 个人配置</li>
</ul>
<p>配置文件格式：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># parameter = value</span></span><br><span class="line"><span class="comment"># _ 和 - 相同</span></span><br><span class="line"><span class="comment"># ON，TRUE，1意义相同；0，OFF，FALSE意义相同，不区分大小写</span></span><br><span class="line"><span class="section">[mysqld_safe]</span></span><br><span class="line"><span class="section">[mysqld_multi]</span></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="section">[mysqldump]</span></span><br><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="section">[client]</span></span><br></pre></td></tr></table></figure>

<p>服务器监听两种 socket 地址：</p>
<ul>
<li><p>ip socket: 监听在 tcp 的 3306 端口，支持远程通信 ，侦听 3306&#x2F;tcp 端口可以在绑定有一个或全部接口 IP 上</p>
</li>
<li><p>unix sock: 监听在 sock 文件上，仅支持本机通信, 如：&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock)</p>
<p>说明：host 为 localhost 时自动使用 unix sock</p>
</li>
</ul>
<h3 id="3-用户账号"><a href="#3-用户账号" class="headerlink" title="3. 用户账号"></a>3. 用户账号</h3><p>mysql 用户账号由两部分组成：username@host</p>
<ul>
<li><p>host：支持通配符，% 匹配任意长度任意字符，_ 匹配任意单个字符</p>
<p>172.16.0.0&#x2F;255.255.0.0 等于 172.16.%.%</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/KeepAlived/Keepalived/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/KeepAlived/Keepalived/" class="post-title-link" itemprop="url">Keepalived</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 22:11:01" itemprop="dateCreated datePublished" datetime="2020-12-31T22:11:01+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/KeepAlived/" itemprop="url" rel="index"><span itemprop="name">KeepAlived</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="高可用集群"><a href="#高可用集群" class="headerlink" title="高可用集群"></a>高可用集群</h2><h3 id="集群类型"><a href="#集群类型" class="headerlink" title="集群类型"></a>集群类型</h3><ul>
<li>LB：load balance，负载均衡，例如 LVS &#x2F; HAProxy &#x2F; Nginx(http&#x2F;upstream、stream&#x2F;upstream)</li>
<li>HA：high availability 高可用集群</li>
<li>HPC：High Performance Computing，高性能集群，例如 超级计算机天河二号</li>
</ul>
<h3 id="系统可用性"><a href="#系统可用性" class="headerlink" title="系统可用性"></a>系统可用性</h3><p>SLA：Service-Level Agreement，服务等级协议，指标：99.9%, 99.99%, 99.999%,99.9999%</p>
<p>MTBF：Mean Time Between Failure，平均无故障工作时间</p>
<p>MTTR：Mean Time To Repair，平均故障时间</p>
<p>A &#x3D; MTBF &#x2F; (MTBF+MTTR）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 99.95%</span></span><br><span class="line">(60*24*30)*(1-0.9995)=21.6分钟 <span class="comment"># 一般按一个月停机时间统计</span></span><br></pre></td></tr></table></figure>

<h3 id="HA-Cluster-实现方案-VRRP"><a href="#HA-Cluster-实现方案-VRRP" class="headerlink" title="HA Cluster 实现方案 VRRP"></a>HA Cluster 实现方案 VRRP</h3><p>Virtual Router Redundancy Protocol，虚拟路由冗余协议，解决静态网关单点风险</p>
<ul>
<li><strong>物理层：</strong>路由器、三层交换机</li>
<li><strong>软件层：</strong>keeplived</li>
</ul>
<h4 id="VRRP-网络硬件实现"><a href="#VRRP-网络硬件实现" class="headerlink" title="VRRP 网络硬件实现"></a>VRRP 网络硬件实现</h4><p>参考：<a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/doc/EDOC1000141382/19258d72/basic-concepts-of-vrrp">https://support.huawei.com/enterprise/zh/doc/EDOC1000141382/19258d72/basic-concepts-of-vrrp</a></p>
<p>VRRP 备份组示意图：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1665139455946.png"></p>
<h4 id="VRRP-相关术语"><a href="#VRRP-相关术语" class="headerlink" title="VRRP 相关术语"></a>VRRP 相关术语</h4><ul>
<li>VRRP 路由器（VRRP Router）：运行 VRRP 协议的设备，它可能属于一个或多个虚拟路由器，如 SwitchA 和 SwitchB。</li>
<li>虚拟路由器（Virtual Router）：又称 VRRP 备份组，由一个 Master 设备和多个 Backup 设备组成，被当作一个共享局域网内主机的缺省网关。如 SwitchA 和 SwitchB 共同组成了一个虚拟路由器。</li>
<li>Master 路由器（Virtual Router Master）：承担转发报文任务的 VRRP 设备，如 SwitchA。</li>
<li>Backup 路由器（Virtual Router Backup）：一组没有承担转发任务的 VRRP 设备，当 Master 设备出现故障时，它们将通过竞选成为新的 Master 设备，如 SwitchB。</li>
<li>VRID：虚拟路由器的标识。如 SwitchA 和 SwitchB 组成的虚拟路由器的 VRID 为 1。</li>
<li>虚拟 IP 地址(Virtual IP Address)：虚拟路由器的 IP 地址，一个虚拟路由器可以有一个或多个 IP 地址，由用户配置。如 SwitchA 和 SwitchB 组成的虚拟路由器的虚拟 IP 地址为 10.1.1.10&#x2F;24。</li>
<li>IP 地址拥有者（IP Address Owner）：如果一个 VRRP 设备将虚拟路由器 IP 地址作为真实的接口地址，则该设备被称为 IP 地址拥有者。如果 IP 地址拥有者是可用的，通常它将成为 Master。如 SwitchA，其接口的 IP 地址与虚拟路由器的 IP 地址相同，均为 10.1.1.10&#x2F;24，因此它是这个 VRRP 备份组的 IP 地址拥有者。</li>
<li>虚拟 MAC 地址（Virtual MAC Address）：虚拟路由器根据虚拟路由器 ID 生成的 MAC 地址。一个虚拟路由器拥有一个虚拟 MAC 地址，格式为：00-00-5E-00-01-{VRID}(VRRP for IPv4)；00-00-5E-00-02-{VRID}(VRRP for IPv6)。当虚拟路由器回应 ARP 请求时，使用虚拟 MAC 地址，而不是接口的真实 MAC 地址。如 SwitchA 和 SwitchB 组成的虚拟路由器的 VRID 为 1，因此这个 VRRP 备份组的 MAC 地址为 00-00-5E-00-01-01。</li>
</ul>
<h2 id="keepalived-初步介绍"><a href="#keepalived-初步介绍" class="headerlink" title="keepalived 初步介绍"></a>keepalived 初步介绍</h2><p>vrrp 协议的软件实现，原生设计目的是为了高可用 ipvs（ip virtual server）服务</p>
<p>负载均衡有 LVS、Nginx、HAProxy 可以选择，但是冗余路由只能选择 keepalived，没有其他类似的软件可以选择</p>
<p>官网：<a target="_blank" rel="noopener" href="http://keepalived.org/">http://keepalived.org</a></p>
<ul>
<li>基于 vrrp 协议完成地址流动</li>
<li>为 vip 地址所在的节点生成 ipvs 规则（在配置文件中预先定义）</li>
<li>为 ipvs 集群的各 RS 做健康状态检测</li>
<li>基于脚本调用接口完成脚本中定义的功能，进而影响集群事务，以此支持 nginx、haproxy 等服务</li>
</ul>
<h3 id="keepalived-架构"><a href="#keepalived-架构" class="headerlink" title="keepalived 架构"></a>keepalived 架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609426188382.png"></p>
<p>用户空间的核心组件：</p>
<ul>
<li><strong>VRRP Stack</strong>：最重要的核心功能，实现了 VIP，利用 VIP 就可以做到 IP 地址的浮动，将来用户只需要访问 VIP，至于 VIP 是由哪个机器提供，利用 VRRP 协议可以控制，谁是主谁就提供 VIP</li>
<li><strong>Checkers</strong>：状态监测，可以监测后端服务器(RS)的健康状况，而 LVS 是不提供这个功能的</li>
<li><strong>System call</strong>：在 vrrp 协议状态转换时（就是主节点挂了，把备用节点提升为主节点的时候），可以调用脚本执行一些操作</li>
<li><strong>SMTP</strong>：邮件组件，比如 当服务器挂了，可以发邮件报警</li>
<li><strong>IPVS wrapper</strong>：管理 ipvs 规则</li>
<li><strong>Netlink Reflector</strong>：网络接口，监控网卡状态，和网卡进行通信</li>
<li><strong>WatchDog</strong>：监控其他组件，其他组件出现问题，由 watchdog 进行解决</li>
<li>控制组件：提供 keepalived.conf 的解析器，完成 Keepalived 配置</li>
<li>IO 复用器：针对网络目的而优化的自己的线程抽象</li>
<li>内存管理组件：为某些通用的内存管理功能（例如分配，重新分配，发布等）提供访问权限</li>
</ul>
<p>keepalived 启动后会有三个进程：</p>
<ol>
<li>父进程：内存管理，子进程管理等等</li>
<li>子进程：VRRP 子进程</li>
<li>子进程：healthchecker 子进程</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Keepalived &lt;-- Parent process monitoring children <span class="comment"># 一个主进程</span></span><br><span class="line">\_ Keepalived &lt;-- VRRP child   <span class="comment"># 子进程，负责VRRP</span></span><br><span class="line">\_ Keepalived &lt;-- Healthchecking child <span class="comment"># 子进程，负责健康性检查</span></span><br></pre></td></tr></table></figure>

<p>有图可知，两个子进程都被系统 WatchDog 看管，两个子进程各自复杂自己的事，healthchecker 子进程复杂检查各自服务器的健康程度，例如 HTTP，LVS 等等，如果 healthchecker 子进程检查到 MASTER 上服务不可用了，就会通知本机上的兄弟 VRRP 子进程，让他删除通告，并且去掉虚拟 IP，转换为 BACKUP 状态。</p>
<h3 id="keepalived-安装"><a href="#keepalived-安装" class="headerlink" title="keepalived 安装"></a>keepalived 安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@c71 ~]<span class="variable">$yum</span> install keepalived -y</span><br><span class="line">[root@c71 ~]<span class="variable">$rpm</span> -ql keepalived</span><br><span class="line">/etc/keepalived</span><br><span class="line">/etc/keepalived/keepalived.conf    <span class="comment"># 配置文件</span></span><br><span class="line">/etc/sysconfig/keepalived</span><br><span class="line">/usr/bin/genhash</span><br><span class="line">/usr/lib/systemd/system/keepalived.service</span><br><span class="line">/usr/libexec/keepalived</span><br><span class="line">/usr/sbin/keepalived      <span class="comment"># 主程序文件</span></span><br><span class="line">...</span><br><span class="line">各种配置示例文件</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>注意：CentOS7 上重启可能失败</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart keepalived <span class="comment"># 可能失败，新配置无法生效</span></span><br><span class="line">systemctl stop keepalived; systemctl start keepalived <span class="comment"># 将重启分为停止和启动两步来执行</span></span><br></pre></td></tr></table></figure>

<h3 id="keepalived-配置文件"><a href="#keepalived-配置文件" class="headerlink" title="keepalived 配置文件"></a>keepalived 配置文件</h3><p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42256765/article/details/103223793">https://blog.csdn.net/weixin_42256765/article/details/103223793</a></p>
<p>keepalived 配置文件：<code>/etc/keepalived/keepalived.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">global_defs  <span class="comment"># 全局配置</span></span><br><span class="line">vrrp_instance <span class="comment"># vrrp配置</span></span><br><span class="line">virtual_server <span class="comment"># 和lvs相关的设置</span></span><br></pre></td></tr></table></figure>

<p>生产环境复杂时，keepalived.conf 中内容过多，不易管理，可以将不同集群的配置放在单独的子配置文件，利用 include 指令包含子配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@c71 ~]<span class="variable">$cd</span> /etc/keepalived/</span><br><span class="line">[root@c71 keepalived]<span class="variable">$mkdir</span> conf.d</span><br><span class="line">[root@c71 keepalived]<span class="variable">$cat</span> keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line">include ./conf.d/*.conf</span><br></pre></td></tr></table></figure>

<h4 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">        441757636@qq.com <span class="comment"># keepalived发生故障切换时邮件发送的目标邮箱，可以按行区分写多个</span></span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from keepalived@localhost <span class="comment"># 发邮件的地址</span></span><br><span class="line">    smtp_server 127.0.0.1 <span class="comment"># 邮件服务器地址</span></span><br><span class="line">    smtp_connect_timeout 30 <span class="comment"># 邮件服务器连接timeout</span></span><br><span class="line">    <span class="comment"># 以上邮箱相关的配置都是无效的，配置了也无法生效</span></span><br><span class="line"></span><br><span class="line">    router_id c71 <span class="comment"># 每个keepalived主机唯一标识，建议使用当前主机名，但其实重名了也不影响</span></span><br><span class="line">    vrrp_skip_check_adv_addr <span class="comment"># 默认对所有通告报文都检查，比较消耗性能，启用此配置后，如果收到的通告报文和上一个报文是同一个路由器，则跳过检查</span></span><br><span class="line">    vrrp_strict <span class="comment"># 严格遵守VRRP协议,如果启用此项，以下三种状况将无法启动服务:1.无VIP地址 2.配置了单播邻居 3.在VRRP版本2中有IPv6地址。开启动此项并且没有配置vrrp_iptables时会自动开启iptables防火墙规则，默认导致VIP无法访问,建议注释掉此项配置</span></span><br><span class="line">    vrrp_garp_interval 0 <span class="comment"># gratuitous ARP messages 报文发送延迟，0表示不延迟</span></span><br><span class="line">    vrrp_gna_interval 0  <span class="comment"># unsolicited NA messages （不请自来）消息发送延迟</span></span><br><span class="line">    vrrp_mcast_group4 224.0.0.18 <span class="comment"># 指定组播IP地址范围：224.0.0.0到239.255.255.255，如果有多组keepalived服务器集群，应该每个集群设置不同的组播地址，避免产生干扰</span></span><br><span class="line">    vrrp_iptables <span class="comment"># 此项和vrrp_strict同时开启时，则不会添加防火墙规则,如果无配置vrrp_strict项,则无需启用此项配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果启用了<code>vrrp_strict</code>，也需要启用<code>vrrp_iptables</code>，否则因为防火墙，会导致生成的 VIP 无法访问</p>
<h4 id="配置虚拟路由器"><a href="#配置虚拟路由器" class="headerlink" title="配置虚拟路由器"></a>配置虚拟路由器</h4><p>允许在一个物理服务器上安装多个 vrrp 实例，每个 vrrp 实例可以单独配置 VIP，例如，有的 vrrp 实例后端是 mysql 服务，有的 vrrp 实例后端是 nginx 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123; <span class="comment"># 指定实例名，VI_1</span></span><br><span class="line">    state MASTER  <span class="comment"># 指定master或者backup，其实此项不起作用，真正起作用的是优先级 priority</span></span><br><span class="line">    interface eth0  <span class="comment"># vrrp实例绑定的网口，因为在虚拟IP的时候必须是在已有的网口上添加</span></span><br><span class="line">    virtual_router_id 51 <span class="comment"># 虚拟路由器的id，0-255，一个局域网内，要确保每个虚拟路由器的id都不同</span></span><br><span class="line">    priority 100  <span class="comment"># 优先级，1-254，虚拟路由器中的每个keepalived节点的优先级都不同</span></span><br><span class="line">    advert_int 1  <span class="comment"># 相互通告优先级，默认1s，超时则认为出故障</span></span><br><span class="line">    authentication &#123; <span class="comment"># 相互通告优先级，需要验证</span></span><br><span class="line">        auth_type PASS <span class="comment"># 认证方式：PASS为简单密码(建议使用)</span></span><br><span class="line">        auth_pass 123456 <span class="comment"># 密码</span></span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123; <span class="comment"># 虚拟ip，生产环境可能指定上百个IP地址</span></span><br><span class="line">     <span class="comment"># &lt;IPADDR&gt;/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;</span></span><br><span class="line">        10.0.0.100/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 跟踪接口，设置额外的监控，里面任意一块网卡出现问题，都会进入故障(FAULT)状态，切换主备状态，例如，用nginx做均衡器的时候，内网必须正常工作，如果内网出问题了，这个均衡器也就无法运作了，所以必须对内外网同时做健康检查</span></span><br><span class="line">    track_interface &#123;</span><br><span class="line">        eth0</span><br><span class="line">        eth1</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@c71 keepalived]<span class="variable">$systemctl</span> restart keepalived.service <span class="comment"># 重启</span></span><br><span class="line">[root@c71 keepalived]<span class="variable">$ip</span> a</span><br><span class="line">...</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:02:6d:64 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.71/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.0.0.100/24 scope global secondary eth0:1 <span class="comment"># 成功将vip10.0.0.100分配给eth0</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f850:2415:92a0:3fe6/64 scope <span class="built_in">link</span> noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="启用-keepalived-日志功能"><a href="#启用-keepalived-日志功能" class="headerlink" title="启用 keepalived 日志功能"></a>启用 keepalived 日志功能</h4><p>每个节点都要统一以下配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@c71 <span class="built_in">log</span>]<span class="variable">$vim</span> /etc/sysconfig/keepalived</span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">&quot;-D -S 6&quot;</span> <span class="comment"># 添加 &quot;-S 6&quot; 参数</span></span><br><span class="line"></span><br><span class="line">[root@c71 <span class="built_in">log</span>]<span class="variable">$vim</span> /etc/rsyslog.conf</span><br><span class="line">...</span><br><span class="line">local6.* /var/log/keepalived.log		<span class="comment"># 添加此行</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@c71 <span class="built_in">log</span>]<span class="variable">$tail</span> -f /var/log/keepalived.log <span class="comment"># 查看是否记录日志</span></span><br></pre></td></tr></table></figure>

<h2 id="keepalived-企业应用"><a href="#keepalived-企业应用" class="headerlink" title="keepalived 企业应用"></a>keepalived 企业应用</h2><h3 id="单主架构"><a href="#单主架构" class="headerlink" title="单主架构"></a>单主架构</h3><p>两台服务器：10.0.0.71、10.0.0.72</p>
<h4 id="master-配置"><a href="#master-配置" class="headerlink" title="master 配置"></a>master 配置</h4><p>10.0.0.71</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     441757636@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id c71    <span class="comment"># c71</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   <span class="comment"># vrrp_strict</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   vrrp_mcast_group4 224.0.0.18</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER    <span class="comment"># MASTER</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 100    <span class="comment"># 优先级</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.100/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># include ./conf.d/*.conf</span></span><br></pre></td></tr></table></figure>

<h4 id="backup-配置"><a href="#backup-配置" class="headerlink" title="backup 配置"></a>backup 配置</h4><p>10.0.0.72</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置文件和master基本一致，只需修改三行</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     441757636@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id c72    <span class="comment"># c72</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   <span class="comment"># vrrp_strict</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   vrrp_mcast_group4 224.0.0.18</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP    <span class="comment"># BACKUP</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 80     <span class="comment"># 优先级</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.100/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># include conf.d/*.conf</span></span><br></pre></td></tr></table></figure>

<h4 id="抓包观察"><a href="#抓包观察" class="headerlink" title="抓包观察"></a>抓包观察</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -nn host 224.0.0.18  <span class="comment"># 224.0.0.18 是组播地址</span></span><br></pre></td></tr></table></figure>

<h3 id="双主架构"><a href="#双主架构" class="headerlink" title="双主架构"></a>双主架构</h3><p>上面的单主模式只有一个 VIP，如果是多个 VIP，为了提高服务器的利用率，将 master 和 backup 均匀分配到每一台服务器上，这种模式就是双主架构</p>
<p>两台服务器：10.0.0.71、10.0.0.72<br>两个 VIP：10.0.0.100&#x2F;24、10.0.0.200&#x2F;24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.71，VI_1 master，VI_2，backup</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     441757636@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id c71    <span class="comment"># c71</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   <span class="comment"># vrrp_strict</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   vrrp_mcast_group4 224.0.0.18</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER    <span class="comment"># MASTER</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 100    <span class="comment"># 优先级</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.100/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP    <span class="comment"># BACKUP</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 80    <span class="comment"># 优先级</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.200/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># include ./conf.d/*.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.72，VI_1 backup，VI_2 master，只需要修改5行，省略号表示配置一样的部分</span></span><br><span class="line">global_defs &#123;</span><br><span class="line"> ...</span><br><span class="line">    router_id c72    <span class="comment"># c72</span></span><br><span class="line">    <span class="comment"># vrrp_strict</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP    <span class="comment"># MASTER</span></span><br><span class="line">    priority 80    <span class="comment"># 优先级</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER    <span class="comment"># MASTER</span></span><br><span class="line">    priority 100    <span class="comment"># 优先级</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># include ./conf.d/*.conf</span></span><br></pre></td></tr></table></figure>

<h3 id="抢占模式和非抢占模式"><a href="#抢占模式和非抢占模式" class="headerlink" title="抢占模式和非抢占模式"></a>抢占模式和非抢占模式</h3><p>抢占式：preempt，高优先级的主机恢复在线后，会抢占低先级的主机的 master 角色，造成网络抖动</p>
<p>非抢占式：nopreempt，高优级主机恢复后，不会抢占低优先级主机的 master 角色</p>
<p>如果只有一个 VIP，建议设置为非抢占模式 nopreempt</p>
<h4 id="非抢占模式"><a href="#非抢占模式" class="headerlink" title="非抢占模式"></a>非抢占模式</h4><p>两台服务器：10.0.0.71、10.0.0.72<br>一个 VIP：10.0.0.100&#x2F;24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.71</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP    <span class="comment"># BACKUP，两台服务器都是BACKUP</span></span><br><span class="line">    priority 100    <span class="comment"># 优先级高</span></span><br><span class="line">    nopreempt     <span class="comment"># 指定模式：非抢占式</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.0.72</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP    <span class="comment"># BACKUP，两台服务器都是BACKUP</span></span><br><span class="line">    priority 80     <span class="comment"># 优先级低</span></span><br><span class="line">    nopreempt     <span class="comment"># 指定模式：非抢占式</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="抢占延迟模式"><a href="#抢占延迟模式" class="headerlink" title="抢占延迟模式"></a>抢占延迟模式</h4><p>优先级高的主机恢复后，不会立即抢回 VIP，而是延迟一段时间（默认 300s）再抢回 VIP</p>
<p>两台服务器：10.0.0.71、10.0.0.72<br>一个 VIP：10.0.0.100&#x2F;24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.71</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP    <span class="comment"># BACKUP，两台服务器都是BACKUP</span></span><br><span class="line">    priority 100    <span class="comment"># 优先级高</span></span><br><span class="line">    preempt_delay 60    <span class="comment"># 抢占延迟模式，默认延迟300s</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.0.72</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP    <span class="comment"># BACKUP，两台服务器都是BACKUP</span></span><br><span class="line">    priority 80     <span class="comment"># 优先级低</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="VIP-单播配置"><a href="#VIP-单播配置" class="headerlink" title="VIP 单播配置"></a>VIP 单播配置</h3><p>keepalived 主机之间默认利用多播相互通告消息，会造成网络拥塞，可以替换成单播，减少网络流量</p>
<p>在所有节点 vrrp_instance 语句块中设置对方主机的 IP，建议设置为专用于对应心跳线网络的地址，而非使用业务网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">unicast_src_ip &lt;IPADDR&gt;  <span class="comment"># 指定发送单播的源IP</span></span><br><span class="line">unicast_peer &#123;</span><br><span class="line"> &lt;IPADDR&gt; 				<span class="comment"># 指定接收单播的对方目标主机IP</span></span><br><span class="line"> ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两台服务器：10.0.0.71、10.0.0.72<br>一个 VIP：10.0.0.100&#x2F;24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.71</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> ...</span><br><span class="line"> virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.71  <span class="comment"># 本机IP</span></span><br><span class="line">    unicast_peer&#123;</span><br><span class="line">     10.0.0.72 	<span class="comment"># 指向对方主机IP</span></span><br><span class="line">     10.0.0.82 	<span class="comment"># 如果有多个keepalived，再加其它节点的IP</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.0.72</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> ...</span><br><span class="line"> virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.72  <span class="comment"># 本机IP</span></span><br><span class="line">    unicast_peer&#123;</span><br><span class="line">     10.0.0.71 	<span class="comment"># 指向对方主机IP</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抓包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -nn host 10.0.0.71 and host 10.0.0.72</span><br></pre></td></tr></table></figure>

<h3 id="通知脚本配置"><a href="#通知脚本配置" class="headerlink" title="通知脚本配置"></a>通知脚本配置</h3><p>当 keepalived 的状态变化时，可以自动触发脚本（sh、py、php 各种脚本）的执行，比如：发邮件、短信、微信通知用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># 指定脚本执行用户的身份，如果不指定，默认用户keepalived_script，如果此用户不存在，则root执行脚本</span></span><br><span class="line">    script_user &lt;USER&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通知脚本类型</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment"># 当前节点成为主节点时触发的脚本</span></span><br><span class="line">notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment"># 当前节点转为备节点时触发的脚本</span></span><br><span class="line">notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment"># 当前节点转为“失败”状态时触发的脚本</span></span><br><span class="line">notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment"># 通用格式的通知触发机制，一个脚本可完成以上三种状态的转换时的通知</span></span><br><span class="line">notify_stop &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment"># 当停止VRRP时触发的脚本</span></span><br></pre></td></tr></table></figure>

<p><strong>邮件服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装邮件服务</span></span><br><span class="line">yum -y install mailx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置/etc/mail.rc</span></span><br><span class="line"><span class="built_in">set</span> from=ljkk3014@foxmail.com</span><br><span class="line"><span class="built_in">set</span> smtp=smtp.qq.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=ljkk3014@foxmail.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-password=jwxxxxxxxxg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送测试邮件</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Hello, I am `whoami`,The system version is here,please help me to check it ,thanks! \n`cat /etc/os-release`&quot;</span> | mail -s hello 441757636@qq.com</span><br></pre></td></tr></table></figure>

<p><img data-src="//img.to2b.cn/blog/ljk/1596250258504.png"></p>
<p><strong>实战案例：实现 Keepalived 状态切换的通知脚本</strong></p>
<p>在所有 keepalived 节点配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@c72 ~]<span class="variable">$cat</span> /etc/keepalived/notify.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">contact=<span class="string">&#x27;441757636@qq.com&#x27;</span></span><br><span class="line"><span class="function"><span class="title">notify</span></span>() &#123;</span><br><span class="line">    mailsubject=<span class="string">&quot;<span class="subst">$(hostname)</span> to be <span class="variable">$1</span>, vip floating&quot;</span></span><br><span class="line">    mailbody=<span class="string">&quot;<span class="subst">$(date +&#x27;%F %T&#x27;)</span>: vrrp transition, <span class="subst">$(hostname)</span> changed to be <span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$mailbody</span>&quot;</span> | mail -s <span class="string">&quot;<span class="variable">$mailsubject</span>&quot;</span> <span class="variable">$contact</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">master)</span><br><span class="line">    notify master</span><br><span class="line">    ;;</span><br><span class="line">backup)</span><br><span class="line">    notify backup</span><br><span class="line">    ;;</span><br><span class="line">fault)</span><br><span class="line">    notify fault</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> &#123;master|backup|fault&#125;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">[root@c72 ~]<span class="variable">$cat</span> /etc/keepalived/keepalived.conf</span><br><span class="line">...</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> ...</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.100/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># include conf.d/*.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将master下线</span></span><br><span class="line">[root@c72 ~]<span class="variable">$systemctl</span> stop keepalived.service</span><br></pre></td></tr></table></figure>

<p>查看邮箱：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1609660315254.png"></p>
<h3 id="实现-IPVS-的高可用性"><a href="#实现-IPVS-的高可用性" class="headerlink" title="实现 IPVS 的高可用性"></a>实现 IPVS 的高可用性</h3><p>keepalived 也提供了管理 IPVS 规则的功能，在实现 VIP 高可用的同时，还能实现 IPVS 的高可用。</p>
<p>所以 ipvsadm 就没什么用了</p>
<h4 id="VS-配置"><a href="#VS-配置" class="headerlink" title="VS 配置"></a>VS 配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">virtual_server IP port    <span class="comment"># 定义虚拟主机IP地址及其端口</span></span><br><span class="line">virtual_server fwmark int   <span class="comment"># ipvs的防火墙打标，实现基于防火墙的负载均衡集群</span></span><br><span class="line">virtual_server group string  <span class="comment"># 使用虚拟服务器组</span></span><br><span class="line"></span><br><span class="line">virtual_server IP port &#123;</span><br><span class="line">    ...</span><br><span class="line">    real_server &#123;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">    real_server &#123;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">virtual_server IP port &#123;     <span class="comment"># VIP和PORT</span></span><br><span class="line">    delay_loop &lt;INT&gt;     <span class="comment"># 检查后端服务器的时间间隔</span></span><br><span class="line">    lb_algo rr|wrr|lc|wlc|lblc|sh|dh  <span class="comment"># 定义调度方法</span></span><br><span class="line">    lb_kind NAT|DR|TUN      <span class="comment"># 集群的类型,注意要大写</span></span><br><span class="line">    persistence_timeout &lt;INT&gt;    <span class="comment"># 持久连接时长</span></span><br><span class="line">    protocol TCP|UDP|SCTP     <span class="comment"># 指定服务协议,一般为TCP</span></span><br><span class="line">    sorry_server &lt;IPADDR&gt; &lt;PORT&gt;   <span class="comment"># 所有RS故障时，备用服务器地址</span></span><br><span class="line">    real_server &lt;IPADDR&gt; &lt;PORT&gt; &#123;   <span class="comment"># RS的IP和PORT</span></span><br><span class="line">        weight &lt;INT&gt;      <span class="comment"># RS权重</span></span><br><span class="line">        notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;   <span class="comment"># RS上线通知脚本</span></span><br><span class="line">        notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment"># RS下线通知脚本</span></span><br><span class="line">        HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK &#123; ... &#125; <span class="comment">#定义当前主机健康状态检测方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="VS-组"><a href="#VS-组" class="headerlink" title="VS 组"></a>VS 组</h4><p>将多个 VS 定义成一个组，统一对外服务，如：http 和 https 定义成一个虚拟服务器组</p>
<p>示例文件：<code>/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.virtual_server_group</code></p>
<h4 id="应用层检测"><a href="#应用层检测" class="headerlink" title="应用层检测"></a>应用层检测</h4><p>应用层检测：http：HTTP_GET；https：SSL_GET</p>
<p>示例文件：<br><code>/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.HTTP_GET.port</code><br><code>/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.SSL_GET</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HTTP_GET|SSL_GET &#123;</span><br><span class="line">    url &#123;</span><br><span class="line">        path &lt;URL_PATH&gt;   <span class="comment"># 定义要监控的URL</span></span><br><span class="line">        status_code &lt;INT&gt;   <span class="comment"># 判断上述检测机制为健康状态的响应码，一般为 200</span></span><br><span class="line">    &#125;</span><br><span class="line">    connect_timeout &lt;INTEGER&gt;  <span class="comment"># 客户端请求的超时时长, 相当于haproxy的timeout server</span></span><br><span class="line">    nb_get_retry &lt;INT&gt;    <span class="comment"># 重试次数</span></span><br><span class="line">    delay_before_retry &lt;INT&gt;  <span class="comment"># 重试之前的延迟时长</span></span><br><span class="line">    connect_ip &lt;IP ADDRESS&gt;  <span class="comment"># 向当前RS哪个IP地址发起健康状态检测请求</span></span><br><span class="line">    connect_port &lt;PORT&gt;   <span class="comment"># 向当前RS的哪个PORT发起健康状态检测请求</span></span><br><span class="line">    bindto &lt;IP ADDRESS&gt;   <span class="comment"># 向当前RS发出健康状态检测请求时使用的源地址</span></span><br><span class="line">    bind_port &lt;PORT&gt;    <span class="comment"># 向当前RS发出健康状态检测请求时使用的源端口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 10.0.0.10 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line">    real_server 10.0.0.7 80 &#123;</span><br><span class="line">     weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /monitor.html</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 10.0.0.17 80 &#123;</span><br><span class="line">     weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TCP-检测"><a href="#TCP-检测" class="headerlink" title="TCP 检测"></a>TCP 检测</h4><p>传输层检测：TCP_CHECK</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TCP_CHECK &#123;</span><br><span class="line">    connect_ip &lt;IP ADDRESS&gt;  	<span class="comment"># 向当前RS的哪个IP地址发起健康状态检测请求</span></span><br><span class="line">    connect_port &lt;PORT&gt;   <span class="comment"># 向当前RS的哪个PORT发起健康状态检测请求</span></span><br><span class="line">    bindto &lt;IP ADDRESS&gt;   <span class="comment"># 发出健康状态检测请求时使用的源地址</span></span><br><span class="line">    bind_port &lt;PORT&gt;    <span class="comment"># 发出健康状态检测请求时使用的源端口</span></span><br><span class="line">    connect_timeout &lt;INTEGER&gt;  <span class="comment"># 客户端请求的超时时长, 等于haproxy的timeout server</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 10.0.0.10 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    <span class="comment">#persistence_timeout 120  #会话保持时间</span></span><br><span class="line">    protocol TCP</span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line">    real_server 10.0.0.7 80 &#123;</span><br><span class="line">     weight 1</span><br><span class="line">     TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 5</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 10.0.0.17 80 &#123;</span><br><span class="line">     weight 1</span><br><span class="line">     TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 5</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><h5 id="实现单主的-LVS-DR-模式"><a href="#实现单主的-LVS-DR-模式" class="headerlink" title="实现单主的 LVS-DR 模式"></a>实现单主的 LVS-DR 模式</h5><h5 id="实现双主的-LVS-DR-模式"><a href="#实现双主的-LVS-DR-模式" class="headerlink" title="实现双主的 LVS-DR 模式"></a>实现双主的 LVS-DR 模式</h5><h5 id="实现单主的-LVS-DR，实现单主的-LVS-DR-模式，利用-FWM-绑定成多个服务为一个集群服务"><a href="#实现单主的-LVS-DR，实现单主的-LVS-DR-模式，利用-FWM-绑定成多个服务为一个集群服务" class="headerlink" title="实现单主的 LVS-DR，实现单主的 LVS-DR 模式，利用 FWM 绑定成多个服务为一个集群服务"></a>实现单主的 LVS-DR，实现单主的 LVS-DR 模式，利用 FWM 绑定成多个服务为一个集群服务</h5><h3 id="实现其他应用的高可用性-VRRP-Script"><a href="#实现其他应用的高可用性-VRRP-Script" class="headerlink" title="实现其他应用的高可用性 VRRP Script"></a>实现其他应用的高可用性 VRRP Script</h3><p>示例文件：<code>/usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp.localcheck </code></p>
<p>调用外部的辅助性脚本进行资源监控，并根据监控的结果实现优先动态调整，从而实现其他应用的高可用性功能</p>
<h4 id="vrrp-script"><a href="#vrrp-script" class="headerlink" title="vrrp_script"></a>vrrp_script</h4><p>自定义资源监控脚本，一般放在 gloal_defs 设置块之后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script &lt;SCRIPT_NAME&gt; &#123;</span><br><span class="line">    script &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment"># shell命令或脚本路径，返回值为0即检测成功</span></span><br><span class="line">    interval &lt;INTEGER&gt;      <span class="comment"># 间隔时间，单位为秒，默认1秒</span></span><br><span class="line">    <span class="built_in">timeout</span> &lt;INTEGER&gt;     <span class="comment"># 超时时间</span></span><br><span class="line">    weight &lt;INTEGER:-254..254&gt;     	<span class="comment"># 权重，配合vrrp_instance的priority调整vrrp实例的优先级：当设置为负数，如果标记KO，vrrp_instance的优先级=priority+weight，优先级降低；当设置为正数，如果标记KO，vrrp_instance的优先级=priority+weight，优先级提高；默认为0,通常使用负值。</span></span><br><span class="line">    fall &lt;INTEGER&gt;       <span class="comment"># 脚本几次失败就标记KO，建议设为2以上</span></span><br><span class="line">    rise &lt;INTEGER&gt;       <span class="comment"># 脚本连续监测成功几次，就标记OK</span></span><br><span class="line">    user USERNAME [GROUPNAME]    <span class="comment"># 执行监测脚本的用户或组</span></span><br><span class="line">    init_fail        <span class="comment"># 设置默认标记为失败状态，监测成功之后再转换为成功状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="track-script"><a href="#track-script" class="headerlink" title="track_script"></a>track_script</h4><p>调用脚本，调用 vrrp_script 定义的脚本去监控资源，定义在 vrrp 实例内</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> ...</span><br><span class="line"> track_script &#123;</span><br><span class="line">  SCRIPT_NAME</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例：利用脚本实现主从角色切换"><a href="#示例：利用脚本实现主从角色切换" class="headerlink" title="示例：利用脚本实现主从角色切换"></a>示例：利用脚本实现主从角色切换</h4><p>两台服务器：10.0.0.71、10.0.0.72<br>一个 VIP：10.0.0.100&#x2F;24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.71</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     441757636@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id c71    <span class="comment"># 10.0.0.72设置为c72</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   <span class="comment"># vrrp_strict</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   vrrp_mcast_group4 224.0.0.18</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_down &#123;</span><br><span class="line">    script <span class="string">&quot;[ ! -f /etc/keepalived/down ]&quot;</span>  <span class="comment"># /etc/keepalived/down存在时返回非0，触发权重-30</span></span><br><span class="line">    interval 1 <span class="comment"># 每秒执行一次script</span></span><br><span class="line">    weight -30</span><br><span class="line">    fall 3  <span class="comment"># 当script执行三次失败，priority = 100 - 30</span></span><br><span class="line">    rise 2</span><br><span class="line">    <span class="built_in">timeout</span> 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER    <span class="comment"># 10.0.0.72设置为BACKUP</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 1</span><br><span class="line">    priority 100    <span class="comment"># 10.0.0.72设置为80</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.100/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    track_interface &#123;</span><br><span class="line">     eth0</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">    track_script &#123;</span><br><span class="line">     check_down	 	<span class="comment"># 调用前面定义的脚本</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例：实现单主模式的-Nginx-反向代理的高可用"><a href="#示例：实现单主模式的-Nginx-反向代理的高可用" class="headerlink" title="示例：实现单主模式的 Nginx 反向代理的高可用"></a>示例：实现单主模式的 Nginx 反向代理的高可用</h4><h4 id="示例：实现双主模式-Nginx-反向代理的高可用"><a href="#示例：实现双主模式-Nginx-反向代理的高可用" class="headerlink" title="示例：实现双主模式 Nginx 反向代理的高可用"></a>示例：实现双主模式 Nginx 反向代理的高可用</h4><h4 id="实现-HAProxy-高可用"><a href="#实现-HAProxy-高可用" class="headerlink" title="实现 HAProxy 高可用"></a>实现 HAProxy 高可用</h4><h4 id="示例：实现-MySQL-双主模式的高可用"><a href="#示例：实现-MySQL-双主模式的高可用" class="headerlink" title="示例：实现 MySQL 双主模式的高可用"></a>示例：实现 MySQL 双主模式的高可用</h4><h3 id="同步组"><a href="#同步组" class="headerlink" title="同步组"></a>同步组</h3><p>LVS NAT 模型 VIP 和 DIP 需要同步，需要同步组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_sync_group VG_1 &#123;</span><br><span class="line">    group &#123;</span><br><span class="line">        VI_1 <span class="comment"># name of vrrp_instance (below)</span></span><br><span class="line">        VI_2 <span class="comment"># One for each moveable IP</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    eth0</span><br><span class="line">    vip</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    eth1</span><br><span class="line">    dip</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="综合实战案例"><a href="#综合实战案例" class="headerlink" title="综合实战案例"></a>综合实战案例</h2><h3 id="Keepalived-LVS"><a href="#Keepalived-LVS" class="headerlink" title="Keepalived + LVS"></a>Keepalived + LVS</h3><ul>
<li>编译安装 keepalived</li>
<li>实现 keepalived(20 个以上的 VIP) + Nginx 双主高可用</li>
<li>实现 keepalived(60 个以上的 VIP) + HAProxy 三服务器高可用</li>
<li>实现 keepalived(100 个以上的 VIP) + LVS 高可用、Real Server 状态监测及规则管理</li>
</ul>
<h3 id="Keepalived-HAProxy"><a href="#Keepalived-HAProxy" class="headerlink" title="Keepalived + HAProxy"></a>Keepalived + HAProxy</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609770239531.png"></p>
<ul>
<li>编译安装 HAProxy 较新 LTS 版本，选择编译安装 keepalived</li>
<li>开启 HAProxy 多进程，进程数与 CPU 核心数保持一致并实现 HAProxy 进程绑定</li>
<li>因业务较多避免配置文件误操作，需要按每业务一个配置文件并统一保存至&#x2F;etc&#x2F;haproxy&#x2F;conf 目录中</li>
<li>实现 keepalived include 导入配置文件功能，使用 LVS-DR 模型代理后端 Nginx web 服务器</li>
<li>基于 ACL 实现单 IP 多域名负载功能(适用于企业较少公网 IP 多域名场景)</li>
<li>实现 MySQL 主从复制，并通过 HAProxy 对 MySQL 进行反向代理</li>
<li>最终完成 HAProxy+Nginx+Tomcat+ Redis，并实现 session 会话保持统一保存到 Redis</li>
</ul>
<p><strong>HAProxy 的 frontend 的 bind 绑定 Keepalived 的 VIP</strong></p>
<h3 id="MyCAT-集群方案"><a href="#MyCAT-集群方案" class="headerlink" title="MyCAT 集群方案"></a>MyCAT 集群方案</h3><p><img data-src="//img.to2b.cn/blog/ljk/1603695796885.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Nginx/6.%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Nginx/6.%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">6.系统参数优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 21:55:15" itemprop="dateCreated datePublished" datetime="2020-12-31T21:55:15+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>默认的 Linux 内核参数不符合 web 服务器高并发的要求，Nginx 作为静态 web 内容服务器、反向代理服务器或者提供压缩服务的服务器时，内核参数的调整是不一样的，下面是针对更多并发请求的 TCP 网络做的参数优化</p>
<h2 id="优化内核参数"><a href="#优化内核参数" class="headerlink" title="优化内核参数"></a>优化内核参数</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/bytxl/article/details/46437363">https://blog.csdn.net/bytxl/article/details/46437363</a></p>
<p>修改<code>/etc/sysctl.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 1000000 <span class="comment"># 表示单个进程较大可以打开的句柄数</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1 <span class="comment"># 参数设置为1，表示允许将TIME_WAIT状态的socket重新用于新的TCP链接，这对于服务器来说意义重大，因为总有大量TIME_WAIT状态的链接存在</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600 <span class="comment"># 当keepalive启动时，TCP发送keepalive消息的频度;默认是2小时，将其设置为10分钟，可更快的清理无效链接</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30 <span class="comment"># 当服务器主动关闭链接时，socket保持在FIN_WAIT_2状态的较大时间</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000 <span class="comment"># 表示操作系统允许TIME_WAIT套接字数量的较大值，如超过此值，TIME_WAIT套接字将立刻被清除并打印警告信息,默认为8000，过多的TIME_WAIT套接字会使Web服务器变慢</span></span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000 <span class="comment"># 定义UDP和TCP链接的本地端口的取值范围</span></span><br><span class="line">net.ipv4.tcp_rmem = 10240 87380 12582912 <span class="comment"># 定义了TCP接受缓存的最小值、默认值、较大值</span></span><br><span class="line">net.ipv4.tcp_wmem = 10240 87380 12582912 <span class="comment"># 定义TCP发送缓存的最小值、默认值、较大值</span></span><br><span class="line">net.core.netdev_max_backlog = 8096 <span class="comment"># 当网卡接收数据包的速度大于内核处理速度时，会有一个列队保存这些数据包。这个参数表示该列队的较大值</span></span><br><span class="line"></span><br><span class="line">net.core.rmem_default = 6291456 <span class="comment"># 表示内核套接字接受缓存区默认大小</span></span><br><span class="line">net.core.wmem_default = 6291456 <span class="comment"># 表示内核套接字发送缓存区默认大小</span></span><br><span class="line">net.core.rmem_max = 12582912 <span class="comment"># 表示内核套接字接受缓存区较大大小</span></span><br><span class="line">net.core.wmem_max = 12582912 <span class="comment"># 表示内核套接字发送缓存区较大大小，</span></span><br><span class="line"><span class="comment"># 注意：以上的四个参数，需要根据业务逻辑和实际的硬件成本来综合考虑</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_syncookies = 1  <span class="comment"># 与性能无关。用于解决TCP的SYN攻击</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192 <span class="comment"># 这个参数表示TCP三次握手建立阶段接受SYN请求列队的较大长度，默认1024，将其设置的大一些可使出现Nginx繁忙来不及accept新连接时，Linux不至于丢失客户端发起的链接请求</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1 <span class="comment"># 这个参数用于设置启用timewait快速回收</span></span><br><span class="line">net.core.somaxconn=262114 <span class="comment"># 选项默认值是128，这个参数用于调节系统同时发起的TCP连接数，在高并发的请求中，默认的值可能会导致链接超时或者重传，因此需要结合高并发请求数来调节此值。</span></span><br><span class="line">net.ipv4.tcp_max_orphans=262114 <span class="comment"># 选项用于设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤立链接将立即被复位并输出警告信息。这个限制指示为了防止简单的DOS攻击，不用过分依靠这个限制甚至人为的减小这个值，更多的情况是增加这个值</span></span><br></pre></td></tr></table></figure>

<p>张 sir：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tcp conn</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line">net.ipv4.tcp_syn_retries = 3</span><br><span class="line">tcp_retries1 = 3</span><br><span class="line">tcp_retries2 = 15</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcp conn reuse</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 1</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line">net.ipv4.tcp_max_orphans= 262114</span><br><span class="line">net.ipv4.tcp_synack_retries= 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># keepalive conn</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 300</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.ip_local_port_range = 10001 65000</span><br><span class="line"></span><br><span class="line"><span class="comment"># swap</span></span><br><span class="line">vm.overcommit_memory = 0</span><br><span class="line">vm.swappiness = 0</span><br></pre></td></tr></table></figure>

<h2 id="PAM-资源限制优化"><a href="#PAM-资源限制优化" class="headerlink" title="PAM 资源限制优化"></a>PAM 资源限制优化</h2><p>在<code>/etc/security/limits.conf</code> 最后增加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">* soft <span class="built_in">nproc</span> 65535</span><br><span class="line">* hard <span class="built_in">nproc</span> 65535</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root soft core unlimited</span><br><span class="line">root hard core unlimited</span><br><span class="line">root soft <span class="built_in">nproc</span> 65535</span><br><span class="line">root hard <span class="built_in">nproc</span> 65535</span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Nginx/5.Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Nginx/5.Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">5.Nginx 反向代理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-30 02:31:24" itemprop="dateCreated datePublished" datetime="2020-12-30T02:31:24+08:00">2020-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>反向代理：reverse proxy，指的是代理外网用户的请求到内部指定的服务器，并将数据返回给用户的一种方式，这是用的比较多的一种方式</p>
<p>nginx 除了可以在企业提供高性能的 web 服务之外，还可以将 nginx 本身不具备的请求通过某种预定义的协议转发至其他服务器处理，不同的协议就是 nginx 服务器进行通信的一种规范，主要在不同的场景使用以下模块实现不同的功能</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将客户端的请求以http协议转发至指定服务器进行处理</span></span><br><span class="line"><span class="attribute">ngx_http_proxy_module</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许定义一组服务器。它们可以在指令proxy_pass、 fastcgi_pass和 memcached_pass中被引用到</span></span><br><span class="line">ngx_http_upstream_module</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将客户端的请求以tcp协议转发至指定服务器处理</span></span><br><span class="line">ngx_stream_proxy_module</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将客户端对php的请求以fastcgi协议转发至指定服务器助理</span></span><br><span class="line">ngx_http_fastcgi_module</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将客户端对Python的请求以uwsgi协议转发至指定服务器处理</span></span><br><span class="line">ngx_http_uwsgi_module</span><br></pre></td></tr></table></figure>

<p>逻辑调用关系：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1609307812887.png"></p>
<p>生成环境部署结构：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1609307837687.png"></p>
<p>访问逻辑图：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1609307876086.png"></p>
<h2 id="http-反向代理"><a href="#http-反向代理" class="headerlink" title="http 反向代理"></a>http 反向代理</h2><h3 id="反向代理配置参数"><a href="#反向代理配置参数" class="headerlink" title="反向代理配置参数"></a>反向代理配置参数</h3><ul>
<li><p><strong>proxy_pass</strong></p>
<p>设置后端服务器的协议和地址，协议支持 http 和 https，地址既可以是域名也可以是 ip，还可以配置端口</p>
<blockquote>
<p>语法: proxy_pass URL;<br>默认值: —<br>上下文: location, if in location, limit_except</p>
</blockquote>
<p>URL 分为两种：结尾加”&#x2F;“和结尾不加”&#x2F;“，如果不加”&#x2F;“，proxy_pass 类似 root，如果加”&#x2F;“，proxy_pass 类似 alias</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">location /web &#123;</span><br><span class="line"> <span class="comment"># http://to2b.cn/web/index.html ==&gt; http://127.0.0.0.1:8080/web/index.html</span></span><br><span class="line"> proxy_pass http://127.0.0.1:8080</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /web &#123;</span><br><span class="line"> <span class="comment"># http://to2b.cn/web/index.html ==&gt; http://127.0.0.0.1:8080/index.html</span></span><br><span class="line"> proxy_pass http://127.0.0.1:8080/</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果location定义uri时使用了正则表达式模式（包括~和~*），则结尾不能加&quot;/&quot;</span></span><br><span class="line">location ~|~* /uri/ &#123;</span><br><span class="line"> proxy_pass http://host:port;	<span class="comment"># proxy_pass后面的url 不能加/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_hide_header</strong></p>
<p>nginx 作为反向代理服务器时，在返回给客户端 http 响应时，隐藏后端服务器响应头的信息</p>
<blockquote>
<p>语法: proxy_hide_header field;<br>默认值: —<br>上下文: http, server, location</p>
</blockquote>
<p>示例：隐藏后端服务器的 ETag 首部字段</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /web &#123;</span><br><span class="line"> <span class="attribute">index</span> index.html;</span><br><span class="line"> <span class="attribute">proxy_pass</span> http://10.0.0.18:8080/;</span><br><span class="line"> <span class="attribute">proxy_hide_header</span> ETag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_pass_header</strong></p>
<p>允许传送<a target="_blank" rel="noopener" href="http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_proxy_module.html#proxy_hide_header">被屏蔽</a>的后端服务器响应头到客户端。</p>
<p>默认 nginx 在响应报文中不传递后端服务器的首部字段 Date, Server, X-Pad, X-Accel 等参数，如果要传递的话则要使用<code>proxy_pass_header field</code>声明将后端服务器返回的值传递给客户端</p>
<p>field 首部字段大小不敏感</p>
<blockquote>
<p>语法: proxy_pass_header field;<br>默认值: —<br>上下文: http, server, location</p>
</blockquote>
</li>
<li><p><strong>proxy_pass_request_body</strong></p>
<p>是否向后端服务器发送 HTTP 实体部分，默认开启</p>
<blockquote>
<p>Syntax: proxy_pass_request_body on | off;<br>Default: proxy_pass_request_body on;<br>Context: http, server, location</p>
</blockquote>
</li>
<li><p><strong>proxy_pass_request_headers</strong></p>
<p>是否将客户端的请求头部转发给后端服务器</p>
<blockquote>
<p>Syntax: proxy_pass_request_headers on | off;<br>Default: proxy_pass_request_headers on;<br>Context: http, server, location</p>
</blockquote>
</li>
<li><p><strong>proxy_set_header</strong></p>
<p>可更改或添加客户端的请求头部信息内容并转发至后端服务器，比如在后端服务器想要获取客户端的真实 IP 的时候，就要更改每一个报文的头部</p>
<blockquote>
<p>语法: proxy_set_header field value;<br>默认值: proxy_set_header Host $proxy_host;<br>proxy_set_header Connection close;<br>上下文: http, server, location</p>
</blockquote>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_connect_timeout</strong></p>
<p>配置 nginx 服务器与后端服务器尝试建立连接的超时时间，默认为 60 秒，超时会返回客户端 504 响应码</p>
<blockquote>
<p>语法: proxy_connect_timeout time;<br>默认值: proxy_connect_timeout 60s;<br>上下文: http, server, location</p>
</blockquote>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_connect_timeout</span> <span class="number">6s</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_read_timeout</strong></p>
<p>定义从后端服务器读取响应的超时。此超时是指相邻两次读操作之间的最长时间间隔，而不是整个响应传输完成的最长时间。如果后端服务器在超时时间段内没有传输任何数据，连接将被关闭</p>
<blockquote>
<p>语法: proxy_read_timeout time;<br>默认值: proxy_read_timeout 60s;<br>上下文: http, server, location</p>
</blockquote>
</li>
<li><p><strong>proxy_send_timeout</strong></p>
<p>定义向后端服务器传输请求的超时。此超时是指相邻两次写操作之间的最长时间间隔，而不是整个请求传输完成的最长时间。如果后端服务器在超时时间段内没有接收到任何数据，连接将被关闭</p>
<blockquote>
<p>语法: proxy_send_timeout time;<br>默认值: proxy_send_timeout 60s;<br>上下文: http, server, location</p>
</blockquote>
</li>
<li><p><strong>proxy_http_version</strong></p>
<blockquote>
<p>语法: proxy_http_version 1.0 | 1.1;<br>默认值: proxy_http_version 1.0;<br>上下文: http, server, location</p>
</blockquote>
<p>设置代理使用的 HTTP 协议版本。默认使用的版本是 1.0，而 1.1 版本则推荐在使用 keepalive 连接时一起使用</p>
</li>
<li><p><strong>proxy_ignore_client_abort</strong></p>
<p>决定当客户端在响应传输完成前就关闭连接时，nginx 是否应关闭后端连接，默认为 off</p>
<p>当客户端网络中断请求时，nginx 服务器中断其对后端服务器的请求。即如果设置 on 开启，服务器会忽略客户端中断并一直等着代理服务执行返回，如果设置 off，则客户端中断后 Nginx 也会中断客户端请求并立即记录 499 日志</p>
<blockquote>
<p>语法: proxy_ignore_client_abort on | off;<br>默认值: proxy_ignore_client_abort off;<br>上下文: http, server, location</p>
</blockquote>
</li>
<li><p><strong>proxy_headers_hash_bucket_size</strong></p>
<p>当配置了 proxy_hide_header 和 proxy_set_header 的时候，用于设置 nginx 保存 HTTP 报文头的 hash 表的上限，默认 64 字节</p>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_headers_hash_bucket_size</span> <span class="number">128</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_headers_hash_max_size</strong></p>
<p>设置 proxy_headers_hash_bucket_size 的最大可用空间，默认 512 字节</p>
</li>
<li><p><strong>server_names_hash_bucket_size</strong></p>
<p>server_name hash 表申请空间大小</p>
</li>
<li><p><strong>server_names_hash_max_size</strong></p>
<p>设置服务器名称 hash 表的上限大小</p>
</li>
</ul>
<h3 id="缓存-proxy-buffering-和-proxy-cache"><a href="#缓存-proxy-buffering-和-proxy-cache" class="headerlink" title="缓存 proxy_buffering 和 proxy_cache"></a>缓存 proxy_buffering 和 proxy_cache</h3><p>为了方便，我们定义三个角色：A 客户端 browser、B 代理服务器 Nginx，C 被代理服务器 PHP</p>
<p><strong>proxy_buffering</strong>：缓冲，实现被代理服务器的数据和客户端的请求异步，Ａ发起请求到Ｂ，Ｂ再去请求Ｃ，Ｃ反馈的数据先到 B 的 buffer 上</p>
<p><strong>proxy_cache</strong>：缓存，B 将从 C 获取到的数据缓存起来，之后 A 再请求时，直接将缓存的数据返回，而不必再向 C 去获取</p>
<h4 id="缓冲"><a href="#缓冲" class="headerlink" title="缓冲"></a>缓冲</h4><ul>
<li><p><strong>proxy_buffering</strong></p>
<p>开启缓冲，默认开启，如果不开启，C 返回的数据实时的通过 B 发送给 A</p>
<p>proxy_buffering 如果设置为 off，proxy_buffers 和 proxy_busy_buffers_size 这两个指令将会失效</p>
</li>
<li><p><strong>proxy_buffers</strong></p>
<p>设置 B 的缓冲区占用的 buffer 的个数和每个 buffer 的大小，所以缓冲区的大小为这两个数字的乘积</p>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffers</span> <span class="number">8</span> <span class="number">4k</span>;  <span class="comment"># 缓冲区总的大小为32k</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_busy_buffers_size</strong></p>
<p>proxy_busy_buffers_size 通常设置为两个 buffer 的大小，示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_busy_buffers_size</span> <span class="number">8k</span>;</span><br></pre></td></tr></table></figure>

<p>上例中，proxy_busy_buffers_size 设置为 8K，如果返回的数据小于 8K，则 B 从 C 请求的数据全部到位后，一次性返回给 A；如果返回的数据大于 8K，则 B 从 C 请求的数据分每次 8K 返回给 A，例如一共 20K 数据，分 8K、8K、4K 三次返回给 A</p>
</li>
<li><p><strong>proxy_buffer_size</strong></p>
<p>该参数用来设置一个特殊 buffer 大小，C 到 B 的第一部分相应数据就存在这个 buffer 中，通常是 header，如果该参数设置太小，会出现 502 错误，不论 proxy_buffering，是否生效，proxy_buffer_size 都生效</p>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffer_size</span> <span class="number">4k</span>; <span class="comment"># 通常设置为单个buffer的大小</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_temp_path</strong></p>
<p>缓冲区的容量毕竟有限，如果并发请求太多，响应的数据量太大，超出缓冲区的数据会储存在临时目录下</p>
<p>proxy_temp_path 定义临时目录</p>
<blockquote>
<p>语法: proxy_temp_path path [level1 [level2 [level3]]];<br>默认值: proxy_temp_path proxy_temp;<br>上下文: http, server, location</p>
</blockquote>
<p>至多设置三层子目录，目录的命名规则和 client_body_temp_path 一样</p>
</li>
<li><p><strong>proxy_max_temp_file_size</strong></p>
<p>临时文件的最大容量，默认 1024m，也就是 1G</p>
</li>
<li><p><strong>proxy_temp_file_write_size</strong></p>
<p>每次写入临时文件的数据量， 通常和 proxy_busy_buffers_size 设置的值一样，两个 buffer 的大小</p>
</li>
</ul>
<h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><ul>
<li><p><strong>proxy_cache</strong></p>
<p>指定用于页面缓存的共享内存。同一块共享内存可以在多个地方使用。off 参数可以屏蔽从上层配置继承的缓存功能</p>
<blockquote>
<p>语法: proxy_cache zone | off;<br>默认值: proxy_cache off;<br>上下文: http, server, location</p>
</blockquote>
<p>zone 是缓存区域的名称，需要 proxy_cache_path 事先定义</p>
</li>
<li><p>proxy_cache_path</p>
<blockquote>
<p>语法: proxy_cache_path path [levels&#x3D;levels] keys_zone&#x3D;name:size [inactive&#x3D;time] [max_size&#x3D;size] [loader_files&#x3D;number] [loader_sleep&#x3D;time] [loader_threshold&#x3D;time];<br>默认值: —<br>上下文: http</p>
</blockquote>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_path</span> /var/cache/nginx/proxy_cache levels=<span class="number">1</span>:<span class="number">2</span>:<span class="number">2</span> keys_zone=proxycache:<span class="number">20m</span> inactive=<span class="number">120s</span> max_size=<span class="number">1g</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /var/cache/nginx/proxy_cache  定义缓存保存路径，proxy_cache会自动创建</span></span><br><span class="line"><span class="comment"># levels=1:2:2  定义缓存目录结构层次，1:2:2可以生成2^4x2^8x2^8=2^20=1048576个目录</span></span><br><span class="line"><span class="comment"># keys_zone=proxycache:20m  内存中缓存的大小，主要用于存放key和metadata</span></span><br><span class="line"><span class="comment"># inactive=120s  缓存有效时间</span></span><br><span class="line"><span class="comment"># max_size=1g 最大磁盘占用空间，磁盘存入文件内容的缓存空间最大值</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_cache_key</strong></p>
<p>定义如何生成缓存的键，默认值就挺好，一般不用设置</p>
<blockquote>
<p>语法: proxy_cache_key string;<br>默认值: proxy_cache_key $scheme$proxy_host$request_uri;<br>上下文: http, server, location</p>
</blockquote>
</li>
<li><p><strong>proxy_cache_valid</strong></p>
<p>为不同的响应状态码设置不同的缓存时间</p>
<blockquote>
<p>语法: proxy_cache_valid [code …] time;<br>默认值: —<br>上下文: http, server, location</p>
</blockquote>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">10m</span>;</span><br><span class="line"><span class="attribute">proxy_cache_valid</span> <span class="number">404</span> <span class="number">1m</span>;</span><br><span class="line"><span class="attribute">proxy_cache_valid</span> any <span class="number">1m</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_cache_use_stale</strong></p>
<p>如果后端服务器出现状况，nginx 可以使用过期的响应缓存。这条指令就是定义何种条件下允许开启此机制</p>
<blockquote>
<p>语法: proxy_cache_use_stale error | timeout | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_404 | off …;<br>默认值: proxy_cache_use_stale off;<br>上下文: http, server, location</p>
</blockquote>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_use_stale</span> <span class="literal">error</span> http_502 http_503;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>proxy_cache_methods</strong></p>
<p>对哪些客户端请求方法对应的响应进行缓存，虽然 GET 和 HEAD 方法总是被缓存，但是建议显式的指定</p>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_methods</span> GET | HEAD | POST ...;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="添加头部报文信息"><a href="#添加头部报文信息" class="headerlink" title="添加头部报文信息"></a>添加头部报文信息</h3><p>基于模块 ngx_http_headers_module，可以实现对后端服务器响应给客户端的报文中添加指定的响应首部字段</p>
<blockquote>
<p>Syntax: add_header name value [always];<br>Default: —<br>Context: http, server, location, if in location</p>
</blockquote>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> X-Via <span class="variable">$server_addr</span>;      <span class="comment"># 当前nginx主机的IP</span></span><br><span class="line"><span class="attribute">add_header</span> X-Cache <span class="variable">$upstream_cache_status</span>;   <span class="comment"># 是否缓存命中</span></span><br><span class="line"><span class="attribute">add_header</span> X-Accel <span class="variable">$server_name</span>;     <span class="comment"># 客户访问的FQDN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加自定义响应信息的尾部，使用较少,1.13.2版后支持</span></span><br><span class="line"><span class="attribute">add_trailer</span> name value [always];</span><br></pre></td></tr></table></figure>

<h3 id="反向代理高级应用"><a href="#反向代理高级应用" class="headerlink" title="反向代理高级应用"></a>反向代理高级应用</h3><p>基于 ngx_http_upstream_module 模块，实现服务器分组转发、权重分配、状态监测、调度算法等高级功能</p>
<ul>
<li><p><strong>upstream</strong></p>
<p>定义一组服务器。 这些服务器可以监听不同的端口。 而且，监听在 TCP 和 UNIX 域套接字的服务器可以混用</p>
<blockquote>
<p>语法: upstream name { … }<br>默认值: —<br>上下文: http</p>
</blockquote>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com weight=<span class="number">5</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>       max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>server</strong></p>
<p>在 upstream 内，至少要有一个 server 服务器配置</p>
<blockquote>
<p>语法: server address [parameters];<br>默认值: —<br>上下文: upstream</p>
</blockquote>
<p>定义服务器的地址和其他参数，地址可以是域名、ip、unix 套接字，如果没有指定端口，默认 80 端口</p>
<p>如果一个域名解析到了多个 ip，本质就是在 upstream 定义了多个 server</p>
<p>parameters：</p>
<ul>
<li>weight&#x3D;number：设定服务器的权重，默认是 1</li>
<li>max_conns&#x3D;number：给当前 server 设置最大活动链接数，默认为 0 表示没有限制</li>
<li>max_fails&#x3D;number：fail_timeout 规定时间内，对后端服务器连续监测失败的次数，超过则标记为不可用，默认为 1 次，当客户端访问时，才会利用 TCP 触发对探测后端服务器健康性检查，而非周期性的探测</li>
<li>fail_timeout&#x3D;time：fail_timeout 时间内，连续监测失败 max_fails 次；或者 fail_timeout 时间内，一直监测失败，则标记服务器不可用</li>
<li>backup：标记为备用服务器，当其他服务器都不可用时，才会启用此服务器</li>
<li>down：标记为 down 状态</li>
<li>resolve：如果 server 定义的是主机名，当 A 记录发生变化会自动应用新 IP 而不用重启 Nginx</li>
<li>…</li>
</ul>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com weight=<span class="number">5</span>;</span><br><span class="line">    <span class="comment"># 30s内，对后端服务器连续监测失败3次，标记次服务器不可用</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>       max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line">    <span class="attribute">server</span> backup1.example.com:<span class="number">8080</span> backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>hash</strong></p>
<blockquote>
<p>Syntax: hash key [consistent];<br>Default: —<br>Context: upstream</p>
</blockquote>
<p>基于指定的 key 做 hash 计算，key 来自请求报文中首部字段或者 URI，consistent 定义使用一致性 hash 运算，一<br>致性 hash 基于取模运算，适用于后端是 Cache 服务器（如 varnish）时使用</p>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hash</span> <span class="variable">$request_uri</span> consistent; <span class="comment"># 基于用户请求的uri做hash</span></span><br><span class="line"><span class="attribute">hash</span> <span class="variable">$cookie_sessionid</span>;  <span class="comment"># 基于cookie中的sessionid这个key进行hash调度,实现会话绑定</span></span><br></pre></td></tr></table></figure>

<p><img data-src="//img.to2b.cn/blog/ljk/1609384791006.png"></p>
</li>
<li><p><strong>ip_hash</strong></p>
<p>源地址 hash 调度方法，基于的客户端的 remote_addr(源地址 IPv4 的前 24 位或整个 IPv6 地址)做 hash 计算，以实现会话保持</p>
</li>
<li><p><strong>least_conn</strong></p>
<p>最少连接调度算法，优先将客户端请求调度到当前连接最少的后端服务器,相当于 LVS 中的 WLC</p>
</li>
</ul>
<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> webserver &#123;</span><br><span class="line">        <span class="comment">#hash $request_uri consistent;</span></span><br><span class="line">        <span class="comment">#hash $cookie_sessionid</span></span><br><span class="line">        <span class="comment">#ip_hash;</span></span><br><span class="line">        <span class="comment">#least_conn;</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">10.0.0.101:80</span> weight=<span class="number">1</span> fail_timeout=<span class="number">5s</span> max_fails=<span class="number">3</span>; <span class="comment">#后端服务器状态监测</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">10.0.0.102:80</span> weight=<span class="number">1</span> fail_timeout=<span class="number">5s</span> max_fails=<span class="number">3</span>;</span><br><span class="line">        <span class="comment">#server 127.0.0.1:80 weight=1 fail_timeout=5s max_fails=3 backup;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.magedu.org;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">index</span> index.html index.php;</span><br><span class="line">        <span class="attribute">root</span> /data/nginx/html/pc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /web &#123;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://webserver/; <span class="comment"># 结尾加&quot;/&quot;，proxy_pass类似alias</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="反向代理客户端-IP-透传"><a href="#反向代理客户端-IP-透传" class="headerlink" title="反向代理客户端 IP 透传"></a>反向代理客户端 IP 透传</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609413884125.png"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一个代理服务器 10.0.0.8</span></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"> <span class="attribute">proxy_pass</span> http://10.0.0.18;</span><br><span class="line"> <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二个代理服务器 10.0.0.18</span></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"> <span class="attribute">proxy_pass</span> http://10.0.0.28;</span><br><span class="line"> <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三个服务器 10.0.0.28，最终会接收到客户端和中间两个代理服务器的ip</span></span><br></pre></td></tr></table></figure>

<h4 id="基于-Cookie-实现会话绑定"><a href="#基于-Cookie-实现会话绑定" class="headerlink" title="基于 Cookie 实现会话绑定"></a>基于 Cookie 实现会话绑定</h4><p>nginx 把客户端的请求轮询到不同的服务器，对于已经登录的客户端（用户信息储存在 cookie），就不适合轮询了，应该始终访问储存登录信息的那台服务器</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"> <span class="section">upstream</span> websrvs &#123;</span><br><span class="line">  <span class="attribute">hash</span> <span class="variable">$cookie_PHPSESSID</span>; <span class="comment"># PHPSESSID是cookie的key的名称</span></span><br><span class="line">  <span class="attribute">server</span> <span class="number">10.0.0.101:80</span> weight=<span class="number">2</span>;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">10.0.0.102:80</span> weight-<span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://websrvs;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="tcp-负载均衡"><a href="#tcp-负载均衡" class="headerlink" title="tcp 负载均衡"></a>tcp 负载均衡</h2><p>基于 ngx_stream_proxy_module 模块，允许通过 TCP、UDP、和 unix 域套接字代理数据流，nginx1.9.0 版本支持</p>
<p>编译安装需要添加 –with-stream 编译选项</p>
<h3 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h3><p>没有在官方文档中找到这个参数，但是它确实存在，和 http 同级别，位于 main 上下文</p>
<h3 id="负载均衡-redis"><a href="#负载均衡-redis" class="headerlink" title="负载均衡 redis"></a>负载均衡 redis</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609419383042.png"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> redis_server &#123;</span><br><span class="line">        <span class="comment">#hash $remote_addr consistent;</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">10.0.0.18:6379</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">10.0.0.28:6379</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">10.0.0.8:6379</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">3s</span>;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">3s</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> redis_server; <span class="comment"># server处于stream上下文，这里proxy_pass的服务器组没有http</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡-mysql"><a href="#负载均衡-mysql" class="headerlink" title="负载均衡 mysql"></a>负载均衡 mysql</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609419396346.png"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> mysql_server &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">10.0.0.18:3306</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">10.0.0.8:3306</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">6s</span>;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">15s</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> mysql_server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h2><h3 id="CGI-和-FastCGI"><a href="#CGI-和-FastCGI" class="headerlink" title="CGI 和 FastCGI"></a>CGI 和 FastCGI</h3><p>最早的 web 服务器只能处理静态文件，对于 php、java 这样的动态语言文件，apache 实现的方式是打补丁，nginx 则通过某种特定的协议将客户端请求转发给语言解析器，这个特定的协议就是 CGI（通用网关接口 common gateway interface），语言解析器新建进程处理请求</p>
<p>CGI 协议解决了语言解析器和 web 服务器之间通讯的问题，但是它的效率太低，因为每处理一个请求，就要新建进程，处理完之后就销毁进程，而 FastCGI 解决了这个问题，每次处理完请求后不会关闭进程，等待处理下一个进程，直到超时没有任务才会被销毁</p>
<h3 id="php-fpm"><a href="#php-fpm" class="headerlink" title="php-fpm"></a>php-fpm</h3><p>FastCGI Process Manager，FastCGI 进程管理器，是一个实现了 FastCGI 的程序，提供进程管理功能，进程包括 master 进程和 worker 进程。master 进程只有一个，负责监听端口，接受来自 web server 的请求。worker 进程一般会有多个，<strong>每个进程中会嵌入一个 PHP 解析器，进行 PHP 代码的处理</strong></p>
<h3 id="FastCGI-配置指令"><a href="#FastCGI-配置指令" class="headerlink" title="FastCGI 配置指令"></a>FastCGI 配置指令</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastcgi_pass</span> address:port; <span class="comment"># 请求转发到后端服务器，指定后端服务器的地址和端口</span></span><br><span class="line"><span class="attribute">fastcgi_index</span> name;  <span class="comment"># 默认的主页资源</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> parameter value [if_not_empty]; <span class="comment"># 设置传递的参数</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> REMOTE_ADDR <span class="variable">$remote_addr</span>; <span class="comment">#客户端源IP</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> REMOTE_PORT <span class="variable">$remote_port</span>; <span class="comment">#客户端源端口</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> SERVER_ADDR <span class="variable">$server_addr</span>; <span class="comment">#请求的服务器IP地址</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> SERVER_PORT <span class="variable">$server_port</span>; <span class="comment">#请求的服务器端口</span></span><br><span class="line"><span class="attribute">fastcgi_param</span> SERVER_NAME <span class="variable">$server_name</span>; <span class="comment">#请求的server name</span></span><br></pre></td></tr></table></figure>

<h3 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 静态文件</span></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://10.0.0.28;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 动态文件</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /data/php;</span><br><span class="line">    <span class="attribute">fastcgi_pass</span> <span class="number">10.0.0.18:9000</span>;</span><br><span class="line">    <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">    <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/php$fastcgi_script_name;</span></span><br><span class="line">    <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Nginx/4.Nginx%20Rewrite%20%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Nginx/4.Nginx%20Rewrite%20%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">4.Nginx Rewrite 相关功能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-29 21:41:04" itemprop="dateCreated datePublished" datetime="2020-12-29T21:41:04+08:00">2020-12-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>rewrite 是 nginx 服务器的重要功能之一，用于实现 URL 的重写，URL 的重写是非常有用的功能，比如它可以在我们改变网站结构之后，不需要客户端修改原来的书签，也无需其他网站修改我们的链接，就可以设置为访问，另外还可以在一定程度上提高网站的安全性</p>
<p>基于 ngx_http_rewrite_module 模块解析和处理 rewrite 请求，依赖 PCRE，因此编译之前要先安装 PCRE 库</p>
<h2 id="ngx-http-rewrite-module-模块指令"><a href="#ngx-http-rewrite-module-模块指令" class="headerlink" title="ngx_http_rewrite_module 模块指令"></a>ngx_http_rewrite_module 模块指令</h2><p>ngx_http_rewrite_module 模块指令：if、set、break、return、rewrite、rewrite_log</p>
<p>下文统称为 <strong>rewrite 指令集</strong></p>
<h2 id="if-指令"><a href="#if-指令" class="headerlink" title="if 指令"></a>if 指令</h2><p>条件判断，根据判断结果选择不同的 nginx 配置，可以配置在 server 或 location 块中，只能做单次判断，不支持使用 if else 这样的多重判断</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (condition) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>使用正则表达式对变量进行匹配，匹配成功时条件为 true，否则为 fasle，变量与表达式之间使用以下符号链接：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=     <span class="comment"># 变量和字符串比较，相等为true</span></span><br><span class="line">!=    <span class="comment"># 变量和字符串比较，不相等为true</span></span><br><span class="line">~    <span class="comment"># 通过正则表达式匹配，满足匹配条件为真，区分大小写</span></span><br><span class="line">!~    <span class="comment"># 通过正则表达式匹配，不满足匹配条件为真，区分大小写</span></span><br><span class="line"></span><br><span class="line">~*    <span class="comment"># 通过正则表达式匹配，满足匹配条件为真，不区分大小写</span></span><br><span class="line">!~*    <span class="comment"># 通过正则表达式匹配，不满足匹配条件为真，不区分大小写</span></span><br><span class="line"></span><br><span class="line">-<span class="attribute">f</span> 和 !-f  <span class="comment"># 判断请求的文件是否存在</span></span><br><span class="line">-f 和 !-d  <span class="comment"># 判断请求的目录是否存在</span></span><br><span class="line">-x 和 ! -x  <span class="comment"># 判断文件是否可执行</span></span><br><span class="line">-e 和 !-e  <span class="comment"># 判断请求的文件或目录是否存在(包括文件，目录，软链接)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：</span></span><br><span class="line"><span class="comment"># 变量值为空字符或者0为false，其他情况为true</span></span><br><span class="line"><span class="comment"># nginx1.0.1版本之前，变量值不能以0开头则为false，例如 $var=0xxx 返回false</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /main &#123;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">default_type</span> text/html;</span><br><span class="line">    <span class="attribute">if</span> ( <span class="variable">$scheme</span> = http )&#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&quot;if-----&gt; <span class="variable">$scheme</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">if</span> ( <span class="variable">$scheme</span> = https )&#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&quot;if ----&gt; <span class="variable">$scheme</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#if (-f $request_filename) &#123;</span></span><br><span class="line">    <span class="comment"># echo &quot;$request_filename is exist&quot;;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">    <span class="attribute">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&quot;<span class="variable">$request_filename</span> is not exist&quot;</span>;</span><br><span class="line">        <span class="comment">#return 409;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="set-指令"><a href="#set-指令" class="headerlink" title="set 指令"></a>set 指令</h2><p>变量赋值：<code>set $var value</code>，value 可以是字符串，可以是变量，也可以是两者结合</p>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /main &#123;</span><br><span class="line">    <span class="attribute">root</span> /data/nginx/html/pc;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">default_type</span> text/html;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$name</span> magedu;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$my_port</span> <span class="variable">$server_port</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$my_port</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="break-指令"><a href="#break-指令" class="headerlink" title="break 指令"></a>break 指令</h2><p>break 用于 server、location、if</p>
<p>break 的作用是中断重定向，具体表现就是：</p>
<ul>
<li>server 或 if 中使用 break：break 后面的 rewrite 指令集全部失效，注意 location 不属于 rewrite 指令集，location 之外的 break 影响不到 location 内的指令</li>
<li>location 中使用 break：不影响此 location 中后面的所有指令，一般搭配 rewrite 指令使用，直接将重定向的结果返回给客户端</li>
</ul>
<h3 id="break-和-last"><a href="#break-和-last" class="headerlink" title="break 和 last"></a>break 和 last</h3><p>两者通常都搭配 rewrite 指令使用，区别在于：</p>
<p>break 不会再去匹配其他 location，而是直接将重定向的结果返回给客户端，而 last 则继续重定，返回最后一个 location 的匹配结果给客户端</p>
<p>示例 1：break</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /last &#123;</span><br><span class="line"> <span class="attribute">root</span> /data/nginx;	<span class="comment"># 这里只能用root，alias不能和rewrite搭配</span></span><br><span class="line"> <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="comment"># /data/nginx/last重定向到/data/nginx/test1，将/data/nginx/test1中的内容返回给客户端</span></span><br><span class="line"> <span class="attribute">rewrite</span><span class="regexp"> ^/last/(.*)</span> /test1/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例 2：last</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /test1 &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/html;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;test1&quot;</span>;   <span class="comment"># 最终返回客户端的结果</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /last &#123;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/last/(.*)</span> /test1/<span class="variable">$1</span> <span class="literal">last</span>; <span class="comment"># 重定向到location /test1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="return-指令"><a href="#return-指令" class="headerlink" title="return 指令"></a>return 指令</h2><p>完成对请求的处理，直接向客户端返回响应状态码，return 后面的所有指令都不被执行</p>
<blockquote>
<p>语法: return code [text];<br>return code URL;<br>return URL;<br>默认值: —<br>上下文: server, location, if</p>
</blockquote>
<h2 id="rewrite-log-指令"><a href="#rewrite-log-指令" class="headerlink" title="rewrite_log 指令"></a>rewrite_log 指令</h2><p>设置是否记录 ngx_http_rewrite_module 模块日志记录到 error_log 日志文件当中</p>
<blockquote>
<p>语法: rewrite_log on | off;<br>默认值: rewrite_log off;<br>上下文: http, server, location, if</p>
</blockquote>
<h2 id="rewrite-指令"><a href="#rewrite-指令" class="headerlink" title="rewrite 指令"></a>rewrite 指令</h2><p>通过正则表达式的匹配来改变 URI，可以同时存在一个或多个指令，按照顺序依次对 URI 进行匹配，rewrite 主要是针对用户请求的 URL 或者是 URI 做具体处理</p>
<blockquote>
<p>语法: rewrite regex replacement [flag];<br>默认值: —<br>上下文: server, location, if</p>
</blockquote>
<p>注意：如果在同一级配置块中存在多个 rewrite 规则，那么会自上而下逐个检查;被某条件规则替换完成后，会重新一轮的替换检查，隐含有循环机制，但不超过 10 次；如果超过，提示 500 响应码，[flag]所表示的标志位用于控制此循环机制</p>
<p>要注意避免出现超过十次以及 URL 重写后返回错误的给用户</p>
<p>如果替换后的 URL 是以 http:&#x2F;&#x2F;或 https:&#x2F;&#x2F;开头，则替换结果会直接以重定向返回给客户端, 即永久重定向 301</p>
<p>302：浏览器不会缓存当前域名的解析记录<br>301：浏览器会缓存永久重定向的 DNS 解析记录</p>
<h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><p>rewrtie 有四种不同的 flag，分别是 redirect（临时重定向 302）、permanent（永久重定向 301）、break 和 last。其中前两种是跳转型的 flag，后两种是代理型</p>
<ul>
<li>跳转型指由客户端浏览器重新对新地址进行请求</li>
<li>代理型是在 WEB 服务器内部实现跳转</li>
</ul>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.    <span class="comment"># 匹配除换行符以外的任意字符</span></span><br><span class="line">\<span class="attribute">w</span>    <span class="comment"># 匹配字母或数字或下划线或汉字</span></span><br><span class="line">\s    <span class="comment"># 匹配任意的空白符</span></span><br><span class="line">\d    <span class="comment"># 匹配数字</span></span><br><span class="line">\b    <span class="comment"># 匹配单词的开始或结束</span><span class="regexp"></span></span><br><span class="line"><span class="regexp">^</span>    <span class="comment"># 匹配字付串的开始</span></span><br><span class="line">$    <span class="comment"># 匹配字符串的结束</span></span><br><span class="line">*    <span class="comment"># 匹配重复零次或更多次</span></span><br><span class="line">+    <span class="comment"># 匹配重复一次或更多次</span></span><br><span class="line">?    <span class="comment"># 匹配重复零次或一次</span></span><br><span class="line">(n)   <span class="comment"># 匹配重复n次</span></span><br><span class="line">&#123;n,&#125;   <span class="comment"># 匹配重复n次或更多次</span></span><br><span class="line">&#123;n,m&#125;   <span class="comment"># 匹配重复n到m次</span></span><br><span class="line">*?    <span class="comment"># 匹配重复任意次，但尽可能少重复</span></span><br><span class="line">+?    <span class="comment"># 匹配重复1次或更多次，但尽可能少重复</span></span><br><span class="line">??    <span class="comment"># 匹配重复0次或1次，但尽可能少重复</span></span><br><span class="line">&#123;n,m&#125;?   <span class="comment"># 匹配重复n到m次，但尽可能少重复</span></span><br><span class="line">&#123;n,&#125;?   <span class="comment"># 匹配重复n次以上，但尽可能少重复</span></span><br><span class="line">\<span class="attribute">W</span>    <span class="comment"># 匹配任意不是字母，数字，下划线，汉字的字符</span></span><br><span class="line">\S    <span class="comment"># 匹配任意不是空白符的字符</span></span><br><span class="line">\D    <span class="comment"># 匹配任意非数字的字符</span></span><br><span class="line">\B    <span class="comment"># 匹配不是单词开头或结束的位置</span></span><br><span class="line">[^x]   <span class="comment"># 匹配除了x以外的任意字符</span></span><br><span class="line">[^magedu]  <span class="comment"># 匹配除了magedu 这几个字母以外的任意字符</span></span><br></pre></td></tr></table></figure>

<h3 id="案例：自动跳转-https"><a href="#案例：自动跳转-https" class="headerlink" title="案例：自动跳转 https"></a>案例：自动跳转 https</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$scheme</span> = http )&#123;       <span class="comment"># 如果没有加条件判断，会导致死循环</span></span><br><span class="line"> <span class="attribute">rewrite</span> / https://<span class="variable">$host</span> <span class="literal">redirect</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例：判断文件是否存在"><a href="#案例：判断文件是否存在" class="headerlink" title="案例：判断文件是否存在"></a>案例：判断文件是否存在</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line"> <span class="attribute">rewrite</span> .* http://www.magedu.org/index.html; 	<span class="comment"># 实现客户端浏览器的302跳转</span></span><br><span class="line"> <span class="comment">#rewrite .* /index.html; 	# web服务器内部跳转</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h2><p>防盗链基于客户端携带的 referer 实现，referer 是记录打开一个页面之前记录是从哪个页面跳转过来的标记信息，如果别人只链接了自己网站图片或某个单独的资源，而不是打开了网站的整个页面，这就是盗链，referer 就是之前的那个网站域名，正常的 referer 信息有以下几种</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">none <span class="comment"># 请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息</span></span><br><span class="line">blocked <span class="comment"># 请求报文有referer首部，但无有效值，比如为空</span></span><br><span class="line">server_names <span class="comment"># referer首部中包含本主机名即nginx监听的server_name</span></span><br><span class="line">arbitrary_string <span class="comment"># 自定义指定字符串，但可使用\*作通配符。示例: \*.magedu.org www.magedu.\*</span></span><br><span class="line">regular expression <span class="comment"># 被指定的正则表达式模式匹配到的字符串，要使用~开头，例如：~.*\.magedu\.com</span></span><br></pre></td></tr></table></figure>

<h3 id="实现防盗链"><a href="#实现防盗链" class="headerlink" title="实现防盗链"></a>实现防盗链</h3><p>基于访问安全考虑，nginx 支持通过 ngx_http_referer_module 模块，检查访问请求的 referer 信息是否有效实现防盗链功能</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /images &#123;</span><br><span class="line">    <span class="attribute">alias</span> /data/images/;</span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> server_names lujinkai.cn ~\.baidu\.;    <span class="comment">#定义有效的referer</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Referer 请求头为指定值时，内嵌变量$invalid_referer 被设置为空字符串， 否则这个变量会被置成“1”。查找匹配时不区分大小写</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Nginx/3.Nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Nginx/3.Nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">3.Nginx高级配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-25 14:50:35" itemprop="dateCreated datePublished" datetime="2020-12-25T14:50:35+08:00">2020-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="状态页"><a href="#状态页" class="headerlink" title="状态页"></a>状态页</h2><p>状态页用于输出 nginx 的基本状态信息</p>
<p>基于 ngx_http_stub_status_module 模块实现，编译安装时需要添加 –with-http_stub_status_module 编译参数</p>
<p>注意：状态页显示的是整个服务器的状态，而非单独某个虚拟机的状态</p>
<p>输出信息示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active connections: 2</span><br><span class="line">server accepts handled requests</span><br><span class="line"> 35836 35836 27001</span><br><span class="line">Reading: 0 Writing: 1 Waiting: 1</span><br></pre></td></tr></table></figure>

<ul>
<li>Active connections：当前处于活动状态的客户端连接数，reading + writing + waiting<ul>
<li>Reading：正在读取客户端请求报文首部的连接的连接数，数值越大，说明排队现象严重，性能不足</li>
<li>Writing：正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大</li>
<li>Waiting：正在等待客户端发出请求的空闲连接数，如果开启 keep-alive，这个值等于 active – (reading+writing)</li>
</ul>
</li>
<li>server accepts handled requests：三个值分别对应 accepts、handled、requests<ul>
<li>accepts：Nginx 自启动后已经接受的客户端请求的总数</li>
<li>handled：Nginx 自启动后已经处理完成的客户端请求总数，通常等于 accepts，除非有因<br>worker_connections 限制等被拒绝的连接</li>
<li>requests：Nginx 自启动后客户端发来的总的请求数</li>
</ul>
</li>
</ul>
<h2 id="第三方模块"><a href="#第三方模块" class="headerlink" title="第三方模块"></a>第三方模块</h2><p>第三模块是对 nginx 的功能扩展，第三方模块需要在编译安装 Nginx 的时候使用参数–add-module&#x3D;PATH 指定路径添加，nginx 支持第三方模块需要从源码重新编译支持</p>
<p>范例：支持开源的 echo 模块 <a target="_blank" rel="noopener" href="https://github.com/openresty/echo-nginx-module">https://github.com/openresty/echo-nginx-module</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 src]$ git <span class="built_in">clone</span> https://github.com/openresty/echo-nginx-module.git</span><br><span class="line">[root@centos8 src]$ ./configure \</span><br><span class="line">--prefix=/user/local/nginx \</span><br><span class="line">...</span><br><span class="line">--add-module=/usr/local/src/echo-nginx-module <span class="comment"># 指定模块源代码路径</span></span><br><span class="line">[root@centos8 src]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># /apps/nginx/sbin/nginx -t</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#nginx -V</span></span><br></pre></td></tr></table></figure>

<h2 id="变量使用"><a href="#变量使用" class="headerlink" title="变量使用"></a>变量使用</h2><p>nginx 的变量可以在配置文件中引用，作为功能判断或者日志等场景使用</p>
<p>变量可以分为内置变量和自定义变量</p>
<p>内置变量是由 nginx 模块自带，通过变量可以获取到众多的与客户端访问相关的值</p>
<h3 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h3><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/varindex.html">http://nginx.org/en/docs/varindex.html</a></p>
<p><a target="_blank" rel="noopener" href="http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_core_module.html#variables">http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_core_module.html#variables</a></p>
<p>常用内置变量：</p>
<ul>
<li><p><code>$remote_addr</code>：客户端的公网 IP</p>
</li>
<li><p><code>$proxy_add_x_forwarded_for</code>：</p>
<p>X-Forwarded-For：简称 XFF，只有在通过 http 代理或者负载均衡服务器时才会添加该项</p>
<p>如果请求头中有 XFF，$proxy_add_x_forwarded_for 就是XXF头的值追加$remote_addr，所以，如果请求头中没有 XFF，$proxy_add_x_forwarded_for 就等于 $remote_addr</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># client1是真实的客户端ip，后面的是经过的代理或者负载均衡的ip，经过几个就会出现几个</span><br><span class="line"><span class="attribute">X-Forwarded-For</span><span class="punctuation">: </span>client, proxy1, proxy2</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例：</span></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; <span class="comment"># 实现ip透传</span></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://36.10.10.118:9015;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>$args</code>：url 中的 get 参数</p>
<p>例如 <a target="_blank" rel="noopener" href="http://ljk.cn/main/index.do?id=1&partner=search%EF%BC%8C$args%E5%B0%B1%E6%98%AFid=1&partner=search">http://ljk.cn/main/index.do?id=1&amp;partner=search，$args就是id=1&amp;partner=search</a></p>
</li>
<li><p><code>$document_root</code>：当前请求的<a target="_blank" rel="noopener" href="http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_core_module.html#root">root</a>指令或<a target="_blank" rel="noopener" href="http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_core_module.html#alias">alias</a>指令的配置</p>
</li>
<li><p><code>$document_uri</code>：和$uri 相同，当前请求中不包含参数的 URI</p>
<p>例如 <a target="_blank" rel="noopener" href="http://ljk.cn/main/index.do?id=1&partner=search%EF%BC%8C$document_uri%E5%B0%B1%E6%98%AF/main/index.do">http://ljk.cn/main/index.do?id=1&amp;partner=search，$document_uri就是/main/index.do</a></p>
</li>
<li><p><code>$host</code>：请求的 host 名称</p>
</li>
<li><p><code>$limit_rate</code>：limit_rate 项配置的网络速率，默认为 0</p>
</li>
<li><p><code>$remote_port</code>：客户端请求 Nginx 服务器时随机打开的端口，这是每个客户端自己的端口</p>
</li>
<li><p><code>$remote_user</code>：已经经过 Auth Basic Module 验证的用户名</p>
</li>
<li><p><code>$request_body_file</code>：做反向代理时发给后端服务器的本地资源的名称</p>
</li>
<li><p><code>$request_method</code>：请求资源的方式，GET&#x2F;PUT&#x2F;DELETE 等</p>
</li>
<li><p><code>$request_filename</code>：当前请求的资源文件的磁盘路径，由 root 或 alias 指令与 URI 请求生成的文件绝对路径，如:&#x2F;apps&#x2F;nginx&#x2F;html&#x2F;main&#x2F;index.html</p>
</li>
<li><p><code>$request_uri</code>：包含请求参数的原始 URI，不包含主机名，相当于:$document_uri?$args，例如如：&#x2F;main&#x2F;index.do?id&#x3D;20190221&amp;partner&#x3D;search</p>
</li>
<li><p><code>$scheme</code>：请求的协议，例如:http、https、ftp 等</p>
</li>
<li><p><code>$server_protocol</code>：保存了客户端请求资源使用的协议的版本，例如:HTTP&#x2F;1.0，HTTP&#x2F;1.1，HTTP&#x2F;2.0 等</p>
</li>
<li><p><code>$server_addr</code>：保存了服务器的 IP 地址</p>
</li>
<li><p><code>$server_name</code>：请求的服务器的主机名</p>
</li>
<li><p><code>$server_port</code>：请求的服务器的端口号</p>
</li>
<li><p><code>$http_&lt;name&gt;</code>：name 为任意请求报文首部字段，表示记录请求报文的首部字段，用下划线代替横线</p>
<p>示例：echo $http_User_Agent</p>
</li>
<li><p><code>$http_user_agent</code>：客户端浏览器的详细信息</p>
</li>
<li><p><code>$http_cookie</code>：客户端的 cookie 信息</p>
</li>
<li><p><code>$cookie_&lt;name&gt;</code>：name 为任意请求报文首部字部 cookie 的 key 名</p>
</li>
</ul>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /main &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/html;</span><br><span class="line">    <span class="attribute">echo</span> <span class="string">&quot;hello world,main--&gt;&quot;</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$remote_addr</span> ;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$args</span> ;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$document_root</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$document_uri</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$http_user_agent</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$http_cookie</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$request_filename</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$scheme</span>;</span><br><span class="line">    <span class="attribute">echo</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$document_uri</span>?<span class="variable">$args</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><blockquote>
<p>语法: set variable value;<br>默认值: —<br>上下文: server, location, if</p>
</blockquote>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> <span class="variable">$name</span> magedu;</span><br><span class="line"><span class="attribute">set</span> <span class="variable">$my_port</span> <span class="variable">$server_port</span>;</span><br></pre></td></tr></table></figure>

<h2 id="自定义访问日志"><a href="#自定义访问日志" class="headerlink" title="自定义访问日志"></a>自定义访问日志</h2><p>错误日志（error_log）一般只有一个，但是访问日志可以在不同的 server 中定义多个，access_log 指定日志的保存路径，log_format 指定日志的格式，格式中定义要保存的具体日志内容</p>
<p>访问日志由 ngx_http_log_module 模块实现</p>
<p><strong>自定义访问日志的格式：</strong></p>
<blockquote>
<p>语法: log_format name [escape&#x3D;default|json|none] string …;<br>默认值: log_format combined “…”;<br>上下文: http</p>
</blockquote>
<p>支持三种转义方式：</p>
<ol>
<li>default：<code>”</code>、<code>,</code>、<code>\</code> 以及小于 32 或大于 126 的字符被转义为<code>\xXX</code></li>
<li>json：所有 json 中不被允许的字符都进行转义，<code>”</code>被转义成 <code>\</code>，<code>\</code>被转义成<code>\\</code>，值小于 32 的字符转义成<code>\n</code>、<code>\r</code>、<code>\t</code>、<code>b</code>、<code>f</code>或<code>\u00XX</code></li>
<li>none：禁止转义</li>
</ol>
<p>combined 是内置的默认格式，以空格分割字符串形式记录日志</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> combined <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;<span class="variable">$request</span>&quot; <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;<span class="variable">$http_referer</span>&quot; &quot;<span class="variable">$http_user_agent</span>&quot;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>自定义访问日志的路径以及其他配置：</strong></p>
<blockquote>
<p>语法: access_log path [format [buffer&#x3D;size] [gzip[&#x3D;level]] [flush&#x3D;time] [if&#x3D;condition]];<br>access_log off;<br>默认值: access_log logs&#x2F;access.log combined;<br>上下文: http, server, location, if in location, limit_except</p>
</blockquote>
<p>format：默认 combined<br>buffer&#x3D;size：缓冲区大小，默认 64K<br>gzip&#x3D;level：压缩等级，1-9，数值越大，压缩率最高，压缩最慢，默认为 1，可以使用<code>zcat</code>解压缩<br>flush&#x3D;time：缓冲区的数据写入磁盘的间隔时间，必须搭配 buffer&#x3D;size 一起使用，时间到了，即使缓冲区还没满，也得写入磁盘<br>if&#x3D;condition：其他条件</p>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">access_log</span> /path/to/log.gz combined gzip flush=<span class="number">5m</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$status</span> <span class="variable">$loggable</span> &#123;</span><br><span class="line">    ~^[23]  0;</span><br><span class="line">    <span class="attribute">default</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">access_log</span> /path/to/access.log combined if=<span class="variable">$loggable</span>;</span><br></pre></td></tr></table></figure>

<h3 id="自定义-json-格式日志"><a href="#自定义-json-格式日志" class="headerlink" title="自定义 json 格式日志"></a>自定义 json 格式日志</h3><p>Nginx 的默认访问日志记录内容相对比较单一，默认的格式也不方便后期做日志统计分析，生产环境中通常将 nginx 日志转换为 json 日志，然后配合使用 ELK 做日志收集-统计-分析</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> access_json <span class="string">&#x27;&#123;&quot;<span class="variable">@timestamp</span>&quot;:&quot;<span class="variable">$time_iso8601</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;host&quot;:&quot;<span class="variable">$server_addr</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;clientip&quot;:&quot;<span class="variable">$remote_addr</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;size&quot;:<span class="variable">$body_bytes_sent</span>,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;responsetime&quot;:<span class="variable">$request_time</span>,&#x27;</span> <span class="comment"># 总的处理时间</span></span><br><span class="line">                        <span class="string">&#x27;&quot;upstreamtime&quot;:&quot;<span class="variable">$upstream_response_time</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;upstreamhost&quot;:&quot;<span class="variable">$upstream_addr</span>&quot;,&#x27;</span> <span class="comment"># 后端应用服务器处理时间</span></span><br><span class="line">                        <span class="string">&#x27;&quot;http_host&quot;:&quot;<span class="variable">$host</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;uri&quot;:&quot;<span class="variable">$uri</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;xff&quot;:&quot;<span class="variable">$http_x_forwarded_for</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;referer&quot;:&quot;<span class="variable">$http_referer</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;tcp_xff&quot;:&quot;<span class="variable">$proxy_protocol_addr</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;http_user_agent&quot;:&quot;<span class="variable">$http_user_agent</span>&quot;,&#x27;</span></span><br><span class="line">                        <span class="string">&#x27;&quot;status&quot;:&quot;<span class="variable">$status</span>&quot;&#125;&#x27;</span>;</span><br><span class="line"><span class="attribute">access_log</span> /apps/nginx/logs/access_json.log access_json;</span><br></pre></td></tr></table></figure>

<h3 id="json-格式的日志访问统计"><a href="#json-格式的日志访问统计" class="headerlink" title="json 格式的日志访问统计"></a>json 格式的日志访问统计</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">status_200= []</span><br><span class="line">status_404= []</span><br><span class="line"><span class="attribute">with</span> open(<span class="string">&quot;access_json.log&quot;</span>) as f:</span><br><span class="line">    for line in f.readlines():</span><br><span class="line">        line = eval(line)</span><br><span class="line">        if line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;200&quot;</span>:</span><br><span class="line">            status_200.append(line.get)</span><br><span class="line">        elif line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">            status_404.append(line.get)</span><br><span class="line">        else:</span><br><span class="line">            print(<span class="string">&quot;状态码 ERROR&quot;</span>)</span><br><span class="line">        print((line.get(<span class="string">&quot;clientip&quot;</span>)))</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;状态码200的有--:&quot;</span>,len(status_200))</span><br><span class="line">print(<span class="string">&quot;状态码404的有--:&quot;</span>,len(status_404))</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-压缩功能"><a href="#Nginx-压缩功能" class="headerlink" title="Nginx 压缩功能"></a>Nginx 压缩功能</h2><p>Nginx 支持对指定类型的文件进行压缩然后再传输给客户端，有助于降低出口带宽的利用率，降低企业的 IT 支出，不过会占用相应的 CPU 资源</p>
<p>依赖于模块 ngx_http_gzip_module</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用或禁用gzip压缩，默认关闭</span></span><br><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line"><span class="comment">#压缩比由低到高从1到9，默认为1</span></span><br><span class="line"><span class="attribute">gzip_comp_level</span> level;</span><br><span class="line"><span class="comment">#禁用IE6 gzip功能</span></span><br><span class="line"><span class="attribute">gzip_disable</span> <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"><span class="comment">#gzip压缩的最小文件，小于设置值的文件将不会压缩，默认单位为字节 1K=1024</span></span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line"><span class="comment">#启用压缩功能时，协议的最小版本，默认HTTP/1.1</span></span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">0</span> | <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line"><span class="comment">#指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k;</span></span><br><span class="line"><span class="attribute">gzip_buffers</span> number size;</span><br><span class="line"><span class="comment">#指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错</span></span><br><span class="line"><span class="attribute">gzip_types</span> mime-type ...;</span><br><span class="line"><span class="comment">#如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开</span></span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nginx作为反向代理的时候启用，开启或者关闭后端服务器返回的结果，匹配的前提是后端服务器必须要返回包含”Via”的 header头。</span></span><br><span class="line"><span class="attribute">gzip_proxied</span> <span class="literal">off</span> | expired | <span class="literal">no</span>-cache | <span class="literal">no</span>-store | private | no_last_modified | no_etag | auth | any ...;</span><br><span class="line"><span class="comment"># off – 关闭所有的代理结果数据的压缩</span></span><br><span class="line"><span class="comment"># expired – 启用压缩，如果header头中包含 “Expires” 头信息</span></span><br><span class="line"><span class="comment"># no-cache – 启用压缩，如果header头中包含 “Cache-Control:no-cache” 头信息</span></span><br><span class="line"><span class="comment"># no-store – 启用压缩，如果header头中包含 “Cache-Control:no-store” 头信息</span></span><br><span class="line"><span class="comment"># private – 启用压缩，如果header头中包含 “Cache-Control:private” 头信息</span></span><br><span class="line"><span class="comment"># no_last_modified – 启用压缩,如果header头中不包含 “Last-Modified” 头信息</span></span><br><span class="line"><span class="comment"># no_etag – 启用压缩 ,如果header头中不包含 “ETag” 头信息</span></span><br><span class="line"><span class="comment"># auth – 启用压缩 , 如果header头中包含 “Authorization” 头信息</span></span><br><span class="line"><span class="comment"># any – 无条件启用压缩</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_buffers</span> <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">256</span>;</span><br><span class="line"><span class="attribute">gzip_proxied</span> any;</span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_types</span></span><br><span class="line">  text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class="line">  text/javascript application/javascript application/x-javascript</span><br><span class="line">  text/x-json application/json application/x-web-app-manifest+json</span><br><span class="line">  text/css text/plain text/x-component</span><br><span class="line">  font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class="line">  image/x-icon;</span><br><span class="line"><span class="attribute">gzip_disable</span> <span class="string">&quot;MSIE [1-6]\.(?!.*SV1)&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="https"><a href="#https" class="headerlink" title="https"></a>https</h2><p>https &#x3D; http + ssl &#x2F; tls</p>
<p>https 的实现过程可以参考前面的关于“安全和加密”部分的笔记</p>
<p>基于模块 ngx_http_ssl_module 实现，yum 安装默认开启，编译安装则需要指定编译参数 –with-http_ssl_module</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl</span> <span class="literal">on</span> | <span class="literal">off</span>; <span class="comment"># 开启ssl功能，这个参数1.15版本已经废除了，应该使用 listen ssl 替代</span></span><br><span class="line"><span class="attribute">listen</span> <span class="number">443</span> ssl; <span class="comment"># 替代ssl指令，同时指定端口</span></span><br><span class="line"><span class="attribute">ssl_certificate</span> /path/to/file; <span class="comment"># 证书文件，一般是crt或者pem文件</span></span><br><span class="line"><span class="attribute">ssl_certificate_key</span> /path/to/file; <span class="comment"># 私钥文件，一般是key文件</span></span><br><span class="line"><span class="comment"># 支持ssl协议版本，早期为ssl现在是TLS，默认为后三个</span></span><br><span class="line"><span class="attribute">ssl_protocols</span> [SSLv2] [SSLv3] [TLSv1] [TLSv1.<span class="number">1</span>] [TLSv1.<span class="number">2</span>];</span><br><span class="line"><span class="attribute">ssl_session_timeout</span> time; <span class="comment"># 客户端连接可以复用ssl session cache中缓存的有效时长，默认5m</span></span><br><span class="line"><span class="comment"># 配置ssl缓存</span></span><br><span class="line"><span class="attribute">ssl_session_cache</span> <span class="literal">off</span> | <span class="literal">none</span> | [builtin[:size]] [shared:name:size];</span><br><span class="line"> <span class="comment"># off：关闭缓存</span></span><br><span class="line"> <span class="comment"># none：通知客户端支持ssl session cache，但实际不支持</span></span><br><span class="line"> <span class="comment"># builtin[:size]：使用OpenSSL内建缓存，为每worker进程私有</span></span><br><span class="line"> <span class="comment"># [shared:name:size]：在各worker之间使用一个共享的缓存，需要定义一个缓存名称和缓存空间大小，一兆可以存储4000个会话信息，多个虚拟主机可以使用相同的缓存名称</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>范例：实现 hsts <a target="_blank" rel="noopener" href="https://www.cnblogs.com/sunsky303/p/8862600.html">https://www.cnblogs.com/sunsky303/p/8862600.html</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /usr/local/nginx/conf/ssl/xcx.to2b.cn.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /usr/local/nginx/conf/ssl/xcx.to2b.cn.key;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> builtin:<span class="number">1000</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_buffer_size</span> <span class="number">1400</span>;</span><br><span class="line">    <span class="comment"># Strict-Transport-Security， 即hsts，强制https的意思</span></span><br><span class="line">    <span class="comment"># 一年内，浏览器自动将http请求转成https</span></span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">    <span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">server_name</span> xcx.to2b.cn;</span><br><span class="line">    <span class="attribute">access_log</span> /data/wwwlogs/xcx.to2b.cn_nginx.log combined;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm index.php;</span><br><span class="line">    <span class="attribute">root</span> /data/wwwroot/xcx.to2b.cn/public;</span><br><span class="line">    <span class="comment"># 第一次http请求，需要重定向到https</span></span><br><span class="line">    <span class="attribute">if</span> ( <span class="variable">$scheme</span> = http ) &#123;<span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> https://www.magedu.org/<span class="variable">$1</span> <span class="literal">redirect</span>;&#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关于-favicon-ico"><a href="#关于-favicon-ico" class="headerlink" title="关于 favicon.ico"></a>关于 favicon.ico</h2><p>favicon.ico 文件是浏览器收藏网址时显示的图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的 favicon.ico 文件，但是当浏览器请求的 favicon.ico 文件不存在时，服务器会记录 404 日志，而且浏览器也会显示 404 报错</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /favicon.ico &#123;</span><br><span class="line"> <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line"> <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">root</span> /data/nginx/html/pc/images;</span><br><span class="line"> <span class="attribute">expires</span> <span class="number">365d</span>; <span class="comment">#设置文件过期时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Nginx/2.Nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Nginx/2.Nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">2.Nginx核心配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-25 14:49:49" itemprop="dateCreated datePublished" datetime="2020-12-25T14:49:49+08:00">2020-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>官方帮助文档：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/">http://nginx.org/en/docs/</a></p>
<p>中文帮助文档：<a target="_blank" rel="noopener" href="http://tengine.taobao.org/nginx_docs/cn/docs/">http://tengine.taobao.org/nginx_docs/cn/docs/</a> 不是很全</p>
<p>语法：</p>
<ol>
<li><p>指令必须分号结尾</p>
</li>
<li><p>内建变量由 nginx 模块引入，可直接饮用；自定义变量由用户使用 set 命令自定义</p>
<p>$variable_name 的形式饮用变量</p>
</li>
</ol>
<h2 id="配置文件结构"><a href="#配置文件结构" class="headerlink" title="配置文件结构"></a>配置文件结构</h2><p>主配置文件 nginx.conf，包括四部分</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.main: 主配置段，即全局配置段，对http和mail都有效</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 事件驱动相关配置</span></span><br><span class="line"><span class="section">event</span> &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.http/https协议相关配置</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.mail协议相关配置，默认不包括</span></span><br><span class="line"><span class="section">mail</span> &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.stream服务器相关配置</span></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置项说明"><a href="#配置项说明" class="headerlink" title="配置项说明"></a>配置项说明</h2><p>说明：在<a target="_blank" rel="noopener" href="http://tengine.taobao.org/nginx_docs/cn/docs/">文档</a>中，每个配置项都有详细的说明</p>
<p>范例：user 配置项，只能用于全局配置中</p>
<blockquote>
<p>语法: user user [group];<br>默认值: user nobody nobody;<br>上下文: main</p>
</blockquote>
<p>范例：charset 配置项，可以用于 http、server、location 配置中</p>
<blockquote>
<p>语法: charset charset | off;<br>默认值: charset off;<br>上下文: http, server, location, if in location</p>
</blockquote>
<h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><p>上下文是 main，全局生效，包括事件驱动相关配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> www www;</span><br><span class="line"><span class="comment"># 启动worker进程的数量，注意并不是设置越大越好，建议设置为auto，worker进程数等于cpu核心数量</span></span><br><span class="line"><span class="attribute">worker_processes</span> [number | auto];</span><br><span class="line"><span class="comment"># 将worker进程和cpu核心绑定，避免了worker进程在不同的cpu核心上来回跳转，建议设置，可以有效提升nginx性能</span></span><br><span class="line"><span class="comment"># 0001：0号CPU、0010：1号CPU</span></span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> <span class="number">0001</span> <span class="number">0010</span> <span class="number">0100</span> <span class="number">1000</span>;</span><br><span class="line"><span class="comment"># 错误日志配置</span></span><br><span class="line"><span class="comment"># error_log file [debug | info | notice | warn | error | crit | alert | emerg]</span></span><br><span class="line"><span class="attribute">error_log</span> /data/wwwlogs/error_nginx.log <span class="literal">crit</span>;</span><br><span class="line"><span class="comment"># pid文件保存路径</span></span><br><span class="line"><span class="attribute">pid</span> /var/run/nginx.pid;</span><br><span class="line"><span class="comment"># 工作进程优先级，-20~19，越小则优先级越高，建议调小</span></span><br><span class="line"><span class="attribute">worker_priority</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment"># 所有worker进程能打开的文件数量上限，注意这里设置的值不能超过`ulimit -n`显示的值，否则没有意义，系统默认打开的最大文件数为1024，建议调大，具体怎么调整，查询其他笔记中的ulimit相关知识</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65536</span>;</span><br><span class="line"><span class="comment"># 前台运行Nginx服务，主要用于测试、docker等环境</span></span><br><span class="line"><span class="attribute">daemon</span> <span class="literal">off</span>;</span><br><span class="line"><span class="comment"># #是否开启Nginx的master-worker工作模式，仅用于开发调试场景,默认为on</span></span><br><span class="line"><span class="attribute">master_process</span> <span class="literal">off</span>|<span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 事件驱动相关配置</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"> <span class="comment"># nginx支持众多事件驱动，推荐设置为epoll</span></span><br><span class="line"> <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line"> <span class="comment"># 单个worker进程的最大并发连接</span></span><br><span class="line"> <span class="attribute">worker_connections</span> <span class="number">51200</span>;</span><br><span class="line"> <span class="comment"># 默认off，新请求回唤醒所有worker进程（惊群），推荐设置为on，worker进程轮流处理新请求</span></span><br><span class="line"> <span class="attribute">accept_mutex</span> <span class="literal">on</span>;</span><br><span class="line"> <span class="comment"># 默认off，推荐设置为on，一个worker进程可以同时接收多个新的网络连接</span></span><br><span class="line"> <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="http-配置"><a href="#http-配置" class="headerlink" title="http 配置"></a>http 配置</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"> <span class="comment"># server的公共配置</span></span><br><span class="line"> ...</span><br><span class="line"> ...</span><br><span class="line"> <span class="comment"># 每个server用于定义一个虚拟主机，第一个server为默认的虚拟服务器</span></span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">  ...</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"> <span class="comment"># 导入支持的文件类型，mime.types的格式：大类/小类 后缀</span></span><br><span class="line"> <span class="attribute">include</span> mime.types;</span><br><span class="line"> <span class="comment"># mime.types中没有的文件类型，默认为dafault_type设置的文件类型</span></span><br><span class="line"> <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line"> <span class="comment"># 默认off，不显示，建议改为utf-8，在响应头会显示：Content-Type: text/html; charset=utf-8</span></span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">    <span class="comment"># 配置响应头的server，on：‘nginx/版本’；off：‘nginx’，不显示版本</span></span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>; <span class="comment"># 开启零拷贝技术，减少I/O次数</span></span><br><span class="line">    <span class="attribute">tcp_nopush</span> <span class="literal">on</span>; <span class="comment"># 在开启了sendfile的情况下，合并请求后统一发给客户端</span></span><br><span class="line">    <span class="comment"># 设置会话保持时间，第二个值为响应头的keep-Alived:timeout值,可以和第一个值不同，可省略</span></span><br><span class="line">    <span class="comment"># https://cloud.tencent.com/developer/article/1541434</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">120</span>;</span><br><span class="line">    <span class="comment"># 在一次长连接上所允许请求的资源的最大数量，默认为100次,建议适当调大,比如:500</span></span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">off</span>; <span class="comment"># off：延迟0.2s发送；on：立即发送，推荐设置为on，提高网络利用率</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">     <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">     <span class="comment"># 支持通配符，支持正则（主机名前加‘~’）</span></span><br><span class="line">     <span class="comment"># 处理请求头没有host字段的请求，server_name设置为空“”</span></span><br><span class="line">     <span class="comment"># ‘_’可以匹配所有的请求，其实也没什么特别，‘_’只是一个非法域名，当然也可以使用“--”和“!@#”等等</span></span><br><span class="line">     <span class="comment"># http://tengine.taobao.org/nginx_docs/cn/docs/http/server_names.html</span></span><br><span class="line">     <span class="attribute">server_name</span> localhost;</span><br><span class="line">     <span class="attribute">access_log</span> logs/host.access.log main;	    	<span class="comment"># 日志设置 main是日志格式</span></span><br><span class="line">     <span class="comment"># location / &#123; &#125; 可以省略，将root和index放到server上下文中</span></span><br><span class="line">     <span class="section">location</span> / &#123;</span><br><span class="line">   <span class="attribute">root</span> html;</span><br><span class="line">   <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># 根目录使用root，其他子目录适合使用alias更直观</span></span><br><span class="line">  <span class="section">location</span> /about &#123;</span><br><span class="line">   <span class="comment"># root about	# http://host/about 访问的是about/about/index.html</span></span><br><span class="line">   <span class="attribute">alias</span> about;	<span class="comment"># http://host/about 访问的是about/index.html</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">location</span> /img &#123;</span><br><span class="line">         <span class="attribute">default_type</span> text/html;</span><br><span class="line">         <span class="attribute">alias</span> /data/wwwroot/default/qiniu/upload.html;</span><br><span class="line">     &#125;</span><br><span class="line">  <span class="comment"># 定义错误页面</span></span><br><span class="line">  <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">  <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line">  <span class="section">location</span> /50x.html &#123;</span><br><span class="line">   <span class="attribute">root</span> html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>商业版本的 nginx 中，可以自定义 nginx 的名称，免费的社区版本不支持，但是可以通过修改源码自定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_tokens on：修改 src/core/nginx.h 修改第13-14行，如下示例</span><br><span class="line">#define NGINX_VERSION &quot;1.68.9&quot;</span><br><span class="line">#define NGINX_VER &quot;lnginx/&quot; NGINX_VERSION</span><br><span class="line"></span><br><span class="line">server_tokens off：修改 src/http/ngx_http_header_filter_module.c第49行，如下示例：</span><br><span class="line">static char ngx_http_server_string[] = &quot;Server: nginx&quot; CRLF;</span><br><span class="line">把其中的nginx改为自己想要的文字即可,如：lujinkaix</span><br></pre></td></tr></table></figure>

<h2 id="核心配置示例"><a href="#核心配置示例" class="headerlink" title="核心配置示例"></a>核心配置示例</h2><h3 id="ngx-http-core-module"><a href="#ngx-http-core-module" class="headerlink" title="ngx_http_core_module"></a>ngx_http_core_module</h3><p>基于不同的 IP、端口、域名实现不同的虚拟主机，依赖于核心模块：ngx_http_core_module</p>
<h4 id="location-语法"><a href="#location-语法" class="headerlink" title="location 语法"></a>location 语法</h4><p>一个 server 中可以配置多个 location</p>
<ul>
<li><p>精确匹配 &#x3D;</p>
<p>通常用于匹配相对固定的 url</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /logo.jpg &#123;</span><br><span class="line"> <span class="attribute">root</span> /data/nginx/images;</span><br><span class="line"> <span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>区分大小写的正则匹配 ~</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~ .*\.(js|css)?$</span> &#123;</span><br><span class="line"> <span class="attribute">expires</span> <span class="number">7d</span>;</span><br><span class="line"> <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不区分大小写的正则匹配 ~*</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：这里只是对img不分区大小写，img、imG都会被匹配到，但是具体到文件，还是区分大小写的</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* /img</span> &#123;</span><br><span class="line"> <span class="attribute">alias</span> /images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>匹配 URI 开始 ^~</p>
<p>通常用于匹配目录，注意：不支持正则</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /images &#123;</span><br><span class="line"> <span class="attribute">root</span> /data/nginx/;</span><br><span class="line"> <span class="attribute">index</span> index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>匹配的优先级：&#x3D;、^<del>、</del>、~*、&#x2F;</p>
<h4 id="作为上传服务器"><a href="#作为上传服务器" class="headerlink" title="作为上传服务器"></a>作为上传服务器</h4><p>以下指令控制上传数据</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许客户端上传单个文件的最大值，默认值为1m,上传文件超过此值会出413错误</span></span><br><span class="line"><span class="attribute">client_max_body_size</span> <span class="number">1m</span>;</span><br><span class="line"><span class="comment"># 用于接收每个客户端请求报文的body部分的缓冲区大小;默认16k;超出此值，则暂存在client_body_temp_path指定的目录下</span></span><br><span class="line"><span class="attribute">client_body_buffer_size</span> size;</span><br><span class="line"><span class="comment"># level1、level2、level3表示的是目录层级1、2、3级的命名，具体规律看下面的范例</span></span><br><span class="line"><span class="attribute">client_body_temp_path</span> path [level1 [level2 [level3]]];</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">client_max_body_size</span> <span class="number">100m</span>; <span class="comment"># 如果php上传,还需要修改php.ini的相关配置</span></span><br><span class="line"><span class="attribute">client_body_buffer_size</span> <span class="number">1024k</span>;</span><br><span class="line"><span class="attribute">client_body_temp_path</span> /data/nginx/client_body_temp/ <span class="number">1</span> <span class="number">2</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>将上传的文件进行 hash 取值，例如 hash 值为：95f6f65f498c74938064851b1bb963d4，因为设置 1 2 2，所以从后往前去分截取 1、2、2 位，即 4、3d、96，最终的目录名称就是把 16 进制转换为十进制后的数字，即：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/data/nginx/client_body_temp/</span><br><span class="line">├── 4</span><br><span class="line">  └── 61</span><br><span class="line">   └── 150</span><br></pre></td></tr></table></figure>

<h3 id="ngx-http-access-module"><a href="#ngx-http-access-module" class="headerlink" title="ngx_http_access_module"></a>ngx_http_access_module</h3><p>访问控制，可以通过匹配客户源 ip 地址进行限制</p>
<p>注意：如果能在防火墙设备进行控制，最好就不要在 nginx 上配置，可以更好的节约资源</p>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /login/ &#123;</span><br><span class="line">    <span class="attribute">root</span> /data/nginx/html/pc;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">10.0.0.0</span>/<span class="number">24</span>;</span><br><span class="line">    <span class="attribute">deny</span> all;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /about &#123;</span><br><span class="line">    <span class="attribute">alias</span> /data/nginx/html/pc;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">    <span class="attribute">deny</span> <span class="number">192.168.1.1</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">192.168.1.0</span>/<span class="number">24</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">10.1.1.0</span>/<span class="number">16</span>;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">2001</span>:0db8::/<span class="number">32</span>;</span><br><span class="line">    <span class="attribute">deny</span> all; <span class="comment"># 按小范围到大范围排序</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ngx-http-auth-basic-module"><a href="#ngx-http-auth-basic-module" class="headerlink" title="ngx_http_auth_basic_module"></a>ngx_http_auth_basic_module</h3><p>提供账户认证功能，某些网页例如状态页需要通过认证才能访问</p>
<h3 id="ngx-http-autoindex-module"><a href="#ngx-http-autoindex-module" class="headerlink" title="ngx_http_autoindex_module"></a>ngx_http_autoindex_module</h3><p>ngx_http_autoindex_module 模块处理以斜杠字符 “&#x2F;“ 结尾的请求，并生成目录列表,可以做为下载服<br>务配置使用</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">autoindex</span> <span class="literal">on</span> | <span class="literal">off</span>; <span class="comment"># 自动文件索引功能，默认为off</span></span><br><span class="line"><span class="attribute">autoindex_exact_size</span> <span class="literal">on</span> | <span class="literal">off</span>; <span class="comment"># 计算文件大小（单位bytes），off 显示大概大小（单位K、M)，默认on</span></span><br><span class="line"><span class="attribute">autoindex_localtime</span> <span class="literal">on</span> | <span class="literal">off</span>; <span class="comment"># 显示本机时间而非GMT(格林威治)时间，默认off</span></span><br><span class="line"><span class="attribute">autoindex_format</span> html | xml | json | jsonp; <span class="comment"># 显示索引的页面文件风格，默认html</span></span><br><span class="line"><span class="attribute">limit_rate</span> rate; <span class="comment"># 限制响应客户端传输速率(除GET和HEAD以外的所有方法)，单位B/s,即bytes/second，默认值0,表示不限速,此指令由ngx_http_core_module提供</span></span><br></pre></td></tr></table></figure>

<p>范例：实现下载站点</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /download &#123;</span><br><span class="line">    <span class="attribute">root</span> /data/nginx/html/pc;</span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">autoindex_exact_size</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">limit_rate</span> <span class="number">1024k</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="error-page"><a href="#error-page" class="headerlink" title="error_page"></a>error_page</h3><p>定义错误页面</p>
<blockquote>
<p>语法: error_page code … [&#x3D;[response]] uri;<br>默认值: —<br>上下文: http, server, location, if in location</p>
</blockquote>
<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span>             /<span class="number">404</span>.html;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line"><span class="comment"># =response 可以改变响应码</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">200</span> /empty.gif;</span><br><span class="line"><span class="comment"># 对错误处理进行重定向</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">403</span>      http://example.com/forbidden.html;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">301</span> http://example.com/notfound.html;</span><br><span class="line"><span class="comment"># 将URI发送到被代理的服务器或者FastCGI服务器处理</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> = /<span class="number">404</span>.php;</span><br></pre></td></tr></table></figure>

<p>如果处理<code>uri</code>产生了错误，那么 nginx 将最后一次出错的 HTTP 响应状态码返回给客户端。</p>
<h3 id="error-log"><a href="#error-log" class="headerlink" title="error_log"></a>error_log</h3><blockquote>
<p>语法: error_log file | stderr [debug | info | notice | warn | error | crit | alert | emerg];<br>默认值: error_log logs&#x2F;error.log error;<br>上下文: main, http, server, location</p>
</blockquote>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log /data/wwwlogs/error_nginx.log crit;</span><br></pre></td></tr></table></figure>

<p>第一个参数是错误日志路径，如果设置为特殊值<code>stderr</code>，nginx 会将日志输出到标准错误输出。</p>
<p>第二个参数是日志级别，debug 到 emerg 严重性由轻到重，如果要设置为 debug，编译时需要添加<code>--with-debug</code>编译选项。</p>
<h3 id="try-files"><a href="#try-files" class="headerlink" title="try_files"></a>try_files</h3><blockquote>
<p>语法: try_files file … uri;<br>try_files file … &#x3D;code;<br>默认值: —<br>上下文: server, location</p>
</blockquote>
<p>内置变量 $uri 和 $request_uri：</p>
<p>如果用户请求的完整 url：<a target="_blank" rel="noopener" href="http://s1.lujinkai.cn/www/nav/v1/index.html#/nav">http://s1.lujinkai.cn/www/nav/v1/index.html#/nav</a></p>
<ul>
<li>$uri：&#x2F;www&#x2F;nav&#x2F;v1，不包含？和#等参数</li>
<li>$request_uri：&#x2F;www&#x2F;nav&#x2F;v1&#x2F;index.html#&#x2F;nav，包含？和#等参数</li>
</ul>
<p>try_files 会按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部 URI 的指向。最后一个参数是回退 URI 且必须存在，否则会出现内部 500 错误。</p>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root /data/nginx/html/pc;</span><br><span class="line">    index index.html;</span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>.html <span class="variable">$uri</span>/index.html /about/default.html;</span><br><span class="line">    <span class="comment">#try_files $uri $uri/index.html $uri.html =489;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]$ <span class="built_in">echo</span> <span class="string">&quot;default page&quot;</span> &gt;&gt; /data/nginx/html/pc/about/default.html</span><br><span class="line"><span class="comment"># 重启nginx并测试，当访问到http://www.magedu.org/about/xx.html等不存在的uri会显示default.html，如果是自定义的状态码则会显示在返回数据的状态码中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注释default.html行,启用上面489行生效后,再观察结果</span></span><br><span class="line">[root@centos8 ~]$ curl -I http://www.magedu.org/about/xx.html</span><br><span class="line">HTTP/1.1 489 <span class="comment"># 489就是自定义的状态返回码</span></span><br><span class="line">Server: nginx</span><br><span class="line">Date: Thu, 21 Feb 2019 00:11:40 GMT</span><br><span class="line">Content-Length: 0</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: <span class="built_in">timeout</span>=65</span><br></pre></td></tr></table></figure>

<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><ul>
<li><p>针对行为异常的浏览器关闭长连接功能：</p>
<blockquote>
<p>语法: keepalive_disable none | browser …;<br>默认值: keepalive_disable msie6;<br>上下文: http, server, location</p>
</blockquote>
</li>
<li><p>限制客户端使用除了指定的请求方法之外的其它方法：</p>
<blockquote>
<p>语法: limit_except method … { … }<br>默认值: —<br>上下文: location</p>
</blockquote>
<p>method ：<code>GET</code>、 <code>HEAD</code>、 <code>POST</code>、 <code>PUT</code>、 <code>DELETE</code>、 <code>MKCOL</code>、 <code>COPY</code>、 <code>MOVE</code>、 <code>OPTIONS</code>、 <code>PROPFIND</code>、 <code>PROPPATCH</code>、 <code>LOCK</code>、 <code>UNLOCK</code> 或者 <code>PATCH</code>。 指定<code>method</code>为<code>GET</code>方法的同时，会自动添加<code>HEAD</code>方法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 除了GET和HEAD 之外其它方法仅允许192.168.1.0/24网段主机使用</span></span><br><span class="line"><span class="attribute">limit_except</span> GET &#123;</span><br><span class="line">    <span class="attribute">allow</span> <span class="number">192.168.1.0</span>/<span class="number">32</span>;</span><br><span class="line">    <span class="attribute">deny</span>  all;</span><br><span class="line">&#125;</span><br><span class="line">​```</span><br></pre></td></tr></table></figure>
</li>
<li><p>异步 I&#x2F;O：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否开启异步I/O功能，如果开启，编译时需要加入--with-file-aio</span></span><br><span class="line"><span class="attribute">aio</span> <span class="literal">on</span> | <span class="literal">off</span>;</span><br><span class="line"><span class="comment"># 如果开启aio，必须同时开启directio，否则读取将是阻塞的，注意打开了directio则自动关闭sendfile</span></span><br><span class="line"><span class="attribute">directio</span> size | <span class="literal">off</span>;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /video/ &#123;</span><br><span class="line">    <span class="attribute">aio</span>            <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">directio</span>       <span class="number">512</span>;</span><br><span class="line">    <span class="comment"># 从磁盘读取响应的缓冲区的数量和大小。默认1 32k</span></span><br><span class="line">    <span class="attribute">output_buffers</span> <span class="number">1</span> <span class="number">128k</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>缓存：</p>
<p>nginx 可以缓存以下三种信息：</p>
<ol>
<li>文件元数据：文件的描述符、文件大小和最近一次的修改时间</li>
<li>打开的目录结构</li>
<li>没有找到的或者没有权限访问的文件的相关信息</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否缓存打开过文件信息，默认off</span></span><br><span class="line"><span class="comment"># max：可缓存的缓存项上限数量；</span></span><br><span class="line"><span class="comment"># inactive：缓存项的非活动时长在此处指定的时长内未被命中的或命中的次数少于open_file_cache_min_uses指令所指定的次数的缓存项即为非活动项，将被删除</span></span><br><span class="line"><span class="attribute">open_file_cache</span> <span class="literal">off</span> | max=N [inactive=time];</span><br><span class="line"></span><br><span class="line"><span class="attribute">open_file_cache_valid</span> time; <span class="comment"># 缓存项有效性的检查验证频率，默认值为60s</span></span><br><span class="line"><span class="attribute">open_file_cache_errors</span> <span class="literal">on</span> | <span class="literal">off</span>; <span class="comment"># 是否缓存查找时发生错误的文件一类的信息,默认值为off</span></span><br><span class="line"><span class="attribute">open_file_cache_min_uses</span> number;  <span class="comment"># open_file_cache指令的inactive参数指定的时长内，至少被命中几数方可被归类为活动项,默认值为1</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">open_file_cache</span> max=<span class="number">10000</span> inactive=<span class="number">60s</span>; <span class="comment"># 最大缓存10000个文件，非活动数据超时时长60s</span></span><br><span class="line"><span class="attribute">open_file_cache_valid</span> <span class="number">60s</span>; <span class="comment"># 每间隔60s检查一下缓存数据有效性</span></span><br><span class="line"><span class="attribute">open_file_cache_min_uses</span> <span class="number">5</span>; <span class="comment"># 60秒内至少被命中访问5次才被标记为活动数据</span></span><br><span class="line"><span class="attribute">open_file_cache_errors</span> <span class="literal">on</span>; <span class="comment"># 缓存错误信息</span></span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Nginx/1.Nginx%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Nginx/1.Nginx%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">1.Nginx架构和安装</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-25 14:48:10" itemprop="dateCreated datePublished" datetime="2020-12-25T14:48:10+08:00">2020-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p>nginx 的功能主要有两个：web 服务器和反向代理</p>
<ul>
<li>html、图片、js、css 等静态资源的服务器</li>
<li>http&#x2F;https 协议的反向代理</li>
<li>结合 FastCGI&#x2F;uWSGI&#x2F;SCGI 等协议反向代理动态资源请求</li>
<li>tcp&#x2F;udp 协议的请求转发（反向代理）</li>
<li>imap4&#x2F;pop3 协议的反向代理</li>
</ul>
<h3 id="基础特性"><a href="#基础特性" class="headerlink" title="基础特性"></a>基础特性</h3><ul>
<li>模块化设计，较好的扩展性</li>
<li>高可靠性</li>
<li>支持热部署：不停机的更新配置文件，升级版本，更换日志文件</li>
<li>低内存消耗：1000 个 keep-alive 连接模式下的非活动连接，仅需 2.5m 内存</li>
<li>event-driven、aio、mmap、sendfile</li>
</ul>
<h3 id="web-相关的功能"><a href="#web-相关的功能" class="headerlink" title="web 相关的功能"></a>web 相关的功能</h3><ul>
<li>虚拟主机（server）</li>
<li>支持 keep-alive 和管道连接（利用一个连接做多次请求）</li>
<li>访问日志（支持基于日志缓冲提高性能）</li>
<li>url rewrite</li>
<li>路径别名</li>
<li>基于 ip 及用户的访问控制</li>
<li>支持速率限制及并发数限制</li>
<li>重新配置和在线升级而无须终端客户的工作进程</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img data-src="//img.to2b.cn/blog/ljk/1608735025958.png"></p>
<p>nginx 是多进程，一个 master 主进程和若干 worker 工作进程组成</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1608735716495.png"></p>
<p>master 进程的功能：</p>
<ol>
<li>对外接口，接收外部的操作（信号）</li>
<li>对内转发，根据外部的操作的不同，通过信号管理 worker</li>
<li>监控 worker 进程的运行状态，worker 进程异常终止后，自动重启 worker 进程</li>
<li>读取 nginx 配置文件，并验证其有效性和正确性</li>
<li>建立、绑定和关闭 socket 连接</li>
<li>按照配置生成、管理和结束工作进程</li>
<li>不中断服务，实现平滑升级（升级失败进行回滚处理）、重启服务并应用新的配置</li>
<li>开启日志文件，获取文件描述符</li>
<li>编译和处理 per 脚本</li>
</ol>
<p>worker 进程的功能：</p>
<ol>
<li>所有 worker 进程都是平等的</li>
<li>实际处理网络请求，将请求依次送入各个功能模块进行处理</li>
<li>I&#x2F;O 调用，获取响应数据</li>
<li>与后端服务器通信，接受后端处理器的处理结果</li>
<li>缓存数据，访问缓存索引，查询和调用缓存数据</li>
<li>发送请求结果，响应客户的请求</li>
</ol>
<p><img data-src="//img.to2b.cn/blog/ljk/1608736685344.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1608736700127.png"></p>
<h3 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h3><p>master 与 worker 通信：worker 进程是由 master 进程生成，主进程在启动之后，建立一个主进程指向工作进程的单向通道，master 进程通过信号机制和与外界通信，当接受到需要处理的信号时，就通过管道向相关的进程发送正确的指令，每个 worker 进程都有能力捕捉管道中的可读事件，当管道中有可读事件时，worker 进程就会从管道中读取并解析指令，然后才去相应的执行动作，这样就完成了主进程与子进程的交互</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1608737297753.png"></p>
<p>worker 进程之间通信：worker 进程之间只要能够取得彼此的信息，建立管道即可通信，但是由于 worker 进程之间是完全隔离的，因此一个进程想要知道另外一个进程的状态信息，就只能通过 master 进程来实现。</p>
<p>master 进程在生成 worker 进程之后，会把新进程的 ID 以及针对该进程建立的管道句柄传递给其他 worker 进程，这样能实现通过 master 进程进行通信</p>
<h3 id="http-连接建立"><a href="#http-连接建立" class="headerlink" title="http 连接建立"></a>http 连接建立</h3><ol>
<li>nginx 启动，master 进程加载配置文件</li>
<li>master 进程初始化监听的 socket</li>
<li>master 进程 fork 出多个 worker 进程</li>
<li>worker 进程，<strong>竞争新的连接</strong>，获胜方通过三次握手，建立 socket 连接，开始处理请求</li>
</ol>
<h3 id="http-处理过程"><a href="#http-处理过程" class="headerlink" title="http 处理过程"></a>http 处理过程</h3><p><img data-src="//img.to2b.cn/blog/ljk/1608739985770.png"></p>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>nginx 高度模块化</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1608809383655.png"></p>
<ul>
<li>核心模块：正常运行必不可少，提供错误日志记录、配置文件解析、事件驱动机制、进程管理等核心功能</li>
<li>标准 http 模块：提供 http 协议解析相关的功能，比如：端口配置、网页编码设置、http 响应头设置等</li>
<li>可选 http 模块：主要用于扩展标准的 http 功能，让 nginx 可以处理一些特殊的服务，比如：flash 多媒体传输、解析 GeoIP 请求、网络传输压缩、安全协议 SSL 支持等</li>
<li>邮件服务服务：主要用于支持 nginx 的邮件服务，包括对 pop3 协议、IMAP 协议和 SMTP 协议的支持</li>
<li>stream 服务模块：实现反向代理功能，包括 TCP 协议代理</li>
<li>第三方面模块：为了扩展 nginx 服务器应用，完成开发者自定义功能，比如：json 支持、lua 支持等</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>推荐编译安装，可以自定义功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看编译参数</span></span><br><span class="line">[root@4710419222 ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.15.7</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-28) (GCC)</span><br><span class="line">built with OpenSSL 1.0.2p  14 Aug 2018</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=www --group=www --with-http_stub_status_module --with-http_v2_module --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_flv_module --with-http_mp4_module --with-openssl=../openssl-1.0.2p --with-pcre=../pcre-8.42 --with-pcre-jit --with-ld-opt=-ljemalloc</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动前，可以检查配置文件nginx.conf的合法性</span></span><br><span class="line">[root@4710419222 vhost]<span class="comment"># /usr/local/nginx/sbin/nginx -t</span></span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Nginx/0.IO%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%9B%B6%E6%8B%B7%E8%B4%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Nginx/0.IO%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%9B%B6%E6%8B%B7%E8%B4%9D/" class="post-title-link" itemprop="url">0.I/O模型和零拷贝</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-25 14:45:19" itemprop="dateCreated datePublished" datetime="2020-12-25T14:45:19+08:00">2020-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h2><h3 id="prefork-模型"><a href="#prefork-模型" class="headerlink" title="prefork 模型"></a>prefork 模型</h3><p><img data-src="//img.to2b.cn/blog/ljk/1608694875696.png"></p>
<h3 id="worker-模型"><a href="#worker-模型" class="headerlink" title="worker 模型"></a>worker 模型</h3><p><img data-src="//img.to2b.cn/blog/ljk/1608694898568.png"></p>
<h3 id="event-模型"><a href="#event-模型" class="headerlink" title="event 模型"></a>event 模型</h3><p>属于事件驱动模型（epoll），它和 worker 模式很像，最大的区别在于，它解决了 keepalive 场景下，长期被占用的线程的资源浪费问题</p>
<p>优点：单线程响应多请求，占据更少的内存，高并发下表现更优秀，会有一个专门的线程来管理 keep-alive 类型的线程，当有真实请求过来的时候，将请求传递给服务线程，执行完毕后，允许它释放</p>
<p>缺点：没有线程安全控制</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1608694925033.png"></p>
<h2 id="一次完整的-I-x2F-O"><a href="#一次完整的-I-x2F-O" class="headerlink" title="一次完整的 I&#x2F;O"></a>一次完整的 I&#x2F;O</h2><p>I&#x2F;O：input &#x2F; output intput 是写，output 是读，I&#x2F;O 就是对文件的读写。</p>
<p>I&#x2F;O 分为 磁盘 I&#x2F;O 和 网络 I&#x2F;O，但 Linux 中一切皆文件，网络 I&#x2F;O 本质是对 socket 文件（socket &#x3D; ip + port）的读写。</p>
<p>内核空间与用户空间都在内存中，但是是严格隔离的，用户空间的程序要想使用内核空间的数据，要先把数据先从内核空间 copy 到用户空间，然后使用 copy 的这份，反之亦然。</p>
<p>所以每次 读 或 写 操作都要经过两个阶段：</p>
<p><strong>读：</strong></p>
<ol>
<li><strong>将数据从文件加载到内核空间（缓冲区），时间较长</strong></li>
<li><strong>将数据从内核空间（缓冲区）复制到用户空间，时间较短</strong></li>
</ol>
<p><strong>写：</strong></p>
<ol>
<li><strong>将数据从用户空间复制到内核空间（缓冲区），时间较短</strong></li>
<li><strong>将数据从内核空间（缓冲区）写入到文件中，时间较长</strong></li>
</ol>
<h2 id="I-x2F-O-相关概念理解"><a href="#I-x2F-O-相关概念理解" class="headerlink" title="I&#x2F;O 相关概念理解"></a>I&#x2F;O 相关概念理解</h2><p>同步&#x2F;异步 关注的是 消息通知机制</p>
<h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><h4 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h4><ol>
<li>用户线程发起 I&#x2F;O 操作 的请求，然后挂起；</li>
<li>内核开始处理请求，直到两个阶段都完成，才返回结果（读操作返回读取的内容，写操作返回是否成功）；</li>
<li>用户线程接收到结果 被激活，然后继续工作；</li>
</ol>
<p>当然 用户线程等待的过程是不消耗 CPU 的。</p>
<h4 id="非阻塞"><a href="#非阻塞" class="headerlink" title="非阻塞"></a>非阻塞</h4><ol>
<li>用户线程发起 I&#x2F;O 操作 的请求；</li>
<li>内核马上返回一个错误(EWOULDBLOCK)，然后开始处理请求。</li>
<li>用户线程接收到错误，然后去处理其他任务，同时定时检查，如果还是返回错误(EWOULDBLOCK)就说明内核还没处理完。</li>
<li>直到定时检查有结果返回，用户线程才回来继续完成任务</li>
</ol>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p><strong>注意：只有同步才有阻塞&#x2F;非阻塞的说法，异步就是异步（都异步了哪来的阻塞？）不涉及阻塞问题。</strong></p>
<ol>
<li><p>用户线程发起 I&#x2F;O 操作 的请求；</p>
</li>
<li><p>内核返回 0，然后开始处理请求</p>
</li>
<li><p>用户线程接收到 0，然后去处理其他任务；</p>
</li>
<li><p>内核请求处理完后，通知线程；</p>
<p>什么时候算处理完？</p>
<ul>
<li><p>写操作：完成第二阶段；</p>
</li>
<li><p>读操作：有两种方式 NIO 和 AIO：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NIO：完成第一阶段就算完成，告诉用户线程”我可以读了“，第二阶段还是要阻塞用户线程。</span><br><span class="line"></span><br><span class="line">AIO：完成第二阶段才算完成，告诉用户线程”我读完了“，是真正的异步，但是因为第二阶段非常快，所以对比NIO提升不大，而且要实现真正的异步 I/O，操作系统需要做大量的工作，目前AIO并不成熟，所以用的不多。</span><br></pre></td></tr></table></figure></li>
</ul>
<p>怎么通知线程？状态、通知或回调。用户线程无需关心具体使用什么方式，</p>
<p>用户线程一定有个“地方”专门接收通知，对于 NIO，这个”地方“就是下文重点介绍的 select、poll、epoll；对于 AIO 就不是很清楚了</p>
</li>
</ol>
<h2 id="网络-IO-模型"><a href="#网络-IO-模型" class="headerlink" title="网络 IO 模型"></a>网络 IO 模型</h2><p>下图是几种常见 I&#x2F;O 模型的对比：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1665303756105.png"></p>
<p>以 socket.read()为例子：BIO 里用户最关心“我要读”，NIO 里用户最关心”我可以读了”，在 AIO 模型里用户更需要关注的是“读完了”。</p>
<h3 id="阻塞-I-x2F-O"><a href="#阻塞-I-x2F-O" class="headerlink" title="阻塞 I&#x2F;O"></a>阻塞 I&#x2F;O</h3><p>最简单的 I&#x2F;O 模型，用户线程在内核进行 IO 操作时阻塞，每个连接需要独立的进程&#x2F;线程单独处理，当并发请求量大时为了维护程序，内存、线程切换开销较大，apache 的 preforck 使用的是这种模式。</p>
<img data-src="//img.to2b.cn/blog/lujinkai/1665469742256.png" style="zoom: 67%;" />

<h3 id="非阻塞-I-x2F-O"><a href="#非阻塞-I-x2F-O" class="headerlink" title="非阻塞 I&#x2F;O"></a>非阻塞 I&#x2F;O</h3><p>程序向内核发送请 I&#x2F;O 求后一直等待内核响应，如果内核处理请求的 IO 操作不能立即返回 IO 结果，进程将不再等待，而且继续处理其他请求，但是仍然需要进程隔一段时间就要查看内核 I&#x2F;O 是否完成。</p>
<img data-src="//img.to2b.cn/blog/ljk/1608732500948.png" style="zoom:80%;" />

<p>上图可知，在设置连接为非阻塞时，当应用进程系统调用 recvfrom 没有数据返回时，内核会立即返回一个 EWOULDBLOCK 错误，而不会一直阻塞到数据准备好。如上图在第四次调用时有一个数据报准备好了，所以这时数据会被复制到 应用进程缓冲区 ，于是 recvfrom 成功返回数据</p>
<h3 id="I-x2F-O-多路复用（重点）"><a href="#I-x2F-O-多路复用（重点）" class="headerlink" title="I&#x2F;O 多路复用（重点）"></a>I&#x2F;O 多路复用（重点）</h3><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/flashsun/p/14591563.html">https://www.cnblogs.com/flashsun/p/14591563.html</a></p>
<p>多路复用就是复用线程的意思，实现单线程处理多任务。</p>
<p>NIO 是多路复用的基础，对于读操作，多路复用只能实现第一阶段的异步，无法实现第二阶段的异步。</p>
<p>I&#x2F;O 多路复用 的实现方式主要有 3 种：select、poll、epoll</p>
<h4 id="select"><a href="#select" class="headerlink" title="select"></a>select</h4><p>伪代码：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个线程，负责接收客户端的连接，并把 socket fd 放到 list 里</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"> connfd := accept(listenfd)</span><br><span class="line"> fcntl(connfd, F_SETFL, O_NONBLOCK)</span><br><span class="line"> fdlist.Add(connfd)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 再创建一个线程，调用select，将list交给操作系统去遍历，找到就绪的 socket fd</span></span><br><span class="line"><span class="comment">// select 接收一个fdList，然后遍历fdList，将就绪的fd标注状态</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    fds := <span class="keyword">select</span>(fdlist)   <span class="comment">// 获取标注状态之后的fdList</span></span><br><span class="line"> <span class="keyword">for</span> _, fd := fds &#123;				<span class="comment">// 遍历处理</span></span><br><span class="line">  <span class="keyword">if</span> fd.Status &#123;				<span class="comment">// 判断fd是否就绪(可读或可写)</span></span><br><span class="line">   read(fd, buffer)		<span class="comment">// 从fd读取数据</span></span><br><span class="line">   process(buffer)			<span class="comment">// 处理读取的数据</span></span><br><span class="line">            <span class="built_in">close</span>(fd);      <span class="comment">// 关闭连接</span></span><br><span class="line">         fdList.Delete(fd)				<span class="comment">// 将处理完的fd删除</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>动图示例：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/gif/567fa1ffacc84953ba48cb8074acce03_tplv-obj.image"></p>
<p>缺点：</p>
<ol>
<li>fdList 最长 1024</li>
<li>每次调用 select，都要将 fdList 拷贝到内核空间，内核处理完后，再拷贝到用户空间，高并发场景下这样的拷贝消耗的资源是惊人的。</li>
<li>select 在内核层仍然是通过遍历的方式检查文件描述符的就绪状态，是个同步过程，只不过无系统调用切换上下文的开销。</li>
<li>select 仅仅返回可读文件描述符的个数，具体哪个可读还是要用户自己遍历。</li>
</ol>
<h4 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h4><p>select 的升级版，本质上和 select 没有区别，去掉了 select 只能监听 1024 个文件描述符的限制。</p>
<h4 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h4><p>epoll 针对 select 和 poll 的缺点，做了三点改进：</p>
<ol>
<li>内核中保存一份文件描述符集合，无需用户每次都重新传入，只需告诉内核修改的部分即可。</li>
<li>内核不再通过轮询的方式找到就绪的文件描述符，而是通过异步 IO 事件唤醒。</li>
<li>内核仅会将有 IO 事件的文件描述符返回给用户，用户也无需遍历整个文件描述符集合。</li>
</ol>
<p>具体，操作系统提供了这三个函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;            <span class="comment">// 第一步，创建一个 epoll 句柄</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span>;  <span class="comment">// 第二步，向内核添加、修改或删除要监控的文件描述符。</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event *events, <span class="type">int</span> max events, <span class="type">int</span> timeout)</span>; <span class="comment">// 第三步，类似发起了 select() 调用</span></span><br></pre></td></tr></table></figure>

<p>伪代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个线程，负责接收客户端的连接，并把 socket fd 放到 list 里</span></span><br><span class="line">epfd := epoll_create(n)  <span class="comment">// 创建epoll</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"> connfd := accept(listenfd)</span><br><span class="line">    fcntl(connfd, F_SETFL, O_NONBLOCK)</span><br><span class="line"> epoll_ctl(epfd, add, connfd)		<span class="comment">// 向epoll中添加connfd</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 再创建一个线程，调用epoll_wait，找到就绪的 socket fd</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    fds := epoll_wait()       <span class="comment">// 获取当前有哪些fd就绪(可读或可写)</span></span><br><span class="line"> <span class="keyword">for</span> _, fd := fds &#123;							<span class="comment">// 遍历处理这些fd</span></span><br><span class="line">  read(fd, buffer)						<span class="comment">// 从fd读取数据</span></span><br><span class="line">  process(buffer)							<span class="comment">// 处理读取的数据</span></span><br><span class="line">        <span class="built_in">close</span>(fd);        <span class="comment">// 关闭连接</span></span><br><span class="line">        epoll_ctl(epfd, <span class="built_in">delete</span>, fd)    <span class="comment">// 将处理完的fd删除</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>动图示例：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/gif/24b34419c9c4404c93ceba46a6e013f7_tplv-obj.image"></p>
<table>
<thead>
<tr>
<th></th>
<th>select</th>
<th>poll</th>
<th>epoll</th>
</tr>
</thead>
<tbody><tr>
<td>操作方式</td>
<td>遍历</td>
<td>遍历</td>
<td>回调</td>
</tr>
<tr>
<td>底层实现</td>
<td>数组</td>
<td>链表</td>
<td>哈希表</td>
</tr>
<tr>
<td>IO 效率</td>
<td>每次调用都进行线性遍历，时间复杂度为 O(n)</td>
<td>每次调用都进行线性遍历，时间复杂度为 O(n)</td>
<td>事件通知方式，每当 fd 就绪，系统注册的回调函数就会被调用，将就绪 fd 放到 readyList 里面，时间复杂度 O(1)</td>
</tr>
<tr>
<td>最大连接数</td>
<td>1024</td>
<td>无上限</td>
<td>无上限</td>
</tr>
<tr>
<td>fd 拷贝</td>
<td>每次调用 select，都需要把 fd 集合从用户态拷贝到内核态</td>
<td>每次调用 poll，都需要把 fd 集合从用户态拷贝到内核态</td>
<td>调用 epoll_ctl 时拷贝进内核并保存，之后每次 epoll_wait 不拷贝</td>
</tr>
</tbody></table>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>一切的开始，都起源于这个 read 函数是操作系统提供的，而且是阻塞的，我们叫它 <strong>阻塞 I&#x2F;O</strong>。</p>
<p>为了破这个局，程序员在用户态通过多线程来防止主线程卡死。</p>
<p>后来操作系统发现这个需求比较大，于是在操作系统层面提供了非阻塞的 read 函数，这样程序员就可以在一个线程内完成多个文件描述符的读取，这就是 <strong>非阻塞 I&#x2F;O</strong>。</p>
<p>但多个文件描述符的读取就需要遍历，当高并发场景越来越多时，用户态遍历的文件描述符也越来越多，相当于在 while 循环里进行了越来越多的系统调用。</p>
<p>后来操作系统又发现这个场景需求量较大，于是又在操作系统层面提供了这样的遍历文件描述符的机制，这就是 <strong>I&#x2F;O 多路复用</strong>。</p>
<p>多路复用有三个函数，最开始是 select，然后又发明了 poll 解决了 select 文件描述符的限制，然后又发明了 epoll 解决 select 的不足。</p>
<hr>
<p>所以，IO 模型的演进，倒逼着操作系统将更多的功能加到自己的内核而已。</p>
<p>如果你建立了这样的思维，很容易发现网上的一些错误。</p>
<p>比如好多文章说，多路复用之所以效率高，是因为用一个线程就可以监控多个文件描述符。</p>
<p>这显然是知其然而不知其所以然，多路复用产生的效果，完全可以由用户态去遍历文件描述符并调用其非阻塞的 read 函数实现。而多路复用快的原因在于，操作系统提供了这样的系统调用，使得原来的 while 循环里多次系统调用，变成了一次系统调用 + 内核层遍历这些文件描述符。</p>
<p>就好比我们平时写业务代码，把原来 while 循环里调 http 接口进行批量，改成了让对方提供一个批量添加的 http 接口，然后我们一次 rpc 请求就完成了批量添加。一个道理。</p>
<h3 id="信号驱动-I-x2F-O"><a href="#信号驱动-I-x2F-O" class="headerlink" title="信号驱动 I&#x2F;O"></a>信号驱动 I&#x2F;O</h3><p>不需要轮训，而是让内核在数据就绪时，发送信号通知</p>
<p>缺点：信号 I&#x2F;O 在大量 IO 操作时可能会因为信号队列溢出导致没法通知</p>
<h3 id="异步-I-x2F-O"><a href="#异步-I-x2F-O" class="headerlink" title="异步 I&#x2F;O"></a>异步 I&#x2F;O</h3><p>异步 IO 与信号驱动 IO 最主要的区别是信号驱动 IO 是由内核通知应用程序何时可以进行 IO 操作，而异步 IO 则是由内核告诉用户线程 IO 操作何时完成。信号驱动 IO 当内核通知触发信号处理程序时，信号处理程序还需要阻塞在从内核空间缓冲区拷贝数据到用户空间缓冲区这个阶段，而异步 IO 直接是在第二个阶段完成后，内核直接通知用户线程可以进行后续操作了</p>
<p>缺点：要实现真正的异步 I&#x2F;O，操作系统需要做大量的工作。目前 Windows 下通过 IOCP 实现了真正的异步 I&#x2F;O，在 Linux 系统下，Linux 2.6 才引入，目前 AIO 并不完善，因此在 Linux 下实现高并发网络编程时以 IO 复用模型模式+多线程任务的架构基本可以满足需求</p>
<p>Linux 提供了 AIO 库函数实现异步，但是用的很少。目前有很多开源的异步 IO 库，例如 libevent、libev、libuv 但是这些的底层都是通过 epoll 的多路复用模拟的异步 I&#x2F;O。</p>
<h2 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h2><p>通过尽量避免拷贝操作来缓解 CPU 的压力。零拷贝并没有真正做到“0”拷贝，它更多是一种思想，很多的零拷贝技术都是基于这个思想去做的优化</p>
<h3 id="MMAP-Memory-Mapping"><a href="#MMAP-Memory-Mapping" class="headerlink" title="MMAP ( Memory Mapping )"></a>MMAP ( Memory Mapping )</h3><p>内存映射，用户空间的内存映射到内核空间</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1608734466702.png"></p>
<h3 id="SENDFILE"><a href="#SENDFILE" class="headerlink" title="SENDFILE"></a>SENDFILE</h3><p><img data-src="//img.to2b.cn/blog/ljk/1608734509830.png"></p>
<h3 id="DMA-辅助的-SENDFILE"><a href="#DMA-辅助的-SENDFILE" class="headerlink" title="DMA 辅助的 SENDFILE"></a>DMA 辅助的 SENDFILE</h3><p>需要硬件支持</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1608734518868.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%89%8D%E7%AB%AF/Vue2/vue%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%89%8D%E7%AB%AF/Vue2/vue%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">vue基础知识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:30:49" itemprop="dateCreated datePublished" datetime="2020-12-11T23:30:49+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/Vue2/" itemprop="url" rel="index"><span itemprop="name">Vue2</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>冒泡： 点击元素， 也会触发父元素的点击事件</p>
<p>defineProperty: 实现属性代理; 实现单向数据绑定</p>
<p><strong>v-开头的属性, 称之为 Vue 的指令</strong></p>
<p>标签分为两类: 表单标签 和 非表单标签, 单向绑定的指令一般用于非表单标签, 双向绑定的指令用于表单标签</p>
<ul>
<li>v-text：和双花括号的效果一样</li>
<li>v-html：和 v-text 唯一的区别就是能解析 html 代码</li>
<li>v-bind:属性名：**简写”：”**，给元素的属性赋值</li>
<li>v-on:事件名：**简写”@”**，事件注册</li>
<li>v-if、v-else-if、v-else：必须是相邻的兄弟元素控制，元素是否显示( 不显示的时候是从 dom 中移除 )</li>
<li>v-show： 控制元素是否显示(不显示的时候是 display:none)</li>
<li>v-for：循环, 常用于列表渲染</li>
<li>v-model</li>
</ul>
<p>绑定方向除了 v-model 是双向，其他的都是单向( 数据&#x3D;&gt;DOM )</p>
<p>双花括号、v-text、v-html、v-bind 对应的位置可以写 js 表达式, 注意不能写 js 语句(例如: 三元表达式可以写, 全局对象方法可以调用, if 语句不能写)</p>
<p><strong>事件修饰符</strong><br>Vue 允许我们在注册事件时，进行额外的操作。我们在事件名后添加 .xxxx 来对事件进行修饰</p>
<table>
<thead>
<tr>
<th>适用事件</th>
<th>事件修饰符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>click</td>
<td>.self</td>
<td>只要点击当前元素自己时, 才会触发事件</td>
<td><code>&lt;div class=&quot;xx&quot; v-on:click.self=&quot;handlerDiv&quot;&gt;</code></td>
</tr>
<tr>
<td></td>
<td>.stop</td>
<td>表示阻止冒泡</td>
<td></td>
</tr>
<tr>
<td></td>
<td>.prevent</td>
<td>阻止事件的默认行为</td>
<td><code>submit.prevent=&quot;xxx&quot;</code></td>
</tr>
</tbody></table>
<p>补充: 关于按钮修饰符给 input 注册 keyup 事件, 但是 .enter 表示, 只有按下 回车键 时, 才触发。示例：<code> &lt;input v-on:keyup.enter=&quot;handler&quot;/&gt;</code></p>
<p><strong>过滤器</strong> ( filter )：常规过滤器、全局过滤器</p>
<p><strong>计算属性</strong> ( computed ) : 和过滤器的本质区别: 当数据变化时才执行</p>
<p><strong>观察者</strong>( watch ) : 监视 data 中的属性,一旦属性发生了改变就去自动调用对应的方法</p>
<p><strong>自定义属性</strong>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;div &gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;cursor: pointer;&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;xx&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;getId($event,b)&quot;</span> <span class="attr">:data-b</span>=<span class="string">&quot;b&quot;</span>&gt;</span>&#123;&#123;a&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">el</span>: <span class="string">&#x27;#box&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="attr">a</span>: <span class="number">123</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="attr">b</span>: <span class="number">455</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="title function_">getId</span>(<span class="params">e,b</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="variable language_">console</span>.<span class="title function_">dir</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">xx</span>.<span class="property">dataset</span>.<span class="property">b</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="variable language_">console</span>.<span class="title function_">dir</span>(e.<span class="property">target</span>.<span class="title function_">getAttribute</span>(<span class="string">&#x27;data-b&#x27;</span>))</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/EasySwoole/swoole%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/EasySwoole/swoole%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">swoole进程模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:22:21" itemprop="dateCreated datePublished" datetime="2020-12-11T23:22:21+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/EasySwoole/" itemprop="url" rel="index"><span itemprop="name">EasySwoole</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/EasySwoole/php-fpm%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/EasySwoole/php-fpm%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">php-fpm进程模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:22:10" itemprop="dateCreated datePublished" datetime="2020-12-11T23:22:10+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/EasySwoole/" itemprop="url" rel="index"><span itemprop="name">EasySwoole</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>子进程和子线程：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39561473/article/details/89576549">https://blog.csdn.net/weixin_39561473/article/details/89576549</a></p>
<p>开启一个 php-fpm 主进程，用户是 root，然后开启多个 php-fpm 子进程，用户是 www。</p>
<p>每个子进程同时只能处理一个请求，所有开启多少 php-fpm，它的并发就是多少，例如开启了 50 个 php-fpm 子进程，那么并发就是 50。子进程是不能无限开启的，进程之间是隔离的，每开启一个进程操作系统都要为其分配内存。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/EasySwoole/jwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/EasySwoole/jwt/" class="post-title-link" itemprop="url">jwt</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:21:58" itemprop="dateCreated datePublished" datetime="2020-12-11T23:21:58+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/EasySwoole/" itemprop="url" rel="index"><span itemprop="name">EasySwoole</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.easyswoole.com/Components/jwt.html">https://www.easyswoole.com/Components/jwt.html</a><br><a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1608021814182894637&wfr=spider&for=pc">https://baijiahao.baidu.com/s?id=1608021814182894637&amp;wfr=spider&amp;for=pc</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42873937/article/details/82460997">使用 JWT 实现单点登录（完全跨域方案）</a></p>
<p>JWT：JSON Web Token</p>
<p>JWT 不仅可用于认证，还可用于信息交换。善用 JWT 有助于减少服务器请求数据库的次数</p>
<h2 id="生成-token-编码"><a href="#生成-token-编码" class="headerlink" title="生成 token 编码"></a>生成 token 编码</h2><p>将<font color=red> <u>用户信息</u> + <u>固定数据</u>（加密方式、用户、过期时间等）+ <u>密钥</u> </font> 加密，得到 <font color=red>签名</font>，然后将这四部分数据 base64 编码，生成一个长字符串，这个长字符串就是 token</p>
<p>注意：</p>
<ul>
<li>密钥保存在服务器上，千万不能泄露，可以设置成 项目名称+随机字符串 的格式</li>
<li>token 中的所有信息都是公开的，所以一定不能存放密码等隐私信息</li>
<li>一旦 JWT 签发，有效期内将会一直有效，不能取消 token 或更改 token 的权限为了减少盗用，JWT 的有效期不宜设置太长。对于某些重要操作，用户在使用时应该每次都进行进行身份验证</li>
<li>密钥可以保证 token 的安全性，但是无法防止 token 的盗用问题，为了减少盗用和窃取，推荐使用 HTTPS 协议进行传输</li>
</ul>
<h2 id="解析-token-解码"><a href="#解析-token-解码" class="headerlink" title="解析 token 解码"></a>解析 token 解码</h2><p>base64 解码 token，得到一堆明文信息和签名，明文信息里有一个字段说明了加密用的算法，将明文信息使用指定的加密方式加密，如果等于签名，则 token 校验通过，在进行超时等其他参数的校验</p>
<h2 id="easyswoole-中的-jwt"><a href="#easyswoole-中的-jwt" class="headerlink" title="easyswoole 中的 jwt"></a>easyswoole 中的 jwt</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://www.easyswoole.com/Components/jwt.html">https://www.easyswoole.com/Components/jwt.html</a></p>
<p>官方文档写的比较简略，通过查阅源码，可以有更详细的了解。</p>
<p>token 由三或四部分组成：</p>
<ol>
<li><p>前缀：prefix，可省略</p>
</li>
<li><p>头部：header，是 alg（加密方式）和 typ（类型，默认 JWT 且无法更改）的组合，经过 base64 转码</p>
</li>
<li><p>有效载荷：payload，包含以下信息，经过 base64 转码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;exp&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getExp</span>(),   <span class="comment">// 过期时间，默认两个小时</span></span><br><span class="line"><span class="string">&#x27;sub&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getSub</span>(),   <span class="comment">// 主题，没有默认值</span></span><br><span class="line"><span class="string">&#x27;nbf&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getNbf</span>(),   <span class="comment">// 在此之前不可用，默认time()</span></span><br><span class="line"><span class="string">&#x27;aud&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAud</span>(),   <span class="comment">// 用户，无默认值</span></span><br><span class="line"><span class="string">&#x27;iat&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getIat</span>(),   <span class="comment">// 发布时间，默认time()</span></span><br><span class="line"><span class="string">&#x27;jti&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getJti</span>(),   <span class="comment">// jwt-id，用于标识jwt，默认10字节的随机字符串</span></span><br><span class="line"><span class="string">&#x27;iss&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getIss</span>(),   <span class="comment">// 发行人，默认&#x27;EasySwoole&#x27;</span></span><br><span class="line"><span class="comment">// token状态，0初始状态，1合法token，-1非法token，-2过期token，生成token的时候，status默认给1</span></span><br><span class="line"><span class="comment">// 不太理解payload中为什么要包含这个字段</span></span><br><span class="line"><span class="string">&#x27;status&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getStatus</span>(),</span><br><span class="line"><span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>()   <span class="comment">// 自定义的数据</span></span><br></pre></td></tr></table></figure>

<p>必要的信息都有默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jwt</span></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$secretKey</span> = <span class="string">&#x27;EasySwoole&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$alg</span> = <span class="title class_">Jwt</span>::<span class="variable constant_">ALG_METHOD_HS256</span>; <span class="comment">// 默认加密方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// JwtObject</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$iss</span> = <span class="string">&#x27;EasySwoole&#x27;</span>; <span class="comment">// 发行人</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;nbf)) &#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;nbf = <span class="title function_ invoke__">time</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;iat)) &#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;iat = <span class="title function_ invoke__">time</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;exp)) &#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;exp = <span class="title function_ invoke__">time</span>() + <span class="number">7200</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;jti)) &#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;jti = <span class="title class_">Random</span>::<span class="title function_ invoke__">character</span>(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>签名：signature，包含 secretKey（秘钥）、header、payload、alg，经过加密然后 base64 转码</p>
<p>除了 secretKey，其他所有信息相当于都是明文，secretKey 储存在服务器的内存中，如果重启服务，secretKey 就会丢失，之前的 token 就都无法通过校验，所以<strong>推荐直接修改 Jwt 组件中的默认 secretKey，然后在生成 token 的时候，不指定 secretKey，使用默认值</strong></p>
</li>
</ol>
<p>生成 token，以下是最简略的写法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">EasySwoole</span>\<span class="title">Jwt</span>\<span class="title">Jwt</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = <span class="title class_">Jwt</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">publish</span>()-&gt;<span class="title function_ invoke__">__toString</span>();</span><br></pre></td></tr></table></figure>

<p>生成 token，以下是推荐写法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">EasySwoole</span>\<span class="title">Jwt</span>\<span class="title">Jwt</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$jwtObject</span> = <span class="title class_">Jwt</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">publish</span>();</span><br><span class="line"><span class="variable">$jwtObject</span>-&gt;<span class="title function_ invoke__">setPrefix</span>(<span class="string">&#x27;Bearer&#x27;</span>);    <span class="comment">// token前缀，Bearer表示标准jwt格式</span></span><br><span class="line"><span class="variable">$jwtObject</span>-&gt;<span class="title function_ invoke__">setSub</span>(<span class="string">&#x27;yuanzhan&#x27;</span>);    <span class="comment">// 主题</span></span><br><span class="line"><span class="variable">$jwtObject</span>-&gt;<span class="title function_ invoke__">setAud</span>(<span class="variable">$userId</span>);    <span class="comment">// 用户id</span></span><br><span class="line"><span class="variable">$jwtObject</span>-&gt;<span class="title function_ invoke__">setExp</span>(<span class="title function_ invoke__">time</span>() + <span class="number">3600</span>);    <span class="comment">// 过期时间设置为1个小时</span></span><br><span class="line"><span class="comment">// 自定义数据</span></span><br><span class="line"><span class="variable">$jwtObject</span>-&gt;<span class="title function_ invoke__">setData</span>([</span><br><span class="line">    <span class="string">&#x27;other_info&#x27;</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$jwt</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br></pre></td></tr></table></figure>

<h2 id="自动续期"><a href="#自动续期" class="headerlink" title="自动续期"></a>自动续期</h2><p>设置 token 过期时间 2h，2h 内用户一直在操作，然后贸然过期肯定不合理，所以 token 要有自动续期机制。</p>
<p>方案：</p>
<ul>
<li>后端：每次校验 token 的过期时间，如果过期但是过期时间不超过 4 个小时，则生成一个新 token，并附着在此次请求返回的数据的基础上。这里用“refreshToken”字段</li>
<li>前端：每次 http 请求校验返回值中有没有“refreshToken”字段，如果有，则刷新本地 token</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/EasySwoole/%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/EasySwoole/%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">上传文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:21:42" itemprop="dateCreated datePublished" datetime="2020-12-11T23:21:42+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/EasySwoole/" itemprop="url" rel="index"><span itemprop="name">EasySwoole</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>上传文件大小受<code>package_max_length</code>配置项限制, 默认为 2M。</p>
<p>不要用 swoole 处理大文件上传, swoole 底层是全内存的，因此如果<code>package_max_length</code>设置过大，可能导致大量并发请求将服务器内存耗尽。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/EasySwoole/%E6%8E%A7%E5%88%B6%E5%99%A8%E7%89%B9%E6%80%A7%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/EasySwoole/%E6%8E%A7%E5%88%B6%E5%99%A8%E7%89%B9%E6%80%A7%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">控制器特性以及常用方法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:21:00" itemprop="dateCreated datePublished" datetime="2020-12-11T23:21:00+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/EasySwoole/" itemprop="url" rel="index"><span itemprop="name">EasySwoole</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>私有属性不释放。可以通过 gc 来释放。注意 gc 方法一定要先执行<code>parent::gc();</code>实现父类的 gc，因为基类中 gc 会进行重置 public 属性的操作。</p>
<p>控制器对象常驻内存，构造方法和析构方法只有在进程开启和退出的时候才会执行。可以用 onRequest 代替构造方法，用 afterAction 代替析构方法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/EasySwoole/%E4%BB%8E%E5%8D%8F%E7%A8%8B%E4%B8%AD%E8%8E%B7%E5%8F%96%E9%93%BE%E6%8E%A5%E7%9A%84%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/EasySwoole/%E4%BB%8E%E5%8D%8F%E7%A8%8B%E4%B8%AD%E8%8E%B7%E5%8F%96%E9%93%BE%E6%8E%A5%E7%9A%84%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">从协程中获取链接的方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:19:52" itemprop="dateCreated datePublished" datetime="2020-12-11T23:19:52+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/EasySwoole/" itemprop="url" rel="index"><span itemprop="name">EasySwoole</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="defer、-invoker、-getObj"><a href="#defer、-invoker、-getObj" class="headerlink" title="defer、 invoker、 getObj"></a>defer、 invoker、 getObj</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">go</span>(function () &#123;</span><br><span class="line">    <span class="variable">$redisPool</span> = <span class="keyword">new</span> <span class="title class_">\App\Pool\RedisPool</span>(<span class="keyword">new</span> <span class="title class_">\EasySwoole\Pool\Config</span>(), <span class="keyword">new</span> <span class="title class_">\EasySwoole\Redis\Config\RedisConfig</span>(<span class="title class_">\EasySwoole\EasySwoole\Config</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">getConf</span>(<span class="string">&#x27;REDIS&#x27;</span>)));</span><br><span class="line">    <span class="variable">$redis</span> = <span class="variable">$redisPool</span>-&gt;<span class="title function_ invoke__">getObj</span>();</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$redis</span>-&gt;<span class="keyword">echo</span>(<span class="string">&#x27;仙士可&#x27;</span>));</span><br><span class="line">    <span class="variable">$redisPool</span>-&gt;<span class="title function_ invoke__">recycleObj</span>(<span class="variable">$redis</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">go</span>(function () &#123;</span><br><span class="line">    <span class="variable">$redisPool</span> = <span class="keyword">new</span> <span class="title class_">\App\Pool\RedisPool</span>(<span class="keyword">new</span> <span class="title class_">\EasySwoole\Pool\Config</span>(), <span class="keyword">new</span> <span class="title class_">\EasySwoole\Redis\Config\RedisConfig</span>(<span class="title class_">\EasySwoole\EasySwoole\Config</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">getConf</span>(<span class="string">&#x27;REDIS&#x27;</span>)));</span><br><span class="line">    <span class="variable">$redisPool</span>-&gt;<span class="title function_ invoke__">invoke</span>(function (\EasySwoole\Redis\Redis <span class="variable">$redis</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$redis</span>-&gt;<span class="keyword">echo</span>(<span class="string">&#x27;仙士可&#x27;</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">go</span>(function () &#123;</span><br><span class="line">    <span class="variable">$redisPool</span> = <span class="keyword">new</span> <span class="title class_">\App\Pool\RedisPool</span>(<span class="keyword">new</span> <span class="title class_">\EasySwoole\Pool\Config</span>(), <span class="keyword">new</span> <span class="title class_">\EasySwoole\Redis\Config\RedisConfig</span>(<span class="title class_">\EasySwoole\EasySwoole\Config</span>::<span class="title function_ invoke__">getInstance</span>()-&gt;<span class="title function_ invoke__">getConf</span>(<span class="string">&#x27;REDIS&#x27;</span>)));</span><br><span class="line">    <span class="variable">$redis</span> = <span class="variable">$redisPool</span>-&gt;<span class="title function_ invoke__">defer</span>();</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$redis</span>-&gt;<span class="keyword">echo</span>(<span class="string">&#x27;仙士可&#x27;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="getObj-获取一个连接池对象"><a href="#getObj-获取一个连接池对象" class="headerlink" title="getObj 获取一个连接池对象"></a>getObj 获取一个连接池对象</h2><blockquote>
<p>​ 通过 getObj 方法获取的对象,都必须调用 unsetObj 或者 recycleObj 进行回收,否则连接池对象会越来越少</p>
</blockquote>
<h3 id="invoke-获取一个连接-传入到-call-回调函数中进行处理-回调结束后自动回收连接"><a href="#invoke-获取一个连接-传入到-call-回调函数中进行处理-回调结束后自动回收连接" class="headerlink" title="invoke 获取一个连接,传入到$call 回调函数中进行处理,回调结束后自动回收连接"></a>invoke 获取一个连接,传入到$call 回调函数中进行处理,回调结束后自动回收连接</h3><blockquote>
<p>​ 通过该方法无需手动回收连接,在回调函数结束后,则自动回收</p>
</blockquote>
<h2 id="defer-获取一个连接-协程结束后自动回收"><a href="#defer-获取一个连接-协程结束后自动回收" class="headerlink" title="defer 获取一个连接,协程结束后自动回收"></a>defer 获取一个连接,协程结束后自动回收</h2><blockquote>
<p>​ 通过该方法无需手动回收连接,在协程结束后,则自动回收</p>
<p>​ 需要注意的事,defer 方法是协程结束后才回收,如果你当前协程运行时间过长,则会一直无法回收,直到协程结束</p>
</blockquote>
<h2 id="三者的联系和区别"><a href="#三者的联系和区别" class="headerlink" title="三者的联系和区别"></a>三者的联系和区别</h2><p>getObj 获取一个连接池对象, 需要手动回收, 而 defer 中封装了 swoole 的 Coroutine::defer, 在 Coroutine::defer 处理连接池对象的回收。</p>
<p>所以说 getObj 和 defer 的区别就在于回收的时机，前者自己把控，后者只能是在当前协程结束的时候回收。</p>
<p>而 invoke 是传入一个匿名函数，在 invoke 内部执行<code>$obj = $this-&gt;getObj()</code>, 然后将$obj 传入匿名函数。利用 try finally, 在匿名函数执行完毕后就回收对象。</p>
<p>总结：本质上都是通过 getObj 获取连接池对象。只不过 defer 和 invoke 又封装了一层，目的都是做到自动回收连接池对象。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/SPL/SplQueue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/SPL/SplQueue/" class="post-title-link" itemprop="url">SplQueue</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:12:21" itemprop="dateCreated datePublished" datetime="2020-12-11T23:12:21+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/SPL/" itemprop="url" rel="index"><span itemprop="name">SPL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><font color=red>先进先出</font></p>
<p>enqueue: 进入队列</p>
<p>dequeue: 退出队列, 返回退出队列的元素</p>
<p>bottom(): 队列底, 就是第一个添加到队列的元素</p>
<p>top(): 队列头, 就是最后一个添加到队列的元素</p>
<p>offsetSet(‘0’, data): 更新元素的值, offset&#x3D;0 是 bottom 所在的位置, 1、2、3… 以此类推</p>
<p>rewind(): 使得指针指向 bottom 所在位置的节点</p>
<p>key(): 当前节点的 index</p>
<p>current(): 当前节点的 value</p>
<p>valid(): 判断当前节点是否有效</p>
<p>next(): 使得指针指向下一个节点</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/SPL/SPL%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/SPL/SPL%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6/" class="post-title-link" itemprop="url">SPL基本框架</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 23:12:13" itemprop="dateCreated datePublished" datetime="2020-12-11T23:12:13+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/SPL/" itemprop="url" rel="index"><span itemprop="name">SPL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>参考：&#x2F;&#x2F;img.to2b.cn&#x2F;blog&#x2F;ljk&#x2F;1607699201217.png</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.lujinkai.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.lujinkai.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.lujinkai.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.lujinkai.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
