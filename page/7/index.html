<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.lujinkai.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.lujinkai.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/7/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/kafka/" class="post-title-link" itemprop="url">kafka</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-22 01:30:29" itemprop="dateCreated datePublished" datetime="2021-02-22T01:30:29+08:00">2021-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="http://kafka.apache.org/">http://kafka.apache.org/</a></p>
<p>阿里云兼容 kafka 消息队列：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/ons">https://www.aliyun.com/product/ons</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613982828738.png"></p>
<p>Kafka 是一种高吞吐量的分布式发布订阅消息系统，其具备分布式功能、并可以结合 zookeeper 可以实现动态扩容，用于构建实时数据管道和流应用程序<br>它具有水平可伸缩性、容错性、快速性</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613955258950.png"></p>
<p>常用消息队列对比：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613955346646.png"></p>
<h2 id="kafka-优势"><a href="#kafka-优势" class="headerlink" title="kafka 优势"></a>kafka 优势</h2><p>kafka 为什么性能高？</p>
<ol>
<li><strong>顺序写入</strong>，kafka 数据写入磁盘，不是保存在内存，默认保存 168 小时</li>
<li></li>
</ol>
<ul>
<li>kafka 通过 O(1)的磁盘数据结构提供消息的持久化，即使数以 TB 的消息存储也能够保持长时间的稳定性能<ul>
<li>O(1)是最低的时间复杂度，哈希算法就是典型的 O(1) 时间复杂度，无论数据规模多大，都可以在一次计算后找到目标</li>
</ul>
</li>
<li>高吞吐量，即使是非常普通的硬件 Kafka 也可以支持每秒数百万的消息</li>
<li>支持通过 Kafka 服务器分区消息，可以将数据保存到不同的服务器</li>
<li>支持 Hadoop 并行数据加载</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1613983260795.png"></p>
<h2 id="kafka-角色"><a href="#kafka-角色" class="headerlink" title="kafka 角色"></a>kafka 角色</h2><p><img data-src="//img.to2b.cn/blog/ljk/1614010759534.png"></p>
<ul>
<li><p><strong>broker</strong>：中文直译“中间人”，实际就是消息代理，是生产者和消费者中间代理保存消息的中转站，集群中每个 kafka 的 broker 都有唯一的 id，由 server.properties 中的 broker.id 指定，可以把每个 kafka 节点抽象的看成是一个 broker，也可以把整个 kafka 集群抽象的看成是一个 broker</p>
</li>
<li><p><strong>topic</strong>：话题，生产者和消费者监听同一个 topic，生产者往里写消息，消费者从里面读消息</p>
</li>
<li><p><strong>partition</strong>：分区，也叫分片，物理上的概念，每个分区对应一个文件夹，topic 可以将其消息<strong>分片储存，提高性能</strong>，然后每个分片做<strong>多个副本，保证高可用</strong>。</p>
<p>注意：分片数量不要超过 kafka 节点数量；副本数量也不要超过 kafka 节点数量；</p>
<ul>
<li><strong>leader</strong>：分片副本的角色，主</li>
<li><strong>follower</strong>：分片副本的角色，从</li>
</ul>
<p>对于一个分片，其副本只有一个是 leader，其他的都是 follower，leader 不能和 follower 在同一个节点，这样就失去了高可用的意义</p>
<p>高可用：当一个节点故障，其他的 follower 会选举出一个作为 leader</p>
<pre class="language-none"><code class="language-none">上图中 topic1 分了两片：topic1-part1、topic1-part2；
上图中 topic2 只有一片：topic2-part1

上图中 topic1 和 topic2 的分片都做了三个副本：topicX-part1、topicX-part2、topicX-part3</code></pre>
</li>
<li><p><strong>Producer</strong>：生产者，负责发布消息到 Kafka broker</p>
</li>
<li><p><strong>Consumer</strong>：消费者，每个 consumer 属于一个特定的 consuer group（若不指定 group name 则属于默认 group），使用 consumer high level API 时，同一 topic 的一条消息只能被同一个 consumer group 内的一个 consumer 消费，但多个 consumer group 可同时消费这一消息<br><img data-src="//img.to2b.cn/blog/ljk/1613999549455.png"></p>
</li>
</ul>
<h3 id="kafka-和-zookeeper-的关系："><a href="#kafka-和-zookeeper-的关系：" class="headerlink" title="kafka 和 zookeeper 的关系："></a>kafka 和 zookeeper 的关系：</h3><p>kafka 自身无法实现集群和高可用，kafka 依赖 zookeeper 实现集群和高可用</p>
<p>zookeeper 和 kafka 都可以存储数据，zookeeper 储存单个数据在 1MB 以内，只用来保存服务的元数据，不保存业务信息</p>
<ol>
<li>Broker 依赖于 Zookeeper，每个 Broker 的 id 和 Topic、Partition 这些元数据信息都会写入 Zookeeper 的 ZNode 节点中</li>
<li>Consumer 依赖于 Zookeeper，Consumer 在消费消息时，每消费完一条消息，会将产生的 offset 保存到 Zookeeper 中，下次消费在当前 offset 往后继续消费。注意：kafka0.9 之前 Consumer 的 offset 存储在 Zookeeper 中，kafka0,9 以后 offset 存储在本地</li>
<li>Partition 依赖于 Zookeeper，Partition 完成 Replication 备份后，选举出一个 Leader，这个是依托于 Zookeeper 的选举机制实现的</li>
</ol>
<h2 id="kafka-部署"><a href="#kafka-部署" class="headerlink" title="kafka 部署"></a>kafka 部署</h2><pre class="language-none"><code class="language-none">kakfa1.ljk.cn:10.0.1.101
kakfa2.ljk.cn:10.0.1.102
kakfa3.ljk.cn:10.0.1.103</code></pre>

<p>快速部署：<a target="_blank" rel="noopener" href="http://kafka.apache.org/quickstart">http://kafka.apache.org/quickstart</a></p>
<ol>
<li><p>安装 zookeeper，这里就不配置集群了，安装单机 zookeeper</p>
</li>
<li><p>安装 kafka</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># kafka 下载页面：http://kafka.apache.org/downloads</span>
<span class="token punctuation">[</span>root@kakfa1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> <span class="token parameter variable">-xzf</span> kafka_2.13-2.7.0.tgz
<span class="token punctuation">[</span>root@kakfa1 src<span class="token punctuation">]</span><span class="token variable">$mv</span> kafka_2.13-2.7.0 /usr/local/kafka
<span class="token punctuation">[</span>root@kakfa1 src<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/
<span class="token punctuation">[</span>root@kakfa1 local<span class="token punctuation">]</span><span class="token variable">$scp</span> <span class="token parameter variable">-r</span> ./kafka/ <span class="token number">10.0</span>.1.102:/usr/local
<span class="token punctuation">[</span>root@kakfa1 local<span class="token punctuation">]</span><span class="token variable">$scp</span> <span class="token parameter variable">-r</span> ./kafka/ <span class="token number">10.0</span>.1.103:/usr/local</code></pre>
</li>
<li><p>配置 kafka</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/hosts
<span class="token punctuation">..</span>.
<span class="token number">10.0</span>.1.101 kafka1.ljk.cn
<span class="token number">10.0</span>.1.102 kafka2.ljk.cn
<span class="token number">10.0</span>.1.103 kafka3.ljk.cn
<span class="token number">10.0</span>.1.101 zk1.ljk.cn			<span class="token comment"># zookeeper地址域名解析</span>

<span class="token punctuation">[</span>root@kakfa1 local<span class="token punctuation">]</span><span class="token variable">$vim</span> kafka/config/server.properties
<span class="token number">21</span> <span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">1</span>	<span class="token comment"># 每个 broker 在集群中的唯一标识，正整数</span>
<span class="token number">31</span> <span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://kafka1.ljk.cn:9092
<span class="token number">60</span> <span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/usr/local/kafka/kafka-logs	<span class="token comment"># kakfa用于保存数据的目录，所有的消都会存储在该目录当中</span>
<span class="token number">65</span> <span class="token assign-left variable">num.partitions</span><span class="token operator">=</span><span class="token number">1</span>	<span class="token comment"># 设置创建新topic的默认分区数量</span>
<span class="token number">103</span> <span class="token assign-left variable">log.retention.hours</span><span class="token operator">=</span><span class="token number">168</span>	<span class="token comment"># 设置kafka中消息保留时间，默认为168小时，即7天</span>
<span class="token comment"># 指定连接的zookeeper的地址,zk中存储了broker的元数据信息,如果zk是集群，多个zk地址使用逗号分割，这里为了方便，使用单机zookeeper，推荐使用域名，如果使用ip可能无法启动，不知道为什么</span>
<span class="token number">123</span> <span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span>zk1.ljk.cn:2181
<span class="token number">126</span> <span class="token assign-left variable">zookeeper.connection.timeout.ms</span><span class="token operator">=</span><span class="token number">6000</span>	<span class="token comment"># 设置连接zookeeper的超时时间，默认6s</span>

<span class="token punctuation">[</span>root@kakfa2 local<span class="token punctuation">]</span><span class="token variable">$vim</span> kafka/config/server.properties
<span class="token number">21</span> <span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">2</span>
<span class="token number">31</span> <span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://10.0.1.102:9092
<span class="token number">60</span> <span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/usr/local/kafka/kafka-logs
<span class="token number">103</span> <span class="token assign-left variable">log.retention.hours</span><span class="token operator">=</span><span class="token number">168</span>
<span class="token number">123</span> <span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span>zk1.ljk.cn:2181
<span class="token number">126</span> <span class="token assign-left variable">zookeeper.connection.timeout.ms</span><span class="token operator">=</span><span class="token number">6000</span>

<span class="token punctuation">[</span>root@kakfa3 local<span class="token punctuation">]</span><span class="token variable">$vim</span> kafka/config/server.properties
<span class="token number">21</span> <span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token number">31</span> <span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://10.0.1.103:9092
<span class="token number">60</span> <span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/usr/local/kafka/kafka-logs
<span class="token number">103</span> <span class="token assign-left variable">log.retention.hours</span><span class="token operator">=</span><span class="token number">168</span>
<span class="token number">123</span> <span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span>zk1.ljk.cn:2181
<span class="token number">126</span> <span class="token assign-left variable">zookeeper.connection.timeout.ms</span><span class="token operator">=</span><span class="token number">6000</span></code></pre>
</li>
<li><p>启动 kafka</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 bin<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/local/kafka/bin
<span class="token punctuation">[</span>root@kakfa1 bin<span class="token punctuation">]</span>$./kafka-server-start.sh <span class="token parameter variable">-daemon</span> <span class="token punctuation">..</span>/config/server.properties

<span class="token punctuation">[</span>root@kakfa2 bin<span class="token punctuation">]</span>$./kafka-server-start.sh <span class="token parameter variable">-daemon</span> <span class="token punctuation">..</span>/config/server.properties

<span class="token punctuation">[</span>root@kakfa3 bin<span class="token punctuation">]</span>$./kafka-server-start.sh <span class="token parameter variable">-daemon</span> <span class="token punctuation">..</span>/config/server.properties</code></pre></li>
</ol>
<h2 id="测试-kafka-读写数据"><a href="#测试-kafka-读写数据" class="headerlink" title="测试 kafka 读写数据"></a>测试 kafka 读写数据</h2><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/quickstart">http://kafka.apache.org/quickstart</a></p>
<h3 id="创建-topic"><a href="#创建-topic" class="headerlink" title="创建 topic"></a>创建 topic</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 bin<span class="token punctuation">]</span>$./kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--zookeeper</span> zk1.ljk.cn:2181 <span class="token punctuation">\</span>
<span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token punctuation">\</span>
--replication-factor <span class="token number">3</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--topic</span> lujinkai
Created topic lujinkai.</code></pre>

<ul>
<li>–create：创建 topic</li>
<li>–zookeeper：指定 zk 地址，虽然配置文件中已经指定了，但是命令行还要指定</li>
<li>–partitions：指定一个 topic 包含几个 partition，就是对 topic 分片，分片可以提高性能，但是一般不用分片，保持默认值 1 就可以，如果分片，也不要超过节点的数量</li>
<li>–replication-factor：指定 partition 的副本数量，kafka 实现高可用全靠 partition 的副本，如果设置 3，则一个 partition 就存储 3 份，注意不是 4 份</li>
<li>–topic：指定名称</li>
</ul>
<p>假设集群有 4 个 broker，一个 topic 有 4 个 partition，每个 partition 有 3 个副本。下图是每个 broker 上的副本分配情况：<br><img data-src="//img.to2b.cn/blog/ljk/1614016182677.png"></p>
<h3 id="验证-topic"><a href="#验证-topic" class="headerlink" title="验证 topic"></a>验证 topic</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 bin<span class="token punctuation">]</span>$./kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--zookeeper</span> zk1.ljk.cn:2181 <span class="token punctuation">\</span>
<span class="token parameter variable">--topic</span> lujinkai
Topic: lujinkai PartitionCount: <span class="token number">3</span>       ReplicationFactor: <span class="token number">3</span>    Configs:
        Topic: lujinkai Partition: <span class="token number">0</span>    Leader: <span class="token number">3</span>       Replicas: <span class="token number">3,2</span>,1 Isr: <span class="token number">3,2</span>,1
        Topic: lujinkai Partition: <span class="token number">1</span>    Leader: <span class="token number">1</span>       Replicas: <span class="token number">1,3</span>,2 Isr: <span class="token number">1,3</span>,2
        Topic: lujinkai Partition: <span class="token number">2</span>    Leader: <span class="token number">2</span>       Replicas: <span class="token number">2,1</span>,3 Isr: <span class="token number">2,1</span>,3</code></pre>

<p>说明：lujinkai 这个 topic 有三个分区分别为 0、1、2，分区 0 的 leader 是 3（broker.id），分区 0 有三个副本，并且状态都为 lsr（ln-sync，表示可以参加选举成为 leader）</p>
<h3 id="获取所有-topic"><a href="#获取所有-topic" class="headerlink" title="获取所有 topic"></a>获取所有 topic</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 bin<span class="token punctuation">]</span>$./kafka-topics.sh <span class="token parameter variable">--list</span> <span class="token parameter variable">--zookeeper</span> zk1.ljk.cn:2181
lujinkai</code></pre>

<h3 id="测试发送消息"><a href="#测试发送消息" class="headerlink" title="测试发送消息"></a>测试发送消息</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 bin<span class="token punctuation">]</span>$./kafka-console-producer.sh <span class="token parameter variable">--topic</span> lujinkai <span class="token punctuation">\</span>
--broker-list kafka1.ljk.cn:9092,kafka2.ljk.cn:9092,kafka3.ljk.cn:9092
<span class="token operator">></span>hello
<span class="token operator">></span>word
<span class="token operator">></span></code></pre>

<h3 id="测试获取消息"><a href="#测试获取消息" class="headerlink" title="测试获取消息"></a>测试获取消息</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kafka2 bin<span class="token punctuation">]</span>$./kafka-console-consumer.sh <span class="token parameter variable">--topic</span> lujinkai <span class="token punctuation">\</span>
--bootstrap-server kafka1.ljk.cn:9092,kafka2.ljk.cn:9092,kafka3.ljk.cn:9092 <span class="token punctuation">\</span>
--from-beginning
hello
word</code></pre>

<ul>
<li>–bootstrap-server：kafak 集群的地址，实际只写一个地址也行</li>
<li>–from-beginning：从最开始的数据进行消费</li>
</ul>
<h3 id="删除-topic"><a href="#删除-topic" class="headerlink" title="删除 topic"></a>删除 topic</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 bin<span class="token punctuation">]</span>$./kafka-topics.sh <span class="token parameter variable">--delete</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--topic</span> lujinkai <span class="token punctuation">\</span>
<span class="token parameter variable">--zookeeper</span> zk1.ljk.cn:2181
Topic lujinkai is marked <span class="token keyword">for</span> deletion.
Note: This will have no impact <span class="token keyword">if</span> delete.topic.enable is not <span class="token builtin class-name">set</span> to true.</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/ZooKeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/ZooKeeper/" class="post-title-link" itemprop="url">ZooKeeper</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-21 21:57:24" itemprop="dateCreated datePublished" datetime="2021-02-21T21:57:24+08:00">2021-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/">https://zookeeper.apache.org/</a></p>
<p>ZooKeeper 是一个分布式服务框架，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：命名服务、状态同步、配置中心、集群管理等</p>
<h2 id="命名服务"><a href="#命名服务" class="headerlink" title="命名服务"></a>命名服务</h2><p>命名服务是分布式系统最基本的公共服务之一。在分布式系统中，被命名的实体通常可以是集群中的机器、提供的服务地址或远程对象等，这些我们都可以统称它们为名字（Name），其中较为常见的就是一些分布式服务框架（如 RPC、RMI）中的服务地址列表，通过使用命名服务，客户端应用能够根据指定名字来获取资源的实体、服务地址和提供者的信息等</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613916145189.png"></p>
<h3 id="状态同步"><a href="#状态同步" class="headerlink" title="状态同步"></a>状态同步</h3><p>每个节点除了存储数据内容和 node 节点状态信息之外，还存储了已经注册的 APP 的状态信息，当有些节点或 APP 不可用，就将当前状态同步给其他服务</p>
<h3 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h3><p>现在我们大多数应用都是采用的是分布式开发的应用，搭建到不同的服务器上，可以使用 ZooKeeper 来实现配置中心，ZooKeeper 采用的是推拉相结合的方式： 客户端向服务端注册自己需要关注的节点，一旦该节点的数据发生变更，那么服务端就会向相应的客户端发送 Watcher 事件通知，客户端接收到这个消息通知后，需要主动到服务端获取最新的数据</p>
<h4 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h4><p>所谓集群管理，包括 <strong>集群监控</strong> 与 <strong>集群控制</strong> 两部分，前者侧重对集群运行时状态的收集，后者则是对集群进行操作与控制</p>
<ul>
<li>客户端如果对 ZooKeepe 的一个数据节点注册 Watcher 监听，那么当该数据节点的内容或是其子节点列表发生变更时，ZooKeeper 服务器就会向订阅的客户端发送变更通知</li>
<li>对在 ZooKeeper 上创建的临时节点，一旦客户端与服务器之间的会话失效，该临时节点也就被自动除</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">Watcher（事件监听器）：Zookeeper中很重要的特性。Zookeeper允许用户在指定节点上注册一些Watcher，并且在一些特定事件触发的时候，ZooKeeper服务端会将事件通知到感兴趣的客户端上去，该机制是 Zookeeper实现分布式协调服务的重要特性</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1613916728374.png"></p>
<p>0、生产者启动<br>1、生产者注册至 zookeeper<br>2、消费者启动并订阅频道<br>3、zookeeper 通知消费者事件<br>4、消费者调用生产者<br>5、监控中心负责统计和监控服务状态</p>
<h2 id="ZooKeeper-单机安装"><a href="#ZooKeeper-单机安装" class="headerlink" title="ZooKeeper 单机安装"></a>ZooKeeper 单机安装</h2><p>ZooKeeper 依赖 Java 环境，要求 JDK1.7 及以上</p>
<ol>
<li><p>配置 java 环境</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 ~<span class="token punctuation">]</span><span class="token variable">$java</span> <span class="token parameter variable">-version</span>
<span class="token function">java</span> version <span class="token string">"1.8.0_271"</span>
Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build <span class="token number">1.8</span>.0_271-b09<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span>build <span class="token number">25.271</span>-b09, mixed mode<span class="token punctuation">)</span></code></pre>
</li>
<li><p>部署 ZooKeeper<br>官网下载地址：<a target="_blank" rel="noopener" href="https://archive.apache.org/dist/zookeeper/">https://archive.apache.org/dist/zookeeper/</a><br>注意，要下载带 bin 的包，不带 bin 的只是源码包，不包含必要的 jar 包</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613922190627.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf apache-zookeeper-3.5.9-bin.tar.gz
<span class="token punctuation">[</span>root@zk1 src<span class="token punctuation">]</span><span class="token variable">$mv</span> apache-zookeeper-3.5.9-bin
<span class="token punctuation">[</span>root@zk1 src<span class="token punctuation">]</span><span class="token variable">$mv</span> apache-zookeeper-3.5.9-bin /usr/local/zookeeper
<span class="token punctuation">[</span>root@zk1 src<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/zookeeper/conf/
<span class="token punctuation">[</span>root@zk1 conf<span class="token punctuation">]</span><span class="token variable">$cp</span> zoo_sample.cfg zoo.cfg
<span class="token punctuation">[</span>root@zk1 conf<span class="token punctuation">]</span><span class="token variable">$grep</span> ^<span class="token punctuation">[</span>a-Z<span class="token punctuation">]</span> ./zoo.cfg
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/tmp/zookeeper
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token assign-left variable">admin.serverPort</span><span class="token operator">=</span><span class="token number">8180</span>		<span class="token comment"># AdminServer监听的端口，默认8080，因为tomcat默认端口也是8080，为了避免冲突，这里修改为8180</span></code></pre></li>
</ol>
<pre class="language-none"><code class="language-none">
   关于AdminServer：https:&#x2F;&#x2F;zookeeper.apache.org&#x2F;doc&#x2F;r3.5.0-alpha&#x2F;zookeeperAdmin.html#sc_adminserver_config

   ![](&#x2F;&#x2F;img.to2b.cn&#x2F;blog&#x2F;ljk&#x2F;1614092973758.png)

3. 启动 ZooKeeper

   &#96;&#96;&#96;bash
   # zkServer.sh 	用于启动、重启、停止 ZooKeeper
   [root@zk1 bin]$pwd
   &#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;bin
   [root@zk1 bin]$.&#x2F;zkServer.sh start
   ZooKeeper JMX enabled by default
   Using config: &#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg
   Starting zookeeper ... STARTED</code></pre>

<ol start="4">
<li><p>验证 Zookeeper 状态</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 bin<span class="token punctuation">]</span>$./zkServer.sh status
ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: standalone</code></pre></li>
</ol>
<h2 id="ZooKeeper-集群简介"><a href="#ZooKeeper-集群简介" class="headerlink" title="ZooKeeper 集群简介"></a>ZooKeeper 集群简介</h2><p>集群架构：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613922779811.png"></p>
<p>集群角色：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613922800778.png"></p>
<h2 id="Zookeeper-集群部署"><a href="#Zookeeper-集群部署" class="headerlink" title="Zookeeper 集群部署"></a>Zookeeper 集群部署</h2><p>整个集群中只要有超过集群数量一半的 zookeeper 工作只正常的，那么整个集群对外就是可用的</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">zk1.ljk.cn:10.0.1.101
zk2.ljk.cn:10.0.1.102
zk3.ljk.cn:10.0.1.103</code></pre>

<ol>
<li><p>各个节点安装 zookeeper，参考上面单机部署，但是先不要启动</p>
</li>
<li><p>各个节点创建数据目录</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/zookeeper/
<span class="token punctuation">[</span>root@zk1 zookeeper<span class="token punctuation">]</span><span class="token variable">$mkdir</span> data

<span class="token punctuation">[</span>root@zk2 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/zookeeper/
<span class="token punctuation">[</span>root@zk2 zookeeper<span class="token punctuation">]</span><span class="token variable">$mkdir</span> data

<span class="token punctuation">[</span>root@zk3 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/zookeeper/
<span class="token punctuation">[</span>root@zk3 zookeeper<span class="token punctuation">]</span><span class="token variable">$mkdir</span> data</code></pre>
</li>
<li><p>各个节点配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 conf<span class="token punctuation">]</span><span class="token variable">$grep</span> ^<span class="token punctuation">[</span>a-Z<span class="token punctuation">]</span> ./zoo.cfg
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>                     <span class="token comment"># 心跳检测周期，单位为毫秒</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>                      <span class="token comment"># leader与follower初始连接心跳次数，即多少个2000毫秒</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>                       <span class="token comment"># leader与follower连接完成之后，后期检测发送和应答的心跳次数，即该follower在5*2000毫秒内不能与leader进行通信，那么此follower将被视为不可用</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/usr/local/zookeeper/data <span class="token comment"># 自定义的zookeeper保存数据的目录</span>
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>                   <span class="token comment"># 客户端连接Zookeeper服务器的端口，Zookeeper会监听这个端口，接受客户端的访问请求</span>
<span class="token assign-left variable">maxClientCnxns</span><span class="token operator">=</span><span class="token number">128</span>                <span class="token comment"># 单个客户端IP可以和zookeeper保持的连接数</span>
<span class="token assign-left variable">autopurge.snapRetainCount</span><span class="token operator">=</span><span class="token number">3</span>       <span class="token comment"># 保存快照的数量，启用后ZooKeeper只保存最新的几个快照，其余的会自动清除，最新快照和相应的事务日志分别保留在dataDir和dataLogDir中，默认值为 3。最小值为 3</span>
<span class="token assign-left variable">autopurge.purgeInterval</span><span class="token operator">=</span><span class="token number">1</span>         <span class="token comment"># 自动清理日志和快照文件的频率，单位小时，默认0，不开启自动清理</span>
<span class="token assign-left variable">server.1</span><span class="token operator">=</span><span class="token number">10.0</span>.1.101:2888:3888     <span class="token comment"># server.服务器编号=服务器IP:LF数据同步端口:LF选举端口</span>
<span class="token assign-left variable">server.2</span><span class="token operator">=</span><span class="token number">10.0</span>.1.102:2888:3888     <span class="token comment"># hostname也可以，只要dns能解析到就行</span>
<span class="token assign-left variable">server.3</span><span class="token operator">=</span><span class="token number">10.0</span>.1.103:2888:3888

<span class="token punctuation">[</span>root@zk1 conf<span class="token punctuation">]</span><span class="token variable">$scp</span> ./zoo.cfg <span class="token number">10.0</span>.1.102:/usr/local/zookeeper/conf
<span class="token punctuation">[</span>root@zk1 conf<span class="token punctuation">]</span><span class="token variable">$scp</span> ./zoo.cfg <span class="token number">10.0</span>.1.103:/usr/local/zookeeper/conf</code></pre>
</li>
<li><p>集群 id</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token number">1</span> <span class="token operator">></span> myid

<span class="token punctuation">[</span>root@zk2 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token number">2</span> <span class="token operator">></span> myid

<span class="token punctuation">[</span>root@zk3 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token number">3</span> <span class="token operator">></span> myid</code></pre>
</li>
<li><p>启动 zookeeper</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 bin<span class="token punctuation">]</span>$./zkServer.sh start

<span class="token punctuation">[</span>root@zk2 bin<span class="token punctuation">]</span>$./zkServer.sh start

<span class="token punctuation">[</span>root@zk3 bin<span class="token punctuation">]</span>$./zkServer.sh start</code></pre>
</li>
<li><p>验证 Zookeeper 状态</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 bin<span class="token punctuation">]</span>$./zkServer.sh status
ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: follower		<span class="token comment"># follower</span>

<span class="token punctuation">[</span>root@zk2 bin<span class="token punctuation">]</span>$./zkServer.sh status
ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: follower		<span class="token comment"># follower</span>

<span class="token punctuation">[</span>root@zk3 bin<span class="token punctuation">]</span>$./zkServer.sh status
ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: leader		<span class="token comment"># leader</span></code></pre></li>
</ol>
<h3 id="zookeeper-集群选举过程"><a href="#zookeeper-集群选举过程" class="headerlink" title="zookeeper 集群选举过程"></a>zookeeper 集群选举过程</h3><p>节点角色状态：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">LOOKING   <span class="token comment"># 寻找 Leader 状态，处于该状态需要进入选举流程</span>
LEADING   <span class="token comment"># 领导者状态，处于该状态的节点说明是角色已经是 Leader</span>
FOLLOWING <span class="token comment"># 跟随者状态，表示 Leader 已经选举出来，当前节点角色是 follower</span>
OBSERVER  <span class="token comment"># 观察者状态，表明当前节点角色是 observer</span></code></pre>

<p>选举 ID：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ZXID	<span class="token comment"># zookeeper transaction id，每个改变Zookeeper状态的操作都会形成一个对应的zxid</span>
myid	<span class="token comment"># 服务器的唯一标识(SID)，通过配置myid文件指定，集群中唯一</span></code></pre>

<h2 id="zookeeper-数据增删改查"><a href="#zookeeper-数据增删改查" class="headerlink" title="zookeeper 数据增删改查"></a>zookeeper 数据增删改查</h2><p>任意一台 zookeeper 节点进行以下操作：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zk1 bin<span class="token punctuation">]</span>$./zkCli.sh <span class="token parameter variable">-server</span> <span class="token number">10.0</span>.1.102:2181
<span class="token punctuation">..</span>.
Welcome to ZooKeeper<span class="token operator">!</span>
JLine support is enabled
<span class="token punctuation">[</span>zk: <span class="token number">10.0</span>.1.102:2181<span class="token punctuation">(</span>CONNECTING<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token builtin class-name">help</span>
ZooKeeper <span class="token parameter variable">-server</span> host:port cmd args
        addauth scheme auth
        close
        config <span class="token punctuation">[</span>-c<span class="token punctuation">]</span> <span class="token punctuation">[</span>-w<span class="token punctuation">]</span> <span class="token punctuation">[</span>-s<span class="token punctuation">]</span>
        connect host:port
        create <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-e<span class="token punctuation">]</span> <span class="token punctuation">[</span>-c<span class="token punctuation">]</span> <span class="token punctuation">[</span>-t ttl<span class="token punctuation">]</span> path <span class="token punctuation">[</span>data<span class="token punctuation">]</span> <span class="token punctuation">[</span>acl<span class="token punctuation">]</span>
        delete <span class="token punctuation">[</span>-v version<span class="token punctuation">]</span> path
        deleteall path
        delquota <span class="token punctuation">[</span>-n<span class="token operator">|</span>-b<span class="token punctuation">]</span> path
        get <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-w<span class="token punctuation">]</span> path
        getAcl <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> path
        <span class="token function">history</span>
        listquota path
        <span class="token function">ls</span> <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-w<span class="token punctuation">]</span> <span class="token punctuation">[</span>-R<span class="token punctuation">]</span> path
        ls2 path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>
        printwatches on<span class="token operator">|</span>off
        quit
        reconfig <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-v version<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>-file path<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>-members <span class="token assign-left variable">serverID</span><span class="token operator">=</span>host:port1:port2<span class="token punctuation">;</span>port3<span class="token punctuation">[</span>,<span class="token punctuation">..</span>.<span class="token punctuation">]</span>*<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>-add <span class="token assign-left variable">serverId</span><span class="token operator">=</span>host:port1:port2<span class="token punctuation">;</span>port3<span class="token punctuation">[</span>,<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span class="token punctuation">]</span>* <span class="token punctuation">[</span>-remove serverId<span class="token punctuation">[</span>,<span class="token punctuation">..</span>.<span class="token punctuation">]</span>*<span class="token punctuation">]</span>
        redo cmdno
        removewatches path <span class="token punctuation">[</span>-c<span class="token operator">|</span>-d<span class="token operator">|</span>-a<span class="token punctuation">]</span> <span class="token punctuation">[</span>-l<span class="token punctuation">]</span>
        rmr path
        <span class="token builtin class-name">set</span> <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-v version<span class="token punctuation">]</span> path data
        setAcl <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-v version<span class="token punctuation">]</span> <span class="token punctuation">[</span>-R<span class="token punctuation">]</span> path acl
        setquota -n<span class="token operator">|</span>-b val path
        <span class="token function">stat</span> <span class="token punctuation">[</span>-w<span class="token punctuation">]</span> path
        <span class="token function">sync</span> path</code></pre>

<h2 id="zookeeper-客户端-ZooInspector"><a href="#zookeeper-客户端-ZooInspector" class="headerlink" title="zookeeper 客户端 ZooInspector"></a>zookeeper 客户端 ZooInspector</h2><p>Linux：<a target="_blank" rel="noopener" href="https://github.com/zzhang5/zooinspector">https://github.com/zzhang5/zooinspector</a><br>Windows：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/weiyiming007/p/11951591.html">https://www.cnblogs.com/weiyiming007/p/11951591.html</a></p>
<ol>
<li>下载、解压、双击 <code>build/zookeeper-dev-ZooInspector.jar </code><br><img data-src="//img.to2b.cn/blog/ljk/1614046764563.png"></li>
<li>连接成功<br><img data-src="//img.to2b.cn/blog/ljk/1614046817443.png"></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/RabbitMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/RabbitMQ/" class="post-title-link" itemprop="url">RabbitMQ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-21 21:56:47" itemprop="dateCreated datePublished" datetime="2021-02-21T21:56:47+08:00">2021-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>阿里云消息队列：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/ons">https://www.aliyun.com/product/ons</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613872511226.png"></p>
<p>RabbitMQ 基于 erlang 语言开发，具有高并发优点、支持分布式具有消息确认机制、消息持久化机制，消息可靠性和集群可靠性高，简单易用、运行稳定、跨平台、多语言开源</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613871128154.png"></p>
<p><strong>Broker</strong>：接收和分发消息的应用，RabbitMQ Server 就是 Message Broker<br><strong>Virtual host</strong>：出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念，当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个 vhost，每个用户在自己的 vhost 创建 exchange／queue 等<br><strong>Connection</strong>：publisher／consumer 和 broker 之间的 TCP 连接。<br><strong>Channel</strong>：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个 thread 创建单独的 channel 进行通讯，AMQP method 包含了 channel id 帮助客户端和 message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销。<br><strong>Exchange</strong>：message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到 queue 中去。常用的类型有：direct (point-to-point), topic (publish-subscribe) and fanout (multicast)。<br><strong>Queue</strong>：消息最终被送到这里等待 consumer 取走，先进先出，可以持久化到磁盘节点服务器<br><strong>Binding</strong>：exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key。Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据。</p>
<h2 id="RabbitMQ-中的生产者消费者示例"><a href="#RabbitMQ-中的生产者消费者示例" class="headerlink" title="RabbitMQ 中的生产者消费者示例"></a>RabbitMQ 中的生产者消费者示例</h2><p><img data-src="//img.to2b.cn/blog/ljk/1613871813675.png"></p>
<p>生产者发送消息到 broker server（RabbitMQ），在 Broker 内部，用户创建 Exchange／Queue，通过 Binding 规则将两者联系在一起，Exchange 分发消息，根据类型／binding 的不同分发策略有区别，消息最后来到 Queue 中，等待消费者取走</p>
<h2 id="RabbitMQ-单机部署"><a href="#RabbitMQ-单机部署" class="headerlink" title="RabbitMQ 单机部署"></a>RabbitMQ 单机部署</h2><p>快速部署示例：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/install-debian.html#apt-bintray-quick-start">https://www.rabbitmq.com/install-debian.html#apt-bintray-quick-start</a></p>
<ol>
<li><p>主机名解析</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$hostname</span>
mq1.ljk.cn
<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$hostname</span> <span class="token parameter variable">-I</span>
<span class="token number">10.0</span>.1.101
<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/hosts
<span class="token punctuation">..</span>.
<span class="token number">10.0</span>.1.101 mq1.ljk.cn mq1</code></pre>
</li>
<li><p>时间原因，选择 apt 安装，直接执行以下脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>

<span class="token comment">## If sudo is not available on the system,</span>
<span class="token comment">## uncomment the line below to install it</span>
<span class="token comment"># apt-get install -y sudo</span>

<span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token parameter variable">-y</span>

<span class="token comment">## Install prerequisites</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">curl</span> gnupg <span class="token parameter variable">-y</span>

<span class="token comment">## Install RabbitMQ signing key</span>
<span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token comment">## Install apt HTTPS transport</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https

<span class="token variable">$distribution</span><span class="token operator">=</span><span class="token string">'bionic'</span>		<span class="token comment"># ubuntu18.04</span>
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/bintray.rabbitmq.list <span class="token operator">&lt;&lt;</span><span class="token string">EOF
## 默认安装最新版本的 erlang 23.x，可以指定版本例如：erlang-22.x
deb https://dl.bintray.com/rabbitmq-erlang/debian <span class="token variable">$distribution</span> erlang
## Installs latest RabbitMQ release
deb https://dl.bintray.com/rabbitmq/debian <span class="token variable">$distribution</span> main
EOF</span>

<span class="token comment">## Update package indices</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token parameter variable">-y</span>

<span class="token comment">## Install rabbitmq-server and its dependencies</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> rabbitmq-server <span class="token parameter variable">-y</span> --fix-missing</code></pre>
</li>
<li><p>安装成功</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix src<span class="token punctuation">]</span><span class="token variable">$systemctl</span> status rabbitmq-server.service
● rabbitmq-server.service - RabbitMQ broker
   Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/rabbitmq-server.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Sun <span class="token number">2021</span>-02-21 02:41:45 UTC<span class="token punctuation">;</span> 1h 26min ago
 Main PID: <span class="token number">5992</span> <span class="token punctuation">(</span>beam.smp<span class="token punctuation">)</span>
   Status: <span class="token string">"Initialized"</span>
    Tasks: <span class="token number">22</span> <span class="token punctuation">(</span>limit: <span class="token number">2289</span><span class="token punctuation">)</span>
   CGroup: /system.slice/rabbitmq-server.service
           ├─5992 /usr/lib/erlang/erts-11.1.8/bin/beam.smp <span class="token parameter variable">-W</span> w <span class="token parameter variable">-MBas</span> ageffcbf <span class="token parameter variable">-MHas</span> ageffcbf <span class="token parameter variable">-MBlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MHlmbcs</span> <span class="token number">512</span> <span class="token parameter variable">-MMmcs</span> <span class="token number">30</span> <span class="token parameter variable">-P</span> <span class="token number">1048576</span> <span class="token parameter variable">-t</span> <span class="token number">5000000</span> <span class="token parameter variable">-stbt</span> db <span class="token parameter variable">-zd</span>
           ├─6013 erl_child_setup <span class="token number">32768</span>
           ├─6039 /usr/lib/erlang/erts-11.1.8/bin/epmd <span class="token parameter variable">-daemon</span>
           ├─6058 inet_gethost <span class="token number">4</span>
           └─6059 inet_gethost <span class="token number">4</span>
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>插件管理<br><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/management.html">https://www.rabbitmq.com/management.html</a><br>开启 web 管理界面</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix src<span class="token punctuation">]</span><span class="token variable">$which</span> rabbitmq-plugins
/usr/sbin/rabbitmq-plugins
<span class="token punctuation">[</span>root@zabbix src<span class="token punctuation">]</span><span class="token variable">$rabbitmq</span>-plugins <span class="token builtin class-name">enable</span> rabbitmq_management
Enabling plugins on <span class="token function">node</span> rabbit@mq1:
rabbitmq_management
The following plugins have been configured:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch
Applying plugin configuration to rabbit@mq1<span class="token punctuation">..</span>.
The following plugins have been enabled:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch

started <span class="token number">3</span> plugins.

<span class="token comment"># 5672		消费者访问的 端口</span>
<span class="token comment"># 15672		web 管理端口</span>
<span class="token comment"># 25672		集群状态通信端口</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> list_users
Listing <span class="token function">users</span> <span class="token punctuation">..</span>.
user    tags
guest   <span class="token punctuation">[</span>administrator<span class="token punctuation">]</span>		<span class="token comment"># guest是初始化的用户，账号密码都是guest，但是只能使用localhost访问</span>

<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> add_user ljk <span class="token number">123456</span>	<span class="token comment"># 添加用户</span>
Adding user <span class="token string">"ljk"</span> <span class="token punctuation">..</span>.
Done. Don<span class="token string">'t forget to grant the user permissions to some virtual hosts! See '</span>rabbitmqctl <span class="token builtin class-name">help</span> set_permissions' to learn more.
<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> set_user_tags ljk administrator	<span class="token comment"># 用户授权</span>
Setting tags <span class="token keyword">for</span> user <span class="token string">"ljk"</span> to <span class="token punctuation">[</span>administrator<span class="token punctuation">]</span> <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> list_users
Listing <span class="token function">users</span> <span class="token punctuation">..</span>.
user    tags
ljk     <span class="token punctuation">[</span>administrator<span class="token punctuation">]</span>		<span class="token comment"># 授权成功</span>
guest   <span class="token punctuation">[</span>administrator<span class="token punctuation">]</span></code></pre>

<p>使用账号 ljk，密码 123456，成功登录 web 管理界面：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613882317923.png"></p>
<p>登录之后，我们很少进行更改，主要是查看 rabbitmq 的运行状态</p>
</li>
</ol>
<h2 id="RabbitMQ-集群部署"><a href="#RabbitMQ-集群部署" class="headerlink" title="RabbitMQ 集群部署"></a>RabbitMQ 集群部署</h2><ul>
<li><strong>普通模式</strong>：创建好 RabbitMQ 集群之后的默认模式<br>所有的 mq 节点保存相同的元数据，即消息队列，但队列里的数据仅保存一份，消费者从 A 节点拉取消息，如果消息在 B 节点，那么 B 会将消息发送给 A 节点，然后消费者就能拉取到数据了<br>缺点：单点失败</li>
<li><strong>镜像模式</strong>：把需要的队列做成镜像队列<br>在普通模式的基础上，增加一些镜像策略，消息实体会主动在镜像节点间同步，而不是在 consumer 取数据时临时拉取，解决了单点失败的问题，但是性能下降，增加集群内部网络消耗一个<br>队列想做成镜像队列，需要先设置 policy，然后客户端创建队列的时候，rabbitmq 集群根据“队列名称”自动设置是普通集群模式或镜像队列</li>
</ul>
<p><strong>推荐设计架构：</strong></p>
<p>在一个 rabbitmq 集群里，有 3 台或以上机器，其中 1 台使用磁盘模式（数据保存到内存和磁盘），其它节点使用内存模式（数据只保存到内存），使用磁盘模式的节点，作为数据备份使用</p>
<h3 id="Ubuntu-1804-安装集群版-RabbitMQ"><a href="#Ubuntu-1804-安装集群版-RabbitMQ" class="headerlink" title="Ubuntu 1804 安装集群版 RabbitMQ"></a>Ubuntu 1804 安装集群版 RabbitMQ</h3><pre class="language-none"><code class="language-none">10.0.1.101 mq1.ljk.cn mq1
10.0.1.102 mq1.ljk.cn mq2
10.0.1.103 mq1.ljk.cn mq3</code></pre>

<p>Rabbitmq 的集群是依赖于 erlang 的集群来工作的，所以必须先构建起 erlang 的集群环境,而 Erlang 的集群中各节点是通过一个 magic cookie 来实现的，这个 cookie 存放在 &#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie 中，文件是 400 的权限,所以必须保证各节点 cookie 保持一致，否则节点之间就无法通信</p>
<ol>
<li><p>各节点安装 RabbitMQ 并安装插件，参考上面单机部署</p>
</li>
<li><p>各服务器关闭 RabbitMQ</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop rabbitmq-server.service
<span class="token punctuation">[</span>root@mq2 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop rabbitmq-server.service
<span class="token punctuation">[</span>root@mq3 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop rabbitmq-server.service</code></pre>
</li>
<li><p>在 mq1 同步.erlang.cookie 至其他两台服务器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /var/lib/rabbitmq/
<span class="token punctuation">[</span>root@mq1 rabbitmq<span class="token punctuation">]</span><span class="token variable">$scp</span> .erlang.cookie <span class="token number">10.0</span>.1.102:/var/lib/rabbitmq
<span class="token punctuation">[</span>root@mq1 rabbitmq<span class="token punctuation">]</span><span class="token variable">$scp</span> .erlang.cookie <span class="token number">10.0</span>.1.103:/var/lib/rabbitmq</code></pre>
</li>
<li><p>各服务器启动 RabbitMQ</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start rabbitmq-server.service
<span class="token punctuation">[</span>root@mq2 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start rabbitmq-server.service
<span class="token punctuation">[</span>root@mq3 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start rabbitmq-server.service</code></pre>
</li>
<li><p>查看当前集群状态</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> cluster_status
<span class="token punctuation">[</span>root@mq2 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> cluster_status
<span class="token punctuation">[</span>root@mq3 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> cluster_status</code></pre>
</li>
<li><p>创建 RabbitMQ 集群：mq1、mq2 作为内存节点，mq3 作为磁盘节点</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> stop_app 	<span class="token comment">#停止 app 服务</span>
<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> reset 		<span class="token comment">#清空元数据</span>
<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> join_cluster rabbit@mq3 <span class="token parameter variable">--ram</span> 	<span class="token comment">#将mq1添加到集群中，并成为内存节点，不加--ram默认是磁盘节点</span>
<span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> start_app	<span class="token comment">#启动 app 服务</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq2 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> stop_app
<span class="token punctuation">[</span>root@mq2 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> reset
<span class="token punctuation">[</span>root@mq2 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> join_cluster rabbit@mq3 <span class="token parameter variable">--ram</span>
<span class="token punctuation">[</span>root@mq2 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> start_app</code></pre>
</li>
<li><p>将集群设置为镜像模式，任意节点执行以下命令</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> set_policy ha-all <span class="token string">"#"</span> <span class="token string">'&#123;"ha-mode":"all"&#125;'</span></code></pre>
</li>
<li><p>查看集群状态</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> cluster_status
Cluster status of <span class="token function">node</span> rabbit@mq1 <span class="token punctuation">..</span>.
Basics

Cluster name: rabbit@mq3.ljk.cn

Disk Nodes

rabbit@mq3

RAM Nodes

rabbit@mq1
rabbit@mq2

Running Nodes

rabbit@mq1
rabbit@mq2
rabbit@mq3

Versions

rabbit@mq1: RabbitMQ <span class="token number">3.8</span>.12 on Erlang <span class="token number">23.2</span>.5
rabbit@mq2: RabbitMQ <span class="token number">3.8</span>.12 on Erlang <span class="token number">23.2</span>.5
rabbit@mq3: RabbitMQ <span class="token number">3.8</span>.12 on Erlang <span class="token number">23.2</span>.5

Maintenance status

Node: rabbit@mq1, status: not under maintenance
Node: rabbit@mq2, status: not under maintenance
Node: rabbit@mq3, status: not under maintenance

Alarms

<span class="token punctuation">(</span>none<span class="token punctuation">)</span>

Network Partitions

<span class="token punctuation">(</span>none<span class="token punctuation">)</span>

Listeners

Node: rabbit@mq1, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">15672</span>, protocol: http, purpose: HTTP API
Node: rabbit@mq1, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@mq1, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">5672</span>, protocol: amqp, purpose: AMQP <span class="token number">0</span>-9-1 and AMQP <span class="token number">1.0</span>
Node: rabbit@mq2, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@mq2, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">5672</span>, protocol: amqp, purpose: AMQP <span class="token number">0</span>-9-1 and AMQP <span class="token number">1.0</span>
Node: rabbit@mq2, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">15672</span>, protocol: http, purpose: HTTP API
Node: rabbit@mq3, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@mq3, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">5672</span>, protocol: amqp, purpose: AMQP <span class="token number">0</span>-9-1 and AMQP <span class="token number">1.0</span>
Node: rabbit@mq3, interface: <span class="token punctuation">[</span>::<span class="token punctuation">]</span>, port: <span class="token number">15672</span>, protocol: http, purpose: HTTP API

Feature flags

Flag: drop_unroutable_metric, state: enabled
Flag: empty_basic_get_metric, state: enabled
Flag: implicit_default_bindings, state: enabled
Flag: maintenance_mode_status, state: enabled
Flag: quorum_queue, state: enabled
Flag: user_limits, state: enabled
Flag: virtual_host_metadata, state: enabled</code></pre></li>
</ol>
<h2 id="RabbitMQ-常用命令"><a href="#RabbitMQ-常用命令" class="headerlink" title="RabbitMQ 常用命令"></a>RabbitMQ 常用命令</h2><ul>
<li><p>创建 vhost</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> add_vhost <span class="token builtin class-name">test</span>
Adding vhost <span class="token string">"test"</span> <span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>列出所有 vhost</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> list_vhosts
Listing vhosts <span class="token punctuation">..</span>.
name
/
<span class="token builtin class-name">test</span></code></pre>
</li>
<li><p>列出所有队列</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> list_queues
Timeout: <span class="token number">60.0</span> seconds <span class="token punctuation">..</span>.
Listing queues <span class="token keyword">for</span> vhost / <span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>删除指定 vhost</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> delete_vhost <span class="token builtin class-name">test</span>
Deleting vhost <span class="token string">"test"</span> <span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>添加账户 jack 密码为 123456</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> add_user jack <span class="token number">123456</span>
Adding user <span class="token string">"jack"</span> <span class="token punctuation">..</span>.
Done. Don<span class="token string">'t forget to grant the user permissions to some virtual hosts! See '</span>rabbitmqctl <span class="token builtin class-name">help</span> set_permissions' to learn more.</code></pre>
</li>
<li><p>更改用户密码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> change_password jack <span class="token number">654321</span>
Changing password <span class="token keyword">for</span> user <span class="token string">"jack"</span> <span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>设置 jack 用户对 test 的 vhost 有读写权限，三个点为配置正则、读和写</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mq1 ~<span class="token punctuation">]</span><span class="token variable">$rabbitmqctl</span> set_permissions <span class="token parameter variable">-p</span> <span class="token builtin class-name">test</span> jack <span class="token string">".*"</span> <span class="token string">".*"</span> <span class="token string">".*"</span></code></pre></li>
</ul>
<h2 id="RabbitMQ-API"><a href="#RabbitMQ-API" class="headerlink" title="RabbitMQ API"></a>RabbitMQ API</h2><h2 id="RabbitMQ-Cluster-Monitor"><a href="#RabbitMQ-Cluster-Monitor" class="headerlink" title="RabbitMQ Cluster Monitor"></a>RabbitMQ Cluster Monitor</h2><h3 id="集群状态监控"><a href="#集群状态监控" class="headerlink" title="集群状态监控"></a>集群状态监控</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/env python</span>
<span class="token comment"># coding:utf-8</span>
<span class="token comment">#Author: ZhangJie</span>
<span class="token function">import</span> subprocess

running_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
error_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token boolean">false</span> <span class="token operator">=</span> <span class="token string">"false"</span>
<span class="token boolean">true</span> <span class="token operator">=</span> <span class="token string">"true"</span>


def get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token string">"curl - s - u guest: guest http: // localhost: 15672/api/nodes &amp; > / dev/null"</span><span class="token punctuation">)</span>, <span class="token assign-left variable">shell</span><span class="token operator">=</span>True, <span class="token assign-left variable">stdout</span><span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>

    data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> data1:
        <span class="token keyword">if</span> i.get<span class="token punctuation">(</span><span class="token string">"running"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"true"</span><span class="token builtin class-name">:</span>
            running_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">))</span>
        else:
            error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">))</span>


def count_server<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>running_list<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span>:   <span class="token comment"># 可以判断错误列表大于 0 或者运行列表小于 3，3未总计的节点数量</span>
        print<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span>              <span class="token comment"># 100 就是集群内有节点运行不正常了</span>
    else:
        print<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>               <span class="token comment"># 50 为所有节点全部运行正常</span>


def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count_server<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="内存使用监控"><a href="#内存使用监控" class="headerlink" title="内存使用监控"></a>内存使用监控</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat rabbitmq_memory.py</span>
<span class="token comment">#!/bin/env python</span>
<span class="token comment"># coding:utf-8</span>
<span class="token comment">#Author: ZhangJie</span>
<span class="token function">import</span> subprocess
<span class="token function">import</span> sys

running_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
error_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token boolean">false</span> <span class="token operator">=</span> <span class="token string">"false"</span>
<span class="token boolean">true</span> <span class="token operator">=</span> <span class="token string">"true"</span>


def get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token string">"curl - s - u guest: guest http: // localhost: 15672/api/nodes &amp; > / dev/null"</span><span class="token punctuation">)</span>, <span class="token assign-left variable">shell</span><span class="token operator">=</span>True, <span class="token assign-left variable">stdout</span><span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>

    data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token comment"># print(data1)</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> data1:
        <span class="token keyword">if</span> i.get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token operator">==</span> sys.argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>:
            print<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">"mem_used"</span><span class="token punctuation">))</span>


def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

root@mq-server3: ~  <span class="token comment"># python3 rabbitmq_memory.py rabbit@mq-server1</span>
<span class="token number">85774336</span>
root@mq-server3: ~  <span class="token comment"># python3 rabbitmq_memory.py rabbit@mq-server2</span>
<span class="token number">91099136</span>
root@mq-server3: ~  <span class="token comment"># python3 rabbitmq_memory.py rabbit@mq-server3</span>
<span class="token number">96428032</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/MQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/MQ/" class="post-title-link" itemprop="url">MQ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 11:56:27" itemprop="dateCreated datePublished" datetime="2021-02-20T11:56:27+08:00">2021-02-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>MQ：Message Queuing，消息队列</p>
<p>Message Queue 的需求由来已久，在 19 世纪 80 年代金融交易中，美国高盛等公司采用 Teknekron 公司的产品，当时的 Message queuing 软件叫做(the informationbus（TIB）,后来 TIB 被电信和通讯等公司采用，然后路透社收购了 Teknekron 公司，再然后 IBM 公司开发了 MQSeries，并且微软也开发了 Microsoft Message Queue（MSMQ），但是这些商业 MQ 供应商的问题是厂商锁定及使用价格高昂，于是 2001 年，Java Message queuing 试图解决锁定和交互性的问题，但对应用来说反而更加麻烦了，于是 2004 年，摩根大通和 iMatrix 开始着手 Advanced MessageQueuing Protocol （<strong>AMQP</strong>）开放标准的开发，2006 年，AMQP 规范发布，2007 年，Rabbit 技术公司基于 AMQP 标准开发的 RabbitMQ1.0 发布。</p>
<p>消息队列的目的是实现各个 APP 之间的通信（包括跨网咯通信），APP 基于 MQ 实现消息的发送和接收，实现应用程序之间的通信，实现业务的解耦的异步机制</p>
<p>消息队列作为高并发系统的核心组件之一，能够帮助业务系统解构，提升开发效率和系统稳定性。消息队列主要具有以下优势：</p>
<ul>
<li>削峰填谷：主要解决瞬时写压力大于应用服务能力导致消息丢失、系统奔溃等问题</li>
<li>系统解耦：解决不同重要程度、不同能力级别系统之间依赖导致一死全死</li>
<li>提升性能：当存在一对多调用时，可以发一条消息给消息系统，让消息系统通知相关系统</li>
<li>蓄流压测：线上有些链路不好压测，可以通过堆积一定量消息再放开来压测</li>
</ul>
<p>目前主流的消息队列软件有 RabbitMQ、kafka、ActiveMQ、RocketMQ 等，还有小众的消息队列软件如 ZeroMQ、Apache Qpid 等</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/" class="post-title-link" itemprop="url">dubbo</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-20 11:56:11" itemprop="dateCreated datePublished" datetime="2021-02-20T11:56:11+08:00">2021-02-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">消息队列与微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>微服务这个概念是从单体服务（单体应用）演化而来的</p>
<p>微服务：micro server，把单体服务拆分成多个小服务，这些小服务就是微服务，每个小服务运行在单独的运行环境，早期一般用虚拟机，现在都是容器（docker + k8s）</p>
<ul>
<li>微服务落地：容器，k8s + docker</li>
<li>微服务发现对方：注册中心、<strong>服务发现</strong>，zookeeper</li>
<li>微服务之间相互调用：API</li>
<li>微服务扩容：服务治理，k8s 实现服务编排</li>
<li>微服务监控：监控微服务的 API 等</li>
<li>微服务代码升级和回滚：CI &#x2F; CD jenkings + gitlab</li>
<li>微服务日志查看：ELK，统一收集和展示</li>
</ul>
<p><strong>服务是相互调用的，一个服务可以即是服务提供方，同时又是服务消费方</strong></p>
<h2 id="微服务框架"><a href="#微服务框架" class="headerlink" title="微服务框架"></a>微服务框架</h2><p>这个开发比较关注微服务框架，作为运维，了解即可</p>
<h3 id="spring-boot"><a href="#spring-boot" class="headerlink" title="spring boot"></a>spring boot</h3><h3 id="spring-cloud"><a href="#spring-cloud" class="headerlink" title="spring cloud"></a>spring cloud</h3><h3 id="dubbo"><a href="#dubbo" class="headerlink" title="dubbo"></a>dubbo</h3><p>阿里云微服务：<a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/act/edasdubbo.html">https://promotion.aliyun.com/ntms/act/edasdubbo.html</a><br>dubbo 官网：<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/">https://dubbo.apache.org/zh/</a><br>阿里云 dubbo 简介：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/99299.html">https://help.aliyun.com/document_detail/99299.html</a></p>
<h4 id="dubbo-架构"><a href="#dubbo-架构" class="headerlink" title="dubbo 架构"></a>dubbo 架构</h4><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/preface/architecture/">https://dubbo.apache.org/zh/docs/v2.7/user/preface/architecture/</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614042570280.png"></p>
<p><strong>节点角色说明：</strong></p>
<table>
<thead>
<tr>
<th>节点</th>
<th>角色说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Provider</code></td>
<td>暴露服务的服务提供方</td>
</tr>
<tr>
<td><code>Consumer</code></td>
<td>调用远程服务的服务消费方</td>
</tr>
<tr>
<td><code>Registry</code></td>
<td>服务注册与发现的注册中心</td>
</tr>
<tr>
<td><code>Monitor</code></td>
<td>统计服务的调用次数和调用时间的监控中心</td>
</tr>
<tr>
<td><code>Container</code></td>
<td>服务运行容器</td>
</tr>
</tbody></table>
<p><strong>调用关系说明：</strong></p>
<ol>
<li>服务容器负责启动，加载，运行服务提供者。</li>
<li>服务提供者在启动时，向注册中心注册自己提供的服务。</li>
<li>服务消费者在启动时，向注册中心订阅自己所需的服务。</li>
<li>注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</li>
<li>服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</li>
<li>服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</li>
</ol>
<p>Dubbo 架构具有以下几个特点，分别是连通性、健壮性、伸缩性、以及向未来架构的升级性。</p>
<h5 id="连通性"><a href="#连通性" class="headerlink" title="连通性"></a>连通性</h5><ul>
<li>注册中心负责服务地址的注册与查找，相当于目录服务，服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小</li>
<li>监控中心负责统计各服务调用次数，调用时间等，统计先在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示</li>
<li>服务提供者向注册中心注册其提供的服务，并汇报调用时间到监控中心，此时间不包含网络开销</li>
<li>服务消费者向注册中心获取服务提供者地址列表，并根据负载算法直接调用提供者，同时汇报调用时间到监控中心，此时间包含网络开销</li>
<li>注册中心，服务提供者，服务消费者三者之间均为长连接，监控中心除外</li>
<li>注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者</li>
<li>注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表</li>
<li>注册中心和监控中心都是可选的，服务消费者可以直连服务提供者</li>
</ul>
<h5 id="健壮性"><a href="#健壮性" class="headerlink" title="健壮性"></a>健壮性</h5><ul>
<li>监控中心宕掉不影响使用，只是丢失部分采样数据</li>
<li>数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务</li>
<li>注册中心对等集群，任意一台宕掉后，将自动切换到另一台</li>
<li>注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯</li>
<li>服务提供者无状态，任意一台宕掉后，不影响使用</li>
<li>服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复</li>
</ul>
<h5 id="伸缩性"><a href="#伸缩性" class="headerlink" title="伸缩性"></a>伸缩性</h5><ul>
<li>注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心</li>
<li>服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者</li>
</ul>
<h5 id="升级性"><a href="#升级性" class="headerlink" title="升级性"></a>升级性</h5><p>当服务集群规模进一步扩大，带动 IT 治理结构进一步升级，需要实现动态部署，进行流动计算，现有分布式服务架构不会带来阻力。下图是未来可能的一种架构：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614083003182.png"></p>
<p><strong>节点角色说明：</strong></p>
<table>
<thead>
<tr>
<th>节点</th>
<th>角色说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Deployer</code></td>
<td>自动部署服务的本地代理</td>
</tr>
<tr>
<td><code>Repository</code></td>
<td>仓库用于存储服务应用发布包</td>
</tr>
<tr>
<td><code>Scheduler</code></td>
<td>调度中心基于访问压力自动增减服务提供者</td>
</tr>
<tr>
<td><code>Admin</code></td>
<td>统一管理控制台</td>
</tr>
<tr>
<td><code>Registry</code></td>
<td>服务注册与发现的注册中心</td>
</tr>
<tr>
<td><code>Monitor</code></td>
<td>统计服务的调用次数和调用时间的监控中心</td>
</tr>
</tbody></table>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="生产者示例"><a href="#生产者示例" class="headerlink" title="生产者示例"></a>生产者示例</h3><p>zk 配置：<a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/user/references/registry/zookeeper/">https://dubbo.apache.org/zh/docs/v2.7/user/references/registry/zookeeper/</a></p>
<p>注册中心除了 zookeeper，还有其他方式：Nacos、Multicast、Redis、Simple</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@provider1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf dubbo-demo-provider-2.1.5-assembly.tar.gz	<span class="token comment"># 开发写的包</span>
<span class="token punctuation">[</span>root@provider1 src<span class="token punctuation">]</span><span class="token variable">$cd</span> dubbo-demo-provider-2.1.5/
<span class="token punctuation">[</span>root@provider1 dubbo-demo-provider-2.1.5<span class="token punctuation">]</span><span class="token variable">$ls</span>
bin  conf  lib

<span class="token punctuation">[</span>root@provider1 dubbo-demo-provider-2.1.5<span class="token punctuation">]</span><span class="token variable">$vim</span> conf/dubbo.properties
<span class="token assign-left variable">dubbo.container</span><span class="token operator">=</span>log4j,spring
<span class="token assign-left variable">dubbo.application.name</span><span class="token operator">=</span>demo-provider
<span class="token assign-left variable">dubbo.application.owner</span><span class="token operator">=</span>
<span class="token comment"># dubbo.registry.address=zookeeper://10.0.1.101:2181 | zookeeper://10.0.1.102:2181 | zookeeper://10.0.1.103:2181	# 注册中心：zookeeper，z集群k</span>
<span class="token assign-left variable">dubbo.registry.address</span><span class="token operator">=</span>zookeeper://10.0.1.101:2181	<span class="token comment"># 注册中心：zookeeper，单zk</span>
<span class="token assign-left variable">dubbo.monitor.protocol</span><span class="token operator">=</span>registry
<span class="token assign-left variable">dubbo.protocol.name</span><span class="token operator">=</span>dubbo
<span class="token assign-left variable">dubbo.protocol.port</span><span class="token operator">=</span><span class="token number">20880</span>
<span class="token assign-left variable">dubbo.log4j.file</span><span class="token operator">=</span>logs/dubbo-demo-provider.log
<span class="token assign-left variable">dubbo.log4j.level</span><span class="token operator">=</span>WARN

<span class="token punctuation">[</span>root@provider1 dubbo-demo-provider-2.1.5<span class="token punctuation">]</span>$./bin/start.sh	<span class="token comment"># 启动provider，可能需要几分钟</span>
Starting the demo-provider <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>OK<span class="token operator">!</span>
PID: <span class="token number">2813</span>
STDOUT: logs/stdout.log

<span class="token punctuation">[</span>root@provider1 dubbo-demo-provider-2.1.5<span class="token punctuation">]</span><span class="token variable">$tail</span> <span class="token parameter variable">-f</span> logs/stdout.log	<span class="token comment"># 查看日志</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM warning: ignoring option <span class="token assign-left variable">PermSize</span><span class="token operator">=</span>128m<span class="token punctuation">;</span> support was removed <span class="token keyword">in</span> <span class="token number">8.0</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and will likely be removed <span class="token keyword">in</span> a future release.
log4j:WARN No appenders could be found <span class="token keyword">for</span> logger <span class="token punctuation">(</span>com.alibaba.dubbo.common.logger.LoggerFactory<span class="token punctuation">)</span>.
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html<span class="token comment">#noconfig for more info.</span>
<span class="token punctuation">[</span><span class="token number">2021</span>-02-23 <span class="token number">13</span>:25:48<span class="token punctuation">]</span> Dubbo <span class="token function">service</span> server started<span class="token operator">!</span>		<span class="token comment"># 启动成功</span>
</code></pre>

<h3 id="消费者示例"><a href="#消费者示例" class="headerlink" title="消费者示例"></a>消费者示例</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@consumer1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf dubbo-demo-consumer-2.1.5-assembly.tar.gz	<span class="token comment"># 开发写的包</span>
<span class="token punctuation">[</span>root@consumer1 src<span class="token punctuation">]</span><span class="token variable">$cd</span> dubbo-demo-consumer-2.1.5/
<span class="token punctuation">[</span>root@consumer1 dubbo-demo-consumer-2.1.5<span class="token punctuation">]</span><span class="token variable">$vim</span> conf/dubbo.properties
<span class="token assign-left variable">dubbo.container</span><span class="token operator">=</span>log4j,spring
<span class="token assign-left variable">dubbo.application.name</span><span class="token operator">=</span>demo-consumer
<span class="token assign-left variable">dubbo.application.owner</span><span class="token operator">=</span>
<span class="token assign-left variable">dubbo.registry.address</span><span class="token operator">=</span>zookeeper://10.0.1.101:2181
<span class="token assign-left variable">dubbo.monitor.protocol</span><span class="token operator">=</span>registry
<span class="token assign-left variable">dubbo.log4j.file</span><span class="token operator">=</span>logs/dubbo-demo-consumer.log
<span class="token assign-left variable">dubbo.log4j.level</span><span class="token operator">=</span>WARN
<span class="token punctuation">[</span>root@kafka3 dubbo-demo-consumer-2.1.5<span class="token punctuation">]</span>$./bin/start.sh 	<span class="token comment"># 启动consumer</span>
Starting the demo-consumer <span class="token punctuation">..</span><span class="token punctuation">..</span>OK<span class="token operator">!</span>
PID: <span class="token number">2498</span>
STDOUT: logs/stdout.log

<span class="token punctuation">[</span>root@consumer1 dubbo-demo-consumer-2.1.5<span class="token punctuation">]</span><span class="token variable">$tail</span> <span class="token parameter variable">-f</span> logs/stdout.log 	<span class="token comment"># 查看日志</span>
<span class="token punctuation">[</span><span class="token number">13</span>:33:22<span class="token punctuation">]</span> Hello world23, response form provider: <span class="token number">10.0</span>.1.101:20880
<span class="token punctuation">[</span><span class="token number">13</span>:33:24<span class="token punctuation">]</span> Hello world24, response form provider: <span class="token number">10.0</span>.1.101:20880
<span class="token punctuation">[</span><span class="token number">13</span>:33:26<span class="token punctuation">]</span> Hello world25, response form provider: <span class="token number">10.0</span>.1.101:20880
<span class="token punctuation">[</span><span class="token number">13</span>:33:28<span class="token punctuation">]</span> Hello world26, response form provider: <span class="token number">10.0</span>.1.101:20880


<span class="token punctuation">[</span>root@provider1 dubbo-demo-provider-2.1.5<span class="token punctuation">]</span><span class="token variable">$tail</span> <span class="token parameter variable">-f</span> logs/stdout.log
<span class="token punctuation">[</span><span class="token number">13</span>:34:18<span class="token punctuation">]</span> Hello world51, request from consumer: /10.0.1.103:13243
<span class="token punctuation">[</span><span class="token number">13</span>:34:20<span class="token punctuation">]</span> Hello world52, request from consumer: /10.0.1.103:13243
<span class="token punctuation">[</span><span class="token number">13</span>:34:22<span class="token punctuation">]</span> Hello world53, request from consumer: /10.0.1.103:13243
<span class="token punctuation">[</span><span class="token number">13</span>:34:24<span class="token punctuation">]</span> Hello world54, request from consumer: /10.0.1.103:13243
<span class="token punctuation">[</span><span class="token number">13</span>:34:26<span class="token punctuation">]</span> Hello world55, request from consumer: /10.0.1.103:13243
<span class="token punctuation">[</span><span class="token number">13</span>:34:28<span class="token punctuation">]</span> Hello world56, request from consumer: /10.0.1.103:13243</code></pre>

<p>以上示例是一个 provider，如果是多个 provider，则 consumer 会轮询读取</p>
<h3 id="zookeeper-验证"><a href="#zookeeper-验证" class="headerlink" title="zookeeper 验证"></a>zookeeper 验证</h3><p><img data-src="//img.to2b.cn/blog/ljk/1614087959466.png"></p>
<h2 id="dubbo-admin"><a href="#dubbo-admin" class="headerlink" title="dubbo admin"></a>dubbo admin</h2><p>基于 zookeeper 发现并管理 provider 和 consumer</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kakfa1 webapps<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop tomcat.service  <span class="token comment"># 先关闭tomcat，否则自动解压会出错</span>
<span class="token punctuation">[</span>root@kakfa1 webapps<span class="token punctuation">]</span><span class="token variable">$unzip</span> dubboadmin.war <span class="token parameter variable">-d</span> dubboadmin  <span class="token comment"># 别人编译好的包，手动解压</span>
<span class="token punctuation">[</span>root@kakfa1 webapps<span class="token punctuation">]</span><span class="token variable">$vim</span> dubboadmin/WEB-INF/dubbo.properties	<span class="token comment"># 配置文件</span>
<span class="token assign-left variable">dubbo.registry.address</span><span class="token operator">=</span>zookeeper://10.0.1.101:2181	<span class="token comment"># zookeeper地址</span>
<span class="token assign-left variable">dubbo.admin.root.password</span><span class="token operator">=</span>root	<span class="token comment"># root用户，账号密码都是root</span>
<span class="token assign-left variable">dubbo.admin.guest.password</span><span class="token operator">=</span>guest	<span class="token comment"># 访客</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1614094423423.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614094441958.png"></p>
<p>这个 duboadmin 版本比较老，如果需要新版的 dubboadmin，需要手动编译</p>
<h2 id="微服务编译"><a href="#微服务编译" class="headerlink" title="微服务编译"></a>微服务编译</h2><p><a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/v2.7/dev/build/">https://dubbo.apache.org/zh/docs/v2.7/dev/build/</a></p>
<h3 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h3><p>编译 c、c++，使用 make、cmake，编译 java，使用 maven</p>
<p>maven 是一个项目管理工具，可以对 Java 项目进行构建、解决打包依赖等</p>
<p><strong>POM：</strong>Project Object Model，项目对象模型，是 Maven 工程的基本工作单元，是一个 XML 文件，包含了项目的基本信息，用于描述项目如何构建，声明项目依赖等，在执行任务或目标时，Maven 会在当前目录中查找 pom 文件，通过读取 pom 文件获取所需的配置信息，然后执行目标</p>
<p>Pom 文件中可以指定以下配置：</p>
<pre class="language-none"><code class="language-none">项目依赖
插件
执行目标
项目构建 profile
项目版本
项目开发者列表
相关邮件列表信息</code></pre>

<p><strong>部署 Maven：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 官方文档：http://maven.apache.org/install.html</span>
<span class="token comment"># 官方源：https://archive.apache.org/dist/maven/maven-3/</span>
<span class="token comment"># 清华源：https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/</span>

<span class="token punctuation">[</span>root@kakfa1 src<span class="token punctuation">]</span><span class="token variable">$wget</span> https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
<span class="token punctuation">[</span>root@kakfa1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf apache-maven-3.6.3-bin.tar.gz
<span class="token punctuation">[</span>root@kakfa1 src<span class="token punctuation">]</span><span class="token variable">$cd</span> apache-maven-3.6.3/
<span class="token punctuation">[</span>root@kakfa1 apache-maven-3.6.3<span class="token punctuation">]</span><span class="token variable">$export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/bin:<span class="token environment constant">$PATH</span></code></pre>

<p><strong>Maven 打包命令：</strong></p>
<ol>
<li><p>进入到包含有“pom.xml”的路径，执行：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mvn clean <span class="token function">install</span> package</code></pre>
</li>
<li><p>有的时候受到测试的干扰，导致无法正在进行编译，这时候可以选择跳过测试：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mvn clean <span class="token function">install</span> package <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true

<span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true		<span class="token comment"># 跳过测试，并且不编译测试下的源代码；</span>
<span class="token parameter variable">-DskipTests</span>					<span class="token comment"># 不执行测试，但是会进行测试代码的编译；</span></code></pre>
</li>
<li><p>如果需要编译的代码异常庞大，需要考虑对编译环境做一些处理，提高编译效率</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mvn <span class="token parameter variable">-T</span> <span class="token number">4</span> clean <span class="token function">install</span> package <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true		<span class="token comment"># 启动多线程编译</span>
mvn <span class="token parameter variable">-T</span> 2C clean <span class="token function">install</span> package <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true		<span class="token comment"># 分配编译的CPU个数</span>
mvn clean <span class="token function">install</span> package <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true <span class="token parameter variable">-Dmaven.compile.fork</span><span class="token operator">=</span>true	<span class="token comment"># 启用多线程编译</span></code></pre>
</li>
<li><p>所有的 Maven 都是建立在 JVM 上的，所以进行编译的时候还需要考虑 JVM 参数优化</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># bin/mvn是shell文件，配置参数：“MAVEN_OPTS”</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">MAVEN_OPTS</span><span class="token operator">=</span><span class="token string">"-Xmx6g -Xms6g"</span> <span class="token operator">>></span> /etc/profile
$ <span class="token builtin class-name">.</span> /etc/profile</code></pre></li>
</ol>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><p>以 dubbo admin 为例：<a target="_blank" rel="noopener" href="https://github.com/apache/dubbo-admin/blob/develop/README_ZH.md">https://github.com/apache/dubbo-admin/blob/develop/README_ZH.md</a></p>
<ol>
<li><p>下载代码:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> clone https://github.com/apache/dubbo-admin.git</code></pre>
</li>
<li><p>指定注册中心地址</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">vim</span> dubbo-admin-server/src/main/resources/application.properties
<span class="token punctuation">..</span>.
<span class="token comment"># centers in dubbo2.7</span>
<span class="token assign-left variable">admin.registry.address</span><span class="token operator">=</span>zookeeper://10.0.1.101:2181
admin.config-center<span class="token operator">=</span>zookeeper://10.0.1.101:2181
admin.metadata-report.address<span class="token operator">=</span>zookeeper://10.0.1.101:2181
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>构建：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ mvn clean package <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true</code></pre>
</li>
<li><p>启动：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ mvn <span class="token parameter variable">--projects</span> dubbo-admin-server spring-boot:run
<span class="token comment"># 或</span>
$ <span class="token builtin class-name">cd</span> dubbo-admin-distribution/target<span class="token punctuation">;</span>
$ <span class="token function">java</span> <span class="token parameter variable">-jar</span> dubbo-admin-0.2.0.jar <span class="token parameter variable">--server.port</span><span class="token operator">=</span><span class="token number">8080</span> <span class="token comment"># 注意端口冲突</span></code></pre>
</li>
<li><p>访问：浏览器访问 <a target="_blank" rel="noopener" href="http://10.0.1.101:8080/">http://10.0.1.101:8080</a></p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix_proxy.conf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/zabbix/zabbix_proxy.conf/" class="post-title-link" itemprop="url">zabbix_proxy.conf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-15 15:52:04" itemprop="dateCreated datePublished" datetime="2021-02-15T15:52:04+08:00">2021-02-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/zabbix/" itemprop="url" rel="index"><span itemprop="name">zabbix</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># vim /apps/zabbix_proxy/etc/zabbix_proxy.conf</span>
<span class="token assign-left variable">ProxyMode</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment">#0为主动，1为被动</span>
<span class="token assign-left variable">Server</span><span class="token operator">=</span><span class="token number">10.0</span>.58.101 <span class="token comment">#zabbix server服务器的地址或主机名</span>
<span class="token assign-left variable">Hostname</span><span class="token operator">=</span>magedu-jiege-proxy-active <span class="token comment">#代理服务器名称，与zabbix server添加代理时候的proxy name一致</span>
<span class="token assign-left variable">ListenPort</span><span class="token operator">=</span><span class="token number">10051</span> <span class="token comment">#zabbix proxy监听端口</span>
<span class="token assign-left variable">LogFile</span><span class="token operator">=</span>/tmp/zabbix_proxy.log
<span class="token assign-left variable">PidFile</span><span class="token operator">=</span>/apps/zabbix_proxy/run/zabbix_proxy.pid
<span class="token assign-left variable">EnableRemoteCommands</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment">#允许zabbix server执行远程命令</span>
<span class="token assign-left variable">DBHost</span><span class="token operator">=</span><span class="token number">10.0</span>.58.104 <span class="token comment">#数据库服务器地址</span>
<span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix_proxy_active <span class="token comment">#使用的数据库名称</span>
<span class="token assign-left variable">DBUser</span><span class="token operator">=</span>proxy <span class="token comment">#连接数据库的用户名称</span>
<span class="token assign-left variable">DBPassword</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token comment">#数据库用户密码</span>
<span class="token assign-left variable">DBPort</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token comment">#数据库端口</span>
<span class="token assign-left variable">ProxyLocalBuffer</span><span class="token operator">=</span><span class="token number">720</span> <span class="token comment">#已经提交到zabbix server的数据保留时间</span>
<span class="token assign-left variable">ProxyOfflineBuffer</span><span class="token operator">=</span><span class="token number">720</span> <span class="token comment">#未提交到zabbix server的时间保留时间</span>
<span class="token assign-left variable">HeartbeatFrequency</span><span class="token operator">=</span><span class="token number">60</span> <span class="token comment">#心跳间隔检测时间，默认60秒，范围0-3600秒，被动模式不使用</span>
<span class="token assign-left variable">ConfigFrequency</span><span class="token operator">=</span><span class="token number">5</span> <span class="token comment">#间隔多少秒从zabbix server获取监控项信息</span>
<span class="token assign-left variable">DataSenderFrequency</span><span class="token operator">=</span><span class="token number">5</span> <span class="token comment">#数据发送时间间隔，默认为1秒，范围为1-3600秒，被动模式不使用</span>
<span class="token assign-left variable">StartPollers</span><span class="token operator">=</span><span class="token number">20</span> <span class="token comment">#启动的数据采集器数量</span>
<span class="token assign-left variable">JavaGateway</span><span class="token operator">=</span><span class="token number">10.0</span>.58.104 <span class="token comment">#java gateway服务器地址,当需要监控java的时候必须配置否则监控不到数据</span>
<span class="token assign-left variable">JavaGatewayPort</span><span class="token operator">=</span><span class="token number">10052</span> <span class="token comment">#Javagatewa服务端口</span>
<span class="token assign-left variable">StartJavaPollers</span><span class="token operator">=</span><span class="token number">20</span> <span class="token comment">#启动多少个线程采集数据</span>
<span class="token assign-left variable">CacheSize</span><span class="token operator">=</span>2G <span class="token comment">#保存监控项而占用的最大内存</span>
<span class="token assign-left variable">HistoryCacheSize</span><span class="token operator">=</span>2G <span class="token comment">#保存监控历史数据占用的最大内存</span>
<span class="token assign-left variable">HistoryIndexCacheSize</span><span class="token operator">=</span>128M <span class="token comment">#历史索引缓存的大小</span>
<span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">30</span> <span class="token comment">#监控项超时时间，单位为秒f</span>
<span class="token assign-left variable">LogSlowQueries</span><span class="token operator">=</span><span class="token number">3000</span> <span class="token comment">#毫秒，多久的数据库查询会被记录到日志</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ProxyMode</span><span class="token operator">=</span><span class="token number">0</span>			<span class="token comment"># proxy模式，0：主动模式；1：被动模式</span>
<span class="token assign-left variable">Server</span><span class="token operator">=</span><span class="token number">10.0</span>.1.21	<span class="token comment"># zabbix-server的ip地址，被动模式的监控项使用</span>
<span class="token assign-left variable">ServerPort</span><span class="token operator">=</span><span class="token number">10051</span>	<span class="token comment"># zabbix-server的端口号，默认10051，被动模式下，此参数忽略</span>
<span class="token assign-left variable">Hostname</span><span class="token operator">=</span>proxy-qinagdao-active	<span class="token comment"># 在zabbix-server上用于区分proxy，通常设置为ip或主机名</span>
<span class="token assign-left variable">HostnameItem</span><span class="token operator">=</span>system.hostname	<span class="token comment"># 功能和hostname一样，可以设置zabbix的键值，所以更方便</span>
<span class="token assign-left variable">ListenPort</span><span class="token operator">=</span><span class="token number">10051</span>	<span class="token comment"># zabbix-proxy监听的本机端口</span>
<span class="token assign-left variable">SourceIP</span><span class="token operator">=</span>			<span class="token comment"># 当服务器上有多个ip地址，可以指定使用哪个ip发起请求，一般不用配置</span>

<span class="token comment"># 日志相关</span>
<span class="token assign-left variable">LogType</span><span class="token operator">=</span>file
<span class="token assign-left variable">LogFile</span><span class="token operator">=</span>/tmp/zabbix_proxy.log
<span class="token assign-left variable">LogFileSize</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">DebugLevel</span><span class="token operator">=</span><span class="token number">3</span>

<span class="token assign-left variable">EnableRemoteCommands</span><span class="token operator">=</span><span class="token number">0</span>	<span class="token comment"># 是否允许远程命令</span>

<span class="token assign-left variable">PidFile</span><span class="token operator">=</span>/tmp/zabbix_proxy.pid
<span class="token assign-left variable">SocketDir</span><span class="token operator">=</span>/tmp

<span class="token comment"># 数据库相关</span>
<span class="token assign-left variable">DBHost</span><span class="token operator">=</span>localhost
<span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix_proxy
<span class="token assign-left variable">DBSchema</span><span class="token operator">=</span>
<span class="token assign-left variable">DBUser</span><span class="token operator">=</span>zabbix
<span class="token assign-left variable">DBPassword</span><span class="token operator">=</span>
<span class="token assign-left variable">DBSocket</span><span class="token operator">=</span>
<span class="token assign-left variable">DBPort</span><span class="token operator">=</span>

<span class="token comment">######### PROXY SPECIFIC PARAMETERS #############</span>
<span class="token assign-left variable">ProxyLocalBuffer</span><span class="token operator">=</span><span class="token number">24</span>		<span class="token comment"># 发送成功的数据在本地保留多久，单位小时，0-172，也就是最多保留30天</span>
<span class="token assign-left variable">ProxyOfflineBuffer</span><span class="token operator">=</span><span class="token number">720</span>	<span class="token comment"># 未发送成功的数据在本地保留多久，单位小时，0-172，也就是最多保留30天</span>

<span class="token assign-left variable">HeartbeatFrequency</span><span class="token operator">=</span><span class="token number">60</span>	<span class="token comment"># 主动模式下，心跳检测zabbxi-server是否在线，0-3600，单位秒</span>
<span class="token assign-left variable">ConfigFrequency</span><span class="token operator">=</span><span class="token number">300</span>		<span class="token comment"># 主动模式下，，配置的更新周期，1-3600*24*7，单位秒，这个参数建议设置为5分钟</span>
<span class="token assign-left variable">DataSenderFrequency</span><span class="token operator">=</span><span class="token number">60</span>	<span class="token comment"># 数据向zabbix-server的推送周期，1-3600，单位秒</span>

<span class="token comment">############ 高级参数 ################ 以下参数和 zabbix_server.conf 类似</span>
<span class="token assign-left variable">StartPollers</span><span class="token operator">=</span><span class="token number">5</span>

<span class="token comment"># StartIPMIPollers=0</span>
<span class="token comment"># StartPollersUnreachable=1</span>
<span class="token comment"># StartTrappers=5</span>
<span class="token comment"># StartPingers=1</span>
<span class="token comment"># StartDiscoverers=1</span>
<span class="token comment"># StartHTTPPollers=1</span>
<span class="token comment"># JavaGateway=</span>
<span class="token comment"># JavaGatewayPort=10052</span>
<span class="token comment"># StartJavaPollers=0</span>
<span class="token comment"># StartVMwareCollectors=0</span>
<span class="token comment"># VMwareFrequency=60</span>
<span class="token comment"># VMwarePerfFrequency=60</span>
<span class="token comment"># VMwareCacheSize=8M</span>
<span class="token comment"># VMwareTimeout=10</span>
<span class="token comment"># SNMPTrapperFile=/tmp/zabbix_traps.tmp</span>
<span class="token comment"># StartSNMPTrapper=0</span>
<span class="token comment"># ListenIP=0.0.0.0</span>
<span class="token comment"># HousekeepingFrequency=1</span>
<span class="token comment"># CacheSize=8M</span>
<span class="token comment"># StartDBSyncers=4</span>
<span class="token comment"># HistoryCacheSize=16M</span>
<span class="token comment"># HistoryIndexCacheSize=4M</span>
<span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">30</span>
<span class="token comment"># TrapperTimeout=300</span>
<span class="token comment"># UnreachablePeriod=45</span>
<span class="token comment"># UnavailableDelay=60</span>
<span class="token comment"># UnreachableDelay=15</span>
<span class="token comment"># ExternalScripts=$&#123;datadir&#125;/zabbix/externalscripts</span>
<span class="token comment"># FpingLocation=/usr/sbin/fping</span>
<span class="token comment"># Fping6Location=/usr/sbin/fping6</span>
<span class="token comment"># SSHKeyLocation=</span>
<span class="token comment"># LogSlowQueries=0</span>
<span class="token assign-left variable">LogSlowQueries</span><span class="token operator">=</span><span class="token number">3000</span>
<span class="token comment"># TmpDir=/tmp</span>
<span class="token comment"># AllowRoot=0</span>
<span class="token comment"># User=zabbix</span>
<span class="token comment"># Include=/usr/local/etc/zabbix_proxy.general.conf</span>
<span class="token comment"># Include=/usr/local/etc/zabbix_proxy.conf.d/</span>
<span class="token comment"># Include=/usr/local/etc/zabbix_proxy.conf.d/*.conf</span>
<span class="token comment"># SSLCertLocation=$&#123;datadir&#125;/zabbix/ssl/certs</span>
<span class="token comment"># SSLKeyLocation=$&#123;datadir&#125;/zabbix/ssl/keys</span>
<span class="token comment"># SSLCALocation=</span>
<span class="token comment"># StatsAllowedIP=</span>
<span class="token comment"># LoadModulePath=$&#123;libdir&#125;/modules</span>
<span class="token comment"># LoadModule=</span>
<span class="token comment"># TLSConnect=unencrypted</span>
<span class="token comment"># TLSAccept=unencrypted</span>
<span class="token comment"># TLSCAFile=</span>
<span class="token comment"># TLSCRLFile=</span>
<span class="token comment"># TLSServerCertIssuer=</span>
<span class="token comment"># TLSServerCertSubject=</span>
<span class="token comment"># TLSCertFile=</span>
<span class="token comment"># TLSKeyFile=</span>
<span class="token comment"># TLSPSKIdentity=</span>
<span class="token comment"># TLSPSKFile=</span>
<span class="token comment"># TLSCipherCert13=</span>
<span class="token comment"># TLSCipherCert=</span>
<span class="token comment"># TLSCipherPSK13=</span>
<span class="token comment"># TLSCipherPSK=</span>
<span class="token comment"># TLSCipherAll13=</span>
<span class="token comment"># TLSCipherAll=</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix_agentd.conf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/zabbix/zabbix_agentd.conf/" class="post-title-link" itemprop="url">zabbix_agentd.conf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-10 20:00:10" itemprop="dateCreated datePublished" datetime="2021-02-10T20:00:10+08:00">2021-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/zabbix/" itemprop="url" rel="index"><span itemprop="name">zabbix</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>大部分同 zabbix_server.conf，以下是不同的参数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">EnableRemoteCommands</span><span class="token operator">=</span><span class="token number">0</span>	<span class="token comment"># 0/1，是否允许执行远程命令</span>
<span class="token assign-left variable">LogRemoteCommands</span><span class="token operator">=</span><span class="token number">0</span>		<span class="token comment"># 0/1，是否记录远程命令日志</span>
<span class="token assign-left variable">Server</span><span class="token operator">=</span><span class="token number">10.0</span>.1.21		<span class="token comment"># 被动模式，设置为server或proxy的地址，或者都设置，允许10.0.1.21来请求数据</span>
<span class="token assign-left variable">ListenPort</span><span class="token operator">=</span><span class="token number">10050</span>		<span class="token comment"># zabbix_agent监听的本地端口</span>
<span class="token assign-left variable">StartAgents</span><span class="token operator">=</span><span class="token number">3</span>			<span class="token comment"># 0-100，预启动进程数，执行被动检查，默认3个足够了</span>
<span class="token assign-left variable">ServerActive</span><span class="token operator">=</span><span class="token number">10.0</span>.1.21	<span class="token comment"># 主动模式，设置为server或proxy的地址，或者都设置，向10.0.1.21发送数据</span>
<span class="token assign-left variable">Hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.1.26		<span class="token comment"># 主机名称，zabbix_server添加主机时需要此项，通常设置为ip或主机名</span>
<span class="token assign-left variable">HostnameItem</span><span class="token operator">=</span>system.hostname	<span class="token comment"># 主机名称，和Hostname冲突，该项是动态的，其支持通过key进行配置，只要是zabbix_get能正常取的数据的key理论都是支持的（包含特殊字符的不支持）</span>
<span class="token assign-left variable">HostMetadata</span><span class="token operator">=</span>		<span class="token comment"># 0-255 characters，自动注册使用，静态配置</span>
<span class="token assign-left variable">HostMetadataItem</span><span class="token operator">=</span>	<span class="token comment"># 自动注册使用，动态配置</span>

<span class="token assign-left variable">RefreshActiveChecks</span><span class="token operator">=</span><span class="token number">120</span>		<span class="token comment"># 主动模式下，每120秒主动提供一次数据</span>

<span class="token assign-left variable">BufferSend</span><span class="token operator">=</span><span class="token number">5</span>	<span class="token comment"># 数据缓冲的时间</span>
<span class="token assign-left variable">BufferSize</span><span class="token operator">=</span><span class="token number">100</span>	<span class="token comment"># zabbix agent数据缓冲区的大小，当达到该值便会发送所有的数据到zabbix server</span>
<span class="token assign-left variable">MaxLinesPerSecond</span><span class="token operator">=</span><span class="token number">20</span>	<span class="token comment"># zabbix agent发送给zabbix server最大的数据行，1-1000</span>

<span class="token comment">####### 用户定义的监控参数 #######</span>
<span class="token assign-left variable">UnsafeUserParameters</span><span class="token operator">=</span><span class="token number">0</span>	<span class="token comment"># 0/1，是否允许所有字符参数的传递</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>			<span class="token comment"># 指定用户自定义参数，可以定义多个，如果要传参，使用[*]</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>tcp_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/bin/bash /usr/local/zabbix/etc/UserParameter/tcp_conn.sh <span class="token variable">$1</span> <span class="token variable">$2</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>memcache_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/etc/UserParameter/memcached_status.sh <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token string">"<span class="token variable">$2</span>"</span> <span class="token string">"<span class="token variable">$3</span>"</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>redis_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/etc/UserParameter/redis_status.sh <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token variable">$3</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>nginx_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/etc/UserParameter/nginx_status.sh <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token variable">$3</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>linux41<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/bin/bash /usr/local/zabbix/etc/UserParameter/linux41.sh <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token variable">$3</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>qinghe,/usr/bin/python3 /usr/local/zabbix/etc/UserParameter/linux41.py
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>tcp_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/bin/bash /usr/local/zabbix/etc/UserParameter/tcp_conn.sh <span class="token variable">$1</span> <span class="token variable">$2</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>memcache_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/etc/UserParameter/memcached_status.sh <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token string">"<span class="token variable">$2</span>"</span> <span class="token string">"<span class="token variable">$3</span>"</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>redis_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/etc/UserParameter/redis_status.sh <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token variable">$3</span>
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>nginx_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/etc/UserParameter/nginx_status.sh <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token variable">$3</span>


<span class="token comment">####### TLS相关参数 #######</span>
<span class="token assign-left variable">TLSConnect</span><span class="token operator">=</span>unencrypted
<span class="token assign-left variable">TLSAccept</span><span class="token operator">=</span>unencrypted
<span class="token assign-left variable">TLSCAFile</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSCRLFile</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSServerCertIssuer</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSServerCertSubject</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSCertFile</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSKeyFile</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSPSKIdentity</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSPSKFile</span><span class="token operator">=</span>

<span class="token comment">####### For advanced users - TLS ciphersuite selection criteria #######</span>
<span class="token assign-left variable">TLSCipherCert13</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSCipherCert</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSCipherPSK13</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSCipherPSK</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSCipherAll13</span><span class="token operator">=</span>
<span class="token assign-left variable">TLSCipherAll</span><span class="token operator">=</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix_server.conf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/zabbix/zabbix_server.conf/" class="post-title-link" itemprop="url">zabbix_server.conf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-09 23:22:50" itemprop="dateCreated datePublished" datetime="2021-02-09T23:22:50+08:00">2021-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/zabbix/" itemprop="url" rel="index"><span itemprop="name">zabbix</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zabbix_server.conf</span>
<span class="token comment"># This is a configuration file for Zabbix server daemon</span>
<span class="token comment"># To get more information about Zabbix, visit http://www.zabbix.com</span>

<span class="token assign-left variable">ListenPort</span><span class="token operator">=</span><span class="token number">10051</span> 	<span class="token comment"># 监听端口</span>
<span class="token assign-left variable">SourceIP</span><span class="token operator">=</span> 			<span class="token comment"># 多IP地址情况下，与其他服务器通信使用的源IP地址，一般不用设置</span>
<span class="token assign-left variable">PidFile</span><span class="token operator">=</span>/tmp/zabbix_server.pid 	<span class="token comment"># PID文件路径</span>
<span class="token assign-left variable">SocketDir</span><span class="token operator">=</span>/tmp 		<span class="token comment"># socket文件路径，如果不涉及到本机通信，此参数意义不大</span>

<span class="token comment"># 日志</span>
<span class="token assign-left variable">LogType</span><span class="token operator">=</span>file 		<span class="token comment"># 日志类型，支持system、file和console</span>
<span class="token assign-left variable">LogFile</span><span class="token operator">=</span>/tmp/zabbix_server.log  <span class="token comment"># 日志路径</span>
<span class="token assign-left variable">LogFileSize</span><span class="token operator">=</span><span class="token number">0</span> 		<span class="token comment"># 指定日志滚动写入大小，当达到指定大小时，会删除就日志重新从头写入新日志，0-1024，最大1024M，0表示不限制，建议设置为0，因为这个文件一般不会太大</span>
<span class="token assign-left variable">DebugLevel</span><span class="token operator">=</span><span class="token number">3</span> <span class="token comment">#自定义日志级别，0-5，默认3 warning，可以设置为4 error</span>

<span class="token comment"># 数据库</span>
<span class="token assign-left variable">DBHost</span><span class="token operator">=</span><span class="token number">192.168</span>.7.104 	<span class="token comment"># 数据库地址</span>
<span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix_server 	<span class="token comment"># 数据库名称</span>
<span class="token assign-left variable">DBSchema</span><span class="token operator">=</span> 				<span class="token comment"># 数据库访问协议，默认myslq，如果使用其他数据库，需要设置</span>
<span class="token assign-left variable">DBUser</span><span class="token operator">=</span>zabbix			<span class="token comment"># 数据库账号名</span>
<span class="token assign-left variable">DBPassword</span><span class="token operator">=</span><span class="token number">123456</span> 		<span class="token comment"># 数据库用户密码</span>
<span class="token assign-left variable">DBSocket</span><span class="token operator">=</span> 				<span class="token comment"># 数据库socket文件，如果mysql不在本机，此参数不需要配置</span>
<span class="token assign-left variable">DBPort</span><span class="token operator">=</span><span class="token number">3306</span> 			<span class="token comment"># 数据库端口，默认3306</span>

<span class="token comment"># 历史数据</span>
<span class="token assign-left variable">HistoryStorageURL</span><span class="token operator">=</span> 		<span class="token comment"># elasticsearch服务器地址，保存zabbix历史数据到ES里面，优化zabbix性能，新版本zabbix的才支持</span>
<span class="token assign-left variable">HistoryStorageTypes</span><span class="token operator">=</span>uint,dbl,str,log,text  <span class="token comment"># elasticsearch索引类型</span>
<span class="token assign-left variable">HistoryStorageDateIndex</span><span class="token operator">=</span><span class="token number">0</span>  <span class="token comment"># 将历史数据保存到不同的elasticsearch索引</span>

<span class="token comment"># 导出数据相关，一般不会导出数据，所以不需要配置</span>
<span class="token assign-left variable">ExportDir</span><span class="token operator">=</span>			<span class="token comment"># 定义实时导出触发器事件，监控项采集值，趋势数据的目录</span>
<span class="token assign-left variable">ExportFileSize</span><span class="token operator">=</span>1G	<span class="token comment"># 定义每个导出文件的最大大小</span>

<span class="token comment">############ 高级参数 ################</span>

<span class="token assign-left variable">StartPollers</span><span class="token operator">=</span><span class="token number">16</span>			<span class="token comment"># 预启动进程数量，收集数据，0-1000，建议此值设置与cpu核数相同</span>
<span class="token assign-left variable">StartIPMIPollers</span><span class="token operator">=</span><span class="token number">0</span>		<span class="token comment"># 预启动进程数量，IPMI收集数据，0-1000，如果有物理服务器，可以打开</span>
<span class="token assign-left variable">StartPreprocessors</span><span class="token operator">=</span><span class="token number">3</span>	<span class="token comment"># 预启动进程数量，用于处理zabbix agent数据，1-1000，建议设置高一些，如果使用proxy，server就不和agent直接接触了，这样可以设置的低一些</span>
<span class="token assign-left variable">StartPollersUnreachable</span><span class="token operator">=</span><span class="token number">1</span>	<span class="token comment"># 预启动进程数量，轮询检查不可达主机，0-1000，设置1个进程就够了，毕竟服务器不会经常挂</span>
<span class="token assign-left variable">StartTrappers</span><span class="token operator">=</span><span class="token number">5</span> 	<span class="token comment"># 预启动进程数量，Trappers进程，处理报警信息，0-1000，报警多的话可以多开几个</span>
<span class="token assign-left variable">StartPingers</span><span class="token operator">=</span><span class="token number">3</span>		<span class="token comment"># 预启动进程数量，用于ping检查主机，0-1000，建议设置多一</span>
<span class="token assign-left variable">StartDiscoverers</span><span class="token operator">=</span><span class="token number">1</span>	<span class="token comment"># 自动发现主机的进程数量，0-250，此功能特别消耗资源，建议关闭</span>
<span class="token assign-left variable">StartHTTPPollers</span><span class="token operator">=</span><span class="token number">1</span> 	<span class="token comment"># http进程数量，处理web请求，设置1-2足够</span>
<span class="token assign-left variable">StartTimers</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 计时器实例数量，记录报错、发邮件等行为的时间，1-1000，设置为2就足够</span>
<span class="token assign-left variable">StartEscalators</span><span class="token operator">=</span><span class="token number">1</span> 	<span class="token comment"># escalators进程的初始实例数量，用于处理动作中的自动步骤的进程的数量，0-100</span>
<span class="token assign-left variable">StartAlerters</span><span class="token operator">=</span><span class="token number">3</span> 	<span class="token comment"># 报警实例预启动数量，0-100，报警多的话可以开多一点</span>

<span class="token comment"># 监控java，zabbix不能直监控java，而是通过javagateway间接监控</span>
<span class="token assign-left variable">JavaGateway</span><span class="token operator">=</span><span class="token number">192.168</span>.7.101	<span class="token comment"># javagateway服务器地址，java pollers必须设置</span>
<span class="token assign-left variable">JavaGatewayPort</span><span class="token operator">=</span><span class="token number">10052</span> 		<span class="token comment"># javagateway端口，1024-32767</span>
<span class="token assign-left variable">StartJavaPollers</span><span class="token operator">=</span><span class="token number">20</span> 		<span class="token comment"># java轮训实例预启动数量，0-1000</span>

<span class="token comment"># 监控VMware，很少用</span>
<span class="token assign-left variable">StartVMwareCollectors</span><span class="token operator">=</span><span class="token number">0</span>		<span class="token comment"># 用于设置监控VMWARE Esxi主机实例时使用，0-250，若为0则不启用，若要监控ESXI主机，此值最少为1，根据监控ESXI数量设置对应数值</span>
<span class="token assign-left variable">VMwareFrequency</span><span class="token operator">=</span><span class="token number">60</span>			<span class="token comment"># 监控vmware获取最新数据间隔频率，单位为秒，10-86400</span>
<span class="token assign-left variable">VMwarePerfFrequency</span><span class="token operator">=</span><span class="token number">60</span>		<span class="token comment"># 监控vmware获取性能数据间隔</span>
<span class="token assign-left variable">VMwareCacheSize</span><span class="token operator">=</span>8M <span class="token comment">#vmware数据缓存大小，会占用zabbix server服务器内存</span>
<span class="token assign-left variable">VMwareTimeout</span><span class="token operator">=</span><span class="token number">10</span> <span class="token comment">#超时时间</span>

<span class="token assign-left variable">SNMPTrapperFile</span><span class="token operator">=</span>/tmp/zabbix_traps.tmp	<span class="token comment"># snmp触发器临时文件路径</span>
<span class="token assign-left variable">StartSNMPTrapper</span><span class="token operator">=</span><span class="token number">0</span>	<span class="token comment"># 是否启用 snmptrapper功能 ，默认0不启用（配合参数SNMPTrapperFile使用）</span>

<span class="token assign-left variable">ListenIP</span><span class="token operator">=</span><span class="token number">0.0</span>.0.0	<span class="token comment"># 监听地址</span>

<span class="token comment"># 历史数据相关，通过设置参数，删不干净，通常写sql脚本，直接删库</span>
<span class="token assign-left variable">HousekeepingFrequency</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 多少小时清理一次代理端数据库的history数据，0-24，默认1小时，关于多久之前的数据是history数据，在模板的监控项中有设置</span>
<span class="token assign-left variable">MaxHousekeeperDelete</span><span class="token operator">=</span><span class="token number">5000</span>		<span class="token comment"># 每次最多删除历史数据的行数，0-1000000</span>

<span class="token comment"># 缓存相关，以下缓存空间都是隔离的</span>
<span class="token assign-left variable">CacheSize</span><span class="token operator">=</span>128M  <span class="token comment"># zabbix初始化时占用多少系统共享内存用于存储配置信息，HOST,ITEM,TRIGGER数据，视监控主机数量和监控项调整，建议调整到32M或者更大</span>
<span class="token assign-left variable">CacheUpdateFrequency</span><span class="token operator">=</span><span class="token number">60</span>		<span class="token comment"># Zabbix更新缓存数据的频率，单位为秒，范围是1-3600，若管理页面操作不频繁，可以考虑加大参数值</span>
<span class="token assign-left variable">StartDBSyncers</span><span class="token operator">=</span><span class="token number">8</span>	<span class="token comment"># zabbix和数据库同步数据的进程数量，1-100，视数据库服务器I/O繁忙情况，和数据库写能力调整。数值越大，写能力越强。对数据库服务器I/O压力越大</span>
<span class="token assign-left variable">HistoryCacheSize</span><span class="token operator">=</span>512M	<span class="token comment"># 历史数据的缓存大小，128K-2G</span>
<span class="token assign-left variable">HistoryIndexCacheSize</span><span class="token operator">=</span>128M	<span class="token comment"># 历史数据索引缓存的大小，128K-2G</span>
<span class="token assign-left variable">TrendCacheSize</span><span class="token operator">=</span>4M	<span class="token comment"># 划分多少系统共享内存用于存储计算出来的趋势数据，一定程度上可缓解数据库读压力</span>
<span class="token assign-left variable">ValueCacheSize</span><span class="token operator">=</span>64M	<span class="token comment"># 历史值缓存的大小，用于缓存历史数据请求的共享内存大小</span>

<span class="token comment"># 超时相关</span>
<span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">30</span>	<span class="token comment"># 数据获取等待超时时间，1-30，建议加大此值，注意若此数值加大，应该考虑参数 StartPollers 是否有相应加大的必要。</span>
<span class="token assign-left variable">TrapperTimeout</span><span class="token operator">=</span><span class="token number">300</span>	<span class="token comment"># 启用trapper功能，用于进程等待超时设置，1-300，单位是秒</span>
<span class="token assign-left variable">UnreachablePeriod</span><span class="token operator">=</span><span class="token number">45</span>	<span class="token comment"># 当主机不可达多少秒后，设置为主机不可用，单位是秒，范围是1-3600</span>
<span class="token assign-left variable">UnavailableDelay</span><span class="token operator">=</span><span class="token number">60</span>		<span class="token comment"># 当主机不可用了，多久检查一次该主机的可用性，单位为秒，范围是1-3600</span>
<span class="token assign-left variable">UnreachableDelay</span><span class="token operator">=</span><span class="token number">15</span> 	<span class="token comment"># 同 UnavailableDelay</span>

<span class="token comment"># 脚本相关</span>
<span class="token assign-left variable">AlertScriptsPath</span><span class="token operator">=</span><span class="token variable">$&#123;datadir&#125;</span>/zabbix/alertscripts		<span class="token comment"># 监控报警脚本路径,取决于编译时datadir参数</span>
<span class="token assign-left variable">ExternalScripts</span><span class="token operator">=</span><span class="token variable">$&#123;datadir&#125;</span>/zabbix/externalscripts 	<span class="token comment"># 自定义脚本存储路径</span>

<span class="token assign-left variable">FpingLocation</span><span class="token operator">=</span>/usr/bin/fping		<span class="token comment"># fping命令的位置</span>
<span class="token assign-left variable">Fping6Location</span><span class="token operator">=</span>/usr/bin/fping6		<span class="token comment"># fping6命令的位置</span>

<span class="token assign-left variable">SSHKeyLocation</span><span class="token operator">=</span>		<span class="token comment"># 用于SSH检查和操作的公钥和私钥的位置。</span>

<span class="token assign-left variable">LogSlowQueries</span><span class="token operator">=</span><span class="token number">0</span>	<span class="token comment"># 设置慢日志查询时间(以毫秒为单位)，仅当DebugLevel设置为3、4、5时才可用，0 - 不记录慢查询，范围是1-3600000，数据库自带慢日志查询功能，这里一般也不设置</span>

<span class="token assign-left variable">TmpDir</span><span class="token operator">=</span>/tmp		<span class="token comment"># 临时文件目录</span>

<span class="token assign-left variable">StartProxyPollers</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 启用多少子进程与proxy端通信，建议此值等于proxy数量，范围是0-250</span>
<span class="token assign-left variable">ProxyConfigFrequency</span><span class="token operator">=</span><span class="token number">60</span>	<span class="token comment"># 被动模式下，被监控主机同步配置文件至proxy的周期，单位秒，1-3600*24*7</span>
<span class="token assign-left variable">ProxyDataFrequency</span><span class="token operator">=</span><span class="token number">60</span> 	<span class="token comment"># 被动模式下，zabbix server间隔多少秒向proxy请求历史数据，1-3600</span>

<span class="token assign-left variable">AllowRoot</span><span class="token operator">=</span><span class="token number">0</span> 	<span class="token comment"># 是否允许root启动zabbix，0/1</span>

<span class="token assign-left variable">User</span><span class="token operator">=</span>zabbix 	<span class="token comment"># 设置zabbix启动用户</span>

<span class="token assign-left variable">Include</span><span class="token operator">=</span>/usr/local/etc/zabbix_server.general.conf 	<span class="token comment"># 导入其他目录的配置文件</span>
<span class="token assign-left variable">Include</span><span class="token operator">=</span>/usr/local/etc/zabbix_server.conf.d/
<span class="token assign-left variable">Include</span><span class="token operator">=</span>/usr/local/etc/zabbix_server.conf.d/*.conf

<span class="token comment"># web监控 SSL相关</span>
<span class="token assign-left variable">SSLCertLocation</span><span class="token operator">=</span><span class="token variable">$&#123;datadir&#125;</span>/zabbix/ssl/certs		<span class="token comment"># SSL证书公钥的位置，用于web监控</span>
<span class="token assign-left variable">SSLKeyLocation</span><span class="token operator">=</span><span class="token variable">$&#123;datadir&#125;</span>/zabbix/ssl/keys 		<span class="token comment"># SSL客证书私钥位置，用于web监控</span>
<span class="token assign-left variable">SSLCALocation</span><span class="token operator">=</span> 									<span class="token comment"># SSL CA钥文件目录</span>

<span class="token assign-left variable">StatsAllowedIP</span><span class="token operator">=</span>		<span class="token comment"># 允许访问zabbix server的IP地址列表，不过一般通过防火墙限制</span>

<span class="token comment"># 第三方模块相关</span>
<span class="token assign-left variable">LoadModulePath</span><span class="token operator">=</span><span class="token variable">$&#123;libdir&#125;</span>/modules	<span class="token comment"># 第三方模块目录路径</span>
<span class="token assign-left variable">LoadModule</span><span class="token operator">=</span> <span class="token comment">#第三方模块路径，示例：LoadModule=&lt;path/module.so></span>

<span class="token comment"># TLS相关，不过zabbix一般不用证书，即使用，配置在nginx也更合适</span>
<span class="token assign-left variable">TLSCAFile</span><span class="token operator">=</span> 		<span class="token comment"># CA文件</span>
<span class="token assign-left variable">TLSCRLFile</span><span class="token operator">=</span> 	<span class="token comment"># 包含已吊销证书的文件的完整路径名。</span>
<span class="token assign-left variable">TLSCertFile</span><span class="token operator">=</span> 	<span class="token comment"># 公钥文件路径</span>
<span class="token assign-left variable">TLSKeyFile</span><span class="token operator">=</span>  	<span class="token comment"># 私钥文件路径</span></code></pre>

<p>以上所有参数的设置，可以先设置一个较小的保守的值，然后通过测试，一点点调整，最终优化到合适的值</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/zabbix/zabbix/" class="post-title-link" itemprop="url">Zabbix</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-05 10:43:08" itemprop="dateCreated datePublished" datetime="2021-02-05T10:43:08+08:00">2021-02-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/zabbix/" itemprop="url" rel="index"><span itemprop="name">zabbix</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="监控服务介绍"><a href="#监控服务介绍" class="headerlink" title="监控服务介绍"></a>监控服务介绍</h2><h3 id="逻辑布局"><a href="#逻辑布局" class="headerlink" title="逻辑布局"></a>逻辑布局</h3><p><img data-src="//img.to2b.cn/blog/ljk/1612493098811.png"></p>
<h3 id="整体布局"><a href="#整体布局" class="headerlink" title="整体布局"></a>整体布局</h3><p><img data-src="//img.to2b.cn/blog/ljk/1612493127884.png"></p>
<h3 id="常见的监控服务"><a href="#常见的监控服务" class="headerlink" title="常见的监控服务"></a>常见的监控服务</h3><p><strong>开源监控软件</strong>：cacti、naglos、zabbix、smokeping、open-falcon 等</p>
<h4 id="Cacti"><a href="#Cacti" class="headerlink" title="Cacti"></a>Cacti</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.cacti.net/">https://www.cacti.net/</a><br>github：<a target="_blank" rel="noopener" href="https://github.com/Cacti/cacti">https://github.com/Cacti/cacti</a></p>
<pre class="language-none"><code class="language-none">Cacti是基于LAMP平台展现的网络流量监测及分析工具，通过SNMP技术或自定义脚本从目标设备&#x2F;主机获取监控指标信息；其次进行数据存储，调用模板将数据存到数据库，使用rrdtool存储和更新数据，通过rrdtool绘制结果图形；最后进行数据展现，通过Web方式将监控结果呈现出来，常用于在数据中心监控网络设备

目前还有很多 数据中心、IDC服务商 还在用Cacti</code></pre>

<p>缺点：只针对物理设备、虚拟机这样有固定 IP 地址的设备，不适用于容器</p>
<h4 id="Nagios"><a href="#Nagios" class="headerlink" title="Nagios"></a>Nagios</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.nagios.org/">https://www.nagios.org/</a></p>
<pre class="language-none"><code class="language-none">Nagios用来监视系统和网络的开源应用软件，利用其众多的插件实现对本机和远端服务的监控，当被监控对象发生异常时，会及时向管理员告警，提供一批预设好的监控插件，用户可以直接调用，也可以自定义Shell脚本来监控服务，适合各企业的业务监控，可通过Web页面显示对象状态、日志、告警信息，分层告警机制及自定义监控相对薄弱</code></pre>

<p>缺点：报警机制比较简单，无法实现分组报警、递归报警等功能</p>
<h4 id="SmokePing"><a href="#SmokePing" class="headerlink" title="SmokePing"></a>SmokePing</h4><p>官网地址：<a target="_blank" rel="noopener" href="https://oss.oetiker.ch/smokeping/">https://oss.oetiker.ch/smokeping/</a></p>
<pre class="language-none"><code class="language-none">Smokeping是一款用于网络性能监测的开源监控软件，主要用于对IDC的网络状况，网络质量，稳定性等做检测，通过rrdtool制图方式，图形化地展示网络的时延情况，进而能够清楚的判断出网络的即时通信情况</code></pre>

<p>可以监测全国各地连接到网站的网速，类似 站长之家 的某些测速功能</p>
<h4 id="Open-falcon"><a href="#Open-falcon" class="headerlink" title="Open-falcon"></a>Open-falcon</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.open-falcon.org/">https://www.open-falcon.org/</a><br>github：<a target="_blank" rel="noopener" href="https://github.com/XiaoMi/open-falcon">https://github.com/XiaoMi/open-falcon</a><br>文档：<a target="_blank" rel="noopener" href="https://book.open-falcon.org/zh_0_2/contributing.html">https://book.open-falcon.org/zh_0_2/contributing.html</a></p>
<pre class="language-none"><code class="language-none">小米公司开源出来的监控软件open-falcon(猎鹰)，监控能力和性能较强
插件很多，部署复杂</code></pre>

<h4 id="夜莺"><a href="#夜莺" class="headerlink" title="夜莺"></a>夜莺</h4><p>官网：<a target="_blank" rel="noopener" href="https://n9e.didiyun.com/">https://n9e.didiyun.com/</a></p>
<pre class="language-none"><code class="language-none">滴滴出品，一款经过大规模生产环境验证的、分布式高性能的运维监控系统，基于 Open-falcon 二次开发</code></pre>

<h4 id="Zabbix"><a href="#Zabbix" class="headerlink" title="Zabbix"></a>Zabbix</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/">https://www.zabbix.com/cn/</a></p>
<pre class="language-none"><code class="language-none">Zabbix是一个企业级解决方案，支持实时监控数千台服务器，虚拟机和网络设备，采集百万级监控指标，适用于任何IT基础架构、服务、应用程序和资源的解决方案

目前使用较多的开源监控软件，可横向扩展、自定义监控项、支持多种监控方式、可监控网络与服务等</code></pre>

<p>缺点：zabbix 使用 mysql，数据库部分容易成为瓶颈</p>
<h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4><p>针对容器环境的开源监控软件</p>
<h4 id="商业监控解决方案"><a href="#商业监控解决方案" class="headerlink" title="商业监控解决方案"></a>商业监控解决方案</h4><ul>
<li>监控宝：<a target="_blank" rel="noopener" href="https://www.jiankongbao.com/">https://www.jiankongbao.com/</a> 推荐使用</li>
<li>听云：<a target="_blank" rel="noopener" href="https://www.tingyun.com/">https://www.tingyun.com/</a></li>
</ul>
<h3 id="Zabbix-使用场景及系统概述"><a href="#Zabbix-使用场景及系统概述" class="headerlink" title="Zabbix 使用场景及系统概述"></a>Zabbix 使用场景及系统概述</h3><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features">https://www.zabbix.com/cn/features</a></p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/network_monitoring">网络</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/server_monitoring">服务器</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=clouds">云</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=virtual_machines">虚拟机</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=applications">应用</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=services">服务</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=databases">数据库</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=clouds">Web</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=security">安全</a></p>
<h4 id="系统概述"><a href="#系统概述" class="headerlink" title="系统概述"></a>系统概述</h4><h5 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h5><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#metric_collection">数据采集</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#problem_detection">问题检测</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#visualization">可视化</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#notification">告警 &amp; 修复</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#security_authentication">安全 &amp; 认证</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#templates">轻松部署</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#auto_discovery">自动发现</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#distributed_monitoring">分布式监控</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#zabbix_api">Zabbix API</a></p>
<h5 id="数据采集"><a href="#数据采集" class="headerlink" title="数据采集"></a>数据采集</h5><p>所有监控系统的工作原理都类似，都需要采集被监控对象的数据</p>
<p>周期性时序数据</p>
<pre class="language-none"><code class="language-none">- 主机&#x2F;对象：服务器、路由器、交换机、存储、防火墙、IP、PORT、URL、自定义监控对象…
  - 服务器较少时，采集时间可以快点，两三分钟一次
  - URL 就是 API
  - 自定义监控对象，通过写脚本实现
- 采集目标：监控项，指标数据（metrics data）</code></pre>

<p><strong>数据采集方式：</strong></p>
<ol>
<li>zabbix-agent 采集本机数据，然后发送给 zabbix-proxy</li>
<li>zabbix-proxy 将数据发送给 zabbix-server<br>注意：不是实时转发，zabbix-proxy 也搭配 mysql，负责临时存储数据</li>
<li>zabbix-server 只和 zabbix-proxy 保持连接即可，将数据存储到 mysql，结束采集</li>
</ol>
<p>如果不安装（或者无法安装）agent 客户端，可以使用特定的协议进行数据采集：</p>
<pre class="language-none"><code class="language-none">- SNMP：适用于路由器、交换机等网络设备
- Telnet
- ssh
- IPMI：物理机上如果有IPM接口，可以采集cpu温度、风扇传输等硬件信息
- JMX：监控java</code></pre>

<h5 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h5><p>监控数据存储系统</p>
<pre class="language-none"><code class="language-none">- SQL: MySQL&#x2F;MariaDB(Zabbix)
- NoSQL：Redis(Open-falcon)
- rrd: Round Robin Database(Cacti) 环形存储，始终保存一年的数据，一年前的覆盖掉

prometheus：时序数据库
zabbix：MySQL
cacti：rrd</code></pre>

<h5 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h5><pre class="language-none"><code class="language-none">- 历史数据: 每个监控项采集到的每个监控值，查询时可能会造成数据库负载过大，开发和测试也会查看
- 趋势数据: 趋势表里主要保留某个监控项一个小时内历史数据的最大值、最小值和平均值以及该监控项一个小时内所采集到的数据个数

趋势数据是对历史数据的筛选，历史数据保存时间短一些，30天足以，趋势数据保存时间长一些，可以设置为一年</code></pre>

<h5 id="阈值"><a href="#阈值" class="headerlink" title="阈值"></a>阈值</h5><p>可按照预定义的阈值等级实现分层报警，可以 80%，不过要考虑基数，<font color=orange>Zabbix 用的好不好，就看阈值设置的好不好，需要慢慢优化</font></p>
<h5 id="告警机制"><a href="#告警机制" class="headerlink" title="告警机制"></a>告警机制</h5><p>email、短信、微信、语音、故障自治愈（zabbix 通知服务器重启，需事先写好脚本，针对物理机和虚拟机）</p>
<p>初级运维 –&gt; 中级运维&#x2F;高级运维 –&gt; 架构师 –&gt; 总监 –&gt; CTO</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">host</span> <span class="token punctuation">(</span>host <span class="token function">groups</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>- templates		<span class="token comment"># 从模板继承告警配置</span>
<span class="token function">host</span> -<span class="token operator">></span> items -<span class="token operator">></span> triggers -<span class="token operator">></span> action <span class="token punctuation">(</span>条件-conditions, 操作-operations<span class="token punctuation">)</span>		<span class="token comment"># 自定义告警配置</span></code></pre>

<h5 id="数据展示"><a href="#数据展示" class="headerlink" title="数据展示"></a>数据展示</h5><pre class="language-none"><code class="language-none">- zabbix web：基于nginx+php
- grafana：以zabbix为数据源，展示更为绚丽的界面</code></pre>

<h2 id="Zabbix-规划及部署"><a href="#Zabbix-规划及部署" class="headerlink" title="Zabbix 规划及部署"></a>Zabbix 规划及部署</h2><p>目前最新的 LTS 版本是 5.0，5.0 和之前版本有明显区别，但是文档还是英文的，所以目前学习还是以 4.0 为准</p>
<p>下载页面：<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/download">https://www.zabbix.com/cn/download</a></p>
<h3 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h3><ul>
<li>数据库：CPU 和磁盘 IO 一定要快，内存最好 32G，磁盘要大，zabbix 的监控数据会远大于业务数据量</li>
<li>zabbix server：zabbix server 直接装在物理机<ul>
<li>CPU：16 核</li>
<li>磁盘：RAID10、500G</li>
<li>内存：8G（监控几十个节点），16G（监控几百个节点），32G（监控两千个节点）</li>
</ul>
</li>
</ul>
<p><strong>实验：</strong></p>
<p>部署环境：服务器系统 ubuntu 18.04.5 &#x2F; Centos 7.x</p>
<table>
<thead>
<tr>
<th>主机类型</th>
<th>IP 地址</th>
</tr>
</thead>
<tbody><tr>
<td>zabbix server</td>
<td>10.0.1.21</td>
</tr>
<tr>
<td>zabbix 主动代理</td>
<td>10.0.1.22</td>
</tr>
<tr>
<td>zabbix 被动代理</td>
<td>10.0.1.23</td>
</tr>
<tr>
<td>mysql master</td>
<td>10.0.1.24</td>
</tr>
<tr>
<td>mysql slave</td>
<td>10.0.1.25</td>
</tr>
<tr>
<td>web server1</td>
<td>10.0.1.26</td>
</tr>
<tr>
<td>web server2</td>
<td>10.0.1.27</td>
</tr>
</tbody></table>
<h3 id="yum-x2F-apt-安装"><a href="#yum-x2F-apt-安装" class="headerlink" title="yum&#x2F;apt 安装"></a>yum&#x2F;apt 安装</h3><ol>
<li><p>Install Zabbix repository</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$wget</span> https://repo.zabbix.com/zabbix/4.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_4.0-3+bionic_all.deb
<span class="token variable">$ls</span>
zabbix-release_4.0-3+bionic_all.deb
<span class="token variable">$dpkg</span> <span class="token parameter variable">-c</span> zabbix-release_4.0-3+bionic_all.deb 	<span class="token comment">#查看dep包的内容</span>
<span class="token punctuation">..</span>.
<span class="token comment">#zabbix.list：官方提供的源</span>
-rw-r--r-- root/root       <span class="token number">118</span> <span class="token number">2019</span>-07-30 <span class="token number">16</span>:34 ./etc/apt/sources.list.d/zabbix.list
<span class="token punctuation">..</span>.
<span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> zabbix-release_4.0-3+bionic_all.deb 	<span class="token comment">#安装dep包</span>
<span class="token variable">$vim</span> /etc/apt/sources.list.d/zabbix.list	<span class="token comment">#修改zabbix源</span>
<span class="token comment">#deb http://repo.zabbix.com/zabbix/4.0/ubuntu bionic main</span>
<span class="token comment">#deb-src http://repo.zabbix.com/zabbix/4.0/ubuntu bionic main</span>
deb https://mirrors.aliyun.com/zabbix/zabbix/4.0/ubuntu bionic main	<span class="token comment">#替换为阿里云的源</span>
deb-src https://mirrors.aliyun.com/zabbix/zabbix/4.0/ubuntu bionic main
<span class="token variable">$apt</span> update</code></pre>
</li>
<li><p>安装 Zabbix server，Web 前端，agent</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> zabbix-server-mysql zabbix-frontend-php zabbix-agent
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> disable mysql.service	<span class="token comment"># 数据库单独装，把自带的禁用掉</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop mysql.service</code></pre>
</li>
<li><p>安装、配置 mysql</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$apt</span> search mysql-server	<span class="token comment"># 确保mysql版本不低于5.7</span>
<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> mysql-server mysql-client

<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$mysql</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment"># 创建 zabbix_server 数据库</span>
mysql<span class="token operator">></span> create database zabbix_server character <span class="token builtin class-name">set</span> utf8 collate utf8_bin<span class="token punctuation">;</span>
<span class="token comment"># 创建 zabbix_server 用户</span>
mysql<span class="token operator">></span> create user zabbix_server@<span class="token string">'10.0.%.%'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> grant all privileges on zabbix_server.* to zabbix_server@<span class="token string">'10.0.%.%'</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/mysql/mysql.conf.d/mysqld.cnf
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
bind-address        <span class="token operator">=</span> <span class="token number">0.0</span>.0.0	<span class="token comment"># 修改监地址，默认监听127.0.0.1，修改为0.0.0.0</span>

<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart mysql.service</code></pre>

<p>数据库初始化：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$zcat</span> /usr/share/doc/zabbix-server-mysql*/create.sql.gz <span class="token operator">|</span> mysql <span class="token parameter variable">-uzabbix_server</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-h10.0.1.24</span> zabbix_server</code></pre>
</li>
<li><p>为 Zabbix server 配置数据库</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑配置文件 /etc/zabbix/zabbix_server.conf</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/zabbix/zabbix_server.conf
<span class="token assign-left variable">DBHost</span><span class="token operator">=</span><span class="token number">10.0</span>.1.24
<span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBUser</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBPassword</span><span class="token operator">=</span><span class="token number">123456</span>

<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token string">'^[a-Z]'</span>  /etc/zabbix/zabbix_server.conf
<span class="token assign-left variable">LogFile</span><span class="token operator">=</span>/var/log/zabbix/zabbix_server.log
<span class="token assign-left variable">LogFileSize</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">PidFile</span><span class="token operator">=</span>/var/run/zabbix/zabbix_server.pid
<span class="token assign-left variable">SocketDir</span><span class="token operator">=</span>/var/run/zabbix
<span class="token assign-left variable">DBHost</span><span class="token operator">=</span><span class="token number">10.0</span>.1.24
<span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBUser</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBPassword</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token assign-left variable">SNMPTrapperFile</span><span class="token operator">=</span>/var/log/snmptrap/snmptrap.log
<span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">4</span>
<span class="token assign-left variable">AlertScriptsPath</span><span class="token operator">=</span>/usr/lib/zabbix/alertscripts
<span class="token assign-left variable">ExternalScripts</span><span class="token operator">=</span>/usr/lib/zabbix/externalscripts
<span class="token assign-left variable">FpingLocation</span><span class="token operator">=</span>/usr/bin/fping
<span class="token assign-left variable">Fping6Location</span><span class="token operator">=</span>/usr/bin/fping6
<span class="token assign-left variable">LogSlowQueries</span><span class="token operator">=</span><span class="token number">3000</span></code></pre>
</li>
<li><p>为 Zabbix 前端配置 PHP</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑配置文件 /etc/zabbix/apache.conf</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/zabbix/apache.conf
<span class="token comment"># php_value date.timezone Europe/Riga</span>
php_value date.timezone Asia/Shanghai	<span class="token comment"># 修改时区</span>

<span class="token comment"># 重启 zabbix 和 apache 服务</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart zabbix-server zabbix-agent apache2</code></pre>
</li>
<li><p>浏览器访问 <a target="_blank" rel="noopener" href="http://10.0.1.21/zabbix%EF%BC%8C%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E6%8F%90%E7%A4%BA%E4%B8%80%E6%AD%A5%E6%AD%A5%E9%85%8D%E7%BD%AE">http://10.0.1.21/zabbix，然后根据提示一步步配置</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612542025387.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">Database <span class="token builtin class-name">type</span>	MySQL
Database server	<span class="token number">10.0</span>.1.24
Database port	<span class="token number">3306</span>
Database name	zabbix_server
Database user	zabbix_server
Database password	<span class="token number">123456</span>

Zabbix server	<span class="token number">10.0</span>.1.21				<span class="token comment"># ip 和 主机名 均可</span>
Zabbix server port	<span class="token number">10051</span>
Zabbix server name	zabbix_server		<span class="token comment"># 这里随便写</span>

<span class="token comment"># 如果以后更改配置，需要修改两个文件</span>
<span class="token comment">#	/etc/zabbix/zabbix_server.conf</span>
<span class="token comment">#	/usr/share/zabbix/conf/zabbix.conf.php	# 生成的配置在此文件中</span></code></pre>

<p>默认的账号 Admin，密码 zabbix</p>
</li>
<li><p>默认只能显示英文，所以需要汉化</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装简体中文语言环境</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> language-pack-zh*
<span class="token comment"># 增加中文语言环境变量</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/environment
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games"</span>
<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span><span class="token string">"zh_CN.UTF-8"</span>		<span class="token comment"># 添加此行</span>
<span class="token comment"># 重新设置本地配置</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$dpkg</span>-reconfigure locales</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612545414997.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612545454796.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置好后，需要重启apacha、php-fpm</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart apache2 php-fpm</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612546094789.png"></p>
<p>但是，还有部分页面乱码，需要更换默认的字体包：</p>
<p>从 windows（位于 C:\Windows\Fonts） 系统中挑一个顺眼的字体包，上传到服务器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-server fonts<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/share/zabbix/assets/fonts		<span class="token comment"># 注意目录</span>
<span class="token punctuation">[</span>root@zabbix-server fonts<span class="token punctuation">]</span><span class="token variable">$ls</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">' '</span> <span class="token punctuation">\</span>n
graphfont.ttf	<span class="token comment"># 默认字体</span>
simhei.ttf		<span class="token comment"># 刚上传的 黑体</span>
simkai.ttf		<span class="token comment"># 刚上传的 楷体，这两个都可以，其他的不一定可以</span>


<span class="token punctuation">[</span>root@zabbix-server include<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/share/zabbix/include		<span class="token comment"># 注意目录</span>
<span class="token comment"># 修改默认字体为黑体，楷体也可以</span>
<span class="token punctuation">[</span>root@zabbix-server include<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/graphfont/simkai/'</span> defines.inc.php
<span class="token punctuation">[</span>root@zabbix-server include<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart apache2 php-fpm</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612547625040.png"></p>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/installation/install">https://www.zabbix.com/documentation/4.0/zh/manual/installation/install</a></p>
<p>把 apt 安装的 zabbix-server、zabbix-proxy、zabbix-agent 等软件的 service 文件拷贝出来备用，然后恢复快照</p>
<p>具体详见脚本 script-apt</p>
<p>注意：</p>
<ol>
<li><p>server 和 proxy 不能安装在同一台主机</p>
</li>
<li><p>如果是 centos，安装依赖参考：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> gcc libxml2-devel net-snmp net-snmp-devel <span class="token function">curl</span> curl-devel php phpbcmath php-mbstring mariadb mariadb-devel <span class="token parameter variable">-y</span></code></pre>
</li>
<li><p>汉化操作需要手动执行，脚本没有实现这个功能，不要忘记重启 php-fpm</p>
</li>
</ol>
</li>
</ol>
<h2 id="Zabbix-监控入门基础"><a href="#Zabbix-监控入门基础" class="headerlink" title="Zabbix 监控入门基础"></a>Zabbix 监控入门基础</h2><ol>
<li>了解业务结构</li>
<li>监控</li>
<li>业务优化</li>
</ol>
<h3 id="zabbix-概念"><a href="#zabbix-概念" class="headerlink" title="zabbix 概念"></a>zabbix 概念</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><ul>
<li><p>模板：</p>
<ul>
<li>键值（key）：最基础的指令，每个键值表示一项数据，比如 <code>system.hostname</code> 表示主机名，zabbix 内置了 一些，如果不够用，可以自定义（需要在 zabbix_agentd.conf 中指定）</li>
<li>监控项（item）：主要是由 键值 + 更新周期 组成</li>
<li>应用集：对监控项分组，功能类似的监控项的合集</li>
<li>触发器：据监控项的返回值对比预先设置的阈值，触发器会触发动作<ul>
<li>表达式：功能一般选择 last</li>
</ul>
</li>
<li>图形：</li>
<li>自动发现：</li>
<li>web 场景&#x2F;web 检测：</li>
</ul>
</li>
<li><p>主机群组</p>
<ul>
<li>1</li>
</ul>
</li>
<li><p>主机</p>
<ul>
<li>d</li>
</ul>
</li>
<li><p>维护</p>
<ul>
<li>w</li>
</ul>
</li>
<li><p>动作</p>
<ul>
<li><p>动作：动作由触发器触发，触发动作选项用来限制触发器的范围，一般选主机群组，只有该主机群组中的主机的触发器可以触发动作，多个触发条件可以选择和&#x2F;或的关系</p>
</li>
<li><p>操作：动作的操作会调用报警媒介，发送到指定用户，毕竟数据库出问题，需要发给 DBA，发给网络工程师也不管用</p>
<ul>
<li><p>默认操作步骤持续时间：发送周期，一般配置 60s，即 60 秒发一次</p>
</li>
<li><p>默认标题 和 消息内容：用{}包裹的变量是宏，zabbix 所有内置的宏，参考：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location">官方文档</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例：</span>
<span class="token punctuation">&#123;</span>ALERT.SENDTO<span class="token punctuation">&#125;</span>		<span class="token comment"># 报警脚本参数，值来自于用户报警媒介配置，可能是邮件、手机号等等</span>
<span class="token punctuation">&#123;</span>ALERT.SUBJECT<span class="token punctuation">&#125;</span>		<span class="token comment"># 报警脚本参数，默认值由动作配置</span>
<span class="token punctuation">&#123;</span>ALERT.MESSAGE<span class="token punctuation">&#125;</span>		<span class="token comment"># 报警脚本参数，默认值由动作配置</span></code></pre></li>
</ul>
</li>
<li><p>恢复操作：解决完报警信息后，恢复信息也要发送</p>
</li>
<li><p>更新操作：</p>
</li>
</ul>
</li>
<li><p>关联事件</p>
<ul>
<li>4</li>
</ul>
</li>
<li><p>自动发现：添加&#x2F;移除&#x2F;更改元素时执行自动操作</p>
<p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/auto_discovery">https://www.zabbix.com/cn/auto_discovery</a><br><a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/discovery/network_discovery">https://www.zabbix.com/documentation/4.0/zh/manual/discovery/network_discovery</a></p>
<ul>
<li>网络发现:定期扫描、发现设备类型，IP，状态，运行时间&#x2F;停机时间等，并采取预定义的操作。</li>
<li>低级别发现（LLD）:自动为设备上不同元素创建监控项，触发器和图形。</li>
<li>主动 agent 自动注册 使用 Zabbix agent 自动开始监控新设备</li>
</ul>
</li>
<li><p>服务</p>
<ul>
<li>2</li>
</ul>
</li>
</ul>
<h4 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h4><ul>
<li>agent 代理程序：即 proxy</li>
<li>报警媒介类型：把报警信息通知给用户的方式，可以配置邮件、短信、微信（通过脚本实现）等方式，以 qq 邮件为例，将 qq 邮箱和用户关联起来，发生报警后，qq 邮箱作为发件人将报警信息发送到用户的邮箱中</li>
<li>用户</li>
</ul>
<h3 id="zabbix-server"><a href="#zabbix-server" class="headerlink" title="zabbix server"></a>zabbix server</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/concepts/server">https://www.zabbix.com/documentation/4.0/zh/manual/concepts/server</a></p>
<p>zabbix server 是整个 zabbix 软件的核心程序。<br>zabbix server 是所有配置、统计和操作数据的中央存储中心，也是 zabbix 监控系统的告警中心。<br>基本的 zabbix server 的功能分解成为三个不同的组件。他们是：zabbix server、web 前端和数据库。</p>
<h3 id="zabbix-proxy"><a href="#zabbix-proxy" class="headerlink" title="zabbix proxy"></a>zabbix proxy</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/concepts/proxy">https://www.zabbix.com/documentation/4.0/zh/manual/concepts/proxy</a></p>
<p>zabbix proxy <font color=red>代表 zabbix server 采集监控数据</font>，减轻 zabbix server 的 cpu 和 io 开销。<br>zabbix proxy 从受监控设备采集监控数据，先将数据缓存到本机数据库，然后传输到所属的 zabbix server。</p>
<h3 id="zabbix-agent"><a href="#zabbix-agent" class="headerlink" title="zabbix agent"></a>zabbix agent</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/concepts/agent">https://www.zabbix.com/documentation/4.0/zh/manual/concepts/agent</a></p>
<p>proxy 和 agent 都是代理，但前者是 服务端，后者是客户端</p>
<p>zabbix agent 部署在被监控目标上，以主动监控本地资源和应用程序（硬盘、内存、处理器统计信息等）。</p>
<p>zabbix agent 收集本地的操作信息并将数据报告给 zabbix server 用于进一步处理。一旦出现异常 （例如硬盘空间已满或者有崩溃的服务进程），zabbix server 会主动警告管理员指定机器上的异常。</p>
<p>zabbix agents 的极高效率缘于它可以利用本地系统调用来完成统计数据的采集。</p>
<p>默认监听在 10051 端口。</p>
<h3 id="sender"><a href="#sender" class="headerlink" title="sender"></a>sender</h3><p>主要用于测试的命令，例如：如果 Zabbix agent 收集不到数据，可以用这个命令发一下测试数据，看一下是 Zabbix agent 的问题还是网络问题</p>
<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>主要用于测试的命令，可以与 Zabbix agent 进行通信，并从 Zabbix agent 那里获取所需的信息</p>
<p>注意：只有 zabbix_agentd.conf 中 Server 配置的 ip 才能从该主机上 get 到数据</p>
<h3 id="监控-tomcat"><a href="#监控-tomcat" class="headerlink" title="监控 tomcat"></a>监控 tomcat</h3><p>所有的监控，配置步骤都是一样的：</p>
<ol>
<li>创建主机</li>
<li>给主机添加模板</li>
</ol>
<h3 id="主动与被动监控模式"><a href="#主动与被动监控模式" class="headerlink" title="主动与被动监控模式"></a>主动与被动监控模式</h3><p>主动和被动都是相对 agent 来说的，被动模式配置简单，所以默认是被动模式</p>
<ul>
<li>被动检查：zabbix server（或 proxy）向 agent 要数据，agent 才工作，否则就不工作</li>
<li>主动检查：agent 从 zabbix server 获取监控项列表，然后定期采集数据，主动发送给 zabbix server</li>
</ul>
<h4 id="被动模式"><a href="#被动模式" class="headerlink" title="被动模式"></a>被动模式</h4><p>被动模式下，zabbix server 会根据主机关联的模板中的监控项和数据采集间隔时间，周期性的打开随机端口并向 zabbix agent 服务器的 10050 发起 tcp 连接，然后发送获取监控项数据的指令，即 zabbix server 发送什么指令，zabbix agent 就收集什么数据，zabbix server 什么时候发送 zabbix agent 就什么时候采集，zabbix server 不发送 zabbix agent 就闲着，所以 zabbix agent 也不用关心其监控项和数据采集周期间隔时间</p>
<p>优点就是配置简单，缺点是会加大 zabbix server 的工作量，在数百甚至数千台服务器的环境下会导致 zabbix server 需要轮训向每个 zabbix agent 发送数据采集指令，如果 zabbix server 负载很高还会导致不能及时获取到最新数据</p>
<h4 id="主动模式"><a href="#主动模式" class="headerlink" title="主动模式"></a>主动模式</h4><p>主动模式下，zabbix agent 主动向 zabbix server 的 10051 端口发起 tcp 连接请求（zabbix agent 配置文件中指定 zabbix server 的 IP 或者主机名），获取到自己的监控项和数据采集周期等信息，然后再周期性的采集指定的数返回给 zabbix server</p>
<p>主动模式可以有效减轻 zabbix server 的压力，推荐使用主动模式</p>
<p><strong>配置主动模式：</strong></p>
<ol>
<li><p>修改 zabbix agent 配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zabbix_agentd.conf</span>
<span class="token assign-left variable">PidFile</span><span class="token operator">=</span>/usr/local/zabbix/run/zabbix_agentd.pid
<span class="token assign-left variable">LogFile</span><span class="token operator">=</span>/tmp/zabbix_agentd.log
<span class="token assign-left variable">LogFileSize</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">Server</span><span class="token operator">=</span><span class="token number">10.0</span>.1.21	<span class="token comment"># 被动模式下，指定zabbix server的ip，如果全部监控项都是主动模式，则可注释此项</span>
<span class="token assign-left variable">StartAgents</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">ServerActive</span><span class="token operator">=</span><span class="token number">10.0</span>.1.21		<span class="token comment"># 重点，开启主动模式，指定zabbix server的ip</span>
<span class="token assign-left variable">Hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.1.26			<span class="token comment"># zabbix agent本机的ip</span>
<span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">30</span>
<span class="token assign-left variable">Include</span><span class="token operator">=</span>/usr/local/etc/zabbix_agentd.conf.d/*.conf</code></pre>
</li>
<li><p>生成主动模式模板<br>完全克隆 zabbix 内置的 Template OS Linux 模板，命名为：Template OS Linux-active，修改监控项的类型，可以单独改，也可以批量更新</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613050322184.png"></p>
</li>
<li><p>最后把主动模式模板添加到主机上</p>
</li>
</ol>
<h2 id="zabbix-proxy-1"><a href="#zabbix-proxy-1" class="headerlink" title="zabbix proxy"></a>zabbix proxy</h2><h3 id="zabbix-proxy-架构"><a href="#zabbix-proxy-架构" class="headerlink" title="zabbix proxy 架构"></a>zabbix proxy 架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613135861331.png"></p>
<h3 id="zabbix-proxy-对比-zbbbix-server"><a href="#zabbix-proxy-对比-zbbbix-server" class="headerlink" title="zabbix proxy 对比 zbbbix server"></a>zabbix proxy 对比 zbbbix server</h3><table>
<thead>
<tr>
<th>功能</th>
<th>zabbxy proxy</th>
<th>zabbix server</th>
</tr>
</thead>
<tbody><tr>
<td>量级</td>
<td>请量级</td>
<td>相对重量级</td>
</tr>
<tr>
<td>图形</td>
<td>无</td>
<td>带图形控制界面</td>
</tr>
<tr>
<td>可以独立工作</td>
<td>是，可以独立采集数据并存储</td>
<td>是，即数据采集、存储、分析、展示于一体</td>
</tr>
<tr>
<td>易维护</td>
<td>是，配置完成后基本无需管理</td>
<td>维护也不难</td>
</tr>
<tr>
<td>独立数据库</td>
<td>保留少量最近数据</td>
<td>保留指定时间内的所有数据</td>
</tr>
<tr>
<td>报警通知</td>
<td>不支持发送邮件通知</td>
<td>支持邮件、短信等告警机制（基于调用脚本）</td>
</tr>
</tbody></table>
<h3 id="zabbix-proxy-部署与使用"><a href="#zabbix-proxy-部署与使用" class="headerlink" title="zabbix proxy 部署与使用"></a>zabbix proxy 部署与使用</h3><p>zabbix proxy 的大版本必须要和 zabbix server 版本一致，否则会出现兼容性问题</p>
<h4 id="apt-x2F-yum-安装-zabbix-proxy"><a href="#apt-x2F-yum-安装-zabbix-proxy" class="headerlink" title="apt&#x2F;yum 安装 zabbix proxy"></a>apt&#x2F;yum 安装 zabbix proxy</h4><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/installation/install_from_packages/debian_ubuntu">https://www.zabbix.com/documentation/4.0/zh/manual/installation/install_from_packages/debian_ubuntu</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装软件仓库配置包</span>
<span class="token variable">$wget</span> https://repo.zabbix.com/zabbix/4.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_4.0-2+bionic_all.deb
<span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> zabbix-release_4.0-2+stretch_all.deb
<span class="token variable">$sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@http://repo.zabbix.com@https://mirrors.aliyun.com/zabbix@'</span> /etc/apt/sources.list.d/zabbix.list
<span class="token variable">$apt</span> update
<span class="token comment"># 安装 SERVER/PROXY/前端</span>
<span class="token variable">$apt</span> <span class="token function">install</span> zabbix-proxy-mysql
<span class="token variable">$cat</span> /lib/systemd/system/zabbix-proxy.service	<span class="token comment"># 这里的service文件没有看懂</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Zabbix Proxy <span class="token punctuation">(</span>MySQL/MariaDB<span class="token punctuation">)</span>
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:zabbix_proxy
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target mysql.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">User</span><span class="token operator">=</span>zabbix
<span class="token assign-left variable">Group</span><span class="token operator">=</span>zabbix
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/sbin/zabbix_proxy <span class="token parameter variable">--foreground</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-abnormal

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token comment"># 配置数据库</span>
略<span class="token punctuation">..</span>.</code></pre>

<h4 id="编译安装-zabbix-proxy"><a href="#编译安装-zabbix-proxy" class="headerlink" title="编译安装 zabbix proxy"></a>编译安装 zabbix proxy</h4><ol>
<li>编译安装，参考脚本…</li>
<li>修改被监控主机的配置文件，Server 和 ServerActive</li>
<li>管理 -&gt; agent 代理程序 -&gt; 创建代理（注意名称要和 zabbix_proxy.conf 中的 hostname 对应起来） -&gt; 修改主机的“由 agent 代理程序监测”参数</li>
</ol>
<h2 id="zabbix-监控案例实战"><a href="#zabbix-监控案例实战" class="headerlink" title="zabbix 监控案例实战"></a>zabbix 监控案例实战</h2><ol>
<li>自定义监控项</li>
<li>通过脚本采集监控项数据</li>
<li>zabbix agent 获取监控项数据</li>
<li>自定义模板和图形及触发器</li>
<li>验证数据</li>
</ol>
<h3 id="监控-Linux-TCP-连接状态"><a href="#监控-Linux-TCP-连接状态" class="headerlink" title="监控 Linux TCP 连接状态"></a>监控 Linux TCP 连接状态</h3><ol>
<li><p>监控 TCP 连接数脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-web1 ~<span class="token punctuation">]</span><span class="token comment">#cat /usr/local/zabbix/data/tcp_conn.sh</span>
<span class="token comment">#!/bin/bash</span>
ss <span class="token parameter variable">-ant</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token parameter variable">-v</span> <span class="token assign-left variable">TCP_STAT</span><span class="token operator">=</span><span class="token variable">$1</span> <span class="token parameter variable">-v</span> <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">'$1==TCP_STAT &#123;++s&#125; END &#123;print s&#125;'</span></code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$vim</span> zabbix_agentd.conf
<span class="token punctuation">..</span>.
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>tcp_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/bin/bash /usr/local/zabbix/data/tcp_conn.sh <span class="token variable">$1</span> <span class="token variable">$2</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$chmod</span> a+x zabbix_agentd.conf
<span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart zabbix-agent</code></pre>
</li>
<li><p>zabbix server 测试监控项数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix bin<span class="token punctuation">]</span>$./zabbix_get <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.1.26 <span class="token parameter variable">-p</span> <span class="token number">10050</span> <span class="token parameter variable">-k</span> tcp_status<span class="token punctuation">[</span>TIME-WAIT<span class="token punctuation">]</span>
<span class="token number">1</span>
<span class="token punctuation">[</span>root@zabbix bin<span class="token punctuation">]</span>$./zabbix_get <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.1.26 <span class="token parameter variable">-p</span> <span class="token number">10050</span> <span class="token parameter variable">-k</span> tcp_status<span class="token punctuation">[</span>ESTAB<span class="token punctuation">]</span>
<span class="token number">2</span>
<span class="token punctuation">[</span>root@zabbix bin<span class="token punctuation">]</span>$./zabbix_get <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.1.26 <span class="token parameter variable">-p</span> <span class="token number">10050</span> <span class="token parameter variable">-k</span> tcp_status<span class="token punctuation">[</span>LISTEN<span class="token punctuation">]</span>
<span class="token number">9</span></code></pre>
</li>
<li><p>zabbix web 导入模板<br>配置-模板-导入</p>
</li>
<li><p>将 TCP 监控模板关联至主机</p>
</li>
<li><p>验证监控数据</p>
</li>
</ol>
<h3 id="监控-Memcached"><a href="#监控-Memcached" class="headerlink" title="监控 Memcached"></a>监控 Memcached</h3><ol>
<li><p>安装 memcached</p>
</li>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token string">'^[^#]'</span> /etc/memcached.conf
<span class="token parameter variable">-d</span>
logfile /var/log/memcached.log
<span class="token parameter variable">-m</span> <span class="token number">64</span>
<span class="token parameter variable">-p</span> <span class="token number">11211</span>
<span class="token parameter variable">-u</span> memcache
<span class="token parameter variable">-l</span> <span class="token number">127.0</span>.0.1
<span class="token parameter variable">-P</span> /var/run/memcached/memcached.pid

<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token parameter variable">-e</span> <span class="token string">"stats<span class="token entity" title="\n">\n</span>quit"</span> <span class="token operator">|</span> <span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">11211</span>
STAT pid <span class="token number">5590</span>
STAT <span class="token function">uptime</span> <span class="token number">725</span>
STAT <span class="token function">time</span> <span class="token number">1613618905</span>
STAT version <span class="token number">1.5</span>.6 Ubuntu
STAT libevent <span class="token number">2.1</span>.8-stable
STAT pointer_size <span class="token number">64</span>
STAT rusage_user <span class="token number">0.072870</span>
STAT rusage_system <span class="token number">0.048580</span>
STAT max_connections <span class="token number">1024</span>
STAT curr_connections <span class="token number">1</span>
STAT total_connections <span class="token number">4</span>
STAT rejected_connections <span class="token number">0</span>
STAT connection_structures <span class="token number">2</span>
STAT reserved_fds <span class="token number">20</span>
STAT cmd_get <span class="token number">0</span>
STAT cmd_set <span class="token number">0</span>
STAT cmd_flush <span class="token number">0</span>
STAT cmd_touch <span class="token number">0</span>
STAT get_hits <span class="token number">0</span>
STAT get_misses <span class="token number">0</span>
STAT get_expired <span class="token number">0</span>
STAT get_flushed <span class="token number">0</span>
STAT delete_misses <span class="token number">0</span>
STAT delete_hits <span class="token number">0</span>
STAT incr_misses <span class="token number">0</span>
STAT incr_hits <span class="token number">0</span>
STAT decr_misses <span class="token number">0</span>
STAT decr_hits <span class="token number">0</span>
STAT cas_misses <span class="token number">0</span>
STAT cas_hits <span class="token number">0</span>
STAT cas_badval <span class="token number">0</span>
STAT touch_hits <span class="token number">0</span>
STAT touch_misses <span class="token number">0</span>
STAT auth_cmds <span class="token number">0</span>
STAT auth_errors <span class="token number">0</span>
STAT bytes_read <span class="token number">35</span>
STAT bytes_written <span class="token number">3795</span>
STAT limit_maxbytes <span class="token number">67108864</span>
STAT accepting_conns <span class="token number">1</span>
STAT listen_disabled_num <span class="token number">0</span>
STAT time_in_listen_disabled_us <span class="token number">0</span>
STAT threads <span class="token number">4</span>
STAT conn_yields <span class="token number">0</span>
STAT hash_power_level <span class="token number">16</span>
STAT hash_bytes <span class="token number">524288</span>
STAT hash_is_expanding <span class="token number">0</span>
STAT slab_reassign_rescues <span class="token number">0</span>
STAT slab_reassign_chunk_rescues <span class="token number">0</span>
STAT slab_reassign_evictions_nomem <span class="token number">0</span>
STAT slab_reassign_inline_reclaim <span class="token number">0</span>
STAT slab_reassign_busy_items <span class="token number">0</span>
STAT slab_reassign_busy_deletes <span class="token number">0</span>
STAT slab_reassign_running <span class="token number">0</span>
STAT slabs_moved <span class="token number">0</span>
STAT lru_crawler_running <span class="token number">0</span>
STAT lru_crawler_starts <span class="token number">1275</span>
STAT lru_maintainer_juggles <span class="token number">774</span>
STAT malloc_fails <span class="token number">0</span>
STAT log_worker_dropped <span class="token number">0</span>
STAT log_worker_written <span class="token number">0</span>
STAT log_watcher_skipped <span class="token number">0</span>
STAT log_watcher_sent <span class="token number">0</span>
STAT bytes <span class="token number">0</span>
STAT curr_items <span class="token number">0</span>
STAT total_items <span class="token number">0</span>
STAT slab_global_page_pool <span class="token number">0</span>
STAT expired_unfetched <span class="token number">0</span>
STAT evicted_unfetched <span class="token number">0</span>
STAT evicted_active <span class="token number">0</span>
STAT evictions <span class="token number">0</span>
STAT reclaimed <span class="token number">0</span>
STAT crawler_reclaimed <span class="token number">0</span>
STAT crawler_items_checked <span class="token number">0</span>
STAT lrutail_reflocked <span class="token number">0</span>
STAT moves_to_cold <span class="token number">0</span>
STAT moves_to_warm <span class="token number">0</span>
STAT moves_within_lru <span class="token number">0</span>
STAT direct_reclaims <span class="token number">0</span>
STAT lru_bumps_dropped <span class="token number">0</span>
END

<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$cat</span> memcache_monitor.sh
<span class="token comment">#!/bin/bash</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"stats<span class="token entity" title="\n">\n</span>quit"</span> <span class="token operator">|</span> <span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">11211</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"STAT <span class="token variable">$1</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $3&#125;'</span></code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
</li>
<li><p>zabbix server 测试监控项数据</p>
</li>
<li><p>zabbix web 制作模板</p>
<ol>
<li>创建模板</li>
<li>创建监控项</li>
<li>创建触发器</li>
<li>创建图形</li>
</ol>
</li>
<li><p>模板关联主机</p>
</li>
<li><p>验证监控项数据</p>
</li>
</ol>
<h3 id="监控-Redis"><a href="#监控-Redis" class="headerlink" title="监控 Redis"></a>监控 Redis</h3><ol>
<li><p>安装 Redis</p>
</li>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> info			<span class="token comment"># 所有info</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> info clients	<span class="token comment"># 客户端相关info</span>
<span class="token comment"># Clients</span>
connected_clients:1				<span class="token comment"># 当前连接数</span>
client_longest_output_list:0
client_biggest_input_buf:0
blocked_clients:0
<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> info memory		<span class="token comment"># 内存相关info</span>
<span class="token comment"># Memory</span>
used_memory:839288				<span class="token comment"># 已用内存</span>
used_memory_human:819.62K
used_memory_rss:3846144
used_memory_rss_human:3.67M
used_memory_peak:841288
used_memory_peak_human:821.57K
used_memory_peak_perc:99.76%
used_memory_overhead:832134
used_memory_startup:782504
used_memory_dataset:7154
used_memory_dataset_perc:12.60%
total_system_memory:2065870848
total_system_memory_human:1.92G
used_memory_lua:37888
used_memory_lua_human:37.00K
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
mem_fragmentation_ratio:4.58
mem_allocator:jemalloc-3.6.0
active_defrag_running:0
lazyfree_pending_objects:0</code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
</li>
<li><p>zabbix server 测试监控项数据</p>
</li>
<li><p>zabbix web 模板制作</p>
<ol>
<li>创建模板</li>
<li>创建触监控项：当前连接数监控项、已用内存监控项</li>
<li>创建触发器：当前连接数触发器、已用内存触发器</li>
<li>创建图形：Redis 当前连接数图形、Redis 已用内存图形</li>
</ol>
</li>
<li><p>模板关联主机</p>
</li>
<li><p>验证监控项数据</p>
</li>
</ol>
<h3 id="监控-Nginx"><a href="#监控-Nginx" class="headerlink" title="监控 Nginx"></a>监控 Nginx</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613622059982.png"></p>
<ol>
<li><p>安装 nginx</p>
</li>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function-name function">nginx_active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Active'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_reading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Reading'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_writing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Writing'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $4&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Waiting'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $6&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_accepts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">awk</span> <span class="token assign-left variable">NR</span><span class="token operator">==</span><span class="token number">3</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_handled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">awk</span> <span class="token assign-left variable">NR</span><span class="token operator">==</span><span class="token number">3</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_requests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">awk</span> <span class="token assign-left variable">NR</span><span class="token operator">==</span><span class="token number">3</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $3&#125;'</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
active<span class="token punctuation">)</span>
    nginx_active
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
reading<span class="token punctuation">)</span>
    nginx_reading
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
writing<span class="token punctuation">)</span>
    nginx_writing
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
waiting<span class="token punctuation">)</span>
    nginx_waiting
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
accepts<span class="token punctuation">)</span>
    nginx_accepts
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
handled<span class="token punctuation">)</span>
    nginx_handled
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
requests<span class="token punctuation">)</span>
    nginx_requests
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span></code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$cat</span> zabbix_agentd.conf
<span class="token punctuation">..</span>.
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>nginx_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/data/nginx_status.sh <span class="token variable">$1</span>
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>导入 Nginx 监控模板</p>
</li>
<li><p>模板关联主机</p>
</li>
<li><p>验证监控数据</p>
</li>
</ol>
<h3 id="SNMP-监控"><a href="#SNMP-监控" class="headerlink" title="SNMP 监控"></a>SNMP 监控</h3><p>SNMP：Simple Network Management Protocol，简单网络管理协议，<strong>TCP&#x2F;IP 协议簇的一个应用层协议</strong></p>
<p>Linux 设备通过 agent 监控，网络设备通过 SNMP 协议监控，主要用于监控华为、思科等网络设备</p>
<p>SNMP 有三个版本：目前主要使用的是 v2c 版本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">SNMP v1		<span class="token comment"># 团体名（Community Name）认证</span>
SNMP v2c	<span class="token comment"># 团体名认证，它在兼容SNMP v1的同时又扩充了SNMP v1的功能</span>
SNMP v3		<span class="token comment"># 基于用户的安全模型（USM，User-Based Security Model）的认证机制</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1613654628015.png"></p>
<h4 id="SNMP-数据交互"><a href="#SNMP-数据交互" class="headerlink" title="SNMP 数据交互"></a>SNMP 数据交互</h4><p>SNMP 管理进程与代理进程之间为了交互信息，定义了 5 种报文：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">get-request			<span class="token comment"># 从代理进程处提取一个或多个参数值</span>
get-response		<span class="token comment"># 返回的一个或多个参数值。这个操作是由代理进程发出的</span>
<span class="token builtin class-name">trap</span>				<span class="token comment"># 代理进程主动发出的报文，通知管理进程有某些事情发生</span>
get-next-request	<span class="token comment"># 从代理进程处提取一个或多个参数的下一个参数值</span>
set-request			<span class="token comment"># 设置代理进程的一个或多个参数值</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1613636339217.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613636481313.png"></p>
<h4 id="SNMP-组织结构"><a href="#SNMP-组织结构" class="headerlink" title="SNMP 组织结构"></a>SNMP 组织结构</h4><p>SNMP 结构非常复杂，一套完整的 SNMP 系统主要包括以下几个方面：</p>
<ol>
<li>SNMP 报文协议</li>
<li>管理信息结构（SMI， Structure of Management Information），一套公用的结构和表示符号</li>
<li>管理信息库（MIB，Management Information Base），管理信息库包含所有代理进程的所有可被查询和修改的参数</li>
<li>OID（Object Identifiers），一个 OID 是一个唯一的键值对，用于标识具体某一个设备的某个具体信息（对象标识），如端口信息、设备名称等</li>
</ol>
<h4 id="SNMP-MIB"><a href="#SNMP-MIB" class="headerlink" title="SNMP MIB"></a>SNMP MIB</h4><p>MIB 是 OID 的集合。MIB 是基于对象标识树的，对象标识是一个整数序列，中间以”.”分割，这些整数构成一个树型结构，类似于 DNS 或 Unix 的文件系统，MIB 被划分为若干个组，如 system、 interfaces、 a t（地址转换）和 ip 组等。iso. org.dod.internet.private.enterprises（1.3 .6 .1.4.1）这个标识，是给厂家自定义而预留的，比如华为：1.3.6.1.4.1.2011，华三：1.3.6.1.4.1.25506</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613636377969.png"></p>
<h4 id="SNMP-OID"><a href="#SNMP-OID" class="headerlink" title="SNMP OID"></a>SNMP OID</h4><p>OID 就是对象标识</p>
<p>snmpwalk 工具可以使用 SNMP 的 get 请求查询指定 OID 入口的所有 OID 树信息。通过 snmpwalk 也可以查看支持 SNMP 协议（可网管）的设备的一些其他信息，比如 cisco 交换机或路由器 IP 地址、内存使用率等，也可用来协助开发 SNMP 功能</p>
<p>ubuntu 中版本较新，这里以 centos7 为例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> net-snmp-utils
<span class="token variable">$snmpwalk</span> <span class="token parameter variable">-h</span>
USAGE: snmpwalk <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> AGENT <span class="token punctuation">[</span>OID<span class="token punctuation">]</span>
–h：显示帮助。
–v：指定snmp的版本, <span class="token number">1</span>或者2c或者3。
–c：指定连接设备SNMP密码。			<span class="token comment"># 重点</span>
–V：显示当前snmpwalk命令行版本。		<span class="token comment"># 重点，其实基本上也就只用这俩参数</span>
–r：指定重试次数，默认为0次。
–t：指定每次请求的等待超时时间，单为秒，默认为3秒。
–l：指定安全级别：noAuthNoPriv<span class="token operator">|</span>authNoPriv<span class="token operator">|</span>authPriv。
–a：验证协议：MD5<span class="token operator">|</span>SHA。只有-l指定为authNoPriv或authPriv时才需要。
–A：验证字符串。只有-l指定为authNoPriv或authPriv时才需要。
–x：加密协议：DES。只有-l指定为authPriv时才需要。
–X：加密字符串。只有-l指定为authPriv时才需要。

<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token comment">#snmpwalk -v 2c -c 123456 10.0.58.108 1.3.6.1.2.1.1.1</span>
iso.3.6.1.2.1.1.1.0 <span class="token operator">=</span> STRING: <span class="token string">"Linux centos7 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64"</span>

<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token comment">#snmpwalk -v 2c -c 123456 10.0.58.108 1.3.6.1.2.1.1.5</span>
iso.3.6.1.2.1.1.5.0 <span class="token operator">=</span> STRING: <span class="token string">"centos7"</span></code></pre>

<h4 id="配置-zabbix"><a href="#配置-zabbix" class="headerlink" title="配置 zabbix"></a>配置 zabbix</h4><p>使用 zabbix 自带的 SNMP，<font color=black>要先修改团体名称，否则 会因为团体名不一致导致 zabbix 没有权限去获取被监控服务器的 snmp 利用率</font></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613655277258.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613655353719.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613655591144.png"></p>
<h3 id="监控-MySQL"><a href="#监控-MySQL" class="headerlink" title="监控 MySQL"></a>监控 MySQL</h3><p>监控 MySQL 连接数、主从同步、同步延迟等</p>
<h4 id="percona-monitoring-plugins"><a href="#percona-monitoring-plugins" class="headerlink" title="percona-monitoring-plugins"></a>percona-monitoring-plugins</h4><p>percona 官方出了专门的监控管理软件，所以已经停止维护 percona-monitoring-plugins，以下使用旧的版本</p>
<ol>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mysql-master src<span class="token punctuation">]</span><span class="token variable">$wget</span> https://downloads.percona.com/downloads/percona-monitoring-plugins/percona-monitoring-plugins-1.1.8/binary/debian/artful/x86_64/percona-zabbix-templates_1.1.8-1.artful_all.deb

<span class="token variable">$dpkg</span> <span class="token parameter variable">-c</span> percona-zabbix-templates_1.1.8-1.artful_all.deb <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span>
<span class="token punctuation">..</span>.
./var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh	<span class="token comment"># 监控脚本，修改手动修改</span>
./var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php	<span class="token comment"># 设置mysql的用户名和密码</span>
./var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf	<span class="token comment"># userparameter</span>
./var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8.xml	<span class="token comment"># 模板文件，直接导入即可</span>
<span class="token punctuation">..</span>.
<span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> percona-zabbix-templates_1.1.8-1.artful_all.deb

<span class="token variable">$cp</span> /var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh /usr/local/zabbix/data/
<span class="token variable">$vim</span> /var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php
<span class="token operator">&lt;</span>?php
<span class="token punctuation">..</span>.
<span class="token variable">$mysql_user</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">;</span>
<span class="token variable">$mysql_pass</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>新建模板：直接导入<code>zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8.xml</code>即可</p>
</li>
<li><p>新建主机，并连接到刚创建的模板</p>
</li>
</ol>
<h4 id="自定义脚本监控-MySQL"><a href="#自定义脚本监控-MySQL" class="headerlink" title="自定义脚本监控 MySQL"></a>自定义脚本监控 MySQL</h4><p>编写脚本监控脚本 MySQL 主从同步及延迟</p>
<p>slave 机器上有两个关键的进程：</p>
<ul>
<li>Slave_SQL_Running：负责自己的 slave mysql 进程</li>
<li>Slave_IO_Running：负责与主机的 io 通信</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 主从延迟，实际上只靠 Seconds_Behind_Master 这一个参数是不够的</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-e</span> <span class="token string">"show slave status\G;"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Seconds_Behind_Master:"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'&#123;print $2&#125;'</span>

mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-e</span> <span class="token string">"show slave status\G;"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Slave_IO_Running"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'&#123;print $2&#125;'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^[ \t]*//g'</span>

mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-e</span> <span class="token string">"show slave status\G;"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Slave_SQL_Running:"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'&#123;print $2&#125;'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^[ \t]*//g'</span></code></pre>

<h3 id="自定义端口和进程监控"><a href="#自定义端口和进程监控" class="headerlink" title="自定义端口和进程监控"></a>自定义端口和进程监控</h3><p>zabbix 内置相关 key：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查 TCP 端口 是否处于侦听状态。返回 0 - 未侦听；1 - 正在侦听</span>
net.tcp.listen<span class="token punctuation">[</span>port<span class="token punctuation">]</span>
<span class="token comment"># 检查是否能建立 TCP 连接到指定端口。返回 0 - 不能连接；1 - 可以连接</span>
net.tcp.port<span class="token punctuation">[</span><span class="token operator">&lt;</span>ip<span class="token operator">></span>,port<span class="token punctuation">]</span>
<span class="token comment"># 检查服务是否运行并接受 TCP 连接。返回 0 - 服务关闭；1 - 服务运行</span>
net.tcp.service<span class="token punctuation">[</span>service,<span class="token operator">&lt;</span>ip<span class="token operator">></span>,<span class="token operator">&lt;</span>port<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token comment"># 检查 TCP 服务的性能，当服务 down 时返回 0，否则返回连接服务花费的秒数</span>
net.tcp.service.perf<span class="token punctuation">[</span>service,<span class="token operator">&lt;</span>ip<span class="token operator">></span>,<span class="token operator">&lt;</span>port<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<h3 id="故障自治愈功能"><a href="#故障自治愈功能" class="headerlink" title="故障自治愈功能"></a>故障自治愈功能</h3><p>当 zabbix 监控到指定的监控项异常的时候，通过指定的操作使故障自动恢复，通常是重启服务等一些简单的操作，也可以调用脚本执行比较复杂的操作</p>
<p>设置监控项和触发器，新建动作，在触发条件里面添加操作，在远程主机通过 zabbix 客户端执行命令</p>
<ol>
<li><p>zabbix agent 需要开启远程命令执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zabbix_agentd.conf</span>
<span class="token assign-left variable">EnableRemoteCommands</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 开启远程执行命令</span>
<span class="token assign-left variable">UnsafeUserParameters</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 允许远程执行命令的时候使用不安全的参数(特殊字符串)</span></code></pre>
</li>
<li><p>zabbix 用户授权</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># /etc/sudoers</span>
zabbix ALL <span class="token operator">=</span> NOPASSWD: ALL	<span class="token comment"># 授权指定用户执行特殊命令不再需要密码，比如sudo等</span></code></pre>
</li>
<li><p>创建动作<br>配置–动作–创建动作<br><img data-src="//img.to2b.cn/blog/ljk/1613698738326.png"></p>
</li>
<li><p>执行远程操作</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613698754613.png"></p>
</li>
<li><p>验证自治愈功能</p>
<p>将被测试的服务手动停止运行，验证能否自动启动或重启，更多操作可以远程执行脚本<br>手动将 Nginx、Tomcat 等 web 服务停止后，验证 zabbix agent 能否自动启动或重启</p>
</li>
</ol>
<h3 id="grafana-图形展示"><a href="#grafana-图形展示" class="headerlink" title="grafana 图形展示"></a>grafana 图形展示</h3><p>grafana 本身只是一个图形显示工具，它独立于 zabbix 之外，通过 zabbix 提供的 api 获取数据，进行展示，其实不只是 zabbix，它还可以搭配 prometheus、elasticsearch、mysql 等等，只要你提供数据，它都能给你展示出来</p>
<p>grafana 相比 zabbix 自带的 web 界面，更加好看</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613701073079.png"></p>
<ol>
<li><p>安装 grafana 服务<br><a target="_blank" rel="noopener" href="https://grafana.com/grafana/download?platform=linux">https://grafana.com/grafana/download?platform=linux</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> adduser libfontconfig1
<span class="token function">wget</span> https://dl.grafana.com/oss/release/grafana_7.4.2_amd64.deb
<span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> grafana_7.4.2_amd64.deb</code></pre>
</li>
<li><p>grafana 安装并启用 zabbix 插件<br><a target="_blank" rel="noopener" href="https://grafana.com/grafana/plugins/alexanderzobnin-zabbix-app">https://grafana.com/grafana/plugins/alexanderzobnin-zabbix-app</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">grafana-cli plugins <span class="token function">install</span> alexanderzobnin-zabbix-app

<span class="token comment"># 以上方式可能失败，推荐直接下载，然后移动到插件目录</span>
<span class="token variable">$wegt</span> https://storage.googleapis.com/plugins-community/alexanderzobnin-zabbix-app/release/4.1.2/alexanderzobnin-zabbix-app-4.1.2.zip
<span class="token variable">$unzip</span> alexanderzobnin-zabbix-app-4.1.2.zip
<span class="token variable">$mv</span> alexanderzobnin-zabbix-app /var/lib/grafana/plugins/

<span class="token variable">$systemctl</span> restart grafana-server.service</code></pre>
</li>
<li><p>启动 zabbix 插件</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613726193516.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613726466582.png"></p>
</li>
<li><p>添加 zabbix 数据源</p>
<ol>
<li><p>添加 mysql 数据源</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727074510.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727183092.png"></p>
</li>
<li><p>添加 zabbix 数据源</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727236979.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727527469.png"></p>
</li>
</ol>
</li>
<li><p>添加 Dashboard</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613728220959.png"></p>
</li>
</ol>
<h3 id="自定义基础监控模板"><a href="#自定义基础监控模板" class="headerlink" title="自定义基础监控模板"></a>自定义基础监控模板</h3><p>略…</p>
<h3 id="结合-pyhton-脚本监控案例"><a href="#结合-pyhton-脚本监控案例" class="headerlink" title="结合 pyhton 脚本监控案例"></a>结合 pyhton 脚本监控案例</h3><h4 id="kubernetes-集群状态监控脚本"><a href="#kubernetes-集群状态监控脚本" class="headerlink" title="kubernetes 集群状态监控脚本"></a>kubernetes 集群状态监控脚本</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kubernetes-master1 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/local/zabbix/data/k8s_monitor.py</span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author ZhangShiJie</span>

<span class="token function">import</span> subprocess
success_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token assign-left variable">error_list</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
def get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token variable"><span class="token punctuation">((</span>"curl <span class="token operator">-</span>sXGET http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10.20</span><span class="token number">.15</span><span class="token number">.209</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>nodes"<span class="token punctuation">)</span><span class="token punctuation">,</span>shell<span class="token operator">=</span>True<span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
    data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    data2 <span class="token operator">=</span> data1.get<span class="token punctuation">(</span>'items'<span class="token punctuation">)</span>
    #print data2
    for i in data2<span class="token operator">:</span>
        data3 <span class="token operator">=</span> i.get<span class="token punctuation">(</span>'status'<span class="token punctuation">)</span>
        for i in data3.get<span class="token punctuation">(</span>'conditions'<span class="token punctuation">)</span><span class="token operator">:</span>
            if i.get<span class="token punctuation">(</span>'reason'<span class="token punctuation">)</span> <span class="token operator">==</span> 'KubeletReady'<span class="token operator">:</span>
                if i.get<span class="token punctuation">(</span>'type'<span class="token punctuation">)</span> <span class="token operator">==</span> "Ready"<span class="token operator">:</span>
                    if i.get<span class="token punctuation">(</span>'status'<span class="token punctuation">)</span> <span class="token operator">==</span> 'True'<span class="token operator">:</span>
                        success_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span>'status'<span class="token punctuation">))</span></span>
                    <span class="token keyword">elif</span> i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'False'</span><span class="token builtin class-name">:</span>
                        error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">))</span>
                    else:
                        <span class="token builtin class-name">break</span>
                else:
                    error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">))</span>
                    <span class="token comment">#pass</span>
            else:
                error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">))</span>

def count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>error_list<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>:
        print <span class="token number">50</span>
    else:
        print <span class="token number">100</span>

def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># chmod a+x /usr/local/zabbix/data/k8s_monitor.py</span></code></pre>

<h4 id="监控-MongodbDB-复制集状态"><a href="#监控-MongodbDB-复制集状态" class="headerlink" title="监控 MongodbDB 复制集状态"></a>监控 MongodbDB 复制集状态</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cat /usr/local/zabbix/data/mongodb_cluster_monitor.py</span>
<span class="token comment">#!/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author: ZhangShiJie</span>

<span class="token function">import</span> subprocess
success_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token assign-left variable">error_list</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

def get_mongodb_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token punctuation">((</span><span class="token string">"echo 'rs.status()' | /usr/local/mongodb/bin/mongo -u user -p wswd --authenticationDatabase admin \
| grep health | awk -F':' '&#123;print <span class="token variable">$2</span>&#125;' | awk -F',' '&#123;print <span class="token variable">$1</span>&#125;'"</span><span class="token punctuation">)</span>,shell<span class="token operator">=</span>True, <span class="token assign-left variable">stdout</span><span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
    restful <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> restful.split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> data:
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">"1"</span><span class="token builtin class-name">:</span>
            success_list.append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        else:
            error_list.append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

def count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>error_list<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>:
        print <span class="token number">100</span>
    else:
        print <span class="token number">50</span>

def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_mongodb_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#chmod a+x /usr/local/zabbix/data/redis_llen.py</span></code></pre>

<h4 id="监控-Redis-列表长度"><a href="#监控-Redis-列表长度" class="headerlink" title="监控 Redis 列表长度"></a>监控 Redis 列表长度</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@redis ~<span class="token punctuation">]</span><span class="token comment">#cat /usr/local/zabbix/data/redis_llen.py</span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author ZhangShijie</span>
<span class="token function">import</span> redis
def redis_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token assign-left variable">pool</span><span class="token operator">=</span>redis.ConnectionPool<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"10.20.0.252"</span>,port<span class="token operator">=</span><span class="token number">6379</span>,db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    conn <span class="token operator">=</span> redis.Redis<span class="token punctuation">(</span>connection_pool<span class="token operator">=</span>pool<span class="token punctuation">)</span>
    data <span class="token operator">=</span> conn.llen<span class="token punctuation">(</span><span class="token string">'api4-nginx-accesslog'</span><span class="token punctuation">)</span>
    print<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
redis_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@redis ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x /usr/local/zabbix/data/redis_llen.py</span></code></pre>

<h4 id="监控-ELK-集群状态"><a href="#监控-ELK-集群状态" class="headerlink" title="监控 ELK 集群状态"></a>监控 ELK 集群状态</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk-s1 ~<span class="token punctuation">]</span><span class="token comment"># vim /usr/local/zabbix/data/els_status.py</span>

<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author ZhangShijie</span>

<span class="token function">import</span> subprocess
<span class="token assign-left variable">false</span><span class="token operator">=</span><span class="token string">"false"</span>
obj <span class="token operator">=</span> subprocess.Popen<span class="token punctuation">((</span><span class="token string">"curl -sXGET http://10.20.3.128:9200/_cluster/health?
pretty=true"</span><span class="token punctuation">)</span>,shell<span class="token operator">=</span>True, <span class="token assign-left variable">stdout</span><span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
status <span class="token operator">=</span> data1.get<span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> status <span class="token operator">==</span> <span class="token string">"green"</span><span class="token builtin class-name">:</span>
    print <span class="token string">"100"</span>
else:
    print <span class="token string">"50"</span>

<span class="token punctuation">[</span>root@elk-s1 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x /usr/local/zabbix/data/els_status.py</span></code></pre>

<h4 id="监控-RabbitMQ-集群节点状态"><a href="#监控-RabbitMQ-集群节点状态" class="headerlink" title="监控 RabbitMQ 集群节点状态"></a>监控 RabbitMQ 集群节点状态</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cat /usr/local/zabbix/data/rabbit_cluster_monitor.py</span>
<span class="token comment">#!/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author: ZhangShiJie</span>

<span class="token function">import</span> subprocess
running_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
error_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token assign-left variable">false</span><span class="token operator">=</span><span class="token string">"false"</span>
<span class="token assign-left variable">true</span><span class="token operator">=</span><span class="token string">"true"</span>
def get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token variable"><span class="token punctuation">((</span>"curl <span class="token operator">-</span>sXGET <span class="token operator">-</span>u guest<span class="token operator">:</span>guest http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10.20</span><span class="token number">.3</span><span class="token number">.171</span><span class="token operator">:</span><span class="token number">15671</span><span class="token operator">/</span>api<span class="token operator">/</span>nodes"<span class="token punctuation">)</span><span class="token punctuation">,</span>shell<span class="token operator">=</span>True<span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
    data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    for i in data1<span class="token operator">:</span>
        if i.get<span class="token punctuation">(</span>"running"<span class="token punctuation">)</span> <span class="token operator">==</span> "true"<span class="token operator">:</span>
            running_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span>"name"<span class="token punctuation">))</span></span>
        else:
            error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">))</span>
def count_server<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>running_list<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span>: <span class="token comment">#可以判断错误列表大于0或者运行列表小于3，3未总计的节点数量</span>
        print <span class="token number">100</span> <span class="token comment">#100就是集群内有节点运行不正常了</span>
    else:
        print <span class="token number">50</span> <span class="token comment">#50为所有节点全部运行正常</span>
def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count_server<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#chmoa a+x /usr/local/zabbix/data/rabbit_cluster_monitor.py</span></code></pre>

<h2 id="Zabbix-事件通知机制"><a href="#Zabbix-事件通知机制" class="headerlink" title="Zabbix 事件通知机制"></a>Zabbix 事件通知机制</h2><p>出现故障报警的时候，可以通过不同方式通知管理员进行故障处理，尽快恢复业务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zabbix_server.conf</span>
<span class="token assign-left variable">AlertScriptsPath</span><span class="token operator">=</span>/usr/lib/zabbix/alertscripts 	<span class="token comment">#报警脚本路径</span>
<span class="token assign-left variable">ExternalScripts</span><span class="token operator">=</span>/usr/lib/zabbix/externalscripts <span class="token comment">#外部脚本路径</span></code></pre>

<p>报警的最核心就是把报警媒介配置好，包括它前后的部分</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613730116604.png"></p>
<ol>
<li>添加报警媒介（邮件、短信、微信）</li>
<li>将报警媒介添加到动作的操作中，这样通过动作，就将触发器和报警媒介关联起来了</li>
<li>将报警媒介添加到用户，这样，当有触发器报警，就会通过报警媒介通知到用户</li>
</ol>
<h3 id="邮件通知"><a href="#邮件通知" class="headerlink" title="邮件通知"></a>邮件通知</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613732542403.png"></p>
<h3 id="短信通知"><a href="#短信通知" class="headerlink" title="短信通知"></a>短信通知</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613733940901.png"></p>
<h3 id="微信通知"><a href="#微信通知" class="headerlink" title="微信通知"></a>微信通知</h3><p>略..，和短信通知差不多</p>
<h2 id="Zabbix-自动化运维"><a href="#Zabbix-自动化运维" class="headerlink" title="Zabbix 自动化运维"></a>Zabbix 自动化运维</h2><h3 id="批量部署-Agent"><a href="#批量部署-Agent" class="headerlink" title="批量部署 Agent"></a>批量部署 Agent</h3><p>使用 agent，实现 agent 的自动化批量安装，可以通过源码或 apt 等方式安装</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>通过 zabbix web 进行的操作，都提供对应的 API，可以通过编程的方式实现</p>
<p>API 简介：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/api">https://www.zabbix.com/documentation/4.0/zh/manual/api</a><br>API 列表：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/api/reference">https://www.zabbix.com/documentation/4.0/zh/manual/api/reference</a></p>
<h3 id="动态发现主机"><a href="#动态发现主机" class="headerlink" title="动态发现主机"></a>动态发现主机</h3><p><a target="_blank" rel="noopener" href="http://blogs.studylinux.net/?p=705">http://blogs.studylinux.net/?p=705</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/TomCat/memcached/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/TomCat/memcached/" class="post-title-link" itemprop="url">memcached</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 17:38:34" itemprop="dateCreated datePublished" datetime="2021-02-04T17:38:34+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/TomCat/" itemprop="url" rel="index"><span itemprop="name">TomCat</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Memcached-和-Redis-比较"><a href="#Memcached-和-Redis-比较" class="headerlink" title="Memcached 和 Redis 比较"></a>Memcached 和 Redis 比较</h2><table>
<thead>
<tr>
<th><font style="white-space:nowrap;">比较类别&amp;emsp;&amp;emsp;&amp;emsp;</font></th>
<th>Redis</th>
<th>memcached</th>
</tr>
</thead>
<tbody><tr>
<td>数据结构</td>
<td>哈希、列表、集合、有序集合</td>
<td>纯 kev-value</td>
</tr>
<tr>
<td>持久化</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>高可用</td>
<td>主从复制、读写分离、sentinel、Redis Cluster</td>
<td>需二次开发</td>
</tr>
<tr>
<td>单 value 容量</td>
<td>最大 512M</td>
<td>最大 1M</td>
</tr>
<tr>
<td>内存分配</td>
<td>临时申请空间，可能导致碎片</td>
<td>预分配内存池的方式管理内存，能够省去内存分配时间</td>
</tr>
<tr>
<td>虚拟内存</td>
<td>有自己的 VM 机制，理论上能够存储比物理内存更多的数据，当数据超量时，会引发 swap，把冷数据刷到磁盘上</td>
<td>所有的数据存储在物理内存里</td>
</tr>
<tr>
<td>网络模型</td>
<td>非阻塞 IO 复用模型，提供一些非 KV 存储之外的排序、聚合功能，在执行这些功能时，复杂的 CPU 计算，会阻塞整个 IO 调度</td>
<td>非阻塞 IO 复用模型</td>
</tr>
<tr>
<td>水平扩展的支持</td>
<td>redis cluster 可以横向扩展</td>
<td>暂无</td>
</tr>
<tr>
<td>多线程</td>
<td>Redis6.0 之前是只支持单线程</td>
<td>Memcached 支持多线程,CPU 利用方面 Memcache 优于 Redis</td>
</tr>
<tr>
<td>过期策略</td>
<td>有专门线程，清除缓存数据</td>
<td>懒淘汰机制：每次往缓存放入数据的时候，都会存一个时间，在读取的时候要和设置的时间做 TTL 比较来判断是否过期</td>
</tr>
<tr>
<td>单机 QPS</td>
<td>约 10W</td>
<td>约 60W</td>
</tr>
<tr>
<td>源代码可读性</td>
<td>代码清爽简洁</td>
<td>可能是考虑了太多的扩展性，多系统的兼容性，代码不清爽</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>复杂数据结构、有持久化、高可用需求、value 存储内容较大</td>
<td>纯 KV，数据量非常大，并发量非常大的业务</td>
</tr>
</tbody></table>
<h2 id="Memcached-集群"><a href="#Memcached-集群" class="headerlink" title="Memcached 集群"></a>Memcached 集群</h2><p>Memcached 集群，称为基于客户端的分布式集群，即由客户端实现集群功能，即 Memcached 本身不支持集群</p>
<p>Memcached 集群内部并不互相通信，一切都需要客户端连接到 Memcached 服务器后自行组织这些节点，并决定数据存储的节点</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612167601397.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%9D%83%E9%99%90/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%9D%83%E9%99%90/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">权限管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 16:33:40" itemprop="dateCreated datePublished" datetime="2021-02-04T16:33:40+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%9D%83%E9%99%90/" itemprop="url" rel="index"><span itemprop="name">权限</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h2><pre class="language-none"><code class="language-none">ugo：属主、属组、其他
rwx：读、写、执行</code></pre>

<p>用户的最终权限从左向右进行顺序匹配，一旦匹配权限立即生效，不再向右继续匹配</p>
<p>注意：权限设置对 root 用户无效</p>
<p>目录和文件的 x 权限：</p>
<ul>
<li>文件 x：把文件提请内核，启动一个进程，文件必的内容必须是可执行</li>
<li>目录 x：目录可访问的最小权限，对文件进行读写操作的时候，文件路径上经过的所有目录，都必须先具有执行权限</li>
</ul>
<p>删除和新建文件，需要有目录的执行（x）和写（w）权限</p>
<h3 id="默认权限"><a href="#默认权限" class="headerlink" title="默认权限"></a>默认权限</h3><p>对于文件来说，大部分文件的内容是不可执行的，所以默认不给执行权限<br>对于目录来说，执行权限是必备的，所以默认给执行权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">20</span>:27:57 root@centos7.mageedu.org  data<span class="token punctuation">]</span><span class="token comment">#mkdir test</span>
<span class="token punctuation">[</span><span class="token number">20</span>:28:04 root@centos7.mageedu.org  data<span class="token punctuation">]</span><span class="token comment">#touch a.log</span>
<span class="token punctuation">[</span><span class="token number">20</span>:28:07 root@centos7.mageedu.org  data<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">0</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">0</span> Aug  <span class="token number">3</span> <span class="token number">20</span>:28 a.log
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">6</span> Aug  <span class="token number">3</span> <span class="token number">20</span>:28 <span class="token builtin class-name">test</span></code></pre>

<h3 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h3><p>修改文件属主、属组</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chown</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>OWNER<span class="token punctuation">]</span><span class="token punctuation">[</span>:<span class="token punctuation">[</span>GROUP<span class="token punctuation">]</span><span class="token punctuation">]</span> FILE<span class="token punctuation">..</span>.
<span class="token function">chown</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token parameter variable">--reference</span><span class="token operator">=</span>RFILE FILE<span class="token punctuation">..</span>.

<span class="token parameter variable">-R</span> 递归修改目录下的所有文件的属主和属组</code></pre>

<h3 id="chgrp"><a href="#chgrp" class="headerlink" title="chgrp"></a>chgrp</h3><p>chgrp 命令只用来修改属组</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chgrp</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. GROUP FILE<span class="token punctuation">..</span>.
<span class="token function">chgrp</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token parameter variable">--reference</span><span class="token operator">=</span>RFILE FILE<span class="token punctuation">..</span>	<span class="token comment"># 参考--reference指定的文件的属组</span>

<span class="token parameter variable">-R</span> 递归</code></pre>

<h3 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h3><p>修改文件权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. MODE<span class="token punctuation">[</span>,MODE<span class="token punctuation">]</span><span class="token punctuation">..</span>. FILE<span class="token punctuation">..</span>.
<span class="token function">chmod</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. OCTAL-MODE FILE<span class="token punctuation">..</span>.
<span class="token function">chmod</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token parameter variable">--reference</span><span class="token operator">=</span>RFILE FILE<span class="token punctuation">..</span>.		<span class="token comment"># 参考--reference指定的文件的权限</span>

<span class="token comment"># MODE: who opt permission</span>
<span class="token comment">#       who: u g o a</span>
<span class="token comment">#           opt: + - =</span>
<span class="token comment">#               permission: r w x X</span>

X：只针对目录，配合-R使用只递归修改目录的权限</code></pre>

<h3 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h3><p>umask 通过 <strong>间接</strong> 的方式设定文件创建时的缺省模式</p>
<ul>
<li>对于文件来说，默认权限上限是 666(不给执行权限)，666 减去 umask 值就是文件创建时的默认权限</li>
<li>对于目录来说，默认权限上限是 777(不做任何限制)，777 减去 umask 值，就是目录创建时的默认权限</li>
</ul>
<p>注意：出于安全方面的考虑，普通文件的执行权限不能通过权限掩码来设置，必须手工修改（使用 chmod 命令）</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">umask</span> <span class="token punctuation">[</span>-p<span class="token punctuation">]</span> <span class="token punctuation">[</span>-S<span class="token punctuation">]</span> <span class="token punctuation">[</span>mode<span class="token punctuation">]</span>

<span class="token comment"># 示例</span>
<span class="token variable">$umask</span> 			<span class="token comment"># 查看当前umask</span>
0022
<span class="token variable">$umask</span> <span class="token parameter variable">-S</span> 		<span class="token comment"># 格式化打印当前umask</span>
<span class="token assign-left variable">u</span><span class="token operator">=</span>rwx,g<span class="token operator">=</span>rx,o<span class="token operator">=</span>rx
<span class="token variable">$umask</span> <span class="token parameter variable">-p</span>		<span class="token comment"># 输出可被调用，就是说输出一个可执行的命令</span>
<span class="token builtin class-name">umask</span> 0022
<span class="token variable">$echo</span> <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">umask</span> <span class="token parameter variable">-p</span><span class="token variable">`</span></span> <span class="token operator">>></span> ~/.bashrc 	<span class="token comment"># 设置 umask 的值，永久生效</span>

<span class="token builtin class-name">umask</span> 002 		<span class="token comment"># 设置umask，这样创建文件默认的权限就是644，创建目录默认的权限就是755</span>
<span class="token builtin class-name">umask</span> <span class="token assign-left variable">u</span><span class="token operator">=</span>rw,g<span class="token operator">=</span>r,o<span class="token operator">=</span></code></pre>

<p>一般不会修改默认的权限，如果修改也是临时的</p>
<h2 id="特殊权限"><a href="#特殊权限" class="headerlink" title="特殊权限"></a>特殊权限</h2><p>r w x 是普通权限，还有三种特殊权限：suid、sgid、sticky</p>
<p>前提：进程有属主和属组；文件有属主和属组</p>
<ul>
<li>任何一个可执行程序文件能不能启动为进程，取决发起者对程序文件是否拥有执行权限</li>
<li>启动为进程之后，其进程的属主为发起者，进程的属组为发起者所属的组</li>
<li>进程访问文件时的权限，取决于进程的发起者</li>
</ul>
<h3 id="suid"><a href="#suid" class="headerlink" title="suid"></a>suid</h3><p>执行二进制文件，会启动进程，默认进程的属主是当前用户的属主，属组是当前用户的主组，如果执行设置 suid 的二进制文件，进程的属主会是此文件的属主</p>
<p>如果二进制可执行文件的属主是 root，那么设置了 suid 后，其他所有用户都可以运行此文件，并且是以 root 用户的身份运行</p>
<p>注意：</p>
<ul>
<li>suid 只对二进制可执行程序（shell 脚本不是二进制可执行程序）有效</li>
<li>suid 设置在目录上毫无意义</li>
</ul>
<p>设置 suid 权限：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> u+s file<span class="token punctuation">..</span>.
<span class="token function">chmod</span> u-s file<span class="token punctuation">..</span>.
<span class="token function">chmod</span> 4xxx file<span class="token punctuation">..</span>.

-rwsr-xr-x. <span class="token number">1</span> root root <span class="token number">34928</span> May <span class="token number">11</span> <span class="token number">2019</span> /usr/bin/passwd</code></pre>

<p><strong>应用场景：</strong></p>
<ol>
<li>某些服务必须以 root 用户运行，可是每次启动都要运维 sudo 很不方便，此时就给可执行程序设置 suid</li>
<li>某些服务必须以 nologin 用户（例如 www）运行，也可以设置 suid</li>
</ol>
<h3 id="sgid"><a href="#sgid" class="headerlink" title="sgid"></a>sgid</h3><p>sgid 和 suid 类似，后者进程继承文件的属主，前者进程继承文件的属组</p>
<p>执行二进制文件，会启动进程，默认进程的属主是当前用户的属主，属组是当前用户的主组，如果执行设置 sgid 的二进制文件，进程的属组会是此文件的属组</p>
<p>suid 作用在目录上无意义，但是 sgid 作用在目录上有意义：</p>
<p>默认情况下，新建文件的属组为用户的主组，如果目录设置了 sgid，则在此目录下新建文件，文件的属组为此目录的属组，可以用于创建协作目录</p>
<p>设置 sgid 权限：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> g+s file<span class="token punctuation">..</span>.
<span class="token function">chmod</span> g-s file<span class="token punctuation">..</span>.
<span class="token function">chmod</span> 2xxx file<span class="token punctuation">..</span>.</code></pre>

<h3 id="sticky"><a href="#sticky" class="headerlink" title="sticky"></a>sticky</h3><p>具有写权限的目录，用户通常可以删除该目录下的任何文件，和文件的权限无关。当目录设置了 sticky 权限，只有文件的所有者和 root 可以删除该文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> o+t DIR<span class="token punctuation">..</span>.
<span class="token function">chmod</span> o-t DIR<span class="token punctuation">..</span>.
<span class="token function">chmod</span> 1xxx DIR<span class="token punctuation">..</span>.

drwxrwxrwt. <span class="token number">15</span> root root <span class="token number">4096</span> Dec <span class="token number">12</span> <span class="token number">20</span>:16 /tmp</code></pre>

<h3 id="chattr"><a href="#chattr" class="headerlink" title="chattr"></a>chattr</h3><p>设置文件的特殊属性，可以防止 root 用户删除或修改文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">chattr +i files<span class="token punctuation">..</span>.   <span class="token comment"># 不能删除、改名、更改</span>
chattr +a files<span class="token punctuation">..</span>.   <span class="token comment"># 只能追加内容，不能删除、改名</span>
lsattr               <span class="token comment"># 显示特殊属性</span></code></pre>

<h3 id="权限的数字表示"><a href="#权限的数字表示" class="headerlink" title="权限的数字表示"></a>权限的数字表示</h3><p>rwx 前面还有一个特殊权限位，rwx 对应的数字 421，特殊权限位取值 0-7，默认 0 可省略</p>
<p>0-7，8 种情况能够表示 suid、sgid、sticky 这三个特殊权限：</p>
<pre class="language-none"><code class="language-none">suid sgid sticky
 0    0    0                  0
 0    0    1                  1
 0    1    0                  2
 0    1    1                  3
 1    0    0                  4
 1    0    1                  5
 1    1    0                  6
 1    1    1                  7</code></pre>

<h3 id="权限位映射"><a href="#权限位映射" class="headerlink" title="权限位映射"></a>权限位映射</h3><p>设置 suid，u 的 x 变成 s，如果 u 本来没有 x，则 x 位置上的 - 变成 S<br>设置 sgid，g 的 x 变成 s，如果 g 本来没有 x，则 x 位置上的 - 变成 S<br>设置 sticky，o 位的 x 变成 t，如果 o 本来没有 x，则 x 位置上的 - 变成 T</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 注意t和T</span>
lujinkai@Z510:~/data/test$ <span class="token function">chmod</span> <span class="token number">1755</span> ./grep/
lujinkai@Z510:~/data/test$ ll <span class="token parameter variable">-d</span> grep/
drwxr-xr-t <span class="token number">2</span> lujinkai lujinkai <span class="token number">4096</span> Aug <span class="token number">13</span> <span class="token number">17</span>:27 grep//
lujinkai@Z510:~/data/test$ <span class="token function">chmod</span> o-x grep/
lujinkai@Z510:~/data/test$ ll <span class="token parameter variable">-d</span> grep/
drwxr-xr-T <span class="token number">2</span> lujinkai lujinkai <span class="token number">4096</span> Aug <span class="token number">13</span> <span class="token number">17</span>:27 grep//</code></pre>

<h2 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h2><p>Access Control List，访问控制列表，实现灵活的权限管理</p>
<p>除了 u g o，可以对更多的用户设置权限</p>
<p>CentOS6 可能不支持，需要手动增加 ACL 功能</p>
<h3 id="ACL-生效顺序"><a href="#ACL-生效顺序" class="headerlink" title="ACL 生效顺序"></a>ACL 生效顺序</h3><pre class="language-none"><code class="language-none">owner(u) &gt; acl user &gt; group(g) &gt; other(o)</code></pre>

<h3 id="ACL-相关命令"><a href="#ACL-相关命令" class="headerlink" title="ACL 相关命令"></a>ACL 相关命令</h3><h4 id="setfacl"><a href="#setfacl" class="headerlink" title="setfacl"></a>setfacl</h4><p>为用户或群组添加针对某目录或文件的 ACL 权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">setfacl <span class="token punctuation">[</span>-bkndRLPvh<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>-m<span class="token operator">|</span>-x<span class="token punctuation">&#125;</span> acl_spec<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>-M<span class="token operator">|</span>-X<span class="token punctuation">&#125;</span> acl_file<span class="token punctuation">]</span> <span class="token function">file</span> <span class="token punctuation">..</span>.
setfacl <span class="token parameter variable">--restore</span><span class="token operator">=</span>file</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">- <span class="token parameter variable">-m</span> --modify-acl 更改文件的访问控制列表
- <span class="token parameter variable">-x</span> --remove-acl
- <span class="token parameter variable">-b</span> --remove-all
- <span class="token parameter variable">--set</span> 选项会把原有的ACL项都删除，用新的替代，需要注意的是一定要包含u g o设置，不能像-m一样只是添加ACL就可以</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">setfacl <span class="token parameter variable">--set</span> u::rw,u:wang:rw,g::r,o::- file1
<span class="token comment"># 设置u的权限为rw、设置用户wang的权限是rw、设置g的权限是r，清空o的所有权限</span></code></pre>

<h4 id="getfacl"><a href="#getfacl" class="headerlink" title="getfacl"></a>getfacl</h4><p>查看设置 ACL 权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置test对a.log文件没有任何权限 可以用 - 或 0 或 000 表示</span>
<span class="token punctuation">[</span>08:57:42 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#setfacl -m u:test:- a.log</span>
<span class="token comment"># 查看对a.log文件设置的ACl权限</span>
<span class="token punctuation">[</span>08:58:30 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#getfacl a.log</span>
<span class="token comment"># 设置apps群组对a.log文件只有写权限</span>
<span class="token punctuation">[</span>08:58:33 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#setfacl -m g:apps:w a.log</span>
<span class="token punctuation">[</span>08:59:06 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#getfacl a.log</span>
<span class="token comment"># file: a.log</span>
<span class="token comment"># owner: root</span>
<span class="token comment"># group: root</span>
user::rw-
user:test:---
group::r--
group:apps:-w-
mask::rw-
other::r--
<span class="token comment"># 清除test用户，对a.log文件acl权限</span>
<span class="token punctuation">[</span>08:59:07 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#setfacl -x u:test a.log</span>
<span class="token punctuation">[</span>08:59:32 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#getfacl a.log</span>
<span class="token comment"># file: a.log</span>
<span class="token comment"># owner: root</span>
<span class="token comment"># group: root</span>
user::rw-
group::r--
group:apps:-w-
mask::rw-
other::r--
<span class="token comment"># 清除a.log上的所有acl权限</span>
<span class="token punctuation">[</span>08:59:33 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#setfacl -b a.log</span>
<span class="token punctuation">[</span>08:59:55 root@centos7.mageedu.org  test<span class="token punctuation">]</span><span class="token comment">#getfacl a.log</span>
<span class="token comment"># file: a.log</span>
<span class="token comment"># owner: root</span>
<span class="token comment"># group: root</span>
user::rw-
group::r--
other::r--</code></pre>

<h3 id="mask"><a href="#mask" class="headerlink" title="mask"></a>mask</h3><p>mask 设置除 u 和 o 之外的用户和组的最大权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>09:28:44 root@centos7  test<span class="token punctuation">]</span><span class="token comment">#getfacl -m mask::r a.log</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1596504792558.png"></p>
<p>设置 mask 之后，如果再使用 setfacl 或者 chmod 更改文件的权限，mask 的值会自动调整</p>
<h3 id="备份和还原-ACL"><a href="#备份和还原-ACL" class="headerlink" title="备份和还原 ACL"></a>备份和还原 ACL</h3><p>主要的文件操作命令 cp 和 mv 都支持 ACL，cp 命令需要加上 -p 参数。但是 tar 等常见的备份工具不会保留目录和文件的 ACL 信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份 先导出acl权限信息，然后再压缩备份</span>
get <span class="token parameter variable">-R</span> /tmp/dir <span class="token operator">></span> acl.txt
<span class="token comment"># 恢复 先解压文件，然后导入acl权限信息</span>
setfacl <span class="token parameter variable">-R</span> --set-file<span class="token operator">=</span>acl.txt /tmp/dir</code></pre>

<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><ol>
<li><p>执行 cp &#x2F;etc&#x2F;issue &#x2F;data&#x2F;dir 所需要的最小权限？</p>
<pre class="language-none"><code class="language-none">&#x2F;bin&#x2F;cp		x
&#x2F;etc&#x2F; 		x
&#x2F;etc&#x2F;issue  r
&#x2F;data&#x2F;      x
&#x2F;data&#x2F;dir&#x2F;	w、x</code></pre>
</li>
<li><p>当用户 docker 对&#x2F;testdir 目录无执行权限时，意味着无法做哪些操作？</p>
<pre class="language-none"><code class="language-none">无法ls查看目录下的文件列表; 无法cd到目录; 无法对目录下的文件进行读写操作; 也无法在目录下新建文件，删除目录下的文件</code></pre>
</li>
<li><p>当用户 mongodb 对&#x2F;testdir 目录无读权限时，意味着无法做哪些操作？</p>
<pre class="language-none"><code class="language-none">无法ls查看目录下的文件列表</code></pre>
</li>
<li><p>当用户 redis 对&#x2F;testdir 目录无写权限时，该目录下的只读文件 file1 是否可修改和删除？</p>
<pre class="language-none"><code class="language-none">不可以</code></pre>
</li>
<li><p>当用户 zabbix 对&#x2F;testdir 目录有写和执行权限时，该目录下的只读文件 file1 是否可修改和删除？</p>
<pre class="language-none"><code class="language-none">不可以修改，可以删除</code></pre>
</li>
<li><p>复制&#x2F;etc&#x2F;fstab 文件到&#x2F;var&#x2F;tmp 下，设置文件所有者为 tomcat 读写权限，所属组为 apps 组有读写权限，其他人无权限</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">21</span>:01:39 root@centos7.mageedu.org  data<span class="token punctuation">]</span><span class="token comment">#useradd -s /sbin/nologin -M tomcat</span>
<span class="token punctuation">[</span><span class="token number">21</span>:01:53 root@centos7.mageedu.org  data<span class="token punctuation">]</span><span class="token comment">#groupadd apps</span>
<span class="token punctuation">[</span><span class="token number">21</span>:03:36 root@centos7.mageedu.org  tmp<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">4</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">595</span> Aug  <span class="token number">3</span> <span class="token number">21</span>:03 fstab
<span class="token punctuation">[</span><span class="token number">21</span>:03:37 root@centos7.mageedu.org  tmp<span class="token punctuation">]</span><span class="token comment">#chown tomact:apps ./fsta</span>
<span class="token punctuation">[</span><span class="token number">21</span>:04:05 root@centos7.mageedu.org  tmp<span class="token punctuation">]</span><span class="token comment">#chown tomcat:apps ./fstab</span>
<span class="token punctuation">[</span><span class="token number">21</span>:04:16 root@centos7.mageedu.org  tmp<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">4</span>
-rw-r--r-- <span class="token number">1</span> tomcat apps <span class="token number">595</span> Aug  <span class="token number">3</span> <span class="token number">21</span>:03 fstab
<span class="token punctuation">[</span><span class="token number">21</span>:08:20 root@centos7.mageedu.org  tmp<span class="token punctuation">]</span><span class="token comment">#chmod 660 fstab</span>
<span class="token punctuation">[</span><span class="token number">21</span>:08:50 root@centos7.mageedu.org  tmp<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">4</span>
-rw-rw---- <span class="token number">1</span> tomcat apps <span class="token number">595</span> Aug  <span class="token number">3</span> <span class="token number">21</span>:03 fstab</code></pre>
</li>
<li><p>误删除了用户 git 的家目录，请重建并恢复该用户家目录及相应的权限属性</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /home/git
<span class="token comment"># 不要拷贝/etc/skel/.*因为.*包括..会把/etc目录内容也拷贝过去，就不对了，复制隐藏和非隐藏文件</span>
<span class="token comment"># . 代表当前目录</span>
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /etc/skel/. /etc/skel/* /home/git
<span class="token function">chmod</span> <span class="token number">700</span> /home/git
<span class="token function">chown</span> <span class="token parameter variable">-R</span> git:git /home/git</code></pre>
</li>
<li><p>在 &#x2F;testdir&#x2F;dir 里创建的新文件自动属于 webs 组，组 apps 的成员如：test 能对这些新文件有读写权限，组 dbs 的成员如：mysql 只能对新文件有读权限，其它用户（不属于 webs、apps、dbs）不能访问这个文件夹</p>
<pre class="language-none"><code class="language-none">1.将apps、dbs中的成员加入到webs组中
2.注意setfacl设置apps和dbs的ACL时给x权限</code></pre>
</li>
<li><p>误将 &#x2F;bin&#x2F;chmod 文件的执行权限删除，如何恢复？</p>
<p>方法一：从别的机器上拷贝一个过来<br>方法二：用系统中已有的各种脚本语言解释器修改权限<br>方法三：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">14</span>:24:31 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#chmod -x /usr/bin/chmod</span>
<span class="token punctuation">[</span><span class="token number">14</span>:24:41 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#ll /usr/bin/chmod</span>
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">58592</span> Aug <span class="token number">20</span>  <span class="token number">2019</span> /usr/bin/chmod
<span class="token punctuation">[</span><span class="token number">14</span>:24:48 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#setfacl -m u:root:rwx /usr/bin/chmod</span>
<span class="token punctuation">[</span><span class="token number">14</span>:25:18 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#getfacl /usr/bin/chmod</span>
getfacl: Removing leading <span class="token string">'/'</span> from absolute path names
<span class="token comment"># file: usr/bin/chmod</span>
<span class="token comment"># owner: root</span>
<span class="token comment"># group: root</span>
user::rw-
user:root:rwx
group::r--
mask::rwx
other::r--

<span class="token punctuation">[</span><span class="token number">14</span>:25:30 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#chmod +x /usr/bin/chmod</span>
<span class="token punctuation">[</span><span class="token number">14</span>:25:43 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#ll /usr/bin/chmod</span>
-rwxrwxr-x+ <span class="token number">1</span> root root <span class="token number">58592</span> Aug <span class="token number">20</span>  <span class="token number">2019</span> /usr/bin/chmod
<span class="token punctuation">[</span><span class="token number">14</span>:25:48 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#setfacl -b /usr/bin/chmod</span>
<span class="token punctuation">[</span><span class="token number">14</span>:26:03 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#ll /usr/bin/chmod</span>
-rwxr--r-x. <span class="token number">1</span> root root <span class="token number">58592</span> Aug <span class="token number">20</span>  <span class="token number">2019</span> /usr/bin/chmod</code></pre></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6/%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6/%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">文件操作相关命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 16:33:25" itemprop="dateCreated datePublished" datetime="2021-02-04T16:33:25+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">文件</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a>pwd</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 bin<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/bin
<span class="token punctuation">[</span>root@centos7 bin<span class="token punctuation">]</span><span class="token comment"># pwd -P		# -P 显示真实的物理路径</span>
/usr/bin</code></pre>

<h2 id="basename-和-dirname"><a href="#basename-和-dirname" class="headerlink" title="basename 和 dirname"></a>basename 和 dirname</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 vhost<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/usr/local/nginx/conf/vhost
<span class="token punctuation">[</span>root@4710419222 vhost<span class="token punctuation">]</span><span class="token comment"># basename `pwd` 	# 显示文件名</span>
vhost
<span class="token punctuation">[</span>root@4710419222 vhost<span class="token punctuation">]</span><span class="token comment"># basename `pwd`\/to2b.cn.conf	# 显示路径</span>
to2b.cn.conf
<span class="token punctuation">[</span>root@4710419222 vhost<span class="token punctuation">]</span><span class="token comment"># dirname $(pwd)</span>
/usr/local/nginx/conf</code></pre>

<h2 id="cd"><a href="#cd" class="headerlink" title="cd"></a>cd</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># cd -P /bin/	# -P 切换至物理路径, 而非软链接目录</span>
<span class="token punctuation">[</span>root@4710419222 bin<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/usr/bin</code></pre>

<p>切换到来时的目录：<code>cd -</code></p>
<h2 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@47105171233 ~<span class="token punctuation">]</span><span class="token comment"># ll -A		# 显示隐藏文件,但是不显示.和..</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># ll -t		# 按照mtime从新到旧排序</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># ll -tr		# 按照mtime从旧到新排序</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># ll -ut /	# 按照atime从新到旧排序</span>
<span class="token punctuation">[</span>root@4710419222 /<span class="token punctuation">]</span><span class="token comment"># ll -S		# 按照从大到小排序</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># ll -R		# 递归遍历目录下所有文件</span></code></pre>

<p>说明: ls 查看不同后缀文件时的颜色由 &#x2F;etc&#x2F;DIR_COLORS 和 @LS_COLORS 变量定义</p>
<h2 id="stat"><a href="#stat" class="headerlink" title="stat"></a>stat</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># stat test.php</span>
  File: ‘test.php’
  Size: <span class="token number">96</span>              Blocks: <span class="token number">8</span>          IO Block: <span class="token number">4096</span>   regular <span class="token function">file</span>
Device: fd01h/64769d    Inode: <span class="token number">138598</span>      Links: <span class="token number">1</span>
Access: <span class="token punctuation">(</span>0644/-rw-r--r--<span class="token punctuation">)</span>  Uid: <span class="token punctuation">(</span>    <span class="token number">0</span>/    root<span class="token punctuation">)</span>   Gid: <span class="token punctuation">(</span>    <span class="token number">0</span>/    root<span class="token punctuation">)</span>
Access: <span class="token number">2020</span>-07-26 <span class="token number">18</span>:48:51.780437746 +0800		<span class="token comment"># 文件最近一次被访问的时间</span>
Modify: <span class="token number">2020</span>-07-25 <span class="token number">17</span>:21:15.970280822 +0800		<span class="token comment"># 文件内容最近一次被修改的时间</span>
Change: <span class="token number">2020</span>-07-25 <span class="token number">17</span>:21:15.973280860 +0800		<span class="token comment"># 文件属性最近一次被修改的时间</span>
 Birth: -</code></pre>

<h2 id="file"><a href="#file" class="headerlink" title="file"></a>file</h2><p>判断文件的类型不能依靠后缀，可以使用 file 命令判断文件的类型</p>
<h2 id="hexdump"><a href="#hexdump" class="headerlink" title="hexdump"></a>hexdump</h2><p>一般用来查看“二进制”文件的十六进制编码，但实际上它能查看任何文件，而不只限于二进制文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># hexdump -C test.txt	# -C 输出规范的十六进制和ASCII码</span>
00000000  0a                                                <span class="token operator">|</span><span class="token builtin class-name">.</span><span class="token operator">|</span>
00000001</code></pre>

<h2 id="文件通配符-glob"><a href="#文件通配符-glob" class="headerlink" title="文件通配符 glob"></a>文件通配符 glob</h2><p>文件通配符可以用来匹配符合条件的多个文件，方便批量管理文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"> <span class="token comment"># * 匹配零个或多个字符, 但不匹配隐藏文件</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token comment"># ll -a *</span>
-rw-r--r-- <span class="token number">1</span> root root        <span class="token number">863</span> Oct <span class="token number">17</span>  <span class="token number">2019</span> clear_history.php
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">244205697</span> Oct <span class="token number">24</span>  <span class="token number">2018</span> oneinstack-full.tar.gz
lrwxrwxrwx <span class="token number">1</span> root root         <span class="token number">27</span> Jul <span class="token number">18</span>  <span class="token number">2019</span> python-learn -<span class="token operator">></span> /data/wwwroot/python-learn/
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1073741824</span> Oct <span class="token number">31</span>  <span class="token number">2018</span> swapfile
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">11195</span> Sep <span class="token number">27</span>  <span class="token number">2019</span> testparm-v.txt
 <span class="token comment"># ? 匹配任何单个字符</span>
 <span class="token comment"># [0-9]</span>
 <span class="token comment"># [a-z] a、A、b、B...x、X、y、Y、z、Z</span>
 <span class="token comment"># [lujinkai]</span>
 <span class="token comment"># [^lujinkai]</span></code></pre>

<p>此外, 还有预定义的字符类: <code>man 7 glob</code></p>
<pre class="language-none"><code class="language-none">[:digit:]：任意数字，相当于0-9
[:lower:]：任意小写字母,表示 a-z
[:upper:]: 任意大写字母,表示 A-Z
[:alpha:]: 任意大小写字母
[:alnum:]：任意数字或字母
[:blank:]：水平空白字符
[:space:]：水平或垂直空白字符
[:punct:]：标点符号
[:print:]：可打印字符
[:cntrl:]：控制（非打印）字符
[:graph:]：图形字符
[:xdigit:]：十六进制字符</code></pre>

<p><strong>文件通配符（glob）和正则表达式（regex）：</strong></p>
<ul>
<li>文件通配符就是<code>* ? []</code> 这三个，正则表达式则功能强大</li>
<li>**对于<code>*</code> **文件通配符中<code>*</code>匹配 0 个或多个字符，可以单独使用。而在正则表达式中<code>*</code>是匹配前面的 0 次或多次，前面必须由内容，不能单独使用</li>
<li><strong>对于<code>?</code></strong> 和<code>*</code>一样，文件通配符中，<code>?</code>可以单独使用，正则表达式中不可以</li>
<li>**对于<code>[]</code> **文件通配符<code>[]</code>中的内容是按照 ASCII 统计的，例如<code>[a-z]</code>会匹配 a、A、b、B…y、Y、z，而正则表达式<code>[]</code>中的内容是按照人类的方式统计，例如<code>[a-z]</code>会匹配 a、b、c、d、e…x、y、z</li>
<li><strong>对于<code>.</code></strong> 文件通配符中<code>.</code>就是<code>.</code>，没有别的意思，正则表达式中<code>.</code>匹配单个字符</li>
</ul>
<h2 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h2><p>创建空文件和 <strong>刷新文件时间</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -a 仅改变 atime和ctime</span>
<span class="token comment"># -m 仅改变 mtime和ctime</span>
<span class="token comment"># -t [[CC]YY]MMDDhhmm[.ss] 指定atime和mtime的时间戳</span>
<span class="token comment"># -c 如果文件不存在，则不予创建</span></code></pre>

<h2 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-a</span>                <span class="token comment"># 归档，相当于-dR --preserv=all，常用于备份功能</span>
<span class="token parameter variable">-u</span> <span class="token parameter variable">--update</span>       <span class="token comment"># 只复制源比目标先更新文件或目标不存在的文件</span>
<span class="token parameter variable">-b</span>                <span class="token comment"># 目标存在, 覆盖前先备份, 默认形式为`filename~`, 只保留最近一个备份</span>
<span class="token parameter variable">--backup</span><span class="token operator">=</span>numbered <span class="token comment"># 目标存在, 覆盖前先备份加数字后缀, 形式为`filename.~#~`, 可以保留多个版本</span></code></pre>

<p>注意：不同类型的文件不能覆盖，例如普通文件可以覆盖普通文件，但是不能覆盖目录</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># ll</span>
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">12288</span> Jul <span class="token number">29</span> <span class="token number">15</span>:32 <span class="token builtin class-name">test</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># \cp -a --backup=numbered /test ./xxx</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># \cp -a --backup=numbered /test ./xxx</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># \cp -a --backup=numbered /test ./xxx</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># ll</span>
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">12288</span> Jul <span class="token number">29</span> <span class="token number">15</span>:32 <span class="token builtin class-name">test</span>
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">11</span> Jul <span class="token number">29</span> <span class="token number">15</span>:30 xxx
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">11</span> Jul <span class="token number">29</span> <span class="token number">15</span>:30 xxx.~1~
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">11</span> Jul <span class="token number">29</span> <span class="token number">15</span>:30 xxx.~2~</code></pre>

<h2 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h2><p>移动和重命名文件，同一分区移动会很快</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>-T<span class="token punctuation">]</span> SOURCE DEST       <span class="token comment"># 移动并重命名</span>
<span class="token function">mv</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. SOURCE<span class="token punctuation">..</span>. DIRECTORY    <span class="token comment"># 移动到目录</span>
<span class="token function">mv</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token parameter variable">-t</span> DIRECTORY SOURCE<span class="token punctuation">..</span>. <span class="token comment"># 目的目录参数在前, 要移动的文件参数在后</span>

<span class="token parameter variable">-b</span>  <span class="token comment"># 目标存在, 覆盖前先备份</span></code></pre>

<p><code>mv</code> 和 <code>rename</code>：<br><code>mv</code> 一次只能重命名一个文件，<code>rename</code> 可以批量重命名文件</p>
<h2 id="rename"><a href="#rename" class="headerlink" title="rename"></a>rename</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">rename</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>expression<span class="token operator">></span> <span class="token operator">&lt;</span>replacement<span class="token operator">></span> <span class="token operator">&lt;</span>file<span class="token operator">></span><span class="token punctuation">..</span>.

<span class="token comment"># 示例</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">4</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">18</span> Jul <span class="token number">29</span> <span class="token number">19</span>:36 a.txt
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">0</span> Jul <span class="token number">29</span> <span class="token number">19</span>:14 b.txt
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># rename '.txt' '.log' ./*	# 修改后缀</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">4</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">18</span> Jul <span class="token number">29</span> <span class="token number">19</span>:36 a.log
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">0</span> Jul <span class="token number">29</span> <span class="token number">19</span>:14 b.log</code></pre>

<p>这个命令好像可以使用正则，但是我试了一下，不行，可能是版本的问题</p>
<h2 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h2><img data-src="//img.to2b.cn/blog/ljk/1596026223412.png" style="zoom: 80%;" />

<p>此命令非常危险, 建议使用 mv 替代 rm</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">rm</span><span class="token operator">=</span><span class="token string">'DIR=/data/backup`date +%F%T`;mkdir $DIR;mv -t $DIR'</span></code></pre>

<p>rm 虽然删除了文件，但是在安全场景要求较高的情况下，可以使用 shred 命令安全删除文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#shred -zvun 5 passwords.txt</span>
<span class="token comment"># -z 最后一次覆盖添加0，以隐藏覆盖操作</span>
<span class="token comment"># -v 能够显示操作进度</span>
<span class="token comment"># -u 覆盖后截断并删除文件</span>
<span class="token comment"># -n 指定覆盖文件内容的次数（默认值是3次）</span></code></pre>

<h2 id="tree"><a href="#tree" class="headerlink" title="tree"></a>tree</h2><p>显示目录树</p>
<h2 id="df"><a href="#df" class="headerlink" title="df"></a>df</h2><p>查看文件系统，显示磁盘占用情况和 inode 使用情况</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">df</span> <span class="token punctuation">[</span>选项列表<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>文件列表<span class="token punctuation">]</span><span class="token punctuation">..</span>.</code></pre>

<ul>
<li>-a –all</li>
<li>-h –human-readable</li>
<li>-i –inodes 显示 inode 信息而非块使用量</li>
</ul>
<p>关于 df 和 lsblk：</p>
<pre class="language-none"><code class="language-none">lsblk 查看的是block device,也就是逻辑磁盘大小。df查看的是file system, 也就是文件系统层的磁盘大小</code></pre>

<h2 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h2><pre class="language-none"><code class="language-none">-p 目录如果不存在，创建，如果存在，不报错
-m 创建目录时直接指定权限</code></pre>

<h2 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a>rmdir</h2><pre class="language-none"><code class="language-none">-p 递归删除父空目录</code></pre>

<p>挂载点不能删除</p>
<h2 id="tee"><a href="#tee" class="headerlink" title="tee"></a>tee</h2><p>从标准输入读入并写往标准输出和文件，把标准输入的数据复制到文件列表中的每一个文件，同时送往标准输出</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">tee</span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>文件列表<span class="token punctuation">]</span><span class="token punctuation">..</span>.

<span class="token parameter variable">-a</span> <span class="token parameter variable">--append</span>    <span class="token comment"># 追加到给出的文件。功能：保存不同阶段的输出；复杂管道的故障排除；同时查看和记录输出</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#cat &lt;&lt;EOF | tee /etc/motd</span>
<span class="token operator">></span> welcome to magedu
<span class="token operator">></span> happy new year
<span class="token operator">></span> EOF
welcome to magedu
happy new year</code></pre>

<h2 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h2><p>linux 下万物皆文件，网络也是文件，lsof 的作用是列出打开的文件</p>
<p>lsof 的参数巨多，下面列举常用的参数：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">lsof</span> <span class="token function">file</span>        <span class="token comment"># 查看文件被哪些进程占用</span>
<span class="token function">lsof</span> <span class="token parameter variable">-i</span>          <span class="token comment"># 列出所有的网络连接</span>
<span class="token function">lsof</span> <span class="token parameter variable">-i:port</span>     <span class="token comment"># 列出指定端口</span>
<span class="token function">lsof</span> <span class="token parameter variable">-i</span> tcp      <span class="token comment"># 列出所有的tcp网络连接</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token variable">$lsof</span> <span class="token parameter variable">-i:10252</span>
COMMAND   PID <span class="token environment constant">USER</span>   FD   TYPE DEVICE SIZE/OFF NODE NAME
kube-cont <span class="token number">883</span> root    7u  IPv4  <span class="token number">32376</span>      0t0  TCP localhost:10252 <span class="token punctuation">(</span>LISTEN<span class="token punctuation">)</span></code></pre>

<h2 id="seq"><a href="#seq" class="headerlink" title="seq"></a>seq</h2><p><a target="_blank" rel="noopener" href="https://www.zsythink.net/archives/128/">https://www.zsythink.net/archives/128/</a></p>
<p>输出连续的数字，或者固定间隔的数字，或者指定格式的数字</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># seq 0 9</span>
<span class="token number">0</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">4</span>
<span class="token number">5</span>
<span class="token number">6</span>
<span class="token number">7</span>
<span class="token number">8</span>
<span class="token number">9</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># seq -s ' ' 0 9	# -s 指定输出的分隔符，默认为\n</span>
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># seq -s ' ' 0 2 9</span>
<span class="token number">0</span> <span class="token number">2</span> <span class="token number">4</span> <span class="token number">6</span> <span class="token number">8</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># seq -s + 1 100 | bc</span>
<span class="token number">5050</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># seq -s + 1 2 100 | bc</span>
<span class="token number">2500</span></code></pre>

<h2 id="练习题"><a href="#练习题" class="headerlink" title="练习题"></a>练习题</h2><ol>
<li><p>将&#x2F;etc&#x2F;issue 文件中的内容转换为大写后保存至&#x2F;tmp&#x2F;issue.out 文件中</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 test<span class="token punctuation">]</span><span class="token comment"># cat /etc/issue | tr 'a-z' 'A-Z' > /tmp/issue.out</span></code></pre>
</li>
<li><p>将当前系统登录用户的信息转换为大写后保存至&#x2F;tmp&#x2F;who.out 文件中</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 test<span class="token punctuation">]</span><span class="token comment"># whoami | tr 'a-z' 'A-Z' > /tmp/who.out</span></code></pre>
</li>
<li><p>一个 linux 用户给 root 发邮件，要求邮件标题为”help”，邮件正文如下：</p>
<blockquote>
<p>Hello，I am 用户名，The system version is here，please help me to check it，thanks!<br>操作系统版本信息</p>
</blockquote>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># echo -e "Hello, I am `whoami`,The system version is here,please help me to check it ,thanks! \n`cat /etc/os-release`" | mail -s hello root</span></code></pre>
</li>
<li><p>将&#x2F;root&#x2F;下文件列表，显示成一行，并文件名之间用空格隔开</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 /<span class="token punctuation">]</span><span class="token comment"># ls -A /root | tr '\n' ' '</span></code></pre>
</li>
<li><p>计算 1+2+3+…+99+100 的总和</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token comment"># seq -s + 1 100 | bc</span>
<span class="token number">5050</span></code></pre>
</li>
<li><p>删除 Windows 文本文件中的回车字符 ，即“\r”</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> a.log <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'\r'</span> <span class="token string">' '</span></code></pre>
</li>
<li><p>处理字符串“xt.,l 1 jr#!$mn 2 c*&#x2F;fe 3 uz 4”，只保留其中的数字和空格</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token comment"># echo 'xt.,l 1 jr#!$mn 2 c*/fe 3 uz 4' | tr -dc '0-9 '</span>
 <span class="token number">1</span>  <span class="token number">2</span>  <span class="token number">3</span>  <span class="token number">4</span><span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>
</li>
<li><p>将 PATH 变量每个目录显示在独立的一行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token comment"># echo $PATH | tr ':' '\n'</span></code></pre>
</li>
<li><p>将指定文件中 0-9 分别替代成 a-j</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token comment"># cat a.log | tr '0-9' 'a-j'</span></code></pre>
</li>
<li><p>将文件&#x2F;etc&#x2F;centos-release 中每个单词（由字母组成）显示在独立一行，并无空行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 test<span class="token punctuation">]</span><span class="token comment"># cat /etc/centos-release | tr -c "[:alpha:]" " " | tr -s " " "\n"</span>
CentOS
Linux
release
Core</code></pre>
</li>
<li><p><code>ls</code> 输出的内容明明是分行的, 为什么显示出来就不分行了?</p>
<p>不单<code> ls</code> 会这样，不少其他命令也会这样。它们会使用 isatty 函数查询输出是否指向终端，对输出到终端和非终端的处理，可能不一样</p>
<p>常见的比如：<br>1、输出到终端时，使用 color，非终端则不用；<br>2、输出到终端时，使用 text 方式，非终端则用 binary。</p>
<p>如果需要一致的输出，应当明确使用相关参数</p>
<p>這取決於 stdout 是不是終端。如果是終端就可以讀取終端的寬度，根據寬度排版。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6/%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" class="post-title-link" itemprop="url">文件管理和IO重定向</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 16:33:24" itemprop="dateCreated datePublished" datetime="2021-02-04T16:33:24+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">文件</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="7-种文件类型"><a href="#7-种文件类型" class="headerlink" title="7 种文件类型"></a>7 种文件类型</h2><pre class="language-none"><code class="language-none">-    普通文件
d    目录文件 directory
b    块设备block
c    字符设备 character
l    符号链接文件 link
p    管道文件 pipe
s    套接字文件 socket</code></pre>

<h3 id="普通文件"><a href="#普通文件" class="headerlink" title="普通文件"></a>普通文件</h3><p>普通文件分为三类:</p>
<ol>
<li>纯文本文件 ASCII：使用 <code>cat</code> 可以查看纯文本文件</li>
<li>二进制文件 binary：使用 <code>od</code> 或者 <code>hexdump</code> 命令以 8 进制或者 16 进制查看</li>
<li>数据格式文件 data<br>有些程序运行的过程中会读取某些特定格式的文件，那些特定格式的文件可以被成为数据文件(data file)。举例来说，我们的 Linux 在使用登录的时候，都会将登录的数据记录在 <code>/var/log/wtmp</code> 文件内，该文件就是一个 data file，它可以被 <code>last</code> 和 <code>who</code> 命令读取内容.</li>
</ol>
<h3 id="目录文件"><a href="#目录文件" class="headerlink" title="目录文件"></a>目录文件</h3><h3 id="块设备-和-字符设备"><a href="#块设备-和-字符设备" class="headerlink" title="块设备 和 字符设备"></a>块设备 和 字符设备</h3><p>块设备是硬件设备, 以块（block, 在 EXT4 文件系统中, 一个 block 通常为 4K）为单位, 应用程序通过<strong>随机访问</strong>的形式读取数据<br>最常见的块设备是<strong>硬盘</strong>，还有软盘等。注意这些都是挂载文件系统的设备, 文件系统就像块设备的通用语言.</p>
<p>字符设备文件以字节流的方式进行访问，由字符设备驱动程序来实现这种特性。<strong>字符终端</strong>、<strong>串口</strong>和<strong>键盘</strong>等就是字符设备。可以顺序读取，但通常不支持随机存取。</p>
<blockquote>
<p>区分块设备和字符设备最简单的方法就是看数据访问的方式，能随机访问获取数据的是块设备，必须按字节顺序访问的是字符设备</p>
</blockquote>
<h3 id="符号链接文件"><a href="#符号链接文件" class="headerlink" title="符号链接文件"></a>符号链接文件</h3><p>符号链接文件又叫软连接，软连接相当于一个快捷方式</p>
<h4 id="软（symbolic-或-soft）链接"><a href="#软（symbolic-或-soft）链接" class="headerlink" title="软（symbolic 或 soft）链接"></a>软（symbolic 或 soft）链接</h4><p>文件 A 和文件 B 的 inode 号码虽然不一样，但是文件 A 的内容是文件 B 的路径。读取文件 A 时，系统会自动将访问者导向文件 B。因此，无论打开哪一个文件，最终读取的都是文件 B。这时，文件 A 就称为文件 B 的”软链接”（soft link）或者”符号链接（symbolic link）。</p>
<p>这意味着，文件 A 依赖于文件 B 而存在，如果删除了文件 B，打开文件 A 就会报错：”No such file or directory”。这是软链接与硬链接最大的不同：文件 A 指向文件 B 的文件名，而不是文件 B 的 inode 号码，文件 B 的 inode”链接数”不会因此发生变化。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ln</span> <span class="token parameter variable">-s</span> filename <span class="token punctuation">[</span>linkname<span class="token punctuation">]</span></code></pre>

<ul>
<li>软链接的内容是它引用文件的路径</li>
<li>可以对目录创建软链接</li>
<li>可以跨分区创建软链接</li>
</ul>
<p>Linux 下使用<code>ln -s</code>设置软连接，Windows 下则是<code>mklink /J</code></p>
<h4 id="硬（hard）链接"><a href="#硬（hard）链接" class="headerlink" title="硬（hard）链接"></a>硬（hard）链接</h4><p>硬链接本质上就给一个文件起一个新的名称，不是符号链接，写在这里主要是为了对照软连接</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ln</span> filename <span class="token punctuation">[</span>linkname<span class="token punctuation">]</span></code></pre>

<p>inode 信息中有一项叫做”链接数”，记录指向该 inode 的文件名总数</p>
<ul>
<li>创建硬链接后，和原文件的 inode 还是一样的</li>
<li>新建硬链接, inode 中的”链接数” + 1</li>
<li>rm 删除文件, inode 中的”链接数” - 1，当”链接数”为 0，才是真正删除此文件</li>
<li>不能跨域驱动器或分区创建硬链接</li>
<li>不支持对目录创建硬链接</li>
</ul>
<h3 id="管道文件-（FIFO-文件）"><a href="#管道文件-（FIFO-文件）" class="headerlink" title="管道文件 （FIFO 文件）"></a>管道文件 （FIFO 文件）</h3><p>管道文件主要用于进程间通信</p>
<p>管道都是一端写入，另一端读取，它们是单方向数据传输的，它们的数据都是直接在内存中传输的，管道是进程间通信的一种方式，例如父进程写，子进程读</p>
<p>管道分为 匿名管道 和 命令管道：</p>
<ul>
<li>匿名管道只能在有亲缘关系（父子或者兄弟）的进程之间创建</li>
<li>命名管道可以使用 <code>mkfifo</code> 或者 <code>mknod</code> 命令创建</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkfifo</span> pipe		<span class="token comment"># 创建一个名为pipe的命名管道</span>
<span class="token function">mknod</span> pipe p	<span class="token comment"># 等价与 `mkfifo pipe`</span></code></pre>

<h3 id="套接字文件"><a href="#套接字文件" class="headerlink" title="套接字文件"></a>套接字文件</h3><p>套接字用来实现两端通信，可以实现双向管道的进程间通信功能。不仅如此，套接字还能<strong>通过网络实现跨主机的进程间通信</strong>功能</p>
<p>套接字需要成对才有意义，也就是分为两端，每一端都有用于读、写的文件描述符(或文件句柄)，相当于两根双向通信的管道。</p>
<p>套接字根据协议族的方式分为两大类：<strong>网络套接字</strong>（AF_INET 类型，根据 ipv4 和 ipv6 分为 inet4 和 inet6）和<strong>Unix Domain 套接字</strong>（AF_UNIX 类型）。当然，从协议族往下，套接字可细分为很多种类型，例如 INET 套接字可以分为 TCP 套接字、UDP 套接字、链路层套接字、Raw 套接字等等。其中网络套接字是网络编程的基础和核心。</p>
<p>对于单机的进程间通信，使用 Unix Domain 套接字比 Inet 套接字更好，因为 Unix Domain 套接字没有网络通信组件，也就是少了很多网络功能，它更加轻量级。实际上，某些语言在某些操作系统平台上实现的管道功能就是通过 Unix Domain 来实现的，可想而知其高效率。例如：nginx 和 PHP-FPM 的进程间通信有 TCP 和 UNIX Domain Socket 两种方式，其中 TCP 是 IP 加端口，可以跨服务器；而 UNIX Domain Socket 不经过网络，只能用于 Nginx 跟 PHP-FPM 都在同一服务器的场景，效率更高</p>
<h2 id="文件元数据"><a href="#文件元数据" class="headerlink" title="文件元数据"></a>文件元数据</h2><p>每个文件的属性信息，比如：文件的大小、时间、类型等，称为文件的元数据（meta data）</p>
<p>每个文件都有三个时间，<strong>atime、mtime、ctime</strong>，使用 <strong>stat</strong> 命令可以查看。</p>
<ul>
<li><p><strong>atime</strong>：access time 访问时间</p>
<ul>
<li>当使用 cat 命令查看文件内容时 atime 不改变；</li>
<li>使用 wq 退出 vim 时修改 atime；</li>
<li>使用 q!退出 vim 时不改变 atime；</li>
<li>使用 echo 往文件写内容不改变 atime；</li>
<li>使用 sed -i 修改文件改变 atime；</li>
</ul>
</li>
<li><p><strong>mtime</strong>：modify time 修改时间，当文件内容被修改时，mtime 发生改变</p>
</li>
<li><p><strong>ctime</strong>：change time 变化时间，文件的 inode 被修改时，ctime 发生改变。</p>
<p>注意：只要 mtime 发生改变，ctime 肯定也同步发生改变，如果文件较大，ctime 可能会延迟几毫秒</p>
</li>
</ul>
<h2 id="文件节点表结构"><a href="#文件节点表结构" class="headerlink" title="文件节点表结构"></a>文件节点表结构</h2><p>广义上，一个文件由三部分组成：目录项、索引节点（inode）、数据块</p>
<ul>
<li><strong>目录项</strong>：dirent，包含文件名和索引节点号，索引节点号指向索引节点表（inode table）中对应的索引节点</li>
<li><strong>索引节点</strong>：inode，包含文件的元数据以及数据块指针</li>
<li><strong>数据块</strong>：包含文件的具体内容</li>
</ul>
<h3 id="inode-的大小"><a href="#inode-的大小" class="headerlink" title="inode 的大小"></a>inode 的大小</h3><p>硬盘格式化的时候，操作系统自动将硬盘分为两个区域。一个是数据区，存放文件数据；另一个是 inode 区（inode table），存放 inode。</p>
<p>每个 inode 节点的大小，一般是 128 字节或 256 字节。inode 节点的总数，在格式化时就给定，一般是每 1KB 或每 2KB 就设置一个 inode。假定在一块 1GB 的硬盘中，每个 inode 节点的大小为 128 字节，每 1KB 就设置一个 inode，那么 inode table 的大小就会达到 128MB，占整块硬盘的 12.8%。</p>
<h3 id="inode-结构"><a href="#inode-结构" class="headerlink" title="inode 结构"></a>inode 结构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1596027765027.png"></p>
<p>inode 由上图中的左边区域组成，数据块由右边区域构成。不同的文件大小，通过多层级的间接指针协同完成。</p>
<p>直接块指针：有 12 个，一个块大小为 4KB，所以直接指针可以保存 12 × 4 &#x3D; 48KB 的文件</p>
<p>间接块指针：指向一个块（4KB），每个指针占用 4 个字节，所以这个块可以拆分成 1024 个指针，那么它可以保存数据 1024*4KB&#x3D;4MB</p>
<p><strong>双重间接块指针：同理可得它可以存储的数据为 1024*4MB&#x3D;4GB</strong></p>
<p><strong>三级指针可以储存文件数据大小为 1024*4GB&#x3D;4TB</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1596027789813.png"></p>
<h3 id="一个指针占几个字节？"><a href="#一个指针占几个字节？" class="headerlink" title="一个指针占几个字节？"></a>一个指针占几个字节？</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/IOSSHAN/article/details/88944637">https://blog.csdn.net/IOSSHAN/article/details/88944637</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1596027808825.png"></p>
<p>目录也是文件，打开目录，实际上就是打开目录文件。</p>
<p>目录文件也是由目录项、inode、数据块组成。</p>
<p>目录的数据块中存储的是一系列目录项的列表，是其下的文件的所有目录项。每个目录项，由两部分组成：包含文件名，以及该文件名对应的 inode 号码。</p>
<h3 id="打开文件和-inode"><a href="#打开文件和-inode" class="headerlink" title="打开文件和 inode"></a>打开文件和 inode</h3><p>每个 inode 都有一个号码，操作系统用 inode 号码来识别不同的文件</p>
<p>这里值得重复一遍：Unix&#x2F;Linux 系统内部不使用文件名，而使用 inode 号码来识别文件。对于系统来说，文件名只是 inode 号码便于识别的别称或者绰号</p>
<p>打开一个文件分三步走：</p>
<pre class="language-none"><code class="language-none">1. 名称与inode编号关联，系统找到这个文件名对应的inode号码
2. 通过inode号找到对应的inode，获取inode信息
3. 根据inode信息，找到文件数据所在的block，读出数据</code></pre>

<h3 id="cp-和-inode"><a href="#cp-和-inode" class="headerlink" title="cp 和 inode"></a>cp 和 inode</h3><pre class="language-none"><code class="language-none">1. 分配一个空闲的inode号，在inode table中生成新条目
2. 在目录中创建一个目录项，将名称与inode编号关联
3. 拷贝数据生成 新的文件</code></pre>

<h3 id="rm-和-inode"><a href="#rm-和-inode" class="headerlink" title="rm 和 inode"></a>rm 和 inode</h3><pre class="language-none"><code class="language-none">1. 链接数递减，当减到0，就释放inode号
2. 把数据块放在空闲列表中
3. 删除目录项
4. 数据实际上不会马上被删除，但是当另一个文件使用数据块时将被覆盖</code></pre>

<p>根据 3，可以得出，删除文件实际上是修改目录的内容，所以删除文件必须要有目录的写权限，所以删除文件和文件的权限没有关系，和文件的父目录的权限有关，创建文件同理</p>
<h3 id="mv-和-inode"><a href="#mv-和-inode" class="headerlink" title="mv 和 inode"></a>mv 和 inode</h3><p>如果 mv 命令的目标和源在相同的文件系统</p>
<pre class="language-none"><code class="language-none">1. 创建新的目录项，新名称对应到inode号
2. 删除旧的目录项
3. 修改对应inode上的元数据（时间戳），不移动数据</code></pre>

<p>如果 mv 命令的目标和源在不同的文件系统：mv 相当于 cp + rm</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 删除大文本文件</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#cat /dev/null > /var/log/huge.log</span></code></pre>

<h2 id="IO-重定向和管道"><a href="#IO-重定向和管道" class="headerlink" title="IO 重定向和管道"></a>IO 重定向和管道</h2><p>打开的文件都有一个 <strong>fd</strong>：file descriptor（文件描述符）</p>
<p>Linux 给程序提供了三种 IO 设备：</p>
<pre class="language-none"><code class="language-none">标准输入：STDIN，0，默认接受来自终端窗口的输入
标准输出：STDOUT，1，默认输出到终端窗口
标准错误：STDERR，2，默认输出到终端窗口</code></pre>

<h3 id="2-gt-amp-1"><a href="#2-gt-amp-1" class="headerlink" title="2&gt;&amp;1"></a>2&gt;&amp;1</h3><p>这里的&amp;类似 php 中表示变量引用的用法，放在&gt;后面的&amp;，表示重定向的目标不是一个文件，而是一个文件描述符</p>
<p><code>2&gt;&amp;1</code> 表示标准错误拷贝了标准输出的<strong>行为</strong>，注意是行为，不仅仅是路径。如果标准输出是 &gt; a.log，那么标准错误输出也是 &gt; a.log，如果标准输出是 &gt;&gt; a.log，那么标准错误输出也是 &gt;&gt; a.log</p>
<h3 id="amp-gt-file"><a href="#amp-gt-file" class="headerlink" title="&amp;&gt;file"></a>&amp;&gt;file</h3><p><code>&amp;&gt;file</code> 是一种特殊的用法，也可以写成 <code>&gt;&amp;file</code>，二者的意思完全相同，都等价于<code>1&gt;file 2&gt;&amp;1</code>，此处的<code>&amp;&gt;</code>或者<code>&gt;&amp;</code>视作整体，不能分开</p>
<h3 id="标准输入重定向-单行重定向-lt"><a href="#标准输入重定向-单行重定向-lt" class="headerlink" title="标准输入重定向 单行重定向 &lt;"></a>标准输入重定向 单行重定向 &lt;</h3><p>利用&lt;可以将标准输入重定向</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># cat a.log</span>
a
<span class="token comment"># cat 如果没有指定文件, 或者指定文件为"-", 则从标准输入读取</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># cat > b.log &lt;a.log</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># cat b.log</span>
a
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># echo b > b.log</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># cat &lt; a.log > b.log</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># cat b.log</span>
a</code></pre>

<h3 id="多行重定向-lt-lt-终止词"><a href="#多行重定向-lt-lt-终止词" class="headerlink" title="多行重定向 &lt;&lt;终止词"></a>多行重定向 &lt;&lt;终止词</h3><p>这个很好理解, 类似 php 的长字符串&lt;&lt;&lt;EOT</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># cat > a.log &lt;&lt;EOT</span>
<span class="token operator">></span> <span class="token number">123</span>
<span class="token operator">></span> <span class="token number">456</span>
<span class="token operator">></span> <span class="token number">789</span>
<span class="token operator">></span> EOT
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># cat a.log</span>
<span class="token number">123</span>
<span class="token number">456</span>
<span class="token number">789</span></code></pre>

<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><p>| 是管道符，管道符左边命令的标准输出发送给管道符右边命令的标准输入</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">命令1 <span class="token operator">|</span> 命令2 <span class="token operator">|</span> 命令3 <span class="token operator">|</span> <span class="token punctuation">..</span>.</code></pre>

<p>注意：所以管道符右面只能跟一个命令，因为管道符右面会打开一个子进程，多个命令只会执行第一个，后面的命令会退出子进程再执行</p>
<p>如果跟多个命令，命令之间用分号间隔，用{}或者()把多个命令包裹起来，确保多个这多个命令是在同一个进程下执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 scripts<span class="token punctuation">]</span><span class="token comment">#echo 1 2 | read x y ; echo x=$x y=$y</span>
<span class="token assign-left variable">x</span><span class="token operator">=</span> <span class="token assign-left variable">y</span><span class="token operator">=</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#echo 1 2 | ( read x y ; echo x=$x y=$y )</span>
<span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">y</span><span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#echo 1 2 | &#123; read x y ; echo x=$x y=$y; &#125;</span>
<span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">y</span><span class="token operator">=</span><span class="token number">2</span></code></pre>

<p>注意: 标准错误默认通过管道转发, 可利用<code>2&gt;&amp;1</code>或<code>|&amp;</code>实现</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># ll c.log</span>
ls: cannot access c.log: No such <span class="token function">file</span> or directory
<span class="token comment"># 命令1 2>&amp;1 | 命令2</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># ll c.log 2>&amp;1 | tr a-z A-Z</span>
LS: CANNOT ACCESS C.LOG: NO SUCH FILE OR DIRECTORY
<span class="token comment"># 命令1 |&amp; 命令2</span>
<span class="token punctuation">[</span>root@4710419222 test<span class="token punctuation">]</span><span class="token comment"># ll c.log |&amp; tr a-z A-Z</span>
LS: CANNOT ACCESS C.LOG: NO SUCH FILE OR DIRECTORY</code></pre>

<h3 id="重定向中的-符号"><a href="#重定向中的-符号" class="headerlink" title="重定向中的 - 符号"></a>重定向中的 - 符号</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将下载文件内容输出到标准输出, 而不保存文件</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span>$ <span class="token function">wget</span> <span class="token parameter variable">-qO</span> - http://www.wangxiaochun.com/testdir/hello.sh
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># ------------------------------------------</span>
<span class="token comment"># Filename: hello.sh</span>
<span class="token comment"># Version: 1.0</span>
<span class="token comment"># Date: 2017/06/01</span>
<span class="token comment"># Author: wang</span>
<span class="token comment"># Email: 29308620@qq.com</span>
<span class="token comment"># Website: www.wangxiaochun.com</span>
<span class="token comment"># Description: This is the first script</span>
<span class="token comment"># Copyright: 2017 wang</span>
<span class="token comment"># License: GPL</span>
<span class="token comment"># ------------------------------------------</span>
<span class="token comment">#经典写法</span>
<span class="token builtin class-name">echo</span> <span class="token string">"hello, world"</span>
<span class="token comment">#流行写法</span>
<span class="token builtin class-name">echo</span> <span class="token string">'Hello, world!'</span>

<span class="token comment"># 将 /home 里面的文件打包，但打包的数据不是记录到文件，而是传送到 stdout，经过管道后，将 tar - cvf - /home 传送给后面的 tar -xvf - , 后面的这个 - 则是取前一个命令的 stdout， 因此，就不需要使用临时file了</span>
<span class="token function">tar</span> <span class="token parameter variable">-cvf</span> - /home <span class="token operator">|</span> <span class="token function">tar</span> <span class="token parameter variable">-xvf</span> -</code></pre>

<h2 id="文件描述符（fd）"><a href="#文件描述符（fd）" class="headerlink" title="文件描述符（fd）"></a>文件描述符（fd）</h2><p>Linux 中一切都是文件。文件描述符 fd 是内核为了高效管理已被打开的文件所创建的<strong>索引</strong>，是一个非负整数，在文件 open 时产生。程序刚刚启动的时候，0 是标准输入，1 是标准输出，2 是标准错误。如果此时去打开一个新的文件，它的文件描述符会是 3。</p>
<p>系统为每一个进程维护了一个文件描述符表，该表的值都是从 0 开始的，<strong>由于进程级文件描述符表的存在，不同的进程中会出现相同的文件描述符，它们可能指向同一个文件，也可能指向不同的文件</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">相关命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 16:33:07" itemprop="dateCreated datePublished" datetime="2021-02-04T16:33:07+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/" itemprop="url" rel="index"><span itemprop="name">用户和组</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="getent"><a href="#getent" class="headerlink" title="getent"></a>getent</h2><p>用来察看系统的数据库中的相关记录，系统数据库包括：ahosts、ahostsv4、ahostsv6、aliases、ethers、group、gshadow、hosts、initgroups、netgroup、networks、passwd、protocols、rpc、services、shadow</p>
<p>getent 通过 key 查询整条数据，当然，一条数据并非只能对应一个 key，例如 passwd，一条数据的 key 可以是用户名, 也可以是 UID</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">getent database <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查询passwd</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent passwd lujinkai</span>
lujinkai:x:1000:1000:lujinkai:/home/lujinkai:/bin/bash
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent passwd 1000</span>
lujinkai:x:1000:1000:lujinkai:/home/lujinkai:/bin/bash
<span class="token comment"># 查询shadow</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent shadow lujinkai</span>
lujinkai:<span class="token variable">$6</span><span class="token variable">$Kmenu</span>.bK<span class="token variable">$sIXTEMYHCL9QJ9ZLEmkeybfF6NV3p6l2m3G1SLFSgomaDOPArKcbZuUHgIunOXjMqfJ48KYbW76YvEgg1hcXs0</span>:18475:0:99999:7:::</code></pre>

<h2 id="vipw-vigr-pwck-grpck"><a href="#vipw-vigr-pwck-grpck" class="headerlink" title="vipw \ vigr \ pwck \ grpck"></a>vipw \ vigr \ pwck \ grpck</h2><p>尽量不要直接修改<code>/etc/passwd</code>、<code>/etc/group</code>、<code>/etc/shadow</code>、<code>/etc/gshadow</code> 这四个文件</p>
<p><strong><code>vipw</code> 可以用来编辑<code>/etc/passwd</code>，<code>vigr</code>可以用来编辑<code>/etc/group</code>，它俩都有语法检查功能</strong></p>
<p><strong><code>pwck</code>用来验证<code>/etc/passwd</code>和<code>/etc/shadow</code>的内容和格式的完整性，<code>grpck</code>用于验证组文件的完整性</strong></p>
<p>虽然用这四个命令会比直接使用 vim 修改这四个文件更安全，但是也不推荐使用，了解即可</p>
<p>推荐使用：useradd、groupadd、chage 等命令，当然本质还是修改这四个文件</p>
<h2 id="useradd"><a href="#useradd" class="headerlink" title="useradd"></a>useradd</h2><p>用户创建，<code>useradd</code> 等于 <code>adduser</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">useradd</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> LOGIN</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">-u, <span class="token parameter variable">--uid</span> <span class="token environment constant">UID</span>                              <span class="token comment"># 指定uid, 不过不加-o参数, 指定的uid必须是唯一非负整数</span>
-o, --non-unique                           <span class="token comment"># 配合-u选项, 不检查UID的唯一性</span>
-g, <span class="token parameter variable">--gid</span> GROUP                            <span class="token comment"># 指定用户所属基本组, 可以是组名, 也可以是GID</span>
-c, <span class="token parameter variable">--comment</span> COMMENT                      <span class="token comment"># 用户的的注释, 要简短一些</span>
-s, <span class="token parameter variable">--shell</span> <span class="token environment constant">SHELL</span>                          <span class="token comment"># 指定用户的默认shell, 可从/etc/shells中选择, 如果是给服务用, 指定/sbin/nologin</span>
-G, <span class="token parameter variable">--groups</span> GROUP1<span class="token punctuation">[</span>,GROUP2,<span class="token punctuation">..</span>.<span class="token punctuation">[</span>,GROUPN<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment"># 指定用户的附加组, 组须是已存在的</span>
-N, --no-user-group                        <span class="token comment"># 不创建私用组作为主组, 使用users组做主组</span>
-r, <span class="token parameter variable">--system</span>                               <span class="token comment"># 创建系统用户 centos6之前: UID &lt; 500, centos7之后: UID &lt; 1000，使用这个参数, 不会自动创建家目录和邮件目录</span>
-d, --home-dir HOME_DIR                    <span class="token comment"># 指定用户的家目录</span>
-m, --create-home                          <span class="token comment"># 创建家目录, 用于系统用户</span>
-M, --no-create-home                       <span class="token comment"># 不创建家目录, 用于非系统用户</span>
-p, <span class="token parameter variable">--password</span> PASSWORD                    <span class="token comment"># 指定密码, 必须是加密过后的</span></code></pre>

<h3 id="创建用户相关文件"><a href="#创建用户相关文件" class="headerlink" title="创建用户相关文件"></a>创建用户相关文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash">/etc/default/useradd
/etc/skel/
/etc/login.defs</code></pre>

<p>useradd 命令默认值设置在 <code>/etc/default/useradd</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># useradd defaults file</span>
<span class="token assign-left variable">GROUP</span><span class="token operator">=</span><span class="token number">100</span>   <span class="token comment"># 如果useradd没有指定组，并且/etc/login.defs中的USERGROUPS_ENAB为no或者useradd使用了-N选项时，此时该参数生效。</span>
<span class="token assign-left variable"><span class="token environment constant">HOME</span></span><span class="token operator">=</span>/home  <span class="token comment"># 家目录放在此目录下</span>
<span class="token assign-left variable">INACTIVE</span><span class="token operator">=</span>-1 <span class="token comment"># 对应/etc/shadow文件第7列, 即用户密码过期的宽限期, -1表示不过期</span>
<span class="token assign-left variable">EXPIRE</span><span class="token operator">=</span>     <span class="token comment"># 对应/etc/shadow文件第8列,即用户账号的有效期, 不设置表示不启用</span>
<span class="token assign-left variable"><span class="token environment constant">SHELL</span></span><span class="token operator">=</span>/bin/bash
<span class="token assign-left variable">SKEL</span><span class="token operator">=</span>/etc/skel
<span class="token assign-left variable">CREATE_MAIL_SPOOL</span><span class="token operator">=</span>yes</code></pre>

<p><code>/etc/skel/</code> 是模板目录，骨架目录。每新建一个用户的家目录，就会把<code>/etc/skel/</code>下的文件拷贝一份到家目录下。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 skel<span class="token punctuation">]</span><span class="token comment"># ls -lia /etc/skel/</span>
total <span class="token number">24</span>
<span class="token number">134321114</span> drwxr-xr-x.  <span class="token number">2</span> root root   <span class="token number">62</span> Jul <span class="token number">29</span> <span class="token number">17</span>:08 <span class="token builtin class-name">.</span>
<span class="token number">134320193</span> drwxr-xr-x. <span class="token number">73</span> root root <span class="token number">8192</span> Aug  <span class="token number">1</span> <span class="token number">17</span>:49 <span class="token punctuation">..</span>
<span class="token number">134360296</span> -rw-r--r--.  <span class="token number">1</span> root root   <span class="token number">18</span> Apr  <span class="token number">1</span> <span class="token number">10</span>:17 .bash_logout
<span class="token number">134360297</span> -rw-r--r--.  <span class="token number">1</span> root root  <span class="token number">193</span> Apr  <span class="token number">1</span> <span class="token number">10</span>:17 .bash_profile
<span class="token number">134360298</span> -rw-r--r--.  <span class="token number">1</span> root root  <span class="token number">231</span> Apr  <span class="token number">1</span> <span class="token number">10</span>:17 .bashrc</code></pre>

<p><code>/etc/login.defs</code> 配合 <code>/etc/passwd</code> 和 <code>/etc/shadow</code> 来对用户进行一些限制 但是优先级低于 <code>/etc/passwd</code>和 <code>/etc/shadow</code></p>
<p>如果有冲突的地方，系统会以 <code>/etc/passwd</code> 和 <code>/etc/shadow</code> 为准</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 skel<span class="token punctuation">]</span><span class="token comment"># egrep -v '^[ ]*$|^#' /etc/login.defs</span>
MAIL_DIR        /var/spool/mail
PASS_MAX_DAYS   <span class="token number">99999</span>
PASS_MIN_DAYS   <span class="token number">0</span>
PASS_MIN_LEN    <span class="token number">5</span>
PASS_WARN_AGE   <span class="token number">7</span>
UID_MIN                  <span class="token number">1000</span>
UID_MAX                 <span class="token number">60000</span>
SYS_UID_MIN               <span class="token number">201</span>
SYS_UID_MAX               <span class="token number">999</span>
GID_MIN                  <span class="token number">1000</span>
GID_MAX                 <span class="token number">60000</span>
SYS_GID_MIN               <span class="token number">201</span>
SYS_GID_MAX               <span class="token number">999</span>
CREATE_HOME     <span class="token function">yes</span>
UMASK           077
USERGROUPS_ENAB <span class="token function">yes</span>
ENCRYPT_METHOD SHA512</code></pre>

<h3 id="newusers"><a href="#newusers" class="headerlink" title="newusers"></a>newusers</h3><p>批量创建用户</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">newusers <span class="token function">passwd</span> 用户文件</code></pre>

<p>用户文件：指定包含用户信息的文本文件，文件格式要与 <code>/etc/passwd</code> 相同</p>
<h3 id="chpasswd"><a href="#chpasswd" class="headerlink" title="chpasswd"></a>chpasswd</h3><p>批量修改用户密码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> username:passwd <span class="token operator">|</span> chpasswd</code></pre>

<p>生成密码:</p>
<ul>
<li><p>CentOS 6</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># grub-crypt 是centos6中的命令, 可以对口令进行加密, 默认加密方式是 sha-512</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># grub-crypt --help</span>
Usage: grub-crypt <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>.
Encrypt a password.

  -h, <span class="token parameter variable">--help</span>              Print this message and <span class="token builtin class-name">exit</span>
  -v, <span class="token parameter variable">--version</span>           Print the version information and <span class="token builtin class-name">exit</span>
  <span class="token parameter variable">--md5</span>                   Use MD5 to encrypt the password
  --sha-256               Use SHA-256 to encrypt the password
  --sha-512               Use SHA-512 to encrypt the password <span class="token punctuation">(</span>default<span class="token punctuation">)</span>

Report bugs to <span class="token operator">&lt;</span>bug-grub@gnu.org<span class="token operator">></span>.
EOF
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># grub-crypt</span>
Password:
Retype password:
<span class="token variable">$6</span><span class="token variable">$O4ufCj1vTKW</span>/7Ko7<span class="token variable">$p9rV3m0dsEsr0ebCyOVN</span>.togh1fVhQCCDBsoc.RkelfWnRrIm3W5vVPuB86oOKo1Yei0QKxO2MRMoX2qzHV7M1
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># useradd -p '$6$O4ufCj1vTKW/7Ko7$p9rV3m0dsEsr0ebCyOVN.togh1fVhQCCDBsoc.RkelfWnRrIm3W5vVPuB86oOKo1Yei0QKxO2MRMoX2qzHV7M1' test</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># getent shadow test</span>
test:<span class="token variable">$6</span><span class="token variable">$O4ufCj1vTKW</span>/7Ko7<span class="token variable">$p9rV3m0dsEsr0ebCyOVN</span>.togh1fVhQCCDBsoc.RkelfWnRrIm3W5vVPuB86oOKo1Yei0QKxO2MRMoX2qzHV7M1:18475:0:99999:7:::</code></pre>
</li>
<li><p>CentOS 7</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># CentOS 7中没有直接命令能加密sha-512口令, 可以使用python</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#python -c 'import</span>
crypt,getpass<span class="token punctuation">;</span><span class="token assign-left variable">pw</span><span class="token operator">=</span><span class="token string">"magedu"</span><span class="token punctuation">;</span>print<span class="token punctuation">(</span>crypt.crypt<span class="token punctuation">(</span>pw<span class="token punctuation">))</span>'
<span class="token variable">$6</span><span class="token variable">$pt0SFMf6YqKea3mh</span>$.7Hkslg17uI.Wu7BcMJStVVtkzrwktXrOC8DxcMFC4JO1igrqR7VAi87H5PH
OuLTUEjl7eJqKUhMT1e9ixojn1</code></pre>
</li>
<li><p>CentOS 8</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -6 表示sha-512加密方式, CentOS7中只有-1(md5)加密方式</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># whatis passwd</span>
openssl-passwd <span class="token punctuation">(</span>1ssl<span class="token punctuation">)</span> - compute password hashes
<span class="token function">passwd</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>           - update user's authentication tokens
<span class="token function">passwd</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>           - password <span class="token function">file</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># man openssl-passwd</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># openssl passwd -6 123456</span>
<span class="token variable">$6</span><span class="token variable">$vQQo</span>/2Ie/NqmeTqp<span class="token variable">$o6kCsDtZwNtW7rLh</span>/LEk8yA26sYW4Kmja7uk/pLp<span class="token punctuation">..</span>cNe77btZf3tRxeqtSwgoGKzc5GgXJT9NIpXNShQ9L7r0</code></pre>
</li>
<li><p>Ubuntu</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment">#echo wang:centos |chpasswd</span>
<span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment">#passwd wang &lt;&lt;EOF</span>
<span class="token operator">></span> centos
<span class="token operator">></span> centos
<span class="token operator">></span> EOF
Enter new UNIX password: Retype new UNIX password: passwd: password updated
successfully
<span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment">#echo -e 'magedu\nmagedu' | passwd wang</span>
Enter new UNIX password: Retype new UNIX password: passwd: password updated
successfully</code></pre></li>
</ul>
<h2 id="usermod"><a href="#usermod" class="headerlink" title="usermod"></a>usermod</h2><p>修改用户属性，不过用户一旦创建完了，很少会再修改，所以这个命令几乎不用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">usermod</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span> login

<span class="token parameter variable">-u</span> <span class="token environment constant">UID</span>                        <span class="token comment"># 新UID</span>
<span class="token parameter variable">-g</span> GID                        <span class="token comment"># 新主组</span>
<span class="token parameter variable">-G</span> GROUP1<span class="token punctuation">[</span>,GROUP2,<span class="token punctuation">..</span>.<span class="token punctuation">[</span>,GROUPN<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment"># 新附加组，原来的附加组将会被覆盖；若保留原有，则要同时使用-a选项</span>
<span class="token parameter variable">-s</span> <span class="token environment constant">SHELL</span>                      <span class="token comment"># 新的默认SHELL</span>
<span class="token parameter variable">-c</span> <span class="token string">'COMMENT'</span>                  <span class="token comment"># 新的注释信息</span>
<span class="token parameter variable">-d</span> <span class="token environment constant">HOME</span>                       <span class="token comment"># 新家目录不会自动创建，若要创建新家目录并移动原家数据，同时使用-m选项</span>
<span class="token parameter variable">-l</span> login_name                 <span class="token comment"># 新的名字</span>
<span class="token parameter variable">-L</span>                            <span class="token comment"># lock指定用户,在/etc/shadow 密码栏的增加 !</span>
<span class="token parameter variable">-U</span>                            <span class="token comment"># unlock指定用户,将 /etc/shadow 密码栏的 ! 拿掉</span>
<span class="token parameter variable">-e</span> YYYY-MM-DD                 <span class="token comment"># 指明用户账号过期日期</span>
<span class="token parameter variable">-f</span> INACTIVE                   <span class="token comment"># 设定非活动期限，即宽限期</span></code></pre>

<h2 id="userdel"><a href="#userdel" class="headerlink" title="userdel"></a>userdel</h2><p>删除用户</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">userdel</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span><span class="token punctuation">..</span>. Login

<span class="token parameter variable">-f</span> <span class="token parameter variable">--force</span>    <span class="token comment"># 强制</span>
<span class="token parameter variable">-r</span> <span class="token parameter variable">--remove</span>   <span class="token comment"># 删除用户家目录和邮箱</span></code></pre>

<h2 id="id"><a href="#id" class="headerlink" title="id"></a>id</h2><p>查看用户相关 ID 信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">id</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span><span class="token environment constant">USER</span><span class="token punctuation">]</span>

<span class="token parameter variable">-u</span>   <span class="token comment">#</span>
<span class="token parameter variable">-g</span>   <span class="token comment">#</span>
<span class="token parameter variable">-G</span>   <span class="token comment">#</span>

<span class="token comment"># 示例</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># id -u</span>
<span class="token number">0</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment"># id -u lujinkai</span>
<span class="token number">1000</span></code></pre>

<h2 id="su"><a href="#su" class="headerlink" title="su"></a>su</h2><p>su：switch user，切换用户</p>
<p>两种切换的方式:</p>
<ul>
<li>su UserName：非登录式切换，即不会读取目标用户的配置文件，不改变当前工作目录，即不完全切换</li>
<li>su - UserName：登录式切换，会读取目标用户的配置文件，切换至自已的家目录，即完全切换</li>
</ul>
<p>注意：su 切换新用户后，使用 exit 退回至旧的用户，而不要再用 su 切换至旧用户，否则会生成很多的 bash 子进程，环境可能会混乱</p>
<h2 id="passwd"><a href="#passwd" class="headerlink" title="passwd"></a>passwd</h2><p>修改用户密码</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">passwd</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> UserName</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">-d：删除指定用户密码
-l：锁定指定用户
-u：解锁指定用户
-e：强制用户下次登录修改密码
-f：强制操作
<span class="token parameter variable">-n</span> mindays：指定最短使用期限
<span class="token parameter variable">-x</span> maxdays：最大使用期限
<span class="token parameter variable">-w</span> warndays：提前多少天开始警告
<span class="token parameter variable">-i</span> inactivedays：非活动期限
--stdin：从标准输入接收用户密码,Ubuntu无此选项</code></pre>

<h2 id="chage"><a href="#chage" class="headerlink" title="chage"></a>chage</h2><p>修改用户密码策略</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">chage <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. LOGIN</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-d</span> LAST_DAY <span class="token comment">#更改密码的时间</span>
<span class="token parameter variable">-m</span> <span class="token parameter variable">--mindays</span> MIN_DAYS
<span class="token parameter variable">-M</span> <span class="token parameter variable">--maxdays</span> MAX_DAYS
<span class="token parameter variable">-W</span> <span class="token parameter variable">--warndays</span> WARN_DAYS
<span class="token parameter variable">-I</span> <span class="token parameter variable">--inactive</span> INACTIVE <span class="token comment">#密码过期后的宽限期</span>
<span class="token parameter variable">-E</span> <span class="token parameter variable">--expiredate</span> EXPIRE_DATE <span class="token comment">#用户的有效期</span>
<span class="token parameter variable">-l</span> 显示密码策略</code></pre>

<h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><ul>
<li><code>chfn</code> 指定个人信息，这个命令修改的是&#x2F;etc&#x2F;passwd 的第 5 个字段</li>
<li><code>chsh</code> 指定 shell，相当于 usermod -s</li>
<li><code>flnger</code> 可以查看用户个人信息</li>
</ul>
<p>这几个命令用的不多，了解即可，flnger 命令在 CentOS8 中已经没有了</p>
<h2 id="groupadd"><a href="#groupadd" class="headerlink" title="groupadd"></a>groupadd</h2><p>创建组，<code>groupadd</code> 等于 <code>addgroup</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">groupadd</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span><span class="token punctuation">..</span>. group_name</code></pre>

<ul>
<li>-g GID : 指明 GID</li>
<li>-r : 创建系统组, CentOS 6 之前: ID&lt;500，CentOS 7 以后: ID&lt;1000</li>
</ul>
<p>范例: <code>groupadd -g 48 -r apache</code></p>
<h2 id="groupmod"><a href="#groupmod" class="headerlink" title="groupmod"></a>groupmod</h2><p>修改组</p>
<p>groupmod 修改组的属性, 用的不多</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">groupmod</span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span><span class="token punctuation">..</span>. group</code></pre>

<ul>
<li>-n group_name : 新名字</li>
<li>-g GID : 新 GID</li>
</ul>
<h2 id="groupdel"><a href="#groupdel" class="headerlink" title="groupdel"></a>groupdel</h2><p>删除组</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">groupdel</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> GROUP</code></pre>

<p>只有当组下没有用户后, 才能删除成功</p>
<h2 id="gpasswd"><a href="#gpasswd" class="headerlink" title="gpasswd"></a>gpasswd</h2><p>gpasswd 命令，可以更改组密码，也可以添加删除附加组成员</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">gpasswd <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> GROUP</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-a</span> user                    <span class="token comment"># 将user添加到指定组中</span>
<span class="token parameter variable">-d</span> user                    <span class="token comment"># 从指定附加组中移除用户user</span>
<span class="token parameter variable">-M</span> user1,user2,user3<span class="token punctuation">..</span>.    <span class="token comment"># 设置组成员列表, 会覆盖已有的组成员列表</span>
<span class="token parameter variable">-A</span> user1, user2, user3 <span class="token punctuation">..</span>. <span class="token comment"># 设置有组管理员列表</span>

<span class="token comment"># 设置管理员的之前, 这些用户必须已经在组内了, 管理员有权限往组内添加用户</span></code></pre>

<h2 id="newgrp"><a href="#newgrp" class="headerlink" title="newgrp"></a>newgrp</h2><p>临时切换主组，把用户的主组临时切换到附加组</p>
<p>这个命令用的不多，了解一下就行</p>
<h2 id="groupmems"><a href="#groupmems" class="headerlink" title="groupmems"></a>groupmems</h2><p>更改和查看组成员，管理附加组的成员关系（只有 root 用户可以执行这个命令）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">groupmems <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>action<span class="token punctuation">]</span>

-g, <span class="token parameter variable">--group</span> groupname <span class="token comment">#更改为指定组 (只有root)</span>
-a, <span class="token parameter variable">--add</span> username    <span class="token comment">#指定用户加入组</span>
-d, <span class="token parameter variable">--delete</span> username <span class="token comment">#从组中删除用户</span>
-p, <span class="token parameter variable">--purge</span>           <span class="token comment">#从组中清除所有成员</span>
-l, <span class="token parameter variable">--list</span>            <span class="token comment">#显示组成员列表</span></code></pre>

<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent group lujinkai</span>
lujinkai:x:1000:lujinkai
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># groupmems -g lujinkai -a test</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent group lujinkai</span>
lujinkai:x:1000:lujinkai,test
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># groupmems -g lujinkai -l</span>
lujinkai  <span class="token builtin class-name">test</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># groupmems -g lujinkai -d test</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent group lujinkai</span>
lujinkai:x:1000:lujinkai
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># groupmems -g lujinkai -p</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent group lujinkai</span>
lujinkai:x:1000:</code></pre>

<h2 id="groups"><a href="#groups" class="headerlink" title="groups"></a>groups</h2><p>查看用户所属组的列表</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># test用户所属的组有两个 test 和 lujinkai, test是主组 lujinkai是附加组</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># groups test</span>
<span class="token builtin class-name">test</span> <span class="token builtin class-name">:</span> <span class="token builtin class-name">test</span> lujinkai</code></pre>

<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>1.创建用户 gentoo，附加组为 bin 和 root，默认 shell 为&#x2F;bin&#x2F;csh，注释信息为”Gentoo Distribution”</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># useradd gentoo -G bin,root -s /bin/csh -c "Gentoo Distribution"</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># getent passwd gentoo</span>
gentoo:x:1003:1003:Gentoo Distribution:/home/gentoo:/bin/csh
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># groups gentoo</span>
gentoo <span class="token builtin class-name">:</span> gentoo root bin</code></pre>

<p>2.创建下面的用户、组和组成员关系:<br>名字为 webs 的组<br>用户 nginx，使用 webs 作为附加组<br>用户 varnish，使用 webs 作为附加组<br>用户 mysql，不可交互登录系统，且不是 webs 的成员，nginx，varnish，mysql 密码都是 magedu</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/" class="post-title-link" itemprop="url">用户和组</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 16:33:06" itemprop="dateCreated datePublished" datetime="2021-02-04T16:33:06+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84/" itemprop="url" rel="index"><span itemprop="name">用户和组</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Linux-安全模型"><a href="#Linux-安全模型" class="headerlink" title="Linux 安全模型"></a>Linux 安全模型</h2><p><strong>3A：</strong></p>
<pre class="language-none"><code class="language-none">认证: Authentication (确认身份, 登录系统的用户名和密码)
授权: Authorization (对于文件和程序的权限)
审计: Accouting|Audition (监控日志)</code></pre>

<p>认证和授权 linux 本身的软件实现, 审计通过特定的软件实现</p>
<p>用户登录成功时，系统会自动分配令牌 token，token 中包含了用户标识和组成员等信息，用户的每一步操作，系统都会校验他的 token，验证他的权限</p>
<h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><p>linux 中每个用户是通过 uid 来唯一标识的 <code>id -u</code></p>
<pre class="language-none"><code class="language-none">管理员：root，0
普通用户
  系统用户：1-499 (centos6及以前)，1-999 (centos7以后)，对守护进行获取资源进行权限分配
  登录用户：500+ (centos6及以前)，1000+ (centos7以后)，给用户进行交互式登录使用</code></pre>

<h2 id="用户组"><a href="#用户组" class="headerlink" title="用户组"></a>用户组</h2><p>linux 中可以将一个或多个用户加入用户组中, 用户组通过 gid 唯一标识 <code>id -g</code></p>
<pre class="language-none"><code class="language-none">管理员组: root, 0
普通组:
  系统组
  普通组</code></pre>

<h2 id="用户和用户组的关系"><a href="#用户和用户组的关系" class="headerlink" title="用户和用户组的关系"></a>用户和用户组的关系</h2><ul>
<li>主组：用户必须属于一个且只有一个主组，默认创建用户时会自动创建和用户同名的组作为用户的主组，由于此组中只有一个用户，又称为私有组</li>
<li>附加组：一个用户可以属于 0 个或多个辅助组，附属组</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>lujinkai@centos7 root<span class="token punctuation">]</span>$ <span class="token function">id</span> postfix
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">89</span><span class="token punctuation">(</span>postfix<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">89</span><span class="token punctuation">(</span>postfix<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">89</span><span class="token punctuation">(</span>postfix<span class="token punctuation">)</span>,12<span class="token punctuation">(</span>mail<span class="token punctuation">)</span></code></pre>

<h2 id="安全上下文"><a href="#安全上下文" class="headerlink" title="安全上下文"></a>安全上下文</h2><p>进程能够访问资源的权限取决于进程的运行者身份，而非程序本身</p>
<h2 id="用户和组的配置文件"><a href="#用户和组的配置文件" class="headerlink" title="用户和组的配置文件"></a>用户和组的配置文件</h2><pre class="language-bash" data-language="bash"><code class="language-bash">/etc/passwd  <span class="token comment">#系统用户配置文件，存储了系统中所有用户的基本信息，并且所有用户都可以对此文件执行读操作</span>
/etc/shadow  <span class="token comment">#存储 Linux 系统中用户的密码信息，又称为“影子文件”</span>
/etc/group   <span class="token comment">#用户组配置文件，用户组的所有信息都存放在此文件中</span>
/etc/gshadow <span class="token comment">#存储组用户的密码信息</span></code></pre>

<h2 id="x2F-etc-x2F-passwd-文件格式"><a href="#x2F-etc-x2F-passwd-文件格式" class="headerlink" title="&#x2F;etc&#x2F;passwd 文件格式"></a>&#x2F;etc&#x2F;passwd 文件格式</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># whatis passwd</span>
sslpasswd <span class="token punctuation">(</span>1ssl<span class="token punctuation">)</span>     - compute password hashes
<span class="token function">passwd</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>           - update user's authentication tokens
<span class="token function">passwd</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>           - password <span class="token function">file</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment"># man 5 passwd</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1596264424437.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">name      <span class="token comment"># 1 用户登录名</span>
password  <span class="token comment"># 2 在很早之前, 这里确实存储密码, 后来因为安全问题, 密码就搬迁到/etc/shadow中了, 但是因为兼容性问题, 所以格式不能变, 就留了一个占位符, 用x或*占位</span>
<span class="token environment constant">UID</span>       <span class="token comment">#  3 用户的id</span>
GID       <span class="token comment">#  4 用户主组的id</span>
GECOS     <span class="token comment"># 5 存储用户全名和一些注释</span>
directory <span class="token comment"># 6 用户家目录</span>
shell     <span class="token comment"># 7 用户默认使用的shell ( /bin/bash )</span></code></pre>

<h2 id="x2F-etc-x2F-shadow-文件格式"><a href="#x2F-etc-x2F-shadow-文件格式" class="headerlink" title="&#x2F;etc&#x2F;shadow 文件格式"></a>&#x2F;etc&#x2F;shadow 文件格式</h2><p>&#x2F;etc&#x2F;passwd 文件所有用户都可以读, &#x2F;etc&#x2F;shadow 文件只有 root 用户才可以读</p>
<p>注意：如果这个文件的权限发生了改变，则需要注意是否是恶意攻击</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1596266655590.png"></p>
<p><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/840.html">Linux &#x2F;etc&#x2F;shadow（影子文件）内容解析（超详细）</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>. 用户登录名
<span class="token number">2</span>. 加密过的用户登录密码, 一般用sha512加密
<span class="token number">3</span>. 最后一次修改密码的时间, 如果没有修改过, 则空置
<span class="token number">4</span>. 密码再过几天可以被更改, <span class="token number">0</span>表示随时都可以更改
<span class="token number">5</span>. 密码再过几天必须被更改, <span class="token number">9999</span>是300多年, 可以认为永不过期
<span class="token number">6</span>. 密码过期前几天系统提醒用户, 默认是一周
<span class="token number">7</span>. 密码过期后的宽限时间, 以天为单位, 也就是说密码过期后, 用户如果还没有修改密码, 则在此字段规定的宽限天数内, 用户还是可以登录系统
<span class="token number">8</span>. 账号过期时间, 从1970.1.1开始算, 多少天后账号失效, 在此规定时间之外, 不论密码是否过期, 都无法登录<span class="token operator">!</span> 该字段通常被使用在具有收费服务的系统中
<span class="token number">9</span>. 保留, 这个字段目前没有使用, 等待新功能的加入</code></pre>

<h2 id="x2F-etc-x2F-group-文件格式"><a href="#x2F-etc-x2F-group-文件格式" class="headerlink" title="&#x2F;etc&#x2F;group 文件格式"></a>&#x2F;etc&#x2F;group 文件格式</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 组名:密码:GID:以当前组为附加组的用户列表(分割符为逗号)</span>

root:x:0:
mail:x:12:postfix
lujinkai:x:1000:</code></pre>

<h2 id="x2F-etc-x2F-gshadow-文件格式"><a href="#x2F-etc-x2F-gshadow-文件格式" class="headerlink" title="&#x2F;etc&#x2F;gshadow 文件格式"></a>&#x2F;etc&#x2F;gshadow 文件格式</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 组名:组密码:组管理员</span>

root:::
mail:::postfix
lujinkai:<span class="token operator">!</span>::</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">组密码：通常不设置组密码, 为空或者 <span class="token operator">!</span> 都表示该群组没有组密码
组管理员列表：可以更改组密码和添加用户到群组中, 组管理员列表用逗号分隔。这个功能现在不常用了
组管理员：该字段显示这个用户组中有哪些附加用户，和<span class="token variable"><span class="token variable">`</span>/etc/group<span class="token variable">`</span></span> 文件中附加组显示内容相同，多个用户也是用逗号分隔</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/DNS/%E7%BB%BC%E5%90%88%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/DNS/%E7%BB%BC%E5%90%88%E5%AE%9E%E9%AA%8C/" class="post-title-link" itemprop="url">综合实验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 15:26:11" itemprop="dateCreated datePublished" datetime="2021-02-04T15:26:11+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/DNS/" itemprop="url" rel="index"><span itemprop="name">DNS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>实验目的：搭建 DNS 实现 internet dns 架构</p>
<h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><p>需要 8 台主机</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">DNS客户端：10.0.0.6/24
本地DNS服务器（只缓存）：10.0.0.8/24
转发目标DNS服务器：10.0.0.18/24
根DNS服务器：10.0.0.28/24
org域DNS服务器：10.0.0.38/24
magedu.org域主DNS服务器：10.0.0.48/24
magedu.org域从DNS服务器：10.0.0.58/24
www.magedu.org的WEB服务器：10.0.0.68/24</code></pre>

<h2 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h2><p><img data-src="//img.to2b.cn/blog/ljk/1600479181845.png"></p>
<p><strong>客户端</strong>设置 dns 为<strong>本地 dns 服务器</strong>，本地 dns 服务器负责将所有 dns 解析请求转发到<strong>转发目标 dns 服务器</strong>，转发目标 DNS 服务器添加<strong>根 dns 服务器</strong>的 ip 到 named.ca，根 dns 服务器将将解析 org 的 dns 请求转发到<strong>org 域 DNS 服务器</strong>，org 域 DNS 服务器将解析 magedu.org 的 dns 请求转发到<strong>magedu.org 域 DNS 服务器（主从）</strong>，magedu.org 域 DNS 服务器将解析<a target="_blank" rel="noopener" href="http://www.magedu.org的dns请求转发到目标**web服务器**,web服务器返回请求的数据/">www.magedu.org的dns请求转发到目标**WEB服务器**，WEB服务器返回请求的数据</a></p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C5%EF%BC%9A%E5%88%A9%E7%94%A8view%E5%AE%9E%E7%8E%B0%E6%99%BA%E8%83%BDDNS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C5%EF%BC%9A%E5%88%A9%E7%94%A8view%E5%AE%9E%E7%8E%B0%E6%99%BA%E8%83%BDDNS/" class="post-title-link" itemprop="url">实验5：利用view实现智能DNS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 15:25:59" itemprop="dateCreated datePublished" datetime="2021-02-04T15:25:59+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/DNS/" itemprop="url" rel="index"><span itemprop="name">DNS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><pre class="language-bash" data-language="bash"><code class="language-bash">DNS主服务器：10.0.0.175
WEB服务器1：10.0.0.8
WEB服务器2：10.0.0.7
WEB服务器3：10.0.0.6
客户端1：10.0.0.57
客户端2：10.0.0.79
客户端3：10.0.0.50</code></pre>

<h2 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h2><p>在 DNS 主服务器中，设置三个 acl，分别对应三台客户端的 ip，设置三个 view，分别服务三个 acl，也建立三套 zone 数据库，当不同的客户端都发送 <a target="_blank" rel="noopener" href="http://www.magedu.local/">www.magedu.local</a> 请求，根据不同的 zone 数据库，会被解析到不同的 WEB 服务器</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C4%EF%BC%9ADNS%20forward%EF%BC%88%E7%BC%93%E5%AD%98%EF%BC%89%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C4%EF%BC%9ADNS%20forward%EF%BC%88%E7%BC%93%E5%AD%98%EF%BC%89%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">实验4：DNS forward（缓存）服务器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 15:25:53" itemprop="dateCreated datePublished" datetime="2021-02-04T15:25:53+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/DNS/" itemprop="url" rel="index"><span itemprop="name">DNS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>实验目的：搭建 DNS 转发（缓存）服务器</p>
<p>环境要求：需要四台主机</p>
<pre class="language-none"><code class="language-none">DNS只缓存服务器：10.0.0.79
DNS主服务器:10.0.0.175
web服务器：10.0.0.8
DNS客户端：10.0.0.67</code></pre>

<p>逻辑：客户端 nameserver 设置为 DNS 缓存服务器的 ip，NDS 缓存服务器负责将 NDS 请求转发至 DNS 主服务器，并将返回结果缓存</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="1-实现转发（只缓存）DNS-服务器"><a href="#1-实现转发（只缓存）DNS-服务器" class="headerlink" title="1. 实现转发（只缓存）DNS 服务器"></a>1. 实现转发（只缓存）DNS 服务器</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token builtin class-name">bind</span> <span class="token parameter variable">-y</span>

<span class="token function">vim</span> /etc/named.conf
<span class="token comment">#注释掉两行</span>
// listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
// allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment"># 全局转发</span>
forward first<span class="token punctuation">;</span>
forwarders <span class="token punctuation">&#123;</span> <span class="token number">10.0</span>.0.175<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">#关闭dnsec功能</span>
dnssec-enable no<span class="token punctuation">;</span>
dnssec-validation no<span class="token punctuation">;</span>

systemctl start named <span class="token comment">#第一次启动服务</span>
rndc reload <span class="token comment">#不是第一次启动服务</span></code></pre>

<h3 id="2-实现主-DNS-服务器"><a href="#2-实现主-DNS-服务器" class="headerlink" title="2. 实现主 DNS 服务器"></a>2. 实现主 DNS 服务器</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token builtin class-name">bind</span> <span class="token parameter variable">-y</span>
<span class="token function">vim</span> /etc/named.conf
<span class="token comment"># 注释掉两行</span>
// listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
// allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">vim</span> /etc/named.rfc1912.zones
<span class="token comment"># 设置域</span>
zone <span class="token string">"magedu.local"</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">"magedu.local.zone"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">vim</span> /var/named/magedu.local.zone
<span class="token variable">$TTL</span> 1D
@       IN      SOA     master  admin.magedu.org. <span class="token punctuation">(</span>
                                                        <span class="token number">0</span> <span class="token punctuation">;</span> serial
                                                        1D <span class="token punctuation">;</span> refresh
                                                        1H <span class="token punctuation">;</span> retry
                                                        1W <span class="token punctuation">;</span> expire
                                                        3H <span class="token punctuation">)</span> <span class="token punctuation">;</span> minimum
                NS      master
master          A       <span class="token number">10.0</span>.0.175
www             A       <span class="token number">10.0</span>.0.8</code></pre>

<h3 id="3-web-服务器配置（参看前面案例，略）"><a href="#3-web-服务器配置（参看前面案例，略）" class="headerlink" title="3. web 服务器配置（参看前面案例，略）"></a>3. web 服务器配置（参看前面案例，略）</h3><h3 id="4-在客户端测试"><a href="#4-在客户端测试" class="headerlink" title="4. 在客户端测试"></a>4. 在客户端测试</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改dns服务器</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/resolv.conf
<span class="token comment"># Generated by NetworkManager</span>
search magedu.org
nameserver <span class="token number">10.0</span>.0.79

<span class="token comment"># 测试</span>
<span class="token function">dig</span> www.magedu.local
<span class="token function">curl</span> www.magedu.local</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C3%EF%BC%9ADNS%E5%AD%90%E5%9F%9F%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C3%EF%BC%9ADNS%E5%AD%90%E5%9F%9F%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">实验3：DNS子域服务器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 15:25:39" itemprop="dateCreated datePublished" datetime="2021-02-04T15:25:39+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/DNS/" itemprop="url" rel="index"><span itemprop="name">DNS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实现父域-DNS-服务器"><a href="#实现父域-DNS-服务器" class="headerlink" title="实现父域 DNS 服务器"></a>实现父域 DNS 服务器</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/named.conf
<span class="token comment">#注释掉下面两行</span>
// listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
// allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">#只允许从服务器进行区域传输</span>
allow-transfer <span class="token punctuation">&#123;</span> 从服务器IP<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">#关闭加密验证</span>
dnssec-enable no<span class="token punctuation">;</span>
dnssec-validation no<span class="token punctuation">;</span>

<span class="token function">vim</span> /etc/named.rfc1912.zones
<span class="token comment">#加上这段</span>
zone <span class="token string">"magedu.local"</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">"magedu.org.local"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /var/named/magedu.local.zone
<span class="token variable">$TTL</span> 1D
@       IN      SOA     master  admin.magedu.org. <span class="token punctuation">(</span>
                                                        <span class="token number">0</span> <span class="token punctuation">;</span> serial
                                                        1D <span class="token punctuation">;</span> refresh
                                                        1H <span class="token punctuation">;</span> retry
                                                        1W <span class="token punctuation">;</span> expire
                                                        3H <span class="token punctuation">)</span> <span class="token punctuation">;</span> minimum
                NS      master
shanghai 		NS 		shanghains
master          A       <span class="token number">10.0</span>.0.175
www             A       <span class="token number">10.0</span>.0.8
slave           A       <span class="token number">10.0</span>.0.6
shanghains 		A 		<span class="token number">10.0</span>.0.18

<span class="token comment"># systemctl start named 第一次启动服务</span>
<span class="token comment"># rndc reload 不是第一次启动服务</span></code></pre>

<h2 id="实现子域-DNS-服务器"><a href="#实现子域-DNS-服务器" class="headerlink" title="实现子域 DNS 服务器"></a>实现子域 DNS 服务器</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/named.conf
<span class="token comment">#注释掉下面两行</span>
// listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
// allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
allow-transfer <span class="token punctuation">&#123;</span> none<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">vim</span> /etc/named.rfc1912.zones
zone <span class="token string">"shanghai.magedu.local"</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">"shanghai.magedu.local.zone"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<pre class="language-none"><code class="language-none">vim &#x2F;var&#x2F;named&#x2F;shanghai.magedu.local.zone
$TTL 1D
@       IN      SOA     master  admin.magedu.org. (
                                                        0 ; serial
                                                        1D ; refresh
                                                        1H ; retry
                                                        1W ; expire
                                                        3H ) ; minimum
                NS      master
master          A       10.0.0.18
www             A       10.0.0.8	; www.shanghai.magedu.local

# systemctl start named 第一次启动服务
# rndc reload 不是第一次启动服务</code></pre>

<h2 id="客户端测试"><a href="#客户端测试" class="headerlink" title="客户端测试"></a>客户端测试</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">dig</span> www.shanghai.magedu.org</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C2%EF%BC%9ADNS%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C2%EF%BC%9ADNS%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">实验2：DNS从服务器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 15:25:26" itemprop="dateCreated datePublished" datetime="2021-02-04T15:25:26+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/DNS/" itemprop="url" rel="index"><span itemprop="name">DNS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h2><p>搭建 DNS 主从服务器架构，实现 DNS 服务冗余</p>
<h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><p>需要四台主机<br>DNS 主服务器：10.0.0.175<br>DNS 从服务器:10.0.0.79<br>web 服务器：10.0.0.8<br>DNS 客户端：10.0.0.57</p>
<h2 id="前提准备"><a href="#前提准备" class="headerlink" title="前提准备"></a>前提准备</h2><p>关闭 SElinux<br>关闭防火墙<br>时间同步</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="主-DNS-服务器配置"><a href="#主-DNS-服务器配置" class="headerlink" title="主 DNS 服务器配置"></a>主 DNS 服务器配置</h3><p>参照前面案例的配置，修改只有两处：allow-transfer 和 slave</p>
<p><strong>1. 配置 &#x2F;etc&#x2F;named.conf：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># allow-transfer &#123; 从服务器IP;&#125;;	只允许从服务器进行区域传输</span>
<span class="token comment"># 同步全部，将配置写入option&#123;&#125;；同步区域，将配置写入zone "ZONE_NAME" &#123;&#125;</span>

options <span class="token punctuation">&#123;</span>
	<span class="token punctuation">..</span>.
	allow-transfer <span class="token punctuation">&#123;</span><span class="token number">10.0</span>.0.79<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token punctuation">..</span>.
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>1.1 配置 &#x2F;etc&#x2F;named.rfc1912.zones</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">zone <span class="token string">"magedu.local"</span> IN <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">"magedu.local.zone"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong>2. 修改 DNS 区域数据库文件 &#x2F;var&#x2F;named&#x2F;magedu.org.zone</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$TTL</span> 1D
@       IN      SOA     master  admin.magedu.org. <span class="token punctuation">(</span>
                                                        <span class="token number">0</span> <span class="token punctuation">;</span> serial
                                                        1D <span class="token punctuation">;</span> refresh
                                                        1H <span class="token punctuation">;</span> retry
                                                        1W <span class="token punctuation">;</span> expire
                                                        3H <span class="token punctuation">)</span> <span class="token punctuation">;</span> minimum
                NS      master
master          A       <span class="token number">10.0</span>.0.175
www             A       <span class="token number">10.0</span>.0.8
slave           A       <span class="token number">10.0</span>.0.6</code></pre>

<p><strong>3. 检查并重启 DNS 主服务器</strong></p>
<pre class="language-none"><code class="language-none">[root@centos8 ~]$named-checkconf
[root@centos8 slaves]$named-checkzone magedu.loacl &#x2F;var&#x2F;named&#x2F;magedu.local.zone
zone magedu.loacl&#x2F;IN: loaded serial 0
OK
[root@centos8 ~]$rndc reload
server reload successful</code></pre>

<h3 id="从-DNS-服务器配置"><a href="#从-DNS-服务器配置" class="headerlink" title="从 DNS 服务器配置"></a>从 DNS 服务器配置</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token builtin class-name">bind</span> <span class="token parameter variable">-y</span></code></pre>

<p>修改 &#x2F;etc&#x2F;named.conf</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">options <span class="token punctuation">&#123;</span>
	<span class="token punctuation">..</span>.
	// listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    // allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token comment">#不允许其它主机进行区域传输</span>
    allow-transfer <span class="token punctuation">&#123;</span> none<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token punctuation">..</span>.
<span class="token punctuation">&#125;</span></code></pre>

<p>配置 &#x2F;etc&#x2F;named.rfc1912.zones</p>
<pre class="language-none"><code class="language-none">zone &quot;magedu.local&quot; IN &#123;
    type slave;
    masters &#123;10.0.0.175;&#125;;
    file &quot;slaves&#x2F;magedu.local.slave&quot;;
&#125;;</code></pre>

<p>检查并启动</p>
<pre class="language-none"><code class="language-none">[root@centos6 ~]$named-checkconf
[root@centos6 slaves]$service named start
Generating &#x2F;etc&#x2F;rndc.key:                                  [  OK  ]
Starting named:                                            [  OK  ]</code></pre>

<p>查看是否生成 magedu.local.slave，注意，DNS 主从服务器都要配置正确才能生成，一开始 DNS 主服务器的 allow-transfer 配置错了从 DNS 从服务器的地址，就怎么也生成不了</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos6 named<span class="token punctuation">]</span><span class="token variable">$ll</span> /var/named/slaves/magedu.local.slave
-rw-r--r-- <span class="token number">1</span> named named <span class="token number">361</span> Sep <span class="token number">17</span> <span class="token number">20</span>:29 /var/named/slaves/magedu.local.slave
<span class="token punctuation">[</span>root@centos6 named<span class="token punctuation">]</span><span class="token variable">$cat</span> <span class="token operator">!</span>$
<span class="token function">cat</span> /var/named/slaves/magedu.local.slave
<span class="token variable">$ORIGIN</span> <span class="token builtin class-name">.</span>
<span class="token variable">$TTL</span> <span class="token number">86400</span>      <span class="token punctuation">;</span> <span class="token number">1</span> day
magedu.local            IN SOA  master.magedu.local. admin.magedu.org. <span class="token punctuation">(</span>
                                <span class="token number">0</span>          <span class="token punctuation">;</span> serial
                                <span class="token number">86400</span>      <span class="token punctuation">;</span> refresh <span class="token punctuation">(</span><span class="token number">1</span> day<span class="token punctuation">)</span>
                                <span class="token number">3600</span>       <span class="token punctuation">;</span> retry <span class="token punctuation">(</span><span class="token number">1</span> hour<span class="token punctuation">)</span>
                                <span class="token number">604800</span>     <span class="token punctuation">;</span> expire <span class="token punctuation">(</span><span class="token number">1</span> week<span class="token punctuation">)</span>
                                <span class="token number">10800</span>      <span class="token punctuation">;</span> minimum <span class="token punctuation">(</span><span class="token number">3</span> hours<span class="token punctuation">)</span>
                                <span class="token punctuation">)</span>
                        NS      master.magedu.local.
<span class="token variable">$ORIGIN</span> magedu.local.
master                  A       <span class="token number">10.0</span>.0.175
slave                   A       <span class="token number">10.0</span>.0.6
www                     A       <span class="token number">10.0</span>.0.8</code></pre>

<h3 id="客户端测试主从-DNS-服务架构"><a href="#客户端测试主从-DNS-服务架构" class="headerlink" title="客户端测试主从 DNS 服务架构"></a>客户端测试主从 DNS 服务架构</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加DNS从服务器ip到/etc/resolv.conf</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/resolv.conf
<span class="token comment"># Generated by NetworkManager</span>
search magedu.org
nameserver <span class="token number">10.0</span>.0.175
nameserver <span class="token number">10.0</span>.0.79

<span class="token comment"># 测试，将DNS主服务器关掉服务，只保留从DNS从服务器服务，或者关掉DNS从服务器服务，只保留DNS主服务器服务，结果是都能访问web服务器的http服务，只有DNS主从服务器都关掉服务，才无法访问web服务器的http服务</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token variable">$curl</span> www.magedu.local
www.magedu.local</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.lujinkai.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.lujinkai.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.lujinkai.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.lujinkai.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
