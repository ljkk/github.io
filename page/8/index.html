<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.to2b.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.to2b.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/8/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.to2b.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C1%EF%BC%9ADNS%E6%AD%A3%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/DNS/%E5%AE%9E%E9%AA%8C1%EF%BC%9ADNS%E6%AD%A3%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">实验1：DNS正向服务器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 15:25:15" itemprop="dateCreated datePublished" datetime="2021-02-04T15:25:15+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/DNS/" itemprop="url" rel="index"><span itemprop="name">DNS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h2><p>搭建 DNS 正向主服务器，实现 web 服务器基于 FQDN 的访问</p>
<h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><p>需要三台主机<br>DNS 服务端：10.0.0.175<br>web 服务器：10.0.0.8<br>DNS 客户端：10.0.0.57</p>
<h2 id="提前准备"><a href="#提前准备" class="headerlink" title="提前准备"></a>提前准备</h2><p>关闭 SElinux<br>关闭防火墙<br>时间同步</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="1-在-DNS-服务端安装-bind"><a href="#1-在-DNS-服务端安装-bind" class="headerlink" title="1. 在 DNS 服务端安装 bind"></a>1. 在 DNS 服务端安装 bind</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token builtin class-name">bind</span></code></pre>

<h3 id="2-修改-bind-配置文件"><a href="#2-修改-bind-配置文件" class="headerlink" title="2. 修改 bind 配置文件"></a>2. 修改 bind 配置文件</h3><p>修改配置文件 &#x2F;etc&#x2F;named.conf</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#注释掉下面两行</span>
// listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
// allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>修改配置文件 vim &#x2F;etc&#x2F;named.rfc1912.zones</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#加上下面内容, IN 可以省略</span>
zone <span class="token string">"magedu.local"</span> IN <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">"magedu.local.zone"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h3 id="3-DNS-区域数据库文件"><a href="#3-DNS-区域数据库文件" class="headerlink" title="3. DNS 区域数据库文件"></a>3. DNS 区域数据库文件</h3><p>在主目录（默认是&#x2F;var&#x2F;named&#x2F;）下新建 DNS 区域数据库文件 magedu.local.zone</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#如果没有加-p选项，需要修改所有者或权限。chgrp named magedu.local.zone</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /var/named/
<span class="token punctuation">[</span>root@centos8 named<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token parameter variable">-p</span> named.localhost magedu.local.zone
<span class="token punctuation">[</span>root@centos8 named<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">32</span>
drwxrwx--- <span class="token number">2</span> named named <span class="token number">4096</span> Sep <span class="token number">17</span> <span class="token number">22</span>:55 data
drwxrwx--- <span class="token number">2</span> named named <span class="token number">4096</span> Sep <span class="token number">17</span> <span class="token number">21</span>:49 dynamic
-rw-r----- <span class="token number">1</span> root  named  <span class="token number">152</span> Jul  <span class="token number">7</span> <span class="token number">22</span>:14 magedu.local.zone
-rw-r----- <span class="token number">1</span> root  named <span class="token number">2253</span> Jul  <span class="token number">7</span> <span class="token number">22</span>:14 named.ca
-rw-r----- <span class="token number">1</span> root  named  <span class="token number">152</span> Jul  <span class="token number">7</span> <span class="token number">22</span>:14 named.empty
-rw-r----- <span class="token number">1</span> root  named  <span class="token number">152</span> Jul  <span class="token number">7</span> <span class="token number">22</span>:14 named.localhost
-rw-r----- <span class="token number">1</span> root  named  <span class="token number">168</span> Jul  <span class="token number">7</span> <span class="token number">22</span>:14 named.loopback
drwxrwx--- <span class="token number">2</span> named named <span class="token number">4096</span> Jul  <span class="token number">7</span> <span class="token number">22</span>:14 slaves
<span class="token punctuation">[</span>root@centos8 named<span class="token punctuation">]</span><span class="token variable">$vim</span> magedu.local.zone
<span class="token comment"># 修改magedu.local.zone为以下内容：</span>
<span class="token variable">$TTL</span> 1D
@ 	IN 	SOA 	master 	admin.magedu.org. <span class="token punctuation">(</span>		<span class="token punctuation">;</span>master 会自动补全 master.magedu.local
									<span class="token number">0</span> <span class="token punctuation">;</span> serial
									1D <span class="token punctuation">;</span> refresh
									1H <span class="token punctuation">;</span> retry
									1W <span class="token punctuation">;</span> expire
									3H <span class="token punctuation">)</span> <span class="token punctuation">;</span> minimum
		NS 		master
master 	A 		<span class="token number">10.0</span>.0.175
www 	A 		<span class="token number">10.0</span>.0.8</code></pre>

<h3 id="4-检查配置文件和数据库文件格式，并启动服务"><a href="#4-检查配置文件和数据库文件格式，并启动服务" class="headerlink" title="4. 检查配置文件和数据库文件格式，并启动服务"></a>4. 检查配置文件和数据库文件格式，并启动服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 named<span class="token punctuation">]</span><span class="token variable">$named</span>-checkconf
<span class="token punctuation">[</span>root@centos8 named<span class="token punctuation">]</span><span class="token variable">$named</span>-checkzone magedu.local.zone /var/named/magedu.local.zone
zone magedu.local.zone/IN: loaded serial <span class="token number">0</span>
OK
<span class="token comment"># systemctl start named 第一次启动服务</span>
<span class="token comment"># rndc reload 不是第一次启动服务</span>
<span class="token punctuation">[</span>root@centos8 named<span class="token punctuation">]</span><span class="token variable">$rndc</span> reload
server reload successful</code></pre>

<h3 id="5-实现-WEB-服务"><a href="#5-实现-WEB-服务" class="headerlink" title="5. 实现 WEB 服务"></a>5. 实现 WEB 服务</h3><p>在 web 服务器 10.0.0.8 执行以下命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'www.magedu.local'</span> <span class="token operator">></span> /var/www/html/index.html</code></pre>

<h3 id="6-在客户端实现测试"><a href="#6-在客户端实现测试" class="headerlink" title="6. 在客户端实现测试"></a>6. 在客户端实现测试</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加DNS从服务器ip到/etc/resolv.conf</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/resolv.conf
<span class="token comment"># Generated by NetworkManager</span>
search magedu.org
nameserver <span class="token number">10.0</span>.0.175

<span class="token comment"># dig</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token variable">$dig</span> www.magedu.local

<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> DiG <span class="token number">9.11</span>.4-P2-RedHat-9.11.4-16.P2.el7_8.6 <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> www.magedu.local
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: .local is reserved <span class="token keyword">for</span> Multicast DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> You are currently testing what happens when an mDNS query is leaked to DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">48252</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">1</span>, AUTHORITY: <span class="token number">1</span>, ADDITIONAL: <span class="token number">2</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">4096</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>www.magedu.local.              IN      A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
www.magedu.local.       <span class="token number">86400</span>   IN      A       <span class="token number">10.0</span>.0.8

<span class="token punctuation">;</span><span class="token punctuation">;</span> AUTHORITY SECTION:
magedu.local.           <span class="token number">86400</span>   IN      NS      master.magedu.local.

<span class="token punctuation">;</span><span class="token punctuation">;</span> ADDITIONAL SECTION:
master.magedu.local.    <span class="token number">86400</span>   IN      A       <span class="token number">10.0</span>.0.175

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">1</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">10.0</span>.0.175<span class="token comment">#53(10.0.0.175)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Thu Sep <span class="token number">17</span> <span class="token number">19</span>:11:55 CST <span class="token number">2020</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">98</span>

<span class="token comment"># 能ping通</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token variable">$ping</span> www.magedu.local
PING www.magedu.local <span class="token punctuation">(</span><span class="token number">10.0</span>.0.8<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.0.8 <span class="token punctuation">(</span><span class="token number">10.0</span>.0.8<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.549</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.0.8 <span class="token punctuation">(</span><span class="token number">10.0</span>.0.8<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.664</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.0.8 <span class="token punctuation">(</span><span class="token number">10.0</span>.0.8<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.838</span> ms
^C
--- www.magedu.local <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 2003ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.549</span>/0.683/0.838/0.122 ms

<span class="token comment"># 能访问</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token variable">$curl</span> www.magedu.local
www.magedu.local</code></pre>

<p>查看 web 服务器查的 http 访问记录：</p>
<pre class="language-none"><code class="language-none">[root@centos8 httpd]$cat &#x2F;dev&#x2F;null &gt; access_log
[root@centos8 httpd]$tail -f access_log
10.0.0.57 - - [17&#x2F;Sep&#x2F;2020:07:47:55 -0400] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 17 &quot;-&quot; &quot;curl&#x2F;7.29.0&quot;</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/DNS/%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9FDNS%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/DNS/%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9FDNS%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">域名系统DNS服务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-04 15:21:56" itemprop="dateCreated datePublished" datetime="2021-02-04T15:21:56+08:00">2021-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/DNS/" itemprop="url" rel="index"><span itemprop="name">DNS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="DNS-相关概念和技术"><a href="#DNS-相关概念和技术" class="headerlink" title="DNS 相关概念和技术"></a>DNS 相关概念和技术</h2><img data-src="//img.to2b.cn/blog/ljk/1600324177530.png" style="zoom:80%;" />

<img data-src="//img.to2b.cn/blog/ljk/1600307364243.png" style="zoom:80%;" />

<h3 id="DNS-查询类型"><a href="#DNS-查询类型" class="headerlink" title="DNS 查询类型"></a>DNS 查询类型</h3><ul>
<li>递归查询：一般客户机和本地 DNS 服务器之间属于递归查询。如果本地 DNS 服务器本身不能解析，则本地 DNS 服务器向其他 DNS 服务器发起发出查询请求。</li>
<li>迭代查询：一般情况下(有例外)本地的 DNS 服务器向其它 DNS 服务器的查询属于迭代查询。如果其他 DNS 服务器也不能解析，则本地 DNS 服务器再向下一个 DNS 服务器发出查询请求。</li>
</ul>
<h3 id="名称服务器"><a href="#名称服务器" class="headerlink" title="名称服务器"></a>名称服务器</h3><p>Name Server：域内负责解析本域内的名称的 DNS 服务器</p>
<h3 id="完整的查询请求经过的流程"><a href="#完整的查询请求经过的流程" class="headerlink" title="完整的查询请求经过的流程"></a>完整的查询请求经过的流程</h3><pre class="language-latex" data-language="latex"><code class="language-latex">Client -->hosts文件 --> Client DNS Service Local Cache --> DNS Server (递归) --> DNS Server Cache -->DNS iteration(迭代) --> 根--> 顶级域名DNS-->二级域名DNS…</code></pre>

<h3 id="DNS-服务器类型"><a href="#DNS-服务器类型" class="headerlink" title="DNS 服务器类型"></a>DNS 服务器类型</h3><ul>
<li><p>主 DNS 服务器</p>
<p>管理和维护所负责解析的域内解析库的服务器</p>
</li>
<li><p>从 DNS 服务器</p>
<p>从主服务器或从服务器“复制”（区域传输）解析库副本。</p>
<ul>
<li>序列号：解析库版本号，主服务器解析库变化时，其序列递增</li>
<li>刷新时间间隔：从服务器从主服务器请求同步解析的时间间隔</li>
<li>重试时间间隔：从服务器请求同步失败时，再次尝试时间间隔</li>
<li>过期时长：从服务器联系不到主服务器时，多久后停止服务</li>
<li>通知机制：主服务器解析库发生变化时，会主动通知从服务器</li>
</ul>
</li>
<li><p>缓存 DNS 服务器（转发器）</p>
</li>
</ul>
<h3 id="区域传输"><a href="#区域传输" class="headerlink" title="区域传输"></a>区域传输</h3><ul>
<li>完全传输：传送整个解析库</li>
<li>增量传输：传递解析库变化的那部分内容</li>
</ul>
<h3 id="解析类型"><a href="#解析类型" class="headerlink" title="解析类型"></a>解析类型</h3><ul>
<li>FQDN（ Fully Qualified Domain Name） –&gt; IP：正向解析</li>
<li>IP –&gt; FQDN：反向解析</li>
</ul>
<p>注意：正反向解析是两个不同的名称空间，是两棵不同的解析树</p>
<h3 id="负责本地域名的正向和反向解析库"><a href="#负责本地域名的正向和反向解析库" class="headerlink" title="负责本地域名的正向和反向解析库"></a>负责本地域名的正向和反向解析库</h3><ul>
<li>正向区域</li>
<li>反向区域</li>
</ul>
<h3 id="解析答案"><a href="#解析答案" class="headerlink" title="解析答案"></a>解析答案</h3><ul>
<li>肯定答案：存在对应的查询结果</li>
<li>否定答案：请求的条目不存在等原因导致无法返回结果</li>
<li>权威答案：直接由存有此查询结果的 DNS 服务器（权威服务器）返回的答案</li>
<li>非权威答案：由其它非权威服务器返回的查询答案</li>
</ul>
<h3 id="资源记录定义格式"><a href="#资源记录定义格式" class="headerlink" title="资源记录定义格式"></a>资源记录定义格式</h3><pre class="language-ini" data-language="ini"><code class="language-ini">name [TTL] IN rr_type value</code></pre>

<ul>
<li>name：zone 的名称，是一个 FQDN，通常使用@来表示；zone 的名称可以定义变量$ORIGIN来表示，优先继承$ORIGIN</li>
<li>TTL：可从全局继承</li>
<li>IN：表示记录类型属于 Internet 类别</li>
<li>rr_type：resource record 资源记录</li>
<li>value：根据资源记录类型的不同，value 也不同</li>
</ul>
<p>同一个名字可以通过多条记录定义多个不同的值；此时 DNS 服务器会以轮询方式响应</p>
<p>同一个值也可能有多个不同的定义名字；通过多个不同的名字指向同一个值进行定义；此仅表示通过多个不同的名字可以找到同一个主机</p>
<h3 id="各种资源记录"><a href="#各种资源记录" class="headerlink" title="各种资源记录"></a>各种资源记录</h3><p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26711103/article/details/82873550">https://blog.csdn.net/qq_26711103/article/details/82873550</a></p>
<p>区域解析库：由众多资源记录 RR（Resource Record）组成</p>
<h4 id="SOA"><a href="#SOA" class="headerlink" title="SOA"></a>SOA</h4><p>Start Of Authority：起始授权记录，一个区域解析库有且仅能有一个 SOA 记录，必须位于解析库的第一条记录</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">;</span> zone <span class="token function">file</span> fragment <span class="token keyword">for</span> mytest.cn
    <span class="token punctuation">;</span><span class="token variable">$TTL</span> <span class="token number">600</span>
    <span class="token variable">$ORIGIN</span> mytest.cn.
    <span class="token punctuation">;</span> SOA record
    <span class="token punctuation">;</span> owner-name ttl class rr      name-server      email-addr  <span class="token punctuation">(</span>sn ref ret ex min<span class="token punctuation">)</span>
    @                 IN   SOA     ns1.mytest.cn.   root.mytest.cn. <span class="token punctuation">(</span>
                                                                    <span class="token number">0</span>	<span class="token punctuation">;</span> serial
                                                                    1D	<span class="token punctuation">;</span> refresh
                                                                    1H	<span class="token punctuation">;</span> retry
                                                                    1W	<span class="token punctuation">;</span> expire
                                                                    3H <span class="token punctuation">)</span>	<span class="token punctuation">;</span> minimum

<span class="token comment"># M：分钟；H：小时；D：天；W：周</span></code></pre>

<ul>
<li><p>owner-name：当前域的名称，通常用 @ 来表示，优先继承$ORIGIN</p>
</li>
<li><p>value：可以设置多个值，本例中设置了三个值，依次为：</p>
<ol>
<li><p>name-server：当前域的主 DNS 服务器的 FQDN，形式为 xxx.ower-name，ower-name 可以省略，例如这里<code>ns1.mytest.cn.</code>还可以写成<code>ns1</code>，下面得配合一条 A 记录把它解析成 ip</p>
</li>
<li><p>email-addr：负责此区域的人员的电子邮件地址，因为@在这里有特殊意义，所以用.替代。所以上面的<code>root.mytest.cn.</code>实际上是<code>root.mytest@cn.</code></p>
</li>
<li><p>主从服务区域传输相关定义</p>
<ol>
<li>serial<br>序列号 – Serial，每次变更区域内容时数值+1，以通知 slave 同步数据。值范围 1 ~ 4294967295，最大增量 2147483647</li>
<li>refresh<br>更新频率 – Refresh，slave 主动向 master 更新。建议 1200 ~ 43200 秒</li>
<li>retry<br>重试时间 – Retry，当 slave 同步数据失败，多少时间内会再次重试同步。典型值为 180（3 分钟）至 900（15 分钟）或更高。</li>
<li>expire<br>失效时间(Expire)，一直尝试的失败时间，持续到这个设定值，指示区域数据不再具有权威性。建议 1209600 ~ 2419200 秒 (2-4 weeks)</li>
<li>minimum<br>bind9 开始将此值重新定义为负缓存时间。任何解析器都可以缓存 NAME ERROR &#x3D; NXDOMAIN 结果的时间。允许的最大值是 3 hours (10800 seconds).</li>
</ol>
</li>
</ol>
</li>
</ul>
<h4 id="NS"><a href="#NS" class="headerlink" title="NS"></a>NS</h4><p>Name Server，专用于标明当前区域的 DNS 服务器，范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># name [TTL] IN rr_type value</span>
<span class="token comment"># name: 当前区域的名字</span>
<span class="token comment"># value: 当前区域的某DNS服务器的名字，例如ns.magedu.org</span>
magedu.org.   IN  NS  ns1.magedu.org.
magedu.org.   IN  NS  ns2.magedu.org.</code></pre>

<p>注意：</p>
<ol>
<li>相邻的两个资源记录的 name 相同时，后续的可省略</li>
<li>对 NS 记录而言，任何一个 ns 记录后面的服务器名字，都应该在后续有一个 A 记录</li>
<li>一个区域可以有多个 NS 记录</li>
</ol>
<h4 id="MX"><a href="#MX" class="headerlink" title="MX"></a>MX</h4><p>Mail eXchanger，邮件交换器，范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># name [TTL] IN rr_type value</span>
<span class="token comment"># name: 当前区域的名字</span>
<span class="token comment"># value: 当前区域的某邮件服务器(smtp服务器)的主机名</span>
magedu.org.   IN  MX  10  mx1.magedu.org.
              IN  MX  20  mx2.magedu.org.
mx1               A 10.0.0.100
mx2               A 10.0.0.200</code></pre>

<p>注意：</p>
<ol>
<li>一个区域内，MX 记录可有多个；但每个记录的 value 之前应该有一个数字(0-99)，表示此服务器的优先级；数字越小优先级越高</li>
<li>对 MX 记录而言，任何一个 MX 记录后面的服务器名字，都应该在后续有一个 A 记录</li>
</ol>
<h4 id="A"><a href="#A" class="headerlink" title="A"></a>A</h4><p>internet Address，作用：FQDN –&gt; IP，范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># name: 某主机的FQDN，例如：www.magedu.org.</span>
<span class="token comment"># value: 主机名对应主机的IP地址</span>
<span class="token comment"># 避免用户写错名称时给错误答案，可通过泛域名解析进行解析至某特定地址</span>
www.magedu.org.         IN  A   1.1.1.1
www.magedu.org.         IN  A   2.2.2.2
mx1.magedu.org.         IN  A   3.3.3.3
mx2.magedu.org.         IN  A   4.4.4.4
$GENERATE 1-254 HOST$   IN  A   1.2.3.$
*.magedu.org.           IN  A   5.5.5.5
magedu.org.             IN  A   6.6.6.6</code></pre>

<h4 id="AAAA"><a href="#AAAA" class="headerlink" title="AAAA"></a>AAAA</h4><p>FQDN –&gt; IPv6</p>
<pre class="language-none"><code class="language-none">name: FQDN
value: IPv6</code></pre>

<h4 id="PTR"><a href="#PTR" class="headerlink" title="PTR"></a>PTR</h4><p>PoinTeR，IP –&gt; FQDN，范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># name: IP，有特定格式，把IP地址反过来写，1.2.3.4，要写作4.3.2.1；而有特定后缀：in-addr.arpa.，所以完整写法为：4.3.2.1.in-addr.arpa.</span>
<span class="token comment"># value: FQDN</span>
4.3.2.1.in-addr.arpa. 	IN 	PTR 	www.magedu.org.
<span class="token comment"># 网络地址及后缀可省略；主机地址依然需要反着写，如1.2.3为网络地址，可简写成：</span>
4 						IN 	PTR 	www.magedu.org.</code></pre>

<h4 id="CNAME"><a href="#CNAME" class="headerlink" title="CNAME"></a>CNAME</h4><p>Canonical Name，别名记录，范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># name: 别名的FQDN</span>
<span class="token comment"># value: 真正名字的FQDN</span>
www.magedu.org. IN CNAME websrv.magedu.org.</code></pre>

<h4 id="TXT"><a href="#TXT" class="headerlink" title="TXT"></a>TXT</h4><p>对域名进行标识和说明的一种方式，一般做验证记录时会使用此项，如：SPF（反垃圾邮件）记录，https 验证等。范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini">_dnsauth TXT 2012011200000051qgs69bwoh4h6nht4n1h0lr038x</code></pre>

<h3 id="子域授权"><a href="#子域授权" class="headerlink" title="子域授权"></a>子域授权</h3><p>每个域的名称服务器，都是通过其上级名称服务器在解析进行授权。</p>
<p>glue record：粘合记录，父域授权子域的记录。</p>
<p>范例：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini">.com. IN NS ns1.com.
.com. IN NS ns2.com.
ns1.com. IN A 2.2.2.1
ns2.com. IN A 2.2.2.</code></pre>

<h3 id="互联网域名"><a href="#互联网域名" class="headerlink" title="互联网域名"></a>互联网域名</h3><p>注册，备案，解析。。。</p>
<h2 id="DNS-软件-bind"><a href="#DNS-软件-bind" class="headerlink" title="DNS 软件 bind"></a>DNS 软件 bind</h2><p>DNS 服务器软件：bind、powerdns、dnsmasq、unbound、coredns</p>
<h3 id="bind-相关程序包"><a href="#bind-相关程序包" class="headerlink" title="bind 相关程序包"></a>bind 相关程序包</h3><ul>
<li>bind：服务端</li>
<li>bind-libs：相关库</li>
<li>bind-utils：客户端</li>
<li>bind-chroot：安全包，默认将 dns 相关文件放至&#x2F;var&#x2F;named&#x2F;chroot</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#dnf -y install bind bind-utils</span></code></pre>

<h3 id="bind-相关文件"><a href="#bind-相关文件" class="headerlink" title="bind 相关文件"></a>bind 相关文件</h3><ul>
<li>bind 主程序：&#x2F;usr&#x2F;sbin&#x2F;named。bind 的主程序是 named，不同名，有点小奇怪</li>
<li>服务脚本和 Unit 名称：&#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;named、&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;named.service</li>
<li>主配置文件：&#x2F;etc&#x2F;named.conf、etc&#x2F;named.rfc1912.zones、&#x2F;etc&#x2F;rndc.key</li>
<li>管理工具：&#x2F;usr&#x2F;sbin&#x2F;rndc：remote name domain controller，默认与 bind 安装在同一主机，且只能通过 127.0.0.1 连接 name 进程，提供辅助性的管理功能，953&#x2F;tcp</li>
<li>解析库文件：&#x2F;var&#x2F;named&#x2F;ZONE_NAME.ZONE<ul>
<li>一台物理服务器可同时为多个区域提供解析</li>
<li>必须要有根区域文件：named.ca</li>
<li>应该有两个（如果是 ipv6，则更多）实现 localhost 和本地回环地址的解析库</li>
</ul>
</li>
</ul>
<h3 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h3><ul>
<li><p>全局配置：options {}</p>
</li>
<li><p>日志子系统配置：logging {}</p>
</li>
<li><p>区域配置：本机能够为哪些 zone 进行解析，就要被定义哪些 zone</p>
<pre class="language-none"><code class="language-none">zone “ZONE_NAME” IN &#123;&#125;</code></pre></li>
</ul>
<p>注意：</p>
<ul>
<li>任何服务器程序如果期望能够通过网络被其他主机访问，至少应该监听在一个能与外部主机通信的 IP 地址上</li>
<li>缓存名称服务器配置：监听外部地址即可</li>
<li>dnssec：建议关闭 dnssc，设为 no</li>
</ul>
<h2 id="实现-DNS-服务器"><a href="#实现-DNS-服务器" class="headerlink" title="实现 DNS 服务器"></a>实现 DNS 服务器</h2><h3 id="主-DNS-服务器配置"><a href="#主-DNS-服务器配置" class="headerlink" title="主 DNS 服务器配置"></a>主 DNS 服务器配置</h3><h4 id="1-定义区域"><a href="#1-定义区域" class="headerlink" title="1. 定义区域"></a>1. 定义区域</h4><p>主 DNS 服务器配置文件：&#x2F;etc&#x2F;named.conf，示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#注释掉下面两行</span>
// listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
// allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment"># 添加区域</span>
zone <span class="token string">"ZONE_NAME"</span> IN <span class="token punctuation">&#123;</span>
	<span class="token builtin class-name">type</span> <span class="token punctuation">&#123;</span>master<span class="token operator">|</span> slave <span class="token operator">|</span> hint <span class="token operator">|</span> forward<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token function">file</span> <span class="token string">"ZONE_NAME.zone"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ul>
<li>listen-on port：监听的地址和端口。注释掉和将<code>127.0.0.1;</code>修改为<code>localhost;</code>效果是一样的，设置<code>127.0.0.1</code>则只会监听地址 127.0.0.1，而注释掉或者设置为 localhost 则监听所有本机地址</li>
<li>allow-query：允许谁向此 DNS 进行查询。注释掉和修改<code>localhost;</code>为<code>any;</code>效果是一样的，设置<code>localhost</code>则允许本机的 ip 地址列表</li>
</ul>
<h4 id="2-定义区域解析库文件"><a href="#2-定义区域解析库文件" class="headerlink" title="2. 定义区域解析库文件"></a>2. 定义区域解析库文件</h4><p>默认位置：&#x2F;var&#x2F;named&#x2F;目录下；</p>
<p>内容包括两部分：宏定义 和 资源记录，范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$TTL</span> <span class="token number">86400</span>
<span class="token variable">$ORIGIN</span> magedu.org.
@ 		IN 	SOA 	ns1.magedu.org. 	admin.magedu.org <span class="token punctuation">(</span>
														<span class="token number">2015042201</span>
														1H
														5M
														7D
														1D <span class="token punctuation">)</span>
		IN 	NS	 	ns1
		IN 	NS	 	ns2
		IN 	MX	 	<span class="token number">10</span> 					mx1
		IN 	MX	 	<span class="token number">20</span> 					mx2
ns1 	IN 	A 		<span class="token number">172.16</span>.100.11
ns2 	IN 	A 		<span class="token number">172.16</span>.100.12
mx1 	IN 	A 		<span class="token number">172.16</span>.100.13
mx2 	IN 	A 		<span class="token number">172.16</span>.100.14
websrv 	IN 	A 		<span class="token number">172.16</span>.100.11
websrv 	IN 	A 		<span class="token number">172.16</span>.100.12
www 	IN 	CNAME 	websrv</code></pre>

<h4 id="3-主配置文件语法检查"><a href="#3-主配置文件语法检查" class="headerlink" title="3. 主配置文件语法检查"></a>3. 主配置文件语法检查</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$named</span>-checkconf</code></pre>

<h4 id="4-主配置文件语法检查"><a href="#4-主配置文件语法检查" class="headerlink" title="4. 主配置文件语法检查"></a>4. 主配置文件语法检查</h4><pre class="language-bash" data-language="bash"><code class="language-bash">named-checkzone <span class="token punctuation">[</span>options<span class="token punctuation">]</span> zonename filename</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$named</span>-checkzone <span class="token string">"magedu.org"</span> /var/named/magedu.org.zone</code></pre>

<h4 id="5-配置生效"><a href="#5-配置生效" class="headerlink" title="5. 配置生效"></a>5. 配置生效</h4><p>三种方式：</p>
<ul>
<li><code>rndc reload</code></li>
<li><code>systemctl reload named</code></li>
<li><code>service named reload</code></li>
</ul>
<h4 id="测试和管理工具"><a href="#测试和管理工具" class="headerlink" title="测试和管理工具"></a>测试和管理工具</h4><h5 id="dig"><a href="#dig" class="headerlink" title="dig"></a>dig</h5><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> bind-utils</code></pre>

<p>dig 只用于测试 dns 系统，不会查询 hosts 文件进行解析</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">dig</span> <span class="token punctuation">[</span>-t type<span class="token punctuation">]</span> name <span class="token punctuation">[</span>@SERVER<span class="token punctuation">]</span> <span class="token punctuation">[</span>query options<span class="token punctuation">]</span></code></pre>

<ul>
<li><p>-t：要查询的资源记录类型。默认 A，除了 AAAA、NS 这一类，还可以是 axfr（全区域传输） 和 ixfr（增量区域传输）。</p>
</li>
<li><p>query options：</p>
<p>+[no]trace：跟踪解析过程 : <code>dig +trace magedu.org</code> +[no]recurse：进行递归解析</p>
</li>
</ul>
<h5 id="host"><a href="#host" class="headerlink" title="host"></a>host</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">host</span> <span class="token punctuation">[</span>-t type<span class="token punctuation">]</span> name <span class="token punctuation">[</span>SERVER<span class="token punctuation">]</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">host</span> <span class="token parameter variable">-t</span> NS magedu.org <span class="token number">172.16</span>.0.1
<span class="token function">host</span> <span class="token parameter variable">-t</span> soa magedu.org
<span class="token function">host</span> <span class="token parameter variable">-t</span> mx magedu.org
<span class="token function">host</span> <span class="token parameter variable">-t</span> axfr magedu.org
<span class="token function">host</span> <span class="token number">1.2</span>.3.4</code></pre>

<h5 id="nslookup"><a href="#nslookup" class="headerlink" title="nslookup"></a>nslookup</h5><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> bind-utils</code></pre>

<p>nslookup 可以支持交互和非交互式两种方式执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">nslookup</span> <span class="token punctuation">[</span>-option<span class="token punctuation">]</span> <span class="token punctuation">[</span>name <span class="token operator">|</span> -<span class="token punctuation">]</span> <span class="token punctuation">[</span>server<span class="token punctuation">]</span></code></pre>

<p>交互模式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nslookup<span class="token operator">></span>
	server IP: 指明使用哪个DNS server进行查询
	<span class="token builtin class-name">set</span> <span class="token assign-left variable">q</span><span class="token operator">=</span>RR_TYPE: 指明查询的资源记录类型
	NAME: 要查询的名称</code></pre>

<h5 id="rndc"><a href="#rndc" class="headerlink" title="rndc"></a>rndc</h5><p>利用 rndc 工具可以实现管理 DNS 功能，rndc 监听端口: 953&#x2F;tcp</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">rndc COMMAND</code></pre>

<ul>
<li>status: 查看状态</li>
<li>reload: 重载主配置文件和区域解析库文件</li>
<li>reload zonename: 重载区域解析库文件</li>
<li>retransfer zonename: 手动启动区域传送，而不管序列号是否增加</li>
<li>notify zonename: 重新对区域传送发通知</li>
<li>reconfig: 重载主配置文件</li>
<li>querylog: 开启或关闭查询日志文件&#x2F;var&#x2F;log&#x2F;message</li>
<li>trace: 递增 debug 一个级别</li>
<li>trace LEVEL: 指定使用的级别</li>
<li>notrace：将调试级别设置为 0</li>
<li>flush：清空 DNS 服务器的所有缓存记录</li>
</ul>
<h4 id="实战案例：实现-DNS-正向服务器"><a href="#实战案例：实现-DNS-正向服务器" class="headerlink" title="实战案例：实现 DNS 正向服务器"></a><a href="%E5%AE%9E%E9%AA%8C1%EF%BC%9ADNS%E6%AD%A3%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8.md">实战案例：实现 DNS 正向服务器</a></h4><h4 id="允许动态更新"><a href="#允许动态更新" class="headerlink" title="允许动态更新"></a>允许动态更新</h4><p>动态更新：可以通过远程更新区域数据库的资源记录，例如添加删除解析记录</p>
<p>实现动态更新，需要在指定的 zone 语句块中添加以下指令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">Allow-update <span class="token punctuation">&#123;</span>any<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h2 id="实现反向解析区域"><a href="#实现反向解析区域" class="headerlink" title="实现反向解析区域"></a>实现反向解析区域</h2><h2 id="实现从服务器"><a href="#实现从服务器" class="headerlink" title="实现从服务器"></a>实现从服务器</h2><p>只有一台主 DNS 服务器，存在单点失败的问题，可以建立主 DNS 服务器的备份服务器，即从服务器来实现 DNS 服务的容错机制。从服务器可以自动和主服务器进行单向的数据同步，从而和主 DNS 服务器一样，也可以对外提供查询服务，但从服务器不提供数据更新服务。</p>
<h3 id="DNS-从服务器"><a href="#DNS-从服务器" class="headerlink" title="DNS 从服务器"></a>DNS 从服务器</h3><ol>
<li>应该为一台独立的名称服务器</li>
<li>主服务器的区域解析库文件中必须有一条 NS 记录指向从服务器</li>
<li>从服务器只需要定义区域，而无须提供解析库文件；解析库文件应该放置于&#x2F;var&#x2F;named&#x2F;slaves&#x2F;目录中</li>
<li>主服务器得允许从服务器作区域传送</li>
<li>主从服务器时间应该同步，可通过 ntp 进行</li>
<li>bind 程序的版本应该保持一致；否则，应该从高，主低</li>
</ol>
<h3 id="定义从区域"><a href="#定义从区域" class="headerlink" title="定义从区域"></a>定义从区域</h3><p>格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">zone <span class="token string">"ZONE_NAME"</span> IN <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">type</span> slave<span class="token punctuation">;</span>
    masters <span class="token punctuation">&#123;</span> MASTER_IP<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">"slaves/ZONE_NAME.zone"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h3 id="实战案例：实现-DNS-从服务器"><a href="#实战案例：实现-DNS-从服务器" class="headerlink" title="实战案例：实现 DNS 从服务器"></a><a href="%E5%AE%9E%E9%AA%8C2%EF%BC%9ADNS%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8.md">实战案例：实现 DNS 从服务器</a></h3><h2 id="实现子域"><a href="#实现子域" class="headerlink" title="实现子域"></a>实现子域</h2><p>将子域委派给其他主机管理，实现分布 DNS 数据库</p>
<p>正向解析 DNS 区域子域方法，很简单，只需要配置两条资源记录，一条 NS，一条 A，范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">shanghai.magedu.local. 	      IN  NS  ns1.shanghai.magedu.local.
shanghai.magedu.local. 	      IN  NS  ns2.shanghai.magedu.local.
zhengzhou.magedu.local.       IN  NS  ns1.zhengzhou.magedu.local.
zhengzhou.magedu.local.       IN  NS  ns2.zhengzhou.magedu.local.
ns1.shanghai.magedu.local.    IN  A   <span class="token number">1.1</span>.1.1
ns2.shanghai.magedu.local.    IN  A   <span class="token number">1.1</span>.1.2
ns1.zhengzhou.magedu.local.   IN  A   <span class="token number">1.1</span>.1.3
ns2.zhengzhou.magedu.local.   IN  A   <span class="token number">1.1</span>.1.4</code></pre>

<h3 id="范例：实现-DNS-父域和子域服务"><a href="#范例：实现-DNS-父域和子域服务" class="headerlink" title="范例：实现 DNS 父域和子域服务"></a><a href="%E5%AE%9E%E9%AA%8C3%EF%BC%9ADNS%E5%AD%90%E5%9F%9F%E6%9C%8D%E5%8A%A1%E5%99%A8.md">范例：实现 DNS 父域和子域服务</a></h3><h2 id="实现-DNS-转发（缓存）服务器"><a href="#实现-DNS-转发（缓存）服务器" class="headerlink" title="实现 DNS 转发（缓存）服务器"></a>实现 DNS 转发（缓存）服务器</h2><p>利用 DNS 转发，可以将用户的 DNS 请求，转发至指定的 DNS 服务器，而非默认的根 DNS 服务器，并将指定服务器查询的返回结果进行缓存，提高效率</p>
<p>注意：被转发的服务器需要能够为请求者做递归，否则转发请求不予执行</p>
<p>转发方式有两种：全局转发 和 特定区域转发</p>
<p>全局转发：对非本机所负责解析区域的请求，全转发给指定的服务器</p>
<p>特定区域转发：仅转发对特定的区域的请求，比全局转发优先级高</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 无论全局转发还是特定区域转发，都需要关闭dnssec功能</span>
options <span class="token punctuation">&#123;</span>
    dnssec-enable no<span class="token punctuation">;</span>
    dnssec-validation no<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 全局转发</span>
options <span class="token punctuation">&#123;</span>
    forward first<span class="token operator">|</span>only<span class="token punctuation">;</span>
    forwarders <span class="token punctuation">&#123;</span> <span class="token function">ip</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment"># 特定区域转发</span>
zone <span class="token string">"ZONE_NAME"</span> IN <span class="token punctuation">&#123;</span>
<span class="token builtin class-name">type</span> forward<span class="token punctuation">;</span>
forward first<span class="token operator">|</span>only<span class="token punctuation">;</span>
forwarders <span class="token punctuation">&#123;</span> <span class="token function">ip</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ul>
<li>first：先转发至指定 DNS 服务器，如果无法解析查询请求，则本服务器再去根服务器查询</li>
<li>only：先转发至指定 DNS 服务器，如果无法解析查询请求，则本服务器将不再去根服务器查询</li>
</ul>
<p>[实战案例：实现 DNS forward（缓存）服务器](实验 4：DNS forward（缓存）服务器.md)</p>
<h2 id="智能-DNS"><a href="#智能-DNS" class="headerlink" title="智能 DNS"></a>智能 DNS</h2><h3 id="智能-DNS-相关技术"><a href="#智能-DNS-相关技术" class="headerlink" title="智能 DNS 相关技术"></a>智能 DNS 相关技术</h3><h4 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h4><p>ACL：把一个或多个地址归并为一个集合，并通过一个统一的名称调用，简单说就是对发起 dns 解析请求的客户端的 ip 进行分类，通常会根据省市地区进行分类</p>
<p>注意：只能先定义后使用；因此需要定义在 options 前面</p>
<p>格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">acl acl_name <span class="token punctuation">&#123;</span>
	<span class="token comment"># 可以是具体ip，也可以网段</span>
    <span class="token function">ip</span><span class="token punctuation">;</span>
    net/prelen<span class="token punctuation">;</span>
    <span class="token punctuation">..</span>.
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">..</span>.
options <span class="token punctuation">&#123;</span><span class="token punctuation">..</span>.<span class="token punctuation">&#125;</span></code></pre>

<p>bind 内置 4 个 acl：none、any、localhost、localnet</p>
<ul>
<li>none：没有一个主机</li>
<li>any：任意主机</li>
<li>localhost：本机</li>
<li>localnet：本机的 IP 同掩码运算后得到的网络地址</li>
</ul>
<h4 id="访问控制指令"><a href="#访问控制指令" class="headerlink" title="访问控制指令"></a>访问控制指令</h4><ul>
<li>allow-query {}： 允许查询的主机；白名单</li>
<li>allow-transfer {}：允许区域传送的主机；白名单</li>
<li>allow-recursion {}: 允许递归的主机,建议全局使用</li>
<li>allow-update {}: 允许更新区域数据库中的内容</li>
</ul>
<p>{}中填入的就是 acl，范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">allow-query <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>		<span class="token comment"># 只处理来自本机的dns解析请求</span></code></pre>

<h4 id="view"><a href="#view" class="headerlink" title="view"></a>view</h4><p>视图，将 ACL 和区域数据库实现对应关系，以实现智能 DNS</p>
<p>view 格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 一个bind服务器可定义多个view，每个view只能匹配一个acl</span>
<span class="token comment"># 客户端请求到达时，自上而下检查view中的acl</span>
<span class="token comment"># 当请求者的ip能被acl匹配到，则使用所在view中的zone数据库，处理其dns解析请求</span>
view VIEW_NAME <span class="token punctuation">&#123;</span>
	match-clients <span class="token punctuation">&#123;</span> acl_name<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>	<span class="token comment"># match-clients 只能匹配一个acl</span>
	zone <span class="token string">"ZONE_NAME"</span> <span class="token punctuation">&#123;</span>
		<span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
		<span class="token function">file</span> <span class="token string">"ZONE_FILE"</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	include <span class="token string">"/etc/named.rfc1912.zones"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment"># 来自上海的ip，则匹配到对应的zone数据库</span>
view VIEW_NAME <span class="token punctuation">&#123;</span>
	match-clients <span class="token punctuation">&#123;</span> shanghainet<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>		<span class="token comment"># shanghainet是已经定义的acl</span>
	zone <span class="token string">"magedu.local"</span> <span class="token punctuation">&#123;</span>
		<span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
		<span class="token function">file</span> <span class="token string">"magedu.local.zone.sh"</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	include <span class="token string">"/etc/named.rfc1912.zones"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ul>
<li>ACL 定义在 options 之前，view 定义在 options 之后</li>
<li>一旦启用了 view，所有的 zone 都只能定义在 view 中</li>
<li>仅在允许递归请求的客户端所在 view 中定义根区域</li>
</ul>
<h4 id="实战案例：利用-view-实现智能-DNS"><a href="#实战案例：利用-view-实现智能-DNS" class="headerlink" title="实战案例：利用 view 实现智能 DNS"></a><a href="%E5%AE%9E%E9%AA%8C5%EF%BC%9A%E5%88%A9%E7%94%A8view%E5%AE%9E%E7%8E%B0%E6%99%BA%E8%83%BDDNS.md">实战案例：利用 view 实现智能 DNS</a></h4><h3 id="借助智能-DNS-实现的技术"><a href="#借助智能-DNS-实现的技术" class="headerlink" title="借助智能 DNS 实现的技术"></a>借助智能 DNS 实现的技术</h3><h4 id="GSLB"><a href="#GSLB" class="headerlink" title="GSLB"></a>GSLB</h4><p>Global Server Load Balance 全局负载均衡</p>
<p>GSLB 是对服务器和链路进行综合判断来决定由哪个地点的服务器来提供服务，实现异地服务器群服务质量的保证</p>
<p>GSLB 主要的目的是在整个网络范围内将用户的请求定向到最近的节点（或者区域）</p>
<p>GSLB 分为基于 DNS 实现、基于重定向实现、基于路由协议实现，其中最通用的是基于 DNS 解析方式</p>
<h4 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h4><ol>
<li><p>用户向浏览器输入<a target="_blank" rel="noopener" href="http://www.a.com这个域名,浏览器第一次发现本地没有dns缓存,则向网站的dns服务器请求/">www.a.com这个域名，浏览器第一次发现本地没有dns缓存，则向网站的DNS服务器请求</a></p>
</li>
<li><p>网站的 DNS 域名解析器设置了 CNAME，指向了<a target="_blank" rel="noopener" href="http://www.a.tbcdn.com,请求指向了cdn网络中的智能dns负载均衡系统/">www.a.tbcdn.com,请求指向了CDN网络中的智能DNS负载均衡系统</a></p>
</li>
<li><p>智能 DNS 负载均衡系统解析域名，把对用户响应速度最快的 IP 节点返回给用户；</p>
</li>
<li><p>用户向该 IP 节点（CDN 服务器）发出请求</p>
</li>
<li><p>由于是第一次访问，CDN 服务器会通过 Cache 内部专用 DNS 解析得到此域名的原 web 站点 IP，向原站点服务器发起请求，并在 CDN 服务器上缓存内容</p>
</li>
<li><p>请求结果发给用户</p>
</li>
</ol>
<h2 id="DNS-排错"><a href="#DNS-排错" class="headerlink" title="DNS 排错"></a>DNS 排错</h2><pre class="language-bash" data-language="bash"><code class="language-bash">SERVFAIL:The nameserver encountered a problem <span class="token keyword">while</span> processing the query.
<span class="token comment"># 可使用dig +trace排错，可能是网络和防火墙导致</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">NXDOMAIN：The queried name does not exist <span class="token keyword">in</span> the zone.
<span class="token comment"># 可能是CNAME对应的A记录不存在导致</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">REFUSED：The nameserver refused the client's DNS request due to policy restrictions.
<span class="token comment"># 可能是DNS策略导致</span></code></pre>

<h2 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a><a href="%E7%BB%BC%E5%90%88%E5%AE%9E%E9%AA%8C.md">实战案例</a></h2><p>综合案例：实现 inertnet 的 DNS 服务架构</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/%E6%BA%90%E7%A0%81/PHP%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/%E6%BA%90%E7%A0%81/PHP%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">PHP垃圾回收机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-02 22:29:09" itemprop="dateCreated datePublished" datetime="2021-02-02T22:29:09+08:00">2021-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h2><ol>
<li>每个内存对象都分配一个计数器，当内存对象被变量引用时，计数器+1</li>
<li>当变量引用撤掉后，计数器-1</li>
<li>定期检查各内存对象的计数器，如果计数器&#x3D;0，表明内存对象没有被使用，该内存对象则进行销毁</li>
<li>垃圾回收完成</li>
</ol>
<h2 id="四色标记"><a href="#四色标记" class="headerlink" title="四色标记"></a>四色标记</h2><p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>?php
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment"># 计数器 = 1</span>
<span class="token variable">$a</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">;</span>		<span class="token comment"># 计数器 = 2</span>

unset<span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment"># 计数器 = 1</span></code></pre>

<p>对象和数组，有循环引用的问题，针对这两种数据类型，采用四色标记法进行垃圾回收</p>
<p>黑色：正常数据<br>紫色：疑似垃圾<br>灰色：<br>白色：垃圾</p>
<ol>
<li>将计数器 -1 过并且目前不为 0 的数组放到缓冲区，并将其标记为紫色</li>
<li>对缓冲区中的数组进行<strong>深度遍历</strong>，将<strong>紫色的元素</strong>标记为灰色，并计数器 -1<br>注意：只对元素进行标灰、-1 操作</li>
<li>再次深度扫描，检查灰色的元素，如果计数器不为 0，将其标记为黑色并计数器+1（上一步有-1 操作），如果计数器为 0，将其标记为白色</li>
<li>扫描数组，黑色的元素从缓冲区中移除，白色的元素计数器+1 并移到 to_free 列表</li>
<li>清除 to_free，完成垃圾回收</li>
</ol>
<p>简单说：将疑似垃圾的数组的元素的计数器-1，&#x3D;0 说明为垃圾，≠0 说明不是垃圾</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/PHP/%E6%BA%90%E7%A0%81/%E5%85%A8%E6%96%B9%E4%BD%8D%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90PHP7%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PHP/%E6%BA%90%E7%A0%81/%E5%85%A8%E6%96%B9%E4%BD%8D%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90PHP7%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">全方位深度剖析PHP7底层源码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-02 18:25:46" itemprop="dateCreated datePublished" datetime="2021-02-02T18:25:46+08:00">2021-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP/%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">源码</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img data-src="//img.to2b.cn/blog/ljk/1612261476200.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/TomCat/tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/TomCat/tomcat/" class="post-title-link" itemprop="url">tomcat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-01 01:24:48" itemprop="dateCreated datePublished" datetime="2021-02-01T01:24:48+08:00">2021-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/TomCat/" itemprop="url" rel="index"><span itemprop="name">TomCat</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="JAVA-基础"><a href="#JAVA-基础" class="headerlink" title="JAVA 基础"></a>JAVA 基础</h2><h3 id="Java-动态网页技术"><a href="#Java-动态网页技术" class="headerlink" title="Java 动态网页技术"></a>Java 动态网页技术</h3><h4 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h4><p>就是前端代码和 java 代码混合的 java 文件，<code>hello.java</code> 示例：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
    message <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//响应报文内容类型</span>
    <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//构建响应报文内容</span>
    out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;h1>"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"&lt;/h1>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;p>&lt;a href=http://blog.lujinkai.cn/>LJKのBlog&lt;/a>欢迎你&lt;/p>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

<h4 id="jsp-Java-Server-Pages"><a href="#jsp-Java-Server-Pages" class="headerlink" title="jsp (Java Server Pages)"></a>jsp (Java Server Pages)</h4><p>jsp 是 html 模板，后缀是 jsp，<code>hello.jsp</code> 示例：</p>
<pre class="language-jsp" data-language="jsp"><code class="language-jsp">&lt;%@ page language&#x3D;&quot;java&quot; contentType&#x3D;&quot;text&#x2F;html; charset&#x3D;UTF-8&quot;
pageEncoding&#x3D;&quot;UTF-8&quot;%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;
    &lt;title&gt;jsp示例&lt;&#x2F;title&gt;
&lt;&#x2F;head&gt;
&lt;body&gt;
    &lt;%
    out.println(&quot;你的 IP 地址 &quot; + request.getRemoteAddr());
    %&gt;
&lt;&#x2F;body&gt;
&lt;&#x2F;html&gt;</code></pre>

<p>浏览器访问 jsp 文件：</p>
<ol>
<li>tomcat 会将 .jsp 文件转为 .java 文件（servlet 类文件）</li>
<li>servlet 类文件转为字节码文件（class 文件），</li>
<li>jvm 解析执行 class 文件</li>
</ol>
<p>例如：</p>
<pre class="language-none"><code class="language-none">hello.jsp --&gt; hello.java --&gt; hello.class --&gt; jvm执行hello.class</code></pre>

<h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><p><strong>JRE</strong>：Java Runtime Environment，指 Java 运行时环境， 包含 JVM + Java 核心类库<br><strong>JDK</strong>：Java Development Kit，即 Java 语言的软件开发工具包,JDK 协议基于 JRL（JavaResearch License）协议</p>
<p>简单地说，JRE 就是运行 Java 字节码的虚拟机。但是，如果只有 Java 源码，要编译成 Java 字节码，就需要 JDK，因为 JDK 除了包含 JRE，还提供了编译器、调试器等开发工具。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611972812220.png"></p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1665801418608.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611972852483.png"></p>
<img data-src="//img.to2b.cn/blog/ljk/1611972864242.png" style="zoom:67%;" />

<h4 id="Oracle-JDK"><a href="#Oracle-JDK" class="headerlink" title="Oracle JDK"></a>Oracle JDK</h4><p><img data-src="//img.to2b.cn/blog/ljk/1611973366044.png"></p>
<p>JDK 有很多版本，Oracle JDK 是官方版，也是用的最多的</p>
<p>Oracle JDK 早期称为 J2SE（标准版）、J2EE（企业版）、J2ME（微型版），现在叫做 JavaEE</p>
<p>早期的 Oracle JDK 的版本以 1.x 的方式命令：JDK 1.0、JDK 1.1、JDK 1.2、JDK 1.3、JDK 1.4</p>
<p>2004 年 9 月 30 日 18:00PM，J2SE1.5 发布，是 Java 语言的发展史上的又一里程碑事件。为了表示这个版本的重要性，J2SE1.5 更名为 J2SE5.0</p>
<p>2005 年 6 月，JavaOne 大会召开，SUN 公司公开 Java SE 6。此时，Java 的各种版本已经更名以取消其中的数字”2”：J2EE 更名为 Java EE, J2SE 更名为 Java SE，J2ME 更名为 Java ME</p>
<h4 id="Open-JDK"><a href="#Open-JDK" class="headerlink" title="Open JDK"></a>Open JDK</h4><p>Oracle JDK 收费，OpenJDK 是第三方版本的 JDK 中最常用的</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611974301614.png"></p>
<p>OpenJDK 7 是基于 JDK7 的 beta 版开发，但为了也将 Java SE 6 开源，从 OpenJDK7 的 b20 构建反向分支开发，从中剥离了不符合 Java SE 6 规范的代码，发布 OpenJDK 6。所以 OpenJDK6 和 JDK6 没什么关系，只是 API 兼容而已</p>
<p>相对来说,Oracle jDK 具有更好的响应能力和 JVM 性能，更加稳定</p>
<h2 id="Tomcat-基础"><a href="#Tomcat-基础" class="headerlink" title="Tomcat 基础"></a>Tomcat 基础</h2><p>tomcat 既是轻量级 web 服务器，可以处理 http 请求，又是 servlet 容器，可以处理 java 程序</p>
<p>tomcat 使用 java 开发，所以依赖 JRE 或者 JDK 环境</p>
<h3 id="安装-x2F-升级-x2F-回滚"><a href="#安装-x2F-升级-x2F-回滚" class="headerlink" title="安装&#x2F;升级&#x2F;回滚"></a>安装&#x2F;升级&#x2F;回滚</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载二进制包</span>
<span class="token punctuation">[</span>root@c71 src<span class="token punctuation">]</span><span class="token variable">$wget</span> https://mirrors.bfsu.edu.cn/apache/tomcat/tomcat-8/v8.5.61/bin/apache-tomcat-8.5.61.tar.gz
<span class="token comment"># 无需编译，解压即可使用</span>
<span class="token punctuation">[</span>root@c71 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf apache-tomcat-8.5.61.tar.gz
<span class="token punctuation">[</span>root@c71 src<span class="token punctuation">]</span><span class="token variable">$mv</span> apache-tomcat-8.5.61 /usr/local/tomcat
<span class="token comment"># 创建tomcat用户</span>
<span class="token punctuation">[</span>root@c71 src<span class="token punctuation">]</span><span class="token variable">$useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin tomcat
<span class="token punctuation">[</span>root@c71 src<span class="token punctuation">]</span><span class="token variable">$chown</span> <span class="token parameter variable">-R</span> tomcat:tomcat /usr/local/tomcat/
<span class="token punctuation">[</span>root@c71 src<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/tomcat/
<span class="token punctuation">[</span>root@c72 bin<span class="token punctuation">]</span><span class="token variable">$ll</span> catalina.sh startup.sh shutdown.sh
-rwxr-x--- <span class="token number">1</span> tomcat tomcat <span class="token number">25121</span> Jan <span class="token number">30</span> <span class="token number">17</span>:19 catalina.sh	<span class="token comment"># 管理tomcat脚本</span>
-rwxr-x--- <span class="token number">1</span> tomcat tomcat  <span class="token number">1902</span> Jan <span class="token number">30</span> <span class="token number">17</span>:19 shutdown.sh	<span class="token comment"># 停止tomcat脚本</span>
-rwxr-x--- <span class="token number">1</span> tomcat tomcat  <span class="token number">1904</span> Jan <span class="token number">30</span> <span class="token number">17</span>:19 startup.sh	<span class="token comment"># 启动tomcat脚本</span>
<span class="token comment"># 提供tomcat所需的环境变量</span>
<span class="token punctuation">[</span>root@c71 tomcat<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token string">"JAVA_HOME=/usr/local/jdk"</span> <span class="token operator">></span>/usr/local/tomcat/conf/tomcat.conf
<span class="token comment"># 创建tomcat.service文件</span>
<span class="token punctuation">[</span>root@c71 tomcat<span class="token punctuation">]</span><span class="token variable">$vim</span> /usr/lib/systemd/system/tomcat.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Tomcat
<span class="token comment">#After=syslog.target network.target remote-fs.target nss-lookup.target</span>
<span class="token assign-left variable">After</span><span class="token operator">=</span>syslog.target network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/usr/local/tomcat/conf/tomcat.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/tomcat/bin/startup.sh
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/tomcat/bin/shutdown.sh
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true
<span class="token assign-left variable">User</span><span class="token operator">=</span>tomcat
<span class="token assign-left variable">Group</span><span class="token operator">=</span>tomcat

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
<span class="token comment"># 设置开机自启</span>
<span class="token punctuation">[</span>root@c71 tomcat<span class="token punctuation">]</span><span class="token variable">$systemctl</span> daemon-reload
<span class="token punctuation">[</span>root@c71 tomcat<span class="token punctuation">]</span><span class="token variable">$systemctl</span> <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> tomcat</code></pre>

<h4 id="升级和回滚"><a href="#升级和回滚" class="headerlink" title="升级和回滚"></a>升级和回滚</h4><p>安装新的 tomcat 版本，然后删除旧的软连接，创建新的软连接，最后重启服务</p>
<h3 id="tomcat-的文件结构和组成"><a href="#tomcat-的文件结构和组成" class="headerlink" title="tomcat 的文件结构和组成"></a>tomcat 的文件结构和组成</h3><table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bin</td>
<td>服务启动、停止等相关程序和文件</td>
</tr>
<tr>
<td><strong>conf</strong></td>
<td>配置文件</td>
</tr>
<tr>
<td>lib</td>
<td>库目录</td>
</tr>
<tr>
<td>logs</td>
<td>日志目录</td>
</tr>
<tr>
<td><strong>webapps</strong></td>
<td>应用程序，应用部署目录</td>
</tr>
<tr>
<td>work</td>
<td>jsp 编译后的结果文件，建议提前预热访问</td>
</tr>
</tbody></table>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>文档：<a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.5-doc/index.html">http://tomcat.apache.org/tomcat-8.5-doc/index.html</a></p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>server.xml</td>
<td>主配置文件</td>
</tr>
<tr>
<td>web.xml</td>
<td>每个 webapp 只有“部署”后才能被访问，它的部署方式通常由 web.xml 进行定义，其存放位置为 WEB-INF&#x2F;目录中；此文件为所有的 webapps 提供默认部署相关的配置,每个 web 应用也可以使用专用配置文件,来覆盖全局文件</td>
</tr>
<tr>
<td>context.xml</td>
<td>用于定义所有 web 应用均需加载的 Context 配置，此文件为所有的 webapps 提供默认配置，每个 web 应用也可以使用自已专用的配置，它通常由专用的配置文件 context.xml 来定义，其存放位置为 WEB-INF&#x2F;目录中，覆盖全局的文件</td>
</tr>
<tr>
<td>tomcat-users.xml</td>
<td>用户认证的账号和密码文件</td>
</tr>
<tr>
<td>catalina.policy</td>
<td>当使用 security 选项启动 tomcat 时，用于为 tomcat 设置安全策略</td>
</tr>
<tr>
<td>catalina.properties</td>
<td>Tomcat 环境变量的配置，用于设定类加载器路径，以及一些与 JVM 调优相关参数</td>
</tr>
<tr>
<td>logging.properties</td>
<td>Tomcat 日志系统相关的配置，可以修改日志级别和日志路径等</td>
</tr>
</tbody></table>
<p>注意：配置文件大小写敏感</p>
<h5 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h5><p>参考文档: <a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/TOMCAT/Logging">https://cwiki.apache.org/confluence/display/TOMCAT/Logging</a><br>日志格式: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging">https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging</a></p>
<p>日志文件位于 logs 目录下，日志的格式在 conf&#x2F;server.xml 中定义</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c72 tomcat<span class="token punctuation">]</span><span class="token variable">$vim</span> conf/server.xml
<span class="token punctuation">..</span>.
<span class="token number">164</span>         <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span>
<span class="token number">165</span>                <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"localhost_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span>
<span class="token number">166</span>                <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">></span>
<span class="token punctuation">..</span>.</code></pre>

<h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><p><img data-src="//img.to2b.cn/blog/ljk/1612001766459.png"></p>
<p>每一个组件都一个对象，这些组件大体可分为以下几个类型：</p>
<ul>
<li><p>顶级组件：Server，代表整个 Tomcat 容器；</p>
</li>
<li><p>服务类组件：Service，可以创建多个 Service，但一般也只创建一个，用来组织 Engine 和 Connector 的对应关系，一个 service 中只有一个 Engine；</p>
</li>
<li><p>连接器组件：Connector，负责客户端的 HTTP、HTTPS、AJP 等协议连接。一个 Connector 只属于某一个 Engine；</p>
<p>AJP（Apache Jserv protocol）是一种基于 TCP 的二进制通讯协议</p>
</li>
<li><p>容器类组件：Engine、Host、Context 都是容器类组件；</p>
<ul>
<li>Engine：引擎，真正的处理请求的入口，其内部定义多个虚拟主机 Host。一个 Engine 上可以绑定多个 Connector</li>
<li>Host：虚拟主机</li>
<li>Context：应用的上下文，配置特定 url 路径映射和目录的映射关系：url &#x3D;&gt; directory</li>
</ul>
</li>
<li><p>内嵌类组件：valve、logger、realm、loader、manager 等。可以内嵌到其他组件内，在不同容器组件内分别定义。</p>
</li>
<li><p>集群类组件：listener、cluster</p>
</li>
</ul>
<p>多个组件关系 <code>/conf/server.xml</code> 示例：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version='1.0' encoding='utf-8'?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8015<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.startup.VersionLoggerListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">SSLEngine</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>on<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.core.AprLifecycleListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.core.JreMemoryLeakPreventionListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.mbeans.GlobalResourcesLifecycleListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.core.ThreadLocalLeakPreventionListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GlobalNamingResources</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Resource</span> <span class="token attr-name">auth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Container<span class="token punctuation">"</span></span> <span class="token attr-name">description</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>User database that can be updated and saved<span class="token punctuation">"</span></span> <span class="token attr-name">factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.users.MemoryUserDatabaseFactory<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserDatabase<span class="token punctuation">"</span></span> <span class="token attr-name">pathname</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>conf/tomcat-users.xml<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.UserDatabase<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GlobalNamingResources</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6804<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span> <span class="token attr-name">defaultHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Realm</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.realm.LockOutRealm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Realm</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.realm.UserDatabaseRealm<span class="token punctuation">"</span></span> <span class="token attr-name">resourceName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserDatabase<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Realm</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.valves.AccessLogValve<span class="token punctuation">"</span></span> <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%h %l %u %t <span class="token entity named-entity" title="&quot;">&amp;quot;</span>%r<span class="token entity named-entity" title="&quot;">&amp;quot;</span> %s %b<span class="token punctuation">"</span></span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost_access_log<span class="token punctuation">"</span></span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.txt<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">></span></span></code></pre>

<h4 id="tomcat-处理请求过程"><a href="#tomcat-处理请求过程" class="headerlink" title="tomcat 处理请求过程"></a>tomcat 处理请求过程</h4><p>假设来自客户的请求为：<a target="_blank" rel="noopener" href="http://localhost:8080/test/index.jsp">http://localhost:8080/test/index.jsp</a></p>
<ol>
<li>浏览器端的请求被发送到服务端端口 8080，Tomcat 进程监听在此端口上。通过侦听的 HTTP&#x2F;1.1 Connector 获得此请求。</li>
<li>Connector 把该请求交给它所在的 Service 的 Engine 来处理，并等待 Engine 的响应</li>
<li>Engine 获得请求 localhost:8080&#x2F;test&#x2F;index.jsp，遍历它所有虚拟主机 Host</li>
<li>Engine 匹配到名为 localhost 的 Host。如果匹配不到,就把请求交给该 Engine 中的 defaultHost 处理</li>
<li>localhost Host 获得请求&#x2F;test&#x2F;index.jsp，匹配它所拥有的所有 Context</li>
<li>Host 匹配到路径为&#x2F;test 的 Context</li>
<li>path&#x3D;&#x2F;test 的 Context 获得请求 index.jsp，在它的 mapping table 中寻找对应的 servlet</li>
<li>Context 匹配到 URL PATTERN 为 *.jsp 的 servlet，对应于 JspServlet 类构造 HttpServletRequest 对象和 HttpServletResponse 对象，作为参数调用 JspServlet 的 doGet 或 doPost 方法。</li>
<li>Context 把执行完了之后的 HttpServletResponse 对象返回给 Host</li>
<li>Host 把 HttpServletResponse 对象返回给 Engine</li>
<li>Engine 把 HttpServletResponse 对象返回给 Connector</li>
<li>Connector 把 HttpServletResponse 对象返回给浏览器端</li>
</ol>
<h3 id="应用部署"><a href="#应用部署" class="headerlink" title="应用部署"></a>应用部署</h3><p>默认网站根目录是 webapps，其下的每个目录都是一个 WebApp</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c72 tomcat<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/local/tomcat
<span class="token punctuation">[</span>root@c72 tomcat<span class="token punctuation">]</span><span class="token variable">$ll</span> webapps/		<span class="token comment"># 默认网站根目录</span>
total <span class="token number">24</span>
drwxr-x--- <span class="token number">2</span> tomcat tomcat <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">22</span>:50 docs
drwxr-x--- <span class="token number">7</span> tomcat tomcat <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">22</span>:50 examples
drwxr-x--- <span class="token number">6</span> tomcat tomcat <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">17</span>:19 host-manager
drwxr-x--- <span class="token number">6</span> tomcat tomcat <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">17</span>:19 manager
drwxr-x--- <span class="token number">3</span> tomcat tomcat <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">22</span>:52 ROOT		<span class="token comment"># 网站默认根目录</span></code></pre>

<h4 id="JSP-WebApp-目录结构"><a href="#JSP-WebApp-目录结构" class="headerlink" title="JSP WebApp 目录结构"></a>JSP WebApp 目录结构</h4><p>目录结构一般由开发用工具自动生成</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">index.html	<span class="token comment"># 主页配置：默认按以下顺序查找主页文件 index.html，index.htm、index.jsp</span>
WEB-INF<span class="token punctuation">\</span>	<span class="token comment"># 当前目录WebApp的私有资源路径，通常存储当前应用使用的web.xml和context.xml配置文件</span>
META-INF<span class="token punctuation">\</span>	<span class="token comment"># 类似于WEB-INF，也是私有资源的配置信息，和WEB-INF/目录一样浏览器无法访问</span>
classes<span class="token punctuation">\</span>	<span class="token comment"># 类文件，当前webapp需要的类</span>
lib<span class="token punctuation">\</span>		<span class="token comment"># 当前应用依赖的jar包</span></code></pre>

<h4 id="主页设置"><a href="#主页设置" class="headerlink" title="主页设置"></a>主页设置</h4><ul>
<li><p>全局配置：修改 conf&#x2F;web.xml 中的 <code>&lt;welcome-file-list&gt;</code> 标签，配置修改后，<font color=red>需要重启 tomcat</font></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 略...</span></code></pre>
</li>
<li><p>WebApp 的专用配置文件：以 ROOT 为例，将上面主配置文件 conf&#x2F;web.xml 中的 <code>&lt;welcome-file-list&gt;</code> 标签，复制到 webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;web.xml 中，配置修改后，<font color=red>无需重启 tomcat 服务</font></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c72 tomcat<span class="token punctuation">]</span><span class="token variable">$vim</span> webapps/ROOT/WEB-INF/web.xml
<span class="token operator">&lt;</span>web-app <span class="token assign-left variable">xmlns</span><span class="token operator">=</span><span class="token string">"http://xmlns.jcp.org/xml/ns/javaee"</span>
  xmlns:xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span> xsi:schemaLocation<span class="token operator">=</span><span class="token string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</span> <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"3.1"</span> metadata-complete<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>display-name<span class="token operator">></span>Welcome to Tomcat<span class="token operator">&lt;</span>/display-name<span class="token operator">></span>
  <span class="token operator">&lt;</span>description<span class="token operator">></span>Welcome to Tomcat<span class="token operator">&lt;</span>/description<span class="token operator">></span>
    <span class="token operator">&lt;</span>welcome-file-list<span class="token operator">></span>
        <span class="token operator">&lt;</span>welcome-file<span class="token operator">></span>index.html<span class="token operator">&lt;</span>/welcome-file<span class="token operator">></span>		<span class="token operator">&lt;</span><span class="token operator">!</span>-- 调整三个文件顺序 --<span class="token operator">></span>
        <span class="token operator">&lt;</span>welcome-file<span class="token operator">></span>index.htm<span class="token operator">&lt;</span>/welcome-file<span class="token operator">></span>
        <span class="token operator">&lt;</span>welcome-file<span class="token operator">></span>index.jsp<span class="token operator">&lt;</span>/welcome-file<span class="token operator">></span>
    <span class="token operator">&lt;</span>/welcome-file-list<span class="token operator">></span>
<span class="token operator">&lt;</span>/web-app<span class="token operator">></span>
<span class="token punctuation">[</span>root@c72 tomcat<span class="token punctuation">]</span><span class="token variable">$chown</span> <span class="token parameter variable">-R</span> tomcat:tomcat ./webapps/ROOT/*	<span class="token comment"># 不要忘记修改属主</span></code></pre></li>
</ul>
<h4 id="应用部署实现"><a href="#应用部署实现" class="headerlink" title="应用部署实现"></a>应用部署实现</h4><p><strong>WebApp 应用的归档格式</strong>：<code>.war</code> 和 <code>.jar</code></p>
<ul>
<li>.war：WebApp 打包,类 zip 格式文件，通常包括一个应用的所有资源，比如 jsp、html、配置文件等</li>
<li>.jar：EJB 类文件的打包压缩类 zip 格式文件，包括很多的 class 文件，网景公司发明</li>
</ul>
<p><strong>部署方式</strong>：自动部署 和 手动部署</p>
<ul>
<li><p>自动部署：Tomcat 一旦发现多了一个 web 应用 APP.war 包，默认会自动把它解压缩，加载并启动起来</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># conf/server.xml中文件配置</span>
<span class="token operator">&lt;</span>Host <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"localhost"</span> <span class="token assign-left variable">appBase</span><span class="token operator">=</span><span class="token string">"webapps"</span> <span class="token assign-left variable">unpackWARs</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token assign-left variable">autoDeploy</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span></code></pre>
</li>
<li><p>手动部署：冷部署 和 热部署</p>
<ul>
<li>冷部署：将 webapp 放到指定目录，才去启动 Tomcat 服务</li>
<li>热部署：Tomcat 服务不停止，需要依赖 manager、ant 脚本、tcd（tomcat client deployer）等工具</li>
</ul>
</li>
<li><p>反部署 undeploy：停止 webapp 运行，并从 JVM 上清除已经加载的类，从 Tomcat 应用目录中移除部署的文件</p>
</li>
<li><p>启动 start：是 webapp 能够访问</p>
</li>
<li><p>停止 stop：webapp 不能访问，不能提供服务，但是 JVM 并不清除它</p>
</li>
</ul>
<h5 id="部署基于-JAVA-的博客系统-JPress"><a href="#部署基于-JAVA-的博客系统-JPress" class="headerlink" title="部署基于 JAVA 的博客系统 JPress"></a>部署基于 JAVA 的博客系统 JPress</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c72 webapps<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/local/tomcat/webapps
<span class="token punctuation">[</span>root@c72 webapps<span class="token punctuation">]</span><span class="token variable">$mv</span> /usr/local/src/jpress-v3.3.0.war ./
<span class="token punctuation">[</span>root@c72 webapps<span class="token punctuation">]</span><span class="token variable">$ln</span> <span class="token parameter variable">-s</span> jpress-v3.3.0 jpress	<span class="token comment"># 创建软连接，方便以后升级</span>
<span class="token punctuation">[</span>root@c72 webapps<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">70024</span>
drwxr-x--- <span class="token number">2</span> tomcat tomcat     <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">22</span>:50 docs
drwxr-x--- <span class="token number">7</span> tomcat tomcat     <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">22</span>:50 examples
drwxr-x--- <span class="token number">6</span> tomcat tomcat     <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">17</span>:19 host-manager
lrwxrwxrwx <span class="token number">1</span> root   root         <span class="token number">13</span> Jan <span class="token number">31</span> <span class="token number">11</span>:35 jpress -<span class="token operator">></span> jpress-v3.3.0
drwxr-x--- <span class="token number">6</span> tomcat tomcat     <span class="token number">4096</span> Jan <span class="token number">31</span> <span class="token number">11</span>:35 jpress-v3.3.0
-rw-r--r-- <span class="token number">1</span> root   root   <span class="token number">71677863</span> Jan <span class="token number">31</span> <span class="token number">11</span>:31 jpress-v3.3.0.war
drwxr-x--- <span class="token number">6</span> tomcat tomcat     <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">17</span>:19 manager
drwxr-x--- <span class="token number">6</span> tomcat tomcat     <span class="token number">4096</span> Jan <span class="token number">30</span> <span class="token number">23</span>:01 ROOT</code></pre>

<img data-src="//img.to2b.cn/blog/ljk/1612064233227.png" style="zoom:67%;" />

<h5 id="基于-WEB-的管理-Server-status-和-Manager-APP-实现应用部署"><a href="#基于-WEB-的管理-Server-status-和-Manager-APP-实现应用部署" class="headerlink" title="基于 WEB 的管理 Server status 和 Manager APP 实现应用部署"></a>基于 WEB 的管理 Server status 和 Manager APP 实现应用部署</h5><p>默认的管理页面被禁用，启用方法如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># server.xml中Resource的pathname参数指定了授权用户信息的文件：conf/tomcat-users.xml</span>

<span class="token punctuation">[</span>root@c72 conf<span class="token punctuation">]</span><span class="token variable">$vim</span> tomcat-users.xml
<span class="token comment">#加下面两行，指定用户和密码</span>
<span class="token operator">&lt;</span>role <span class="token assign-left variable">rolename</span><span class="token operator">=</span><span class="token string">"manager-gui"</span>/<span class="token operator">></span>
<span class="token operator">&lt;</span>user <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">"admin"</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">"123456"</span> <span class="token assign-left variable">roles</span><span class="token operator">=</span><span class="token string">"manager-gui"</span>/<span class="token operator">></span>

<span class="token punctuation">[</span>root@c72 manager<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/local/tomcat/webapps/manage
<span class="token punctuation">[</span>root@c72 manager<span class="token punctuation">]</span><span class="token variable">$vim</span> META-INF/context.xml
<span class="token comment"># 当前访问地址是10.0.0.72，可以修改正则表达式为</span>
<span class="token assign-left variable">allow</span><span class="token operator">=</span><span class="token string">"127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.0\.0\.\d+"</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612079811469.png"></p>
<h5 id="基于-WEB-应用程序管理器实现-APP-的部署"><a href="#基于-WEB-应用程序管理器实现-APP-的部署" class="headerlink" title="基于 WEB 应用程序管理器实现 APP 的部署"></a>基于 WEB 应用程序管理器实现 APP 的部署</h5><p>访问 &#x2F;manager 即可</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612080515159.png"></p>
<h4 id="常见配置详解"><a href="#常见配置详解" class="headerlink" title="常见配置详解"></a>常见配置详解</h4><h5 id="端口-8005-x2F-tcp-安全配置管理"><a href="#端口-8005-x2F-tcp-安全配置管理" class="headerlink" title="端口 8005&#x2F;tcp 安全配置管理"></a>端口 8005&#x2F;tcp 安全配置管理</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ss</span> <span class="token parameter variable">-ntlp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">8005</span>
LISTEN   <span class="token number">0</span>   <span class="token number">1</span>    <span class="token punctuation">[</span>::ffff:127.0.0.1<span class="token punctuation">]</span>:8005    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:*    users:<span class="token variable"><span class="token punctuation">((</span>"java"<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">3117</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">66</span><span class="token punctuation">))</span></span></code></pre>

<p>tomcat 默认监听 8005 端口，这是一个后门，可通过这个端口关闭 tomcat 服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">8005</span>		<span class="token comment"># 连接到本机的8005端口</span>
SHUTDOWN				<span class="token comment"># 输入SHUTDOWN，关闭tomcat</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># server.xml</span>
<span class="token operator">&lt;</span>Server <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"8005"</span> <span class="token assign-left variable">shutdown</span><span class="token operator">=</span><span class="token string">"SHUTDOWN"</span><span class="token operator">></span>	<span class="token comment"># 配置后门的端口，和关闭服务的指令</span></code></pre>

<p>此行不能被注释，否则无法启动 tomcat 服务</p>
<p>此管理功能建议禁用：</p>
<ul>
<li>将 SHUTDOWN 改为一串猜不出的字符串实现</li>
<li>port 修改成 0, 会使用随机端口,如:36913</li>
<li>port 设为-1 等无效端口,将关闭此功能</li>
</ul>
<h5 id="显示指定的-http-服务器版本信息"><a href="#显示指定的-http-服务器版本信息" class="headerlink" title="显示指定的 http 服务器版本信息"></a>显示指定的 http 服务器版本信息</h5><p>默认不显示 tomcat 的 http 的 Server 头信息, 可以指定 tomcat 的 http 的 Server 头信息</p>
<p>示例：冒充 nginx 服务器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 给Connector标签添加Server参数</span>
<span class="token operator">&lt;</span>Connector <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"8080"</span> <span class="token assign-left variable">protocol</span><span class="token operator">=</span><span class="token string">"HTTP/1.1"</span> <span class="token assign-left variable">connectionTimeout</span><span class="token operator">=</span><span class="token string">"20000"</span> <span class="token assign-left variable">redirectPort</span><span class="token operator">=</span><span class="token string">"8443"</span> <span class="token assign-left variable">Server</span><span class="token operator">=</span><span class="token string">"nginx"</span> /<span class="token operator">></span>
<span class="token comment"># 重启tomcat</span>
systemctl restart tomcat</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612082891274.png"></p>
<h5 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h5><p>server.xml 中可以配置 service、connector、Engine、Host 等</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 一般情况下，一个Server实例配置一个Service，name属性相当于该Service的ID</span>
<span class="token operator">&lt;</span>Service <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"Catalina"</span><span class="token operator">></span>
<span class="token comment"># redirectPort：如果访问HTTPS协议，自动转向这个连接器。但大多数时候，Tomcat并不会开启HTTPS，因为Tomcat往往部署在内部，HTTPS性能较差</span>
<span class="token operator">&lt;</span>Connector <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"8080"</span> <span class="token assign-left variable">protocol</span><span class="token operator">=</span><span class="token string">"HTTP/1.1"</span> <span class="token assign-left variable">connectionTimeout</span><span class="token operator">=</span><span class="token string">"20000"</span> <span class="token assign-left variable">redirectPort</span><span class="token operator">=</span><span class="token string">"8443"</span> /<span class="token operator">></span>
<span class="token comment"># 引擎配置</span>
<span class="token operator">&lt;</span>Engine <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"Catalina"</span> <span class="token assign-left variable">defaultHost</span><span class="token operator">=</span><span class="token string">"localhost"</span><span class="token operator">></span>
<span class="token comment"># defaultHost配置，默认localhost。</span>
<span class="token operator">&lt;</span>Host <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"localhost"</span> <span class="token assign-left variable">appBase</span><span class="token operator">=</span><span class="token string">"webapps"</span> <span class="token assign-left variable">unpackWARs</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token assign-left variable">autoDeploy</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span></code></pre>

<h5 id="多虚拟主机配置"><a href="#多虚拟主机配置" class="headerlink" title="多虚拟主机配置"></a>多虚拟主机配置</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># name：相当于 nginx 的 server_name</span>
<span class="token comment"># appBase：网站根目录，可以使用相对路径或绝对路径</span>
<span class="token comment"># unpackWARs：是否自动解压 war 格式</span>
<span class="token comment"># autoDeploy：热部署，自动加载并运行应用</span>
<span class="token operator">&lt;</span>Host <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"test.ljk.cn"</span> <span class="token assign-left variable">appBase</span><span class="token operator">=</span><span class="token string">"/data/wwwroot/test.ljk.cn"</span> <span class="token assign-left variable">unpackWARs</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token assign-left variable">autoDeploy</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>
	<span class="token comment"># className</span>
	<span class="token comment"># directory：日志目录，可以使用相对路径或绝对路径</span>
	<span class="token comment"># 日志文件：prefix.2021-01-31.suffix</span>
    <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"/data/wwwlogs"</span> <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"test.ljk.cn_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span> <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">></span>
<span class="token operator">&lt;</span>/Host<span class="token operator">></span>

<span class="token comment"># 注意日志的权限问题</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> tomcat:tomcat /data/wwwlogs

<span class="token punctuation">[</span>root@c72 test.ljk.cn<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/data/wwwroot/test.ljk.cn
<span class="token punctuation">[</span>root@c72 test.ljk.cn<span class="token punctuation">]</span><span class="token variable">$cat</span> ./ROOT/index.html 	<span class="token comment"># 注意目录结构</span>
hello test.ljk.cn</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612100702899.png"></p>
<h5 id="基于-web-方式的-Host-Manager-虚拟主机管理"><a href="#基于-web-方式的-Host-Manager-虚拟主机管理" class="headerlink" title="基于 web 方式的 Host Manager 虚拟主机管理"></a>基于 web 方式的 Host Manager 虚拟主机管理</h5><p>略…</p>
<h5 id="Context-配置"><a href="#Context-配置" class="headerlink" title="Context 配置"></a>Context 配置</h5><p>Context 类似 Nginx 中的 location</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># path</span>
<span class="token comment"># docBase：相对、绝对路径均可</span>
<span class="token comment"># reloadable：WEB-INF/classes或META-INF/lib目录下.class文件有改动，自动重载，生产建议关闭</span>
<span class="token operator">&lt;</span>Context <span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token string">"/test"</span> <span class="token assign-left variable">docBase</span><span class="token operator">=</span><span class="token string">"/data/test"</span> <span class="token assign-left variable">reloadable</span><span class="token operator">=</span><span class="token string">"true"</span> /<span class="token operator">></span>

<span class="token comment"># 相当于 Nginx 中：</span>
location /test <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">alias</span> /data/test<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>还可以单独添加日志配置：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>Context <span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token string">"/test"</span> <span class="token assign-left variable">docBase</span><span class="token operator">=</span><span class="token string">"/data/test"</span> <span class="token assign-left variable">reloadable</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span> <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"localhost_test_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span> <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">></span>
<span class="token operator">&lt;</span>/Context<span class="token operator">></span></code></pre>

<p><strong>Valve 组件</strong></p>
<p>valve(阀门)组件可以定义日志</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span> <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"localhost_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span> <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /<span class="token operator">></span>

<span class="token comment"># className</span>
<span class="token comment"># 定义访问日志 org.apache.catalina.valves.AccessLogValve</span>
<span class="token comment"># 定义访问控制 org.apache.catalina.valves.RemoteAddrValve</span>
<span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.RemoteAddrValve"</span> <span class="token assign-left variable">deny</span><span class="token operator">=</span><span class="token string">"10\.0\.0\.\d+"</span>/<span class="token operator">></span></code></pre>

<h2 id="反向代理和负载均衡"><a href="#反向代理和负载均衡" class="headerlink" title="反向代理和负载均衡"></a>反向代理和负载均衡</h2><p>tomcat 的网络并发性能比较差，所以通常只用 tomcat 解析动态页面</p>
<p>两种常见的部署方式：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612112198795.png"></p>
<p>nginx 监听 80 端口，tomcat 监听 8080 端口，nginx 负责将请求转发给 tomcat 处理</p>
<p><strong>反向代理：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">server <span class="token punctuation">&#123;</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name to2b.cn<span class="token punctuation">;</span>
    access_log off<span class="token punctuation">;</span>

    location / <span class="token punctuation">&#123;</span>
        proxy_pass http://to2b.cn:8080<span class="token punctuation">;</span>		<span class="token comment"># 反向代理</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>负载均衡：</strong></p>
<p>略…</p>
<h2 id="Tomcat-Session-Replication-Cluster"><a href="#Tomcat-Session-Replication-Cluster" class="headerlink" title="Tomcat Session Replication Cluster"></a>Tomcat Session Replication Cluster</h2><p>Tomcat 官方实现了 Session 的复制集群，将每个 Tomcat 的 Session 进行相互的复制同步，从而保证所有 Tomcat 都有相同的 Session 信息</p>
<p>这种同步 session 的方式缺点很明显，就是占用内存，所以不适用于 tomcat 服务器太多的情况，如果只有两三台，可以使用</p>
<p>…</p>
<h2 id="session-共享服务器-msm"><a href="#session-共享服务器-msm" class="headerlink" title="session 共享服务器 msm"></a>session 共享服务器 msm</h2><p>msm：memcached session manager，将 Tomcat 的 session 保持到 memcached 或 redis，实现高可用</p>
<p>github 网站链接: <a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager">https://github.com/magro/memcached-session-manager</a></p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<ol>
<li><p>下载各种包</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612151828593.png"></p>
<p>注意：直接点击会报错 501，这时因为 maven 仓库废弃了 http 访问，手动更改为 https 即可</p>
</li>
<li><p>将相关的 jar 文件都放到 Tomcat 的 lib 目录中即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Tomcat的Session管理类</span>
memcached-session-manager-2.3.2.jar
memcached-session-manager-tc8-2.3.2.jar

<span class="token comment"># 驱动类，memcached(spymemcached.jar)、Redis(jedis.jar)</span>
spymemcached-2.12.3.jar

<span class="token comment"># Session数据的序列化、反序列化类，官方推荐 kryo</span>
msm-kryo-serializer-2.3.2.jar
kryo-serializers-0.45.jar
kryo-3.0.3.jar
minlog-1.3.1.jar
reflectasm-1.11.9.jar
asm-5.2.jar
objenesis-2.6.jar</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/local/tomcat/lib
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.2/memcached-session-manager-2.3.2.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc8/2.3.2/memcached-session-manager-tc8-2.3.2.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/net/spy/spymemcached/2.12.3/spymemcached-2.12.3.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.2/msm-kryo-serializer-2.3.2.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.45/kryo-serializers-0.45.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/com/esotericsoftware/kryo/3.0.3/kryo-3.0.3.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/org/ow2/asm/asm/5.2/asm-5.2.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/org/objenesis/objenesis/2.6/objenesis-2.6.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.9/reflectasm-1.11.9.jar
<span class="token punctuation">[</span>root@c72 lib<span class="token punctuation">]</span><span class="token variable">$wget</span> https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.1/minlog-1.3.1.jar</code></pre></li>
</ol>
<h3 id="sticky-模式"><a href="#sticky-模式" class="headerlink" title="sticky 模式"></a>sticky 模式</h3><p>前端 tomcat 和后端 memcached**有关联(粘性)**关系</p>
<p>略…</p>
<h3 id="non-sticky-模式"><a href="#non-sticky-模式" class="headerlink" title="non-sticky 模式"></a>non-sticky 模式</h3><p>前端 tomcat 和后端 memcached**无关联(无粘性)**关系，msm 1.4.0 之后版本开始支持</p>
<p>Tomcat session 为中转 Session，对每一个 SessionID 随机选中后端的 memcached 节点 n1(或者 n2)为主 session，而另一个 memcached 节点 n2(或者是 n1)为备 session。产生的新的 Session 会发送给主、备 memcached，并清除本地 Session</p>
<p>如果 n1 下线，n2 则转正。n1 再次上线，n2 依然是主 Session 存储节点</p>
<h4 id="实战案例-memcached-实现-non-sticky-模式"><a href="#实战案例-memcached-实现-non-sticky-模式" class="headerlink" title="实战案例: memcached 实现 non-sticky 模式"></a>实战案例: memcached 实现 non-sticky 模式</h4><p><img data-src="//img.to2b.cn/blog/ljk/1612166152971.png"></p>
<table>
<thead>
<tr>
<th>ip</th>
<th>服务</th>
<th>安装软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.71</td>
<td>tomcat1、memcached</td>
<td>jdk8、tomcat8、memcached</td>
</tr>
<tr>
<td>10.0.0.72</td>
<td>tomcat1、memcached</td>
<td>jdk8、tomcat8、memcached</td>
</tr>
<tr>
<td>10.0.0.73</td>
<td>负载均衡调度器</td>
<td>haproxy 或者 nginx</td>
</tr>
</tbody></table>
<p>负载均衡调度器的安装配置过程：略…</p>
<p>10.0.0.71 和 10.0.0.72 做以下配置：</p>
<ol>
<li><p>安装配置 memcached</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$yum</span> <span class="token function">install</span> memcached
<span class="token variable">$vim</span> /etc/sysconfig/memcached
<span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token string">"11211"</span>
<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token string">"memcached"</span>
<span class="token assign-left variable">MAXCONN</span><span class="token operator">=</span><span class="token string">"1024"</span>
<span class="token assign-left variable">CACHESIZE</span><span class="token operator">=</span><span class="token string">"64"</span>
<span class="token assign-left variable">OPTIONS</span><span class="token operator">=</span><span class="token string">""</span></code></pre>
</li>
<li><p>配置 tomcat 的 context.xml</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span><span class="token punctuation">></span></span>
	...
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Manager</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>de.javakaffee.web.msm.MemcachedBackupSessionManager<span class="token punctuation">"</span></span>
  <span class="token attr-name">memcachedNodes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>n1:10.0.0.72:11211,n2:10.0.0.73:11211<span class="token punctuation">"</span></span>
  <span class="token attr-name">sticky</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
  <span class="token attr-name">sessionBackupAsync</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
  <span class="token attr-name">lockingMode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>uriPattern:/path1|/path2<span class="token punctuation">"</span></span>
  <span class="token attr-name">requestUriIgnorePattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.*\.(ico|png|gif|jpg|css|js)$<span class="token punctuation">"</span></span>
  <span class="token attr-name">transcoderFactoryClass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Context</span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h4 id="实战案例-redis-实现-non-sticky-模式"><a href="#实战案例-redis-实现-non-sticky-模式" class="headerlink" title="实战案例: redis 实现 non-sticky 模式"></a>实战案例: redis 实现 non-sticky 模式</h4><p><img data-src="//img.to2b.cn/blog/ljk/1612168658161.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612168462956.png"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis</a></p>
<h3 id="Session-问题方案总结"><a href="#Session-问题方案总结" class="headerlink" title="Session 问题方案总结"></a>Session 问题方案总结</h3><ol>
<li>session 绑定，基于 IP 或 session cookie 的。其部署简单，尤其基于 session 黏性的方式，粒度小，对负载均衡影响小。但一旦后端服务器有故障，其上的 session 丢失</li>
<li>session 复制集群，基于 tomcat 实现多个服务器内共享同步所有 session。此方法可以保证任意一台后端服务器故障，其余各服务器上还都存有全部 session，对业务无影响。但是它基于多播实现心跳，TCP 单播实现复制，当设备节点过多，这种复制机制不是很好的解决方案。且并发连接多的时候，单机上的所有 session 占据的内存空间非常巨大，甚至耗尽内存</li>
<li>session 服务器，将所有的 session 存储到一个共享的内存空间中，使用多个冗余节点保存 session，这样做到 session 存储服务器的高可用，且占据业务服务器内存较小。是一种比较好的解决 session 持久的解决方案</li>
</ol>
<p>以上的方法都有其适用性。生产环境中，应根据实际需要合理选择</p>
<h2 id="Tomcat-性能优化"><a href="#Tomcat-性能优化" class="headerlink" title="Tomcat 性能优化"></a>Tomcat 性能优化</h2><p>tomcat 是运行在 jvm 虚拟机上的一个程序，所以 tomcat 的性能和 jvm 密切相关，所以要想优化 tomcat 的性能，除了优化 tomcat 本身的设置，还需要优化 jvm</p>
<h3 id="JVM-组成"><a href="#JVM-组成" class="headerlink" title="JVM 组成"></a>JVM 组成</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$java</span> <span class="token parameter variable">-version</span>
<span class="token function">java</span> version <span class="token string">"1.8.0_271"</span>
Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build <span class="token number">1.8</span>.0_271-b09<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span>build <span class="token number">25.271</span>-b09, mixed mode<span class="token punctuation">)</span></code></pre>

<p>JVM：Java Virtual Machine，java 虚拟机</p>
<p>HotSpot 实现了 Java 虚拟机规范，java 虚拟机有好几种，HotSpot 是最主流的一种</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612238340678.png"></p>
<ul>
<li>类加载子系统：将 java 代码编译成字节码文件，将所需所有类加载到内存，必要时将类实例化成实例</li>
<li><strong>运行时数据区</strong>：最消耗内存的空间，需要优化</li>
<li>执行引擎：包括 JIT （JustInTimeCompiler）即时编译器，GC （Garbage Collector）垃圾回收器</li>
<li>本地方法接口：通过 JNI（Java Native Interface）调用 C、C++ 库其他语言，扩展 Java 功能</li>
</ul>
<p>运行时数据区的<strong>heap</strong>（堆）是我们关注的重点，这部分可以通过修改设置进行优化，其他部分没有优化的途径</p>
<ul>
<li>MetaSpace：元空间，线程共享，存放已加载的类信息（构造方法、接口定义）、常量（final）、静态变量（static）、运行时常量池等。但实例变量存放在堆内存中。**JDK8 之前叫 Method Area（方法区） **</li>
<li><strong>heap</strong>：堆，线程共享，虚拟机启动时创建，存放创建的所有对象信息。如果对象无法申请到可用内存将抛出 OOM 异常。堆是靠 GC 垃圾回收器管理的，通过 -Xmx -Xms 指定最大堆和最小堆空间大小</li>
<li>Java stack：java 栈，线程私有，每个线程会分配一个栈，存放 java 中 8 大基本数据类型、对象引用、实例的本地变量、方法参数和返回值等，基于 FILO()（First In Last Out），每个方法为一个栈帧</li>
<li>Program Counter Register：PC 寄存器，线程私有，就是一个指针，指向方法区中的方法字节码，每一个线程用于记录当前线程正在执行的字节码指令地址。由执行引擎读取下一条指令。因为线程需要切换，当一个线程被切换回来需要执行的时候，需要知道执行到哪里</li>
<li>Native Method stack：本地方法栈，线程私有，为本地方法执行构建的内存空间，存放本地方法执行时的局部变量、操作数等<br>所谓本地方法，即使用 native 关健字修饰的方法，比如 Thread.sleep 方法。简单的说是非 Java 实现的方法，例如操作系统的 C 编写的库提供的本地方法，Java 调用这些本地方法接口执行。但是要注意，本地方法应该避免直接编程使用，因为 Java 可能跨平台使用，如果用了 Windows API，换到了 Linux 平台部署就有了问题</li>
</ul>
<h3 id="GC-Garbage-Collection-垃圾收集器"><a href="#GC-Garbage-Collection-垃圾收集器" class="headerlink" title="GC (Garbage Collection) 垃圾收集器"></a>GC (Garbage Collection) 垃圾收集器</h3><h4 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h4><ul>
<li>标记-清除 Mark-Sweep</li>
<li>标记-压缩 Mark-Compact</li>
<li>复制 Copying</li>
</ul>
<h4 id="分代堆内存-GC-策略"><a href="#分代堆内存-GC-策略" class="headerlink" title="分代堆内存 GC 策略"></a>分代堆内存 GC 策略</h4><p>JVM 内存空间划分为 heap 区和 非 heap 区</p>
<p>heap 内存空间：</p>
<ul>
<li><strong>Eden Space</strong>：伊甸园区</li>
<li><strong>Survivor Space</strong>：幸存者区，分为两部分，一个是 from 区，一个是 to 区。大小相等、地位相同、可互换<ul>
<li>from：指的是本次复制数据的源区</li>
<li>to：指的是本次复制数据的目标区</li>
</ul>
</li>
<li><strong>Tenured Gen</strong>：养老区 或 老年代</li>
</ul>
<p>规律：一般情况 99%的对象都是临时对象</p>
<p>默认空间大小比例：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612421682238.png"></p>
<p>非 heap 区内存划分：</p>
<ul>
<li><strong>Code Cache</strong>：</li>
<li><strong>Compressed Class Space</strong>：</li>
<li><strong>Metaspace</strong>：</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1612344278251.png"></p>
<h5 id="Minor-GC"><a href="#Minor-GC" class="headerlink" title="Minor GC"></a>Minor GC</h5><p>通常场景下，大多数对象都不会存活很久，而且创建活动非常多，伊甸园区和幸存者区的垃圾回收就非常频繁，所以采用 <strong>复制 Copying</strong> 算法</p>
<ol>
<li>所有新建对象（特大对象直接进入养老区）都出生在 eden</li>
<li>当 eden 满了，启动 GC。这个称为 Young GC 或者 <strong>Minor GC</strong>，标记 eden 存活对象，将存活对象复制到幸存者者区（两个幸存者区之一），GC 完成</li>
<li>当 eden 满了，再次启动 GC，标记 eden 和幸存者区的存活对象，将存活对象复制到另一个幸存者区，GC 完成</li>
</ol>
<p>以后就重复上面的步骤，每当 eden 满了，就将其中的存货对象和幸存者区（from 区）的存货对象复制到另一个幸存者区（to 区）</p>
<p>但是，如果一个对象一直存活，它最后就在 from、to 来回复制，如果 from 区中对象复制次数达到阈值（默认 15 次，CMS 为 6 次，可通过 java 的选项 -XX:MaxTenuringThreshold&#x3D;N 指定)，就直接复制到养老区</p>
<h5 id="Major-GC"><a href="#Major-GC" class="headerlink" title="Major GC"></a>Major GC</h5><p>进入养老区的数据较少，所以养老区被占满的速度较慢，所以垃圾回收也不频繁，所以较常采用 <strong>标记-压缩 Mark-Compact</strong> 算法</p>
<p>如果养老区也满了，会触养老区 GC，称为 Old GC 或者 <strong>Major GC</strong></p>
<p>因为 Major GC 会对整个 heap 内存空间进行垃圾回收，影响所有的区域，所以 Major GC 又叫 <strong>FullGC</strong></p>
<h4 id="java-内存调整相关参数"><a href="#java-内存调整相关参数" class="headerlink" title="java 内存调整相关参数"></a>java 内存调整相关参数</h4><p>Java 命令行参考文档: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
<p>选项分类：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">-选项名称		<span class="token comment"># 标准选项，所有HotSpot都支持</span>
-X选项名称		<span class="token comment"># 稳定的非标准选项</span>
-XX:选项名称	<span class="token comment"># 非标准的不稳定选项，下一个版本可能会取消</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612422174426.png"></p>
<p>常用选项：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-Xms</span>				<span class="token comment"># 设置堆内存初始大小，示例：-Xms2g</span>
<span class="token parameter variable">-Xmx</span>				<span class="token comment"># 设置堆内存上限，示例：-Xms4g</span>
<span class="token parameter variable">-XX:NewSize</span>			<span class="token comment"># 设置伊甸园区和幸存者区初始大小，示例：-XX:NewSize=128m</span>
<span class="token parameter variable">-XX:MaxNewSize</span>		<span class="token comment"># 设置伊甸园区和幸存者区上限，示例：-XX:MaxNewSize=256m</span>
<span class="token parameter variable">-Xmnsize</span>			<span class="token comment"># 同时设置-XX:NewSize 和 -XX:MaxNewSize，示例：-Xmn1g</span>
<span class="token parameter variable">-XX:NewRatio</span>		<span class="token comment"># 以比例方式设置新生代和老年代，示例：-XX:NewRatio=2，即new/old=1/2</span>
<span class="token parameter variable">-XX:SurvivorRatio</span>	<span class="token comment"># 以比例方式设置eden和survivor，示例：-XX:SurvivorRatio=6，即eden/survivor=6/1、new/survivor=8/1</span>
<span class="token parameter variable">-Xss</span>				<span class="token comment"># 设置每个线程私有的栈空间大小，依据具体线程大小和数量，示例：-Xss256k</span></code></pre>

<p>注意：Xms 和 Xmx 通常设置为相同的值，防止内存碎片化</p>
<h4 id="垃圾收集方式"><a href="#垃圾收集方式" class="headerlink" title="垃圾收集方式"></a>垃圾收集方式</h4><p>按 <strong>回收线程</strong> 数：GC 线程串行（serial）还是并行（parallel）</p>
<ul>
<li>串行垃圾回收器：一个 GC 线程完成回收工作</li>
<li>并行垃圾回收器：多个 GC 线程同时一起完成回收工作，充分利用 CPU 资源</li>
</ul>
<p>按 <strong>工作模式</strong> 不同：GC 线程是否和工作线程一起运行</p>
<ul>
<li><p>独占垃圾回收器：只有 GC 在工作，STW 一直进行到回收完毕，工作线程才能继续执行</p>
</li>
<li><p>并发垃圾回收器：GC 线程垃圾回收某些阶段可以和工作线程一起进行，如标记阶段并行，回收阶段仍然串行</p>
</li>
</ul>
<h4 id="调整策略"><a href="#调整策略" class="headerlink" title="调整策略"></a>调整策略</h4><p>对 JVM 调整策略应用极广</p>
<ul>
<li><p>在 WEB 领域中 Tomcat 等</p>
</li>
<li><p>在大数据领域 Hadoop 生态各组件</p>
</li>
<li><p>在消息中间件领域的 Kafka 等</p>
</li>
<li><p>在搜索引擎领域的 ElasticSearch、Solr 等</p>
</li>
</ul>
<p><strong>注意：在不同领域和场景对 JVM 需要不同的调整策略</strong></p>
<ul>
<li>减少 STW 时长，串行变并行</li>
<li>减少 GC 次数，要分配合适的内存大小</li>
</ul>
<p><strong>一般情况下，我们大概可以使用以下原则：</strong></p>
<ul>
<li>客户端或较小程序，内存使用量不大，可以使用串行回收</li>
<li>对于服务端大型计算，可以使用并行回收</li>
<li>大型 WEB 应用，用户端不愿意等待，尽量少的 STW，可以使用并发回收</li>
</ul>
<h4 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h4><h5 id="常用垃圾回收器"><a href="#常用垃圾回收器" class="headerlink" title="常用垃圾回收器"></a>常用垃圾回收器</h5><p>ParNew：parallel new，并行处理新生代</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612439688703.png"></p>
<p><strong>按分代设置不同垃圾回收器：</strong></p>
<p>新生代：</p>
<ul>
<li>新生代串行收集器 <strong>Serial</strong></li>
<li>新生代并行回收收集器 <strong>PS</strong>（Parallel Scavenge）</li>
<li>新生代并行收集器 <strong>ParNew</strong></li>
</ul>
<p>老年代：</p>
<ul>
<li>老年代串行收集器 <strong>Serial Old</strong></li>
<li>老年代并行回收收集器 <strong>Parallel Old</strong></li>
<li><strong>CMS</strong>（Concurrent Mark Sweep 并发标记清除算法）<strong>收集器</strong></li>
</ul>
<p><strong>以下收集器不再按明确的分代单独设置：</strong></p>
<ul>
<li>G1（Garbage First）收集器<ul>
<li>最新垃圾回收器，从 JDK1.6 实验性提供，JDK1.7 发布，其设计目标是在多处理器、大内存服务器端提供优于 CMS 收集器的吞吐量和停顿控制的回收器。JDK9 将 G1 设为默认的收集器，建议 JDK9 版本以后使用</li>
<li>基于 <strong>标记压缩</strong> 算法,不会产生大量的空间碎片，有利于程序的长期执行</li>
<li>分为 4 个阶段：初始标记、并发标记、最终标记、筛选回收。并发标记并发执行，其它阶段 STW 只有 GC 线程并行执行</li>
<li>G1 收集器是面向服务端的收集器，它的思想就是首先回收尽可能多的垃圾（这也是 Garbage-First 名字的由来）</li>
<li>G1 能充分的利用多 CPU，多核环境下的硬件优势，使用多个 CPU 来缩短 STW 停顿的时间 （<strong>10ms 以内</strong>）</li>
<li>可预测的停顿：这是 G1 相对于 CMS 的另一大优势，G1 和 CMS 一样都是关注于降低停顿时间，但是 G1 能够让使用者明确的指定在一个 M 毫秒的时间片段内，消耗在垃圾收集的时间不得超过 N 毫秒</li>
<li>通过此选项指定: +UseG1GC</li>
</ul>
</li>
<li>ZGC 收集器：减少 SWT 时长(1ms 以内)，可以媲美 C++ 的效率，目前实验阶段</li>
<li>Shenandoah 收集器：和 ZGC 竞争关系，目前实验阶段</li>
<li>Epsilon 收集器：调试 JDK 使用，内部使用，不用于生产环境</li>
</ul>
<h5 id="垃圾收集器设置"><a href="#垃圾收集器设置" class="headerlink" title="垃圾收集器设置"></a>垃圾收集器设置</h5><p>优化调整 Java 相关参数的目标：尽量减少 FullGC 和 STW</p>
<p>通过以下选项可以单独指定新生代、老年代的垃圾收集器</p>
<ul>
<li>-server<br>指定为 Server 模式，也是默认值，一般使用此工作模式</li>
<li>-XX:+UseSerialGC<br>运行在 Client 模式下，新生代是 Serial, 老年代使用 SerialOld</li>
<li>-XX:+UseParNewGC<br>新生代使用 ParNew，老年代使用 SerialOld</li>
<li>-XX:+UseParallelGC<br>运行于 server 模式下，新生代使用 Serial Scavenge, 老年代使用 SerialOld</li>
<li>-XX:+UseParallelOldGC<br>新生代使用 Paralell Scavenge, 老年代使用 Paralell Old<br>-XX:ParallelGCThreads&#x3D;N 在关注吞吐量的场景使用此选项增加并行线程数</li>
<li>-XX:+UseConcMarkSweepGC<br>新生代使用 ParNew, 老年代优先使用 CMS，备选方式为 Serial Old<br>响应时间要短，停顿短使用这个垃圾收集器<br>-XX:CMSInitiatingOccupancyFraction&#x3D;N 达到老年代的大小的百分比多少时触发回收，默认 68<br>-XX:+UseCMSCompactAtFullCollection 开启此值，在 CMS 收集后，进行内存碎片整理<br>-XX:CMSFullGCsBeforeCompaction&#x3D;N 设定多少次 CMS 后，进行一次内存碎片整理<br>-XX:+CMSParallelRemarkEnabled 降低标记停顿</li>
</ul>
<h4 id="JAVA-参数总结"><a href="#JAVA-参数总结" class="headerlink" title="JAVA 参数总结"></a>JAVA 参数总结</h4><table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-Xms</td>
<td><font style="white-space:nowrap;"> 初始堆大小</font></td>
<td>物理内存的 1&#x2F;64(&lt;1GB)</td>
<td>默认(MinHeapFreeRatio 参数可以调整)空余堆内存小于 40%时，JVM 就会增大堆直到-Xmx 的最大限制.</td>
</tr>
<tr>
<td>-Xmx</td>
<td>最大堆大小</td>
<td>物理内存的 1&#x2F;4(&lt;1GB)</td>
<td>默认(MaxHeapFreeRatio 参数可以调整)空余堆内存大于 70%时，JVM 会减少堆直到-Xms 的最小限制</td>
</tr>
<tr>
<td>-Xmn</td>
<td>年轻代大小(1.4or lator)</td>
<td></td>
<td>注意：此处的大小是（eden+ 2 survivor space).与 jmap -heap 中显示的 New gen 是不同的。 整个堆大小&#x3D;年轻代大小 + 年老代大小 + 持久代大小. 增大年轻代后,将会减小年老代大小.此值对系统性能影响较大,Sun 官方推荐配置为整个堆的 3&#x2F;8</td>
</tr>
<tr>
<td>-XX:NewSize</td>
<td>设置年轻代大小(for 1.3&#x2F;1.4)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:MaxNewSize</td>
<td>年轻代最大值(for 1.3&#x2F;1.4)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:PermSize</td>
<td>设置持久代(perm gen)初始值</td>
<td>物理内存的 1&#x2F;64</td>
<td></td>
</tr>
<tr>
<td>-XX:MaxPermSize</td>
<td>设置持久代最大值</td>
<td>物理内存的 1&#x2F;4</td>
<td></td>
</tr>
<tr>
<td>-Xss</td>
<td>-Xss</td>
<td></td>
<td>JDK5.0 以后每个线程堆栈大小为 1M,以前每个线程堆栈大小为 256K.更具应用的线程所需内存大小进行 调整.在相同物理内存下,减小这个值能生成更多的线程.但是操作系统对一个进程内的线程数还是有限制的,不能无限生成,经验值在 3000~5000 左右 一般小的应用， 如果栈不是很深， 应该是 128k 够用的 大的应用建议使用 256k。这个选项对性能影响比较大，需要严格的测试。</td>
</tr>
<tr>
<td>-XX:ThreadStackSize</td>
<td>Thread StackSize</td>
<td></td>
<td>(0 means use defaultstack size) [Sparc: 512;Solaris x86: 320 (was 256prior in 5.0 and earlier);Sparc 64 bit: 1024; Linuxamd64: 1024 (was 0 in 5.0and earlier); all others 0.]</td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>年轻代(包括 Eden 和两个 Survivor 区)与年老代的比值(除去持久代)</td>
<td></td>
<td>-XX:NewRatio&#x3D;4 表示年轻代与年老代所占比值为 1:4,年轻代占整个堆栈的 1&#x2F;5Xms&#x3D;Xmx 并且设置了 Xmn 的情况下，该参数不需要进行设置。</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>Eden 区与 Survivor 区的大小比值</td>
<td></td>
<td>设置为 8,则两个 Survivor 区与一个 Eden 区的比值为 2:8,一个 Survivor 区占整个年轻代的 1&#x2F;10</td>
</tr>
<tr>
<td>-XX:LargePageSizeInBytes</td>
<td>内存页的大小不可设置过大， 会影响 Perm 的大小</td>
<td></td>
<td>&#x3D;128m</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+UseFastAccessorMethods</font></td>
<td>原始类型的快速优化</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+DisableExplicitGC</td>
<td>关闭 System.gc()</td>
<td></td>
<td>这个参数需要严格的测试</td>
</tr>
<tr>
<td>-XX:MaxTenuringThreshold</td>
<td>垃圾最大年龄</td>
<td></td>
<td>如果设置为 0 的话,则年轻代对象不经过 Survivor 区,直接进入年老代. 对于年老代比较多的应用,可以提高效率.如果将此值设置为一个较大值,则年轻代对象会在 Survivor 区进行多次复制,这样可以增加对象再年轻代的存活 时间,增加在年轻代即被回收的概率 该参数只有在串行 GC 时才有效</td>
</tr>
<tr>
<td>-XX:+AggressiveOpts</td>
<td>加快编译</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+UseBiasedLocking</td>
<td>锁机制的性能改善</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-Xnoclassgc</td>
<td>禁用垃圾回收</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:SoftRefLRUPolicyMSPerMB</td>
<td>每兆堆空闲空间中 SoftReference 的存活时间</td>
<td></td>
<td>可达的对象在上次被引用后将保留一段时间。 缺省值是堆中每个空闲兆字节的生命周期的一秒钟</td>
</tr>
<tr>
<td>-XX:PretenureSizeThreshold</td>
<td>对象超过多大是直接在旧生代分配</td>
<td>0</td>
<td>单位字节 新生代采用 Parallel Scavenge GC 时无效 另一种直接在旧生代分配的情况是大的数组对象,且数组中无外部引用对象</td>
</tr>
<tr>
<td>-XX:TLABWasteTargetPercent</td>
<td>TLAB 占 eden 区的百分比</td>
<td>1%</td>
<td></td>
</tr>
<tr>
<td>-XX:+CollectGen0First</td>
<td>FullGC 时是否先 YGC</td>
<td>false</td>
<td></td>
</tr>
</tbody></table>
<p><strong>并行收集器相关参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseParallelGC</td>
<td>Full GC 采用 parallelMSC</td>
<td></td>
<td>选择垃圾收集器为并行收集器.此配置仅对年轻代有效.即上述配置下,年轻代使用并发收集,而年老代仍旧使用串行收集</td>
</tr>
<tr>
<td>-XX:+UseParNewGC</td>
<td>设置年轻代为并行收集</td>
<td></td>
<td>可与 CMS 收集同时使用 JDK5.0 以上,JVM 会根据系统配置自行设置,所以无需再设置此值</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads</td>
<td>并行收集器的线程数</td>
<td></td>
<td>此值最好配置与处理器数目相等 同样适用于 CMS</td>
</tr>
<tr>
<td>-XX:+UseParallelOldGC</td>
<td>年老代垃圾收集方式为并行收集(ParallelCompacting)</td>
<td></td>
<td>这个是 JAVA 6 出现的参数选项</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis</td>
<td>每次年轻代垃圾回收的最长时间(最大暂停时间)</td>
<td></td>
<td>如果无法满足此时间,JVM 会自动调整年轻代大小,以满足此值</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+UseAdaptiveSizePolicy</font></td>
<td>自动选择年轻代区大小和相应的 Survivor 区比例</td>
<td></td>
<td>设置此选项后,并行收集器会自动选择年轻代区大小和相应的 Survivor 区比例,以达到目标系统规定的最低相应时间或者收集频率等,此值建议使用并行收集器时,一直打开</td>
</tr>
<tr>
<td>-XX:GCTimeRatio</td>
<td>设置垃圾回收时间占程序运行时间的百分比</td>
<td></td>
<td>公式为 1&#x2F;(1+n)</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+ScavengeBeforeFullGC</font></td>
<td>Full GC 前调用 YGC</td>
<td>true</td>
<td></td>
</tr>
</tbody></table>
<p><strong>CMS 相关参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>使用 CMS 内存收集</td>
<td></td>
<td>测试中配置这个以后,-XX:NewRatio&#x3D;4 的配置可能失效,所以,此时年轻代大小最好用-Xmn 设置</td>
</tr>
<tr>
<td>-XX:+AggressiveHeap</td>
<td></td>
<td></td>
<td>试图是使用大量的物理内存 长时间大内存使用的优化，能检查计算资源（内存， 处理器数量） 至少需要 256MB 内存 大量的 CPU／内存， （在 1.4.1 在 4CPU 的机器上已经显示有提升）</td>
</tr>
<tr>
<td>-XX:CMSFullGCsBeforeCompaction</td>
<td>多少次后进行内存压缩</td>
<td></td>
<td>由于并发收集器不对内存空间进行压缩,整理,所以运行一段时间以后会产生”碎片”,使得运行效率降低.此值设置运行多少次 GC 以后对内存空间进行压缩,整理</td>
</tr>
<tr>
<td>-XX:+CMSParallelRemarkEnabled</td>
<td>降低标记停顿</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX+UseCMSCompactAtFullCollection</td>
<td>在 FULLGC 的时候，对年老代的压缩</td>
<td></td>
<td>CMS 是不会移动内存的， 因此， 这个非常容易产生碎片，导致内存不够用， 因此， 内存的压缩这个时候就会被启用。增加这个参数是个好习惯。 可能会影响性能,但是可以消除碎片</td>
</tr>
<tr>
<td>-XX:+UseCMSInitiatingOccupancyOnly</td>
<td>使用手动定义初始化定义开始 CMS 收集</td>
<td></td>
<td>禁止 hostspot 自行触发 CMSGC</td>
</tr>
<tr>
<td>-XX:CMSInitiatingOccupancyFraction&#x3D;70</td>
<td>使用 cms 作为垃圾回收使用 70％后开始 CMS 收集</td>
<td>92</td>
<td></td>
</tr>
<tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>使用 CMS 内存收集</td>
<td></td>
<td>测试中配置这个以后,-XX:NewRatio&#x3D;4 的配置可能失效,所以,此时年轻代大小最好用-Xmn 设置</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:CMSInitiatingPermOccupancyFraction</font></td>
<td>设置 PermGen 使用到达多少比率时触发</td>
<td>92</td>
<td></td>
</tr>
<tr>
<td>-XX:+CMSIncrementalMode</td>
<td>设置为增量模式</td>
<td></td>
<td>用于单 CPU 情况</td>
</tr>
<tr>
<td>-XX:+CMSClassUnloadingEnabled</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>辅助信息：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+PrintGC</td>
<td></td>
<td></td>
<td>输出形式:[GC 118250K-&gt;113543K(130112K),0.0094143 secs] [Full GC121376K-&gt;10414K(130112K),0.0650971 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCDetails</td>
<td></td>
<td></td>
<td>输出形式:[GC [DefNew:8614K-&gt;781K(9088K),0.0123035 secs] 118250K-&gt;113543K(130112K),0.0124633 secs] [GC[DefNew: 8614K-&gt;8614K(9088K), 0.0000665secs] 121376K-&gt;10414K(130112K),0.0436268 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCTimeStamps</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintGC:PrintGCTimeStamps</td>
<td></td>
<td></td>
<td>可与-XX:+PrintGC -XX:+PrintGCDetails 混合使用输出形式:11.851: [GC98328K-&gt;93620K(130112K),0.0082960 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationStoppedTime</td>
<td>打印垃圾回收期间程序暂停的时间.可与上面混合使用</td>
<td></td>
<td>输出形式:Total time forwhich application threadswere stopped: 0.0468229seconds</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+PrintGCApplicationConcurrentTime</font></td>
<td>打印每次垃圾回收前,程序未中断的执行时间.可与上面混合使用</td>
<td></td>
<td>输出形式:Application time:0.5291524 seconds</td>
</tr>
<tr>
<td>-XX:+PrintHeapAtGC</td>
<td>打印 GC 前后的详细堆栈信息</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-Xloggc:filename</td>
<td>把相关日志信息记录到文件以便分析. 与上面几个配合使用</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintGC</td>
<td></td>
<td></td>
<td>输出形式:[GC 118250K-&gt;113543K(130112K),0.0094143 secs] [Full GC121376K-&gt;10414K(130112K),0.0650971 secs]</td>
</tr>
<tr>
<td>-XX:+PrintClassHistogram</td>
<td>garbagecollectsbeforeprintingthehistogram</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintTLAB</td>
<td>查看 TLAB 空间的使用情况</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintTenuringDistribution</td>
<td>查看每次 minor GC 后新的存活周期的阈值</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="JVM-相关工具"><a href="#JVM-相关工具" class="headerlink" title="JVM 相关工具"></a>JVM 相关工具</h3><p>$JAVA_HOME&#x2F;bin 下</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>jps</td>
<td>查看所有 jvm 进程</td>
</tr>
<tr>
<td>jinfo</td>
<td>查看进程的运行环境参数，主要是 jvm 命令行参数</td>
</tr>
<tr>
<td>jstat</td>
<td>对 jvm 应用程序的资源和性能进行实时监控</td>
</tr>
<tr>
<td>jstack</td>
<td>查看所有线程的运行状态，程序员常用堆栈情况查看工具</td>
</tr>
<tr>
<td>jmap</td>
<td>查看 jvm 占用物理内存的状态</td>
</tr>
<tr>
<td>jhat</td>
<td>+UseParNew</td>
</tr>
<tr>
<td>jconsole</td>
<td>图形工具</td>
</tr>
<tr>
<td>jvisualvm</td>
<td>图形工具</td>
</tr>
</tbody></table>
<h4 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a>JMX</h4><p>JMX（Java Management Extensions，即 Java 管理扩展）是一个为应用程序、设备、系统等植入管理功能的框架。JMX 可以跨越一系列异构操作系统平台、系统体系结构和网络传输协议，灵活的开发无缝集成的系统、网络和服务管理应用。<br>JMX 最常见的场景是监控 Java 程序的基本信息和运行情况，任何 Java 程序都可以开启 JMX，然后使用 JConsole 或 Visual VM 进行预览。</p>
<p>为 Java 程序开启 JMX 很简单，只要在运行 Java 程序的命令后面指定如下命令即可</p>
<p>在 tomcat 开启远程 JMX 如下配置：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-Dcom.sun.management.jmxremote</span>	<span class="token comment">#启用远程监控JMX</span>
<span class="token parameter variable">-Djava.rmi.server.hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.71	<span class="token comment">#tomcat主机自己的IP地址,不要写zabbix服务器的地址</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote.port</span><span class="token operator">=</span><span class="token number">1100</span>	<span class="token comment">#默认启动的JMX端口号，要和zabbix添加主机时候的端口一致</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote.ssl</span><span class="token operator">=</span>false	<span class="token comment">#不启用ssl认证</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote.authenticate</span><span class="token operator">=</span>false	<span class="token comment">#不启用用户名密码认证</span></code></pre>

<h4 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h4><p>JVM 进程状态工具</p>
<h4 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h4><p>输出给定的 java 进程的所有配置信息</p>
<h4 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h4><p>输出指定的 java 进程的统计信息</p>
<h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p>查看指定的 java 进程的线程栈的相关信息，程序员常用堆栈情况查看工具</p>
<h4 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h4><p>Memory Map，用于查看堆内存的使用状态</p>
<h4 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a>jhat</h4><p>Java Heap Analysis Tool 堆分析工具</p>
<h4 id="jconsole"><a href="#jconsole" class="headerlink" title="jconsole"></a>jconsole</h4><p>查看 Java 进程信息的图形化工具</p>
<ol>
<li><p>配置 JMX，在服务器 10.0.0.71 上做如下配置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$vim</span> /usr/local/tomcat/bin/catalina.sh
<span class="token comment"># OS specific support.  $var _must_ be set to either true or false.</span>
<span class="token comment"># 添加以下配置，注意位置，如果添加在文件末尾，则无法生效</span>
<span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Djava.rmi.server.hostname=10.0.0.71 -Dcom.sun.management.jmxremote.port=1100 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false"</span>

<span class="token variable">$systemctl</span> restart tomcat.service</code></pre>
</li>
<li><p>在 windows 上配置好 jdk，去 jdk&#x2F;bin 目录下，启动 jconsole.exe</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612438140927.png"></p>
</li>
</ol>
<h4 id="jvisualvm"><a href="#jvisualvm" class="headerlink" title="jvisualvm"></a>jvisualvm</h4><p>监控 jvm 的图形化工具，可以本机监控，也可以远程监控，下面以远程监控为例：</p>
<ol>
<li><p>配置 JMX，在服务器 10.0.0.71 上做如下配置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$vim</span> /usr/local/tomcat/bin/catalina.sh
<span class="token comment"># OS specific support.  $var _must_ be set to either true or false.</span>
<span class="token comment"># 添加以下配置，注意位置，如果添加在文件末尾，则无法生效</span>
<span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Djava.rmi.server.hostname=10.0.0.71 -Dcom.sun.management.jmxremote.port=1100 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false"</span>

<span class="token variable">$systemctl</span> restart tomcat.service</code></pre>
</li>
<li><p>在 windows 上配置好 jdk，去 jdk&#x2F;bin 目录下，启动 jvisualvm.exe，添加远程主机 -&gt; 选择添加 jmx 连接</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612434978564.png"></p>
</li>
</ol>
<h5 id="使用-jvisualvm-的-Visual-GC-插件"><a href="#使用-jvisualvm-的-Visual-GC-插件" class="headerlink" title="使用 jvisualvm 的 Visual GC 插件"></a>使用 jvisualvm 的 Visual GC 插件</h5><p><img data-src="//img.to2b.cn/blog/ljk/1612435183380.png"></p>
<p>安装完成后，重启即可，不过因为是远程连接，还需要做其他配置，这个问题百度解决，或者选择使用本机监控</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612435453238.png"></p>
<h4 id="Jprofiler"><a href="#Jprofiler" class="headerlink" title="Jprofiler"></a>Jprofiler</h4><p>JProfiler 是一款功能强大的 Java 开发分析工具，它可以快速的帮助用户分析出存在的错误，软件还可对需要的显示类进行标记，包括了内存的分配情况和信息的视图等</p>
<p>这个工具是收费的，可以用来定位 OOM 的问题原因</p>
<p>JProfiler 官网：<a target="_blank" rel="noopener" href="http://www.ej-technologies.com/products/jprofiler/overview.html">http://www.ej-technologies.com/products/jprofiler/overview.html</a></p>
<h3 id="Tomcat-性能优化常用配置"><a href="#Tomcat-性能优化常用配置" class="headerlink" title="Tomcat 性能优化常用配置"></a>Tomcat 性能优化常用配置</h3><h4 id="内存空间优化"><a href="#内存空间优化" class="headerlink" title="内存空间优化"></a>内存空间优化</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-server -Xms4g -Xmx4g -XX:NewSize= -XX:MaxNewSize= "</span>

-server：服务器模式，VM运行在server模式，为在服务器端最大化程序运行速度而优化
-Xms：堆内存初始化大小
-Xmx：堆内存空间上限
<span class="token parameter variable">-XX:NewSize</span><span class="token operator">=</span>：新生代空间初始化大小
<span class="token parameter variable">-XX:MaxNewSize</span><span class="token operator">=</span>：新生代空间最大值</code></pre>

<p>生产案例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /usr/local/tomcat/bin/catalina.sh</span>
<span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-server -Xms4g -Xmx4g -Xss512k -Xmn1g -
XX:CMSInitiatingOccupancyFraction=65 -XX:+AggressiveOpts -XX:+UseBiasedLocking -
XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewRatio=2 -
XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -
XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -
XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -
XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods"</span></code></pre>

<p>一台 tomcat 服务器并发连接数不高，生产建议分配物理内存通常 4G 到 8G 较多，如果需要更多连接，一般会利用虚拟化技术实现多台 tomcat</p>
<h4 id="线程池调整"><a href="#线程池调整" class="headerlink" title="线程池调整"></a>线程池调整</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#vim /usr/local/tomcat/conf/server.xml</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token operator">&lt;</span>Connector <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"8080"</span> <span class="token assign-left variable">protocol</span><span class="token operator">=</span><span class="token string">"HTTP/1.1"</span> <span class="token assign-left variable">connectionTimeout</span><span class="token operator">=</span><span class="token string">"20000"</span>
<span class="token assign-left variable">redirectPort</span><span class="token operator">=</span><span class="token string">"8443"</span> /<span class="token operator">></span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></code></pre>

<p>常用属性：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">connectionTimeout		<span class="token comment"># 连接超时时长,单位ms</span>
maxThreads				<span class="token comment"># 最大线程数，默认200</span>
minSpareThreads			<span class="token comment"># 最小空闲线程数</span>
maxSpareThreads			<span class="token comment"># 最大空闲线程数</span>
acceptCount				<span class="token comment"># 当启动线程满了之后，等待队列的最大长度，默认100</span>
URIEncoding				<span class="token comment"># URI 地址编码格式，建议使用 UTF-8</span>
enableLookups			<span class="token comment"># 是否启用客户端主机名的DNS反向解析，缺省禁用，建议禁用，就使用客户端IP就行</span>
compression				<span class="token comment"># 是否启用传输压缩机制，建议 "on"，CPU和流量的平衡</span>
	compressionMinSize		<span class="token comment"># 启用压缩传输的数据流最小值，单位是字节</span>
	compressableMimeType 	<span class="token comment"># 定义启用压缩功能的 MIME 类型text/html、text/css、text/javascript</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/jinja2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/jinja2/" class="post-title-link" itemprop="url">jinja2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-27 23:46:17" itemprop="dateCreated datePublished" datetime="2021-01-27T23:46:17+08:00">2021-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">运维自动化</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/" itemprop="url" rel="index"><span itemprop="name">ANSIBLE</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Jinja2 是基于 python 的模板引擎，功能比较类似于于 PHP 的 smarty</p>
<p>参考文档：<a target="_blank" rel="noopener" href="http://docs.jinkan.org/docs/jinja2/index.html">http://docs.jinkan.org/docs/jinja2/index.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/yaml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/yaml/" class="post-title-link" itemprop="url">yaml</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-27 23:46:06" itemprop="dateCreated datePublished" datetime="2021-01-27T23:46:06+08:00">2021-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">运维自动化</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/" itemprop="url" rel="index"><span itemprop="name">ANSIBLE</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="语法："><a href="#语法：" class="headerlink" title="语法："></a>语法：</h2><ul>
<li>扩展名通常为 yml 或 yaml</li>
<li>在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件的结尾</li>
<li>次行开始正常写 Playbook 的内容，一般建议写明该 Playbook 的功能</li>
<li>使用#号注释代码</li>
<li>缩进必须是统一的，不能空格和 tab 混用</li>
<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</li>
<li>YAML 文件内容是区别大小写的，key&#x2F;value 的值均需大小写敏感</li>
<li>多个 key&#x2F;value 可同行写也可换行写，同行使用，分隔</li>
<li>key 后面冒号要加一个空格 比如: key: value</li>
<li>value 可是个字符串，也可是另一个列表</li>
</ul>
<h2 id="支持的数据类型"><a href="#支持的数据类型" class="headerlink" title="支持的数据类型"></a>支持的数据类型</h2><ul>
<li>标量：单个的、不可再分的值</li>
<li>对象：键值对的集合，又称为映射（mapping）&#x2F; 哈希（hashes） &#x2F; 字典（dictionary）</li>
<li>数组：一组按次序排列的值，又称为序列（sequence） &#x2F; 列表（list）</li>
</ul>
<h2 id="scalar-标量"><a href="#scalar-标量" class="headerlink" title="scalar 标量"></a>scalar 标量</h2><p>标量是最基本的，不可再分的值，包括：<strong>字符串、布尔值、整数、浮点数、Null、时间、日期</strong></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 一行</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> lujinkai
<span class="token comment"># 使用缩进</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span>
  wang</code></pre>

<h2 id="dictionary-字典"><a href="#dictionary-字典" class="headerlink" title="dictionary 字典"></a>dictionary 字典</h2><p>字典由多个键值对组成，键值用: 分割，注意:后面有一个空格；值可以是标量、列表或其他字典</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 一行</span>
account: <span class="token punctuation">&#123;</span> name: lujinkai, age: <span class="token number">26</span> <span class="token punctuation">&#125;</span>
<span class="token comment"># 使用缩进</span>
account:
  name: lujinkai
  age: <span class="token number">26</span></code></pre>

<h2 id="list-列表"><a href="#list-列表" class="headerlink" title="list 列表"></a>list 列表</h2><p>列表由多个元素组成，元素可以是标量、字典或其他列表</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 一行</span>
skills: <span class="token punctuation">[</span> linux, golang, python <span class="token punctuation">]</span>
<span class="token comment"># 使用缩进</span>
skills:
  - linux
  - golang
  - python</code></pre>

<p>范例：使用 yaml 表示一个家庭</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> John Smith
<span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">41</span>
<span class="token key atrule">gender</span><span class="token punctuation">:</span> Male
<span class="token key atrule">spouse</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> Jane Smith
  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">37</span>
  <span class="token key atrule">gender</span><span class="token punctuation">:</span> Female
<span class="token key atrule">children</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Jimmy Smith
    <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">17</span>
    <span class="token key atrule">gender</span><span class="token punctuation">:</span> Male
  <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Jenny Smith<span class="token punctuation">,</span> <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token key atrule">gender</span><span class="token punctuation">:</span> Female <span class="token punctuation">&#125;</span>
  <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hao Smith<span class="token punctuation">,</span> <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token key atrule">gender</span><span class="token punctuation">:</span> Male <span class="token punctuation">&#125;</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">文本处理相关命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-27 18:58:03" itemprop="dateCreated datePublished" datetime="2021-01-27T18:58:03+08:00">2021-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">文本处理</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h2><p>如果没有指定文件，或者指定文件为 “-”，则从标准输入读取</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-n</span>    <span class="token comment"># 对输出内容标行号</span>
<span class="token parameter variable">-b</span>    <span class="token comment"># 对输出内容非空行标行号</span>
<span class="token parameter variable">-E</span>    <span class="token comment"># 显示行结束符$</span>
<span class="token parameter variable">-A</span>    <span class="token comment"># 显示所有控制符</span>
<span class="token parameter variable">-s</span>    <span class="token comment"># 压缩连续的空行成一行</span></code></pre>

<h2 id="nl"><a href="#nl" class="headerlink" title="nl"></a>nl</h2><p>相当于 <code>cat -b</code></p>
<h2 id="tac"><a href="#tac" class="headerlink" title="tac"></a>tac</h2><p>cat 倒着写 tac，功能也是恰如其名：逆向显示文本内容</p>
<h2 id="tr"><a href="#tr" class="headerlink" title="tr"></a>tr</h2><p>translate，转换、删除、去重标准输入中的字符，将结果写入到标准输出</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">tr</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. SET1 <span class="token punctuation">[</span>SET2<span class="token punctuation">]</span>

<span class="token parameter variable">-d</span>		<span class="token comment"># 删除</span>
<span class="token parameter variable">-c</span>		<span class="token comment"># 取补集</span>
<span class="token parameter variable">-s</span>		<span class="token comment"># 对set1进行去重操作</span>
<span class="token parameter variable">-t</span>		<span class="token comment"># 将第一个字符集对应字符转化为第二字符集对应的字符</span>
<span class="token parameter variable">-c</span>		<span class="token comment"># 取字符集的补集</span></code></pre>

<p>tr 类似于 sed 命令，但是比 sed 简单，所有 tr 能实现的功能，sed 都能实现</p>
<p>示例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将a换成b</span>
<span class="token variable">$tr</span> a b
<span class="token comment"># 生成8位随机数</span>
$ <span class="token function">cat</span> /dev/urandom <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-dc</span> A-Za-z0-9 <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-c8</span>
1imvyPoH
<span class="token comment"># 将a.log中大写输出为小写</span>
$ <span class="token function">cat</span> a.log
HELLO WORD
$ <span class="token function">tr</span> A-z a-z <span class="token operator">&lt;</span>a.log
hello word</code></pre>

<h2 id=""><a href="#" class="headerlink" title="-"></a>-</h2><p>重定向有时会使用 - 符号，重定向到标准输出</p>
<h2 id="rev"><a href="#rev" class="headerlink" title="rev"></a>rev</h2><p>将每行的内容逆向显示</p>
<h2 id="head"><a href="#head" class="headerlink" title="head"></a>head</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-c</span>   <span class="token comment">#指定前几个字符</span>
<span class="token parameter variable">-n</span>   <span class="token comment">#指定前几行，当n是负数(-#)，表示舍弃最后#行</span></code></pre>

<h2 id="tail"><a href="#tail" class="headerlink" title="tail"></a>tail</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-f</span>   <span class="token comment">#将文件尾部内容显示在终端，并不断刷新，常用于观察实时日志</span>
<span class="token parameter variable">-c</span>   <span class="token comment">#指定后几个字符</span>
<span class="token parameter variable">-n</span>   <span class="token comment">#指定后几行，当n是显示整数（+#），表示从第#行开始到结束</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1596538677023.png"></p>
<h2 id="less-和-more"><a href="#less-和-more" class="headerlink" title="less 和 more"></a>less 和 more</h2><p>分页查看文件内容</p>
<p>一般搭配管道符使用，less 和 more 差不多，区别在于 more 只能向下翻页</p>
<h2 id="hexdump、od、xxd"><a href="#hexdump、od、xxd" class="headerlink" title="hexdump、od、xxd"></a>hexdump、od、xxd</h2><p>查看非文本内容</p>
<p>最常的是 hexdump，常用选项 -C</p>
<h2 id="cut"><a href="#cut" class="headerlink" title="cut"></a>cut</h2><p>提取文本文件或 STDIN 数据的指定列</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cut</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.

<span class="token parameter variable">-d</span> delimiter        <span class="token comment">#指明分隔符</span>
<span class="token parameter variable">-f</span> fileds
   n        <span class="token comment">#第n个字段, 例如: 3</span>
   n,n<span class="token punctuation">[</span>,n<span class="token punctuation">]</span>  <span class="token comment">#离散的多个字段, 例如: 1,3,6</span>
   n-n      <span class="token comment">#连续的多个字段, 例如: 1-6</span>
   混合使用: <span class="token number">1</span>-3,7
<span class="token parameter variable">-c</span>                  <span class="token comment">#按字符切割</span>
--output-delimiter  <span class="token comment">#指定输出分隔符</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">19</span>:22:09 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#cut -d : -f1-3 --output-delimiter=. passwd</span>
root.x.0
bin.x.1
daemon.x.2
adm.x.3
lp.x.4
sync.x.5
shutdown.x.6
halt.x.7
mail.x.8
operator.x.11
games.x.12
ftp.x.14
nobody.x.99
systemd-network.x.192
dbus.x.81
polkitd.x.999
sshd.x.74
postfix.x.89
lujinkai.x.1000
test.x.1001
test2.x.1002
gentoo.x.1003
tomcat.x.1004
mysql.x.1005
<span class="token punctuation">[</span><span class="token number">14</span>:49:02 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#cut -c1-3 passwd</span>
roo
bin
dae
adm
lp:
syn
shu
hal
mai
ope
gam
<span class="token function">ftp</span>
nob
sys
dbu
pol
<span class="token function">ssh</span>
pos
luj
tes
tes
gen
tom
mys</code></pre>

<h2 id="paste"><a href="#paste" class="headerlink" title="paste"></a>paste</h2><p>合并多个文件，合并多个文件同行号的列到一行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">paste</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.

<span class="token parameter variable">-d</span>   <span class="token comment">#分隔符, 指定分隔符, 默认分隔符TAB</span>
<span class="token parameter variable">-s</span>   <span class="token comment">#所有行合成一行显示</span></code></pre>

<h2 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h2><p>文本统计，用于统计文件或 STDIN 的行总数、单词总数、字节总数和字符总数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-l</span>   <span class="token comment">#统计行数</span>
<span class="token parameter variable">-w</span>   <span class="token comment">#统计单词数 (规则是有空格或者换行分隔才是单词)</span>
<span class="token parameter variable">-m</span>   <span class="token comment">#打印字符数 (空格和换行和tab都是字符)</span>
<span class="token parameter variable">-L</span>   <span class="token comment">#统计文件中最长行的长度</span></code></pre>

<h2 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h2><p>字典排序, 从小到大</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-r</span>  <span class="token comment">#反方向</span>
<span class="token parameter variable">-R</span>  <span class="token comment">#随机排序</span>
<span class="token parameter variable">-n</span>  <span class="token comment">#自然排序</span>
<span class="token parameter variable">-h</span>  <span class="token comment">#人类可读排序, 如: 2k 1G</span>
<span class="token parameter variable">-f</span>  <span class="token comment">#忽略大小写</span>
<span class="token parameter variable">-u</span>  <span class="token comment">#合并重复项, 即去重</span>
<span class="token parameter variable">-t</span>  <span class="token comment">#指定字段界定符</span>
<span class="token parameter variable">-k</span>  <span class="token comment">#配合-t使用, 指定使用第几个字符来排序</span></code></pre>

<p>示例：按照 UID 进行排序</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">21</span>:18:38 root@centos7 data<span class="token punctuation">]</span><span class="token comment">#cat /etc/passwd | sort -n -t: -k 3</span>
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
dbus:x:81:81:System message bus:/:/sbin/nologin
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
nobody:x:99:99:Nobody:/:/sbin/nologin
systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin
polkitd:x:999:998:User <span class="token keyword">for</span> polkitd:/:/sbin/nologin
lujinkai:x:1000:1000:lujinkai:/home/lujinkai:/bin/bash
test:x:1001:1001::/home/test:/bin/bash
test2:x:1002:1002::/home/test2:/bin/bash
gentoo:x:1003:1003:Gentoo Distribution:/home/gentoo:/bin/csh
tomcat:x:1004:1006::/home/tomcat:/sbin/nologin
mysql:x:1005:1009::/home/mysql:/bin/bash</code></pre>

<h2 id="uniq"><a href="#uniq" class="headerlink" title="uniq"></a>uniq</h2><p>去重，从输入中删除前后相接的重复的行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">uniq</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>FILE<span class="token punctuation">]</span><span class="token punctuation">..</span>.

<span class="token parameter variable">-c</span>    <span class="token comment"># 显示每行重复出现的次数, 重复的行必须相邻, 否则会单独统计</span>
<span class="token parameter variable">-d</span>    <span class="token comment"># 仅显示重复的行</span>
<span class="token parameter variable">-u</span>    <span class="token comment"># 仅显示不重复的行</span></code></pre>

<p>uniq 常和 sort 命令一起配合使用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sort</span> userlist.txt <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span></code></pre>

<h2 id="diff-和-path"><a href="#diff-和-path" class="headerlink" title="diff 和 path"></a>diff 和 path</h2><p>比较文本</p>
<h3 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h3><p>diff 命令比较两个文件之间的区别</p>
<p>常用选项 -u</p>
<h3 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h3><p>复制在其他文件中进行的改变 (要谨慎使用)</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">diff</span> <span class="token parameter variable">-u</span> foo.conf foo2.conf <span class="token operator">></span> foo.patch
patch <span class="token parameter variable">-b</span> foo.conf foo.patch</code></pre>

<h2 id="cmp"><a href="#cmp" class="headerlink" title="cmp"></a>cmp</h2><p>比较二进制文件，查看二进制文件的不同</p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>1、找出 ifconfig “网卡名” 命令结果中本机的 IPv4 地址</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@47105171233 wwwlogs<span class="token punctuation">]</span><span class="token comment"># cut -d' ' -f1 lujinkai.cn_nginx.log | sort -t' ' -k1 | uniq -c | sort -nr | head -n10</span>
    <span class="token number">276</span> <span class="token number">112.64</span>.64.36
    <span class="token number">186</span> <span class="token number">183.136</span>.190.62
    <span class="token number">184</span> <span class="token number">112.64</span>.64.47
    <span class="token number">184</span> <span class="token number">112.64</span>.64.40
    <span class="token number">184</span> <span class="token number">112.64</span>.64.33
    <span class="token number">121</span> <span class="token number">176.9</span>.32.203
     <span class="token number">94</span> <span class="token number">47.92</span>.207.41
     <span class="token number">92</span> <span class="token number">112.64</span>.64.43
     <span class="token number">92</span> <span class="token number">112.64</span>.64.39
     <span class="token number">92</span> <span class="token number">112.64</span>.64.35</code></pre>

<p>2、查出分区空间使用率的最大百分比值<br>3、查出用户 UID 最大值的用户名、UID 及 shell 类型<br>4、查出&#x2F;tmp 的权限，以数字方式显示<br>5、统计当前连接本机的每个远程主机 IP 的连接数，并按从大到小排序</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/%E4%B8%BA%E4%BB%80%E4%B9%88kubernetes%E4%B8%8D%E6%94%AF%E6%8C%81docker%E4%BA%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/%E4%B8%BA%E4%BB%80%E4%B9%88kubernetes%E4%B8%8D%E6%94%AF%E6%8C%81docker%E4%BA%86/" class="post-title-link" itemprop="url">为什么kubernetes不支持docker了</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-24 21:42:23" itemprop="dateCreated datePublished" datetime="2021-01-24T21:42:23+08:00">2021-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>官方解释称，Docker 作为一个完整的容器技术堆栈，在其创建之初就不是为了将其嵌入 Kubernetes 而设计的。除了其作为容器运行时本身的作用以外，Docker 还包含了一系列方便用户交互的 UX 更改，而这些额外的功能对于 Kubernetes 来说过于臃肿。</p>
<p>事实上，Docker 并不符合 Kubernetes 的容器运行时接口标准（CRI），官方必须要维护一个名为 Dockershim 的中间件才能够把 Docker 当作 Kubernetes 的容器运行时来使用。因此，官方建议用户使用符合 CRI 的 containerd 或 CRI-O 作为取代 Docker 的容器运行时，并表示最早将于 v1.23 版本把 Dockershim 从 Kubelet 中移除。</p>
<p>不过，Kubernetes 官方表示用户今后依然可以使用 Docker 来构建容器镜像，而 Docker 生成的镜像实际上也是一个 OCI（Open Container Initiative）镜像。无论使用什么工具来构建镜像，任何符合 OCI 标准的镜像在 Kubernetes 看来都是一样的。containerd 和 CRI-O 则可以提取这些镜像并运行它们。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/kubeasz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/kubeasz/" class="post-title-link" itemprop="url">kubeasz</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-24 21:42:04" itemprop="dateCreated datePublished" datetime="2021-01-24T21:42:04+08:00">2021-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz">https://github.com/easzlab/kubeasz</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/00-planning_and_overall_intro.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/00-planning_and_overall_intro.md</a></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>ip</th>
<th>主机名</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>master1</td>
<td>10.0.1.1&#x2F;21</td>
<td>k8s-master1.ljk.cn</td>
<td>同时部署 ansible</td>
</tr>
<tr>
<td>master2</td>
<td>10.0.1.2&#x2F;21</td>
<td>k8s-master2.ljk.cn</td>
<td></td>
</tr>
<tr>
<td>node1</td>
<td>10.0.1.3&#x2F;21</td>
<td>k8s-node1.ljk.cn</td>
<td></td>
</tr>
<tr>
<td>node2</td>
<td>10.0.1.4&#x2F;21</td>
<td>k8s-node2.ljk.cn</td>
<td></td>
</tr>
<tr>
<td>etcd1</td>
<td>10.0.2.1&#x2F;21</td>
<td>k8s-etcd1.ljk.cn</td>
<td></td>
</tr>
<tr>
<td>etcd2</td>
<td>10.0.2.2&#x2F;21</td>
<td>k8s-etcd2.ljk.cn</td>
<td></td>
</tr>
<tr>
<td>etcd3</td>
<td>10.0.2.3&#x2F;21</td>
<td>k8s-etcd3.ljk.cn</td>
<td></td>
</tr>
<tr>
<td>HAProxy1 + keepalived<br>给 master 做负载均衡</td>
<td>10.0.2.1&#x2F;21<br>vip：10.0.2.188:8443</td>
<td></td>
<td>和 etcd1 混用</td>
</tr>
<tr>
<td>HAProxy2 + keepalived<br/>给 master 做负载均衡</td>
<td>10.0.2.2&#x2F;2<br>vip：10.0.2.188:8443</td>
<td></td>
<td>和 etcd2 混用</td>
</tr>
<tr>
<td>harbor</td>
<td>10.0.2.3&#x2F;21</td>
<td></td>
<td>和 etcd3 混用</td>
</tr>
</tbody></table>
<p>架构图：</p>
<img data-src="//img.to2b.cn/blog/ljk/1615197258481.png" style="zoom:80%;" />

<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="校准时区和同步时间"><a href="#校准时区和同步时间" class="headerlink" title="校准时区和同步时间"></a>校准时区和同步时间</h3><ul>
<li><p>所有服务器，校准时区</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ timedatectl set-timezone Asia/Shanghai</code></pre>
</li>
<li><p>确保各节点时区设置一致、时间同步。 如果你的环境没有提供 NTP 时间同步，推荐集成安装 chrony</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ~<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> chrony
<span class="token punctuation">[</span>root@k8s-master1 ~<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-n</span> <span class="token string">'/^#/!p'</span> /etc/chrony/chrony.conf
server ntp.aliyun.com iburst
server time1.cloud.tencent.com iburst
keyfile /etc/chrony/chrony.keys
driftfile /var/lib/chrony/chrony.drift
logdir /var/log/chrony
maxupdateskew <span class="token number">100.0</span>
rtcsync
makestep <span class="token number">1</span> <span class="token number">3</span>
allow <span class="token number">10.0</span>.0.0/16
allow <span class="token number">10.0</span>.1.0/16
allow <span class="token number">10.0</span>.2.0/16
allow <span class="token number">10.0</span>.3.0/16
allow <span class="token number">10.0</span>.4.0/16
allow <span class="token number">10.0</span>.5.0/16
allow <span class="token number">10.0</span>.6.0/16
allow <span class="token number">10.0</span>.7.0/16
<span class="token builtin class-name">local</span> stratum <span class="token number">10</span>
<span class="token punctuation">[</span>root@k8s-master1 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart chronyd.service

<span class="token comment"># 其他节点</span>
<span class="token variable">$apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> chrony
<span class="token variable">$vim</span> /etc/chrony/chrony.conf
<span class="token punctuation">..</span>.
server <span class="token number">10.0</span>.1.1 iburst	<span class="token comment"># 只修改此行</span>
<span class="token punctuation">..</span>.
<span class="token variable">$systemctl</span> restart chronyd.service</code></pre></li>
</ul>
<h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><p>kubeasz 基于 ansible，而 ansible 基于 python 的，所以所有服务器都需要安装 python 环境</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt</span> <span class="token function">install</span> python3 –y</code></pre>

<h3 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h3><p>在 master1 上安装 ansible</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ~<span class="token punctuation">]</span><span class="token variable">$apt</span>-get <span class="token function">install</span> <span class="token function">git</span> python3-pip <span class="token parameter variable">-y</span>
<span class="token comment"># 优化pip</span>
<span class="token punctuation">[</span>root@k8s-master1 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> ~/.pip/pip.conf		<span class="token comment"># 没有就创建</span>
<span class="token punctuation">[</span>global<span class="token punctuation">]</span>
index-url <span class="token operator">=</span> https://mirrors.aliyun.com/pypi/simple/

<span class="token punctuation">[</span>install<span class="token punctuation">]</span>
trusted-host<span class="token operator">=</span>mirrors.aliyun.com

<span class="token punctuation">[</span>root@k8s-master1 ~<span class="token punctuation">]</span><span class="token variable">$pip3</span> <span class="token function">install</span> ansible		<span class="token comment"># 这一步时间很长，建议更改为阿里的pip源</span></code></pre>

<p>设置 ssh 免密</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">ssh_push_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token assign-left variable">ips</span><span class="token operator">=</span><span class="token punctuation">(</span>
        <span class="token number">10.0</span>.1.2
        <span class="token number">10.0</span>.1.3
        <span class="token number">10.0</span>.1.4
        <span class="token number">10.0</span>.2.1
        <span class="token number">10.0</span>.2.2
        <span class="token number">10.0</span>.2.3
    <span class="token punctuation">)</span>
    <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">ips</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span>
    <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> sshpass
    <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> ~/.ssh/id_rsa <span class="token punctuation">]</span> <span class="token operator">||</span> ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-f</span> ~/.ssh/id_rsa <span class="token parameter variable">-P</span> <span class="token string">''</span> <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>
    <span class="token builtin class-name">export</span> <span class="token assign-left variable">SSHPASS</span><span class="token operator">=</span>ljkk
    <span class="token keyword">for</span> <span class="token for-or-select variable">ip</span> <span class="token keyword">in</span> <span class="token variable">$&#123;ips<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token punctuation">(</span>
            <span class="token function">timeout</span> <span class="token number">5</span> <span class="token function">ssh</span> <span class="token variable">$ip</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$ip</span>: SSH has passwordless access!"</span>
            <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                sshpass <span class="token parameter variable">-e</span> ssh-copy-id <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no root@<span class="token variable">$ip</span> <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>
                <span class="token function">timeout</span> <span class="token number">5</span> <span class="token function">ssh</span> <span class="token variable">$ip</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$ip</span>: SSH has passwordless access!"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$ip</span>: SSH has no passwordless access!"</span>
            <span class="token keyword">fi</span>
        <span class="token punctuation">)</span> <span class="token operator">&amp;</span>
    <span class="token keyword">done</span>
    <span class="token function">wait</span>
<span class="token punctuation">&#125;</span>
ssh_push_key</code></pre>

<h3 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h3><p>10.0.2.1&#x2F;21 和 10.0.2.2&#x2F;21 均安装 keepalived</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装</span>
<span class="token variable">$apt</span> <span class="token function">install</span> keepalived <span class="token parameter variable">-y</span>
<span class="token variable">$vim</span> /etc/keepalived/keepalived.conf
global_defs <span class="token punctuation">&#123;</span>
    router_id keepalived1
    vrrp_skip_check_adv_addr
    vrrp_garp_interval <span class="token number">0</span>
    vrrp_gna_interval <span class="token number">0</span>
    vrrp_mcast_group4 <span class="token number">224.0</span>.0.18
<span class="token punctuation">&#125;</span>

vrrp_instance VI_1 <span class="token punctuation">&#123;</span>
    state MASTER
    interface eth0
    virtual_router_id <span class="token number">1</span>		<span class="token comment"># 另一个keepalived设置为2</span>
    priority <span class="token number">100</span>			<span class="token comment"># 另一个keepalived设置为120</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">&#123;</span>
        auth_type PASS
        auth_pass <span class="token number">123456</span>
    <span class="token punctuation">&#125;</span>
    virtual_ipaddress <span class="token punctuation">&#123;</span>
        <span class="token number">10.0</span>.2.188 dev eth0 label eth0:0
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$systemctl</span> restart keepalived.service</code></pre>

<h3 id="haproxy"><a href="#haproxy" class="headerlink" title="haproxy"></a>haproxy</h3><p>10.0.2.1&#x2F;21 和 10.0.2.2&#x2F;21 均安装 haproxy</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编译安装lua，过程略...</span>
<span class="token comment"># 编译安装haproxy</span>
<span class="token variable">$wget</span> http://www.haproxy.org/download/2.2/src/haproxy-2.2.6.tar.gz
<span class="token variable">$apt</span> <span class="token function">install</span> <span class="token function">make</span> gcc build-essential libssl-dev zlib1g-dev libpcre3 libpcre3-dev libsystemd-dev libreadline-dev <span class="token parameter variable">-y</span>
<span class="token variable">$useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin <span class="token parameter variable">-d</span> /var/lib/haproxy haproxy
<span class="token variable">$mkdir</span> /usr/local/haproxy
<span class="token variable">$tar</span> zxvf haproxy-2.2.6.tar.gz
<span class="token variable">$cd</span> haproxy-2.2.6/
<span class="token variable">$make</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86_64 <span class="token assign-left variable">TARGET</span><span class="token operator">=</span>linux-glibc <span class="token assign-left variable">USE_PCRE</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_OPENSSL</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_ZLIB</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_SYSTEMD</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">USE_LUA</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">LUA_INC</span><span class="token operator">=</span>/usr/local/lua/src/ <span class="token assign-left variable">LUA_LIB</span><span class="token operator">=</span>/usr/local/lua/src/
<span class="token variable">$make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token variable">$vim</span> /etc/profile	<span class="token comment"># export PATH=/usr/local/haproxy/sbin:$PATH</span>
$. /etc/profile
<span class="token variable">$haproxy</span> <span class="token parameter variable">-v</span>
<span class="token variable">$haproxy</span> <span class="token parameter variable">-V</span>
<span class="token variable">$haproxy</span> <span class="token parameter variable">-vv</span>

<span class="token comment"># 配置文件</span>
<span class="token variable">$mkdir</span> /var/lib/haproxy
<span class="token variable">$mkdir</span> /etc/haproxy
<span class="token variable">$vim</span> /etc/haproxy/haproxy.cfg
global
    <span class="token function">chroot</span> /usr/local/haproxy
    stats socket /var/lib/haproxy/haproxy.sock mode <span class="token number">600</span> level admin
    user haproxy
    group haproxy
    daemon
    nbproc <span class="token number">1</span>
    maxconn <span class="token number">100000</span>
    pidfile /var/lib/haproxy/haproxy.pid

defaults
    option redispatch
    option abortonclose
    option http-keep-alive
    option forwardfor
    maxconn <span class="token number">100000</span>
    mode http
    <span class="token function">timeout</span> connect 120s
    <span class="token function">timeout</span> server 120s
    <span class="token function">timeout</span> client 120s
    <span class="token function">timeout</span>     check 5s

listen stats
    stats <span class="token builtin class-name">enable</span>
    mode http
    <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:9999
    log global
    stats uri /haproxy-status
    stats auth admin:123456

listen k8s-api-8443
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.2.188:8443		<span class="token comment"># 注意，要和hosts的[ex-lb]对应起来</span>
    mode tcp
    server master1 <span class="token number">10.0</span>.1.1:6443 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>	<span class="token comment"># 6443端口是默认的，不能改</span>
    server master2 <span class="token number">10.0</span>.1.2:6443 check inter <span class="token number">2000</span> fall <span class="token number">3</span> rise <span class="token number">5</span>

<span class="token comment"># 启动文件</span>
<span class="token variable">$mkdir</span> /etc/haproxy/conf.d/
<span class="token variable">$vim</span> /lib/systemd/system/haproxy.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>HAProxy Load Balancer
<span class="token assign-left variable">After</span><span class="token operator">=</span>syslog.target network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/local/haproxy/sbin/haproxy <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-f</span> /etc/haproxy/conf.d/ <span class="token parameter variable">-c</span> <span class="token parameter variable">-q</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/haproxy/sbin/haproxy <span class="token parameter variable">-Ws</span> <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfg <span class="token parameter variable">-f</span> /etc/haproxy/conf.d/ <span class="token parameter variable">-p</span> /var/lib/haproxy/haproxy.pid
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-USR2</span> <span class="token variable">$MAINPID</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token variable">$systemctl</span> start haproxy.service</code></pre>

<h3 id="下载项目源码"><a href="#下载项目源码" class="headerlink" title="下载项目源码"></a>下载项目源码</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$export</span> <span class="token assign-left variable">release</span><span class="token operator">=</span><span class="token number">2.2</span>.4
<span class="token variable">$curl</span> -C- <span class="token parameter variable">-fLO</span> <span class="token parameter variable">--retry</span> <span class="token number">3</span> https://github.com/easzlab/kubeasz/releases/download/<span class="token variable">$&#123;release&#125;</span>/easzup
<span class="token variable">$chmod</span> +x ./easzup
<span class="token comment"># 使用工具脚本下载</span>
$./easzup <span class="token parameter variable">-D</span></code></pre>

<h3 id="配置集群参数"><a href="#配置集群参数" class="headerlink" title="配置集群参数"></a>配置集群参数</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /etc/ansible
<span class="token function">cp</span> example/hosts.multi-node hosts</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 'etcd' cluster should have odd member(s) (1,3,5,...)</span>
<span class="token comment"># variable 'NODE_NAME' is the distinct name of a member in 'etcd' cluster</span>
<span class="token punctuation">[</span>etcd<span class="token punctuation">]</span>
<span class="token number">10.0</span>.2.1 <span class="token assign-left variable">NODE_NAME</span><span class="token operator">=</span>etcd1
<span class="token number">10.0</span>.2.2 <span class="token assign-left variable">NODE_NAME</span><span class="token operator">=</span>etcd2
<span class="token number">10.0</span>.2.3 <span class="token assign-left variable">NODE_NAME</span><span class="token operator">=</span>etcd3

<span class="token comment"># master node(s)</span>
<span class="token punctuation">[</span>kube-master<span class="token punctuation">]</span>
<span class="token number">10.0</span>.1.1
<span class="token number">10.0</span>.1.2

<span class="token comment"># work node(s)</span>
<span class="token punctuation">[</span>kube-node<span class="token punctuation">]</span>
<span class="token number">10.0</span>.1.3
<span class="token comment">#10.0.1.4</span>

<span class="token comment"># [optional] harbor server, a private docker registry</span>
<span class="token comment"># 'NEW_INSTALL': 'yes' to install a harbor server; 'no' to integrate with existed one</span>
<span class="token comment"># 'SELF_SIGNED_CERT': 'no' you need put files of certificates named harbor.pem and harbor-key.pem in directory 'down'</span>
<span class="token punctuation">[</span>harbor<span class="token punctuation">]</span>
<span class="token comment">#192.168.1.8 HARBOR_DOMAIN="harbor.yourdomain.com" NEW_INSTALL=no SELF_SIGNED_CERT=yes</span>

<span class="token comment"># [optional] loadbalance for accessing k8s from outside</span>
<span class="token punctuation">[</span>ex-lb<span class="token punctuation">]</span>
<span class="token number">10.0</span>.2.1 <span class="token assign-left variable">LB_ROLE</span><span class="token operator">=</span>backup <span class="token assign-left variable">EX_APISERVER_VIP</span><span class="token operator">=</span><span class="token number">10.0</span>.2.188 <span class="token assign-left variable">EX_APISERVER_PORT</span><span class="token operator">=</span><span class="token number">8443</span>
<span class="token number">10.0</span>.2.2 <span class="token assign-left variable">LB_ROLE</span><span class="token operator">=</span>master <span class="token assign-left variable">EX_APISERVER_VIP</span><span class="token operator">=</span><span class="token number">10.0</span>.2.188 <span class="token assign-left variable">EX_APISERVER_PORT</span><span class="token operator">=</span><span class="token number">8443</span>

<span class="token comment"># [optional] ntp server for the cluster</span>
<span class="token punctuation">[</span>chrony<span class="token punctuation">]</span>
<span class="token comment">#192.168.1.1</span>

<span class="token punctuation">[</span>all:vars<span class="token punctuation">]</span>
<span class="token comment"># --------- Main Variables ---------------</span>
<span class="token comment"># Cluster container-runtime supported: docker, containerd</span>
<span class="token assign-left variable">CONTAINER_RUNTIME</span><span class="token operator">=</span><span class="token string">"docker"</span>

<span class="token comment"># Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn</span>
<span class="token assign-left variable">CLUSTER_NETWORK</span><span class="token operator">=</span><span class="token string">"calico"</span>

<span class="token comment"># Service proxy mode of kube-proxy: 'iptables' or 'ipvs'</span>
<span class="token assign-left variable">PROXY_MODE</span><span class="token operator">=</span><span class="token string">"ipvs"</span>

<span class="token comment"># K8S Service CIDR, not overlap with node(host) networking</span>
<span class="token assign-left variable">SERVICE_CIDR</span><span class="token operator">=</span><span class="token string">"192.168.0.0/16"</span>

<span class="token comment"># Cluster CIDR (Pod CIDR), not overlap with node(host) networking</span>
<span class="token assign-left variable">CLUSTER_CIDR</span><span class="token operator">=</span><span class="token string">"10.10.0.0/16"</span>

<span class="token comment"># NodePort Range</span>
<span class="token assign-left variable">NODE_PORT_RANGE</span><span class="token operator">=</span><span class="token string">"30000-60000"</span>

<span class="token comment"># Cluster DNS Domain</span>
<span class="token assign-left variable">CLUSTER_DNS_DOMAIN</span><span class="token operator">=</span><span class="token string">"ljk.local."</span>

<span class="token comment"># -------- Additional Variables (don't change the default value right now) ---</span>
<span class="token comment"># Binaries Directory</span>
<span class="token assign-left variable">bin_dir</span><span class="token operator">=</span><span class="token string">"/usr/local/bin"</span>

<span class="token comment"># CA and other components cert/key Directory</span>
<span class="token assign-left variable">ca_dir</span><span class="token operator">=</span><span class="token string">"/etc/kubernetes/ssl"</span>

<span class="token comment"># Deploy Directory (kubeasz workspace)</span>
<span class="token assign-left variable">base_dir</span><span class="token operator">=</span><span class="token string">"/etc/ansible"</span></code></pre>

<p>验证配置是否成功：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ansible</span> all <span class="token parameter variable">-m</span> <span class="token function">ping</span></code></pre>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="配置-harbor"><a href="#配置-harbor" class="headerlink" title="配置 harbor"></a>配置 harbor</h3><p>10.0.2.3，详细步骤参考：<a href="http://blog.lujinkai.cn/2021/01/08/%E8%BF%90%E7%BB%B4/Docker/docker%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86/">docker 仓库管理</a></p>
<p>因为笔记本性能问题，harbor 和 etcd 复用一个节点，所以 harbor 的 hostname 配置为 ip，如果 harbor 单独使用一台服务器，应该配置为 hostname</p>
<h3 id="00-规划集群和配置介绍"><a href="#00-规划集群和配置介绍" class="headerlink" title="00-规划集群和配置介绍"></a>00-规划集群和配置介绍</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/00-planning_and_overall_intro.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/00-planning_and_overall_intro.md</a></p>
<h3 id="01-创建证书和安装准备"><a href="#01-创建证书和安装准备" class="headerlink" title="01-创建证书和安装准备"></a>01-创建证书和安装准备</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/01-CA_and_prerequisite.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/01-CA_and_prerequisite.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/ansible
<span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook ./01.prepare.yml</code></pre>

<h3 id="02-安装-etcd-集群"><a href="#02-安装-etcd-集群" class="headerlink" title="02-安装 etcd 集群"></a>02-安装 etcd 集群</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/02-install_etcd.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/02-install_etcd.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook ./02.etcd.yml</code></pre>

<h3 id="03-安装-docker-服务"><a href="#03-安装-docker-服务" class="headerlink" title="03-安装 docker 服务"></a>03-安装 docker 服务</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/03-install_docker.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/03-install_docker.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook 03.docker.yml</code></pre>

<h3 id="04-安装-master-节点"><a href="#04-安装-master-节点" class="headerlink" title="04-安装 master 节点"></a>04-安装 master 节点</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/04-install_kube_master.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/04-install_kube_master.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook 04.kube-master.yml</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 报错：目标主机没有/opt/kube目录</span>
TASK <span class="token punctuation">[</span>kube-master <span class="token builtin class-name">:</span> 配置admin用户rbac权限<span class="token punctuation">]</span> ****************************************************************************************
fatal: <span class="token punctuation">[</span><span class="token number">10.0</span>.1.2<span class="token punctuation">]</span>: FAILED<span class="token operator">!</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token string">"changed"</span><span class="token builtin class-name">:</span> false, <span class="token string">"checksum"</span><span class="token builtin class-name">:</span> <span class="token string">"95ce2ef4052ea55b6326ce0fe9f6da49319874c7"</span>, <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"Destination directory /opt/kube does not exist"</span><span class="token punctuation">&#125;</span>
changed: <span class="token punctuation">[</span><span class="token number">10.0</span>.1.1<span class="token punctuation">]</span>

<span class="token comment"># 解决：去目标主机手动创建/opt/kube目录</span>
<span class="token punctuation">[</span>root@k8s-master2 ~<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /opt/kube
<span class="token comment"># 重新执行ansible-playbook</span>
<span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook 04.kube-master.yml</code></pre>

<h3 id="05-安装-node-节点"><a href="#05-安装-node-节点" class="headerlink" title="05-安装 node 节点"></a>05-安装 node 节点</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/05-install_kube_node.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/05-install_kube_node.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook 05.kube-node.yml</code></pre>

<h3 id="06-安装集群网络"><a href="#06-安装集群网络" class="headerlink" title="06-安装集群网络"></a>06-安装集群网络</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/06-install_network_plugin.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/06-install_network_plugin.md</a></p>
<p>公有云推荐使用 flannel，自建 IDC 推荐使用 calico，如果选择 calico，一定要关闭 IPIP</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$vim</span> roles/calico/defaults/main.yml
CALICO_IPV4POOL_IPIP: <span class="token string">"off"</span>			<span class="token comment"># 将always修改为off，关闭IPIP</span>
<span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook 06.network.yml</code></pre>

<h3 id="07-安装集群插件"><a href="#07-安装集群插件" class="headerlink" title="07-安装集群插件"></a>07-安装集群插件</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/07-install_cluster_addon.md">https://github.com/easzlab/kubeasz/blob/master/docs/setup/07-install_cluster_addon.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

<h3 id="安装-dashboard"><a href="#安装-dashboard" class="headerlink" title="安装 dashboard"></a>安装 dashboard</h3><p>安装部署：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 ansible<span class="token punctuation">]</span><span class="token variable">$cd</span> manifests/dashboard/
<span class="token punctuation">[</span>root@k8s-master1 dashboard<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/ansible/manifests/dashboard
<span class="token comment"># 部署dashboard 主yaml配置文件</span>
<span class="token punctuation">[</span>root@k8s-master1 dashboard<span class="token punctuation">]</span><span class="token variable">$kubectl</span> apply <span class="token parameter variable">-f</span> ./kubernetes-dashboard.yaml
<span class="token comment"># 创建可读可写 admin Service Account</span>
<span class="token punctuation">[</span>root@k8s-master1 dashboard<span class="token punctuation">]</span><span class="token variable">$kubectl</span> apply <span class="token parameter variable">-f</span> ./admin-user-sa-rbac.yaml
<span class="token comment"># 创建只读 read Service Account</span>
<span class="token punctuation">[</span>root@k8s-master1 dashboard<span class="token punctuation">]</span><span class="token variable">$kubectl</span> apply <span class="token parameter variable">-f</span> ./read-user-sa-rbac.yaml</code></pre>

<p>验证：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看pod 运行状态</span>
<span class="token punctuation">[</span>root@k8s-master1 dashboard<span class="token punctuation">]</span><span class="token variable">$kubectl</span> get pod <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> dashboard
dashboard-metrics-scraper-79c5968bdc-cqg8b   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          60m
kubernetes-dashboard-c4c6566d6-crqfc         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          60m
<span class="token comment"># 查看dashboard service</span>
<span class="token punctuation">[</span>root@k8s-master1 dashboard<span class="token punctuation">]</span><span class="token variable">$kubectl</span> get <span class="token function">service</span> <span class="token parameter variable">-n</span> kube-system<span class="token operator">|</span><span class="token function">grep</span> dashboard
dashboard-metrics-scraper ClusterIP <span class="token number">192.168</span>.233.194  <span class="token operator">&lt;</span>none<span class="token operator">></span>  <span class="token number">8000</span>/TCP       60m
kubernetes-dashboard      NodePort  <span class="token number">192.168</span>.249.138  <span class="token operator">&lt;</span>none<span class="token operator">></span>  <span class="token number">443</span>:44420/TCP  60m	<span class="token comment"># 44420</span>
<span class="token comment"># 查看集群服务</span>
<span class="token variable">$kubectl</span> cluster-info<span class="token operator">|</span><span class="token function">grep</span> dashboard
<span class="token comment"># 查看pod 运行日志</span>
<span class="token variable">$kubectl</span> logs kubernetes-dashboard-c4c6566d6-crqfc <span class="token parameter variable">-n</span> kube-system</code></pre>

<p>访问：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611914011003.png"></p>
<p>登录：</p>
<ul>
<li><p>token：令牌</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看用户 admin-user 的 token</span>
<span class="token variable">$kubectl</span> <span class="token parameter variable">-n</span> kube-system describe secret <span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get secret <span class="token operator">|</span> <span class="token function">grep</span> admin-user <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">)</span></span>

<span class="token comment"># 查看用户 read-user 的 token</span>
<span class="token variable">$kubectl</span> <span class="token parameter variable">-n</span> kube-system describe secret <span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get secret <span class="token operator">|</span> <span class="token function">grep</span> read-user <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">)</span></span></code></pre>
</li>
<li><p>kubeconfig：配置文件</p>
<p>将 token 追加到 &#x2F;root&#x2F;.kube&#x2F;config 文件中，然后将此文件作为登录的凭证</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611914384351.png"></p>
</li>
</ul>
<h3 id="测试网络"><a href="#测试网络" class="headerlink" title="测试网络"></a>测试网络</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装几个测试pod</span>
<span class="token comment"># 注意node上的/etc/docker/daemon.json 要配置"insecure-registries": ["10.0.2.3"]</span>
kubectl run net-test1 <span class="token parameter variable">--image</span><span class="token operator">=</span><span class="token number">10.0</span>.2.3/baseimages/alpine:3.13 <span class="token function">sleep</span> <span class="token number">360000</span>
kubectl run net-test2 <span class="token parameter variable">--image</span><span class="token operator">=</span><span class="token number">10.0</span>.2.3/baseimages/alpine:3.13 <span class="token function">sleep</span> <span class="token number">360000</span>
kubectl run net-test3 <span class="token parameter variable">--image</span><span class="token operator">=</span><span class="token number">10.0</span>.2.3/baseimages/alpine:3.13 <span class="token function">sleep</span> <span class="token number">360000</span>
<span class="token comment"># 查看pod，确保跑在不同的node上，这样才能测试网络</span>
<span class="token variable">$kubectl</span> get pod <span class="token parameter variable">-o</span> wide
NAME     READY    STATUS    RESTARTS AGE   IP     NODE  NOMINATED NODE  READINESS GATES
net-test1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>    7m11s   <span class="token number">10.10</span>.210.4   <span class="token number">10.0</span>.1.4   <span class="token operator">&lt;</span>none<span class="token operator">></span>    <span class="token operator">&lt;</span>none<span class="token operator">></span>
net-test2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>    2m27s   <span class="token number">10.10</span>.210.5   <span class="token number">10.0</span>.1.4   <span class="token operator">&lt;</span>none<span class="token operator">></span>    <span class="token operator">&lt;</span>none<span class="token operator">></span>
net-test3   <span class="token number">1</span>/1     Running   <span class="token number">0</span>    2m6s    <span class="token number">10.10</span>.246.66  <span class="token number">10.0</span>.1.3   <span class="token operator">&lt;</span>none<span class="token operator">></span>     <span class="token operator">&lt;</span>none<span class="token operator">></span>
<span class="token comment"># 测试：进入pod，ping其他node的pod的ip，确保能ping通</span></code></pre>

<h3 id="安装-CoreDNS"><a href="#安装-CoreDNS" class="headerlink" title="安装 CoreDNS"></a>安装 CoreDNS</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入到pod中，无法ping通域名，这时因为没有配置dns</span>
<span class="token variable">$ping</span> kubernetes.default.svc.ljk.local
ping: bad address <span class="token string">'kubernetes.default.svc.ljk.local'</span></code></pre>

<h4 id="自行安装"><a href="#自行安装" class="headerlink" title="自行安装"></a>自行安装</h4><p>coredns 官方 github 提供的安装脚本，依赖 kube-dns，所以我们使用 kubernetes 官方提供的 yaml 进行安装</p>
<p>去 kubernetes 的官方 github 仓库，下载二进制文件</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611918663693.png"></p>
<p>打开后，往下拉，下载 client、node、server 三个源码包，注意要下载 amd64 版本，不要下载错了</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">https://dl.k8s.io/v1.20.2/kubernetes.tar.gz
https://dl.k8s.io/v1.20.2/kubernetes-client-linux-amd64.tar.gz
https://dl.k8s.io/v1.20.2/kubernetes-node-linux-amd64.tar.gz
https://dl.k8s.io/v1.20.2/kubernetes-server-linux-amd64.tar.gz</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf kubernetes.tar.gz
<span class="token punctuation">[</span>root@k8s-master1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf kubernetes-client-linux-amd64.tar.gz
<span class="token punctuation">[</span>root@k8s-master1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf kubernetes-node-linux-amd64.tar.gz
<span class="token punctuation">[</span>root@k8s-master1 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxf kubernetes-server-linux-amd64.tar.gz
<span class="token punctuation">[</span>root@k8s-master1 src<span class="token punctuation">]</span><span class="token variable">$cd</span> kubernetes/
<span class="token punctuation">[</span>root@k8s-master1 kubernetes<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">33672</span>
drwxr-xr-x <span class="token number">10</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:44 ./
drwxr-xr-x  <span class="token number">3</span> root root     <span class="token number">4096</span> Jan <span class="token number">29</span> <span class="token number">19</span>:38 <span class="token punctuation">..</span>/
drwxr-xr-x  <span class="token number">2</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:44 addons/
drwxr-xr-x  <span class="token number">3</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:40 client/
drwxr-xr-x  <span class="token number">9</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 cluster/
drwxr-xr-x  <span class="token number">2</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 docs/
drwxr-xr-x  <span class="token number">3</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 hack/
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">34426961</span> Jan <span class="token number">13</span> <span class="token number">21</span>:44 kubernetes-src.tar.gz
drwxr-xr-x  <span class="token number">3</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:44 LICENSES/
drwxr-xr-x  <span class="token number">3</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:41 node/
-rw-r--r--  <span class="token number">1</span> root root     <span class="token number">3386</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 README.md
drwxr-xr-x  <span class="token number">3</span> root root     <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:41 server/
-rw-r--r--  <span class="token number">1</span> root root        <span class="token number">8</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 version
<span class="token punctuation">[</span>root@k8s-master1 kubernetes<span class="token punctuation">]</span><span class="token variable">$ll</span> server/bin/	<span class="token comment"># 这些都是go写的二进制程序，可以直接执行的</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@k8s-master1 kubernetes<span class="token punctuation">]</span><span class="token variable">$cd</span> ./cluster/addons/dns/coredns/
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">44</span>
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">4096</span> Jan <span class="token number">29</span> <span class="token number">21</span>:39 ./
drwxr-xr-x <span class="token number">5</span> root root <span class="token number">4096</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 <span class="token punctuation">..</span>/
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">4957</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 coredns.yaml.base
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">5007</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 coredns.yaml.in	<span class="token comment"># 基于coredns.yaml.base</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">5009</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 coredns.yaml.sed	<span class="token comment"># 基于coredns.yaml.base</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1075</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 Makefile
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">344</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 transforms2salt.sed
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">287</span> Jan <span class="token number">13</span> <span class="token number">21</span>:46 transforms2sed.sed
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$mkdir</span> <span class="token parameter variable">-p</span> /etc/ansible/manifests/dns/coredns	<span class="token comment"># 规划一下目录</span>
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$cp</span> coredns.yaml.base /etc/ansible/manifests/dns/coredns/coredns.yaml
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$cd</span> /etc/ansible/manifests/dns/coredns/
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$ls</span>
coredns.yaml
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$vim</span> coredns.yaml
<span class="token comment"># 修改以下几行</span>
image: <span class="token number">10.0</span>.2.3/baseimages/coredns:1.7.0		<span class="token comment"># 将镜像换为本地harbor地址</span>
resources:
  limits:
    memory: 512Mi		<span class="token comment"># 分配内存，生产中要给的大一些</span>
kubernetes ljk.local in-addr.arpa ip6.arpa <span class="token punctuation">&#123;</span>	<span class="token comment"># 设置域名 ljk.local</span>
  pods insecure
  fallthrough in-addr.arpa ip6.arpa
  ttl <span class="token number">30</span>
<span class="token punctuation">&#125;</span>
clusterIP: <span class="token number">192.168</span>.0.2		<span class="token comment"># 设置dns服务器，这个可以进入pod查看/etc/resolv.conf的nameserver</span>
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$kubectl</span> apply <span class="token parameter variable">-f</span> coredns.yaml
<span class="token punctuation">[</span>root@k8s-master1 coredns<span class="token punctuation">]</span><span class="token variable">$kubectl</span> get pod <span class="token parameter variable">-n</span> kube-system  <span class="token operator">|</span> <span class="token function">grep</span> coredns
coredns-7589f7f68b-jp5kz          <span class="token number">1</span>/1     Running   <span class="token number">0</span>       39m</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 server ip</span>
<span class="token variable">$kubectl</span> get <span class="token function">service</span> <span class="token parameter variable">-o</span> wide <span class="token parameter variable">-A</span>
NAMESPACE     NAME                        TYPE        CLUSTER-IP        EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                  AGE     SELECTOR
default       kubernetes                  ClusterIP   <span class="token number">192.168</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP                  29h     <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   dashboard-metrics-scraper   ClusterIP   <span class="token number">192.168</span>.233.194   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8000</span>/TCP                 6h27m   k8s-app<span class="token operator">=</span>dashboard-metrics-scraper
kube-system   kube-dns                    ClusterIP   <span class="token number">192.168</span>.0.2       <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">53</span>/UDP,53/TCP,9153/TCP   47m     k8s-app<span class="token operator">=</span>kube-dns
kube-system   kubernetes-dashboard        NodePort    <span class="token number">192.168</span>.249.138   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>:44420/TCP            6h27m   k8s-app<span class="token operator">=</span>kubernetes-dashboard</code></pre>

<p>通过 dashboard 进入 pod，测试一下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 服务名称.命名空间.svc.ljk.local</span>
/ <span class="token comment"># nslookup  kubernetes.default.svc.ljk.local</span>
Server:         <span class="token number">192.168</span>.0.2
Address:        <span class="token number">192.168</span>.0.2<span class="token comment">#53</span>

Name:   kubernetes.default.svc.ljk.local
Address: <span class="token number">192.168</span>.0.1						<span class="token comment"># 测试成功</span>

/ <span class="token comment"># nslookup  dashboard-metrics-scraper.kube-system.svc.ljk.local</span>
Server:         <span class="token number">192.168</span>.0.2
Address:        <span class="token number">192.168</span>.0.2<span class="token comment">#53</span>

Name:   dashboard-metrics-scraper.kube-system.svc.ljk.local
Address: <span class="token number">192.168</span>.233.194</code></pre>

<h4 id="kubeasz-安装"><a href="#kubeasz-安装" class="headerlink" title="kubeasz 安装"></a>kubeasz 安装</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ansible<span class="token punctuation">]</span><span class="token variable">$vim</span> roles/cluster-addon/defaults/main.yml
<span class="token comment"># 关闭其他组件的自动安装，只安装coredns</span>
metricsserver_install: <span class="token string">"no"</span>
dashboard_install: <span class="token string">"no"</span>
ingress_install: <span class="token string">"no"</span>

<span class="token punctuation">[</span>root@k8s-master ansible<span class="token punctuation">]</span><span class="token variable">$ansible</span>-playbook ./07.cluster-addon.yml
<span class="token punctuation">..</span>.

<span class="token comment"># 测试，随便进入一个pod</span>
/ <span class="token comment"># nslookup kubernetes.default.svc.ljk.local</span>
Server:         <span class="token number">192.168</span>.0.2
Address:        <span class="token number">192.168</span>.0.2:53

Name:   kubernetes.default.svc.ljk.local
Address: <span class="token number">192.168</span>.0.1</code></pre>

<h2 id="关于负载均衡"><a href="#关于负载均衡" class="headerlink" title="关于负载均衡"></a>关于负载均衡</h2><p>kubeasz 的逻辑是在每个 node 上安装一个 haproxy，如果 master 的数量超过 1 个，node 和 master 的通信就走 haproxy</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-node1 kubernetes<span class="token punctuation">]</span><span class="token variable">$cat</span> ~/.kube/config <span class="token operator">|</span> <span class="token function">grep</span> server
    server: https://127.0.0.1:6443
<span class="token punctuation">[</span>root@k8s-node1 kubernetes<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token operator">|</span> <span class="token function">grep</span> server
    server: https://127.0.0.1:6443
<span class="token punctuation">[</span>root@k8s-node1 kubernetes<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/kubernetes/kubelet.kubeconfig <span class="token operator">|</span> <span class="token function">grep</span> server
    server: https://127.0.0.1:6443</code></pre>

<p>可是这样无法避免 haproxy 的单点失败问题，而且外部访问 master 的时候还得走 vip，所以不如直接只搭建一套 keeplived + haproxy，然后不管 master 还是 node，所有和 apiserver 的通信都走 vip，kubeasz 提供了搭建 keeplived + haproxy 的 playbook，在 01.prepare.yml 中打开注释即可，当然也可以自己搭建</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h3><p>非常简单</p>
<h3 id="添加-master"><a href="#添加-master" class="headerlink" title="添加 master"></a>添加 master</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/op/op-master.md">https://github.com/easzlab/kubeasz/blob/master/docs/op/op-master.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">easzctl add-master <span class="token variable">$ip</span></code></pre>

<h3 id="添加-node"><a href="#添加-node" class="headerlink" title="添加 node"></a>添加 node</h3><p><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz/blob/master/docs/op/op-node.md">https://github.com/easzlab/kubeasz/blob/master/docs/op/op-node.md</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">easzctl add-node <span class="token variable">$ip</span></code></pre>

<h2 id="集群升级"><a href="#集群升级" class="headerlink" title="集群升级"></a>集群升级</h2><h3 id="小版本升级"><a href="#小版本升级" class="headerlink" title="小版本升级"></a>小版本升级</h3><p>下载最新版本的 kubernetes，全部解压后，在 kubernetes&#x2F;server&#x2F;bin 目录下，都是编译好的二进制程序</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubernetes-client-linux-amd64.tar.gz
kubernetes-node-linux-amd64.tar.gz
kubernetes-server-linux-amd64.tar.gz
kubernetes.tar.gz

<span class="token comment"># 将以上四个都解压，得到一个目录：kubernetes</span>
<span class="token variable">$pwd</span>
/usr/local/src/kubernetes/server/bin
<span class="token variable">$ll</span>
total <span class="token number">986844</span>
drwxr-xr-x <span class="token number">2</span> root root      <span class="token number">4096</span> Feb <span class="token number">19</span> 00:26 ./
drwxr-xr-x <span class="token number">3</span> root root      <span class="token number">4096</span> Feb <span class="token number">19</span> 00:30 <span class="token punctuation">..</span>/
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">46710784</span> Feb <span class="token number">19</span> 00:26 apiextensions-apiserver*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">39251968</span> Feb <span class="token number">19</span> 00:26 kubeadm*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">44699648</span> Feb <span class="token number">19</span> 00:26 kube-aggregator*
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">118218752</span> Feb <span class="token number">19</span> 00:26 kube-apiserver*
-rw-r--r-- <span class="token number">1</span> root root         <span class="token number">8</span> Feb <span class="token number">19</span> 00:24 kube-apiserver.docker_tag
-rw------- <span class="token number">1</span> root root <span class="token number">123035136</span> Feb <span class="token number">19</span> 00:24 kube-apiserver.tar
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">112758784</span> Feb <span class="token number">19</span> 00:26 kube-controller-manager*
-rw-r--r-- <span class="token number">1</span> root root         <span class="token number">8</span> Feb <span class="token number">19</span> 00:24 kube-controller-manager.docker_tag
-rw------- <span class="token number">1</span> root root <span class="token number">117575168</span> Feb <span class="token number">19</span> 00:24 kube-controller-manager.tar
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">40263680</span> Feb <span class="token number">19</span> 00:26 kubectl*
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">114113512</span> Feb <span class="token number">19</span> 00:26 kubelet*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">39518208</span> Feb <span class="token number">19</span> 00:26 kube-proxy*
-rw-r--r-- <span class="token number">1</span> root root         <span class="token number">8</span> Feb <span class="token number">19</span> 00:24 kube-proxy.docker_tag
-rw------- <span class="token number">1</span> root root <span class="token number">120411648</span> Feb <span class="token number">19</span> 00:24 kube-proxy.tar
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">43745280</span> Feb <span class="token number">19</span> 00:26 kube-scheduler*
-rw-r--r-- <span class="token number">1</span> root root         <span class="token number">8</span> Feb <span class="token number">19</span> 00:24 kube-scheduler.docker_tag
-rw------- <span class="token number">1</span> root root  <span class="token number">48561664</span> Feb <span class="token number">19</span> 00:24 kube-scheduler.tar
-rwxr-xr-x <span class="token number">1</span> root root   <span class="token number">1634304</span> Feb <span class="token number">19</span> 00:26 mounter*</code></pre>

<h4 id="master"><a href="#master" class="headerlink" title="master"></a>master</h4><ol>
<li><p>关闭服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$systemctl</span> stop <span class="token punctuation">\</span>
	kube-apiserver.service <span class="token punctuation">\</span>
	kubelet.service <span class="token punctuation">\</span>
	kube-scheduler.service <span class="token punctuation">\</span>
	kube-controller-manager.service <span class="token punctuation">\</span>
	kube-proxy.service</code></pre>
</li>
<li><p>拷贝新版本，覆盖旧版本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> kube-apiserver kubelet kube-scheduler kube-controller-manager kube-proxy kubectl <span class="token number">10.0</span>.1.31:/usr/local/bin</code></pre>
</li>
<li><p>启动服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$systemctl</span> start <span class="token punctuation">\</span>
	kube-apiserver.service <span class="token punctuation">\</span>
	kubelet.service <span class="token punctuation">\</span>
	kube-scheduler.service <span class="token punctuation">\</span>
	kube-controller-manager.service <span class="token punctuation">\</span>
	kube-proxy.service</code></pre></li>
</ol>
<p>注：因为 master 做了 haproxy+keepalived，所以只要不是全部 master 同时关闭服务就没问题，其实都全部 master 都关闭服务，短时间也没事</p>
<h4 id="node"><a href="#node" class="headerlink" title="node"></a>node</h4><ol>
<li><p>关闭服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$systemctl</span> stop kubelet.service kube-proxy.service</code></pre>
</li>
<li><p>拷贝新版本，覆盖旧版本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> kubelet kube-proxy kubectl <span class="token number">10.0</span>.1.33:/usr/local/bin</code></pre>
</li>
<li><p>启动服务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$systemctl</span> start kubelet.service kube-proxy.service</code></pre></li>
</ol>
<p>注：关闭 kubelet 和 kube-proxy 不影响访问已经创建的 Pod</p>
<p>如果 node 数量比较多，写个脚本循环升级即可</p>
<h3 id="大版本升级"><a href="#大版本升级" class="headerlink" title="大版本升级"></a>大版本升级</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/kubectl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/kubectl/" class="post-title-link" itemprop="url">kubectl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-16 09:55:26" itemprop="dateCreated datePublished" datetime="2021-01-16T09:55:26+08:00">2021-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>kubectl 是 kube-apiserver 的命令行客户端，就像 redis-cli 是 redis 的命令行客户端</p>
<h2 id="安装-kubectl"><a href="#安装-kubectl" class="headerlink" title="安装 kubectl"></a>安装 kubectl</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/tools/install-kubectl/">https://kubernetes.io/zh/docs/tasks/tools/install-kubectl/</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b11Qo8aZk">https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b11Qo8aZk</a></p>
<h2 id="kubectl-详解"><a href="#kubectl-详解" class="headerlink" title="kubectl 详解"></a>kubectl 详解</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/overview/">https://kubernetes.io/zh/docs/reference/kubectl/overview/</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/overview/">https://kubernetes.io/docs/reference/kubectl/overview/</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></code></pre>

<p><strong>command</strong>：指定要对一个或多个资源执行的操作，例如 <code>create</code>、<code>get</code>、<code>describe</code>、<code>delete</code><br><strong>TYPE</strong>：指定资源类型。不区分大小写， 可以指定单数、复数或缩写形式。例如，以下命令输出相同的结果：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl get pod pod1
kubectl get pods pod1
kubectl get po pod1</code></pre>

<p><strong>NAME</strong>：指定资源的名称。名称区分大小写。 如果省略名称，则显示所有资源的详细信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 类型相同的资源 TYPE1 name1 name2 name3...</span>
kubectl get pod example-pod1 example-pod2
<span class="token comment"># 多个资源类型 TYPE1/name1 TYPE1/name2 TYPE2/name3 ...</span>
kubectl get pod/example-pod1 replicationcontroller/example-rc1
<span class="token comment"># 用一个或多个文件指定资源 -f file1 -f file2 -f file3...</span>
kubectl get <span class="token parameter variable">-f</span> ./pod.yaml</code></pre>

<p><strong>flags</strong>：指定可选的参数。例如，可以使用 -s 或 -server 指定 Kubernetes API 服务器的地址和端口</p>
<blockquote>
<p>从命令行指定的参数优先级最高</p>
</blockquote>
<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash">create        <span class="token comment"># 创建资源</span>
expose        <span class="token comment"># 将资源暴露为新的 Service</span>
run           <span class="token comment"># 在集群上运行一个特定的镜像</span>
<span class="token builtin class-name">set</span>           <span class="token comment"># 使用命令行修改资源</span>
edit          <span class="token comment"># 使用编辑器修改资源，交互式</span>
explain       <span class="token comment"># 资源的详细信息</span>
get           <span class="token comment"># 显示一个或多个资源</span>
delete        <span class="token comment"># 删除资源</span></code></pre>

<h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl get <span class="token punctuation">[</span><span class="token punctuation">(</span>-o<span class="token operator">|</span>--output<span class="token operator">=</span><span class="token punctuation">)</span>json<span class="token operator">|</span>yaml<span class="token operator">|</span>wide<span class="token operator">|</span>custom-columns<span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token operator">|</span>custom-columns-file<span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token operator">|</span>go-template<span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token operator">|</span>go-template-file<span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token operator">|</span><span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token operator">|</span>jsonpath-file<span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">(</span>TYPE<span class="token punctuation">[</span>.VERSION <span class="token punctuation">[</span>.GROUP<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME <span class="token operator">|</span> <span class="token parameter variable">-l</span> label<span class="token punctuation">]</span> <span class="token operator">|</span> TYPE<span class="token punctuation">[</span>.VERSION<span class="token punctuation">]</span><span class="token punctuation">[</span>.GROUP<span class="token punctuation">]</span>/NAME <span class="token punctuation">..</span>.<span class="token punctuation">)</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例</span>
kubectl get pods
kubectl get pods <span class="token parameter variable">-A</span> 相当于 kubectl  get pods --all-namespaces
kubectl get pods <span class="token parameter variable">-o</span> wide
kubectl get replicationcontroller web
kubectl get deployments.v1.apps <span class="token parameter variable">-o</span> json
kubectl get <span class="token parameter variable">-o</span> json pod web-pod-13je7
kubectl get <span class="token parameter variable">-f</span> pod.yaml <span class="token parameter variable">-o</span> json
kubectl get <span class="token parameter variable">-k</span> dir/
kubectl get <span class="token parameter variable">-o</span> template pod/web-pod-13je7 <span class="token parameter variable">--template</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>.status.phase<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
kubectl get rc,services
kubectl get rc/web service/frontend pods/web-pod-13je7</code></pre>

<h4 id="create"><a href="#create" class="headerlink" title="create"></a>create</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl create <span class="token parameter variable">-f</span> FILENAME <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl create <span class="token parameter variable">-f</span> ./pod.json
<span class="token function">cat</span> pod.json <span class="token operator">|</span> kubectl create <span class="token parameter variable">-f</span> -
kubectl create <span class="token parameter variable">-f</span> docker-registry.yaml <span class="token parameter variable">--edit</span> <span class="token parameter variable">-o</span> json</code></pre>

<h4 id="expose"><a href="#expose" class="headerlink" title="expose"></a>expose</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl expose <span class="token punctuation">(</span>-f FILENAME <span class="token operator">|</span> TYPE NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>--port<span class="token operator">=</span>port<span class="token punctuation">]</span> <span class="token punctuation">[</span>--protocol<span class="token operator">=</span>TCP<span class="token operator">|</span>UDP<span class="token operator">|</span>SCTP<span class="token punctuation">]</span> <span class="token punctuation">[</span>--target-port<span class="token operator">=</span>number-or-name<span class="token punctuation">]</span> <span class="token punctuation">[</span>--name<span class="token operator">=</span>name<span class="token punctuation">]</span> <span class="token punctuation">[</span>--external-ip<span class="token operator">=</span>external-ip-of-service<span class="token punctuation">]</span> <span class="token punctuation">[</span>--type<span class="token operator">=</span>type<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl expose rc nginx <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8000</span>
kubectl expose <span class="token parameter variable">-f</span> nginx-controller.yaml <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8000</span>
kubectl expose pod valid-pod <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">444</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>frontend
kubectl expose <span class="token function">service</span> nginx <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">443</span> --target-port<span class="token operator">=</span><span class="token number">8443</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>nginx-https
kubectl expose rc streamer <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">4100</span> <span class="token parameter variable">--protocol</span><span class="token operator">=</span>UDP <span class="token parameter variable">--name</span><span class="token operator">=</span>video-stream
kubectl expose rs nginx <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8000</span>
kubectl expose deployment nginx <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8000</span></code></pre>

<h4 id="set-★★★"><a href="#set-★★★" class="headerlink" title="set ★★★"></a>set ★★★</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">set</span> SUBCOMMAND <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

SUBCOMMAND:
  <span class="token function">env</span>		<span class="token comment"># 更新环境变量，对应deployment的`spec.template.spec.containers.env`</span>
  image     <span class="token comment"># 更新镜像</span>
  resources      Update resource requests/limits on objects with pod templates
  selector       Set the selector on a resource
  serviceaccount Update ServiceAccount of a resource</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">set</span> image <span class="token punctuation">(</span>-f FILENAME <span class="token operator">|</span> TYPE NAME<span class="token punctuation">)</span> <span class="token assign-left variable">CONTAINER_NAME_1</span><span class="token operator">=</span>CONTAINER_IMAGE_1 <span class="token punctuation">..</span>. <span class="token assign-left variable">CONTAINER_NAME_N</span><span class="token operator">=</span>CONTAINER_IMAGE_N <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例</span>
kubectl <span class="token builtin class-name">set</span> image deployment/nginx <span class="token assign-left variable">busybox</span><span class="token operator">=</span>busybox <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.9.1
kubectl <span class="token builtin class-name">set</span> image deployments,rc <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.9.1 <span class="token parameter variable">--all</span>
kubectl <span class="token builtin class-name">set</span> image daemonset abc *<span class="token operator">=</span>nginx:1.9.1
kubectl <span class="token builtin class-name">set</span> image <span class="token parameter variable">-f</span> path/to/file.yaml <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.9.1 <span class="token parameter variable">--local</span> <span class="token parameter variable">-o</span> yaml</code></pre>

<h4 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl edit <span class="token punctuation">(</span>RESOURCE/NAME <span class="token operator">|</span> <span class="token parameter variable">-f</span> FILENAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl edit svc/docker-registry
<span class="token assign-left variable">KUBE_EDITOR</span><span class="token operator">=</span><span class="token string">"nano"</span> kubectl edit svc/docker-registry
kubectl edit job.v1.batch/myjob <span class="token parameter variable">-o</span> json
kubectl edit deployment/mydeployment <span class="token parameter variable">-o</span> yaml --save-config</code></pre>

<h4 id="run"><a href="#run" class="headerlink" title="run"></a>run</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl run NAME <span class="token parameter variable">--image</span><span class="token operator">=</span><span class="token operator">&lt;</span>image<span class="token operator">></span> <span class="token punctuation">[</span>--env<span class="token operator">=</span><span class="token string">"key=value"</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>--port<span class="token operator">=</span>port<span class="token punctuation">]</span> <span class="token punctuation">[</span>--dry-run<span class="token operator">=</span>server<span class="token operator">|</span>client<span class="token punctuation">]</span> <span class="token punctuation">[</span>--overrides<span class="token operator">=</span>inline-json<span class="token punctuation">]</span> <span class="token punctuation">[</span>--command<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl run nginx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx		<span class="token comment"># 使用默认命令启动</span>
kubectl run nginx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx -- <span class="token operator">&lt;</span>arg<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token operator">&lt;</span>arg<span class="token operator"><span class="token file-descriptor important">2</span>></span> <span class="token punctuation">..</span>. <span class="token operator">&lt;</span>argN<span class="token operator">></span> <span class="token comment">#默认命令，自定义参数</span>
kubectl run nginx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx <span class="token parameter variable">--command</span> -- <span class="token operator">&lt;</span>cmd<span class="token operator">></span> <span class="token operator">&lt;</span>arg<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token punctuation">..</span>. <span class="token operator">&lt;</span>argN<span class="token operator">></span> <span class="token comment">#非默认命令</span>
kubectl run test1 <span class="token parameter variable">--image</span><span class="token operator">=</span>harbor.ljk.local/baseimages/alpine:3.12.4 -- <span class="token function">sleep</span> <span class="token number">3600</span></code></pre>

<h4 id="explain"><a href="#explain" class="headerlink" title="explain"></a>explain</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl explain RESOURCE <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
kubectl explain <span class="token operator">&lt;</span>type<span class="token operator">></span>.<span class="token operator">&lt;</span>fieldName<span class="token operator">></span><span class="token punctuation">[</span>.<span class="token operator">&lt;</span>fieldName<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span></code></pre>

<p>使用 <code>kubectl explain</code> 查看配置清单怎么写，例如：使用 <code>kubectl explain deployment</code> 查看创建 deployment 资源的配置清单怎么写，使用 <code>kubectl explain namespace</code> 查看创建 namespace 资源的配置清单怎么写，等等</p>
<h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl delete <span class="token punctuation">(</span><span class="token punctuation">[</span>-f FILENAME<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span>-k DIRECTORY<span class="token punctuation">]</span> <span class="token operator">|</span> TYPE <span class="token punctuation">[</span><span class="token punctuation">(</span>NAME <span class="token operator">|</span> <span class="token parameter variable">-l</span> label <span class="token operator">|</span> --all<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl delete <span class="token parameter variable">-f</span> ./pod.json
kubectl delete <span class="token parameter variable">-k</span> <span class="token function">dir</span>
<span class="token function">cat</span> pod.json <span class="token operator">|</span> kubectl delete <span class="token parameter variable">-f</span> -
kubectl delete pod,service baz foo
kubectl delete pods,services <span class="token parameter variable">-l</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel
kubectl delete pod foo <span class="token parameter variable">--now</span>
kubectl delete pod foo <span class="token parameter variable">--force</span>
kubectl delete pods <span class="token parameter variable">--all</span></code></pre>

<h3 id="部署命令"><a href="#部署命令" class="headerlink" title="部署命令"></a>部署命令</h3><p>参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment">回滚 Deployment</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">rollout       管理资源的升级和回滚
scale         弹性伸缩Pod数量
autoscale     自动设置运行的pod数量（水平自动伸缩）</code></pre>

<h4 id="rollout-★★★"><a href="#rollout-★★★" class="headerlink" title="rollout ★★★"></a>rollout ★★★</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl rollout SUBCOMMAND <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

SUBCOMMAND:
  <span class="token function">history</span>     查看指定资源的操作记录
  pause       暂停升级
  restart     Restart a resource
  resume      继续升级
  status      Show the status of the rollout
  undo        升级回滚</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl rollout <span class="token function">history</span> <span class="token punctuation">(</span>TYPE NAME <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl rollout <span class="token function">history</span> deployment/abc
deployments <span class="token string">"nginx-deployment"</span>
EVISION    CHANGE-CAUSE
<span class="token number">1</span>           kubectl apply <span class="token parameter variable">--filename</span><span class="token operator">=</span>nginx-deployment.yaml <span class="token parameter variable">--record</span><span class="token operator">=</span>true
<span class="token number">2</span>           kubectl <span class="token builtin class-name">set</span> image deployment/abc <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.9.1 <span class="token parameter variable">--record</span><span class="token operator">=</span>true
<span class="token number">3</span>           kubectl <span class="token builtin class-name">set</span> image deployment/abc <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.91 <span class="token parameter variable">--record</span><span class="token operator">=</span>true

kubectl rollout <span class="token function">history</span> daemonset/abc <span class="token parameter variable">--revision</span><span class="token operator">=</span><span class="token number">3</span>		<span class="token comment"># 指定版本</span>

kubectl rollout <span class="token function">history</span> deployment.v1.apps/nginx-deployment
kubectl rollout <span class="token function">history</span> deployment.v1.apps/nginx-deployment <span class="token parameter variable">--revision</span><span class="token operator">=</span><span class="token number">2</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl rollout undo <span class="token punctuation">(</span>TYPE NAME <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl rollout undo deployment/abc		<span class="token comment"># 回滚到上个版本</span>
kubectl rollout undo daemonset/abc --to-revision<span class="token operator">=</span><span class="token number">3</span>	<span class="token comment"># 回滚到指定版本</span>
kubectl rollout undo --dry-run<span class="token operator">=</span>server deployment/abc</code></pre>

<h4 id="scale"><a href="#scale" class="headerlink" title="scale"></a>scale</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl scale <span class="token punctuation">[</span>--resource-version<span class="token operator">=</span>version<span class="token punctuation">]</span> <span class="token punctuation">[</span>--current-replicas<span class="token operator">=</span>count<span class="token punctuation">]</span> <span class="token parameter variable">--replicas</span><span class="token operator">=</span>COUNT <span class="token punctuation">(</span>-f FILENAME <span class="token operator">|</span> <span class="token operator">&lt;</span>TYPE<span class="token operator">></span> <span class="token operator">&lt;</span>NAME<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span> rs/foo
kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span> <span class="token parameter variable">-f</span> foo.yaml
kubectl scale --current-replicas<span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span> deployment/mysql
kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">5</span> rc/foo rc/bar rc/baz
kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span> statefulset/web</code></pre>

<h4 id="autoscale"><a href="#autoscale" class="headerlink" title="autoscale"></a>autoscale</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl autoscale <span class="token punctuation">(</span>-f FILENAME <span class="token operator">|</span> TYPE NAME <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>--min<span class="token operator">=</span>MINPODS<span class="token punctuation">]</span> <span class="token parameter variable">--max</span><span class="token operator">=</span>MAXPODS <span class="token punctuation">[</span>--cpu-percent<span class="token operator">=</span>CPU<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl autoscale deployment foo <span class="token parameter variable">--min</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">--max</span><span class="token operator">=</span><span class="token number">10</span>
kubectl autoscale rc foo <span class="token parameter variable">--max</span><span class="token operator">=</span><span class="token number">5</span> --cpu-percent<span class="token operator">=</span><span class="token number">80</span></code></pre>

<h3 id="集群管理命令"><a href="#集群管理命令" class="headerlink" title="集群管理命令"></a>集群管理命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash">certificate   Modify certificate resources.
cluster-info  集群信息
<span class="token function">top</span>           集群资源 <span class="token punctuation">(</span>CPU/Memory/Storage<span class="token punctuation">)</span> 使用情况
cordon        警戒线，标记node不被调度，即不参加pod调度
uncordon      取消警戒标记为cordon的node，即参加pod调度
drain         驱逐node上的pod，用于node下线等场景
taint         给node标记污点</code></pre>

<h4 id="cordon"><a href="#cordon" class="headerlink" title="cordon"></a>cordon</h4><h4 id="uncordon"><a href="#uncordon" class="headerlink" title="uncordon"></a>uncordon</h4><h3 id="故障处理和调试命令"><a href="#故障处理和调试命令" class="headerlink" title="故障处理和调试命令"></a>故障处理和调试命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash">describe      显示资源或资源组的详细信息
logs          打印pod中容器的日志（标准输出的日志）
attach        Attach to a running container
<span class="token builtin class-name">exec</span>          和docker的exec实现一样的功能，只是更加智能，不用考虑容器在哪个节点上
port-forward  Forward one or <span class="token function">more</span> <span class="token builtin class-name">local</span> ports to a pod
proxy         Run a proxy to the Kubernetes API server
<span class="token function">cp</span>            Copy files and directories to and from containers.
auth          Inspect authorization
debug         Create debugging sessions <span class="token keyword">for</span> troubleshooting workloads and nodes</code></pre>

<h4 id="describe-★★★"><a href="#describe-★★★" class="headerlink" title="describe ★★★"></a>describe ★★★</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl describe <span class="token punctuation">(</span>-f FILENAME <span class="token operator">|</span> TYPE <span class="token punctuation">[</span>NAME_PREFIX <span class="token operator">|</span> <span class="token parameter variable">-l</span> label<span class="token punctuation">]</span> <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl describe nodes kubernetes-node-emt8.c.myproject.internal
kubectl describe pods/nginx
kubectl describe <span class="token parameter variable">-f</span> pod.json
kubectl describe pods
kubectl describe po <span class="token parameter variable">-l</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel
kubectl describe pods frontend</code></pre>

<p>经常用此命令查看 pod 的日志</p>
<p>pod 没有启动的原因排错：</p>
<ol>
<li>kubectl get</li>
<li>kubectl describe</li>
<li>kubectl logs</li>
<li>到 pod 所在的宿主机去看宿主机的系统日志</li>
</ol>
<h4 id="logs"><a href="#logs" class="headerlink" title="logs"></a>logs</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl logs <span class="token punctuation">[</span>-f<span class="token punctuation">]</span> <span class="token punctuation">[</span>-p<span class="token punctuation">]</span> <span class="token punctuation">(</span>POD <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>-c CONTAINER<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl logs nginx
kubectl logs nginx --all-containers<span class="token operator">=</span>true
kubectl logs <span class="token parameter variable">-lapp</span><span class="token operator">=</span>nginx --all-containers<span class="token operator">=</span>true
kubectl logs <span class="token parameter variable">-p</span> <span class="token parameter variable">-c</span> ruby web-1
kubectl logs <span class="token parameter variable">-f</span> <span class="token parameter variable">-c</span> ruby web-1
kubectl logs <span class="token parameter variable">-f</span> <span class="token parameter variable">-lapp</span><span class="token operator">=</span>nginx --all-containers<span class="token operator">=</span>true
kubectl logs <span class="token parameter variable">--tail</span><span class="token operator">=</span><span class="token number">20</span> nginx
kubectl logs <span class="token parameter variable">--since</span><span class="token operator">=</span>1h nginx
kubectl logs --insecure-skip-tls-verify-backend nginx
kubectl logs job/hello
kubectl logs deployment/nginx <span class="token parameter variable">-c</span> nginx-1</code></pre>

<h4 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">(</span>POD <span class="token operator">|</span> TYPE/NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>-c CONTAINER<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> -- COMMAND <span class="token punctuation">[</span>args<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl <span class="token builtin class-name">exec</span> mypod -- <span class="token function">date</span>
kubectl <span class="token builtin class-name">exec</span> mypod <span class="token parameter variable">-c</span> ruby-container -- <span class="token function">date</span>
kubectl <span class="token builtin class-name">exec</span> mypod <span class="token parameter variable">-c</span> ruby-container <span class="token parameter variable">-i</span> <span class="token parameter variable">-t</span> -- <span class="token function">bash</span> <span class="token parameter variable">-il</span>
kubectl <span class="token builtin class-name">exec</span> mypod <span class="token parameter variable">-i</span> <span class="token parameter variable">-t</span> -- <span class="token function">ls</span> <span class="token parameter variable">-t</span> /usr
kubectl <span class="token builtin class-name">exec</span> deploy/mydeployment -- <span class="token function">date</span>
kubectl <span class="token builtin class-name">exec</span> svc/myservice -- <span class="token function">date</span></code></pre>

<p>注意：进入容器只是查看信息，不要修改配置，如果需要修改配置，只能重新打镜像</p>
<h3 id="高级命令"><a href="#高级命令" class="headerlink" title="高级命令"></a>高级命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">diff</span>          Diff live version against would-be applied version
apply         Apply a configuration to a resource by filename or stdin
patch         Update field<span class="token punctuation">(</span>s<span class="token punctuation">)</span> of a resource
replace       Replace a resource by filename or stdin
<span class="token function">wait</span>          Experimental: Wait <span class="token keyword">for</span> a specific condition on one or many resources.
kustomize     Build a kustomization target from a directory or a remote url.</code></pre>

<h4 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h4><h4 id="apply-★★★"><a href="#apply-★★★" class="headerlink" title="apply ★★★"></a>apply ★★★</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl apply <span class="token punctuation">(</span>-f FILENAME <span class="token operator">|</span> <span class="token parameter variable">-k</span> DIRECTORY<span class="token punctuation">)</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl apply <span class="token parameter variable">-f</span> ./pod.json
kubectl apply <span class="token parameter variable">-k</span> dir/
<span class="token function">cat</span> pod.json <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -
kubectl apply <span class="token parameter variable">--prune</span> <span class="token parameter variable">-f</span> manifest.yaml <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
kubectl apply <span class="token parameter variable">--prune</span> <span class="token parameter variable">-f</span> manifest.yaml <span class="token parameter variable">--all</span> --prune-whitelist<span class="token operator">=</span>core/v1/ConfigMap</code></pre>

<h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><p>修改、更新资源字段，支持 JSON 和 YAML 格式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl patch <span class="token punctuation">(</span>-f FILENAME <span class="token operator">|</span> TYPE NAME<span class="token punctuation">)</span> <span class="token punctuation">[</span>-p PATCH<span class="token operator">|</span>--patch-file FILE<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

-p：更新json资源文件

<span class="token comment"># 示例：</span>
kubectl patch <span class="token function">node</span> k8s-node-1 <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"unschedulable":true&#125;&#125;'</span>
kubectl patch <span class="token function">node</span> k8s-node-1 <span class="token parameter variable">-p</span> <span class="token string">$'spec:<span class="token entity" title="\n">\n</span> unschedulable: true'</span>
kubectl patch <span class="token parameter variable">-f</span> node.json <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"unschedulable":true&#125;&#125;'</span>
kubectl patch pod valid-pod <span class="token parameter variable">-p</span> <span class="token string">'&#123;"spec":&#123;"containers":[&#123;"name":"kubernetes-serve-hostname","image":"new image"&#125;]&#125;&#125;'</span>
kubectl patch pod valid-pod <span class="token parameter variable">--type</span><span class="token operator">=</span><span class="token string">'json'</span> <span class="token parameter variable">-p</span><span class="token operator">=</span><span class="token string">'[&#123;"op": "replace", "path": "/spec/containers/0/image", "value":"newimage"&#125;]'</span></code></pre>

<h4 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h4><p>使用配置文件或 stdin 来替换当前资源</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl replace <span class="token parameter variable">-f</span> FILENAME <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

<span class="token comment"># 示例：</span>
kubectl replace <span class="token parameter variable">-f</span> ./pod.json
<span class="token function">cat</span> pod.json <span class="token operator">|</span> kubectl replace <span class="token parameter variable">-f</span> -
kubectl get pod mypod <span class="token parameter variable">-o</span> yaml <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/\(image: myimage\):.*$/\1:v4/'</span> <span class="token operator">|</span> kubectl replace <span class="token parameter variable">-f</span> -
kubectl replace <span class="token parameter variable">--force</span> <span class="token parameter variable">-f</span> ./pod.json</code></pre>

<p><strong><code>create</code> 、<code>apply</code>、<code>replace</code> 的区别：</strong></p>
<ul>
<li><code>create</code>：指定一个动作，新建资源</li>
<li><code>replace</code>：指定一个动作，替换资源</li>
<li><code>apply</code>：指定目标状态，不关心实现的过程</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新建资源</span>
kubectl create <span class="token parameter variable">-f</span> nginx.yaml
<span class="token comment"># 修改nginx.yaml，然后用修改后替换当前的</span>
kubectl replace <span class="token parameter variable">-f</span> nginx.yaml</code></pre>

<p>相当于：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新建资源，相当于 `kubectl create`</span>
kubectl apply <span class="token parameter variable">-f</span> nginx.yaml
<span class="token comment"># 修改nginx.yaml，然后更新资源，相当于 `kubectl path`</span>
kubectl apply <span class="token parameter variable">-f</span> nginx.yaml</code></pre>

<h4 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h4><h4 id="kustomize"><a href="#kustomize" class="headerlink" title="kustomize"></a>kustomize</h4><h3 id="设置命令"><a href="#设置命令" class="headerlink" title="设置命令"></a>设置命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash">label         Update the labels on a resource
annotate      Update the annotations on a resource
completion    Output shell completion code <span class="token keyword">for</span> the specified shell <span class="token punctuation">(</span>bash or <span class="token function">zsh</span><span class="token punctuation">)</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token variable">$kubectl</span> completion <span class="token function">bash</span> <span class="token operator">></span> /etc/profile.d/kubectl_completion.sh</code></pre>

<h3 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash">api-resources 打印服务器上支持的API资源
api-versions  以 <span class="token string">"group/version"</span> 的形式打印API versions
config        Modify kubeconfig files
plugin        Provides utilities <span class="token keyword">for</span> interacting with plugins.
version       Print the client and server version information
alpha
convert
options</code></pre>

<h3 id="输出选项"><a href="#输出选项" class="headerlink" title="输出选项"></a>输出选项</h3><h4 id="Formatting-output"><a href="#Formatting-output" class="headerlink" title="Formatting output"></a>Formatting output</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> <span class="token parameter variable">-o</span> <span class="token operator">&lt;</span>output_format<span class="token operator">></span>

<span class="token parameter variable">-o</span> wide：适合查看
<span class="token parameter variable">-o</span> json：适合监控</code></pre>

<h4 id="Sorting-list-objects"><a href="#Sorting-list-objects" class="headerlink" title="Sorting list objects"></a>Sorting list objects</h4><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> --sort-by<span class="token operator">=</span><span class="token operator">&lt;</span>jsonpath_exp<span class="token operator">></span></code></pre>

<h3 id="示例：常用操作"><a href="#示例：常用操作" class="headerlink" title="示例：常用操作"></a>示例：常用操作</h3><h3 id="示例：创建和使用插件"><a href="#示例：创建和使用插件" class="headerlink" title="示例：创建和使用插件"></a>示例：创建和使用插件</h3><h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><pre class="language-bash" data-language="bash"><code class="language-bash">kubectl api-resources</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/Kubeadm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/Kubeadm/" class="post-title-link" itemprop="url">kubeadm</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-15 20:49:14" itemprop="dateCreated datePublished" datetime="2021-01-15T20:49:14+08:00">2021-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>kubeadm 提供了<code>kubeadm init</code> 和 <code>kubeadm join</code> ，可以快速创建 k8s 集群</p>
<p>kubeadm 通过执行必要的操作来启动和运行最小可用集群。按照设计，它只关注启动引导，而非配置机器</p>
<p>我们希望在 kubeadm 之上构建更高级别以及更加合规的工具，理想情况下，使用 kubeadm 作为所有部署工作的基准将会更加易于创建一致性集群</p>
<p>安装各种 “锦上添花” 的扩展，例如 Kubernetes Dashboard、监控方案、以及特定云平台的扩展，都不在讨论范围内</p>
<h2 id="安装-kubeadm"><a href="#安装-kubeadm" class="headerlink" title="安装 kubeadm"></a>安装 kubeadm</h2><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b11Qo8aZk">https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b11Qo8aZk</a></p>
<h2 id="kubeadm"><a href="#kubeadm" class="headerlink" title="kubeadm"></a>kubeadm</h2><pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></code></pre>

<p>command：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">alpha           <span class="token comment"># kubeadm 处于测试阶段的命令，尽量不要用，`kubeadm alpha --help`查看有哪些命令</span>
certs           <span class="token comment"># 处理kubernetes证书</span>
completion      <span class="token comment"># bash 命令补全，需要安装 bash-completion</span>
config          <span class="token comment"># 管理 kubeadm 集群的配置，该配置保留在集群的 ConfigMap 中</span>
<span class="token builtin class-name">help</span>            <span class="token comment"># Help about any command</span>
init            <span class="token comment"># 设置一个Kubernetes控制平面</span>
<span class="token function">join</span>            <span class="token comment"># 将节点加入到k8s集群</span>
reset           <span class="token comment"># 还原使用`kubeadm init`或者`kubeadm join`对系统产生的环境变化</span>
token           <span class="token comment"># 管理 token</span>
upgrade         <span class="token comment"># 升级 k8s 版本</span>
version         <span class="token comment"># 查看版本信息</span></code></pre>

<p>flags：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">--add-dir-header	<span class="token comment"># 如果为true，则将文件目录添加到日志消息的头部</span>
-h, <span class="token parameter variable">--help</span>
--log-file string	<span class="token comment"># 如果非空，则使用此日志文件</span>
--log-file-max-size uint	<span class="token comment"># 定义日志文件可以增长到的最大大小。单位是字节。当该值为0时，表示不限制文件的最大大小。1800(默认)</span>
--one-output		<span class="token comment"># 如果为真，则只将日志写入其本机的严重级别(vs也写入每个较低的严重级别)</span>
<span class="token parameter variable">--rootfs</span> string		<span class="token comment"># 到“真实的”主机根文件系统的路径。</span>
--skip-headers		<span class="token comment"># 如果为true，则避免在日志消息中使用头前缀</span>
--skip-log-headers	<span class="token comment"># 如果为true，在打开日志文件时避免头文件</span>
-v, <span class="token parameter variable">--v</span> Level		<span class="token comment"># 日志级别详细程度的编号</span></code></pre>

<h3 id="kubeadm-completion"><a href="#kubeadm-completion" class="headerlink" title="kubeadm completion"></a><code>kubeadm completion</code></h3><p>让 kubeadm 命令支持自动补全，只支持 bash 和 zsh 两种环境。<br>将 <code>kubeadm completion bash</code> 打印的脚本加载到环境变量即可：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> bash-completion <span class="token parameter variable">-y</span>
<span class="token function">touch</span> /etc/profile.d/kubeadm_completion.sh
kubeadm completion <span class="token function">bash</span> <span class="token operator">></span> /etc/profile.d/kubeadm_completion.sh
<span class="token builtin class-name">exit</span>	<span class="token comment"># 重新登录终端</span>

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> 	<span class="token comment"># tab键就会出现命令提示</span>
alpha  certs  completion  config  <span class="token builtin class-name">help</span>  init  <span class="token function">join</span>  reset  token  upgrade  version</code></pre>

<h3 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a><code>kubeadm init</code></h3><p>此命令初始化一个 Kubernetes 控制平面节点</p>
<p>参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init">https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init</a></p>
<p><code>kubeadm init</code> 执行流程：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610450164021.png"></p>
<ol>
<li>检查系统状态，有的检查只报错，有的检查会退出流程</li>
<li>生成自签名 CA（可用使用用户提供的现有 CA）为集群中的每个组件设置身份，默认存放在 &#x2F;etc&#x2F;kubernetes&#x2F;kpi</li>
<li>在 &#x2F;etc&#x2F;kubernetes&#x2F; 中为 kubelet、controller-manger 和 scheduler 编写配置文件，让它们可以连接 API Server，每个文件都需要有自己的标识。同时还需要为管理用途编写文件 admin.conf</li>
<li>alpha 相关，略…</li>
<li>为 API Server、controller-manager 和 scheduler 生成静态的 manifest 文件。如果没有提供外部 etcd，也会为 etcd 生成一个额外的 Pod manifest 文件。<br>静态 Pod 的 manifest 文件将会写入 &#x2F;etc&#x2F;kubernetes&#x2F;manifest，kubelet 监控这个目录，在启动时判断是否生成 Pod。<br>一旦控制平面 Pod 启动并运行，<code>kubeadm init</code> 将会继续运行</li>
<li>alpha 相关，略…</li>
<li>将标签和 taint 应用到 master 节点，这样就不会有额外的工作负载运行在该节点上</li>
<li>生成 token 以让额外的 node 能够将它们自己注册到这个 master，默认有效期 24 小时</li>
<li>创建所有必需的配置让 node 能够通过 Bootstrap Token 和 TLS Bootstrap 机制来加入集群<ol>
<li>编写一个 ConfigMap 来提供加入集群所需的所有信息，并设置相关的 RBAC 访问规则</li>
<li>让 Bootstrap Token 能够访问 CSR 鉴权 API</li>
<li>为所有新的 CSR 请求配置 auto-approval</li>
</ol>
</li>
<li>安装内部的 DNS 服务（默认 CoreDNS），通过 Api Server 安装 kube-proxy 插件组件<br>请注意：就算部署了 DNS 服务，在安装 CNI 之前它也不会被调度到 node 上</li>
<li>alpha 相关，略…</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm init <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
kubeadm init <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></code></pre>

<p>command：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">phase	<span class="token comment"># 使用此命令调用init工作流的单个阶段</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm init phase <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
<span class="token comment"># command：</span>
addon              <span class="token comment"># Install required addons for passing Conformance tests</span>
bootstrap-token    <span class="token comment"># Generates bootstrap tokens used to join a node to a cluster</span>
certs              <span class="token comment"># Certificate generation</span>
control-plane      <span class="token comment"># 生成建立控制平面所需的所有静态pod清单文件</span>
etcd               <span class="token comment"># Generate static Pod manifest file for local etcd</span>
kubeconfig         <span class="token comment"># 生成建立控制平面所需的所有kubeconfig文件和管理kubeconfig文件</span>
kubelet-finalize   <span class="token comment"># Updates settings relevant to the kubelet after TLS bootstrap</span>
kubelet-start      <span class="token comment">#　Write kubelet settings and (re)start the kubelet</span>
mark-control-plane <span class="token comment"># Mark a node as a control-plane</span>
preflight          <span class="token comment"># Run pre-flight checks</span>
upload-certs       <span class="token comment"># Upload certificates to kubeadm-certs</span>
upload-config      <span class="token comment"># Upload the kubeadm and kubelet configuration to a ConfigMap</span>

<span class="token comment"># 每个命令都可以使用--help查询帮助，例如：`kubeadm init phase addon --help`</span></code></pre>

<p>flags：标星的是需要指定的，其他没有标星的一般情况下使用默认值即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">★ --apiserver-advertise-address string	<span class="token comment"># K8S API Server 将要监听的监听的 IP 地址，设置为master的IP，默认自动探测</span>
★ --apiserver-bind-port int32	<span class="token comment"># API Server 绑定的端口,默认为 6443</span>
--apiserver-cert-extra-sans strings	<span class="token comment"># 可选的证书额外信息，用于指定 API Server 的服务器证书。可以是 IP 地址也可以是 DNS 名称</span>
--cert-dir string	<span class="token comment"># 证书的存储路径，缺省路径为 /etc/kubernetes/pki</span>
--certificate-key string	<span class="token comment"># 定义一个用于加密 kubeadm-certs Secret 中的控制平台证书的密钥</span>
<span class="token parameter variable">--config</span> string	<span class="token comment"># kubeadm 配置文件的路径</span>
★ --control-plane-endpoint string	<span class="token comment"># 为控制平面指定一个稳定的 IP 地址或 DNS 名称，即配置一个可以长期使用且是高可用的 VIP 或者域名，k8s 多 master 高可用基于此参数实现</span>
--cri-socket string	<span class="token comment"># 要连接的 CRI（容器运行时接口：Container Runtime Interface）套接字的路径。如果为空，则 kubeadm 将尝试自动检测此值；仅当安装了多个 CRI 或具有非标准 CRI 插槽时，才使用此选项</span>
--dry-run	<span class="token comment"># 不要应用任何更改；只是输出将要执行的操作，其实就是测试运行</span>
--experimental-patches string	<span class="token comment"># 用于存储 kustomize 为静态 pod 清单所提供的补丁的路径</span>
--feature-gates string	<span class="token comment"># 一组用来描述各种功能特性的键值（key=value）对。选项是：IPv6DualStack=true|false (ALPHA - default=false)</span>
--ignore-preflight-errors strings	<span class="token comment"># 可以忽略检查过程 中出现的错误信息，比如忽略 swap，如果为 all 就忽略所有</span>
★ --image-repository string	<span class="token comment"># 设置用于拉取控制平面镜像的容器仓库，默认为 k8s.gcr.io</span>
★ --kubernetes-version string	<span class="token comment"># 为控制平面选择一个特定的 Kubernetes 版本，默认为 stable-1</span>
--node-name string	<span class="token comment"># 指定master节点的名称，默认使用hostname</span>
★ --pod-network-cidr string	<span class="token comment"># 设置 pod ip 地址范围， control plane 会自动将 网络发布到其他节点的node，让其上启动的容器使用此网络，flannel插件的默认值是 10.244.0.0/16</span>
★ --service-cidr string	<span class="token comment"># 指定service 的IP 范围. (default "10.96.0.0/12")</span>
--service-dns-domain string	<span class="token comment"># 指定 service 的 dns 后缀, e.g. "myorg.internal". (default "cluster.local")</span>
--skip-certificate-key-	<span class="token comment"># 不打印 control-plane 用于加密证书的key.</span>
--skip-phases strings	<span class="token comment"># 跳过指定的阶段（phase）</span>
--skip-token-print	<span class="token comment"># 不打印 kubeadm init 生成的 default bootstrap token</span>
<span class="token parameter variable">--token</span> string	<span class="token comment"># 指定 node 和control plane 之间，简历双向认证的token ，格式为 [a-z0-9]&#123;6&#125;\.[a-z0-9]&#123;16&#125; - e.g. abcdef.0123456789abcdef</span>
 --token-ttl duration	<span class="token comment"># token 自动删除的时间间隔。 (e.g. 1s, 2m, 3h). 如果设置为 '0', token 永不过期 (default 24h0m0s)</span>
 --upload-certs	<span class="token comment"># 上传 control-plane 证书到 kubeadm-certs Secret</span></code></pre>

<p>k8s 中有三个网段：node、service、pod，这三个网段千万不要冲突，否则通信会出现问题</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 多控制平面（多个master节点）</span>
<span class="token comment"># 多个master通过HAProxy配置的负载均衡，再通过keepalived配置HAProxy的高可用，假设VIP为 10.0.0.1/24</span>
kubeadm init --apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.0</span>.0.71 <span class="token punctuation">\</span>
	--control-plane-endpoint<span class="token operator">=</span><span class="token number">10.0</span>.0.1 <span class="token punctuation">\</span>
	--apiserver-bind-port<span class="token operator">=</span><span class="token number">6443</span> <span class="token punctuation">\</span>
	--kubernetes-version<span class="token operator">=</span>v1.20.2 <span class="token punctuation">\</span>
	--pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\</span>
	--service-cidr<span class="token operator">=</span><span class="token number">10.10</span>.0.0/16 <span class="token punctuation">\</span>
	--image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers

<span class="token comment"># 单控制平面（一个master节点）</span>
<span class="token comment"># 对于单控制平面，controller-plane-endpoint默认同apiserver-advertise-address</span>
kubeadm init --apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.0</span>.0.71 <span class="token punctuation">\</span>
	--apiserver-bind-port<span class="token operator">=</span><span class="token number">6443</span> <span class="token punctuation">\</span>
	--kubernetes-version<span class="token operator">=</span>v1.20.2 <span class="token punctuation">\</span>
	--pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\</span>
	--service-cidr<span class="token operator">=</span><span class="token number">10.10</span>.0.0/16 <span class="token punctuation">\</span>
	--image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers</code></pre>

<h3 id="kubeadm-join"><a href="#kubeadm-join" class="headerlink" title="kubeadm join"></a><code>kubeadm join</code></h3><p>此命令用来初始化 Kubernetes 节点并将其加入集群</p>
<p>在执行完 <code>kubeadm init</code> 后，会在终端打印以后加入此集群时需要执行的<code>kubeadm join</code> 命令</p>
<p>参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-join/">https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-join/</a></p>
<p>当节点加入 kubeadm 初始化的集群时，我们需要建立双向信任。 这个过程可以分解为<strong>发现</strong>和<strong>TLS 引导</strong>两部分。</p>
<blockquote>
<p>通常两个部分会使用相同的令牌。 在这种情况下可以使用 –token 参数，而不是单独指定每个令牌。</p>
</blockquote>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm <span class="token function">join</span> <span class="token punctuation">[</span>api-server-endpoint<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
kubeadm <span class="token function">join</span> <span class="token punctuation">[</span>command<span class="token punctuation">]</span></code></pre>

<p>command：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">phase	<span class="token comment"># 使用此命令可以调用连接工作流的单个阶段</span></code></pre>

<p>api-server-endpoint：控制平面的 IP，如果是单控制平面，就是 master 节点的 IP，如果是多控制平面，就是 VIP</p>
<p>flags：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>

<h3 id="kubeadm-alpha"><a href="#kubeadm-alpha" class="headerlink" title="kubeadm alpha"></a><code>kubeadm alpha</code></h3><p>kubeadm 处于测试阶段的命令，尽量不要用，<code>kubeadm alpha --help</code> 查看有哪些命令，v1.20.2 版本中只有一个：kubeconfig</p>
<h3 id="kubeadm-certs"><a href="#kubeadm-certs" class="headerlink" title="kubeadm certs"></a><code>kubeadm certs</code></h3><pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm certs <span class="token punctuation">[</span>command<span class="token punctuation">]</span></code></pre>

<p>command：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">certificate-key		<span class="token comment"># 生成证书密钥</span>
check-expiration	<span class="token comment"># 检查Kubernetes集群的证书过期情况</span>
generate-csr		<span class="token comment"># 生成密钥和证书签名请求</span>
renew				<span class="token comment"># 为Kubernetes集群更新证书</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm certs check-expiration <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
<span class="token comment"># flags：</span>
--cert-dir string
<span class="token parameter variable">--config</span> string
<span class="token parameter variable">--kubeconfig</span> string</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm certs generate-csr <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
<span class="token comment"># flags：</span>
--cert-dir string
<span class="token parameter variable">--config</span> string
--kubeconfig-dir string</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm certs renew <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
<span class="token comment"># command：</span>
admin.conf					<span class="token comment"># 更新嵌入在kubeconfig文件中的证书，供管理员和kubeadm本身使用</span>
all							<span class="token comment"># 续期所有可用证书</span>
apiserver					<span class="token comment"># 更新服务Kubernetes API的证书</span>
apiserver-etcd-client		<span class="token comment"># 更新apiserver访问etcd时使用的证书</span>
apiserver-kubelet-client 	<span class="token comment"># 更新证书以便API服务器连接到kubelet</span>
controller-manager.conf  	<span class="token comment"># 更新嵌入在kubeconfig文件中的证书，以便控制器管理器使用</span>
etcd-healthcheck-client  	<span class="token comment"># 将活动探测的证书更新到healthcheck etcd</span>
etcd-peer					<span class="token comment"># 为etcd节点之间的通信更新证书</span>
etcd-server					<span class="token comment"># 续证供etcd使用</span>
front-proxy-client			<span class="token comment"># 更新前端代理客户端证书</span>
scheduler.conf				<span class="token comment"># 更新kubeconfig文件中嵌入的证书，以便调度器管理器使用</span>

<span class="token comment"># 每个命令都可以使用 --help 查询帮助，例如：`kubeadm certs renew admin.conf --help`</span></code></pre>

<h3 id="kubeadm-config"><a href="#kubeadm-config" class="headerlink" title="kubeadm config"></a><code>kubeadm config</code></h3><p>在 <code>kubeadm init</code> 执行期间，kubeadm 将 ClusterConfiguration 对象上传到你的集群的 kube-system 名字空间下 名为 kubeadm-config 的 ConfigMap 对象中。 然后在 <code>kubeadm join</code>、<code>kubeadm reset</code> 和 <code>kubeadm upgrade</code> 执行期间读取此配置。 要查看此 ConfigMap，请调用 <code>kubectl get cm -o yaml -n kube-system kubeadm-config</code>。</p>
<p>你可以使用 <code>kubeadm config print</code> 命令打印默认配置， 并使用 <code>kubeadm config migrate</code> 命令将旧版本的配置转化成新版本。 <code>kubeadm config images list</code> 和 <code>kubeadm config images pull</code> 命令可以用来列出并拉取 kubeadm 所需的镜像。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm config <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
kubeadm config <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></code></pre>

<p>command：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">images	<span class="token comment"># 与kubeadm使用的容器镜像交互</span>
migrate <span class="token comment"># 将本地旧版本的配置对象转换为最新支持的版本，而无需变更集群中的任何内容</span>
print   <span class="token comment"># 打印对象</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm config images <span class="token punctuation">[</span>command<span class="token punctuation">]</span>	<span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
<span class="token comment"># command：</span>
list	<span class="token comment"># 打印 kubeadm 要使用的镜像列表。配置文件用于自定义任何镜像或镜像存储库。</span>
pull	<span class="token comment"># 拉取 kubeadm 使用的镜像</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm config images list <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
<span class="token comment"># flags</span>
--allow-missing-template-keys
<span class="token parameter variable">--config</span> string
-o, --experimental-output string
--feature-gates string
--image-repository string
--kubernetes-version string</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm config images pull <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
<span class="token comment"># flags</span>
<span class="token parameter variable">--config</span> string					<span class="token comment"># kubeadm 配置文件的路径</span>
--cri-socket string
--feature-gates string
--image-repository string
--kubernetes-version string</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm config migrate <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
<span class="token comment"># flags：</span>
--new-config string		<span class="token comment"># 使用新的 API 版本生成的 kubeadm 配置文件的路径。默认输出到stdout。</span>
--old-config string		<span class="token comment"># 使用旧 API 版本且应转换的 kubeadm 配置文件的路径。此参数是必需的</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm config print <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
<span class="token comment"># command：</span>
init-defaults	<span class="token comment"># 打印默认的初始化配置，可以用于`kubeadm init`</span>
join-defaults	<span class="token comment"># 打印默认连接配置，可以用于`kubeadm join`</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm config print init-defaults <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
kubeadm config print join-defaults <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
<span class="token comment"># flags</span>
--component-configs strings</code></pre>

<p>flags：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--kubeconfig</span> string		<span class="token comment"># 与集群通信时要使用的kubeconfig文件。(默认/etc/kubernetes/admin.conf)</span></code></pre>

<h3 id="kubeadm-reset"><a href="#kubeadm-reset" class="headerlink" title="kubeadm reset"></a><code>kubeadm reset</code></h3><p><code>kubeadm reset</code> 负责从使用 <code>kubeadm init</code> 或 <code>kubeadm join</code> 命令创建的文件中清除节点本地文件系统。对于控制平面节点，reset 还从 etcd 集群中删除该节点的本地 etcd 堆成员，还从 kubeadm ClusterStatus 对象中删除该节点的信息。 ClusterStatus 是一个 kubeadm 管理的 Kubernetes API 对象，该对象包含 kube-apiserver 端点列表。</p>
<p><code>kubeadm reset phase</code> 可用于执行上述工作流程的各个阶段。 要跳过阶段列表，你可以使用 –skip-phases 参数，该参数的工作方式类似于 <code>kubeadm join</code> 和 <code>kubeadm init</code> 阶段运行器</p>
<p>“reset” 执行以下阶段：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">preflight              Run reset pre-flight checks
update-cluster-status  Remove this <span class="token function">node</span> from the ClusterStatus object.
remove-etcd-member     Remove a <span class="token builtin class-name">local</span> etcd member.
cleanup-node           Run cleanup node.</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm reset <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
kubeadm reset <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></code></pre>

<p>command：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">phase	<span class="token comment"># 调用重置工作流的单个阶段</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm reset phase <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
<span class="token comment"># command</span>
cleanup-node          <span class="token comment"># Run cleanup node.</span>
preflight             <span class="token comment"># Run reset pre-flight checks</span>
remove-etcd-member    <span class="token comment"># Remove a local etcd member.</span>
update-cluster-status <span class="token comment"># Remove this node from the ClusterStatus object.</span></code></pre>

<p>flags：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">--cert-dir string	<span class="token comment"># 存储证书的目录路径。需要清空此目录。默认"/etc/kubernetes/pki"</span>
--cri-socket string	<span class="token comment"># 要连接的 CRI 套接字的路径。如果为空，则 kubeadm 将尝试自动检测此值；仅当安装了多个CRI 或具有非标准 CRI 插槽时，才使用此选项</span>
-f, <span class="token parameter variable">--force</span>	<span class="token comment"># 	在不提示确认的情况下重置节点</span>
--ignore-preflight-errors strings	<span class="token comment"># 忽略检查过程中出现的错误信息，比如swap，如果为all就忽略所有</span>
<span class="token parameter variable">--kubeconfig</span> string	<span class="token comment"># 与集群通信时使用的 kubeconfig 文件，默认 /etc/kubernetes/admin.conf</span>
--skip-phases strings	<span class="token comment"># 要跳过的阶段列表，四个阶段</span></code></pre>

<blockquote>
<p>注意：如果使用了外部 etcd，<code>kubeadm reset</code> 将不会删除任何 etcd 中的数据</p>
</blockquote>
<h3 id="kubeadm-token"><a href="#kubeadm-token" class="headerlink" title="kubeadm token"></a><code>kubeadm token</code></h3><p>用于管理 <code>kubeadm join</code> 使用的令牌</p>
<p>使用 <code>kubeadm init</code> 默认生成的 token 有效期 24 小时</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 生成新 token</span>
<span class="token variable">$kubeadm</span> token create --print-join-command
kubeadm <span class="token function">join</span> <span class="token number">10.0</span>.0.171:6443 <span class="token parameter variable">--token</span> mud4vy.ygs3zdmuz6rwggrt     --discovery-token-ca-cert-hash sha256:83da17177796380c6038dd8a76bc7050fd9c3c6b55d53a7f7a652817cc73c8e6
<span class="token comment"># 查看目前有效的token</span>
<span class="token variable">$kubeadm</span> token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA <span class="token environment constant">GROUPS</span>
mud4vy.ygs3zdmuz6rwggrt   23h         <span class="token number">2021</span>-01-23T23:46:03+08:00   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>                                                     system:bootstrappers:kubeadm:default-node-token
<span class="token comment"># 查看 hash</span>
<span class="token variable">$openssl</span> x509 <span class="token parameter variable">-pubkey</span> <span class="token parameter variable">-in</span> /etc/kubernetes/pki/ca.crt <span class="token operator">|</span> openssl rsa <span class="token parameter variable">-pubin</span> <span class="token parameter variable">-outform</span> der <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> openssl dgst <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-hex</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^.* //'</span>
83da17177796380c6038dd8a76bc7050fd9c3c6b55d53a7f7a652817cc73c8e6</code></pre>

<h3 id="kubeadm-upgrade"><a href="#kubeadm-upgrade" class="headerlink" title="kubeadm upgrade"></a><code>kubeadm upgrade</code></h3><p>用于升级 Kubernetes 集群到新版本</p>
<h3 id="kubeadm-version"><a href="#kubeadm-version" class="headerlink" title="kubeadm version"></a><code>kubeadm version</code></h3><p>用于打印 kubeadm 的版本信息</p>
<h3 id="kubeadm-help"><a href="#kubeadm-help" class="headerlink" title="kubeadm help"></a><code>kubeadm help</code></h3><h2 id="部署-k8s-集群"><a href="#部署-k8s-集群" class="headerlink" title="部署 k8s 集群"></a>部署 k8s 集群</h2><p><img data-src="//img.to2b.cn/blog/ljk/1610715414287.png" alt="部署规划图"></p>
<p>学习环境，简单部署，准备三台主机，都是 centos7</p>
<table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>ip 地址</th>
</tr>
</thead>
<tbody><tr>
<td>master1</td>
<td>master01.ljk.cn</td>
<td>10.0.0.71&#x2F;24</td>
</tr>
<tr>
<td>node1</td>
<td>node01.ljk.cn</td>
<td>10.0.0.72&#x2F;24</td>
</tr>
<tr>
<td>node2</td>
<td>node02.ljk.cn</td>
<td>10.0.0.73&#x2F;24</td>
</tr>
</tbody></table>
<h3 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11lfXdWn">安装 docker</a></h3><p>注意：kubernetes 对 docker 的版本有要求，最新版本的 docker 一般来讲都不兼容</p>
<p>经过测试：kubernetes v1.20.2 最高支持 docker v19.03</p>
<p>在三台主机上均执行以下步骤：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum makecache fast
yum list docker-ce.x86_64 <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span>	<span class="token comment"># 搜索可用版本</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce-19.03.9	<span class="token comment"># 安装指定版本</span>
<span class="token comment"># 加速 和 优化</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker
<span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
&#123;
  "registry-mirrors": ["https://3417nt4m.mirror.aliyuncs.com"],
  "exec-opts":["native.cgroupdriver=systemd"]
&#125;
EOF</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> docker.service</code></pre>

<h3 id="安装-Kubernetes"><a href="#安装-Kubernetes" class="headerlink" title="安装 Kubernetes"></a><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3e221b11lfXdWn">安装 Kubernetes</a></h3><p>在三台主机上均执行以下步骤：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>
setenforce <span class="token number">0</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectl
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet</code></pre>

<h3 id="部署-dns，或者直接修改-x2F-etc-x2F-hosts"><a href="#部署-dns，或者直接修改-x2F-etc-x2F-hosts" class="headerlink" title="部署 dns，或者直接修改&#x2F;etc&#x2F;hosts"></a>部署 dns，或者直接修改&#x2F;etc&#x2F;hosts</h3><p>在三台主机上均执行以下步骤：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat /etc/hosts</span>
<span class="token punctuation">..</span>.
<span class="token number">10.0</span>.0.71 master01.ljk.cn
<span class="token number">10.0</span>.0.72 node01.ljk.cn
<span class="token number">10.0</span>.0.73 node02.ljk.cn</code></pre>

<h3 id="kubeadm-init-初始化"><a href="#kubeadm-init-初始化" class="headerlink" title="kubeadm init 初始化"></a><code>kubeadm init</code> 初始化</h3><p>集群初始化，而且集群初始化只需要初始化一次</p>
<p>注意：<code>kubeadm init</code> 必须在 master 节点上运行，任意一 master 节点即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 提前下载组件镜像，这一步可以不用执行，init的时候会自动下载，但是下载时间一般很长，最好还是提前下载</span>
kubeadm config images pull --image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers --kubernetes-version<span class="token operator">=</span>v1.20.2
<span class="token comment"># 预检查一下，出现问题则修复</span>
<span class="token punctuation">[</span>root@master01 docker<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> init phase preflight</code></pre>

<p>初始化，两种方式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 方式一</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> init --apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.0</span>.0.71 <span class="token punctuation">\</span>
	--apiserver-bind-port<span class="token operator">=</span><span class="token number">6443</span> <span class="token punctuation">\</span>
	--kubernetes-version<span class="token operator">=</span>v1.20.2 <span class="token punctuation">\</span>
	--pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\</span>
	--service-cidr<span class="token operator">=</span><span class="token number">10.10</span>.0.0/16 <span class="token punctuation">\</span>
	--image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>
	--ignore-preflight-errors<span class="token operator">=</span>NumCPU	<span class="token comment"># 学习环境，忽略cpu数量的检查</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 方式二</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> config print init-defaults <span class="token operator">></span> /etc/kubernetes/kubeadmin-init.yaml
<span class="token comment"># 修改advertiseAddress、imageRepository、kubernetesVersion、dnsDomain、serviceSubnet</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/kubernetes/kubeadmin-init.yaml
apiVersion: kubeadm.k8s.io/v1beta2
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: <span class="token number">10.0</span>.0.71
  bindPort: <span class="token number">6443</span>
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: master01.ljk.cn
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
<span class="token comment">#controlPlaneEndpoint: 10.0.0.1:6443 #多控制平面开启此项，基于 VIP 的 Endpoint</span>
controllerManager: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
dns:
  type: CoreDNS
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
kubernetesVersion: v1.20.2
networking:
  dnsDomain: ljk.local
  podSubnet: <span class="token number">10.244</span>.0.0/16
  serviceSubnet: <span class="token number">10.10</span>.0.0/16
scheduler: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@master01 docker<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> init <span class="token parameter variable">--config</span><span class="token operator">=</span>/etc/kubernetes/kubeadmin-init.yaml --ignore-preflight-errors<span class="token operator">=</span>NumCPU	<span class="token comment"># 忽略检查cpu核心数，生产环境不要忽略</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">10.0</span>.0.71:6443 <span class="token parameter variable">--token</span> abcdef.0123456789abcdef <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:b794ecc7f2fc825b58e4e2108eab0dfa603c3d861de55bcc8c437949bed83fec

<span class="token comment"># 按照init成功后的提示</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
<span class="token comment"># 如果是root用户，也可以</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

<span class="token comment"># 安装网络插件 flannel，参考：https://github.com/coreos/flannel</span>
<span class="token comment"># 这个链接可能需要科学上网</span>
kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></pre>

<p>补充：如果是多控制平面，<code>kubeadm init</code> 需要添加 –control-plane-endpoint 参数，设置访问多个 master 的 VIP，通常是 keepalived+HAProxy 配置多个 master 的高可用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> init --apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.0</span>.0.71 <span class="token punctuation">\</span>
	--control-plane-endpoint<span class="token operator">=</span><span class="token number">10.0</span>.0.1 <span class="token punctuation">\</span>
	--apiserver-bind-port<span class="token operator">=</span><span class="token number">6443</span> <span class="token punctuation">\</span>
	--kubernetes-version<span class="token operator">=</span>v1.20.2 <span class="token punctuation">\</span>
	--pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\</span>
	--service-cidr<span class="token operator">=</span><span class="token number">10.10</span>.0.0/16 <span class="token punctuation">\</span>
	--image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>
	--ignore-preflight-errors<span class="token operator">=</span>NumCPU</code></pre>

<h3 id="kubeadm-join-node-加入-k8s-集群"><a href="#kubeadm-join-node-加入-k8s-集群" class="headerlink" title="kubeadm join node 加入 k8s 集群"></a><code>kubeadm join</code> node 加入 k8s 集群</h3><p>加入集群的 <code>kubeadm join</code> 命令在 <code>kubeadm init</code> 完成后会自动打印出来，如果将来 token 和 hash 过期失效了，使用 <code>kubeadm token create --print-join-command</code> 重新生成即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># node1</span>
<span class="token punctuation">[</span>root@node01 kubernetes<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> <span class="token function">join</span> <span class="token number">10.0</span>.0.71:6443 <span class="token punctuation">\</span>
	<span class="token parameter variable">--token</span> abcdef.0123456789abcdef <span class="token punctuation">\</span>
	--discovery-token-ca-cert-hash sha256:b794ecc7f2fc825b58e4e2108eab0dfa603c3d861de55bcc8c437949bed83fec
<span class="token comment"># node2</span>
<span class="token punctuation">[</span>root@node02 ~<span class="token punctuation">]</span><span class="token variable">$kubeadm</span> <span class="token function">join</span> <span class="token number">10.0</span>.0.71:6443 <span class="token punctuation">\</span>
	<span class="token parameter variable">--token</span> abcdef.0123456789abcdef	<span class="token punctuation">\</span>
	--discovery-token-ca-cert-hash sha256:b794ecc7f2fc825b58e4e2108eab0dfa603c3d861de55bcc8c437949bed83fec</code></pre>

<p>查看是否加入成功：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token variable">$kubectl</span> get nodes
NAME              STATUS   ROLES                  AGE     VERSION
master01.ljk.cn   Ready    control-plane,master   53m     v1.20.2
node01.ljk.cn     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 6m24s   v1.20.2
node02.ljk.cn     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 10m     v1.20.2

<span class="token comment"># 在每个节点上都生成一个flannel网卡，或者说是网络隧道，保障集群内部的通信</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token variable">$ip</span> a		<span class="token comment"># master</span>
<span class="token punctuation">..</span>.
<span class="token number">4</span>: flannel.1: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1450</span> qdisc noop state DOWN group default
    link/ether <span class="token number">26</span>:69:fd:2f:7a:3f brd ff:ff:ff:ff:ff:ff
<span class="token punctuation">[</span>root@node01 kubernetes<span class="token punctuation">]</span><span class="token variable">$ip</span> a	<span class="token comment"># node1</span>
<span class="token punctuation">..</span>.
<span class="token number">4</span>: flannel.1: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1450</span> qdisc noop state DOWN group default
    link/ether a2:74:d6:61:d5:5c brd ff:ff:ff:ff:ff:ff
<span class="token punctuation">[</span>root@node02 ~<span class="token punctuation">]</span><span class="token variable">$ip</span> a	<span class="token comment"># node2</span>
<span class="token punctuation">..</span>.
<span class="token number">4</span>: flannel.1: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1450</span> qdisc noop state DOWN group default
    link/ether fe:83:2b:fc:1e:01 brd ff:ff:ff:ff:ff:ff</code></pre>

<h2 id="部署-Web-服务-Dashboard"><a href="#部署-Web-服务-Dashboard" class="headerlink" title="部署 Web 服务 Dashboard"></a>部署 Web 服务 Dashboard</h2><p>github 地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/releases">https://github.com/kubernetes/dashboard/releases</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.下载配置清单</span>
<span class="token variable">$wget</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.1.0/aio/deploy/recommended.yaml
<span class="token comment"># 2.修改配置清单</span>
<span class="token variable">$vim</span> recommended.yaml
<span class="token punctuation">..</span>.
spec:
  type: NodePort	<span class="token comment"># 添加此行</span>
  ports:
    - port: <span class="token number">443</span>
      targetPort: <span class="token number">8443</span>
      nodePort: <span class="token number">30002</span>		<span class="token comment"># 添加此行</span>
  selector:
    k8s-app: kubernetes-dashboard
 <span class="token punctuation">..</span>.
 <span class="token comment"># 3.创建资源对象</span>
 kubectl apply <span class="token parameter variable">-f</span> ./recommended.yaml
 <span class="token comment"># 4.查看</span>
<span class="token variable">$kubectl</span> get pod <span class="token parameter variable">-n</span> kubernetes-dashboard
NAME                                         READY   STATUS    RESTARTS   AGE
dashboard-metrics-scraper-79c5968bdc-5dv7w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          88m
kubernetes-dashboard-7448ffc97b-rg77t        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          88m
<span class="token comment"># 5.创建管理 dashboard 的 service 账号</span>
<span class="token variable">$cat</span> admin-user.yml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
<span class="token variable">$kubectl</span> apply <span class="token parameter variable">-f</span> admin-user.yml
<span class="token comment"># 6.查看 admin-user 的 token</span>
<span class="token variable">$kubectl</span> get secrets <span class="token parameter variable">-A</span> <span class="token operator">|</span> <span class="token function">grep</span> admin-user
<span class="token variable">$kubectl</span> describe secrets <span class="token parameter variable">-n</span> kubernetes-dashboard admin-user-token-wpz7j
Name:         admin-user-token-wpz7j
Namespace:    kubernetes-dashboard
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:  kubernetes.io/service-account.name: admin-user
              kubernetes.io/service-account.uid: 613c9277-f124-4622-88c9-714dc2479602

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
ca.crt:     <span class="token number">1066</span> bytes
namespace:  <span class="token number">20</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjJ2THVKYzd4Q3hVeVI5QWVCMk5YUU5kbE9lRzJjZ1hHZkV0WndQUGczWmcifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXdwejdqIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI2MTNjOTI3Ny1mMTI0LTQ2MjItODhjOS03MTRkYzI0Nzk2MDIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.N7Hcf9JIgV5p_j8-YYJHMDrqGkGtsalTxbabTjXASyoR63gmvNmekPACQ9EDwu1MF2du3wkyReVb_aYD11tHw4XsNbfnoaytYqcQ9U8lhLXd8A7wlBnK8_EBa5-XP0-nRRSw7gUsG6s7xvrviWcndNO0nIUPgS--B1G8S-AR_Y0CJRzFF4FL0zhZvxCxSDwHO2OrjKpbxhuZOgzhOI_CXCEMghsCyUUFeNlRj2F-YulzVNLdJSzIh0UMyvoKVv6ylesRtyUJK8lo3tpcC0K4hTKsWYXHgibto024tT4D1KtYLqNhEhI4PkYogZQTsG3-ggVo5Nry5m8AL0CKCD0xoA</code></pre>

<p>最后，打开浏览器，输入 <a target="_blank" rel="noopener" href="https://10.0.0.171:30002/%EF%BC%8C%E9%99%A4%E4%BA%8610.0.0.171%EF%BC%8C10.0.0.71">https://10.0.0.171:30002/，除了10.0.0.171，10.0.0.71</a> 和 10.0.0.72 也可以，然后 copy 刚才生产的 admin-user 用户的 token，成功登陆</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611329286288.png"></p>
<h2 id="k8s-集群升级"><a href="#k8s-集群升级" class="headerlink" title="k8s 集群升级"></a>k8s 集群升级</h2><p>小版本升级，一般不会有很大更改，经过充分测试，直接升级即可</p>
<p>大版本升级，风险较大，可以像小版本一样，经过测试，然后直接升级；但是更推荐以下升级方式：</p>
<ol>
<li><p>在备用的服务器上再部署一套 k8s 集群，使用最新的 k8s 版本</p>
</li>
<li><p>把业务离线导入新的 k8s 集群</p>
</li>
<li><p>经过测试后，切换负载均衡到新的 k8s 集群</p>
</li>
<li><p>下线的旧 k8s 集群，直接重装系统，安装最新的 ubuntu 或者 centos，然后作为 node 加入到新的 k8s 集群</p>
</li>
<li><p>升级完成</p>
</li>
</ol>
<p>这种方法是比较稳妥的，只是成本比较高，需要有充足的备用的服务器，如果目前的 k8s 集群使用 30 台服务器，那备用的服务器差不多也得 20 台</p>
<h3 id="升级-master"><a href="#升级-master" class="headerlink" title="升级 master"></a>升级 master</h3><p>先升级 kubeadm，kubeadm 是 k8s 升级的“准升证”</p>
<ol>
<li><p>验证当 k8s 前版本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$kubeadm</span> version</code></pre>
</li>
<li><p>各 master 安装指定新版本 kubeadm</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$apt</span>-cache madison kubeadm <span class="token comment">#查看 k8s 版本列表</span>
<span class="token variable">$apt</span>-get <span class="token function">install</span> <span class="token assign-left variable">kubeadm</span><span class="token operator">=</span><span class="token number">1.17</span>.4-00 <span class="token comment">#安装新版本 kubeadm</span>
<span class="token variable">$kubeadm</span> version <span class="token comment">#验证 kubeadm 版本</span>
<span class="token variable">$apt</span> <span class="token function">install</span> <span class="token assign-left variable">kubelet</span><span class="token operator">=</span><span class="token number">1.17</span>.4-00 <span class="token assign-left variable">kubectl</span><span class="token operator">=</span><span class="token number">1.17</span>.4-00	<span class="token comment"># kubectl 和 kubelet 也升级一下</span></code></pre>
</li>
<li><p>kubeadm 升级命令使用帮助</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$kubeadm</span> upgrade <span class="token parameter variable">--help</span>
Upgrade your cluster smoothly to a newer version with this <span class="token builtin class-name">command</span>

Usage:
  kubeadm upgrade <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
  kubeadm upgrade <span class="token punctuation">[</span>command<span class="token punctuation">]</span>

Available Commands:
  apply       Upgrade your Kubernetes cluster to the specified version
  <span class="token function">diff</span>        Show what differences would be applied to existing static pod manifests. See also: kubeadm upgrade apply --dry-run
  <span class="token function">node</span>        Upgrade commands <span class="token keyword">for</span> a <span class="token function">node</span> <span class="token keyword">in</span> the cluster
  plan        Check <span class="token function">which</span> versions are available to upgrade to and validate whether your current cluster is upgradeable. To skip the internet check, pass <span class="token keyword">in</span> the optional <span class="token punctuation">[</span>version<span class="token punctuation">]</span> parameter</code></pre>
</li>
<li><p>升级计划</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubeadm upgrade plan <span class="token comment">#查看升级计划</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1611378566762.png"></p>
</li>
<li><p>开始升级</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$kubeadm</span> upgrade apply v1.17.4 <span class="token comment">#master1</span>
<span class="token variable">$kubeadm</span> upgrade apply v1.17.4 <span class="token comment">#master2</span>
<span class="token variable">$kubeadm</span> upgrade apply v1.17.4 <span class="token comment">#master3</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1611378684576.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611378700401.png"></p>
</li>
<li><p>验证镜像</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$docker</span> image <span class="token function">ls</span></code></pre></li>
</ol>
<h3 id="升级-node"><a href="#升级-node" class="headerlink" title="升级 node"></a>升级 node</h3><p>升级客户端服务 kubectl kubelet</p>
<ol>
<li><p>验证当前 node 版本信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$kubectl</span> get <span class="token function">node</span></code></pre>
</li>
<li><p>升级各 node 节点配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$kubeadm</span> upgrade <span class="token function">node</span> --kubelet-version v1.17.4		<span class="token comment"># master上执行</span></code></pre>
</li>
<li><p>各 Node 节点升级 kubelet、kubeadm、kubectl 二进制包</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$apt</span> <span class="token function">install</span> <span class="token assign-left variable">kubelet</span><span class="token operator">=</span><span class="token number">1.17</span>.4-00 <span class="token assign-left variable">kubeadm</span><span class="token operator">=</span><span class="token number">1.17</span>.4-00 <span class="token assign-left variable">kubectl</span><span class="token operator">=</span><span class="token number">1.17</span>.4-00</code></pre></li>
</ol>
<h2 id="测试运行-Nginx-Tomcat"><a href="#测试运行-Nginx-Tomcat" class="headerlink" title="测试运行 Nginx+Tomcat"></a>测试运行 Nginx+Tomcat</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Kubernetes/%E8%B5%84%E6%BA%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Kubernetes/%E8%B5%84%E6%BA%90/" class="post-title-link" itemprop="url">资源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-14 23:10:04" itemprop="dateCreated datePublished" datetime="2021-01-14T23:10:04+08:00">2021-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>并非所有对象都在名字空间中，大多数 kubernetes 资源（例如 Pod、Service、deployment 等）都位于某些 Namespace 中。 但是 Namespace 资源本身并不在 Namespace 中。而且底层资源，例如 Node 和 persistentVolumes 不属于任何名字空间</p>
<p>查看哪些资源在 Namespace 中，哪些不在 Namespace 中：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 位于名字空间中的资源</span>
kubectl api-resources <span class="token parameter variable">--namespaced</span><span class="token operator">=</span>true

<span class="token comment"># 不在名字空间中的资源</span>
kubectl api-resources <span class="token parameter variable">--namespaced</span><span class="token operator">=</span>false</code></pre>

<h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><p>以应用（Pod）为中心：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613959187857.png"></p>
<ul>
<li>pop 是容器集，是 k8s 的最小运行单元，一个 pop 中的所有容器必须运行在同一 node 上</li>
<li>运行多个容器的话，这些容器是一起被调度的</li>
<li>Pod 的生命周期是短暂的，不会自愈，是用完就销毁的实体</li>
<li>一般通过 Controller 来创建和管理 pod</li>
</ul>
<h3 id="建立-pod"><a href="#建立-pod" class="headerlink" title="建立 pod"></a>建立 pod</h3><p>p83，4.5.2 pod 的创建过程</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615683760108.png"></p>
<p>一个 pod 就像是一个虚拟机：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613959332313.png"></p>
<p><strong>pause</strong> 是 pod 的基础设施容器，这个容器的作用是给 pod 内部容器提供可被加入和共享的 net、ipc、uts、namespace，同时我们向一个 pod 附加 volume 时，也是附加在 pause 之上，从而可以被共享给一个 pod 内的多个容器</p>
<h3 id="Pod-的生命周期"><a href="#Pod-的生命周期" class="headerlink" title="Pod 的生命周期"></a>Pod 的生命周期</h3><p>初始化容器、启动前操作、就绪探针、存活探针、删除 pod 操作</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1615741115662.png"></p>
<h4 id="livenessProb"><a href="#livenessProb" class="headerlink" title="livenessProb"></a>livenessProb</h4><p>存活探针，检测应用是否发生故障，检测失败重启 pod</p>
<h4 id="readinessProbe"><a href="#readinessProbe" class="headerlink" title="readinessProbe"></a>readinessProbe</h4><p>就绪探针，检测 pod 启动之后应用是否就绪，是否可以提供服务，检测成功，pod 才开始接收流量</p>
<h2 id="控制器（controller）"><a href="#控制器（controller）" class="headerlink" title="控制器（controller）"></a>控制器（controller）</h2><p>控制器有数十种，最常用的是 deployment：无状态应用编排工具</p>
<table>
<thead>
<tr>
<th>控制器</th>
<th>简写</th>
<th>简述</th>
</tr>
</thead>
<tbody><tr>
<td>ReplicationController</td>
<td>rc</td>
<td>第一代 pod 副本控制器</td>
</tr>
<tr>
<td>ReplicaSet</td>
<td>rs</td>
<td>第二代 pod 副本控制器</td>
</tr>
<tr>
<td>Deployment</td>
<td>deploy</td>
<td>第三代 pod 控制器</td>
</tr>
</tbody></table>
<h3 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicationcontroller/">https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicationcontroller/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/">https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/</a></p>
<p>副本控制器 selector &#x3D;、!&#x3D;</p>
<h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicaset/">https://kubernetes.io/zh/docs/concepts/workloads/controllers/replicaset/</a></p>
<p>副本控制集，和副本控制器的区别是：selector 还支持 in、notin</p>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/</a></p>
<p>比 rs 更高一级的控制器，除了有 rs 的功能之外，还有很多高级功能,，比如说最重要的：滚动升级、回滚等</p>
<h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><p>DaemonSet 确保全部（或者某些）节点上运行一个 Pod 的副本。 当有节点加入集群时， 也会为他们新增一个 Pod 。 当有节点从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除它创建的所有 Pod</p>
<p>DaemonSet 的一些典型用法：</p>
<ul>
<li>在每个节点上运行集群守护进程</li>
<li>在每个节点上运行日志收集守护进程</li>
<li>在每个节点上运行监控守护进程</li>
</ul>
<p>一种简单的用法是为每种类型的守护进程在所有的节点上都启动一个 DaemonSet。 一个稍微复杂的用法是为同一种守护进程部署多个 DaemonSet；每个具有不同的标志， 并且对不同硬件类型具有不同的内存、CPU 要求</p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a><a href="./service/">Service</a></h2><p>pod 重建之后 ip 就变了，pod 之间直接访问会有问题，service 就是用来解决这个问题</p>
<p>service 解耦了服务和应用</p>
<p>一般常用的有两种：</p>
<ol>
<li>k8s 集群内的 service：selector 指定 pod，自动创建 Endpoints</li>
<li>k8s 集群外的 service：手动创建 Endpoints，指定外部服务的 ip，端口和协议</li>
</ol>
<p>kube-proxy 和 service 的关系：<br>kube-proxy 监听着 k8s-apiserver，一旦 service 资源发生变化（调 k8s-api 修改 service 信息），kube-proxy 就会生成对应的负载调度的调整，这样就保证 service 的最新状态</p>
<h2 id="卷（volume）"><a href="#卷（volume）" class="headerlink" title="卷（volume）"></a>卷（volume）</h2><p>volume：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">https://kubernetes.io/zh/docs/concepts/storage/volumes/</a><br>emptydir：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#emptydir">https://kubernetes.io/zh/docs/concepts/storage/volumes/#emptydir</a><br>hostpath：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath">https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath</a><br>nfs：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#nfs">https://kubernetes.io/zh/docs/concepts/storage/volumes/#nfs</a><br>configmap：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#configmap">https://kubernetes.io/zh/docs/concepts/storage/volumes/#configmap</a></p>
<table>
<thead>
<tr>
<th><font style="white-space:nowrap;">卷类型&amp;emsp; &amp;emsp; &amp;emsp; &amp;emsp; &amp;emsp;</font></th>
<th>简介</th>
</tr>
</thead>
<tbody><tr>
<td>emptyDir</td>
<td>挂载一个空目录，pod 删除时，卷也会被删除</td>
</tr>
<tr>
<td>hostPath</td>
<td>和 <code>docker -v</code> 实现一样的效果<br />挂载文件或目录挂载，pod 删除的时候，卷不会被删除，但是 Pod 和 node 是绑定的，nfs 等共享存储可以解决这个问题</td>
</tr>
<tr>
<td>nfs 等共享存储</td>
<td>挂载 NFS（网络文件系统），当删除 Pod 时，nfs 卷被卸载，但是内容保留<br />NFS 可以被多个 Pod 同时挂载</td>
</tr>
<tr>
<td>Configmap</td>
<td>Why：配置信息和镜像解耦，避免每次更新配置都得重新打镜像<br />What：将配置信息放到 configmap 对象中，然后在 pod 的对象中导入 configmap 对象，实现导入配置的操作<br />How：声明一个 ConfigMap 的对象，作为 Volume 挂载到 pod 中</td>
</tr>
</tbody></table>
<h2 id="PV-x2F-PVC"><a href="#PV-x2F-PVC" class="headerlink" title="PV &#x2F; PVC"></a>PV &#x2F; PVC</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/">https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/</a></p>
<p>存储的管理是一个与计算实例的管理完全不同的问题。PersistentVolume 子系统为用户和管理员提供了一组 API，<strong>将存储如何供应的细节从其如何被使用中抽象出来</strong>。 为了实现这点，我们引入了两个新的 API 资源：PersistentVolume 和 PersistentVolumeClaim</p>
<pre class="language-none"><code class="language-none">PV：PersistentVolume，持久卷
PVC：PersistentVolumeClaim，持久卷申领</code></pre>

<p>对于有状态服务，例如 MySQL、zookeeper，搭建集群的时候，因为不能共享存储，所以可以给每个节点挂载一个 nfs 存储，但是更推荐在 nfs 上再封装一层 PV &#x2F; PVC</p>
<p>PV &#x2F; PVC 用于有状态的服务，例如 MySQL、zookeeper，nfs 用于无状态的服务，例如 nginx、tomcat</p>
<p>PV &#x2F; PVC 通常和 Statefulset 搭配使用</p>
<h2 id="Statefulset-gt-Operator"><a href="#Statefulset-gt-Operator" class="headerlink" title="Statefulset -&gt; Operator"></a>Statefulset -&gt; Operator</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/">https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/</a></p>
<p>deployment 是无状态应用编排工具，而 statefulset 是有状态应用编排工具</p>
<p>statefulset 本质上是 Deployment 的一种变体，为了解决有状态服务的问题，statefulset 管理的 Pod 拥有固定的 Pod 名称，主机名，启停顺序，在 statefulset 中，Pod 名字称为网络标识(hostname)，还必须要用到共享存储</p>
<p>在 deployment 中，与之对应的服务是 service，而在 statefulset 中与之对应的是 <strong>headless service</strong>，即无头服务，与 service 的区别就是它没有 Cluster IP，解析它的名称时将返回该 headless service 对应的全部 Pod 的 Endpoint 列表</p>
<p>StatefulSet 特点：</p>
<ul>
<li>给每个 pdo 分配固定且唯一的网络标识符</li>
<li>给<strong>每个</strong>pod 分配固定且持久化的外部存储</li>
<li>对 pod 进行有序的部署和扩展</li>
<li>对 pod 进有序的删除和终止</li>
<li>对 pod 进有序的自动滚动更新</li>
</ul>
<p>StatefulSet 的组成部分：</p>
<ul>
<li>Headless Service：用来定义 Pod 网络标识( DNS domain)</li>
<li>StatefulSet：定义具体应用，有多少个 Pod 副本，并为每个 Pod 定义了一个域名</li>
<li>volumeClaimTemplates： 存储卷申请模板，创建 PVC，指定 pvc 名称大小，将自动创建 pvc，且 pvc 必须由存储类供应</li>
</ul>
<h3 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/</a></p>
<p>不同的有状态应用的运维操作过程差别巨大，因此 StatefulSet 控制器本身几乎无法为此种类型的应用提供完善的通用管理控制机制，现实中的各种有状态应用通常是使用专用的自定义控制器专门封装特定的运维操作流程，这些自定义控制器统称为 Operator</p>
<p>Operator 是 kubernetes 的扩展软件，Operator 是 Kubernetes API 的客户端，充当 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/">定制资源</a> 的控制器</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/HTTP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/HTTP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">HTTP协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-12 22:09:47" itemprop="dateCreated datePublished" datetime="2021-01-12T22:09:47+08:00">2021-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Socket-套接字"><a href="#Socket-套接字" class="headerlink" title="Socket 套接字"></a>Socket 套接字</h2><p><img data-src="//img.to2b.cn/blog/ljk/1610460765251.png"></p>
<p>套接字 Socket 是进程间通信 IPC 的一种实现，允许位于不同主机（或同一主机）上不同进程之间进行通信和数据交换，SocketAPI 出现于 1983 年 BSD 4.2 实现</p>
<p>在建立通信连接的每一端，进程间的传输要有两个标志：IP 地址和端口号，合称为套接字地址 socket address</p>
<p>客户机套接字地址定义了一个唯一的客户进程<br>服务器套接字地址定义了一个唯一的服务器进程</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610460824378.png"></p>
<h3 id="Socket-API"><a href="#Socket-API" class="headerlink" title="Socket API"></a>Socket API</h3><p>封装了内核中所提供的 socket 通信相关的系统调用</p>
<p>Socket Domain：根据其所使用的地址</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">AF_INET</span>		<span class="token comment"># Address Family，IPv4</span>
<span class="token constant">AF_INET6</span>	<span class="token comment"># IPv6</span>
<span class="token constant">AF_UNIX</span>		<span class="token comment"># 同一主机上不同进程之间通信时使用</span></code></pre>

<p>Socket Type：根据使用的传输层协议</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">SOCK_STREAM</span>		<span class="token comment"># 流，tcp套接字，可靠地传递、面向连接</span>
<span class="token constant">SOCK_DGRAM</span>		<span class="token comment"># 数据报，udp套接字，不可靠地传递、无连接</span>
<span class="token constant">SOCK_RAW</span>		<span class="token comment"># 裸套接字,无须tcp或udp,APP直接通过IP包通信</span></code></pre>

<h3 id="客户-x2F-服务器程序的套接字函数"><a href="#客户-x2F-服务器程序的套接字函数" class="headerlink" title="客户&#x2F;服务器程序的套接字函数"></a>客户&#x2F;服务器程序的套接字函数</h3><p><img data-src="//img.to2b.cn/blog/ljk/1610461039387.png"></p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 		<span class="token comment"># 创建一个套接字</span>
<span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 			<span class="token comment"># 绑定IP和端口</span>
<span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 		<span class="token comment"># 监听</span>
<span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 		<span class="token comment"># 接收请求</span>
<span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 		<span class="token comment"># 请求连接建立</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 		<span class="token comment"># 发送</span>
<span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 			<span class="token comment"># 接收</span>
<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 		<span class="token comment"># 关闭连接</span></code></pre>

<h2 id="http-协议及报文头部结构"><a href="#http-协议及报文头部结构" class="headerlink" title="http 协议及报文头部结构"></a>http 协议及报文头部结构</h2><h3 id="Method-方法"><a href="#Method-方法" class="headerlink" title="Method 方法"></a>Method 方法</h3><p>请求方法，标明客户端希望服务器对资源执行的动作</p>
<ul>
<li>GET： 从服务器获取一个资源</li>
<li>HEAD： 只从服务器获取文档的响应首部</li>
<li>POST： 向服务器输入数据，通常会再由网关程序继续处理</li>
<li>PUT： 将请求的主体部分存储在服务器中，如上传文件</li>
<li>DELETE： 请求删除服务器上指定的文档</li>
<li>TRACE： 追踪请求到达服务器中间经过的代理服务器</li>
<li>OPTIONS：请求服务器返回对指定资源支持使用的请求方法</li>
<li>CONNECT：建立一个到由目标资源标识的服务器的隧道</li>
<li>PATCH：用于对资源应用部分修改</li>
</ul>
<h3 id="status-状态码"><a href="#status-状态码" class="headerlink" title="status 状态码"></a>status 状态码</h3><p>参考资料：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status</a></p>
<pre class="language-none"><code class="language-none">1xx：100-101 信息提示
2xx：200-206 成功
3xx：300-307 重定向
4xx：400-415 错误类信息，客户端错误
5xx：500-505 错误类信息，服务器端错误</code></pre>

<pre class="language-none"><code class="language-none">200： 成功，请求数据通过响应报文的entity-body部分发送;OK
301： 永久重定向；Moved Permanently
302： 临时重定向 Moved Temporarily
304： 客户端发出了条件式请求，但服务器上的资源未曾发生改变，则通过响应此响应状态码通知客户端；Not Modified
307:  浏览器内部重定向
401： 需要输入账号和密码认证方能访问资源；Unauthorized
403： 请求被禁止；Forbidden
404： 服务器无法找到客户端请求的资源；Not Found
500： 服务器内部错误；Internal Server Error
502： 代理服务器从后端服务器收到了一条伪响应，如无法连接到网关；Bad Gateway
503： 服务不可用，临时服务器维护或过载，服务器无法处理请求
504： 网关超时</code></pre>

<p>关于 301 和 302：</p>
<p>用户输入了你不希望输入的 url 或者说是没用的 url，用 301 重定向，例如 http 转到 https、旧域名转到新域名；<br>因为业务逻辑临时跳转，用 302 重定向，例如用户直接访问管理后台就临时跳转到登录页面</p>
<h2 id="web-相关工具"><a href="#web-相关工具" class="headerlink" title="web 相关工具"></a>web 相关工具</h2><h3 id="links"><a href="#links" class="headerlink" title="links"></a>links</h3><h3 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">[</span>URL<span class="token punctuation">]</span><span class="token punctuation">..</span>.</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#启动</span>
-V，-version 显示wget的版本后退出
-h，-help 打印语法帮助
-b，-background 启动后转入后台执行
-e，-execute<span class="token operator">=</span>COMMAND 执行<span class="token variable"><span class="token variable">`</span>.wgetrc<span class="token string">'格式的命令，wgetrc格式参见/etc/wgetrc或~/.wgetrc

#记录和输入文件
-o，-output-file=FILE 把记录写到FILE文件中
-a，-append-output=FILE 把记录追加到FILE文件中
-d，-debug 打印调试输出
-q，-quiet 安静模式(没有输出)
-v，-verbose 冗长模式(这是缺省设置)
-nv，-non-verbose 关掉冗长模式，但不是安静模式
-i，-input-file=FILE 下载在FILE文件中出现的URLs
-F，-force-html 把输入文件当作HTML格式文件对待
-B，-base=URL 将URL作为在-F -i参数指定的文件中出现的相对链接的前缀
-sslcertfile=FILE 可选客户端证书
-sslcertkey=KEYFILE 可选客户端证书的KEYFILE
-egd-file=FILE 指定EGD socket的文件名

#下载
-bind-address=ADDRESS 指定本地使用地址(主机名或IP，当本地有多个IP或名字时使用)
-t，-tries=NUMBER 设定最大尝试链接次数(0 表示无限制).
-O -output-document=FILE 把文档写到FILE文件中
-nc，-no-clobber 不要覆盖存在的文件或使用.#前缀
-c，-continue 接着下载没下载完的文件
-progress=TYPE 设定进程条标记
-N，-timestamping 不要重新下载文件除非比本地文件新
-S，-server-response 打印服务器的回应
-spider 不下载任何东西
-T，-timeout=SECONDS 设定响应超时的秒数
-w，-wait=SECONDS 两次尝试之间间隔SECONDS秒
-waitretry=SECONDS 在重新链接之间等待1…SECONDS秒
-random-wait 在下载之间等待0…2*WAIT秒
-Y，-proxy=on/off 打开或关闭代理
-Q，-quota=NUMBER 设置下载的容量限制
-limit-rate=RATE 限定下载输率
#目录
-nd -no-directories 不创建目录
-x，-force-directories 强制创建目录
-nH，-no-host-directories 不创建主机目录
-P，-directory-prefix=PREFIX 将文件保存到目录 PREFIX/…
-cut-dirs=NUMBER 忽略 NUMBER层远程目录
#HTTP 选项
-http-user=USER 设定HTTP用户名为 USER.
-http-passwd=PASS 设定http密码为 PASS.
-C，-cache=on/off 允许/不允许服务器端的数据缓存 (一般情况下允许).
-E，-html-extension 将所有text/html文档以.html扩展名保存
-ignore-length 忽略 '</span>Content-Length'头域
<span class="token parameter variable">-header</span><span class="token operator">=</span>STRING 在headers中插入字符串 STRING
-proxy-user<span class="token operator">=</span><span class="token environment constant">USER</span> 设定代理的用户名为 <span class="token environment constant">USER</span>
-proxy-passwd<span class="token operator">=</span>PASS 设定代理的密码为 PASS
<span class="token parameter variable">-referer</span><span class="token operator">=</span>URL 在HTTP请求中包含 <span class="token variable">`</span></span>Referer: URL<span class="token string">'头
-s，-save-headers 保存HTTP头到文件
-U，-user-agent=AGENT 设定代理的名称为 AGENT而不是 Wget/VERSION.
-no-http-keep-alive 关闭 HTTP活动链接 (永远链接).
-cookies=off 不使用 cookies.
-load-cookies=FILE 在开始会话前从文件 FILE中加载cookie
-save-cookies=FILE 在会话结束后将 cookies保存到 FILE文件中

#FTP 选项
-nr，-dont-remove-listing 不移走 `.listing'</span>文件
-g，-glob<span class="token operator">=</span>on/off 打开或关闭文件名的 globbing机制
-passive-ftp 使用被动传输模式 <span class="token punctuation">(</span>缺省值<span class="token punctuation">)</span>.
-active-ftp 使用主动传输模式
-retr-symlinks 在递归的时候，将链接指向文件<span class="token punctuation">(</span>而不是目录<span class="token punctuation">)</span>

<span class="token comment">#递归下载</span>
-r，-recursive 递归下载－－慎用<span class="token operator">!</span>
-l，-level<span class="token operator">=</span>NUMBER 最大递归深度 <span class="token punctuation">(</span>inf 或 <span class="token number">0</span> 代表无穷<span class="token punctuation">)</span>.
-delete-after 在现在完毕后局部删除文件
-k，-convert-links 转换非相对链接为相对链接
-K，-backup-converted 在转换文件X之前，将之备份为 X.orig
-m，-mirror 等价于 <span class="token parameter variable">-r</span> <span class="token parameter variable">-N</span> <span class="token parameter variable">-l</span> inf -nr.
-p，-page-requisites 下载显示HTML文件的所有图片

<span class="token comment">#递归下载中的包含和不包含(accept/reject)</span>
-A，-accept<span class="token operator">=</span>LIST 分号分隔的被接受扩展名的列表
-R，-reject<span class="token operator">=</span>LIST 分号分隔的不被接受的扩展名的列表
-D，-domains<span class="token operator">=</span>LIST 分号分隔的被接受域的列表
-exclude-domains<span class="token operator">=</span>LIST 分号分隔的不被接受的域的列表
-follow-ftp 跟踪HTML文档中的FTP链接
-follow-tags<span class="token operator">=</span>LIST 分号分隔的被跟踪的HTML标签的列表
-G，-ignore-tags<span class="token operator">=</span>LIST 分号分隔的被忽略的HTML标签的列表
-H，-span-hosts 当递归时转到外部主机
-L，-relative 仅仅跟踪相对链接
-I，-include-directories<span class="token operator">=</span>LIST 允许目录的列表
-X，-exclude-directories<span class="token operator">=</span>LIST 不被包含目录的列表
-np，-no-parent 不要追溯到父目录</code></pre>

<p>常用选项：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-q</span> 静默模式
<span class="token parameter variable">-c</span> 断点续传
<span class="token parameter variable">-P</span> /path 保存在指定目录
<span class="token parameter variable">-O</span> filename 保存为指定文件名，filename 为 - 时，发送至标准输出
--limit-rate<span class="token operator">=</span> 指定传输速率，单位K，M等</code></pre>

<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><p>curl 是基于 URL 语法在命令行方式下工作的文件传输工具，它支持 FTP，FTPS，HTTP，HTTPS，GOPHER，TELNET，DICT，FILE 及 LDAP 等协议。curl 支持 HTTPS 认证，并且支持 HTTP 的 POST、PUT 等方法，FTP 上传，kerberos 认证，HTTP 上传，代理服务器，cookies，用户名/密码认证，下载文件断点续传，上载文件断点续传，http 代理服务器管道（ proxy tunneling），还支持 IPv6，socks5 代理服务器，通过 http 代理服务器上传文件到 FTP 服务器等，功能十分强大</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>URL<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">-A/--user-agent <span class="token operator">&lt;</span>string<span class="token operator">></span> 设置用户代理发送给服务器
-e/--referer <span class="token operator">&lt;</span>URL<span class="token operator">></span> 来源网址
<span class="token parameter variable">--cacert</span> <span class="token operator">&lt;</span>file<span class="token operator">></span> CA证书 <span class="token punctuation">(</span>SSL<span class="token punctuation">)</span>
-k/--insecure 允许忽略证书进行 SSL 连接
<span class="token parameter variable">--compressed</span> 要求返回是压缩的格式
-H/--header "key:value” 自定义首部字段传递给服务器
<span class="token parameter variable">-i</span> 显示页面内容，包括报文首部信息
-I/--head 只显示响应报文首部信息
-D/--dump-header <span class="token operator">&lt;</span>file<span class="token operator">></span>将url的header信息存放在指定文件中
<span class="token parameter variable">--basic</span> 使用HTTP基本认证
-u/--user <span class="token operator">&lt;</span>user<span class="token punctuation">[</span>:password<span class="token punctuation">]</span><span class="token operator">></span>设置服务器的用户和密码
<span class="token parameter variable">-L</span> 如果有3xx响应码，重新发请求到新位置
<span class="token parameter variable">-O</span> 使用URL中默认的文件名保存文件到本地
<span class="token parameter variable">-o</span> <span class="token operator">&lt;</span>file<span class="token operator">></span> 将网络文件保存为指定的文件中
--limit-rate <span class="token operator">&lt;</span>rate<span class="token operator">></span> 设置传输速度
-0/--http1.0 数字0，使用HTTP <span class="token number">1.0</span>
-v/--verbose 更详细
<span class="token parameter variable">-C</span> 选项可对文件使用断点续传功能
-c/--cookie-jar <span class="token operator">&lt;</span>file name<span class="token operator">></span> 将url中cookie存放在指定文件中
-x/--proxy <span class="token operator">&lt;</span>proxyhost<span class="token punctuation">[</span>:port<span class="token punctuation">]</span><span class="token operator">></span> 指定代理服务器地址
-X/--request <span class="token operator">&lt;</span>command<span class="token operator">></span> 向服务器发送指定请求方法
-U/--proxy-user <span class="token operator">&lt;</span>user:password<span class="token operator">></span> 代理服务器用户和密码
<span class="token parameter variable">-T</span> 选项可将指定的本地文件上传到FTP服务器上
--data/-d 方式指定使用POST方式传递数据
<span class="token parameter variable">-s</span> <span class="token parameter variable">--silent</span> Silent mode
<span class="token parameter variable">-b</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>data 从服务器响应set-cookie得到值，返回给服务器
<span class="token parameter variable">-w</span> <span class="token operator">&lt;</span>format<span class="token operator">></span> 显示相应的指定的报文信息，如：%<span class="token punctuation">&#123;</span>http_code<span class="token punctuation">&#125;</span>，%<span class="token punctuation">&#123;</span>remote_ip<span class="token punctuation">&#125;</span>等
-m, --max-time <span class="token operator">&lt;</span>time<span class="token operator">></span> 允许最大传输时间</code></pre>

<h3 id="httpie"><a href="#httpie" class="headerlink" title="httpie"></a>httpie</h3><p>httpie 工具是现代的 HTTP 命令行客户端，它能通过命令行界面与 Web 服务进行交互。它提供一个简单的 http 命令，允许使用简单而自然的语法发送任意的 HTTP 请求，并会显示彩色的输出</p>
<p>httpie 能用于测试、调试及与 HTTP 服务器交互</p>
<ul>
<li>具表达力的和直观语法</li>
<li>格式化的及彩色化的终端输出</li>
<li>内置 JSON 支持</li>
<li>表单和文件上传</li>
<li>HTTPS、代理和认证任意请求数据</li>
<li>自定义头部</li>
<li>持久化会话</li>
<li>类似 wget 的下载</li>
<li>支持 Python 2.7 和 3.x</li>
</ul>
<p>官方网站：<a target="_blank" rel="noopener" href="https://httpie.org/">https://httpie.org</a><br>安装：基于 EPEL（CentOS 8 目前还不支持）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#yum install httpie -y</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 显示信息（包含响应头200）</span>
http www.magedu.com

<span class="token comment"># 显示详细的请求（包含请求和返回头200）</span>
http <span class="token parameter variable">-v</span> www.magedu.com

<span class="token comment"># 只显示Header</span>
http <span class="token parameter variable">-h</span> www.magedu.com
http <span class="token parameter variable">--head</span> www.magedu.com
http <span class="token parameter variable">--header</span> www.magedu.com
http <span class="token parameter variable">--headers</span> www.magedu.com

<span class="token comment"># 只显示Body</span>
http <span class="token parameter variable">-b</span> www.magedu.com
http <span class="token parameter variable">--body</span> magedu.com

<span class="token comment"># 下载文件</span>
http <span class="token parameter variable">-d</span> www.magedu.com

<span class="token comment"># 模拟提交表单</span>
http <span class="token parameter variable">-f</span> POST www.magedu.com <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">'wang'</span>

<span class="token comment"># 请求删除的方法</span>
http DELETE www.magedu.com

<span class="token comment"># 传递JSON数据请求(默认就是JSON数据请求)</span>
http PUT www.magedu.com <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">'wang'</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">'magedu'</span>

<span class="token comment"># 如果JSON数据存在不是字符串则用:=分隔，例如</span>
http PUT www.magedu.com <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">'wang'</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token string">'magedu'</span> age:<span class="token operator">=</span><span class="token number">30</span> a:<span class="token operator">=</span>true streets:<span class="token operator">=</span><span class="token string">'["a", "b"]'</span>

<span class="token comment"># 模拟Form的Post请求, Content-Type: application/x-www-form-urlencoded;</span>
<span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
http <span class="token parameter variable">--form</span> POST www.magedu.com <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">'wang'</span>

<span class="token comment"># 模拟Form的上传, Content-Type: multipart/form-data</span>
http <span class="token parameter variable">-f</span> POST www.magedu.com/jobs <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token string">'wang'</span> file@~/test.pdf

<span class="token comment"># 修改请求头, 使用:分隔</span>
http www.magedu.com User-Agent:magedu-agent/1.0 <span class="token string">'Cookie:a=b;b=c'</span> Referer:http://www.google.com/

<span class="token comment"># 认证</span>
http <span class="token parameter variable">-a</span> username:password www.magedu.com
http <span class="token parameter variable">-A</span> basic <span class="token parameter variable">-a</span> username:password www.magedu.com

<span class="token comment"># 使用http代理</span>
http <span class="token parameter variable">--proxy</span><span class="token operator">=</span>http:http://172.16.0.100:8081 proxy.magedu.com
http <span class="token parameter variable">--proxy</span><span class="token operator">=</span>http:http://user:pass@172.16.0.100:8081 proxy.magedu.com
http <span class="token parameter variable">--proxy</span><span class="token operator">=</span>https:http://172.16.0.100:8118 proxy.magedu.com
http <span class="token parameter variable">--proxy</span><span class="token operator">=</span>https:http://user:pass@172.16.0.100:8118 proxy.magedu.com</code></pre>

<p>范例：查看信息及相应头</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http 192.168.8.8/test.html</span>
HTTP/1.1 <span class="token number">200</span> OK
Accept-Ranges: bytes
Connection: Keep-Alive
Content-Length: <span class="token number">30</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
Date: Thu, 07 Nov <span class="token number">2019</span> 09:09:34 GMT
ETag: <span class="token string">"1e-596be05bc9a34"</span>
Keep-Alive: <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token number">5</span>, <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">100</span>
Last-Modified: Thu, 07 Nov <span class="token number">2019</span> 09:09:27 GMT
Server: Apache/2.4.37 <span class="token punctuation">(</span>centos<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>strong<span class="token operator">></span>马哥教育<span class="token operator">&lt;</span>/strong<span class="token operator">></span></code></pre>

<p>范例：查看请示和响应头部及信息</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http -v 192.168.8.8/test.html</span>
GET /test.html HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: <span class="token number">192.168</span>.8.8
User-Agent: HTTPie/0.9.4

HTTP/1.1 <span class="token number">200</span> OK
Accept-Ranges: bytes
Connection: Keep-Alive
Content-Length: <span class="token number">30</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
Date: Thu, 07 Nov <span class="token number">2019</span> 09:09:39 GMT
ETag: <span class="token string">"1e-596be05bc9a34"</span>
Keep-Alive: <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token number">5</span>, <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token number">100</span>
Last-Modified: Thu, 07 Nov <span class="token number">2019</span> 09:09:27 GMT
Server: Apache/2.4.37 <span class="token punctuation">(</span>centos<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>strong<span class="token operator">></span>马哥教育<span class="token operator">&lt;</span>/strong<span class="token operator">></span></code></pre>

<p>范例：查看响应报文头部</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http HEAD http://www.magedu.com</span>
HTTP/1.1 <span class="token number">200</span> OK
Connection: keep-alive
Content-Encoding: <span class="token function">gzip</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
Date: Thu, 07 Nov <span class="token number">2019</span> 08:09:49 GMT
Link: <span class="token operator">&lt;</span>http://www.magedu.com/wp-json/<span class="token operator">></span><span class="token punctuation">;</span> <span class="token assign-left variable">rel</span><span class="token operator">=</span><span class="token string">"https://api.w.org/"</span>
Link: <span class="token operator">&lt;</span>http://www.magedu.com/<span class="token operator">></span><span class="token punctuation">;</span> <span class="token assign-left variable">rel</span><span class="token operator">=</span>shortlink
Server: Tengine
Vary: Accept-Encoding
Vary: Accept-Encoding, Cookie</code></pre>

<p>范例： 查看请求和响应报文头部</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http -p Hh http://www.magedu.com</span>
GET / HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: www.magedu.com
User-Agent: HTTPie/0.9.4

HTTP/1.1 <span class="token number">200</span> OK
Cache-Control: max-age<span class="token operator">=</span><span class="token number">3</span>, must-revalidate
Connection: keep-alive
Content-Encoding: <span class="token function">gzip</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
Date: Thu, 07 Nov <span class="token number">2019</span> 03:44:14 GMT
Server: Tengine
Transfer-Encoding: chunked
Vary: Accept-Encoding
Vary: Accept-Encoding, Cookie</code></pre>

<p>范例：指定请求头部的首部字段</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http -p H http://www.magedu.com User-Agent:wangtest</span>
Referer:http://www.baidu.com
GET / HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: www.magedu.com
Referer: http://www.baidu.com
User-Agent: wangtest</code></pre>

<p>范例：下载资源</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#方法1</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http http://www.magedu.com/wp-content/uploads/2018/12/2018122312035677.png > logo.png</span>
<span class="token comment">#方法2</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#file logo.png</span>
logo.png: PNG image data, <span class="token number">411</span> x <span class="token number">127</span>, <span class="token number">8</span>-bit/color RGBA, non-interlaced
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http --download http://www.magedu.com/wp-content/uploads/2018/12/2018122312035677.png</span>
HTTP/1.1 <span class="token number">200</span> OK
Accept-Ranges: bytes
Cache-Control: max-age<span class="token operator">=</span><span class="token number">604800</span>
Connection: keep-alive
Content-Length: <span class="token number">8983</span>
Content-Type: image/png
Date: Thu, 07 Nov <span class="token number">2019</span> 08:20:44 GMT
ETag: <span class="token string">"5c1f79ac-2317"</span>
Expires: Thu, <span class="token number">14</span> Nov <span class="token number">2019</span> 08:20:44 GMT
Last-Modified: Sun, <span class="token number">23</span> Dec <span class="token number">2018</span> <span class="token number">12</span>:03:56 GMT
Server: Tengine
Vary: Accept-Encoding

Downloading <span class="token number">8.77</span> kB to <span class="token string">"2018122312035677.png"</span>
Done. <span class="token number">8.77</span> kB <span class="token keyword">in</span> <span class="token number">0</span>.00091s <span class="token punctuation">(</span><span class="token number">9.46</span> MB/s<span class="token punctuation">)</span></code></pre>

<p>范例：用 POST 方法提交 json 格式的数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http http://www.magedu.com user=wang password=magedu</span></code></pre>

<p>范例：用 POST 方法，指交表单数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#http -f POST http://www.magedu.com user=wang password=magedu</span></code></pre>

<h3 id="压力测试工具"><a href="#压力测试工具" class="headerlink" title="压力测试工具"></a>压力测试工具</h3><p>ab 来自 httpd-tools 包</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ab <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> URL</code></pre>

<p>option：</p>
<ul>
<li>-n：总请求数</li>
<li>-c：模拟的并发数</li>
<li>-k：以持久连接模式测试</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/8.docker%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E5%BD%A2%E5%B7%A5%E5%85%B7Portainer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/8.docker%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E5%BD%A2%E5%B7%A5%E5%85%B7Portainer/" class="post-title-link" itemprop="url">docker可视化图形工具Portainer</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:28:41" itemprop="dateCreated datePublished" datetime="2021-01-08T11:28:41+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Portainer 是一个可视化的容器镜像的图形管理工具，利用 Portainer 可以轻松构建，管理和维护 Docker 环境。 而且完全免费，基于容器化的安装方式，方便高效部署。</p>
<p>官方站点: <a target="_blank" rel="noopener" href="https://www.portainer.io/">https://www.portainer.io/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/6.%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92%E4%B9%8BDocker%20Compose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/6.%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92%E4%B9%8BDocker%20Compose/" class="post-title-link" itemprop="url">单机编排之Docker Compose</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:28:28" itemprop="dateCreated datePublished" datetime="2021-01-08T11:28:28+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/7.docker%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/7.docker%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/" class="post-title-link" itemprop="url">docker资源限制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:28:28" itemprop="dateCreated datePublished" datetime="2021-01-08T11:28:28+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>默认情况下，容器没有资源的使用限制，docker 提供了控制容器使用资源的方法,可以限制容器使用多少内存或 CPU 等， 在 docker run 命令的运行时配置标志实现资源限制功能。</p>
<h2 id="容器的内存限制"><a href="#容器的内存限制" class="headerlink" title="容器的内存限制"></a>容器的内存限制</h2><p>为了运行效率，建议关闭交换内存，如果内存不够了，打报告采购就好了，而且 k8s 也禁止使用交换内存</p>
<p>在容器中使用 free 命令，看到的是宿主机的内存情况</p>
<table>
<thead>
<tr>
<th>内存相关配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-m | –mermory&#x3D;</td>
<td>容器可以使用的最大内存，硬限制，最小 4m，此项常用</td>
</tr>
<tr>
<td>–mermory-swap</td>
<td>交换内存相关的配置项，如果宿主机关闭了交换内存，建议忽略此项</td>
</tr>
</tbody></table>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 单位：b、k、m、g</span>
<span class="token comment"># 限制容器的内存不超过300m</span>
root@u3:~<span class="token comment"># docker container run -it -m 300m harbor.ljk.org/library/alpine:v1</span></code></pre>

<h2 id="容器的-CPU-限制"><a href="#容器的-CPU-限制" class="headerlink" title="容器的 CPU 限制"></a>容器的 CPU 限制</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/5.docker%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/5.docker%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">docker仓库管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:28:19" itemprop="dateCreated datePublished" datetime="2021-01-08T11:28:19+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>docker 仓库分为公有云仓库 和 私有云仓库</p>
<p>公有云仓库：</p>
<ul>
<li>官方</li>
<li>阿里云等第三方仓库，推荐</li>
</ul>
<p>私有云仓库：</p>
<ul>
<li>docker registory</li>
<li>docker harbor，推荐</li>
</ul>
<h2 id="阿里云-docker-仓库"><a href="#阿里云-docker-仓库" class="headerlink" title="阿里云 docker 仓库"></a>阿里云 docker 仓库</h2><ol>
<li>访问凭证</li>
<li>命名空间</li>
<li>镜像仓库</li>
</ol>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 浏览器的登录阿里云，创建命名空间107，镜像仓库可以创建也可以不创建，如果不创建，push的时候会自动创建</span>
<span class="token comment"># 2. 登录阿里云，交互式，密码存储在~/.docker/config.json</span>
<span class="token function">docker</span> login <span class="token parameter variable">--username</span><span class="token operator">=</span><span class="token number">1076956365</span>@qq.com registry.cn-beijing.aliyuncs.com
<span class="token comment"># 3. 给镜像打标签，注意格式</span>
<span class="token function">docker</span> tag nginx:1.22.1 registry.cn-beijing.aliyuncs.com/lujk/nginx:1.22.1
<span class="token comment"># 4. 上传到阿里云的docker镜像仓库</span>
<span class="token function">docker</span> push registry.cn-beijing.aliyuncs.com/lujk/nginx:1.22.1
<span class="token comment"># 5. 刷新网站页面，如果没有看到镜像，可能是区域设置不对</span>
<span class="token comment"># 6. 其他机器下载镜像</span>
<span class="token function">docker</span> pull registry.cn-beijing.aliyuncs.com/lujk/nginx:1.22.1</code></pre>

<h2 id="私有云单机仓库-Docker-Registry"><a href="#私有云单机仓库-Docker-Registry" class="headerlink" title="私有云单机仓库 Docker Registry"></a>私有云单机仓库 Docker Registry</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/registry/">https://docs.docker.com/registry/</a></p>
<p>部署文档：<a target="_blank" rel="noopener" href="https://github.com/docker/docs/blob/main/registry/deploying.md">https://github.com/docker/docs/blob/main/registry/deploying.md</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41605937/article/details/122367707">https://blog.csdn.net/weixin_41605937/article/details/122367707</a></p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="1-生成证书"><a href="#1-生成证书" class="headerlink" title="1. 生成证书"></a>1. 生成证书</h4><p>一路回车就可以</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-x509</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-out</span> ./ssl/certs/reg.cntv.local.crt <span class="token parameter variable">-keyout</span> ./ssl/private/reg.cntv.local.key</code></pre>

<h4 id="2-创建授权的-registry-用户和密码"><a href="#2-创建授权的-registry-用户和密码" class="headerlink" title="2.创建授权的 registry 用户和密码"></a>2.创建授权的 registry 用户和密码</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 创建授权用户密码使用目录</span>
root@lujinkai-pc:~$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker/auth

<span class="token comment"># 2. 创建registry用户，用于上传和下载镜像</span>
<span class="token punctuation">[</span>root@484288 ~<span class="token punctuation">]</span>$ htpasswd <span class="token parameter variable">-Bbn</span> ops <span class="token number">123456</span>. <span class="token operator">></span> /etc/docker/auth/registry

<span class="token punctuation">[</span>root@484288 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> /etc/docker/auth/registry
ops:<span class="token variable">$2y</span><span class="token variable">$05</span><span class="token variable">$zvMWW6tjQriMEKNinHyL</span>.uPsvSYfR9iYWROMAvwrA7AfRy1K0SUTC</code></pre>

<p>创建用户还可以使用如下命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">docker</span> run <span class="token punctuation">\</span>
  <span class="token parameter variable">--entrypoint</span> htpasswd <span class="token punctuation">\</span>
  registry:2 <span class="token parameter variable">-Bbn</span> ops <span class="token number">123456</span>. <span class="token operator">></span> /etc/docker/auth/registry</code></pre>

<h4 id="3-启动容器"><a href="#3-启动容器" class="headerlink" title="3. 启动容器"></a>3. 启动容器</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 指定443端口</span>
$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
      <span class="token parameter variable">--name</span> registry <span class="token punctuation">\</span>
      <span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_ADDR</span><span class="token operator">=</span><span class="token number">0.0</span>.0.0:443 <span class="token punctuation">\</span>
      <span class="token parameter variable">-p</span> <span class="token number">443</span>:443 <span class="token punctuation">\</span>
      registry:2

<span class="token comment"># 或者：默认的5000端口</span>
$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span>   <span class="token punctuation">\</span>
    <span class="token parameter variable">-p</span> <span class="token number">5000</span>:5000   <span class="token punctuation">\</span>
    <span class="token parameter variable">--restart</span><span class="token operator">=</span>always   <span class="token punctuation">\</span>
    <span class="token parameter variable">--name</span> registry   <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>"</span>/ssl:/ssl   <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="token operator">=</span>/ssl/certs/reg.cntv.local.crt   <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_HTTP_TLS_KEY</span><span class="token operator">=</span>/ssl/private/reg.cntv.local.key   <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> /etc/docker/auth:/auth <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm"</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="token operator">=</span>/auth/registry <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">"REGISTRY_AUTH=htpasswd"</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> /data/registry:/var/lib/registry <span class="token punctuation">\</span>
    registry:2</code></pre>

<p>api：</p>
<pre class="language-none"><code class="language-none">Path:        &quot;&#x2F;v2&#x2F;&quot;,
Path:        &quot;&#x2F;v2&#x2F;&#123;name:&quot; + reference.NameRegexp.String() + &quot;&#125;&#x2F;tags&#x2F;list&quot;,
Path:        &quot;&#x2F;v2&#x2F;&#123;name:&quot; + reference.NameRegexp.String() + &quot;&#125;&#x2F;manifests&#x2F;&#123;reference:&quot; + reference.TagRegexp.String() + &quot;|&quot; + digest.DigestRegexp.String() + &quot;&#125;&quot;,
Path:        &quot;&#x2F;v2&#x2F;&#123;name:&quot; + reference.NameRegexp.String() + &quot;&#125;&#x2F;blobs&#x2F;&#123;digest:&quot; + digest.DigestRegexp.String() + &quot;&#125;&quot;,
Path:        &quot;&#x2F;v2&#x2F;&#123;name:&quot; + reference.NameRegexp.String() + &quot;&#125;&#x2F;blobs&#x2F;uploads&#x2F;&quot;,
Path:        &quot;&#x2F;v2&#x2F;&#123;name:&quot; + reference.NameRegexp.String() + &quot;&#125;&#x2F;blobs&#x2F;uploads&#x2F;&#123;uuid:[a-zA-Z0-9-_.&#x3D;]+&#125;&quot;,
Path:        &quot;&#x2F;v2&#x2F;_catalog&quot;,</code></pre>

<p>查询、删除镜像：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查询镜像</span>
<span class="token function">curl</span>  <span class="token operator">&lt;</span>仓库地址<span class="token operator">></span>/v2/_catalog

<span class="token comment">#查询镜像tag(版本)</span>
<span class="token function">curl</span>  <span class="token operator">&lt;</span>仓库地址<span class="token operator">></span>/v2/<span class="token operator">&lt;</span>镜像名<span class="token operator">></span>/tags/list

<span class="token comment">#删除镜像API</span>
<span class="token function">curl</span> <span class="token parameter variable">-I</span> <span class="token parameter variable">-X</span> DELETE <span class="token string">"&lt;仓库地址>/v2/&lt;镜像名>/manifests/&lt;镜像digest_hash>"</span>

<span class="token comment">#获取镜像digest_hash</span>
<span class="token function">curl</span>  <span class="token operator">&lt;</span>仓库地址<span class="token operator">></span>/v2/<span class="token operator">&lt;</span>镜像名<span class="token operator">></span>/manifests/<span class="token operator">&lt;</span>tag<span class="token operator">></span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--header</span> <span class="token string">"Accept: application/vnd.docker.distribution.manifest.v2+json"</span></code></pre>

<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><h4 id="1-添加-hosts"><a href="#1-添加-hosts" class="headerlink" title="1. 添加 hosts"></a>1. 添加 hosts</h4><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /etc/hosts
<span class="token punctuation">..</span>.
<span class="token number">192.168</span>.117.138 reg.cntv.local</code></pre>

<h4 id="2-修改-daemon-json-并重启-docker"><a href="#2-修改-daemon-json-并重启-docker" class="headerlink" title="2. 修改 daemon.json 并重启 docker"></a>2. 修改 daemon.json 并重启 docker</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将https://reg.cntv.local添加到insecure-registries</span>
$ <span class="token function">cat</span> /etc/docker/daemon.json
<span class="token punctuation">&#123;</span>
  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://3417nt4m.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
  <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://reg.cntv.local:5000"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>注意：修改 daemon.json 后需要重启 docker.service</p>
<h4 id="3-登陆"><a href="#3-登陆" class="headerlink" title="3. 登陆"></a>3. 登陆</h4><pre class="language-none"><code class="language-none">docker login -u ops -p 123456. reg.cntv.local:5000</code></pre>

<h4 id="4-上传-amp-下载"><a href="#4-上传-amp-下载" class="headerlink" title="4. 上传&amp;下载"></a>4. 上传&amp;下载</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 上传</span>
$ <span class="token function">docker</span> image tag alpine:3.17 reg.cntv.local:5000/alpine:3.17
$ <span class="token function">docker</span> push reg.cntv.local:5000/alpine:3.17

<span class="token comment"># 下载</span>
$ <span class="token function">docker</span> pull reg.cntv.local:5000/alpine:3.17</code></pre>

<h2 id="Docker-之分布式仓库-Harbor"><a href="#Docker-之分布式仓库-Harbor" class="headerlink" title="Docker 之分布式仓库 Harbor"></a>Docker 之分布式仓库 Harbor</h2><p><strong>harbor 功能介绍：</strong></p>
<ul>
<li>基于角色的访问控制</li>
<li>镜像复制</li>
<li>图形化用户界面</li>
<li>审计管理</li>
<li>国际化</li>
<li>resful api</li>
<li>部署简单</li>
</ul>
<p><strong>harbor 组成：</strong></p>
<p>harbor 是由很多容器组成实现完整功能</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1606200537850.png"></p>
<ul>
<li>proxy：对应启动组件 nginx。它是一个 nginx 反向代理，代理 notary client（镜像认证）、docker client（镜像上传下载等）和浏览器的访问请求（core service）给后端的各服务</li>
<li>UI（Core Service）：对应启动组件 harbor-ui。底层数据存储使用 mysql 数据库，主要提供了四个子功能：<ul>
<li>UI：一个 web 管理页面 ui</li>
<li>API：Harbor 暴露的 API 服务</li>
<li>Auth：用户认证服务，decode 后的 token 中的用户信息在这里进行认证；auth 后端可以接 db、ldap、uaa 三种认证实现</li>
<li>Token 服务（上图中未体现）：负责根据用户在每个 project 中的 role 来为每一个 docker push&#x2F;pull 命令发布一个 token，如果从 docker client 发送给 registry 的请求没有带 token，registry 会重定向请求到 token 服务创建 token</li>
</ul>
</li>
<li>registry：对应启动组件 registry。负责存储镜像文件，和处理镜像的 pull&#x2F;push 命令。Harbor 对镜像进行强制的访问控制，Registry 会将客户端的每个 pull、push 请求转发到 token 服务来获取有效的 token</li>
<li>admin service：对应启动组件 harbor-adminserver。是系统的配置管理中心附带检查存储用量，ui 和 jobserver 启动时候需要加载 adminserver 的配置</li>
<li>job service：对应启动组件 harbor-jobservice。负责镜像复制工作的，他和 registry 通信，从一个 registry pull 镜像然后 push 到另一个 registry，并记录 job_log</li>
<li>log collector：对应启动组件 harbor-log。日志汇总组件，通过 docker 的 log-driver 把日志汇总到一起</li>
<li>db：对应启动组件 harbor-db，负责存储 project、 user、 role、replication、image_scan、access 等的 metadata 数据</li>
</ul>
<h3 id="配置-harbor-仓库"><a href="#配置-harbor-仓库" class="headerlink" title="配置 harbor 仓库"></a>配置 harbor 仓库</h3><p><img data-src="//img.to2b.cn/blog/ljk/1606219992986.png"></p>
<p>两台 harbor 服务器 10.0.0.118 和 10.0.0.119 均按照以下步骤配置：</p>
<ol>
<li>安装 docker</li>
<li>安装 docker compose，docker compose 必须先于 harbor 安装，否则会报错</li>
<li>下载 Harbor 安装包并解压缩</li>
<li>编辑配置文件 harbor.yml，旧版本是 harbor.cfg</li>
<li>运行 harbor 安装脚本</li>
<li>实现开机自动启动 harbor</li>
<li>登录 harbor 主机网站</li>
<li>建立项目</li>
<li>修改 harbor 配置</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 安装docker</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token punctuation">\</span>
    apt-transport-https <span class="token punctuation">\</span>
    ca-certificates <span class="token punctuation">\</span>
    <span class="token function">curl</span> <span class="token punctuation">\</span>
    gnupg-agent <span class="token punctuation">\</span>
    software-properties-common
$ <span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
$ <span class="token function">sudo</span> add-apt-repository <span class="token punctuation">\</span>
    <span class="token string">"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \
    <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> \
    stable"</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce

<span class="token comment"># 以上是直接安装最新版本，推荐安装时指定版本</span>
$ <span class="token function">apt-cache</span> madison docker-ce
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce<span class="token operator">=</span><span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">></span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 2. 安装docker compose</span>
root@u1:~<span class="token comment"># apt -y install python3-pip	# 为了方便，直接安装pip</span>
root@u1:~<span class="token comment"># pip3 install docker-compose</span>
root@u1:~<span class="token comment"># docker-compose --version</span>
<span class="token function">docker-compose</span> version <span class="token number">1.27</span>.4, build unknown</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 3. 下载Harbor安装包并解压缩</span>
<span class="token comment"># 可以下载在线安装包或者完整的离线安装包，推荐下载离线包</span>
<span class="token comment"># 下载网址：https://github.com/goharbor/harbor/releases</span>
<span class="token comment"># 推荐使用迅雷下载：harbor-offline-installer-v1.10.6.tgz</span>
root@u1:/usr/local/src<span class="token comment"># tar zxvf harbor-offline-installer-v1.10.6.tgz</span>
root@u1:/usr/local/src<span class="token comment"># cd harbor/</span>
root@u1:/usr/local/src/harbor<span class="token comment"># ll</span>
total <span class="token number">700264</span>
drwxr-xr-x <span class="token number">2</span> root root      <span class="token number">4096</span> Nov <span class="token number">24</span> <span class="token number">13</span>:29 ./
drwxr-xr-x <span class="token number">3</span> root root      <span class="token number">4096</span> Nov <span class="token number">24</span> <span class="token number">13</span>:29 <span class="token punctuation">..</span>/
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">3398</span> Nov <span class="token number">17</span> 03:58 common.sh
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">717021676</span> Nov <span class="token number">17</span> 03:59 harbor.v1.10.6.tar.gz
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">5882</span> Nov <span class="token number">17</span> 03:58 harbor.yml
-rwxr-xr-x <span class="token number">1</span> root root      <span class="token number">2284</span> Nov <span class="token number">17</span> 03:58 install.sh*
-rw-r--r-- <span class="token number">1</span> root root     <span class="token number">11347</span> Nov <span class="token number">17</span> 03:58 LICENSE
-rwxr-xr-x <span class="token number">1</span> root root      <span class="token number">1749</span> Nov <span class="token number">17</span> 03:58 prepare*</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 4. 编辑配置文件 harbor.yml</span>
root@u1:/usr/local/src/harbor<span class="token comment"># vim harbor.yml</span>
<span class="token comment">#只需要修改下面两行</span>
hostname: <span class="token number">10.0</span>.0.118 <span class="token comment"># 修改此行,指向当前主机IP 或 FQDN</span>
harbor_admin_password: <span class="token number">123456</span> <span class="token comment"># 修改此行指定harbor登录用户admin的密码</span>

<span class="token comment"># 不需要https，注释以下内容</span>
<span class="token comment"># https:</span>
<span class="token comment">#   # https port for harbor, default is 443</span>
<span class="token comment">#   port: 443</span>
<span class="token comment">#   # The path of cert and key files for nginx</span>
<span class="token comment">#   certificate: /your/certificate/path</span>
<span class="token comment">#   private_key: /your/private/key/path</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 5. 运行 harbor 安装脚本</span>
root@u1:/usr/local/src<span class="token comment"># mv harbor /usr/local/</span>
root@u1:/usr/local/src<span class="token comment"># cd /usr/local/harbor/</span>
root@u1:/usr/local/src<span class="token comment"># ./prepare</span>
<span class="token punctuation">..</span>.
root@u1:/usr/local/src<span class="token comment"># ./install.sh</span>
<span class="token punctuation">..</span>.</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 6. 实现开机自动启动 harbor</span>
root@u1:~<span class="token comment"># vim /lib/systemd/system/harbor.service</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Harbor
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service systemd-networkd.service systemd-resolved.service
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>docker.service
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>http://github.com/vmware/harbor

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/docker-compose <span class="token parameter variable">-f</span> usr/local/harbor/docker-compose.yml up
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/bin/docker-compose <span class="token parameter variable">-f</span> usr/local/harbor/docker-compose.yml down

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

root@u1:~<span class="token comment"># systemctl daemon-reload</span>
root@u1:~<span class="token comment"># systemctl enable --now harbor.service</span>
Created symlink /etc/systemd/system/multi-user.target.wants/harbor.service → /lib/systemd/system/harbor.service.</code></pre>

<ol start="7">
<li>登录 harbor 主机网站 <code>http://10.0.0.118</code></li>
</ol>
<p><img data-src="//img.to2b.cn/blog/ljk/1606227845071.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1606227877823.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 9. 修改harbor配置</span>
<span class="token comment"># 后期如果需要修改harbor配置</span>
<span class="token number">1</span>.修改 harbor.yml 文件
<span class="token number">2</span>.停止harbor: systemctl stop harbor.service
<span class="token number">3</span>.执行prepare
<span class="token number">4</span>.启动harbor：sysytemcrl start harbor.service</code></pre>

<h3 id="配置-docker-客户端"><a href="#配置-docker-客户端" class="headerlink" title="配置 docker 客户端"></a>配置 docker 客户端</h3><p>客户端 10.0.0.117</p>
<ol>
<li>安装 docker</li>
<li>登录 harbor</li>
<li>给本地镜像大标签并上传到 harbor</li>
<li>下载 harbor 的镜像</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 安装docker</span>
略<span class="token punctuation">..</span>.</code></pre>

<ol start="2">
<li>建立项目</li>
</ol>
<p><img data-src="//img.to2b.cn/blog/ljk/1606445045953.png"></p>
<p>项目可以设置为“公开”，这样不用登陆就可以 pull，但是要想 push 还是得登陆</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 3. 登录harbor.两种方法，命令行或者配置文件</span>
<span class="token comment"># 方法一：命令行</span>
root@u3:~<span class="token comment"># vim /usr/lib/systemd/system/docker.service</span>
<span class="token punctuation">..</span>.
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd <span class="token parameter variable">-H</span> fd:// <span class="token parameter variable">--containerd</span><span class="token operator">=</span>/run/containerd/containerd.sock --insecure-registry <span class="token number">10.0</span>.0.118 --insecure-registry <span class="token number">10.0</span>.0.119
<span class="token punctuation">..</span>.
<span class="token comment"># 方法二：配置文件,推荐</span>
root@u3:~<span class="token comment"># vim /etc/docker/daemon.json</span>
<span class="token punctuation">&#123;</span>
        <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://3417nt4m.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
        <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.118"</span>, <span class="token string">"10.0.0.119"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
root@u3:~<span class="token comment"># systemctl restart docker.service</span>
root@u3:~<span class="token comment"># docker login 10.0.0.118</span>
Username: admin
Password:
WARNING<span class="token operator">!</span> Your password will be stored unencrypted <span class="token keyword">in</span> /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/<span class="token comment">#credentials-store</span>

Login Succeeded</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 3. 给本地镜像大标签并上传到harbor</span>
<span class="token comment"># 修改 images 的名称，不修改成指定格式无法将镜像上传到 harbor 仓库</span>
<span class="token comment"># 格式：Harbor主机IP/项目名/image名字:版本</span>
root@u3:~<span class="token comment"># docker tag alpine:latest 10.0.0.118/library/alpine-base:3.12</span>
root@u3:~<span class="token comment"># docker push 10.0.0.118/library/alpine-base:3.12</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 4. 下载harbor的镜像</span>
<span class="token comment"># 另开一台机器，安装docker，daemon.json设置insecure-registries，就可以直接下载镜像</span>
root@u4:~<span class="token comment"># docker image pull 10.0.0.118/library/alpine-base:3.12</span></code></pre>

<h3 id="harbor-高可用"><a href="#harbor-高可用" class="headerlink" title="harbor 高可用"></a>harbor 高可用</h3><p><img data-src="//img.to2b.cn/blog/ljk/1607528920165.png"></p>
<p>实现 harbor 有两种方式：共享存储 和 镜像复制，这里只学习后者，可以通过 web 界面直接配置镜像复制</p>
<p>前面配置了两台 harbor 仓库，10.0.0.118 和 10.0.0.119，但是只使用了一台，这里使用另一台组成双向复制</p>
<p>注意：不是主从，而是双向复制，通过负载均衡器将请求分流</p>
<p>h1：10.0.0.118<br>h2：10.0.0.119</p>
<ol>
<li><p>确保 h1 和 h2 中有相同的项目</p>
</li>
<li><p>h1 和 h2 均新建仓库，目标分别为对方</p>
<p>复制模式选择 push-based</p>
</li>
<li><p>h1 和 h2 均新建复制，目标分别为对方</p>
</li>
<li><p>测试，分别在 h1 和 h2 上传（注意上传前先登录 harbor）然后删除，都能同步成功</p>
</li>
</ol>
<h3 id="harbor-配置-https"><a href="#harbor-配置-https" class="headerlink" title="harbor 配置 https"></a>harbor 配置 https</h3><p>harbor 默认使用 http，可以配置 https，不过我认为没有这个必要</p>
<p>在前面配置好 harbor 仓库的基础上，执行以下操作：</p>
<ol>
<li><p>配置服务端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@u1:~<span class="token comment"># mkdir -p /root/.rnd</span>
root@u1:~<span class="token comment"># mkdir -p /usr/local/harbor/certs</span>
root@u1:~<span class="token comment"># cd /usr/local/harbor/certs</span>
root@u1:/usr/local/harbor/certs<span class="token comment"># ls</span>
<span class="token comment"># 创建私有CA</span>
root@u1:/usr/local/harbor/certs<span class="token comment"># openssl req -newkey rsa:1024 -nodes -sha256 -keyout ca.key -x509 -subj "/CN=ca.ljk.org" -days 3650 -out ca.crt</span>
Generating a RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
writing new private key to <span class="token string">'ca.key'</span>
-----
root@u1:/usr/local/harbor/certs<span class="token comment"># ls</span>
ca.crt  ca.key
<span class="token comment"># 生成harbor主机的证书申请</span>
root@u1:/usr/local/harbor/certs<span class="token comment"># openssl req -newkey rsa:1024 -nodes -sha256 -subj "/CN=harbor.ljk.org" -keyout harbor.ljk.org.key -out harbor.ljk.org.csr</span>
Generating a RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
writing new private key to <span class="token string">'harbor.ljk.org.key'</span>
-----
root@u1:/usr/local/harbor/certs<span class="token comment"># ls</span>
ca.crt  ca.key  harbor.ljk.org.csr  harbor.ljk.org.key
<span class="token comment"># 给harbor主机颁发证书</span>
root@u1:/usr/local/harbor/certs<span class="token comment"># openssl x509 -req -in harbor.ljk.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out harbor.ljk.org.crt</span>
Signature ok
<span class="token assign-left variable">subject</span><span class="token operator">=</span>CN <span class="token operator">=</span> harbor.ljk.org
Getting CA Private Key
root@u1:/usr/local/harbor/certs<span class="token comment"># tree</span>
<span class="token builtin class-name">.</span>
├── ca.crt
├── ca.key
├── ca.srl
├── harbor.ljk.org.crt
├── harbor.ljk.org.csr
└── harbor.ljk.org.key

<span class="token number">0</span> directories, <span class="token number">6</span> files
root@u1:/usr/local/harbor/certs<span class="token comment"># vim ../harbor.yml</span>
hostname: harbor.ljk.org	<span class="token comment"># 此行需改为域名</span>
https:
  <span class="token comment"># https port for harbor, default is 443</span>
  port: <span class="token number">443</span>
  <span class="token comment"># The path of cert and key files for nginx</span>
  certificate: /usr/local/harbor/certs/harbor.ljk.org.crt
  private_key: /usr/local/harbor/certs/harbor.ljk.org.key
<span class="token punctuation">..</span>.
root@u1:/usr/local/harbor/certs<span class="token comment"># cd ..</span>
root@u1:/usr/local/harbor<span class="token comment"># systemctl stop harbor.service 	# 这一步要等挺久</span>
root@u1:/usr/local/harbor<span class="token comment"># ./prepare</span>
root@u1:/usr/local/harbor<span class="token comment"># ./install.sh</span>
root@u1:/usr/local/harbor<span class="token comment"># systemctl start harbor.service</span></code></pre>

<p>访问：<a target="_blank" rel="noopener" href="https://10.0.0.118/">https://10.0.0.118</a></p>
</li>
<li><p>配置客户端</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@u3:~<span class="token comment"># echo '10.0.0.118 harbor.ljk.org' >> /etc/hosts</span>

<span class="token comment"># 因为是自建证书，所以harbor规定，客户端也下载一份，位于/etc/docker/certs.d/harbor.ljk.org</span>
<span class="token comment"># 其实，只需要harbor.ljk.org.crt即可，这里为了方便，全部拷贝过来</span>
root@u3:~<span class="token comment"># scp lujinkai@harbor.ljk.org:/usr/local/harbor/certs/* /etc/docker/certs.d/harbor.ljk.org/</span>

<span class="token comment"># 登录成功</span>
root@u3:~<span class="token comment"># docker login harbor.ljk.org</span>

<span class="token comment"># 上传镜像</span>
root@u3:~<span class="token comment"># docker image push harbor.ljk.org/library/alpine:v1</span></code></pre></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/4.docker%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/4.docker%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">docker网络管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:28:10" itemprop="dateCreated datePublished" datetime="2021-01-08T11:28:10+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>docker 网络支持 5 种网络模式：none、bridge、host、container、network-net</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1606097620697.png"></p>
<p>创建新容器时，<code>docker run</code>命令可以指定网络模式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--network</span> <span class="token operator">&lt;</span>mode<span class="token operator">></span>

<span class="token comment"># mode：默认是bridge</span>
none
bridge
<span class="token function">host</span>
container:容器名或容器ID
自定义网络名称</code></pre>

<h2 id="bridge-模式"><a href="#bridge-模式" class="headerlink" title="bridge 模式"></a>bridge 模式</h2><p><img data-src="//img.to2b.cn/blog/ljk/1606098112832.png"></p>
<p>默认模式，容器连接到一个虚拟网桥与外界通信，通过 SNAT 访问外网，通过 DNAT 可以让容器被外部主机访问，所以此模式也称为 NAT 模式</p>
<p>此模式会启动宿主机的 ip_forward 功能</p>
<p>bridge 模式特点：</p>
<ul>
<li>网络资源隔离：不同主机的容器之间无法直接通信</li>
<li>因为 NAT 转换，所以性能较低</li>
<li>端口管理繁琐，每个容器必须手动指定唯一的端口，容易产生端口冲突</li>
</ul>
<p>修改默认的 bridge 模式网络配置：</p>
<p>方法一：修改 docker.service</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker0默认ip为172.17.0.1/16，修改为10.100.0.1/24</span>
root@Z510:~<span class="token comment"># vim /usr/lib/systemd/system/docker.service</span>
<span class="token punctuation">..</span>.
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd <span class="token parameter variable">-H</span> fd:// <span class="token parameter variable">--containerd</span><span class="token operator">=</span>/run/containerd/containerd.sock <span class="token parameter variable">--bip</span><span class="token operator">=</span><span class="token number">10.100</span>.0.1/24
<span class="token punctuation">..</span>.</code></pre>

<p>方法二：<a target="_blank" rel="noopener" href="https://blog.whsir.com/post-5195.html">修改 daemon.json</a>，推荐这种方法</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@Z510:~<span class="token comment"># vim /etc/docker/daemon.json</span>
<span class="token comment"># hosts 指定docker守护进程侦听的地址，默认/var/run/docker.sock</span>
<span class="token string">"hosts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"tcp://0.0.0.0:2375"</span>, <span class="token string">"fd://"</span><span class="token punctuation">]</span>,
<span class="token string">"bip"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.100.100/24"</span>,	<span class="token comment"># docker0网卡的IP</span>
<span class="token string">"fixed-cidr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.100.128/26"</span>,	<span class="token comment"># 分配给容器的IP范围</span>
<span class="token string">"fixed-cidr-v6"</span><span class="token builtin class-name">:</span> <span class="token string">"2001:db8::/64"</span>,
<span class="token string">"mtu"</span><span class="token builtin class-name">:</span> <span class="token number">1500</span>,
<span class="token string">"default-gateway"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.100.200"</span>,	<span class="token comment"># 网关必须和bip在同一个网段</span>
<span class="token string">"default-gateway-v6"</span><span class="token builtin class-name">:</span> <span class="token string">"2001:db8:abcd::89"</span>,
<span class="token string">"dns"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">"1.1.1.1"</span>, <span class="token string">"8.8.8.8"</span><span class="token punctuation">]</span></code></pre>

<h2 id="host-模式"><a href="#host-模式" class="headerlink" title="host 模式"></a>host 模式</h2><p>容器和宿主机之间网络不隔离（其他资源隔离），容器不创建自己的虚拟网卡，而是使用宿主机的网卡和 IP 地址，因此在容器里面查看到的 IP 信息就是宿主机的信息，访问容器的时候直接使用宿主机 IP+容器端口即可</p>
<p>此模式由于直接使用宿主机的网络无需转换，网络性能最高，但是各容器内使用的端口不能相同，适用于运行容器端口比较固定的业务</p>
<p>host 网络模式特点：</p>
<ul>
<li>共享宿主机网络</li>
<li>网络性能无损耗</li>
<li>网络故障排除相对简单</li>
<li>各容器网络无隔离</li>
<li>网络资源无法分别统计</li>
<li>端口管理困难: 容易产生端口冲突</li>
<li>不支持端口映射</li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--network</span> <span class="token function">host</span> <span class="token parameter variable">--name</span> web1 nginx-centos7-base:1.6.1</code></pre>

<h2 id="none-模式"><a href="#none-模式" class="headerlink" title="none 模式"></a>none 模式</h2><p>容器不会进行任何网络配置，没有网卡、没有 IP 也没有路由，因此默认无法与外界通信，需要手动添加网卡配置 IP 等，所以极少使用</p>
<h2 id="containter-模式"><a href="#containter-模式" class="headerlink" title="containter 模式"></a>containter 模式</h2><p>指定一个已经存在的容器（选择与其通信频繁的容器），共享其网络，因此这个容器的端口不能和被指定容器的端口冲突</p>
<p>这种模式也较少使用</p>
<h2 id="自定义网络模式"><a href="#自定义网络模式" class="headerlink" title="自定义网络模式"></a>自定义网络模式</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker network --help</span>
Usage:	<span class="token function">docker</span> network COMMAND

Commands:
  connect     Connect a container to a network
  create      Create a network
  disconnect  Disconnect a container from a network
  inspect     Display detailed information on one or <span class="token function">more</span> networks
  <span class="token function">ls</span>          List networks
  prune       Remove all unused networks
  <span class="token function">rm</span>          Remove one or <span class="token function">more</span> networks</code></pre>

<p><font color=red>自定义网络内的容器可以直接通过容器进行相互的访问</font></p>
<p>可以使用自定义网络模式，实现不同集群应用的独立网络管理，而互补影响，而且在一个网络内，可以直接利用容器名称相互访问，非常便利</p>
<p>创建自定义网络：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker network create --help</span>
Usage:	<span class="token function">docker</span> network create <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> NETWORK

Options:
      <span class="token parameter variable">--attachable</span>           Enable manual container attachment
      --aux-address map      Auxiliary IPv4 or IPv6 addresses used by Network driver <span class="token punctuation">(</span>default map<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      --config-from string   The network from <span class="token function">which</span> copying the configuration
      --config-only          Create a configuration only network
  -d, <span class="token parameter variable">--driver</span> string        Driver to manage the Network <span class="token punctuation">(</span>default <span class="token string">"bridge"</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--gateway</span> strings      IPv4 or IPv6 Gateway <span class="token keyword">for</span> the master subnet
      <span class="token parameter variable">--ingress</span>              Create swarm routing-mesh network
      <span class="token parameter variable">--internal</span>             Restrict external access to the network
      --ip-range strings     Allocate container <span class="token function">ip</span> from a sub-range
      --ipam-driver string   IP Address Management Driver <span class="token punctuation">(</span>default <span class="token string">"default"</span><span class="token punctuation">)</span>
      --ipam-opt map         Set IPAM driver specific options <span class="token punctuation">(</span>default map<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--ipv6</span>                 Enable IPv6 networking
      <span class="token parameter variable">--label</span> list           Set metadata on a network
  -o, <span class="token parameter variable">--opt</span> map              Set driver specific options <span class="token punctuation">(</span>default map<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--scope</span> string         Control the network's scope
      <span class="token parameter variable">--subnet</span> strings       Subnet <span class="token keyword">in</span> CIDR <span class="token function">format</span> that represents a network segment</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> network create <span class="token parameter variable">-d</span> <span class="token operator">&lt;</span>mode<span class="token operator">></span> <span class="token parameter variable">--subnet</span> <span class="token operator">&lt;</span>CIDR<span class="token operator">></span> <span class="token parameter variable">--gateway</span> <span class="token operator">&lt;</span>网关<span class="token operator">></span> <span class="token operator">&lt;</span>自定义网络名称<span class="token operator">></span>

<span class="token comment">#注意mode不支持host和none</span></code></pre>

<h3 id="容器间通信"><a href="#容器间通信" class="headerlink" title="容器间通信"></a>容器间通信</h3><h2 id="禁止同宿主机的不同容器间通信"><a href="#禁止同宿主机的不同容器间通信" class="headerlink" title="禁止同宿主机的不同容器间通信"></a>禁止同宿主机的不同容器间通信</h2><p>docker.service</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd <span class="token parameter variable">-H</span> fd:// <span class="token parameter variable">--containerd</span><span class="token operator">=</span>/run/containerd/containerd.sock <span class="token parameter variable">--icc</span><span class="token operator">=</span>false</code></pre>

<p>daemon.json</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token string">"icc"</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span></code></pre>

<h2 id="容器名称互联"><a href="#容器名称互联" class="headerlink" title="容器名称互联"></a>容器名称互联</h2><p>前文中，自定义网络模式，可以实现容器名称互联，如果是默认模式，想要实现这个功能，需要在创建容器时，使用–link 选项</p>
<p>范例：实现 a1 和 a2 容器名称互联</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 创建容器a1</span>
root@Z510:~<span class="token comment"># docker container run -it --name a1  alpine:latest</span>
/ <span class="token comment"># hostname -i</span>
<span class="token number">172.17</span>.0.2
<span class="token comment"># 2. 创建容器a2</span>
root@Z510:~<span class="token comment"># docker container run -it --name a2 --link a1 alpine:latest</span>
/ <span class="token comment"># hostname -i</span>
<span class="token number">172.17</span>.0.3
/ <span class="token comment"># cat /etc/hosts</span>
<span class="token punctuation">..</span>.
<span class="token number">172.17</span>.0.2	a1 6079167b0ed1
<span class="token number">172.17</span>.0.3	b4e8abef6893
/ <span class="token comment"># ping a1								# a2可以ping通a1</span>
PING a1 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.191</span> ms
<span class="token punctuation">..</span>.
<span class="token comment"># 3. 修改容器a1的hosts</span>
/ <span class="token comment"># vi /etc/hosts</span>
<span class="token comment"># 添加如下行</span>
<span class="token number">172.17</span>.0.3      a2 b4e8abef6893
/ <span class="token comment"># ping a2								# a1可以ping通a2</span>
PING a2 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.3<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.135</span> ms
<span class="token punctuation">..</span>.</code></pre>

<h2 id="同宿主机之间不同网络的容器通信"><a href="#同宿主机之间不同网络的容器通信" class="headerlink" title="同宿主机之间不同网络的容器通信"></a>同宿主机之间不同网络的容器通信</h2><p>同一个宿主机，创建两个容器，一个使用自定义网络，一个使用默认的 bridge 模式，默认这两个容器是无法通信的，如果想要实现通信，有两种方式：修改 iptables 规则 和 通过<code>docker network connect</code>实现</p>
<p>本笔记只记录第二种方式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker network connect --help</span>
Usage:	<span class="token function">docker</span> network connect <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> NETWORK CONTAINER

Options:
      <span class="token parameter variable">--alias</span> strings           Add network-scoped <span class="token builtin class-name">alias</span> <span class="token keyword">for</span> the container
      --driver-opt strings      driver options <span class="token keyword">for</span> the network
      <span class="token parameter variable">--ip</span> string               IPv4 address <span class="token punctuation">(</span>e.g., <span class="token number">172.30</span>.100.104<span class="token punctuation">)</span>
      <span class="token parameter variable">--ip6</span> string              IPv6 address <span class="token punctuation">(</span>e.g., <span class="token number">2001</span>:db8::33<span class="token punctuation">)</span>
      <span class="token parameter variable">--link</span> list               Add <span class="token function">link</span> to another container
      --link-local-ip strings   Add a link-local address <span class="token keyword">for</span> the container</code></pre>

<p>范例：默认 docker0 中的容器为 test1，自定义网络 test-net 中的容器为 test2</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 创建网络和容器，过程略...</span>
<span class="token comment"># 2. 让默认网络中容器test1可以连通自定义网络test-net的容器test2</span>
<span class="token function">docker</span> network connect test-net test1
<span class="token function">ip</span> a	<span class="token comment"># 可以看到新增一个网卡，ip和test-net同网段</span>
<span class="token comment"># 3. 让自定义网络中容器test2可以连通默认网络的容器test1</span>
<span class="token function">docker</span> network connect bridge test2
<span class="token function">ip</span> a	<span class="token comment"># 可以看到新增一个网卡，ip和docker0同网段</span></code></pre>

<p>docker 容器创建后，必不可少的要和其它主机或容器进行网络通信</p>
<p>docker 的网络模式和 KVM 很相似</p>
<h3 id="docker-网络连接模式"><a href="#docker-网络连接模式" class="headerlink" title="docker 网络连接模式"></a>docker 网络连接模式</h3><h2 id="跨宿主机的容器之间网络通信"><a href="#跨宿主机的容器之间网络通信" class="headerlink" title="跨宿主机的容器之间网络通信"></a>跨宿主机的容器之间网络通信</h2><p>四种方法：</p>
<ol>
<li>桥接</li>
<li>NAT</li>
<li>Open vSwitch</li>
<li>weave</li>
</ol>
<p>生产中，以上四种都不用，而是通过 k8s 实现，如果真的用到了，再回来复习课件</p>
<h3 id="案例：docker-amp-LVS-实现网络架构高可用"><a href="#案例：docker-amp-LVS-实现网络架构高可用" class="headerlink" title="案例：docker &amp; LVS 实现网络架构高可用"></a>案例：docker &amp; LVS 实现网络架构高可用</h3><p>整体规划图：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1606136027542.png"></p>
<p>过程略..</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/Docker/3.docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/Docker/3.docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">docker数据管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-08 11:27:58" itemprop="dateCreated datePublished" datetime="2021-01-08T11:27:58+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img data-src="//img.to2b.cn/blog/ljk/1605928216982.png"></p>
<p>docker 镜像由多个只读层叠加而成，启动容器时，docker 会加载只读镜像层并在镜像栈顶部添加一个读写层</p>
<p>所有的修改都被复制到读写层，保存在 diff 目录，原理就是“写时复制（COW）”</p>
<p>但是一旦删除容器，读写层也会被删除，所以为了数据持久化，需要将容器中的数据保存到宿主机的制定目录，方法就是使用数据卷（Data Volume）：直接将宿主机目录挂载到容器的指定目录</p>
<h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><p>数据卷实际上就是宿主机上的目录或文件，可以直接 mount 到容器中使用</p>
<p>实际生产环境中，需要针对不同类型的服务，不同类型的数据存储要求做到相应的规划，最终保证服务的可扩展性、稳定性以及数据的安全性</p>
<p><strong>使用场景：</strong>数据库、日志、静态 web 页面、应用配置文件、多容器间目录或文件共享</p>
<p><strong>数据卷特点：</strong></p>
<ul>
<li>可以多容器之间共享</li>
<li>依赖宿主机目录，宿主机出问题，依赖的容器就会受影响，当宿主机较多时，不方便统一管理</li>
<li>镜像中的挂载点中包含数据，则在容器初始化时会将数据拷贝到数据卷（匿名和命名）中</li>
</ul>
<h3 id="数据卷的使用"><a href="#数据卷的使用" class="headerlink" title="数据卷的使用"></a>数据卷的使用</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> container run <span class="token parameter variable">-v</span> <span class="token punctuation">[</span>host-src:<span class="token punctuation">]</span>container-dest<span class="token punctuation">[</span>:<span class="token operator">&lt;</span>options<span class="token operator">></span><span class="token punctuation">]</span>

options：
ro：容器内对此数据卷只读，代码等文件适合设置为只读
rw：容器内对此数据卷读写，默认</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将宿主机目录挂载容器目录,两个目录都可自动创建</span>
<span class="token parameter variable">-v</span> <span class="token operator">&lt;</span>宿主机绝对路径的目录或文件<span class="token operator">></span>:<span class="token operator">&lt;</span>容器目录或文件<span class="token operator">></span><span class="token punctuation">[</span>:ro<span class="token punctuation">]</span>

<span class="token comment"># 匿名卷，宿主机自动生成/var/lib/docker/volumes/&lt;卷ID>/_data目录，并挂载至容器指定路径</span>
<span class="token parameter variable">-v</span> <span class="token operator">&lt;</span>容器内路径<span class="token operator">></span>

<span class="token comment"># 命名卷，宿主机自动生成/var/lib/docker/volumes/&lt;卷名>/_data目录，并挂载至容器指定路径</span>
<span class="token parameter variable">-v</span> <span class="token operator">&lt;</span>卷名<span class="token operator">></span>:<span class="token operator">&lt;</span>容器目录路径<span class="token operator">></span></code></pre>

<p><strong>管理卷命令：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker volume --help</span>
Usage:    <span class="token function">docker</span> volume COMMAND

Commands:
  create      Create a volume
  inspect     Display detailed information on one or <span class="token function">more</span> volumes
  <span class="token function">ls</span>          List volumes
  prune       Remove all unused <span class="token builtin class-name">local</span> volumes
  <span class="token function">rm</span>          Remove one or <span class="token function">more</span> volumes</code></pre>

<p><strong>关于匿名卷和命名卷：</strong></p>
<p>命名卷，因为有名字可以指定，在用过一次后,以后挂载容器的时候还可以使用，所以一般需要保存的数据使用命名卷保存。</p>
<p>匿名卷没有名字，随容器建立而建立，当容器消亡，匿名卷即使还存在，但也失去了意义，因此匿名卷只存放无关紧要的临时数据。</p>
<p>Dockerfile 中指定 VOLUME 为匿名数据卷，其目的只是为了将某个路径确定为卷。</p>
<p>数据卷默认可能会保存于 &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes，不过一般不需要、也不应该访问这个位置。</p>
<p>按照最佳实践的要求，不应该在容器存储层内进行数据写入操作，所有写入应该使用卷。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看数据卷的挂载关系</span>
<span class="token function">docker</span> inspect <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">"&#123;&#123;.Mounts&#125;&#125;"</span> <span class="token operator">&lt;</span>容器ID<span class="token operator">></span>
<span class="token comment"># 删除所有数据卷</span>
<span class="token function">docker</span> volume <span class="token function">rm</span> <span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> volume <span class="token function">ls</span> <span class="token parameter variable">-q</span><span class="token variable">`</span></span></code></pre>

<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>MySQL 使用数据卷：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/mysql/:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> mysql:5.7.30</code></pre>

<p>文件数据卷：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/bin/catalina.sh:/apps/tomcat/bin/catalina.sh:ro <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/testapp:/data/tomcat/webapps/testapp <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /data/logs:/apps/tomcat/logs <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 tomcat-web:app1</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-1 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.to2b.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.to2b.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.to2b.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.to2b.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
