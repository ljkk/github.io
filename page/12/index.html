<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.lujinkai.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.lujinkai.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="LJKのBlog">
<meta property="og:url" content="http://blog.lujinkai.cn/page/12/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="像方便面一样的男子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.lujinkai.cn/page/12/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/12/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LJKのBlog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/vim/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/vim/" class="post-title-link" itemprop="url">vim</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:40:56" itemprop="dateCreated datePublished" datetime="2020-12-11T22:40:56+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">文本处理</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>vim 有三种模式：</p>
<pre class="language-none"><code class="language-none">- 命令模式 或 普通模式
- 插入模式 或 编辑模式
- 扩展命令模式 或 命令行模式 或 末行模式</code></pre>

<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><h4 id="光标跳转"><a href="#光标跳转" class="headerlink" title="光标跳转"></a>光标跳转</h4><h5 id="字符间跳转"><a href="#字符间跳转" class="headerlink" title="字符间跳转"></a>字符间跳转</h5><pre class="language-bash" data-language="bash"><code class="language-bash">j      <span class="token comment"># 下</span>
k      <span class="token comment"># 上</span>
h      <span class="token comment"># 左</span>
l      <span class="token comment"># 右</span></code></pre>

<h5 id="单词间跳转"><a href="#单词间跳转" class="headerlink" title="单词间跳转"></a>单词间跳转</h5><pre class="language-bash" data-language="bash"><code class="language-bash">w      <span class="token comment"># 定位下一个单词</span></code></pre>

<h5 id="当前页跳转"><a href="#当前页跳转" class="headerlink" title="当前页跳转"></a>当前页跳转</h5><pre class="language-bash" data-language="bash"><code class="language-bash">H      <span class="token comment"># 定位页首</span>
M      <span class="token comment"># 定位中间行</span>
L      <span class="token comment"># 定位页末</span>
zt     <span class="token comment"># 滚动屏幕, 使当前行置顶 top</span>
zz     <span class="token comment"># 滚动屏幕, 使当前行置中</span>
zb     <span class="token comment"># 滚动屏幕, 使当前行置底 bottom</span></code></pre>

<h5 id="行首行尾跳转"><a href="#行首行尾跳转" class="headerlink" title="行首行尾跳转"></a>行首行尾跳转</h5><pre class="language-bash" data-language="bash"><code class="language-bash">^      <span class="token comment"># 定位行首第一个非空字符</span>
<span class="token number">0</span>      <span class="token comment"># 定位行尾</span>
$      <span class="token comment"># 定位行首</span></code></pre>

<h5 id="行间移动"><a href="#行间移动" class="headerlink" title="行间移动"></a>行间移动</h5><pre class="language-bash" data-language="bash"><code class="language-bash">gg     <span class="token comment"># 定位文首</span>
G      <span class="token comment"># 定位文末</span>
nG     <span class="token comment"># 定位指定行行首, 例如定位第5行: `5G`</span></code></pre>

<h5 id="句间和段落间移动"><a href="#句间和段落间移动" class="headerlink" title="句间和段落间移动"></a>句间和段落间移动</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">)</span>      <span class="token comment"># 下一句</span>
<span class="token punctuation">(</span>      <span class="token comment"># 上一句</span>
<span class="token punctuation">&#125;</span>      <span class="token comment"># 下一段</span>
<span class="token punctuation">&#123;</span>      <span class="token comment"># 上一段</span></code></pre>

<h5 id="翻屏操作"><a href="#翻屏操作" class="headerlink" title="翻屏操作"></a>翻屏操作</h5><pre class="language-bash" data-language="bash"><code class="language-bash">ctrl+f     <span class="token comment"># 向后翻一屏</span>
ctrl+d     <span class="token comment"># 向后翻半屏</span>
ctrl+b     <span class="token comment"># 向前翻一屏</span>
ctrl+u     <span class="token comment"># 向前翻半屏</span></code></pre>

<h4 id="字符编辑"><a href="#字符编辑" class="headerlink" title="字符编辑"></a>字符编辑</h4><pre class="language-bash" data-language="bash"><code class="language-bash">x     <span class="token comment"># 剪切光标处字符</span>
p     <span class="token comment"># 黏贴</span>
~     <span class="token comment"># 转换大小写, 然后光标向后移一位</span>
J     <span class="token comment"># 删除当前行前后的换行符</span></code></pre>

<h4 id="替换-replace"><a href="#替换-replace" class="headerlink" title="替换 replace"></a>替换 replace</h4><pre class="language-bash" data-language="bash"><code class="language-bash">r    <span class="token comment"># 替换光标所在处的一个字符, 按下r,然后再按替换后的字符</span>
R    <span class="token comment"># 切换成REPLACE模式, ESC回到命令模式, 按下r, 然后再输入替换后的内容</span></code></pre>

<h4 id="删除-delete"><a href="#删除-delete" class="headerlink" title="删除 delete"></a>删除 delete</h4><pre class="language-bash" data-language="bash"><code class="language-bash">d      <span class="token comment"># 删除, 可结合光标跳转, 实现范围删除</span>
d$     <span class="token comment"># 删除到行尾</span>
d0     <span class="token comment"># 删除到行首</span>
d^     <span class="token comment"># 删除到非空行首</span>
<span class="token function">dd</span>     <span class="token comment"># 删除当前行</span>
<span class="token comment">#dd    # 删除多行, 从当前行开始, 删除#行</span>
D      <span class="token comment"># 删除到行尾, 等同于d$</span></code></pre>

<h4 id="复制-yank"><a href="#复制-yank" class="headerlink" title="复制 yank"></a>复制 yank</h4><pre class="language-bash" data-language="bash"><code class="language-bash">y 	<span class="token comment"># 复制, 行为相似于d命令</span>
Y 	<span class="token comment"># 复制整行</span></code></pre>

<h4 id="粘贴-paste"><a href="#粘贴-paste" class="headerlink" title="粘贴 paste"></a>粘贴 paste</h4><pre class="language-bash" data-language="bash"><code class="language-bash">p 	<span class="token comment"># 整行, 则粘贴到下一行, 否则粘贴到光标后</span>
P 	<span class="token comment"># 整行, 则粘贴到上一行, 否则粘贴到光标后</span></code></pre>

<h4 id="命令模式-切换到-插入模式"><a href="#命令模式-切换到-插入模式" class="headerlink" title="命令模式 切换到 插入模式"></a>命令模式 切换到 插入模式</h4><p>以下快捷键, 进入插入模式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">i    <span class="token comment"># 不动</span>
I    <span class="token comment"># 定位行首</span>
a    <span class="token comment"># 向后移一位</span>
A    <span class="token comment"># 定位行尾</span>
o    <span class="token comment"># 定位下一行行首, 并开辟新行</span>
O    <span class="token comment"># 定位上一行行首, 并开辟新行</span></code></pre>

<h3 id="插入模式"><a href="#插入模式" class="headerlink" title="插入模式"></a>插入模式</h3><p>从光标前输入数据</p>
<h3 id="末行模式"><a href="#末行模式" class="headerlink" title="末行模式"></a>末行模式</h3><pre class="language-bash" data-language="bash"><code class="language-bash">:wq         <span class="token comment"># 存盘并退出</span>
:q<span class="token operator">!</span>         <span class="token comment"># 不存盘强制退出</span>
:r <span class="token function">file</span>     <span class="token comment"># 将file中的内容写入到当前文件, 例如\`:r a.log\`就把a.log中的内容写入到当前文件</span>
:w <span class="token function">file</span>     <span class="token comment"># 将当前文件内容写入file文件, 如果file已存在, 需要\`:w! file\`强制覆盖文件</span>
:<span class="token operator">!</span>command   <span class="token comment"># 不退出文件,执行命令</span>
:r<span class="token operator">!</span>command  <span class="token comment"># 将执行命令的输出写入到当前文件</span></code></pre>

<p>地址定界：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">n 		<span class="token comment"># 第几行, 例如2表示第2行</span>
n,n 	<span class="token comment"># 第#行到到第#行, 例如 2,5 表示2到5行</span>
n,+n 	<span class="token comment"># 第#行加#行, 例如 2,+3 表示2到5行</span>
<span class="token builtin class-name">.</span> 		<span class="token comment"># 当前行</span>
$ 		<span class="token comment">#　最后一行, .,$-1 表示当前行到倒数第二行</span>
% 		<span class="token comment"># 全文, 相当于1、$</span>

/pattern/ 				<span class="token comment"># 从当前行开始,直到第一次匹配到的行</span>
/pattern1/,/pattern2/ 	<span class="token comment"># 从pattern1第一次匹配到行, 到pattern2第一次匹配到的行</span>
n,/pattern/ 			<span class="token comment"># 从指定行开始, 到第一次pattern匹配到行</span>
/pattern/,$ 			<span class="token comment"># 从pattern第一次匹配到的行, 到最后一行</span></code></pre>

<p>地址定界后跟一个编辑命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">d 		  <span class="token comment"># 删除</span>
y 		  <span class="token comment"># 复制</span>
w <span class="token function">file</span> 	  <span class="token comment"># 将范围内的行另存到file文件中</span>
r <span class="token function">file</span> 	  <span class="token comment"># 在指定位置插入file文件中的所有内容</span></code></pre>

<p>查找并替换：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">s/要查找的内容/替换为的内容/修饰符		<span class="token comment"># 当前行查找替换</span>
%s/要查找的内容/替换为的内容/修饰符	<span class="token comment"># 全文查找替换</span>

要查找的内容可使用正则
替换为的内容不能使用正则，但可以使用<span class="token punctuation">\</span><span class="token number">1</span>, <span class="token punctuation">\</span><span class="token number">2</span>, <span class="token punctuation">..</span>.等后向引用符号；还可以使用“<span class="token operator">&amp;</span>”引用前面查找时查找到的整个内容
修饰符：
 i 	忽略大小写
 g 	全局替换
 gc 	全局替换, 每次替换前询问</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">u 		 <span class="token comment"># 撤销, 相当于windows中的ctrl+z</span>
<span class="token comment">#u 		 # 撤销多步</span>
U 		 <span class="token comment"># 撤销此行的所有操作</span>
ctrl+r 	 <span class="token comment"># 取消撤销, 相当于windows中的ctrl+y</span></code></pre>

<h4 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h4><p>示例：粘贴”wang”100 次</p>
<pre class="language-none"><code class="language-none">100iwang [ESC]</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">di"      <span class="token comment"># 光标在” “之间，则删除” “之间的内容</span>
yi<span class="token punctuation">(</span>      <span class="token comment"># 光标在()之间，则复制()之间的内容</span>
vi<span class="token punctuation">[</span>      <span class="token comment"># 光标在[]之间，则选中[]之间的内容</span>
dtx      <span class="token comment"># 删除字符直到遇见光标之后的第一个 x 字符</span>
ytx      <span class="token comment"># 复制字符直到遇见光标之后的第一个 x 字符</span></code></pre>

<h4 id="定制-vim-的工作特性"><a href="#定制-vim-的工作特性" class="headerlink" title="定制 vim 的工作特性"></a>定制 vim 的工作特性</h4><p>配置文件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">/etc/vimrc 	    <span class="token comment"># 全局</span>
~/.vimrc 		<span class="token comment"># 个人</span></code></pre>

<pre class="language-none"><code class="language-none">set nu
set nocompatible
set showmode
set showcmd
set encoding&#x3D;utf-8
set t_Co&#x3D;256

&quot; 缩进
set autoindent
set tabstop&#x3D;4

&quot; 外观
set wrap
set linebreak
set wrapmargin&#x3D;2
set showmatch
set hlsearch
set ignorecase
set smartcase

&quot; 编辑
set autoread
set wildmenu

&quot; 插件
autocmd FileType php set omnifunc&#x3D;phpcomplete#CompletePHP

set tags&#x3D;&#x2F;data&#x2F;wwwroot&#x2F;php-7.1.32&#x2F;tags</code></pre>

<h3 id="可视化模式"><a href="#可视化模式" class="headerlink" title="可视化模式"></a>可视化模式</h3><p>进入可视化模式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">v</span>           <span class="token comment"># 面向字符</span>
V           <span class="token comment"># 面向整行</span>
ctrl + <span class="token function">v</span>    <span class="token comment"># 面向块(列)</span></code></pre>

<p>选中的文字可以被删除、复制、变更、过滤、搜索、替换等</p>
<p>示例：在文件每一行行首插入 # 然后再删除</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">gg
ctrl + <span class="token function">v</span>
G
I
输入<span class="token comment">#</span>
ESC退出 插入<span class="token comment">#成功</span>
ctrl + <span class="token function">v</span>
d 删除成功
ESC退出</code></pre>

<h3 id="vim-总结"><a href="#vim-总结" class="headerlink" title="vim 总结"></a>vim 总结</h3><p><img data-src="//img.to2b.cn/blog/ljk/1596528940424.png"><br><img data-src="//img.to2b.cn/blog/ljk/1596528977017.png"><br><img data-src="//img.to2b.cn/blog/ljk/1596153844306.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/Socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/Socket/" class="post-title-link" itemprop="url">Socket</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:39:22" itemprop="dateCreated datePublished" datetime="2020-12-11T22:39:22+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>学习目标：</p>
<ul>
<li>了解<code>SOCKET</code>的基本操作如<code>accept/connect</code>、<code>send/recv</code>、<code>close</code>、<code>listen</code>、<code>bind</code></li>
<li>了解<code>SOCKET</code>的接收缓存区、发送缓存区、阻塞&#x2F;非阻塞、超时等概念</li>
</ul>
<p>在计算机通信领域, socket 被翻译为”<font color=red>套接字</font>“，是计算机之间进行通信的一种约定或者一种方式。</p>
<p>声明: 在 windows 和 linux 下 socket 是有差异的, 本文以 linux 下为准,忽略 windows.</p>
<h2 id="“套接字”有哪些类型呢？"><a href="#“套接字”有哪些类型呢？" class="headerlink" title="“套接字”有哪些类型呢？"></a>“套接字”有哪些类型呢？</h2><p>这个世界上有很多种套接字（<a target="_blank" rel="noopener" href="http://c.biancheng.net/socket/">socket</a>），比如 DARPA Internet 地址（Internet 套接字）、本地节点的路径名（Unix 套接字）、CCITT X.25 地址（X.25 套接字）等。但本教程只讲第一种套接字——Internet 套接字，它是最具代表性的，也是最经典最常用的。以后我们提及套接字，指的都是 Internet 套接字。</p>
<p>根据数据的传输方式，可以将 Internet 套接字分成两种类型。通过 socket() 函数创建连接时，必须告诉它使用哪种数据传输方式。</p>
<blockquote>
<p>​ Internet 套接字其实还有很多其它数据传输方式，但是我可不想吓到你，本教程只讲常用的两种</p>
</blockquote>
<h3 id="流格式套接字-SOCK-STREAM"><a href="#流格式套接字-SOCK-STREAM" class="headerlink" title="流格式套接字(SOCK_STREAM)"></a>流格式套接字(SOCK_STREAM)</h3><p>流格式套接字（Stream Sockets）也叫“面向连接的套接字”，在代码中使用 SOCK_STREAM 表示。</p>
<p>它使用 TCP 协议来确保数据的正确性，使用 IP 来控制数据如何从源头到达目的地，也就是常说的“路由”。</p>
<h3 id="数据报格式套接字-SOCK-DGAM"><a href="#数据报格式套接字-SOCK-DGAM" class="headerlink" title="数据报格式套接字(SOCK_DGAM)"></a>数据报格式套接字(SOCK_DGAM)</h3><p>数据报格式套接字（Datagram Sockets）也叫“无连接的套接字”，在代码中使用 SOCK_DGRAM 表示。</p>
<p>数据报套接字也使用 IP 协议作路由，但是它不使用 TCP 协议，而是使用 UDP 协议。</p>
<h2 id="OSI-网络七层模型"><a href="#OSI-网络七层模型" class="headerlink" title="OSI 网络七层模型"></a>OSI 网络七层模型</h2><p>OSI 模型把网络通信的工作分为 7 层，从下到上分别是物理层、数据链路层、网络层、传输层、会话层、表示层和应用层。</p>
<p>OSI 只是存在于概念和理论上的一种模型，它的缺点是分层太多，增加了网络工作的复杂性，所以没有大规模应用。后来人们对 OSI 进行了简化，合并了一些层，最终只保留了 4 层，从下到上分别是<font color=red>接口层、网络层、传输层和应用层</font>，这就是大名鼎鼎的 <font color=red>TCP&#x2F;IP 模型</font>。</p>
<p><font color=purple>这个网络模型究竟是干什么呢？简而言之就是进行数据封装的。</font></p>
<p>我们平常使用的程序（或者说软件）一般都是通过应用层来访问网络的，程序产生的数据会一层一层地往下传输，直到最后的网络接口层，就通过网线发送到互联网上去了。数据每往下走一层，就会被这一层的协议增加一层包装，等到发送到互联网上时，已经比原始数据多了四层包装。整个数据封装的过程就像俄罗斯套娃。</p>
<p>当另一台计算机接收到数据包时，会从网络接口层再一层一层往上传输，每传输一层就拆开一层包装，直到最后的应用层，就得到了最原始的数据，这才是程序要使用的数据。</p>
<p>给数据加包装的过程，实际上就是在数据的头部增加一个标志（一个数据块），表示数据经过了这一层，我已经处理过了。给数据拆包装的过程正好相反，就是去掉数据头部的标志，让它逐渐现出原形。</p>
<p>我们所说的 <a target="_blank" rel="noopener" href="http://c.biancheng.net/socket/">socket</a> 编程，是站在传输层的基础上，所以可以使用 TCP&#x2F;UDP 协议，但是不能干「访问网页」这样的事情，因为访问网页所需要的 http 协议位于应用层。</p>
<p>两台计算机进行通信时，必须遵守以下原则：</p>
<ul>
<li>必须是同一层次进行通信，比如，A 计算机的应用层和 B 计算机的传输层就不能通信，因为它们不在一个层次，数据的拆包会遇到问题。</li>
<li>每一层的功能都必须相同，也就是拥有完全相同的网络模型。如果网络模型都不同，那不就乱套了，谁都不认识谁。</li>
<li>数据只能逐层传输，不能跃层。</li>
<li>每一层可以使用下层提供的服务，并向上层提供服务。</li>
</ul>
<h2 id="TCP-x2F-IP-协议族"><a href="#TCP-x2F-IP-协议族" class="headerlink" title="TCP&#x2F;IP 协议族"></a><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/2133.html">TCP&#x2F;IP 协议族</a></h2><p><img data-src="http://c.biancheng.net/uploads/allimg/190126/1-1Z126104435N0.gif"></p>
<h2 id="IP、MAC-和端口号——网络通信中确认身份信息的三要素"><a href="#IP、MAC-和端口号——网络通信中确认身份信息的三要素" class="headerlink" title="IP、MAC 和端口号——网络通信中确认身份信息的三要素"></a><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/2132.html">IP、MAC 和端口号——网络通信中确认身份信息的三要素</a></h2><p>对于目前广泛使用 IPv4 地址，它的资源是非常有限的，一台计算机一个 IP 地址是不现实的，往往是一个局域网才拥有一个 IP 地址。换句话说，IP 地址只能定位到一个局域网，无法定位到具体的一台计算机。</p>
<p>其实，真正能唯一标识一台计算机的是 MAC 地址，每个网卡的 MAC 地址在全世界都是独一无二的。计算机出厂时，MAC 地址已经被写死到网卡里面了（当然通过某些“奇巧淫技”也是可以修改的）。局域网中的路由器&#x2F;交换机会记录每台计算机的 MAC 地址。</p>
<blockquote>
<p>MAC 地址是 Media Access Control Address 的缩写，直译为“媒体访问控制地址”，也称为局域网地址（LAN Address），以太网地址（Ethernet Address）或物理地址（Physical Address）。</p>
</blockquote>
<p>数据包中除了会附带对方的 IP 地址，还会附带对方的 MAC 地址，当数据包达到局域网以后，路由器&#x2F;交换机会根据数据包中的 MAC 地址找到对应的计算机，然后把数据包转交给它，这样就完成了数据的传递。</p>
<p>有了 IP 地址和 MAC 地址，虽然可以找到目标计算机，但仍然不能进行通信。为了区分不同的网络程序，计算机会为每个网络程序分配一个独一无二的端口号（Port Number），例如，Web 服务的端口号是 80，FTP 服务的端口号是 21，SMTP 服务的端口号是 25。</p>
<p>端口（Port）是一个虚拟的、逻辑上的概念。可以将端口理解为一道门，数据通过这道门流入流出，每道门有不同的编号，就是端口号。如下图所示：</p>
<p><img data-src="http://c.biancheng.net/uploads/allimg/190126/15060130Z-0.jpg"></p>
<h2 id="Linux-下的-socket-演示程序"><a href="#Linux-下的-socket-演示程序" class="headerlink" title="Linux 下的 socket 演示程序"></a><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/2128.html">Linux 下的 socket 演示程序</a></h2><p>详细信息参考链接。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//创建套接字</span>
<span class="token keyword">int</span> serv_sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>AF_INET：使用过 IPv4 地址</p>
<p>SOCK_STREAM：设置套接字</p>
<p>IPPROTO_TCP：使用 TCP 协议，这里也可以写 0，SOCK_STREAM 默认就是 TCP</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>socket() 函数确定了套接字的各种属性，<font color=red>bind()</font> 函数让套接字与特定的 IP 地址和端口对应起来，这样客户端才能连接到该套接字。</p>
<p><font color=red>listen()</font> 让套接字处于被动监听状态。所谓被动监听，是指套接字一直处于“睡眠”中，直到客户端发起请求才会被“唤醒”。</p>
<p><font color=red>accept()</font> 函数用来接收客户端的请求。程序一旦执行到 accept() 就会被阻塞（暂停运行），直到客户端发起请求。</p>
<p><font color=red>write()</font> 函数用来向套接字文件中写入数据，也就是向客户端发送数据。</p>
<p>和普通文件一样，socket 在使用完毕后也要用 <font color=red>close()</font> 关闭。</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p><font color=red>connect()</font> 向服务器发起请求, 直到服务器传回数据后，connect() 才运行结束。</p>
<p>通过 <font color=red>read()</font> 从套接字文件中读取数据。</p>
<h2 id="socket-函数"><a href="#socket-函数" class="headerlink" title="socket() 函数"></a>socket() 函数</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>af 为地址族（Address Family），也就是 IP 地址类型，常用的有 AF_INET 和 AF_INET6。AF 是“Address Family”的简写，INET 是“Inetnet”的简写。AF_INET 表示 IPv4 地址，例如 127.0.0.1；AF_INET6 表示 IPv6 地址，例如 1030::C9B4:FF12:48AA:1A2B。</p>
<p>type 为数据传输方式&#x2F;套接字类型，常用的有 SOCK_STREAM（流格式套接字&#x2F;面向连接的套接字） 和 SOCK_DGRAM（数据报套接字&#x2F;无连接的套接字）。</p>
<p>protocol 表示传输协议，常用的有 IPPROTO_TCP 和 IPPTOTO_UDP，分别表示 TCP 传输协议和 UDP 传输协议。</p>
<p>正如大家所想，一般情况下有了 af 和 type 两个参数就可以创建套接字了，操作系统会自动推演出协议类型，除非遇到这样的情况：有两种不同的协议支持同一种地址类型和数据传输类型。如果我们不指明使用哪种协议，操作系统是没办法自动推演的。</p>
<p>满足 af 和 type 这两个条件的协议只有一种，可以将 protocol 的值设为 0，系统会自动推演出应该使用什么协议，如下所示：</p>
<pre class="language-none"><code class="language-none">int tcp_socket &#x3D; socket(AF_INET, SOCK_STREAM, 0);  &#x2F;&#x2F;创建TCP套接字
int udp_socket &#x3D; socket(AF_INET, SOCK_DGRAM, 0);  &#x2F;&#x2F;创建UDP套接字</code></pre>

<h2 id="bind-和-connect-函数"><a href="#bind-和-connect-函数" class="headerlink" title="bind() 和 connect() 函数"></a>bind() 和 connect() 函数</h2><p><a target="_blank" rel="noopener" href="http://c.biancheng.net/socket/">socket</a>() 函数用来创建套接字，确定套接字的各种属性，然后服务器端要用 bind() 函数将套接字与特定的 IP 地址和端口绑定起来，只有这样，流经该 IP 地址和端口的数据才能交给套接字处理。类似地，客户端也要用 connect() 函数建立连接。</p>
<h2 id="listen-和-accept-函数：让套接字进入监听状态并响应客户端请求"><a href="#listen-和-accept-函数：让套接字进入监听状态并响应客户端请求" class="headerlink" title="listen()和 accept()函数：让套接字进入监听状态并响应客户端请求"></a>listen()和 accept()函数：让套接字进入监听状态并响应客户端请求</h2><p>对于服务器端程序，使用 bind() 绑定套接字后，还需要使用 listen() 函数让套接字进入被动监听状态，再调用 accept() 函数，就可以随时响应客户端的请求了。</p>
<h3 id="listen-函数"><a href="#listen-函数" class="headerlink" title="listen() 函数"></a>listen() 函数</h3><p>通过 listen() 函数可以让套接字进入被动监听状态, 所谓被动监听，是指当没有客户端请求时，套接字处于“睡眠”状态，只有当接收到客户端请求时，套接字才会被“唤醒”来响应请求。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sock<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h4 id="请求队列"><a href="#请求队列" class="headerlink" title="请求队列"></a>请求队列</h4><p>当套接字正在处理客户端请求时，如果有新的请求进来，套接字是没法处理的，只能把它放进<font color=green>缓冲区</font>，待当前请求处理完毕后，再从缓冲区中读取出来处理。如果不断有新的请求进来，它们就按照先后顺序在缓冲区中排队，直到缓冲区满。这个缓冲区，就称为请求队列（Request Queue）。</p>
<p>缓冲区的长度（能存放多少个客户端请求）可以通过 listen() 函数的 backlog 参数指定，但究竟为多少并没有什么标准，可以根据你的需求来定，并发量小的话可以是 10 或者 20。</p>
<p>如果将 backlog 的值设置为 SOMAXCONN，就由系统来决定请求队列长度，这个值一般比较大，可能是几百，或者更多。</p>
<p>当请求队列满时，就不再接收新的请求，对于 Linux，客户端会收到 ECONNREFUSED 错误，对于 Windows，客户端会收到 WSAECONNREFUSED 错误。</p>
<p>注意：listen() 只是让套接字处于监听状态，并没有接收请求。接收请求需要使用 accept() 函数。</p>
<h3 id="accept-函数"><a href="#accept-函数" class="headerlink" title="accept() 函数"></a>accept() 函数</h3><p>当套接字处于监听状态时，可以通过 accept() 函数来接收客户端请求。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sock<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><font color=#b22222>accept() 返回一个新的套接字来和客户端通信，addr 保存了客户端的 IP 地址和端口号，而 sock 是服务器端的套接字，注意区分</font>。后面和客户端通信时，要使用这个新生成的套接字，而不是原来服务器端的套接字。</p>
<p>最后需要说明的是：listen() 只是让套接字进入监听状态，并没有真正接收客户端请求，listen() 后面的代码会继续执行，直到遇到 accept()。accept() 会阻塞程序执行（后面代码不能被执行），直到有新的请求到来。</p>
<h2 id="send-x2F-recv-和-write-x2F-read-：发送数据和接收数据"><a href="#send-x2F-recv-和-write-x2F-read-：发送数据和接收数据" class="headerlink" title="send()&#x2F;recv()和 write()&#x2F;read()：发送数据和接收数据"></a>send()&#x2F;recv()和 write()&#x2F;read()：发送数据和接收数据</h2><p>Linux 不区分套接字文件和普通文件，使用 write() 可以向套接字中写入数据，使用 read() 可以从套接字中读取数据。</p>
<p><font color=#b22222>前面我们说过，两台计算机之间的通信相当于两个套接字之间的通信，在服务器端用 write() 向套接字写入数据，客户端就能收到，然后再使用 read() 从套接字中读取出来，就完成了一次通信。</font></p>
<p>Windows 区分普通文件和套接字，并定义了专门的接收和发送的函数: 从服务器端发送数据使用 <font color=red>send()</font> 函数; 在客户端接收数据使用 <font color=red>recv()</font> 函数;</p>
<h2 id="如何让服务器端持续不断地监听客户端的请求"><a href="#如何让服务器端持续不断地监听客户端的请求" class="headerlink" title="如何让服务器端持续不断地监听客户端的请求?"></a>如何让服务器端持续不断地监听客户端的请求?</h2><p>答: 使用 while</p>
<h2 id="socket-缓冲区以及阻塞模式详解"><a href="#socket-缓冲区以及阻塞模式详解" class="headerlink" title="socket 缓冲区以及阻塞模式详解"></a><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/2349.html">socket 缓冲区以及阻塞模式详解</a></h2><h3 id="socket-缓冲区"><a href="#socket-缓冲区" class="headerlink" title="socket 缓冲区"></a>socket 缓冲区</h3><p><font color=#b22222>每个 socket 被创建后，都会分配两个缓冲区，输入缓冲区和输出缓冲区。</font></p>
<p><font color=red>write()</font> 并不立即向网络中传输数据，而是先将数据写入缓冲区中，再由 TCP 协议将数据从缓冲区发送到目标机器。一旦将数据写入到缓冲区，函数就可以成功返回，不管它们有没有到达目标机器，也不管它们何时被发送到网络，这些都是 TCP 协议负责的事情。</p>
<p>TCP 协议独立于 <font color=red>write()</font> 函数，数据有可能刚被写入缓冲区就发送到网络，也可能在缓冲区中不断积压，多次写入的数据被一次性发送到网络，这取决于当时的网络情况、当前线程是否空闲等诸多因素，不由程序员控制。</p>
<p><font color=red>read()</font> 函数也是如此，也从输入缓冲区中读取数据，而不是直接从网络中读取。</p>
<p><img data-src="http://c.biancheng.net/uploads/allimg/190219/1149355056-0.jpg" alt="TCP套接字I/O缓冲区示意图"></p>
<p>这些 I&#x2F;O 缓冲区特性可整理如下：</p>
<ul>
<li>I&#x2F;O 缓冲区在每个 TCP 套接字中单独存在；</li>
<li>I&#x2F;O 缓冲区在创建套接字时自动生成；</li>
<li>即使关闭套接字也会继续传送输出缓冲区中遗留的数据；</li>
<li>关闭套接字将丢失输入缓冲区中的数据。</li>
</ul>
<p>输入输出缓冲区的默认大小一般都是 8K，可以通过 getsockopt() 函数获取：</p>
<h3 id="阻塞模式"><a href="#阻塞模式" class="headerlink" title="阻塞模式"></a>阻塞模式</h3><p>对于 TCP 套接字（默认情况下），当使用 write() 发送数据时：</p>
<ol>
<li>首先会检查缓冲区，如果缓冲区的可用空间长度小于要发送的数据，那么 write() 会被阻塞（暂停执行），直到缓冲区中的数据被发送到目标机器，腾出足够的空间，才唤醒 write() 函数继续写入数据。</li>
<li>如果 TCP 协议正在向网络发送数据，那么输出缓冲区会被锁定，不允许写入，write() 也会被阻塞，直到数据发送完毕缓冲区解锁，write()&#x2F;send() 才会被唤醒。</li>
<li>如果要写入的数据大于缓冲区的最大长度，那么将分批写入。</li>
<li>直到所有数据被写入缓冲区 write() 才能返回。</li>
</ol>
<p>当使用 read() 读取数据时：</p>
<ol>
<li>首先会检查缓冲区，如果缓冲区中有数据，那么就读取，否则函数会被阻塞，直到网络上有数据到来。</li>
<li>如果要读取的数据长度小于缓冲区中的数据长度，那么就不能一次性将缓冲区中的所有数据读出，剩余数据将不断囤积，直到有 read() 函数再次读取。</li>
<li>直到读取到数据后 read() 函数才会返回，否则就一直被阻塞。</li>
</ol>
<p>这就是 TCP 套接字的阻塞模式。所谓阻塞，就是上一步动作没有完成，下一步动作将暂停，直到上一步动作完成后才能继续，以保持同步性。</p>
<blockquote>
<p>​ CP 套接字默认情况下是阻塞模式，也是最常用的。当然你也可以更改为非阻塞模式，后续我们会讲解。</p>
</blockquote>
<h2 id="TCP-协议的粘包问题（数据的无边界性）"><a href="#TCP-协议的粘包问题（数据的无边界性）" class="headerlink" title="TCP 协议的粘包问题（数据的无边界性）"></a>TCP 协议的粘包问题（数据的无边界性）</h2><h2 id="图解-TCP-数据报结构以及三次握手（非常详细）"><a href="#图解-TCP-数据报结构以及三次握手（非常详细）" class="headerlink" title="图解 TCP 数据报结构以及三次握手（非常详细）"></a><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/2351.html">图解 TCP 数据报结构以及三次握手（非常详细）</a></h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%B7%A5%E5%85%B7/ubuntu/Ubuntu%2018.04%E6%90%9C%E7%8B%97%E8%BE%93%E5%85%A5%E6%B3%95%E6%98%BE%E7%A4%BA%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B7%A5%E5%85%B7/ubuntu/Ubuntu%2018.04%E6%90%9C%E7%8B%97%E8%BE%93%E5%85%A5%E6%B3%95%E6%98%BE%E7%A4%BA%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">Ubuntu 18.04搜狗输入法显示乱码问题解决方案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:36:05" itemprop="dateCreated datePublished" datetime="2020-12-11T22:36:05+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/ubuntu/" itemprop="url" rel="index"><span itemprop="name">ubuntu</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/dailymatters/p/12431344.html">https://www.cnblogs.com/dailymatters/p/12431344.html</a></p>
<p>将英文键盘设置为第一个选项即可。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1597624853522.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%B7%A5%E5%85%B7/ubuntu/Linux%E4%B9%8Bman%E5%91%BD%E4%BB%A4%E4%B8%AD%E6%96%87%E6%B1%89%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B7%A5%E5%85%B7/ubuntu/Linux%E4%B9%8Bman%E5%91%BD%E4%BB%A4%E4%B8%AD%E6%96%87%E6%B1%89%E5%8C%96/" class="post-title-link" itemprop="url">Linux之man命令中文汉化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:35:36" itemprop="dateCreated datePublished" datetime="2020-12-11T22:35:36+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/ubuntu/" itemprop="url" rel="index"><span itemprop="name">ubuntu</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> autoconf
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> opencc</code></pre>

<p><a target="_blank" rel="noopener" href="https://github.com/man-pages-zh/manpages-zh">github 地址</a><br>下载 zip 压缩包</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> autoreconf <span class="token parameter variable">--install</span> <span class="token parameter variable">--force</span>
<span class="token function">sudo</span> ./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/zhman --disable-zhtw
<span class="token function">sudo</span> <span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"alias cman='man -M /usr/local/zhman/share/man/zh_CN' "</span> <span class="token operator">>></span> ~/.bashrc
<span class="token builtin class-name">.</span> ~/.bashrc</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/MySQL/%E6%97%A0%E9%99%90%E5%B1%82%E7%BA%A7%E8%8F%9C%E5%8D%95%E2%80%94%E5%B7%A6%E5%8F%B3%E5%80%BC%E6%A0%91%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/MySQL/%E6%97%A0%E9%99%90%E5%B1%82%E7%BA%A7%E8%8F%9C%E5%8D%95%E2%80%94%E5%B7%A6%E5%8F%B3%E5%80%BC%E6%A0%91%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">无限层级菜单—左右值树型数据结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:23:55" itemprop="dateCreated datePublished" datetime="2020-12-11T22:23:55+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>参考：<a target="_blank" rel="noopener" href="http://caijt.com/2016/01/19/422/">http://caijt.com/2016/01/19/422/</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://app.yinxiang.com/shard/s57/nl/12854860/90760f75-a41b-4109-ba50-4b22a952ef1d">无限层级菜单—左右值树型数据结构 | 菜工的 IT 生涯</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%89%8D%E7%AB%AF/Vue2/%E7%94%A8element%E7%9A%84upload%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E5%92%8C%E5%8E%8B%E7%BC%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%89%8D%E7%AB%AF/Vue2/%E7%94%A8element%E7%9A%84upload%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E5%92%8C%E5%8E%8B%E7%BC%A9/" class="post-title-link" itemprop="url">用element的upload组件实现多图片上传和压缩</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:09:37" itemprop="dateCreated datePublished" datetime="2020-12-11T22:09:37+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/Vue2/" itemprop="url" rel="index"><span itemprop="name">Vue2</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010227042/article/details/90756308">https://blog.csdn.net/u010227042/article/details/90756308</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%B7%A5%E5%85%B7/windows/vmware/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B7%A5%E5%85%B7/windows/vmware/" class="post-title-link" itemprop="url">vmware</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:04:10" itemprop="dateCreated datePublished" datetime="2020-12-11T22:04:10+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/windows/" itemprop="url" rel="index"><span itemprop="name">windows</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="快照原理"><a href="#快照原理" class="headerlink" title="快照原理"></a>快照原理</h2><p>将当前虚拟机的虚拟硬盘文件锁定，不再更改，之后新建一个文件，之后所有更改都放到新建的文件中，读取时，优先读取这个中的，没有的话在读取锁定中的数据。所以快照占的空间取决于你做了多少更改</p>
<h2 id="移动和复制"><a href="#移动和复制" class="headerlink" title="移动和复制"></a>移动和复制</h2><p>选择移动不会改变，选择复制会改变 ip、mac 等信息。</p>
<h2 id="主机能-ping-通虚拟机，虚拟机-ping-不通主机"><a href="#主机能-ping-通虚拟机，虚拟机-ping-不通主机" class="headerlink" title="主机能 ping 通虚拟机，虚拟机 ping 不通主机"></a>主机能 ping 通虚拟机，虚拟机 ping 不通主机</h2><ol>
<li>打开 WIN7 防火墙</li>
<li>选择高级设置</li>
<li>入站规则</li>
<li>找到配置文件类型为“公用”的“文件和打印共享（回显请求  – ICMPv4-In）”规则，设置为允许。如果“公用”已经开启，那就再开启“专用”</li>
<li>虚拟机可以 ping 通主机了。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%B7%A5%E5%85%B7/windows/%E9%BB%98%E8%AE%A4%E7%AE%A1%E7%90%86%E5%91%98%E8%BF%90%E8%A1%8Ccmd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B7%A5%E5%85%B7/windows/%E9%BB%98%E8%AE%A4%E7%AE%A1%E7%90%86%E5%91%98%E8%BF%90%E8%A1%8Ccmd/" class="post-title-link" itemprop="url">默认管理员运行cmd</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 22:04:10" itemprop="dateCreated datePublished" datetime="2020-12-11T22:04:10+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/windows/" itemprop="url" rel="index"><span itemprop="name">windows</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>Win+R – regedit</li>
<li>找到以下位置: <code>HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers</code></li>
<li>新建一个字符串值，命名为”c:\windows\system32\cmd.exe”，然后右键–修改 – 数值数据写入“RUNASADMIN”，确定 ！</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E9%A2%98%E7%A7%AF%E7%B4%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E9%A2%98%E7%A7%AF%E7%B4%AF/" class="post-title-link" itemprop="url">面试题积累</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 21:58:07" itemprop="dateCreated datePublished" datetime="2020-12-11T21:58:07+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E9%9D%A2%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">面试</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="删除文件却没有释放空间"><a href="#删除文件却没有释放空间" class="headerlink" title="删除文件却没有释放空间"></a>删除文件却没有释放空间</h2><p>因为有程序正在占用这个文件, 只要 kill 掉这个程序, 就能释放空间了</p>
<p>或者使用<code>cat /dev/null &gt; bigfile</code>指令先清除文件内容，然后再 rm 删除文件</p>
<h2 id="从浏览器输入-URL-到页面展示过程发生了什么？"><a href="#从浏览器输入-URL-到页面展示过程发生了什么？" class="headerlink" title="从浏览器输入 URL 到页面展示过程发生了什么？"></a>从浏览器输入 URL 到页面展示过程发生了什么？</h2><ol>
<li>浏览器构建完整的的 url，例如输入：lujinkai.cn，浏览器会自动补全为 <a target="_blank" rel="noopener" href="http://lujinkai.cn,然后浏览器进程将完整的/">http://lujinkai.cn，然后浏览器进程将完整的</a> url 通过 ipc 发送给网络进程</li>
<li>网络进程接收到 url 后，对域名进行 dns 解析，得到 ip</li>
<li>有了 ip，检查路由是否可达</li>
<li>通过 arp 得到 ip 对应的 mac 地址</li>
<li>发起三次握手，建立连接，进行通信</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%89%8D%E7%AB%AF/hexo/njk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%89%8D%E7%AB%AF/hexo/njk/" class="post-title-link" itemprop="url">njk</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 21:56:49" itemprop="dateCreated datePublished" datetime="2020-12-11T21:56:49+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/hexo/" itemprop="url" rel="index"><span itemprop="name">hexo</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>参考：<a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1022910821149312/1100400176397024">https://www.liaoxuefeng.com/wiki/1022910821149312/1100400176397024</a></p>
<p>参考：<a target="_blank" rel="noopener" href="http://mozilla.github.io/nunjucks/cn/templating.html">http://mozilla.github.io/nunjucks/cn/templating.html</a></p>
<p>Nunjucks 是 Mozilla 开发的一个纯 JavaScript 编写的模板引擎，既可以用在 Node 环境下，又可以运行在浏览器端。但是，主要还是运行在 Node 环境下，因为浏览器端有更好的模板解决方案，例如 MVVM 框架。</p>
<p>先定义一个基本的网页框架<code>base.html</code>：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>html<span class="token operator">></span><span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token punctuation">&#123;</span><span class="token operator">%</span> block header <span class="token operator">%</span><span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>h3<span class="token operator">></span>Unnamed<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>No body<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token operator">%</span> block footer <span class="token operator">%</span><span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>copyright<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span></code></pre>

<p><code>base.html</code>定义了三个可编辑的块，分别命名为<code>header</code>、<code>body</code>和<code>footer</code>。<strong>子模板可以有选择地对块进行重新定义</strong>：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">%</span> <span class="token keyword">extends</span> <span class="token string">'base.html'</span> <span class="token operator">%</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#123;</span><span class="token operator">%</span> block header <span class="token operator">%</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span>h1<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> header <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#123;</span><span class="token operator">%</span> block body <span class="token operator">%</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span>p<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> body <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">&#125;</span></code></pre>

<p>然后，我们对子模板进行渲染：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  env<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"extend.html"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">"bla bla bla..."</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>输出 HTML 如下：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>html<span class="token operator">></span><span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Hello<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>bla bla bla<span class="token punctuation">..</span>.<span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>div<span class="token operator">></span>copyright<span class="token operator">&lt;</span>/div<span class="token operator">></span> <span class="token operator">&lt;</span>-- footer没有重定义，所以仍使用父模板的内容
<span class="token operator">&lt;</span>/body<span class="token operator">></span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E5%89%8D%E7%AB%AF/Vue2/element-ui/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%89%8D%E7%AB%AF/Vue2/element-ui/" class="post-title-link" itemprop="url">element-ui</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 18:43:14" itemprop="dateCreated datePublished" datetime="2020-12-11T18:43:14+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/Vue2/" itemprop="url" rel="index"><span itemprop="name">Vue2</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>列举包可使用版本：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> view element-ui versions</code></pre>

<p>升级到最新版本：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> update element-ui</code></pre>

<p>升级到特定版本：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> update element-ui@1.4.1</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/C/C%E8%AF%AD%E8%A8%80%E7%B3%BB%E7%BB%9F%E5%8C%96%E7%B2%BE%E8%AE%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/C/C%E8%AF%AD%E8%A8%80%E7%B3%BB%E7%BB%9F%E5%8C%96%E7%B2%BE%E8%AE%B2/" class="post-title-link" itemprop="url">C语言系统化精讲</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 14:45:20" itemprop="dateCreated datePublished" datetime="2020-12-11T14:45:20+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>大端序和小端序：</p>
<ul>
<li>小端序：高位序存于高地址，更符号机器的阅读顺序</li>
<li>大端序：高位存于低地址，人类的阅读顺序</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/C/%E8%BD%AC%E8%BD%BD-gdb%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/C/%E8%BD%AC%E8%BD%BD-gdb%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">转载-gdb调试指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-11 14:45:14" itemprop="dateCreated datePublished" datetime="2020-12-11T14:45:14+08:00">2020-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><p>本文为 GDB 调试指南，参考 GDB 调试手册，但加入了很多实例，目前已有的篇目：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/04/20/41283.html#%E5%90%AF%E5%8A%A8%E8%B0%83%E8%AF%95">启动调试</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/04/20/41283.html#%E6%96%AD%E7%82%B9%E8%AE%BE%E7%BD%AE">断点设置</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/04/20/41283.html#%E5%8F%98%E9%87%8F%E6%9F%A5%E7%9C%8B">变量查看</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/04/20/41283.html#%E5%8D%95%E6%AD%A5%E8%B0%83%E8%AF%95">单步调试</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/04/20/41283.html#%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B">源码查看</a></li>
</ul>
<h1 id="启动调试"><a href="#启动调试" class="headerlink" title="启动调试"></a>启动调试</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>GDB（GNU Debugger）是 UNIX 及 UNIX-like 下的强大调试工具，可以调试 ada, c, c++, asm, minimal, d, fortran, objective-c, go, java,pascal 等语言。本文以 C 程序为例，介绍 GDB 启动调试的多种方式。</p>
<h2 id="哪类程序可被调试"><a href="#哪类程序可被调试" class="headerlink" title="哪类程序可被调试"></a>哪类程序可被调试</h2><p>对于 C 程序来说，需要在编译时加上-g 参数，保留调试信息，否则不能使用 GDB 进行调试。</p>
<p>但如果不是自己编译的程序，并不知道是否带有-g 参数，如何判断一个文件是否带有调试信息呢？</p>
<h4 id="gdb-文件"><a href="#gdb-文件" class="headerlink" title="gdb 文件"></a>gdb 文件</h4><p>例如：</p>
<pre class="language-none"><code class="language-none">$ gdb helloworld
Reading symbols from helloWorld...(no debugging symbols found)...done.</code></pre>

<p>如果没有调试信息，会提示 no debugging symbols found。<br>如果是下面的提示：</p>
<pre class="language-none"><code class="language-none">Reading symbols from helloWorld...done.</code></pre>

<p>则可以进行调试。</p>
<h4 id="readelf-查看段信息"><a href="#readelf-查看段信息" class="headerlink" title="readelf 查看段信息"></a>readelf 查看段信息</h4><p>例如：</p>
<pre class="language-none"><code class="language-none">$ readelf -S helloWorld|grep debug
  [28] .debug_aranges    PROGBITS         0000000000000000  0000106d
  [29] .debug_info       PROGBITS         0000000000000000  0000109d
  [30] .debug_abbrev     PROGBITS         0000000000000000  0000115b
  [31] .debug_line       PROGBITS         0000000000000000  000011b9
  [32] .debug_str        PROGBITS         0000000000000000  000011fc</code></pre>

<p>helloWorld 为文件名，如果没有任何 debug 信息，则不能被调试。</p>
<h4 id="file-查看-strip-状况"><a href="#file-查看-strip-状况" class="headerlink" title="file 查看 strip 状况"></a>file 查看 strip 状况</h4><p>下面的情况也是不可调试的：</p>
<pre class="language-none"><code class="language-none">file helloWorld
helloWorld: (省略前面内容) stripped</code></pre>

<p>如果最后是 stripped，则说明该文件的符号表信息和调试信息已被去除，不能使用 gdb 调试。但是 not stripped 的情况并不能说明能够被调试。</p>
<h2 id="调试方式运行程序"><a href="#调试方式运行程序" class="headerlink" title="调试方式运行程序"></a>调试方式运行程序</h2><p>程序还未启动时，可有多种方式启动调试。</p>
<h4 id="调试启动无参程序"><a href="#调试启动无参程序" class="headerlink" title="调试启动无参程序"></a>调试启动无参程序</h4><p>例如：</p>
<pre class="language-none"><code class="language-none">$ gdb helloWorld
(gdb)</code></pre>

<p>输入 run 命令，即可运行程序</p>
<h4 id="调试启动带参程序"><a href="#调试启动带参程序" class="headerlink" title="调试启动带参程序"></a>调试启动带参程序</h4><p>假设有以下程序，启动时需要带参数：</p>
<pre class="language-none"><code class="language-none">#include&lt;stdio.h&gt;
int main(int argc,char *argv[])
&#123;
    if(1 &gt;&#x3D; argc)
    &#123;
        printf(&quot;usage:hello name\n&quot;);
        return 0;
    &#125;
    printf(&quot;Hello World %s!\n&quot;,argv[1]);
    return 0 ;
&#125;</code></pre>

<p>编译：</p>
<pre class="language-none"><code class="language-none">gcc -g -o hello hello.c</code></pre>

<p>这种情况如何启动调试呢？需要设置参数：</p>
<pre class="language-none"><code class="language-none">$ gdb hello
(gdb)run 编程珠玑
Starting program: &#x2F;home&#x2F;shouwang&#x2F;workspaces&#x2F;c&#x2F;hello 编程珠玑
Hello World 编程珠玑!
[Inferior 1 (process 20084) exited normally]
(gdb)</code></pre>

<p>只需要 run 的时候带上参数即可。<br>或者使用 set args，然后在用 run 启动：</p>
<pre class="language-none"><code class="language-none">gdb hello
(gdb) set args 编程珠玑
(gdb) run
Starting program: &#x2F;home&#x2F;hyb&#x2F;workspaces&#x2F;c&#x2F;hello 编程珠玑
Hello World 编程珠玑!
[Inferior 1 (process 20201) exited normally]
(gdb)</code></pre>

<h4 id="调试-core-文件"><a href="#调试-core-文件" class="headerlink" title="调试 core 文件"></a>调试 core 文件</h4><p>当程序 core dump 时，可能会产生 core 文件，它能够很大程序帮助我们定位问题。但前提是系统没有限制 core 文件的产生。可以使用命令 limit -c 查看：</p>
<pre class="language-none"><code class="language-none">$ ulimit -c
0</code></pre>

<p>如果结果是 0，那么恭喜你，即便程序 core dump 了也不会有 core 文件留下。我们需要让 core 文件能够产生：</p>
<pre class="language-none"><code class="language-none">ulimit -c unlimied  #表示不限制core文件大小
ulimit -c 10        #设置最大大小，单位为块，一块默认为512字节</code></pre>

<p>上面两种方式可选其一。第一种无限制，第二种指定最大产生的大小。<br>调试 core 文件也很简单：</p>
<pre class="language-none"><code class="language-none">gdb 程序文件名 core文件名</code></pre>

<p>具体可参看《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2018/09/26/61877.html">linux 常用命令-开发调试篇</a>》gdb 部分。</p>
<h2 id="调试已运行程序"><a href="#调试已运行程序" class="headerlink" title="调试已运行程序"></a>调试已运行程序</h2><p>如果程序已经运行了怎么办呢？<br>首先使用 ps 命令找到进程 id：</p>
<pre class="language-none"><code class="language-none">ps -ef|grep 进程名</code></pre>

<h4 id="attach-方式"><a href="#attach-方式" class="headerlink" title="attach 方式"></a>attach 方式</h4><p>假设获取到进程 id 为 20829，则可用下面的方式调试进程：</p>
<pre class="language-none"><code class="language-none">$ gdb
(gdb) attach 20829</code></pre>

<p>接下来就可以继续你的调试啦。</p>
<p>可能会有下面的错误提示：</p>
<pre class="language-none"><code class="language-none">Could not attach to process.  If your uid matches the uid of the target
process, check the setting of &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;yama&#x2F;ptrace_scope, or try
again as the root user.  For more details, see &#x2F;etc&#x2F;sysctl.d&#x2F;10-ptrace.conf
ptrace: Operation not permitted.</code></pre>

<p>解决方法，切换到 root 用户：<br>将&#x2F;etc&#x2F;sysctl.d&#x2F;10-ptrace.conf 中的</p>
<pre class="language-none"><code class="language-none">kernel.yama.ptrace_scope &#x3D; 1</code></pre>

<p>修改为</p>
<pre class="language-none"><code class="language-none">kernel.yama.ptrace_scope &#x3D; 0</code></pre>

<h4 id="直接调试相关-id-进程"><a href="#直接调试相关-id-进程" class="headerlink" title="直接调试相关 id 进程"></a>直接调试相关 id 进程</h4><p>还可以是用这样的方式 gdb program pid，例如:</p>
<pre class="language-none"><code class="language-none">gdb hello 20829</code></pre>

<p>或者：</p>
<pre class="language-none"><code class="language-none">gdb hello --pid 20829</code></pre>

<h4 id="已运行程序没有调试信息"><a href="#已运行程序没有调试信息" class="headerlink" title="已运行程序没有调试信息"></a>已运行程序没有调试信息</h4><p>为了节省磁盘空间，已经运行的程序通常没有调试信息。但如果又不能停止当前程序重新启动调试，那怎么办呢？还有办法，那就是同样的代码，再编译出一个带调试信息的版本。然后使用和前面提到的方式操作。对于 attach 方式，在 attach 之前，使用 file 命令即可：</p>
<pre class="language-none"><code class="language-none">$ gdb
(gdb) file hello
Reading symbols from hello...done.
(gdb)attach 20829</code></pre>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要介绍了两种类型的 GDB 启动调试方式，分别是调试未运行的程序和已经运行的程序。对于什么样的程序能够进行调试也进行了简单说明。</p>
<h1 id="断点设置"><a href="#断点设置" class="headerlink" title="断点设置"></a>断点设置</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>上篇《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/01/08/62137.html">GDB 调试指南-启动调试</a>》我们讲到了 GDB 启动调试的多种方式，分别应用于多种场景。今天我们来介绍一下断点设置的多种方式。</p>
<h2 id="为何要设置断点"><a href="#为何要设置断点" class="headerlink" title="为何要设置断点"></a>为何要设置断点</h2><p>在介绍之前，我们首先需要了解，为什么需要设置断点。我们在指定位置设置断点之后，程序运行到该位置将会“暂停”，这个时候我们就可以对程序进行更多的操作，比如查看变量内容，堆栈情况等等，以帮助我们调试程序。</p>
<h2 id="查看已设置的断点"><a href="#查看已设置的断点" class="headerlink" title="查看已设置的断点"></a>查看已设置的断点</h2><p>在学习断点设置之前，我们可以使用 info breakpoints 查看已设置断点：</p>
<pre class="language-none"><code class="language-none">info breakpoints
Num     Type           Disp Enb Address            What
1       breakpoint     keep y   0x00000000004005fc in printNum2 at test.c:17
    breakpoint already hit 1 time
2       hw watchpoint  keep y                      a
    breakpoint already hit 1 time
    ignore next 3 hits</code></pre>

<p>它将会列出所有已设置的断点，每一个断点都有一个标号，用来代表这个断点。例如，第 2 个断点设置是一个观察点，并且会忽略三次。</p>
<h2 id="断点设置-1"><a href="#断点设置-1" class="headerlink" title="断点设置"></a>断点设置</h2><p>断点设置有多种方式，分别应用于不同的场景。借助示例程序进行一一介绍：</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;test.c
#include&lt;stdio.h&gt;
void printNum(int a)
&#123;
    printf(&quot;printNum\n&quot;);
    while(a &gt; 0)
    &#123;
        printf(&quot;%d\n&quot;,a);
        a--;
    &#125;
&#125;
void printNum2(int a,int num)
&#123;
    printf(&quot;printNum\n&quot;);
    while(a &gt; num &amp;&amp; a&gt;0)
    &#123;
        printf(&quot;%d\n&quot;,a);
        a--;
    &#125;
&#125;
int div(int a,int b)
&#123;
    printf(&quot;a&#x3D;%d,b&#x3D;%d\n&quot;,a,b);
    int temp &#x3D; a&#x2F;b;
    return temp;
&#125;
int main(int argc,char *argv[])
&#123;
    printNum2(12,5);
    printNum(10);
    div(10,0);
    return 0;
&#125;</code></pre>

<p>编译：</p>
<pre class="language-none"><code class="language-none">gcc -g -o test test.c</code></pre>

<p>注意，编译时需要带上-g 参数，具体原因参见《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/01/08/62137.html">GDB 调试指南-启动调试</a>》。</p>
<h4 id="根据行号设置断点"><a href="#根据行号设置断点" class="headerlink" title="根据行号设置断点"></a>根据行号设置断点</h4><pre class="language-none"><code class="language-none">b 9  #break 可简写为b</code></pre>

<p>或者</p>
<pre class="language-none"><code class="language-none">b test.c:9</code></pre>

<p>程序运行到第 9 行的时候会断住。</p>
<h4 id="根据函数名设置断点"><a href="#根据函数名设置断点" class="headerlink" title="根据函数名设置断点"></a>根据函数名设置断点</h4><p>同样可以将断点设置在函数处：</p>
<pre class="language-none"><code class="language-none">b printNum</code></pre>

<p>程序在调用到 printNum 函数的时候会断住。</p>
<h4 id="根据条件设置断点"><a href="#根据条件设置断点" class="headerlink" title="根据条件设置断点"></a>根据条件设置断点</h4><p>假设程序某处发生崩溃，而崩溃的原因怀疑是某个地方出现了非期望的值，那么你就可以在这里断点观察，当出现该非法值时，程序断住。这个时候我们可以借助 gdb 来设置条件断点，例如：</p>
<pre class="language-none"><code class="language-none">break test.c:23 if b&#x3D;&#x3D;0</code></pre>

<p>当在 b 等于 0 时，程序将会在第 23 行断住。<br>它和 condition 有着类似的作用，假设上面的断点号为 1，那么：</p>
<pre class="language-none"><code class="language-none">condition 1 b&#x3D;&#x3D;0</code></pre>

<p>会使得 b 等于 0 时，产生断点 1。而实际上可以很方便地用来改变断点产生的条件，例如，之前设置 b&#x3D;&#x3D;0 时产生该断点，那么使用 condition 可以修改断点产生的条件。</p>
<h4 id="根据规则设置断点"><a href="#根据规则设置断点" class="headerlink" title="根据规则设置断点"></a>根据规则设置断点</h4><p>例如需要对所有调用 printNum 函数都设置断点，可以使用下面的方式：</p>
<pre class="language-none"><code class="language-none">rbreak printNum*</code></pre>

<p>所有以 printNum 开头的函数都设置了断点。而下面是对所有函数设置断点：</p>
<pre class="language-none"><code class="language-none">#用法：rbreak file:regex
rbreak .
rbreak test.c:. #对test.c中的所有函数设置断点
rbreak test.c:^print #对以print开头的函数设置断点</code></pre>

<h4 id="设置临时断点"><a href="#设置临时断点" class="headerlink" title="设置临时断点"></a>设置临时断点</h4><p>假设某处的断点只想生效一次，那么可以设置临时断点，这样断点后面就不复存在了：</p>
<pre class="language-none"><code class="language-none">tbreak test.c:l0  #在第10行设置临时断点</code></pre>

<h4 id="跳过多次设置断点"><a href="#跳过多次设置断点" class="headerlink" title="跳过多次设置断点"></a>跳过多次设置断点</h4><p>假如有某个地方，我们知道可能出错，但是前面 30 次都没有问题，虽然在该处设置了断点，但是想跳过前面 30 次，可以使用下面的方式：</p>
<pre class="language-none"><code class="language-none">ignore 1 30</code></pre>

<p>其中，1 是你要忽略的断点号，可以通过前面的方式查找到，30 是需要跳过的次数。这样设置之后，会跳过前面 30 次。再次通过 info breakpoints 可以看到：</p>
<pre class="language-none"><code class="language-none">Num     Type           Disp Enb Address            What
1       breakpoint     keep y   0x00000000004005e8 in printNum2 at test.c:16
    ignore next 30 hits</code></pre>

<h4 id="根据表达式值变化产生断点"><a href="#根据表达式值变化产生断点" class="headerlink" title="根据表达式值变化产生断点"></a>根据表达式值变化产生断点</h4><p>有时候我们需要观察某个值或表达式，知道它什么时候发生变化了，这个时候我们可以借助 watch 命令。例如：</p>
<pre class="language-none"><code class="language-none">watch a</code></pre>

<p>这个时候，让程序继续运行，如果 a 的值发生变化，则会打印相关内容，如：</p>
<pre class="language-none"><code class="language-none">Hardware watchpoint 2: a
Old value &#x3D; 12
New value &#x3D; 11</code></pre>

<p>但是这里要特别注意的是，程序必须运行起来，否则会出现：</p>
<pre class="language-none"><code class="language-none">No symbol &quot;a&quot; in current context.</code></pre>

<p>因为程序没有运行，当前上下文也就没有相关变量信息。</p>
<p>rwatch 和 awatch 同样可以设置观察点前者是当变量值被读时断住，后者是被读或者被改写时断住。</p>
<h2 id="禁用或启动断点"><a href="#禁用或启动断点" class="headerlink" title="禁用或启动断点"></a>禁用或启动断点</h2><p>有些断点暂时不想使用，但又不想删除，可以暂时禁用或启用。例如：</p>
<pre class="language-none"><code class="language-none">disable  #禁用所有断点
disable bnum #禁用标号为bnum的断点
enable  #启用所有断点
enable bnum #启用标号为bnum的断点
enable delete bnum  #启动标号为bnum的断点，并且在此之后删除该断点</code></pre>

<h2 id="断点清除"><a href="#断点清除" class="headerlink" title="断点清除"></a>断点清除</h2><p>断点清除主要用到 clear 和 delete 命令。常见使用如下：</p>
<pre class="language-none"><code class="language-none">clear   #删除当前行所有breakpoints
clear function  #删除函数名为function处的断点
clear filename:function #删除文件filename中函数function处的断点
clear lineNum #删除行号为lineNum处的断点
clear f:lename：lineNum #删除文件filename中行号为lineNum处的断点
delete  #删除所有breakpoints,watchpoints和catchpoints
delete bnum #删除断点号为bnum的断点</code></pre>

<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>本文介绍了常见的断点设置方法，断点设置之后，可以便于我们后期观察变量，堆栈等信息，为进一步的定位与调试做准备。</p>
<h1 id="变量查看"><a href="#变量查看" class="headerlink" title="变量查看"></a>变量查看</h1><h2 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h2><p>在启动调试以及设置断点之后，就到了我们非常关键的一步-查看变量。GDB 调试最大的目的之一就是走查代码，查看运行结果是否符合预期。既然如此，我们就不得不了解一些查看各种类型变量的方法，以帮助我们进一步定位问题。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>在查看变量之前，需要先启动调试并设置断点，该部分内容可参考《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/01/08/62137.html">GDB 调试指南－启动调试</a>》和《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/02/24/44483.html">GDB 调试指南－断点设置</a>》。后面的内容都基于在某个位置已经断住。</p>
<p>本文辅助说明程序如下:<br>testGdb.c</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;testGdb.c
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&quot;testGdb.h&quot;
int main(void)
&#123;
    int a &#x3D; 10; &#x2F;&#x2F;整型
    int b[] &#x3D; &#123;1,2,3,5&#125;;  &#x2F;&#x2F;数组
    char c[] &#x3D; &quot;hello,shouwang&quot;;&#x2F;&#x2F;字符数组
    &#x2F;*申请内存，失败时退出*&#x2F;
    int *d &#x3D; (int*)malloc(a*sizeof(int));
    if(NULL &#x3D;&#x3D; d)
    &#123;
        printf(&quot;malloc error\n&quot;);
        return -1;
    &#125;
    &#x2F;*赋值*&#x2F;
    for(int i&#x3D;0; i &lt; 10;i++)
    &#123;
        d[i] &#x3D; i;
    &#125;
    free(d);
    d &#x3D; NULL;
    float e &#x3D; 8.5f;
    return 0;
&#125;</code></pre>

<p>testGdb.h</p>
<pre class="language-none"><code class="language-none">int a &#x3D; 11;</code></pre>

<p>编译：</p>
<pre class="language-none"><code class="language-none">$ gcc -g -o testGdb testGdb.o</code></pre>

<h2 id="普通变量查看"><a href="#普通变量查看" class="headerlink" title="普通变量查看"></a>普通变量查看</h2><h4 id="打印基本类型变量，数组，字符数组"><a href="#打印基本类型变量，数组，字符数组" class="headerlink" title="打印基本类型变量，数组，字符数组"></a>打印基本类型变量，数组，字符数组</h4><p>最常见的使用便是使用 print（可简写为 p）打印变量内容。<br>例如，打印基本类型，数组，字符数组等直接使用 p 变量名即可：</p>
<pre class="language-none"><code class="language-none">(gdb) p a
$1 &#x3D; 10
(gdb) p b
$2 &#x3D; &#123;1, 2, 3, 5&#125;
(gdb) p c
$3 &#x3D; &quot;hello,shouwang&quot;
(gdb)</code></pre>

<p>当然有时候，多个函数或者多个文件会有同一个变量名，这个时候可以在前面加上函数名或者文件名来区分：</p>
<pre class="language-none"><code class="language-none">(gdb) p &#39;testGdb.h&#39;::a
$1 &#x3D; 11
(gdb) p &#39;main&#39;::b
$2 &#x3D; &#123;1, 2, 3, 5&#125;
(gdb)</code></pre>

<p>这里所打印的 a 值是我们定义在 testGdb.h 文件里的，而 b 值是 main 函数中的 b。</p>
<h4 id="打印指针指向内容"><a href="#打印指针指向内容" class="headerlink" title="打印指针指向内容"></a>打印指针指向内容</h4><p>如果还是使用上面的方式打印指针指向的内容，那么打印出来的只是指针地址而已，例如：</p>
<pre class="language-none"><code class="language-none">(gdb) p d
$1 &#x3D; (int *) 0x602010
(gdb)</code></pre>

<p>而如果想要打印指针指向的内容，需要解引用：</p>
<pre class="language-none"><code class="language-none">(gdb) p *d
$2 &#x3D; 0
(gdb) p *d@10
$3 &#x3D; &#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9&#125;
(gdb)</code></pre>

<p>从上面可以看到，仅仅使用*只能打印第一个值，如果要打印多个值，后面跟上@并加上要打印的长度。<br>或者@后面跟上变量值：</p>
<pre class="language-none"><code class="language-none">(gdb) p *d@a
$2 &#x3D; &#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9&#125;
(gdb)</code></pre>

<p>由于 a 的值为 10，并且是作为整型指针数据长度，因此后面可以直接跟着 a，也可以打印出所有内容。</p>
<p>另外值得一提的是，$可表示上一个变量，而假设此时有一个链表 linkNode，它有 next 成员代表下一个节点，则可使用下面方式不断打印链表内容：</p>
<pre class="language-none"><code class="language-none">(gdb) p *linkNode
(这里显示linkNode节点内容)
(gdb) p *$.next
(这里显示linkNode节点下一个节点的内容)</code></pre>

<p>如果想要查看前面数组的内容，你可以将下标一个一个累加，还可以定义一个类似 UNIX 环境变量，例如：</p>
<pre class="language-none"><code class="language-none">(gdb) set $index&#x3D;0
(gdb) p b[$index++]
$11 &#x3D; 1
(gdb) p b[$index++]
$12 &#x3D; 2
(gdb) p b[$index++]
$13 &#x3D; 3</code></pre>

<p>这样就不需要每次修改下标去打印啦。</p>
<h2 id="按照特定格式打印变量"><a href="#按照特定格式打印变量" class="headerlink" title="按照特定格式打印变量"></a>按照特定格式打印变量</h2><p>对于简单的数据，print 默认的打印方式已经足够了，它会根据变量类型的格式打印出来，但是有时候这还不够，我们需要更多的格式控制。常见格式控制字符如下：</p>
<ul>
<li>x 按十六进制格式显示变量。</li>
<li>d 按十进制格式显示变量。</li>
<li>u 按十六进制格式显示无符号整型。</li>
<li>o 按八进制格式显示变量。</li>
<li>t 按二进制格式显示变量。</li>
<li>a 按十六进制格式显示变量。</li>
<li>c 按字符格式显示变量。</li>
<li>f 按浮点数格式显示变量。</li>
</ul>
<p>还是以辅助程序来说明，正常方式打印字符数组 c：</p>
<pre class="language-none"><code class="language-none">(gdb) p c
$18 &#x3D; &quot;hello,shouwang&quot;</code></pre>

<p>但是如果我们要查看它的十六进制格式打印呢？</p>
<pre class="language-none"><code class="language-none">(gdb) p&#x2F;x c
$19 &#x3D; &#123;0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x73, 0x68, 0x6f, 0x75, 0x77, 0x61,
  0x6e, 0x67, 0x0&#125;
(gdb)</code></pre>

<p>但是如果我们想用这种方式查看浮点数的二进制格式是怎样的是不行的，因为直接打印它首先会被转换成整型，因此最终会得到 8：</p>
<pre class="language-none"><code class="language-none">(gdb) p e
$1 &#x3D; 8.5
(gdb) p&#x2F;t e
$2 &#x3D; 1000
(gdb)</code></pre>

<p>那么就需要另外一种查看方式了。</p>
<h2 id="查看内存内容"><a href="#查看内存内容" class="headerlink" title="查看内存内容"></a>查看内存内容</h2><p>examine(简写为 x)可以用来查看内存地址中的值。语法如下：</p>
<pre class="language-none"><code class="language-none">x&#x2F;[n][f][u] addr</code></pre>

<p>其中：</p>
<ul>
<li>n 表示要显示的内存单元数，默认值为 1</li>
<li>f 表示要打印的格式，前面已经提到了格式控制字符</li>
<li>u 要打印的单元长度</li>
<li>addr 内存地址</li>
</ul>
<p>单元类型常见有如下：</p>
<ul>
<li>b 字节</li>
<li>h 半字，即双字节</li>
<li>w 字，即四字节</li>
<li>g 八字节</li>
</ul>
<p>我们通过一个实例来看，假如我们要把 float 变量 e 按照二进制方式打印，并且打印单位是一字节：</p>
<pre class="language-none"><code class="language-none">(gdb) x&#x2F;4tb &amp;e
0x7fffffffdbd4:    00000000    00000000    00001000    01000001
(gdb)</code></pre>

<p>可以看到，变量 e 的四个字节都以二进制的方式打印出来了。</p>
<h2 id="自动显示变量内容"><a href="#自动显示变量内容" class="headerlink" title="自动显示变量内容"></a>自动显示变量内容</h2><p>假设我们希望程序断住时，就显示某个变量的值，可以使用 display 命令。</p>
<pre class="language-none"><code class="language-none">(gdb) display e
1: e &#x3D; 8.5</code></pre>

<p>那么每次程序断住时，就会打印 e 的值。要查看哪些变量被设置了 display，可以使用：</p>
<pre class="language-none"><code class="language-none">(gdb)info display
Auto-display expressions now in effect:
Num Enb Expression
1:   y  b
2:   y  e</code></pre>

<p>如果想要清除可以使用</p>
<pre class="language-none"><code class="language-none">delete display num #num为前面变量前的编号,不带num时清除所有。</code></pre>

<p>或者去使能：</p>
<pre class="language-none"><code class="language-none">disable display num  #num为前面变量前的编号，不带num时去使能所有</code></pre>

<h2 id="查看寄存器内容"><a href="#查看寄存器内容" class="headerlink" title="查看寄存器内容"></a>查看寄存器内容</h2><pre class="language-none"><code class="language-none">(gdb)info registers
rax            0x0    0
rbx            0x0    0
rcx            0x7ffff7dd1b00    140737351850752
rdx            0x0    0
rsi            0x7ffff7dd1b30    140737351850800
rdi            0xffffffff    4294967295
rbp            0x7fffffffdc10    0x7fffffffdc10
(内容过多未显示完全)</code></pre>

<h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>通过不同方式查看变量值或者内存值能够极大的帮助我们判断程序的运行是否符合我们的预期，如果发现观察的值不是我们预期的时候，就需要检查我们的代码了。</p>
<h1 id="单步调试"><a href="#单步调试" class="headerlink" title="单步调试"></a>单步调试</h1><h2 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h2><p>前面通过《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/01/08/62137.html">启动调试</a>》，《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/02/24/44483.html">断点设置</a>》，《<a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/03/10/50132.html">变量查看</a>》,我们已经了解了 GDB 基本的启动，设置断点，查看变量等，如果这些内容你还不知道，建议先回顾一下前面的内容。在启动调试设置断点观察之后，没有我们想要的信息怎么办呢？这个时候，就需要单步执行或者跳过当前断点继续执行等等。而本文所说的单步调试并非仅仅指单步执行，而是指在你的控制之下，按要求执行语句。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>老规矩，先准备一个示例程序如下：</p>
<pre class="language-none"><code class="language-none">&#x2F;*gdbStep.c*&#x2F;
#include&lt;stdio.h&gt;
&#x2F;*计算简单乘法,这里没有考虑溢出*&#x2F;
int add(int a, int b)
&#123;
    int c &#x3D; a + b;
    return c;
&#125;
&#x2F;*打印从0到num-1的数*&#x2F;
int count(int num)
&#123;
    int i &#x3D; 0;
    if(0 &gt; num)
        return 0;
    while(i &lt; num)
    &#123;
        printf(&quot;%d\n&quot;,i);
        i++;
    &#125;
    return i;
&#125;
int main(void)
&#123;
    int a &#x3D; 3;
    int b &#x3D; 7;
    printf(&quot;it will calc a + b\n&quot;);
    int c &#x3D; add(a,b);
    printf(&quot;%d + %d &#x3D; %d\n&quot;,a,b,c);
    count(c);
    return 0;
&#125;</code></pre>

<p>编译：</p>
<pre class="language-none"><code class="language-none">gcc -g -o gdbStep gdbStep.c</code></pre>

<p>程序的功能比较简单，这里不多做解释。</p>
<p>特别简单说明一条命令，list（可简写为 l），它可以将源码列出来，例如：</p>
<pre class="language-none"><code class="language-none">(gdb) list
1    #include&lt;stdio.h&gt;
2
3    &#x2F;*计算简单乘法,这里没有考虑溢出*&#x2F;
4    int add(int a, int b)
5    &#123;
6        int c &#x3D; a * b;
7        return c;
8    &#125;
9    int main(void)
10    &#123;
(gdb) l
11        int a &#x3D; 13;
12        int b &#x3D; 57;
13        printf(&quot;it will calc a * b\n&quot;);
14        int c &#x3D; add(a,b);
15        printf(&quot;%d*%d &#x3D; %d\n&quot;,a,b,c);
16        return 0;
17    &#125;
(gdb)</code></pre>

<h2 id="单步执行-next"><a href="#单步执行-next" class="headerlink" title="单步执行-next"></a>单步执行-next</h2><p>next 命令（可简写为 n）用于在程序断住后，继续执行下一条语句，假设已经启动调试，并在第 12 行停住，如果要继续执行，则使用 n 执行下一条语句，如果后面跟上数字 num，则表示执行该命令 num 次，就达到继续执行 n 行的效果了：</p>
<pre class="language-none"><code class="language-none">$ gdb gdbStep   #启动调试
(gdb)b 25       #将断点设置在12行
(gdb)run        #运行程序
Breakpoint 1, main () at gdbStep.c:25
25        int b &#x3D; 7;
(gdb) n     #单步执行
26        printf(&quot;it will calc a + b\n&quot;);
(gdb) n 2   #执行两次
it will calc a + b
28        printf(&quot;%d + %d &#x3D; %d\n&quot;,a,b,c);
(gdb)</code></pre>

<p>从上面的执行结果可以看到，我们在 25 行处断住，执行 n 之后，运行到 26 行，运行 n 2 之后，运行到 28 行，但是有没有发现一个问题，为什么不会进入到 add 函数内部呢？那就需要用到另外一个命令啦。</p>
<h2 id="单步进入-step"><a href="#单步进入-step" class="headerlink" title="单步进入-step"></a>单步进入-step</h2><p>对于上面的情况，如果我们想跟踪 add 函数内部的情况，可以使用 step 命令（可简写为 s），它可以单步跟踪到函数内部，但前提是该函数有调试信息并且有源码信息。</p>
<pre class="language-none"><code class="language-none">$ gdb gdbStep    #启动调试
(gdb) b 25       #在12行设置断点
Breakpoint 1 at 0x4005d3: file gdbStep.c, line 25.
(gdb) run        #运行程序
Breakpoint 1, main () at gdbStep.c:25
25        int b &#x3D; 7;
(gdb) s
26        printf(&quot;it will calc a + b\n&quot;);
(gdb) s     #单步进入，但是并没有该函数的源文件信息
_IO_puts (str&#x3D;0x4006b8 &quot;it will calc a + b&quot;) at ioputs.c:33
33    ioputs.c: No such file or directory.
(gdb) finish    #继续完成该函数调用
Run till exit from #0  _IO_puts (str&#x3D;0x4006b8 &quot;it will calc a + b&quot;)
    at ioputs.c:33
it will calc a + b
main () at gdbStep.c:27
27        int c &#x3D; add(a,b);
Value returned is $1 &#x3D; 19
(gdb) s        #单步进入，现在已经进入到了add函数内部
add (a&#x3D;13, b&#x3D;57) at gdbStep.c:6
6        int c &#x3D; a + b;</code></pre>

<p>从上面的过程可以看到，s 命令会尝试进入函数，但是如果没有该函数源码，需要跳过该函数执行，可使用 finish 命令，继续后面的执行。如果没有函数调用，s 的作用与 n 的作用并无差别，仅仅是继续执行下一行。它后面也可以跟数字，表明要执行的次数。</p>
<p>当然它还有一个选项，用来设置当遇到没有调试信息的函数，s 命令是否跳过该函数，而执行后面的。默认情况下，它是会跳过的，即 step-mode 值是 off：</p>
<pre class="language-none"><code class="language-none">(gdb) show step-mode
Mode of the step operation is off.
(gdb) set step-mode on
(gdb) set step-mode off</code></pre>

<p>还有一个与 step 相关的命令是 stepi（可简写为 si），它与 step 不同的是，每次执行一条机器指令：</p>
<pre class="language-none"><code class="language-none">(gdb) si
0x0000000000400573    6        int c &#x3D; a + b;
(gdb) display&#x2F;i $pc
1: x&#x2F;i $pc
&#x3D;&gt; 0x400573 &lt;add+13&gt;:    mov    -0x18(%rbp),%eax
(gdb)</code></pre>

<h2 id="继续执行到下一个断点-continue"><a href="#继续执行到下一个断点-continue" class="headerlink" title="继续执行到下一个断点-continue"></a>继续执行到下一个断点-continue</h2><p>我们可能打了多处断点，或者断点打在循环内，这个时候，想跳过这个断点，甚至跳过多次断点继续执行该怎么做呢？可以使用 continue 命令（可简写为 c）或者 fg，它会继续执行程序，直到再次遇到断点处：</p>
<pre class="language-none"><code class="language-none">$ gdb gdbStep
(gdb)b 18    #在count函数循环内打断点
(gdb)run
Breakpoint 1, count (num&#x3D;10) at gdbStep.c:18
18            i++;
(gdb) c      #继续运行，直到下一次断住
Continuing.
1

Breakpoint 1, count (num&#x3D;10) at gdbStep.c:18
18            i++;
(gdb) fg     #继续运行，直到下一次断住
Continuing.
2

Breakpoint 1, count (num&#x3D;10) at gdbStep.c:18
18            i++;
(gdb) c 3    #跳过三次
Will ignore next 2 crossings of breakpoint 1.  Continuing.
3
4
5

Breakpoint 1, count (num&#x3D;10) at gdbStep.c:18
18            i++;</code></pre>

<h2 id="继续运行到指定位置-until"><a href="#继续运行到指定位置-until" class="headerlink" title="继续运行到指定位置-until"></a>继续运行到指定位置-until</h2><p>假如我们在 25 行停住了，现在想要运行到 29 行停住，就可以使用 until 命令（可简写为 u）：</p>
<pre class="language-none"><code class="language-none">$ gdb gdbStep
(gdb)b 25
(gdb)run
(gdb) u 29
it will calc a + b
3 + 7 &#x3D; 10
main () at gdbStep.c:29
29        count(c);
(gdb)</code></pre>

<p>可以看到，在执行 u 29 之后，它在 29 行停住了。它利用的是临时断点。</p>
<h2 id="跳过执行—skip"><a href="#跳过执行—skip" class="headerlink" title="跳过执行—skip"></a>跳过执行—skip</h2><p>skip 可以在 step 时跳过一些不想关注的函数或者某个文件的代码:</p>
<pre class="language-c" data-language="c"><code class="language-c">$ gdb <span class="token function">gdbStep</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b <span class="token number">27</span>
Breakpoint <span class="token number">1</span> at <span class="token number">0x4005e4</span><span class="token operator">:</span> file gdbStep<span class="token punctuation">.</span>c<span class="token punctuation">,</span> line <span class="token number">27.</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> skip function add    #step时跳过add函数
Function add will be skipped when stepping<span class="token punctuation">.</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> info skip   #查看step情况
Num     Type           Enb What
<span class="token number">1</span>       function       y   <span class="token function">add</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> run
Starting program<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>hyb<span class="token operator">/</span>workspaces<span class="token operator">/</span>gdb<span class="token operator">/</span>gdbStep
it will calc a <span class="token operator">+</span> b

Breakpoint <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> at gdbStep<span class="token punctuation">.</span>c<span class="token operator">:</span><span class="token number">27</span>
<span class="token number">27</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> s
<span class="token number">28</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d + %d = %d\n"</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span></code></pre>

<p>可以看到，再使用 skip 之后，使用 step 将不会进入 add 函数。<br>step 也后面也可以跟文件：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span>skip file gdbStep<span class="token punctuation">.</span>c</code></pre>

<p>这样 gdbStep.c 中的函数都不会进入。</p>
<p>其他相关命令：</p>
<ul>
<li>skip delete [num] 删除 skip</li>
<li>skip enable [num] 使能 skip</li>
<li>skip disable [num] 去使能 skip</li>
</ul>
<p>其中 num 是前面通过 info skip 看到的 num 值，上面可以带或不带该值，如果不带 num，则针对所有 skip，如果带上了，则只针对某一个 skip。</p>
<h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>本文主要介绍了一些简单情况的单步调试方法或常见命令使用，但这些已经够用了，毕竟大部分程序的执行或停止都在我们的掌控之中了。</p>
<h1 id="源码查看"><a href="#源码查看" class="headerlink" title="源码查看"></a>源码查看</h1><h2 id="前言-4"><a href="#前言-4" class="headerlink" title="前言"></a>前言</h2><p>我们在调试过程中难免要对照源码进行查看，如果已经开始了调试，而查看源码或者编辑源码却要另外打开一个窗口，那未免显得太麻烦。文本将会介绍如何在 GDB 调试模式下<strong>查看源码或对源码进行编辑</strong>。</p>
<h2 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h2><p>为了说明后面的内容，我们先准备一些源码，分别是 main.c：</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;main.c
#include&lt;stdio.h&gt;
#include&quot;test.h&quot;
int main(void)
&#123;
    printf(&quot;it will print from 5 to 1\n&quot;);
    printNum(5);
    printf(&quot;print end\n&quot;);

    printf(&quot;it will print 1 to 5\n&quot;);
    printNum1(5);
    printf(&quot;print end\n&quot;);
    return 0;
&#125;</code></pre>

<p>头文件 test.h：</p>
<pre class="language-none"><code class="language-none">#ifndef _TEST_H
#define _TEST_H
#include&lt;stdio.h&gt;
void printNum(int n);
void printNum1(int n);
#endif</code></pre>

<p>以及 test.c:</p>
<pre class="language-none"><code class="language-none">#include&quot;test.h&quot;
void printNum(int n)
&#123;
    if( n &lt; 0)
        return;
    while(n &gt; 0)
    &#123;
        printf(&quot;%d\n&quot;,n);
        n--;
    &#125;
&#125;

void printNum1(int n)
&#123;
    if( n &lt; 0)
        return;
    int i &#x3D; 1;
    while(i &lt;&#x3D; n)
    &#123;
        printf(&quot;%d\n&quot;,i);
        i++;
    &#125;
&#125;</code></pre>

<p>编译运行：</p>
<pre class="language-none"><code class="language-none">$ gcc -g  -o main  main.c test.c
$ chmod +x main
$ .&#x2F;main
it will print from 5 to 1
5
4
3
2
1
print end
it will print 1 to 5
1
2
3
4
5
print end</code></pre>

<p>程序功能比较简单，用来打印 5 到 1 的数以及 1 到 5 的数，这里也就不多做解释。</p>
<h2 id="列出源码"><a href="#列出源码" class="headerlink" title="列出源码"></a>列出源码</h2><p>首先要介绍的就是 list 命令（可简写为 l），它用来打印源码。</p>
<h4 id="直接打印源码"><a href="#直接打印源码" class="headerlink" title="直接打印源码"></a>直接打印源码</h4><p>例如：</p>
<pre class="language-none"><code class="language-none">$ gdb main
(gdb) l
1    &#x2F;&#x2F;main.c
2    #include&lt;stdio.h&gt;
3    #include&quot;test.h&quot;
4    int main(void)
5    &#123;
6        printf(&quot;it will print from 5 to 1\n&quot;);
7        printNum(5);
8        printf(&quot;print end\n&quot;);
9
10        printf(&quot;it will print 1 to 5\n&quot;);
(gdb)</code></pre>

<p>直接输入 l 可从第一行开始显示源码，继续输入 l，可列出后面的源码。后面也可以跟上+或者-，分别表示要列出上一次列出源码的后面部分或者前面部分。</p>
<h4 id="列出指定行附近源码"><a href="#列出指定行附近源码" class="headerlink" title="列出指定行附近源码"></a>列出指定行附近源码</h4><p>l 后面可以跟行号，表明要列出附近的源码：</p>
<pre class="language-none"><code class="language-none">(gdb) l 9
4    int main(void)
5    &#123;
6        printf(&quot;it will print from 5 to 1\n&quot;);
7        printNum(5);
8        printf(&quot;print end\n&quot;);
9
10        printf(&quot;it will print 1 to 5\n&quot;);
11        printNum1(5);
12        printf(&quot;print end\n&quot;);
13        return 0;</code></pre>

<p>在这里，l 后面跟上 9，表明要列出第 9 行附近的源码。</p>
<h4 id="列出指定函数附近的源码"><a href="#列出指定函数附近的源码" class="headerlink" title="列出指定函数附近的源码"></a>列出指定函数附近的源码</h4><p>这个很容易理解，而使用也很简单，l 后面跟函数名即可，例如：</p>
<pre class="language-none"><code class="language-none">(gdb) l printNum
1    #include&quot;test.h&quot;
2    void printNum(int n)
3    &#123;
4        if( n &lt; 0)
5            return;
6        while(n &gt; 0)
7        &#123;
8            printf(&quot;%d\n&quot;,n);
9            n--;
10        &#125;</code></pre>

<p>在这里，l 后面跟上函数名 printNum，它便列出了 printNum 函数附近的源码。</p>
<h4 id="设置源码一次列出行数"><a href="#设置源码一次列出行数" class="headerlink" title="设置源码一次列出行数"></a>设置源码一次列出行数</h4><p>不知道你有没有发现，在列出函数源码的时候，它并没有列全，因为 l 每次只显示 10 行，那么有没有方法每次列出更多呢？<br>我们可以通过 listsize 属性来设置，例如设置每次列出 20 行：</p>
<pre class="language-none"><code class="language-none">(gdb) set listsize 20
(gdb) show listsize
Number of source lines gdb will list by default is 20.</code></pre>

<p>这样每次就会列出 20 行，当然也可以设置为 0 或者 unlimited，这样设置之后，列出就没有限制了，但源码如果较长，查看将会不便。</p>
<h4 id="列出指定行之间的源码"><a href="#列出指定行之间的源码" class="headerlink" title="列出指定行之间的源码"></a>列出指定行之间的源码</h4><p>list first,last<br>例如，要列出 3 到 15 行之间的源码：</p>
<pre class="language-none"><code class="language-none">(gdb) l 3,15
3    &#123;
4        if( n &lt; 0)
5            return;
6        while(n &gt; 0)
7        &#123;
8            printf(&quot;%d\n&quot;,n);
9            n--;
10        &#125;
11    &#125;
12
13    void printNum1(int n)
14    &#123;
15        if( n &lt; 0)</code></pre>

<p>启始行和结束行号之间用逗号隔开。两者之一也可以省略，例如：</p>
<pre class="language-none"><code class="language-none">(gdb) list 3,
3    &#123;
4        if( n &lt; 0)
5            return;
6        while(n &gt; 0)
7        &#123;
8            printf(&quot;%d\n&quot;,n);
9            n--;
10        &#125;
11    &#125;
12</code></pre>

<p>省略结束行的时候，它列出从开始行开始，到指定大小行结束，而省略开始行的时候，到结束行结束，列出设置的大小行，例如默认设置为 10 行，则到结束行为止，总共列出 10 行。前面我们也介绍了修改和查看默认列出源码行数的方法。</p>
<h4 id="列出指定文件的源码"><a href="#列出指定文件的源码" class="headerlink" title="列出指定文件的源码"></a>列出指定文件的源码</h4><p>前面执行 l 命令时，默认列出 main.c 的源码，如果想要看指定文件的源码呢？可以</p>
<pre class="language-none"><code class="language-none">l location</code></pre>

<p>其中 location 可以是<strong>文件名加行号或函数名</strong>，因此可以使用：</p>
<pre class="language-none"><code class="language-none">(gdb) l test.c:1
1    #include&quot;test.h&quot;
2    void printNum(int n)
3    &#123;
4        if( n &lt; 0)
5            return;
6        while(n &gt; 0)
7        &#123;
8            printf(&quot;%d\n&quot;,n);
9            n--;
10        &#125;
(gdb)</code></pre>

<p>来查看指定文件指定行，或者指定文件指定函数：</p>
<pre class="language-none"><code class="language-none">(gdb) l test.c:printNum1
9            n--;
10        &#125;
11    &#125;
12
13    void printNum1(int n)
14    &#123;
15        if( n &lt; 0)
16            return;
17        int i &#x3D; 1;
18        while(i &lt;&#x3D; n)
(gdb)</code></pre>

<p>或者指定文件指定行之间：</p>
<pre class="language-none"><code class="language-none">(gdb) l test.c:1,test.c:3
1    #include&quot;test.h&quot;
2    void printNum(int n)
3    &#123;
(gdb)</code></pre>

<h2 id="指定源码路径"><a href="#指定源码路径" class="headerlink" title="指定源码路径"></a>指定源码路径</h2><p>在查看源码之前，首先要确保我们的程序能够关联到源码，一般来说，我们在自己的机器上加上-g 参数编译完之后，使用 gdb 都能查看到源码，但是如果出现下面的情况呢？</p>
<h4 id="源码被移走"><a href="#源码被移走" class="headerlink" title="源码被移走"></a>源码被移走</h4><p>例如，我现在将 main.c 移动到当前的 temp 目录下，再执行 l 命令：</p>
<pre class="language-none"><code class="language-none">(gdb) l
1    main.c: No such file or directory.
(gdb)</code></pre>

<p>它就会提示找不到源码文件了，那么怎么办呢？<br>我们可以使用 dir 命名指定源码路径，例如：</p>
<pre class="language-none"><code class="language-none">(gdb) dir .&#x2F;temp
Source directories searched: &#x2F;home&#x2F;hyb&#x2F;workspaces&#x2F;gdb&#x2F;sourceCode&#x2F;.&#x2F;temp:$cdir:$cwd</code></pre>

<p>这个时候它就能找到源码路径了。我这里使用的是相对路径，保险起见，你也可以使用绝对路径。</p>
<h4 id="更换源码目录"><a href="#更换源码目录" class="headerlink" title="更换源码目录"></a>更换源码目录</h4><p>例如，你编译好的程序文件，放到了另外一台机器上进行调试，或者你的源码文件全都移动到了另外一个目录，怎么办呢？当然你还可以使用前面的方法添加源码搜索路径，也可以使用 set substitute-path from to 将原来的路径替换为新的路径，那么我们如何知道原来的源码路径是什么呢？借助 readelf 命令可以知道：</p>
<pre class="language-none"><code class="language-none">$ readelf main -p .debug_str
  [     0]  long unsigned int
  [    12]  short int
  [    1c]  &#x2F;home&#x2F;hyb&#x2F;workspaces&#x2F;gdb&#x2F;sourceCode
  [    40]  main.c
（显示部分内容）</code></pre>

<p>main 为你将要调试的程序名，这里我们可以看到原来的路径，那么我们现在替换掉它：</p>
<pre class="language-none"><code class="language-none">(gdb) set substitute-path &#x2F;home&#x2F;hyb&#x2F;workspaces&#x2F;gdb&#x2F;sourceCode &#x2F;home&#x2F;hyb&#x2F;workspaces&#x2F;gdb&#x2F;sourceCode&#x2F;temp
(gdb) show substitute-path
List of all source path substitution rules:
  &#96;&#x2F;home&#x2F;hyb&#x2F;workspaces&#x2F;gdb&#x2F;sourceCode&#39; -&gt; &#96;&#x2F;home&#x2F;hyb&#x2F;workspaces&#x2F;gdb&#x2F;sourceCode&#x2F;temp&#39;.
(gdb)</code></pre>

<p>设置完成后，可以通过 show substitute-path 来查看设置结果。这样它也能在正确的路径查找源码啦。</p>
<p>需要注意的是，这里<strong>对路径做了字符串替换</strong>，那么如果你有多个路径，可以做多个替换。甚至可以对指定文件路径进行替换。</p>
<p>最后你也可以通过 unset substitute-path [path]取消替换。</p>
<h2 id="编辑源码"><a href="#编辑源码" class="headerlink" title="编辑源码"></a>编辑源码</h2><p>为了避免已经启动了调试之后，需要编辑源码，又不想退出，可以直接在 gdb 模式下编辑源码，它默认使用的编辑器是&#x2F;bin&#x2F;ex，但是你的机器上可能没有这个编辑器，或者你想使用自己熟悉的编辑器，那么可以通过下面的方式进行设置：</p>
<pre class="language-none"><code class="language-none">$ EDITOR&#x3D;&#x2F;usr&#x2F;bin&#x2F;vim
$ export EDITOR</code></pre>

<p>&#x2F;usr&#x2F;bin&#x2F;vim 可以替换为你熟悉的编辑器的路径，如果你不知道你的编辑器在什么位置，可借助 whereis 命令或者 witch 命令查看：</p>
<pre class="language-none"><code class="language-none">$ whereis vim
vim: &#x2F;usr&#x2F;bin&#x2F;vim &#x2F;usr&#x2F;bin&#x2F;vim.tiny &#x2F;usr&#x2F;bin&#x2F;vim.basic &#x2F;usr&#x2F;bin&#x2F;vim.gnome &#x2F;etc&#x2F;vim &#x2F;usr&#x2F;share&#x2F;vim &#x2F;usr&#x2F;share&#x2F;man&#x2F;man1&#x2F;vim.1.gz
$ which vim
&#x2F;usr&#x2F;bin&#x2F;vim</code></pre>

<p>设置之后，就可以在 gdb 调试模式下进行编辑源码了，使用命令 edit location，例如：</p>
<pre class="language-none"><code class="language-none">(gdb)edit 3  #编辑第三行
(gdb)edit printNum #编辑printNum函数
(gdb)edit test.c:5 #编辑test.c第五行</code></pre>

<p>可自行尝试，这里的 location 和前面介绍的一样，可以跟指定文件的特定行或指定文件的指定函数。<br>编辑完保存后，别忘了重新编译程序：</p>
<pre class="language-none"><code class="language-none">(gdb)shell gcc -g -o main main.c test.c</code></pre>

<p>这里要注意，为了在 gdb 调试模式下执行 shell 命令，需要在命令之前加上 shell，表明这是一条 shell 命令。这样就能在不用退出 GDB 调试模式的情况下编译程序了。</p>
<h2 id="另外一种模式"><a href="#另外一种模式" class="headerlink" title="另外一种模式"></a>另外一种模式</h2><p>启动时，带上 tui(Text User Interface)参数，会有意想不到的效果，它会将调试在多个文本窗口呈现：</p>
<pre class="language-none"><code class="language-none">gdb main -tui</code></pre>

<p><a target="_blank" rel="noopener" href="https://github.com/yanbinghu/BlogImages/raw/master/articles/GDB%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97-%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B/gdb-tui.png"><img data-src="//img.to2b.cn/blog/lujinkai/1656387574358.png"></a></p>
<p>但是本文不作介绍，有兴趣的可以探索一下。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E9%98%B2%E7%81%AB%E5%A2%99/nft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E9%98%B2%E7%81%AB%E5%A2%99/nft/" class="post-title-link" itemprop="url">nft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:56:07" itemprop="dateCreated datePublished" datetime="2020-12-09T23:56:07+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E9%98%B2%E7%81%AB%E5%A2%99/" itemprop="url" rel="index"><span itemprop="name">防火墙</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>相关文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Main_Page">https://wiki.nftables.org/wiki-nftables/index.php/Main_Page</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Nftables_families">https://wiki.nftables.org/wiki-nftables/index.php/Nftables_families</a></li>
<li><code>man nft</code></li>
</ul>
<p>nftables 和 iptables 一样，依赖的底层机制都是 Netfilter，但是 nftables 各个方面都比 iptables 更优秀，未来一定会成为主流，所以有必要好好学习。</p>
<h2 id="升级-nftables"><a href="#升级-nftables" class="headerlink" title="升级 nftables"></a>升级 nftables</h2><p>CentOS8 自带的 nftables 版本是 0.9.3，而官网最新的版本是 0.9.6，所以需要先升级：</p>
<ol>
<li><p>卸载系统自带的 nftables</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$yum</span> remove nftables.x86_64
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-qa</span> <span class="token operator">|</span> <span class="token function">grep</span> ntf
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span>$</code></pre>
</li>
<li><p>去官网下载最新版本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 官网：http://netfilter.org/projects/nftables/downloads.html</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/src/
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">bzip2</span>
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$tar</span> jxvf nftables-0.9.6.tar.bz2
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">844</span>
drwxr-xr-x. <span class="token number">10</span> lujinkai lujinkai   <span class="token number">4096</span> Jun <span class="token number">15</span> <span class="token number">16</span>:24 nftables-0.9.6
-rw-r--r--.  <span class="token number">1</span> root     root     <span class="token number">859481</span> Sep <span class="token number">27</span> 06:49 nftables-0.9.6.tar.bz2</code></pre>
</li>
<li><p>安装</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$cd</span> nftables-0.9.6/
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /usr/local/nftables
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span>$./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nftables
<span class="token punctuation">..</span>.
<span class="token comment"># 报错，缺少libmnl依赖</span>
checking <span class="token keyword">for</span> LIBMNL<span class="token punctuation">..</span>. no
configure: error: Package requirements <span class="token punctuation">(</span>libmnl <span class="token operator">>=</span> <span class="token number">1.0</span>.4<span class="token punctuation">)</span> were not met:
<span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token comment"># 安装libmnl参考：https://centos.pkgs.org/8/centos-baseos-x86_64/libmnl-1.0.4-6.el8.x86_64.rpm.html</span>
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable">$dnf</span> <span class="token function">install</span> libmnl
<span class="token comment"># 安装libmnl-devel参考：https://centos.pkgs.org/8/centos-powertools-x86_64/libmnl-devel-1.0.4-6.el8.x86_64.rpm.html</span>
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable">$dnf</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>PowerTools <span class="token function">install</span> libmnl-devel
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable">$ldconfig</span>
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span>$./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nftables
<span class="token punctuation">..</span>.
<span class="token comment"># 报错，缺少libnftnl依赖</span>
checking <span class="token keyword">for</span> LIBNFTNL<span class="token punctuation">..</span>. no
configure: error: Package requirements <span class="token punctuation">(</span>libnftnl <span class="token operator">>=</span> <span class="token number">1.1</span>.7<span class="token punctuation">)</span> were not met:

No package <span class="token string">'libnftnl'</span> found

Consider adjusting the PKG_CONFIG_PATH environment variable <span class="token keyword">if</span> you
installed software <span class="token keyword">in</span> a non-standard prefix.

Alternatively, you may <span class="token builtin class-name">set</span> the environment variables LIBNFTNL_CFLAGS
and LIBNFTNL_LIBS to avoid the need to call pkg-config.
See the pkg-config <span class="token function">man</span> page <span class="token keyword">for</span> <span class="token function">more</span> details.
<span class="token punctuation">..</span>.
<span class="token comment"># 上面的libmnl通过dnf安装，这个libnftnl就通过编译安装吧，从nftables官网下载最新的libnftnl源码包</span>
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable">$cd</span> <span class="token punctuation">..</span>
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$tar</span> jxvf libnftnl-1.1.7.tar.bz2
<span class="token punctuation">[</span>root@centos8 src<span class="token punctuation">]</span><span class="token variable">$cd</span> libnftnl-1.1.7/
<span class="token punctuation">[</span>root@centos8 libnftnl-1.1.7<span class="token punctuation">]</span>$./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/libnftnl-1.1.7
<span class="token punctuation">[</span>root@centos8 libnftnl-1.1.7<span class="token punctuation">]</span><span class="token variable">$make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token punctuation">..</span>.
<span class="token comment"># 根据提示，要指定libnftnl的lib和include，这个要查看具体的pkg-config文件</span>
<span class="token comment"># vim /usr/local/libnftnl-1.1.7/lib/pkgconfig/libnftnl.pc</span>
<span class="token comment"># ...</span>
<span class="token comment"># 15 Libs: -L$&#123;libdir&#125; -lnftnl</span>
<span class="token comment"># 16 Cflags: -I$&#123;includedir&#125;</span>
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable"><span class="token variable">$(</span><span class="token assign-left variable">LIBNFTNL_CFLAGS</span><span class="token operator">=</span>-I/usr/local/libnftnl-1.1.7/include/ <span class="token assign-left variable">LIBNFTNL_LIBS</span><span class="token operator">=</span><span class="token string">"-L/usr/local/libnftnl-1.1.7/lib/ -lnftnl"</span> ./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nftables<span class="token variable">)</span></span>
<span class="token punctuation">..</span>.
<span class="token comment"># 报错，缺少libgmb依赖</span>
checking <span class="token keyword">for</span> <span class="token for-or-select variable">__gmpz_init</span> <span class="token keyword">in</span> -lgmp<span class="token punctuation">..</span>. no
configure: error: No suitable version of libgmp found
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> gmp gmp-devel
<span class="token comment"># 继续</span>
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span>$./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nftables
<span class="token punctuation">..</span>.
<span class="token comment"># 缺少 libreadline 依赖</span>
checking <span class="token keyword">for</span> <span class="token for-or-select variable">readline</span> <span class="token keyword">in</span> -lreadline<span class="token punctuation">..</span>. no
configure: error: No suitable version of libreadline found
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span><span class="token variable">$dnf</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> readline readline-devel
<span class="token punctuation">[</span>root@centos8 nftables-0.9.6<span class="token punctuation">]</span>$./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nftables
<span class="token comment"># 安装成功</span>
nft configuration:
  cli support:                  readline
  <span class="token builtin class-name">enable</span> debugging symbols:     <span class="token function">yes</span>
  use mini-gmp:                 no
  <span class="token builtin class-name">enable</span> <span class="token function">man</span> page:              <span class="token function">yes</span>
  libxtables support:           no
  json output support:          no
  <span class="token builtin class-name">enable</span> Python:                no</code></pre>
</li>
<li><p>配置 systemctl</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /usr/lib/systemd/system/nftables.service
<span class="token comment"># 从另一台机器上拷贝一份yum安装自动生成的nftables.service文件，稍作改动</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Netfilter Tables
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:nft<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-pre.target
<span class="token assign-left variable">Before</span><span class="token operator">=</span>network-pre.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>oneshot
<span class="token assign-left variable">ProtectSystem</span><span class="token operator">=</span>full
<span class="token assign-left variable">ProtectHome</span><span class="token operator">=</span>true
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/nftables/sbin/nft <span class="token parameter variable">-f</span> /usr/local/nftables/etc/nftables/all-in-one.nft
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/usr/local/nftables/sbin/nft <span class="token string">'flush ruleset; include "/usr/local/nftables/etc/nftables/all-in-one.nft";'</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/nftables/sbin/nft flush ruleset
<span class="token assign-left variable">RemainAfterExit</span><span class="token operator">=</span>yes

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token comment"># 设置开机自启</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> nftables.service</code></pre>
</li>
<li><p>配置环境变量</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将 /usr/local/nftables/sbin 添加到PATH（位于/etc/profile）</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/nftables/sbin:/usr/local/nginx/sbin:<span class="token environment constant">$PATH</span>
<span class="token comment"># 重载</span>
<span class="token builtin class-name">.</span> /etc/profile</code></pre></li>
</ol>
<h2 id="nftables-和-iptables-的区别"><a href="#nftables-和-iptables-的区别" class="headerlink" title="nftables 和 iptables 的区别"></a>nftables 和 iptables 的区别</h2><ol>
<li>1</li>
<li>2</li>
<li>3</li>
<li>…</li>
</ol>
<h2 id="nf-和-xt"><a href="#nf-和-xt" class="headerlink" title="nf* 和 xt*"></a>nf* 和 xt*</h2><p>nf* 是 netfilter 的缩写，nf_ 前缀的模块是 netfilter 的核心模块（以下称 nf 模块），nftables 之前，netfilter 提供了 iptables、ip6tables、arptables 等用户空间工具，xtables 就是这些工具的统称，缩写为 xt。可能是为了便于理解或者什么理由，专为 xtables 开发的模块以 xt*前缀命名（以下称 xt 模块），当然，xtables 也可以调用 nf 模块。</p>
<p>安装 iptables 后，会生成&#x2F;usr&#x2F;lib64&#x2F;xtables&#x2F;目录，目录下就是各种 xt 模块。</p>
<p>xtables 既能调用 xt 模块，也能调用 nf 模块，为了方便我们把 xt 模块和 nf 模块统称为扩展。</p>
<p>现在，这些 xtables 工具被认为是<a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Legacy_xtables_tools">过时</a>的，推荐使用 nftables，nftables 是 xtables 的全面替代品，nftables 调用的都是 nf 模块，所以安装后自然也不会生成 &#x2F;usr&#x2F;lib64&#x2F;xtables&#x2F;目录。</p>
<p><strong>因为并没有找到参考资料，以上都是个人理解和猜测，说的不一定准确。</strong></p>
<h2 id="表（Tables）"><a href="#表（Tables）" class="headerlink" title="表（Tables）"></a>表（Tables）</h2><p>与 iptables 类似，在 nftables 中，<strong>表</strong>是<strong>链</strong>的容器，nftables 不包含任何的表和链，所以开始使用 nftables 时，首先需要添加至少一个表，然后向表里添加链，然后往链里添加规则。</p>
<h3 id="地址簇与钩子函数"><a href="#地址簇与钩子函数" class="headerlink" title="地址簇与钩子函数"></a>地址簇与钩子函数</h3><p>什么是地址族？<br>地址族：又叫地址簇，AF，Address；不要太纠结这个名称，可以认为就是 地址类型。<br>另外，还有协议族：又叫协议簇，PF，Protocol Family；协议族等价于地址族。</p>
<p>netfilter 中六个勾子函数（hook），前面 iptables 章节一节已经介绍过了，这里再说一遍，六个钩子函数是：</p>
<pre class="language-none"><code class="language-none">INGRESS、PREROUTING、INPUT、OUTPUT、FORWARD、POSTROUTING</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1600853967007.png"></p>
<h3 id="添加表"><a href="#添加表" class="headerlink" title="添加表"></a>添加表</h3><p>语法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft <span class="token punctuation">&#123;</span>add <span class="token operator">|</span> create<span class="token punctuation">&#125;</span> table <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span></code></pre>

<ul>
<li><p><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Nftables_families">family</a>：表支持的地址类型，有六种，每个表只能指定一种，默认是 ip，表示 IPv4</p>
<table>
<thead>
<tr>
<th>family</th>
<th>表示的地址族</th>
<th>iptables 中对应的命令行工具</th>
</tr>
</thead>
<tbody><tr>
<td>ip</td>
<td>IPv4 地址</td>
<td>iptables</td>
</tr>
<tr>
<td>ip6</td>
<td>IPv6 地址</td>
<td>ip6tables</td>
</tr>
<tr>
<td>inet</td>
<td>IPv4 和 IPv6 地址</td>
<td>iptables 和 ip6tables</td>
</tr>
<tr>
<td>arp</td>
<td>地址解析协议(ARP)地址</td>
<td>arptables</td>
</tr>
<tr>
<td>bridge</td>
<td>处理桥接数据包</td>
<td>ebtables</td>
</tr>
<tr>
<td>netdev</td>
<td>内核 4.2 之后可用。只能使用 ingress 钩子，在路由之前进行过滤，可以替代<code>tc</code>命令</td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加一个 IPv4 的 foo 表</span>
nft <span class="token function">add</span> table <span class="token function">ip</span> foo
<span class="token comment"># 添加一个 IPv6 的 bar 表</span>
nft <span class="token function">add</span> table ip6 bar</code></pre>

<h3 id="列出表"><a href="#列出表" class="headerlink" title="列出表"></a>列出表</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出所有表</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list tables
table <span class="token function">ip</span> foo
table ip6 bar
<span class="token comment"># 列出一个或多个地址族的所有表，注意这时是tables</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list tables <span class="token function">ip</span>
table <span class="token function">ip</span> foo
<span class="token comment"># 列出一个表中的所有链</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list table <span class="token function">ip</span> foo
table <span class="token function">ip</span> foo <span class="token punctuation">&#123;</span>	<span class="token comment"># 目前表中还没链</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> delete table ip6 bar</code></pre>

<p>说明：内核 3.18 以前，需要先清空表中的内容，再删除表</p>
<h3 id="清空表"><a href="#清空表" class="headerlink" title="清空表"></a>清空表</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清空表中所有链中的所有规则</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> flush table <span class="token function">ip</span> foo</code></pre>

<h2 id="链（Chains）"><a href="#链（Chains）" class="headerlink" title="链（Chains）"></a>链（Chains）</h2><p>ntfables 没有内置的链，所有的链都需要手动创建，链有两种类型：基本类型和常规类型。<br>其中基本类型又分类三类：filter、nat、route</p>
<ul>
<li><p>基本链：base chains，数据包的入口，需要指定钩子函数和优先级，类似 iptables 中的内置链</p>
<table>
<thead>
<tr>
<th>type</th>
<th>表</th>
<th>钩子函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>filter</td>
<td>all</td>
<td>all</td>
<td>过滤</td>
</tr>
<tr>
<td>nat</td>
<td>ip、ip6、inet</td>
<td>prerouting、input、output、postrouting</td>
<td>地址转换，第一个包总是命中这个链，因此不要用此链进行过滤</td>
</tr>
<tr>
<td>route</td>
<td>ip、ip6</td>
<td>output</td>
<td>策略路由选择器，等价于 iptables 中的 mangle 表，但是仅用于 output 钩子函数</td>
</tr>
</tbody></table>
</li>
<li><p>常规链：regular chains，不需要指定钩子函数和优先级，可以用来做跳转，从逻辑上对规则进行分类，类似 iptables 中的自定义类</p>
</li>
</ul>
<h3 id="创建链"><a href="#创建链" class="headerlink" title="创建链"></a>创建链</h3><p>语法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建常规链</span>
nft <span class="token function">add</span> chain <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span>
<span class="token comment"># 创建基本链</span>
nft <span class="token function">add</span> chain <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span> <span class="token punctuation">&#123;</span>type <span class="token operator">&lt;</span>type<span class="token operator">></span> hook <span class="token operator">&lt;</span>hook<span class="token operator">></span> <span class="token punctuation">[</span>device <span class="token operator">&lt;</span>device<span class="token operator">></span><span class="token punctuation">]</span> priority <span class="token operator">&lt;</span>priority<span class="token operator">></span><span class="token punctuation">;</span> <span class="token punctuation">[</span>policy <span class="token operator">&lt;</span>policy<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></code></pre>

<ul>
<li><p>type：可以选择 filter、nat、route</p>
</li>
<li><p>hook：钩子函数，六个钩子函数，只能指定一个，不同的表 family 支持不同的钩子函数：</p>
<table>
<thead>
<tr>
<th>family</th>
<th>hook</th>
</tr>
</thead>
<tbody><tr>
<td>ip、ip6、inet</td>
<td>prerouting、input、forward、output、postrouting</td>
</tr>
<tr>
<td>arp</td>
<td>input、output</td>
</tr>
<tr>
<td>bridge</td>
<td>prerouting、input、forward、output、postrouting</td>
</tr>
<tr>
<td>netdev</td>
<td>ingress</td>
</tr>
</tbody></table>
<p>小总结：netdev 只支持 ingress + filter 一种组合；arp 支持 { input | output } + filter 两种组合</p>
</li>
<li><p>device：netdev 表只存在于每个传入接口，所以它需要指定 device 参数</p>
</li>
<li><p>priority：优先级，可以接受 整数值 或者 标准优先级名。整数值可以为负，数值越低优先级越高；有以下数值可以选择</p>
<ul>
<li>NF_IP_PRI_CONNTRACK_DEFRAG (-400): priority of defragmentation</li>
<li>NF_IP_PRI_RAW (-300): traditional priority of the raw table placed before connection tracking operation</li>
<li>NF_IP_PRI_SELINUX_FIRST (-225): SELinux operations</li>
<li>NF_IP_PRI_CONNTRACK (-200): Connection tracking operations</li>
<li>NF_IP_PRI_MANGLE (-150): mangle operation</li>
<li>NF_IP_PRI_NAT_DST (-100): destination NAT</li>
<li>NF_IP_PRI_FILTER (0): filtering operation, the filter table</li>
<li>NF_IP_PRI_SECURITY (50): Place of security table where secmark can be set for example</li>
<li>NF_IP_PRI_NAT_SRC (100): source NAT</li>
<li>NF_IP_PRI_SELINUX_LAST (225): SELinux at packet exit</li>
<li>NF_IP_PRI_CONNTRACK_HELPER (300): connection tracking at exit</li>
</ul>
</li>
<li><p>policy：链的策略，支持的策略值是 accept、drop，默认是 accept</p>
</li>
</ul>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加常规链</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> <span class="token function">add</span> chain <span class="token function">ip</span> foo chain_1
<span class="token comment"># 添加基本链</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> <span class="token function">add</span> chain <span class="token function">ip</span> foo chain_2 <span class="token punctuation">&#123;</span>type filter hook input priority <span class="token number">0</span><span class="token punctuation">\</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>

<h3 id="列出链"><a href="#列出链" class="headerlink" title="列出链"></a>列出链</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出一个表中的所有链</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list table <span class="token function">ip</span> foo
table <span class="token function">ip</span> foo <span class="token punctuation">&#123;</span>
        chain chain_1 <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>

        chain chain_2 <span class="token punctuation">&#123;</span>
                <span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># 列出一个链中的所有规则</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list chain <span class="token function">ip</span> foo chain_1
table <span class="token function">ip</span> foo <span class="token punctuation">&#123;</span>
        chain chain_1 <span class="token punctuation">&#123;</span>	<span class="token comment"># 目前链中还没有规则</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list chain <span class="token function">ip</span> foo chain_2
table <span class="token function">ip</span> foo <span class="token punctuation">&#123;</span>
        chain chain_2 <span class="token punctuation">&#123;</span>	<span class="token comment"># 目前链中还没有规则</span>
                <span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="编辑链"><a href="#编辑链" class="headerlink" title="编辑链"></a>编辑链</h3><p>把添加链语法的 add 或者 create 关键字去掉，就是编辑链的语法</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑常规链</span>
nft chain <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span>
<span class="token comment"># 编辑基本链</span>
nft chain <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span>type <span class="token operator">&lt;</span>type<span class="token operator">></span> hook <span class="token operator">&lt;</span>hook<span class="token operator">></span> <span class="token punctuation">[</span>device <span class="token operator">&lt;</span>device<span class="token operator">></span><span class="token punctuation">]</span> priority <span class="token operator">&lt;</span>priority<span class="token operator">></span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>policy policy <span class="token punctuation">;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将chain_1链策略从accept更改为drop</span>
nft chain <span class="token function">ip</span> foo chain_1 <span class="token punctuation">&#123;</span> policy drop <span class="token punctuation">\</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></code></pre>

<h3 id="删除链"><a href="#删除链" class="headerlink" title="删除链"></a>删除链</h3><p>要删除的链不能包含任何规则或者跳转目标。</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> delete chain <span class="token function">ip</span> foo chain_1
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list table <span class="token function">ip</span> foo
table <span class="token function">ip</span> foo <span class="token punctuation">&#123;</span>
        chain chain_2 <span class="token punctuation">&#123;</span>
                <span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="清空链"><a href="#清空链" class="headerlink" title="清空链"></a>清空链</h3><p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清空chain_2链中的所有规则</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> flush chain <span class="token function">ip</span> foo chain_2</code></pre>

<h2 id="规则（Rules）"><a href="#规则（Rules）" class="headerlink" title="规则（Rules）"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Quick_reference-nftables_in_10_minutes">规则（Rules）</a></h2><h3 id="iptables-和-nftables-的区别"><a href="#iptables-和-nftables-的区别" class="headerlink" title="iptables 和 nftables 的区别"></a>iptables 和 nftables 的区别</h3><p>参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/dog250/article/details/41526421?locationNum=8">https://blog.csdn.net/dog250/article/details/41526421?locationNum=8</a></p>
<h4 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h4><p>iptables 是由表、链、规则组成，其中规则又由 match、target 组成。</p>
<p>iptables 的规则是按照配置顺序顺序匹配的，在每一张表的每一个链上依次匹配每一条规则，在每一条规则依次匹配每一个 match，全部匹配的 match 执行该规则的 target，由 target 决定：</p>
<ul>
<li>继续匹配下一条规则</li>
<li>对数据包做一些修改</li>
<li>跳转到其它的链(即开始从该链依次匹配该链上的每一条规则)</li>
<li>返回引发跳转的链(即继续匹配跳转前的链的下一条规则)</li>
<li>丢弃数据包</li>
<li>接收数据包(即不再继续往下匹配，直接返回)</li>
<li>记录日志</li>
<li>…</li>
</ul>
<p>整个 iptables 框架的执行流程如下：</p>
<pre class="language-c" data-language="c"><code class="language-c">循环<span class="token number">1</span><span class="token operator">:</span>
	<span class="token keyword">static</span> breakrule <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	遍历一个chain的每一条rule <span class="token punctuation">&#123;</span>
	nomatch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	循环<span class="token number">2</span><span class="token operator">:</span>遍历一条rule的每一个match <span class="token punctuation">&#123;</span>
			result <span class="token operator">=</span> rule<span class="token operator">-></span>match<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> MATCH<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				nomatch <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>nomatch <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">continue</span>该chain的下一条rule<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	result <span class="token operator">=</span> rule<span class="token operator">-></span><span class="token function">target</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> DROP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>丢弃数据包
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> ACCEPT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>接受数据包
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> GOTO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		breakrule <span class="token operator">=</span> rule<span class="token punctuation">;</span>
		跳转到相应的chain，执行循环<span class="token number">1</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> RETURN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>返回调用chain，执行其breakrule的下一条rule
	<span class="token punctuation">&#125;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>可以发现，包过滤的流程最终要落实到规则匹配，而过滤的动作最终落实到了该规则的 target，前面的所有的 match 匹配返回结果就是 0 或者非 0 表示是否匹配，只有所有的 match 均匹配，才会执行 target。这也就导致了如果你想实现多个 target，就不得不写多条规则。</p>
<h4 id="nftables"><a href="#nftables" class="headerlink" title="nftables"></a>nftables</h4><p>nftables 的规则去掉了“匹配所有的 match 之后执行一个 target”这样的限制，使一条规则真的成了“为一个数据包做一些事情”这样灵活的命令。我们来看一下 nftables 框架的执行流程：</p>
<pre class="language-c" data-language="c"><code class="language-c">循环<span class="token number">1</span><span class="token operator">:</span>
	<span class="token keyword">static</span> breakrule <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	遍历一个chain的每一条rule <span class="token punctuation">&#123;</span>
	nomatch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	reg<span class="token punctuation">[</span>MAX<span class="token punctuation">]</span>
	循环<span class="token number">2</span><span class="token operator">:</span>遍历一条rule的每一个expression <span class="token punctuation">&#123;</span>
			<span class="token keyword">void</span> rule<span class="token operator">-></span>expression<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token operator">-></span>operations<span class="token operator">-></span><span class="token function">expr</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> info<span class="token punctuation">,</span> reg<span class="token punctuation">)</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>reg<span class="token punctuation">[</span>VERDICT<span class="token punctuation">]</span> <span class="token operator">!=</span> CONTINUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">[</span>VERDICT<span class="token punctuation">]</span> <span class="token operator">==</span> CONTINUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">continue</span>该chain的下一条rule<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">[</span>VERDICT<span class="token punctuation">]</span> <span class="token operator">==</span> DROP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>丢弃数据包
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">[</span>VERDICT<span class="token punctuation">]</span> <span class="token operator">==</span> ACCEPT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>接受数据包
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">[</span>VERDICT<span class="token punctuation">]</span> <span class="token operator">==</span> GOTO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		breakrule <span class="token operator">=</span> rule<span class="token punctuation">;</span>
		跳转到相应的chain，执行循环<span class="token number">1</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">[</span>VERDICT<span class="token punctuation">]</span> <span class="token operator">==</span> RETURN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>调用chain，执行其breakrule的下一条rule
	<span class="token punctuation">&#125;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>可以看到，nftables 没有 match 和 target，而是将一条 rule 抽象成了若干条的表达式，即 expression，所谓的表达式就是一个主语加谓词的式子，它是“可执行”的，它可以“做任何事情”，而不仅仅是计算一个匹配结果。除此之外，nftables 内置了一组寄存器，其中之一是 verdict 寄存器，它指示了“下一步要怎么做”。每一条 expression 执行完了之后，会取出该寄存器，由该寄存器的值来采取下一步的行动。这个 verdict 寄存器替换了 iptables 中 target 返回值，这就可以在一条 rule 中采取多个动作，每条动作可以解析成一个 expression，只要每一个 expression 在执行后将 verdict 寄存器设置为 CONTINUE 即可。</p>
<p>除了执行流程的显著区别之外，nftables 最大的意义在于它对 expression 进行了抽象，nftables 的内核框架可以注册很多种的 expression，其中 expr 回调函数执行具体的 expression 表达式。</p>
<h3 id="表达式-expression"><a href="#表达式-expression" class="headerlink" title="表达式 expression"></a>表达式 expression</h3><p>规则由表达式组成，表达式有匹配表达式，和动作表达式两种，但官方文档不是这么划分的，而是分成表达式和语句，其实表达式就是匹配表达式，语句就是动作表达式，下文如果没有特别说明，采用的是官方的说法。</p>
<p>例如规则：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> saddr <span class="token number">10.1</span>.1.1 tcp dport <span class="token function">ssh</span> accept</code></pre>

<p>就是由<code>ip sadd</code>、<code>tcp dpor</code>两条表达式和<code>accept</code>一条语句组成</p>
<p><strong>每个表达式都有一个数据类型</strong></p>
<h4 id="describe"><a href="#describe" class="headerlink" title="describe"></a>describe</h4><p>describe 命令可以显示表达式 或 数据类型的信息</p>
<p>语法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出表达式的信息</span>
describe <span class="token operator">&lt;</span>expression<span class="token operator">></span>
<span class="token comment"># 列出数据类型的信息</span>
describe <span class="token operator">&lt;</span>datatype<span class="token operator">></span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># describe &lt;expression></span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> describe ct state
ct expression, datatype ct_state <span class="token punctuation">(</span>conntrack state<span class="token punctuation">)</span> <span class="token punctuation">(</span>basetype bitmask, integer<span class="token punctuation">)</span>, <span class="token number">32</span> bits

pre-defined symbolic constants <span class="token punctuation">(</span>in hexadecimal<span class="token punctuation">)</span>:
        invalid                         0x00000001
        new                             0x00000008
        established                     0x00000002
        related                         0x00000004
        untracked                       0x00000040
<span class="token comment"># describe &lt;datatype></span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> describe ct_state
datatype ct_state <span class="token punctuation">(</span>conntrack state<span class="token punctuation">)</span> <span class="token punctuation">(</span>basetype bitmask, integer<span class="token punctuation">)</span>, <span class="token number">32</span> bits

pre-defined symbolic constants <span class="token punctuation">(</span>in hexadecimal<span class="token punctuation">)</span>:
        invalid                         0x00000001
        new                             0x00000008
        established                     0x00000002
        related                         0x00000004
        untracked                       0x00000040
<span class="token comment"># describe &lt;expression></span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> describe tcp dport
payload expression, datatype inet_service <span class="token punctuation">(</span>internet network <span class="token function">service</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>basetype integer<span class="token punctuation">)</span>, <span class="token number">16</span> bits
<span class="token comment"># describe &lt;datatype></span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> describe inet_service
datatype inet_service <span class="token punctuation">(</span>internet network <span class="token function">service</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>basetype integer<span class="token punctuation">)</span>, <span class="token number">16</span> bits</code></pre>

<h4 id="datatype"><a href="#datatype" class="headerlink" title="datatype"></a><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#DATA_TYPES">datatype</a></h4><p>数据类型分级别，全局数据类型是最低阶的，有 integer、string 两种，高阶的数据类型从低阶的派生而来，例如：bitmask 从 integer 派生而来，ct_state 从 bitmask 派生而来。</p>
<p>大部分数据类型固定长度，少部分不固定。</p>
<p>一些高阶的数据类型具有预定义的符号常量，例如：boolean 类型，固定 size 1bit，取值 0 或 1，预定义了 exists 和 missing 两个字符常量，会被自动替换为 1 和 0；</p>
<ul>
<li>integer：用于数值，可以指定为十进制、十六进制或八进制，没有固定大小</li>
<li>string：用于字符串，以字母开头，此外，双引号内的任何内容都被认为是字符串</li>
<li>bitmask：用于位掩码，基于 integer，至于什么是位掩码，自行百度或参考文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148827170">什么是掩码 BitMask</a></li>
<li>boolean：用于布尔值，固定 size 1bit</li>
<li>inet_service：用于服务端口，固定 size 16bit</li>
<li>ipv4_addr：用于 IPv4 地址，固定 size 32bit，预定义字符常量 localhost</li>
<li>icmp_type：用于 ICMP 类型，固定 size 8bit，取值 0-18，预定义了 echo-reply、echo-request 等 19 个字符常量，会被自动替换为 0-18</li>
<li>链接跟踪<ul>
<li>ct_state</li>
<li>ct_status</li>
<li>…</li>
</ul>
</li>
<li>…</li>
</ul>
<h4 id="expression"><a href="#expression" class="headerlink" title="expression"></a>expression</h4><p>分为主表达式和有效负载表达式，不知道有什么区别，看起来好像在一条规则中，主表达式的位置在有效负载表达式的前面。</p>
<p>以下是对所有表达式做一个全面但简略的记录，详细信息参考：<a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8">https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8</a></p>
<h5 id="PRIMARY-EXPRESSIONS"><a href="#PRIMARY-EXPRESSIONS" class="headerlink" title="PRIMARY EXPRESSIONS"></a><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#PRIMARY_EXPRESSIONS">PRIMARY EXPRESSIONS</a></h5><ul>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#META_EXPRESSIONS">meta 表达式</a></p>
<p>meta 就是数据包的元数据，元表达式有限定和非限定两种，限定不能省略 meta 关键字，非限定则可以省略</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># mete 关键字不可省略</span>
meta <span class="token punctuation">&#123;</span>length <span class="token operator">|</span> nfproto <span class="token operator">|</span> l4proto <span class="token operator">|</span> protocol <span class="token operator">|</span> priority<span class="token punctuation">&#125;</span>
<span class="token comment"># meta 关键字可以省略</span>
<span class="token punctuation">[</span>meta<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>mark <span class="token operator">|</span> iif <span class="token operator">|</span> iifname <span class="token operator">|</span> iiftype <span class="token operator">|</span> oif <span class="token operator">|</span> oifname <span class="token operator">|</span> oiftype <span class="token operator">|</span> skuid <span class="token operator">|</span> skgid <span class="token operator">|</span> nftrace <span class="token operator">|</span> rtclassid <span class="token operator">|</span> ibrname <span class="token operator">|</span> obrname <span class="token operator">|</span> pkttype <span class="token operator">|</span> cpu <span class="token operator">|</span> iifgroup <span class="token operator">|</span> oifgroup <span class="token operator">|</span> cgroup <span class="token operator">|</span> random <span class="token operator">|</span> ipsec <span class="token operator">|</span> iifkind <span class="token operator">|</span> oifkind <span class="token operator">|</span> <span class="token function">time</span> <span class="token operator">|</span> hour <span class="token operator">|</span> day <span class="token punctuation">&#125;</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> describe meta iif
meta expression, datatype iface_index <span class="token punctuation">(</span>network interface index<span class="token punctuation">)</span> <span class="token punctuation">(</span>basetype integer<span class="token punctuation">)</span>, <span class="token number">32</span> bits
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> describe meta oif
meta expression, datatype iface_index <span class="token punctuation">(</span>network interface index<span class="token punctuation">)</span> <span class="token punctuation">(</span>basetype integer<span class="token punctuation">)</span>, <span class="token number">32</span> bits
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> describe meta iifname
meta expression, datatype ifname <span class="token punctuation">(</span>network interface name<span class="token punctuation">)</span> <span class="token punctuation">(</span>basetype string<span class="token punctuation">)</span>, <span class="token number">16</span> characters</code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#SOCKET_EXPRESSION">socket 表达式</a></p>
<p>套接字表达式用于搜索已打开的 TCP&#x2F;UDP 套接字，及其与数据包关联的属性</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">socket <span class="token punctuation">&#123;</span>transparent <span class="token operator">|</span> mark<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#OSF_EXPRESSION">osf 表达式</a></p>
<p>被动操作系统指纹识别。此表达式将数据包中的某些数据（窗口大小、MSS、选项及其顺序、DF 等）与 SYN 位集进行比较</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">osf <span class="token punctuation">[</span>ttl <span class="token punctuation">&#123;</span>loose <span class="token operator">|</span> skip<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>name <span class="token operator">|</span> version<span class="token punctuation">&#125;</span></code></pre>

<ul>
<li>ttl：对包进行 TTL 检查以确定操作系统</li>
<li>version：对包进行 OS 版本检查</li>
<li>name：要匹配的操作系统签名的名称。所有的签名都可以在 pf.os 文件中找到。对表达式无法检测到的操作系统签名使用“unknown”</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#FIB_EXPRESSIONS">fib 表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">fib <span class="token punctuation">&#123;</span>saddr <span class="token operator">|</span> daddr <span class="token operator">|</span> mark <span class="token operator">|</span> iif <span class="token operator">|</span> oif<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>. <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>oif <span class="token operator">|</span> oifname <span class="token operator">|</span> type<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#ROUTING_EXPRESSIONS">routing 表达式</a></p>
<p>路由表达式指的是与数据包关联的路由数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">rt <span class="token punctuation">[</span>ip <span class="token operator">|</span> ip6<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>classid <span class="token operator">|</span> nexthop <span class="token operator">|</span> mtu <span class="token operator">|</span> ipsec<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#IPSEC_EXPRESSIONS">ipsec 表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ipsec <span class="token punctuation">&#123;</span>in <span class="token operator">|</span> out<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span> spnum NUM <span class="token punctuation">]</span>  <span class="token punctuation">&#123;</span>reqid <span class="token operator">|</span> spi<span class="token punctuation">&#125;</span>
ipsec <span class="token punctuation">&#123;</span>in <span class="token operator">|</span> out<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span> spnum NUM <span class="token punctuation">]</span>  <span class="token punctuation">&#123;</span>ip <span class="token operator">|</span> ip6<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>saddr <span class="token operator">|</span> daddr<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#NUMGEN_EXPRESSION">numgen 表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">numgen <span class="token punctuation">&#123;</span>inc <span class="token operator">|</span> random<span class="token punctuation">&#125;</span> mod NUM <span class="token punctuation">[</span> offset NUM <span class="token punctuation">]</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#HASH_EXPRESSIONS">hash 表达式</a></p>
<p>使用一个哈希函数来生成一个数字。可用的函数是 jhash（Jenkins 散列）和 symhash（对称散列）。<br>jhash 和 symhash 的典型用例是负载均衡</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">jhash <span class="token punctuation">&#123;</span>ip saddr <span class="token operator">|</span> ip6 daddr <span class="token operator">|</span> tcp dport <span class="token operator">|</span> udp sport <span class="token operator">|</span> ether saddr<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>. <span class="token punctuation">..</span>.<span class="token punctuation">]</span> mod NUM <span class="token punctuation">[</span> seed NUM <span class="token punctuation">]</span> <span class="token punctuation">[</span> offset NUM <span class="token punctuation">]</span>

symhash mod NUM <span class="token punctuation">[</span> offset NUM <span class="token punctuation">]</span></code></pre></li>
</ul>
<h5 id="PRIMARY-EXPRESSIONS-1"><a href="#PRIMARY-EXPRESSIONS-1" class="headerlink" title="PRIMARY EXPRESSIONS"></a><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#PAYLOAD_EXPRESSIONS">PRIMARY EXPRESSIONS</a></h5><ul>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#ETHERNET_HEADER_EXPRESSION">以太网报头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ether <span class="token punctuation">&#123;</span>daddr <span class="token operator">|</span> saddr <span class="token operator">|</span> type<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#VLAN_HEADER_EXPRESSION">VLAN 头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">vlan <span class="token punctuation">&#123;</span>id <span class="token operator">|</span> cfi <span class="token operator">|</span> pcp <span class="token operator">|</span> type<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#ARP_HEADER_EXPRESSION">ARP 头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">arp <span class="token punctuation">&#123;</span>htype <span class="token operator">|</span> ptype <span class="token operator">|</span> hlen <span class="token operator">|</span> plen <span class="token operator">|</span> operation <span class="token operator">|</span> saddr <span class="token punctuation">&#123;</span> <span class="token function">ip</span> <span class="token operator">|</span> ether <span class="token punctuation">&#125;</span> <span class="token operator">|</span> daddr <span class="token punctuation">&#123;</span> <span class="token function">ip</span> <span class="token operator">|</span> ether <span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#IPV4_HEADER_EXPRESSION">IPV4 头表达</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> <span class="token punctuation">&#123;</span>version <span class="token operator">|</span> hdrlength <span class="token operator">|</span> dscp <span class="token operator">|</span> ecn <span class="token operator">|</span> length <span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> frag-off <span class="token operator">|</span> ttl <span class="token operator">|</span> protocol <span class="token operator">|</span> checksum <span class="token operator">|</span> saddr <span class="token operator">|</span> daddr <span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#ICMP_HEADER_EXPRESSION">ICMP 头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">icmp <span class="token punctuation">&#123;</span>type <span class="token operator">|</span> code <span class="token operator">|</span> checksum <span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> sequence <span class="token operator">|</span> gateway <span class="token operator">|</span> mtu<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#IGMP_HEADER_EXPRESSION">IGMP 头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">igmp <span class="token punctuation">&#123;</span>type <span class="token operator">|</span> mrt <span class="token operator">|</span> checksum <span class="token operator">|</span> group<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#IPV6_HEADER_EXPRESSION">IPV6 报头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ip6 <span class="token punctuation">&#123;</span>version <span class="token operator">|</span> dscp <span class="token operator">|</span> ecn <span class="token operator">|</span> flowlabel <span class="token operator">|</span> length <span class="token operator">|</span> nexthdr <span class="token operator">|</span> hoplimit <span class="token operator">|</span> saddr <span class="token operator">|</span> daddr<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#ICMPV6_HEADER_EXPRESSION">ICMPV6 头表达</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">icmpv6 <span class="token punctuation">&#123;</span>type <span class="token operator">|</span> code <span class="token operator">|</span> checksum <span class="token operator">|</span> parameter-problem <span class="token operator">|</span> packet-too-big <span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> sequence <span class="token operator">|</span> max-delay<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#TCP_HEADER_EXPRESSION">TCP 报头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">tcp <span class="token punctuation">&#123;</span>sport <span class="token operator">|</span> dport <span class="token operator">|</span> sequence <span class="token operator">|</span> ackseq <span class="token operator">|</span> doff <span class="token operator">|</span> reserved <span class="token operator">|</span> flags <span class="token operator">|</span> window <span class="token operator">|</span> checksum <span class="token operator">|</span> urgptr<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#UDP_HEADER_EXPRESSION">UDP 报头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">udp <span class="token punctuation">&#123;</span>sport <span class="token operator">|</span> dport <span class="token operator">|</span> length <span class="token operator">|</span> checksum<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#UDP_-LITE_HEADER_EXPRESSION">UDP-LITE 头表达</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">udplite <span class="token punctuation">&#123;</span>sport <span class="token operator">|</span> dport <span class="token operator">|</span> checksum<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#SCTP_HEADER_EXPRESSION">SCTP 头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">sctp <span class="token punctuation">&#123;</span>sport <span class="token operator">|</span> dport <span class="token operator">|</span> vtag <span class="token operator">|</span> checksum<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#DCCP_HEADER_EXPRESSION">DCCP 头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">dccp <span class="token punctuation">&#123;</span>sport <span class="token operator">|</span> dport<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#AUTHENTICATION_HEADER_EXPRESSION">验证标题表达</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ah <span class="token punctuation">&#123;</span>nexthdr <span class="token operator">|</span> hdrlength <span class="token operator">|</span> reserved <span class="token operator">|</span> spi <span class="token operator">|</span> sequence<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#ENCRYPTED_SECURITY_PAYLOAD_HEADER_EXPRESSION">加密的安全有效负载头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">esp <span class="token punctuation">&#123;</span>spi <span class="token operator">|</span> sequence<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#IPCOMP_HEADER_EXPRESSION">IPCOMP 头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">comp <span class="token punctuation">&#123;</span>nexthdr <span class="token operator">|</span> flags <span class="token operator">|</span> cpi<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#RAW_PAYLOAD_EXPRESSION">原始载荷表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#EXTENSION_HEADER_EXPRESSIONS">扩展头表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">hbh <span class="token punctuation">&#123;</span>nexthdr <span class="token operator">|</span> hdrlength<span class="token punctuation">&#125;</span>
frag <span class="token punctuation">&#123;</span>nexthdr <span class="token operator">|</span> frag-off <span class="token operator">|</span> more-fragments <span class="token operator">|</span> id<span class="token punctuation">&#125;</span>
rt <span class="token punctuation">&#123;</span>nexthdr <span class="token operator">|</span> hdrlength <span class="token operator">|</span> <span class="token builtin class-name">type</span> <span class="token operator">|</span> seg-left<span class="token punctuation">&#125;</span>
dst <span class="token punctuation">&#123;</span>nexthdr <span class="token operator">|</span> hdrlength<span class="token punctuation">&#125;</span>
mh <span class="token punctuation">&#123;</span>nexthdr <span class="token operator">|</span> hdrlength <span class="token operator">|</span> checksum <span class="token operator">|</span> type<span class="token punctuation">&#125;</span>
srh <span class="token punctuation">&#123;</span>flags <span class="token operator">|</span> tag <span class="token operator">|</span> sid <span class="token operator">|</span> seg-left<span class="token punctuation">&#125;</span>
tcp option <span class="token punctuation">&#123;</span>eol <span class="token operator">|</span> noop <span class="token operator">|</span> maxseg <span class="token operator">|</span> window <span class="token operator">|</span> sack-permitted <span class="token operator">|</span> sack <span class="token operator">|</span> sack0 <span class="token operator">|</span> sack1 <span class="token operator">|</span> sack2 <span class="token operator">|</span> sack3 <span class="token operator">|</span> timestamp<span class="token punctuation">&#125;</span> tcp_option_field
<span class="token function">ip</span> option <span class="token punctuation">&#123;</span> lsrr <span class="token operator">|</span> ra <span class="token operator">|</span> rr <span class="token operator">|</span> ssrr <span class="token punctuation">&#125;</span> ip_option_field
<span class="token comment">#</span>
exthdr <span class="token punctuation">&#123;</span>hbh <span class="token operator">|</span> frag <span class="token operator">|</span> rt <span class="token operator">|</span> dst <span class="token operator">|</span> mh<span class="token punctuation">&#125;</span>
tcp option <span class="token punctuation">&#123;</span>eol <span class="token operator">|</span> noop <span class="token operator">|</span> maxseg <span class="token operator">|</span> window <span class="token operator">|</span> sack-permitted <span class="token operator">|</span> sack <span class="token operator">|</span> sack0 <span class="token operator">|</span> sack1 <span class="token operator">|</span> sack2 <span class="token operator">|</span> sack3 <span class="token operator">|</span> timestamp<span class="token punctuation">&#125;</span>
<span class="token function">ip</span> option <span class="token punctuation">&#123;</span> lsrr <span class="token operator">|</span> ra <span class="token operator">|</span> rr <span class="token operator">|</span> ssrr <span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8#CONNTRACK_EXPRESSIONS">CONNTRACK 表达式</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct <span class="token punctuation">&#123;</span>state <span class="token operator">|</span> direction <span class="token operator">|</span> status <span class="token operator">|</span> mark <span class="token operator">|</span> expiration <span class="token operator">|</span> helper <span class="token operator">|</span> label<span class="token punctuation">&#125;</span>
ct <span class="token punctuation">[</span>original <span class="token operator">|</span> reply<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>l3proto <span class="token operator">|</span> protocol <span class="token operator">|</span> bytes <span class="token operator">|</span> packets <span class="token operator">|</span> avgpkt <span class="token operator">|</span> zone <span class="token operator">|</span> id<span class="token punctuation">&#125;</span>
ct <span class="token punctuation">&#123;</span>original <span class="token operator">|</span> reply<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>proto-src <span class="token operator">|</span> proto-dst<span class="token punctuation">&#125;</span>
ct <span class="token punctuation">&#123;</span>original <span class="token operator">|</span> reply<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>ip <span class="token operator">|</span> ip6<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>saddr <span class="token operator">|</span> daddr<span class="token punctuation">&#125;</span></code></pre></li>
</ul>
<h3 id="添加规则"><a href="#添加规则" class="headerlink" title="添加规则"></a>添加规则</h3><p>语法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft <span class="token punctuation">&#123;</span>add<span class="token operator">|</span>insert<span class="token punctuation">&#125;</span> rule <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span> <span class="token punctuation">[</span>handle <span class="token operator">&lt;</span>handle<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>expressions<span class="token operator">></span> <span class="token operator">&lt;</span>statements<span class="token operator">></span> <span class="token punctuation">[</span>comment <span class="token operator">&lt;</span>comment<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<ul>
<li>handle：规则句柄，句柄是不变的，除非规则被删除，这就为规则提供了稳定的索引。add 添加规则到句柄规则后面，insert 添加规则到句柄规则的前面。如果省略，add 默认添加规则到链末尾，insert 默认添加规则到链的开头</li>
<li>expression：负责匹配数据包</li>
<li>statement：负责对匹配的数据包做后续处理</li>
<li>comment：备注</li>
</ul>
<h4 id="expressions"><a href="#expressions" class="headerlink" title="expressions"></a>expressions</h4><p>expr 回调函数每处理完一条表达式，就修改 verdict 寄存器的值为 CONTINUE，继续处理下一条。</p>
<p>上文 expression 章节中的表达式总结的很全面，下面对常用的表达式做详细的说明：</p>
<h5 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h5><img data-src="//img.to2b.cn/blog/ljk/1600933365734.png" style="zoom:50%;" />

<p>上图是 IPv4 报头图，除了最后的可选字段，其他每个字段 matches 都可以匹配，下面挑常用的介绍，后面的 ip6、tcp、udp 等等，也都是只介绍常用的，这点就不再赘述：</p>
<ul>
<li><p>protocol <protocol>：上层协议</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> protocol tcp
<span class="token function">ip</span> protocol <span class="token number">6</span>
<span class="token function">ip</span> protocol <span class="token operator">!=</span> tcp
<span class="token function">ip</span> protocol <span class="token punctuation">&#123;</span> icmp, esp, ah, comp, udp, udplite, tcp, dccp, sctp <span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>saddr <ip source address>：Source IP Address</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ip</span> saddr <span class="token number">192.168</span>.2.0/24
<span class="token function">ip</span> saddr <span class="token operator">!=</span> <span class="token number">192.168</span>.2.0/24
<span class="token function">ip</span> saddr <span class="token number">192.168</span>.3.1 <span class="token function">ip</span> daddr <span class="token number">192.168</span>.3.100
<span class="token function">ip</span> saddr <span class="token operator">!=</span> <span class="token number">1.1</span>.1.1
<span class="token function">ip</span> saddr <span class="token number">1.1</span>.1.1
<span class="token function">ip</span> saddr <span class="token operator">&amp;</span> 0xff <span class="token operator">==</span> <span class="token number">1</span>
<span class="token function">ip</span> saddr <span class="token operator">&amp;</span> <span class="token number">0.0</span>.0.255 <span class="token operator">&lt;</span> <span class="token number">0.0</span>.0.127</code></pre>
</li>
<li><p>daddr <ip destination address>：Destination IP Address</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">
<span class="token function">ip</span> daddr <span class="token number">192.168</span>.0.1
<span class="token function">ip</span> daddr <span class="token operator">!=</span> <span class="token number">192.168</span>.0.1
<span class="token function">ip</span> daddr <span class="token number">192.168</span>.0.1-192.168.0.250
<span class="token function">ip</span> daddr <span class="token number">10.0</span>.0.0-10.255.255.255
<span class="token function">ip</span> daddr <span class="token number">172.16</span>.0.0-172.31.255.255
<span class="token function">ip</span> daddr <span class="token number">192.168</span>.3.1-192.168.4.250
<span class="token function">ip</span> daddr <span class="token operator">!=</span> <span class="token number">192.168</span>.0.1-192.168.0.250
<span class="token function">ip</span> daddr <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.0.1-192.168.0.250 <span class="token punctuation">&#125;</span>
<span class="token function">ip</span> daddr <span class="token punctuation">&#123;</span> <span class="token number">192.168</span>.5.1, <span class="token number">192.168</span>.5.2, <span class="token number">192.168</span>.5.3 <span class="token punctuation">&#125;</span></code></pre></li>
</ul>
<h5 id="Ip6"><a href="#Ip6" class="headerlink" title="Ip6"></a>Ip6</h5><p><img data-src="//img.to2b.cn/blog/ljk/1600934961736.png"></p>
<ul>
<li><p>flowlabel <label>：Flow Label，占 20 位，用来标记报文的数据流类型，以便在网络层区分不同的报文。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ip6 flowlabel <span class="token number">22</span>
ip6 flowlabel <span class="token operator">!=</span> <span class="token number">233</span>
ip6 flowlabel <span class="token punctuation">&#123;</span> <span class="token number">33</span>, <span class="token number">55</span>, <span class="token number">67</span>, <span class="token number">88</span> <span class="token punctuation">&#125;</span>
ip6 flowlabel <span class="token punctuation">&#123;</span> <span class="token number">33</span>-55 <span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>saddr <ip source address>：Source Address</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ip6 saddr <span class="token number">1234</span>:1234:1234:1234:1234:1234:1234:1234
ip6 saddr ::1234:1234:1234:1234:1234:1234:1234
ip6 saddr ::/64
ip6 saddr ::1 ip6 daddr ::2</code></pre>
</li>
<li><p>daddr <ip destination address>：Destination Address</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ip6 daddr <span class="token number">1234</span>:1234:1234:1234:1234:1234:1234:1234
ip6 daddr <span class="token operator">!=</span> ::1234:1234:1234:1234:1234:1234:1234-1234:1234::1234:1234:1234:1234:1234</code></pre></li>
</ul>
<h5 id="Tcp"><a href="#Tcp" class="headerlink" title="Tcp"></a>Tcp</h5><p><img data-src="//img.to2b.cn/blog/ljk/1600937199061.png"></p>
<ul>
<li><p>sport <source port>：Source port</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">tcp sport <span class="token number">22</span>
tcp sport <span class="token operator">!=</span> <span class="token number">33</span>-45
tcp sport <span class="token punctuation">&#123;</span> <span class="token number">33</span>, <span class="token number">55</span>, <span class="token number">67</span>, <span class="token number">88</span><span class="token punctuation">&#125;</span>
tcp sport <span class="token punctuation">&#123;</span> <span class="token number">33</span>-55<span class="token punctuation">&#125;</span>
tcp sport vmap <span class="token punctuation">&#123;</span> <span class="token number">25</span>:accept, <span class="token number">28</span>:drop <span class="token punctuation">&#125;</span>
tcp sport <span class="token number">1024</span> tcp dport <span class="token number">22</span></code></pre>
</li>
<li><p>dport <destination port>：Destination port</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">tcp dport <span class="token number">22</span>
tcp dport <span class="token operator">!=</span> <span class="token number">33</span>-45
tcp dport <span class="token punctuation">&#123;</span> <span class="token number">33</span>-55 <span class="token punctuation">&#125;</span>
tcp dport <span class="token punctuation">&#123;</span>telnet, ssh, http, https <span class="token punctuation">&#125;</span>
tcp dport vmap <span class="token punctuation">&#123;</span> <span class="token number">22</span> <span class="token builtin class-name">:</span> accept, <span class="token number">23</span> <span class="token builtin class-name">:</span> drop <span class="token punctuation">&#125;</span>
tcp dport vmap <span class="token punctuation">&#123;</span> <span class="token number">25</span>:accept, <span class="token number">28</span>:drop <span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>flags <flags>：TCP flags</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">tcp flags <span class="token punctuation">&#123;</span> fin, syn, rst, psh, ack, urg, ecn, cwr<span class="token punctuation">&#125;</span>
tcp flags cwr
tcp flags <span class="token operator">!=</span> cwr</code></pre></li>
</ul>
<h5 id="Udp"><a href="#Udp" class="headerlink" title="Udp"></a>Udp</h5><p><img data-src="//img.to2b.cn/blog/ljk/1600937935815.png"></p>
<ul>
<li>sport <source port>：Source port</li>
<li>dport <destination port>：Destination port</li>
</ul>
<h5 id="Udplite"><a href="#Udplite" class="headerlink" title="Udplite"></a>Udplite</h5><h5 id="Sctp"><a href="#Sctp" class="headerlink" title="Sctp"></a>Sctp</h5><h5 id="Dccp"><a href="#Dccp" class="headerlink" title="Dccp"></a>Dccp</h5><h5 id="Ah"><a href="#Ah" class="headerlink" title="Ah"></a>Ah</h5><h5 id="Esp"><a href="#Esp" class="headerlink" title="Esp"></a>Esp</h5><h5 id="Comp"><a href="#Comp" class="headerlink" title="Comp"></a>Comp</h5><h5 id="Icmp"><a href="#Icmp" class="headerlink" title="Icmp"></a>Icmp</h5><p><img data-src="//img.to2b.cn/blog/ljk/1600938679478.png"><br><img data-src="//img.to2b.cn/blog/ljk/1600938925363.png"></p>
<ul>
<li><p>type &lt;type&gt;：ICMP packet type，也可以写数值，例如<code>icmp type echo-reply</code>等价于<code>icmp type 0</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">icmp <span class="token builtin class-name">type</span> <span class="token punctuation">&#123;</span>echo-reply, destination-unreachable, source-quench, redirect, echo-request, time-exceeded, parameter-problem, timestamp-request, timestamp-reply, info-request, info-reply, address-mask-request, address-mask-reply, router-advertisement, router-solicitation<span class="token punctuation">&#125;</span>
icmp <span class="token builtin class-name">type</span> <span class="token number">8</span> reject <span class="token comment"># 禁止别人ping我</span></code></pre></li>
<li><p>code &lt;code&gt;：ICMP packet code</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">icmp code <span class="token number">111</span>
icmp code <span class="token operator">!=</span> <span class="token number">33</span>-55
icmp code <span class="token punctuation">&#123;</span> <span class="token number">2</span>, <span class="token number">4</span>, <span class="token number">54</span>, <span class="token number">33</span>, <span class="token number">56</span><span class="token punctuation">&#125;</span></code></pre></li>
<li><p>mtu <value>：ICMP packet mtu，最大传输单元</p>
</li>
<li><p>gateway <value>：ICMP packet gateway</p>
</li>
</ul>
<h5 id="Icmpv6"><a href="#Icmpv6" class="headerlink" title="Icmpv6"></a>Icmpv6</h5><h5 id="Ether"><a href="#Ether" class="headerlink" title="Ether"></a>Ether</h5><h5 id="Dst"><a href="#Dst" class="headerlink" title="Dst"></a>Dst</h5><h5 id="Frag"><a href="#Frag" class="headerlink" title="Frag"></a>Frag</h5><h5 id="Hbh"><a href="#Hbh" class="headerlink" title="Hbh"></a>Hbh</h5><h5 id="Mh"><a href="#Mh" class="headerlink" title="Mh"></a>Mh</h5><h5 id="Rt"><a href="#Rt" class="headerlink" title="Rt"></a>Rt</h5><h5 id="Vlan"><a href="#Vlan" class="headerlink" title="Vlan"></a>Vlan</h5><h5 id="Arp"><a href="#Arp" class="headerlink" title="Arp"></a>Arp</h5><h5 id="Ct"><a href="#Ct" class="headerlink" title="Ct"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Matching_connection_tracking_stateful_metainformation">Ct</a></h5><p>Ct 是 Conntrack 的缩写，链接跟踪</p>
<ul>
<li><p>state <state>： State of the connection，这个匹配条件的作用和 iptables 的 state 模块一样</p>
<pre class="language-none"><code class="language-none">ct state &#123; new, established, related, invalid，untracked &#125;
ct state !&#x3D; related
ct state established
ct state 8</code></pre>
</li>
<li><p>direction <value>： Direction of the packet relative to the connection，数据包相对于链接的方向</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct direction original
ct direction <span class="token operator">!=</span> original
ct direction <span class="token punctuation">&#123;</span>reply, original<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>status <status>：Status of the connection</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct status expected
ct status <span class="token operator">!=</span> expected
ct status <span class="token punctuation">&#123;</span> expected,seen-reply,assured,confirmed,snat,dnat,dying <span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>mark [set]：Mark of the connection</p>
</li>
<li><p>expiration： Connection expiration time，连接过期时间</p>
</li>
<li><p>helper “<helper>“：Helper associated with the connection</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct helper <span class="token string">"ftp"</span></code></pre>
</li>
<li><p>[original|reply] bytes <value></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct original bytes <span class="token operator">></span> <span class="token number">100000</span>
ct bytes <span class="token operator">></span> <span class="token number">100000</span></code></pre>
</li>
<li><p>[original|reply] packets <value>：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct reply packets <span class="token operator">&lt;</span> <span class="token number">100</span></code></pre>
</li>
<li><p>[original | reply] saddr <ip source address></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct original saddr <span class="token number">192.168</span>.0.1
ct reply saddr <span class="token number">192.168</span>.0.1
ct original saddr <span class="token number">192.168</span>.1.0/24
ct reply saddr <span class="token number">192.168</span>.1.0/24</code></pre>
</li>
<li><p>[original | reply] daddr <ip destination address></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct original daddr <span class="token number">192.168</span>.0.1
ct reply daddr <span class="token number">192.168</span>.0.1
ct original daddr <span class="token number">192.168</span>.1.0/24
ct reply daddr <span class="token number">192.168</span>.1.0/24</code></pre>
</li>
<li><p>[original | reply] l3proto <protocol></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct original l3proto ipv4</code></pre>
</li>
<li><p>[original | reply] protocol <protocol></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct original protocol <span class="token number">6</span></code></pre>
</li>
<li><p>[original | reply] proto-dst <port></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct original proto-dst <span class="token number">22</span></code></pre>
</li>
<li><p>[original | reply] proto-src <port></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ct reply proto-src <span class="token number">53</span></code></pre></li>
</ul>
<h5 id="Meta"><a href="#Meta" class="headerlink" title="Meta"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Matching_packet_metainformation">Meta</a></h5><p>匹配（某些情况下可以 设置）数据包的元信息，虽然我现在也不知道元信息是什么？</p>
<ul>
<li><p>不能省略 meta 关键字</p>
<ul>
<li>length – packet lenght</li>
<li>protocol – packet protocol (as in skb-&gt;protocol)</li>
<li>nfproto – netfilter packet protocol family (like ipv4, ipv6, etc..).</li>
<li>l4proto – layer 4 protocol (tcp, udp, etc..)</li>
<li>priority – packet priority, tc handle. <a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Setting_packet_metainformation">Can be set.</a></li>
<li>random – match against a single&#x2F;simple random number</li>
<li>secmark – packet secmark. <a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Setting_packet_metainformation">Can be set.</a></li>
<li>ibrvproto – match the bridge protocol</li>
<li>ibrpvid – match the bridge pvid</li>
</ul>
</li>
<li><p>可以省略 meta 关键字</p>
<ul>
<li>mark – packet mark. <a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Setting_packet_metainformation">Can be set.</a></li>
<li>iif – input interface index</li>
<li>iifname – input interface name</li>
<li>iiftype – input interface type</li>
<li>oif – output interface index</li>
<li>oifname – output interface name</li>
<li>oiftype – output interface type</li>
<li>skuid – socket uid</li>
<li>skgid – socket gid</li>
<li>nftrace – nftrace debugging bit. <a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Setting_packet_metainformation">Can be set.</a></li>
<li>rtclassid – realm</li>
<li>ibriport – input bridge port</li>
<li>obriport – output bridge port</li>
<li>ibridgename – input bridge name</li>
<li>obridgename – output bridge name</li>
<li>pkttype – packet type. <a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Setting_packet_metainformation">Can be set.</a></li>
<li>cpu – cpu number</li>
<li>iifgroup – input interface group</li>
<li>oifgroup – output interface group</li>
<li>cgroup – cgroup number</li>
<li>ipsec – ipsec (secpath) packet or not</li>
<li>time – packet timestamp</li>
<li>day – packet timestamp</li>
<li>hour – packet timestamp</li>
</ul>
</li>
</ul>
<p><strong>Matching packets by interface name 通过接口名称匹配数据包</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft <span class="token function">add</span> rule filter input meta oifname lo accept</code></pre>

<p><strong>Matching packets by packet mark 通过数据标记匹配数据包</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft <span class="token function">add</span> rule filter output meta mark <span class="token number">123</span> counter</code></pre>

<p><strong>Matching packets the socket UID 匹配套接字 UID 的数据包</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft <span class="token function">add</span> rule filter output meta skuid pablo counter
nft <span class="token function">add</span> rule filter output meta skuid <span class="token number">1000</span> counter</code></pre>

<p><strong>Matching packet priority 匹配数据包的优先级</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft <span class="token function">add</span> rule filter forward meta priority abcd:1234
nft <span class="token function">add</span> rule filter forward meta priority none</code></pre>

<h4 id="statements"><a href="#statements" class="headerlink" title="statements"></a>statements</h4><p>语句，分为两种，终结和非终结，终结语句不会再继续处理后面的表达式和规则，防火墙完成本次任务，而非终结语句会继续处理后面的表达式或者规则。</p>
<ul>
<li>Verdict：重定向</li>
<li>Log：记录日志并继续处理请求</li>
<li>Reject：停止处理并拒绝请求</li>
<li>Counter：计数</li>
<li>Limit：如果达到了接收数据包的匹配限制，则根据规则处理数据包</li>
<li>Nat：NAT，分为 snat 和 dnat</li>
<li>Queuea：停止处理并发送数据包到用户空间程序</li>
</ul>
<h5 id="verdict"><a href="#verdict" class="headerlink" title="verdict"></a>verdict</h5><p>每条 verdict 语句都与 verdict 寄存器的预设值一一对应，只负责控制已匹配数据包的重定向，如果在决定数据包的去向之前有任何操作，交给其他类型的语句负责</p>
<p>expr 处理完 verdict 语句，会跳出当前表达式的循环（即上文 nftables 框架的执行流程中的循环 2）这样不管最终重定向到哪里，都会就此结束当前规则，所以 verdict 语句，要写在规则的最后。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Accepting_and_dropping_packets">accept</a>：终结语句，接受数据包</li>
<li><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Accepting_and_dropping_packets">drop</a>：终结语句，接受数据包</li>
<li>queue：将数据包排队到用户空间，queue 本身不是终结语句，但是需要搭配 accept 或者 drop 使用</li>
<li>continue：跳过本条规则后面的表达式和语句，处理下一条规则</li>
<li>return：<ul>
<li>从一个 CHAIN 里可以 jump 到另一个 CHAIN, jump 到的那个 CHAIN 是子 CHAIN</li>
<li>从子 CHAIN return 后，回到触发 jump 的那条规则，从那条规则的下一条继续匹配</li>
<li>如果不是在子 CHAIN 里 return，而是在 main CHAIN，那么就以默认规则进行</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Jumping_to_chain">jump <chain></a>：跳转到指定的规则链，当执行完成或者返回时，返回到调用的规则链</li>
<li><a href="(https://wiki.nftables.org/wiki-nftables/index.php/Jumping_to_chain)">goto <chain></a>：类似于跳转，发送到指定规则链但不返回</li>
</ul>
<h5 id="log"><a href="#log" class="headerlink" title="log"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Logging_traffic">log</a></h5><ul>
<li><p>level [over] <value> <unit> [burst <value> <unit>]：Log level</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">log
log level emerg
log level alert
log level crit
log level err
log level warn
log level notice
log level info
log level debug</code></pre>
</li>
<li><p>group <value> [queue-threshold <value>] [snaplen <value>] [prefix “<prefix>“]</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">log prefix aaaaa-aaaaaa group <span class="token number">2</span> snaplen <span class="token number">33</span>
log group <span class="token number">2</span> queue-threshold <span class="token number">2</span>
log group <span class="token number">2</span> snaplen <span class="token number">33</span></code></pre></li>
</ul>
<h5 id="reject"><a href="#reject" class="headerlink" title="reject"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Rejecting_traffic">reject</a></h5><ul>
<li><p>with <protocol> type <type></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">reject
reject with icmp <span class="token builtin class-name">type</span> host-unreachable
reject with icmp <span class="token builtin class-name">type</span> net-unreachable
reject with icmp <span class="token builtin class-name">type</span> prot-unreachable
reject with icmp <span class="token builtin class-name">type</span> port-unreachable
reject with icmp <span class="token builtin class-name">type</span> net-prohibited
reject with icmp <span class="token builtin class-name">type</span> host-prohibited
reject with icmp <span class="token builtin class-name">type</span> admin-prohibited
reject with icmpv6 <span class="token builtin class-name">type</span> no-route
reject with icmpv6 <span class="token builtin class-name">type</span> admin-prohibited
reject with icmpv6 <span class="token builtin class-name">type</span> addr-unreachable
reject with icmpv6 <span class="token builtin class-name">type</span> port-unreachable
reject with icmpx <span class="token builtin class-name">type</span> host-unreachable
reject with icmpx <span class="token builtin class-name">type</span> no-route
reject with icmpx <span class="token builtin class-name">type</span> admin-prohibited
reject with icmpx <span class="token builtin class-name">type</span> port-unreachable
<span class="token function">ip</span> protocol tcp reject with tcp reset</code></pre></li>
</ul>
<h5 id="counter"><a href="#counter" class="headerlink" title="counter"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Counters">counter</a></h5><p>按照数据包的大小递增字节计数器以及包计数器的值</p>
<ul>
<li><p>packets <packets> bytes <bytes></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># counter 和 counter packets 0 bytes 0 是等价的，都表示从0开始计数，</span>
<span class="token comment"># 过一段时间再 nft list ruleset 查看过滤规则，packets 和 bytes 就会显示通过过滤的数据计数</span>
counter
counter packets <span class="token number">0</span> bytes <span class="token number">0</span></code></pre></li>
</ul>
<h5 id="Limit"><a href="#Limit" class="headerlink" title="Limit"></a>Limit</h5><p>等同于 iptables 中的 limit 条件匹配模块</p>
<ul>
<li><p>rate [over] <value> <unit> [burst <value> <unit>]：Rate limit，令牌桶算法限速</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">limit rate <span class="token number">400</span>/minute
limit rate <span class="token number">400</span>/hour
limit rate over <span class="token number">40</span>/day
limit rate over <span class="token number">400</span>/week
limit rate over <span class="token number">1023</span>/second burst <span class="token number">10</span> packets
limit rate <span class="token number">1025</span> kbytes/second
limit rate <span class="token number">1023000</span> mbytes/second
limit rate <span class="token number">1025</span> bytes/second burst <span class="token number">512</span> bytes
limit rate <span class="token number">1025</span> kbytes/second burst <span class="token number">1023</span> kbytes
limit rate <span class="token number">1025</span> mbytes/second burst <span class="token number">1025</span> kbytes
limit rate <span class="token number">1025000</span> mbytes/second burst <span class="token number">1023</span> mbytes</code></pre></li>
</ul>
<h5 id="nat"><a href="#nat" class="headerlink" title="nat"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)">nat</a></h5><p>适用于 nat 链</p>
<ul>
<li><p>dnat <destination address>：Destination address translation，目标地址转换</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">dnat <span class="token number">192.168</span>.3.2
dnat ct mark map <span class="token punctuation">&#123;</span> 0x00000014 <span class="token builtin class-name">:</span> <span class="token number">1.2</span>.3.4<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>snat <ip source address>：Source address translation 源地址转换</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">snat <span class="token number">192.168</span>.3.2
snat <span class="token number">2001</span>:838:35f:1::-2001:838:35f:2:::100</code></pre>
</li>
<li><p>masquerade [<type>] [to :<port>]：Masquerade，特殊的 snat，可以把 MASQUERADE 理解为动态的、自动化的 SNAT，如果没有动态 SNAT 的需求，没有必要使 MASQUERADE，因为 SNAT 更加高效</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">masquerade
masquerade persistent,fully-random,random
masquerade to :1024
masquerade to :1024-2048</code></pre></li>
</ul>
<h5 id="queueaz"><a href="#queueaz" class="headerlink" title="queueaz"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Queueing_to_userspace">queueaz</a></h5><ul>
<li><p>num <value> <scheduler></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">queue
queue num <span class="token number">2</span>
queue num <span class="token number">2</span>-3
queue num <span class="token number">4</span>-5 fanout bypass
queue num <span class="token number">4</span>-5 fanout
queue num <span class="token number">4</span>-5 bypass</code></pre></li>
</ul>
<h5 id="tproxy"><a href="#tproxy" class="headerlink" title="tproxy"></a>tproxy</h5><h5 id="synproxy"><a href="#synproxy" class="headerlink" title="synproxy"></a>synproxy</h5><h5 id="flow"><a href="#flow" class="headerlink" title="flow"></a>flow</h5><h5 id="dup"><a href="#dup" class="headerlink" title="dup"></a>dup</h5><h5 id="fwd"><a href="#fwd" class="headerlink" title="fwd"></a>fwd</h5><h5 id="set"><a href="#set" class="headerlink" title="set"></a>set</h5><h5 id="map"><a href="#map" class="headerlink" title="map"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Multiple_NATs_using_nftables_maps">map</a></h5><h5 id="vmap"><a href="#vmap" class="headerlink" title="vmap"></a><a target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Dictionaries">vmap</a></h5><h4 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新建filter表</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> <span class="token function">add</span> table <span class="token function">ip</span> filter

<span class="token comment"># 添加input、forward、output三个基本链，input和forward的默认策略是drop，output的默认策略是accpet</span>
nft <span class="token function">add</span> chain inet filter input <span class="token punctuation">&#123;</span>type filter hook input priority <span class="token number">0</span><span class="token punctuation">\</span><span class="token punctuation">;</span> policy drop<span class="token punctuation">\</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
nft <span class="token function">add</span> chain inet filter forwad <span class="token punctuation">&#123;</span>type filter hook forward priority <span class="token number">0</span><span class="token punctuation">\</span><span class="token punctuation">;</span> policy drop<span class="token punctuation">\</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
nft <span class="token function">add</span> chain inet filter output <span class="token punctuation">&#123;</span>type filter hook output priority <span class="token number">0</span><span class="token punctuation">\</span><span class="token punctuation">;</span> policy accept<span class="token punctuation">\</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 添加两个与TCP和UDP关联的常规链</span>
nft <span class="token function">add</span> chain inet filter TCP
nft <span class="token function">add</span> chain inet filter UDP

<span class="token comment"># related 和 established 的流量都accept</span>
nft <span class="token function">add</span> rule inet filter input ct state related,established accept

<span class="token comment"># loopback 接口流量会 accept，省略meta关键字</span>
nft <span class="token function">add</span> rule inet filter input iif lo accept

<span class="token comment"># 无效的流量都 drop</span>
nft <span class="token function">add</span> rule inet filter input ct state invalid drop

<span class="token comment"># 新的echo请求（ping）accept</span>
nft <span class="token function">add</span> rule inet filter input <span class="token function">ip</span> protocol icmp icmp <span class="token builtin class-name">type</span> echo-request ct state new accept

<span class="token comment"># 新的UDP流量跳转到UDP链</span>
nft <span class="token function">add</span> rule inet filter input <span class="token function">ip</span> protocol udp ct state new jump UDP
<span class="token comment"># 新的TCP流量跳转到TCP链</span>
<span class="token comment"># &amp;：按位与；|：按位或</span>
<span class="token comment"># fin、syn、rst、ack四个值按位或，统计有这四个值有几个为1，数据包与统计结果的flags按位与（为什么不按位或呢，因为flags有8位，其他四位不关心），如果结果只有syn位为1，就说明是tcp第一次握手</span>
nft <span class="token function">add</span> rule inet filter input <span class="token function">ip</span> protocol tcp tcp flags <span class="token punctuation">\</span><span class="token operator">&amp;</span> <span class="token punctuation">\</span><span class="token punctuation">(</span>fin<span class="token punctuation">\</span><span class="token operator">|</span>syn<span class="token punctuation">\</span><span class="token operator">|</span>rst<span class="token punctuation">\</span><span class="token operator">|</span>ack<span class="token punctuation">\</span><span class="token punctuation">)</span> <span class="token operator">==</span> syn ct state new jump TCP

<span class="token comment"># 未由其他规则处理的所有流量会reject</span>
nft <span class="token function">add</span> rule inet filter input <span class="token function">ip</span> protocol udp reject
nft <span class="token function">add</span> rule inet filter input <span class="token function">ip</span> protocol tcp reject with tcp reset
nft <span class="token function">add</span> rule inet filter input counter reject with icmp <span class="token builtin class-name">type</span> prot-unreachable

<span class="token comment"># 由TCP和UDP链处理，打开web服务器的连接端口</span>
nft <span class="token function">add</span> rule inet filter TCP tcp dport <span class="token number">80</span> accept
nft <span class="token function">add</span> rule inet filter TCP tcp dport <span class="token number">443</span> accept
<span class="token comment"># 允许SSH连接端口22</span>
nft <span class="token function">add</span> rule inet filter TCP tcp dport <span class="token number">22</span> accept
<span class="token comment"># 允许传入DNS请求</span>
nft <span class="token function">add</span> rule inet filter TCP tcp dport <span class="token number">53</span> accept
nft <span class="token function">add</span> rule inet filter UDP udp dport <span class="token number">53</span> accept</code></pre>

<h3 id="替换规则"><a href="#替换规则" class="headerlink" title="替换规则"></a>替换规则</h3><p>指定 handle，替换规则</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft replace rule <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span> handle <span class="token operator">&lt;</span>handle<span class="token operator">></span> <span class="token operator">&lt;</span>matches<span class="token operator">></span> <span class="token operator">&lt;</span>statements<span class="token operator">></span></code></pre>

<h3 id="列出规则"><a href="#列出规则" class="headerlink" title="列出规则"></a>列出规则</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新建filter表</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> <span class="token function">add</span> table <span class="token function">ip</span> filter
<span class="token comment"># 新建INPUT链</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> <span class="token function">add</span> chain <span class="token function">ip</span> filter INPUT <span class="token punctuation">&#123;</span>type filter hook input priority <span class="token number">0</span><span class="token punctuation">\</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
<span class="token comment"># 添加规则，禁ping</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> <span class="token function">add</span> rule <span class="token function">ip</span> filter INPUT icmp <span class="token builtin class-name">type</span> <span class="token number">8</span> reject

<span class="token comment"># 列出指定链中的规则</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list chain <span class="token function">ip</span> filter INPUT
table <span class="token function">ip</span> filter <span class="token punctuation">&#123;</span>
        chain INPUT <span class="token punctuation">&#123;</span>
                <span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
                icmp <span class="token builtin class-name">type</span> echo-request reject
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># -a，--handle：显示句柄值；-n，--numeric：数字化输出</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> <span class="token parameter variable">-an</span> list chain <span class="token function">ip</span> filter INPUT
table <span class="token function">ip</span> filter <span class="token punctuation">&#123;</span>
        chain INPUT <span class="token punctuation">&#123;</span> <span class="token comment"># handle 4</span>
                <span class="token builtin class-name">type</span> filter hook input priority <span class="token number">0</span><span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
                icmp <span class="token builtin class-name">type</span> <span class="token number">8</span> reject <span class="token comment"># handle 6</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出所有的规则</span>
nft list ruleset</code></pre>

<h3 id="删除规则"><a href="#删除规则" class="headerlink" title="删除规则"></a>删除规则</h3><p>删除规则只能通过 handle 值，所以删除之前需要先查询规则的 handle 值</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 语法</span>
nft delete rule <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span> handle <span class="token operator">&lt;</span>handle<span class="token operator">></span>
<span class="token comment"># 范例</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> delete rule <span class="token function">ip</span> filter INPUT handle <span class="token number">7</span></code></pre>

<h3 id="清空规则"><a href="#清空规则" class="headerlink" title="清空规则"></a>清空规则</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清空链中的规则</span>
nft flush chain <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>chain<span class="token operator">></span>
<span class="token comment"># 清空所有规则</span>
nft flush ruleset</code></pre>

<h3 id="数据报文分组、分类的数据结构"><a href="#数据报文分组、分类的数据结构" class="headerlink" title="数据报文分组、分类的数据结构"></a>数据报文分组、分类的数据结构</h3><h4 id="表与命名空间"><a href="#表与命名空间" class="headerlink" title="表与命名空间"></a>表与命名空间</h4><p>在 nftables 中，每个表都是独立的命名空间，这就意味着不同的表中的链、集合、字典等名字可以相同。不同的应用就可以在相互不影响的情况下管理自己表中的规则，不过要注意，由于 nftables 将每个表都视为独立的防火墙，一个数据包必须被所有表中的规则放行才能真正通过，如果在一个 hook，出现两条优先级相同的链，就会进入竞争状态。</p>
<h4 id="集合（sets）"><a href="#集合（sets）" class="headerlink" title="集合（sets）"></a>集合（sets）</h4><p>集合可以用来匹配多个 <code>IP</code> 地址、端口号、网卡或其他任何条件。<br>相对 <code>iptables</code> 来说，<code>nftables</code> 原生支持集合，并不需要借助 <code>ipset</code> 来实现。<br><code>nftables</code> 的集合分为匿名集合与命名集合。</p>
<p>集合中的元素可能是连续的，也可能是不连续的，连续的使用 - 划分范围，不连续的使用 , 分割</p>
<h5 id="匿名集合"><a href="#匿名集合" class="headerlink" title="匿名集合"></a>匿名集合</h5><p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nft <span class="token function">add</span> rule <span class="token function">ip</span> filter output tcp dport <span class="token punctuation">&#123;</span> <span class="token number">22</span>, <span class="token number">23</span> <span class="token punctuation">&#125;</span> counter</code></pre>

<p>如果写在文件中，通过 -f 加载，可以使用 define 关键字定义，使用 $ 关键字调用，范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">define CDN_EDGE <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token number">192.168</span>.1.1,
    <span class="token number">192.168</span>.1.2,
    <span class="token number">192.168</span>.1.3,
    <span class="token number">10.0</span>.0.0/8
<span class="token punctuation">&#125;</span>

define CDN_MONITORS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token number">192.168</span>.1.10,
    <span class="token number">192.168</span>.1.20
<span class="token punctuation">&#125;</span>

define CDN <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$CDN_EDGE</span>,
    <span class="token variable">$CDN_MONITORS</span>
<span class="token punctuation">&#125;</span>
table inet filter <span class="token punctuation">&#123;</span>
	chain input <span class="token punctuation">&#123;</span>
		<span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy drop<span class="token punctuation">;</span>
		tcp dport <span class="token punctuation">&#123;</span> http, https <span class="token punctuation">&#125;</span> <span class="token function">ip</span> saddr <span class="token variable">$CDN</span> accept
		udp dport <span class="token punctuation">&#123;</span> http, https <span class="token punctuation">&#125;</span> <span class="token function">ip</span> saddr <span class="token variable">$CDN</span> accept
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="命名集合"><a href="#命名集合" class="headerlink" title="命名集合"></a>命名集合</h5><h6 id="新建命名集合"><a href="#新建命名集合" class="headerlink" title="新建命名集合"></a>新建命名集合</h6><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">add</span> <span class="token builtin class-name">set</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>set<span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token builtin class-name">type</span> <span class="token operator">&lt;</span>type<span class="token operator">></span> <span class="token operator">|</span> typeof <span class="token operator">&lt;</span>expression<span class="token operator">></span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>flags <span class="token operator">&lt;</span>flags<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>timeout <span class="token operator">&lt;</span>timeout<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>gc-interval <span class="token operator">&lt;</span>gc-interval<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>elements <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">&lt;</span>element<span class="token operator">></span><span class="token punctuation">[</span>, <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>size <span class="token operator">&lt;</span>size<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>policy <span class="token operator">&lt;</span>policy<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>auto-merge <span class="token punctuation">;</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span></code></pre>

<p>上文的 <strong>表达式 expression</strong> 章节介绍了 datatype 和 expression。集合中的 type 和 typeof 关键字功能类似，type 指定 datatype，typeof 指定 expression，推荐使用 typeof，更易读</p>
<ul>
<li><p>type：指定集合中元素的类型，当前支持的数据类型有：</p>
</li>
<li><p>ipv4_addr : IPv4 地址</p>
<ul>
<li>ipv6_addr : IPv6 地址</li>
<li>ether_addr : 以太网（Ethernet）地址</li>
<li>inet_proto : 网络协议</li>
<li>inet_service : 网络服务</li>
<li>mark : 标记类型</li>
</ul>
</li>
<li><p>typeof：typeof 关键字从 0.9.4 版本开始用有效，允许使用表达式（参考下文的表达式章节），让 nftables 解析基本类型</p>
</li>
<li><p>flags：标志</p>
<ul>
<li>constant：内容不可变</li>
<li>interval：内容包含区间集</li>
<li>timeout：可以给元素设置一个过期时间</li>
</ul>
</li>
<li><p>timeout：设置元素的过期时间</p>
</li>
<li><p>gc-interval：</p>
</li>
<li><p>elements：给初始化的集合填充元素</p>
</li>
<li><p>size：限制集合中元素的数量</p>
</li>
<li><p>policy：集合策略</p>
<ul>
<li>performance [default]</li>
<li>memory</li>
</ul>
</li>
<li><p>auto-merge：相邻&#x2F;重叠集元素自动合并(仅适用于区间集)</p>
</li>
<li><p>counter：给每个元素设置计数器</p>
</li>
</ul>
<p>范例：</p>
<p>使用 @ 关键字调用命名集合</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">flush ruleset
table inet filter <span class="token punctuation">&#123;</span>
	<span class="token builtin class-name">set</span> ip_saddrs <span class="token punctuation">&#123;</span>
		typeof <span class="token function">ip</span> saddr
		flags interval
		elements <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">10.0</span>.0.0/24, <span class="token number">192.168</span>.248.0/24 <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token builtin class-name">set</span> tcp_dports <span class="token punctuation">&#123;</span>
		typeof tcp dport
		elements <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">22</span>, <span class="token number">80</span>, <span class="token number">443</span> <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	chain input <span class="token punctuation">&#123;</span>
		<span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy drop<span class="token punctuation">;</span>
		<span class="token function">ip</span> saddr @ip_saddrs tcp dport @tcp_dports accept
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h6 id="列出命名集合"><a href="#列出命名集合" class="headerlink" title="列出命名集合"></a>列出命名集合</h6><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 默认列出全部集合</span>
nft list sets <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token comment"># 列出一个集合</span>
nft list <span class="token builtin class-name">set</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>family<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>table<span class="token operator">></span> <span class="token operator">&lt;</span>set<span class="token operator">></span></code></pre>

<h4 id="映射（Maps）"><a href="#映射（Maps）" class="headerlink" title="映射（Maps）"></a>映射（Maps）</h4><p>映射的元素形式是 key-value，key 和 vaule 之间的映射关系取决于映射的 type 或者 typeof</p>
<p>配置文件中的语法格式：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">map <span class="token operator">&lt;</span>map<span class="token operator">></span> <span class="token punctuation">&#123;</span>
	<span class="token builtin class-name">type</span> <span class="token operator">&lt;</span>type<span class="token operator">></span> <span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>type<span class="token operator">></span>
	<span class="token comment"># 或</span>
	typeof <span class="token operator">&lt;</span>expression<span class="token operator">></span> <span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>expression<span class="token operator">></span>
	<span class="token comment"># 或</span>
	<span class="token builtin class-name">type</span> <span class="token operator">&lt;</span>type<span class="token operator">></span> <span class="token builtin class-name">:</span> verdict

	<span class="token punctuation">[</span>flags <span class="token operator">&lt;</span>flags<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span>elements <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">&lt;</span>element<span class="token operator">></span><span class="token punctuation">[</span>, <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">;</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span>size <span class="token operator">&lt;</span>size<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span>policy <span class="token operator">&lt;</span>policy<span class="token operator">></span> <span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>映射用于 map 和 vmap 语句，当键值均为表达式时，用于 map，当值为 verdict 语句时，用于 vmap。</p>
<p>map 通常用于 nat 地址转换。</p>
<ul>
<li>type：指定 datatype，支持以下 datatype，注意 counter 和 quota 不能用于键<ul>
<li>ipv4_addr : IPv4 地址</li>
<li>ipv6_addr : IPv6 地址</li>
<li>ether_addr : 以太网（Ethernet）地址</li>
<li>inet_proto : 网络协议</li>
<li>inet_service : 网络服务</li>
<li>mark : 标记类型</li>
<li>counter：</li>
<li>quota：</li>
</ul>
</li>
<li>typeof：指定 expression</li>
<li>flags：标志<ul>
<li>constant</li>
<li>interval</li>
</ul>
</li>
<li>elements：初始化映射中的元素</li>
<li>size：限制映射中元素的数量</li>
<li>policy：策略<ul>
<li>performance [default]</li>
<li>memory</li>
</ul>
</li>
</ul>
<p>范例：</p>
<p>使用 @ 关键字调用映射</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">flush ruleset
table inet filter <span class="token punctuation">&#123;</span>
	<span class="token builtin class-name">set</span> tcp_dports <span class="token punctuation">&#123;</span>
		typeof tcp dport
		elements <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">22</span>, <span class="token number">80</span>, <span class="token number">443</span> <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	map test_vmap <span class="token punctuation">&#123;</span>
		<span class="token builtin class-name">type</span> ipv4_addr <span class="token builtin class-name">:</span> verdict
        flags interval
		elements <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token number">192.168</span>.248.0/24 <span class="token builtin class-name">:</span> drop,
            <span class="token number">10.0</span>.0.1/24 <span class="token builtin class-name">:</span> accept
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	chain input <span class="token punctuation">&#123;</span>
		<span class="token builtin class-name">type</span> filter hook input priority filter<span class="token punctuation">;</span> policy drop<span class="token punctuation">;</span>
		<span class="token function">ip</span> saddr vmap @test_vmap tcp dport @tcp_dports accept
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="Concatenations"><a href="#Concatenations" class="headerlink" title="Concatenations"></a>Concatenations</h4><h4 id="Metering"><a href="#Metering" class="headerlink" title="Metering"></a>Metering</h4><p>以前称之为 flow tables</p>
<h4 id="Updating-sets-from-the-packet-path"><a href="#Updating-sets-from-the-packet-path" class="headerlink" title="Updating sets from the packet path"></a>Updating sets from the packet path</h4><h4 id="Math-operations"><a href="#Math-operations" class="headerlink" title="Math operations"></a>Math operations</h4><h4 id="Stateful-objects"><a href="#Stateful-objects" class="headerlink" title="Stateful objects"></a>Stateful objects</h4><h4 id="Flowtable-the-fastpath-network-stack-bypass"><a href="#Flowtable-the-fastpath-network-stack-bypass" class="headerlink" title="Flowtable (the fastpath network stack bypass)"></a>Flowtable (the fastpath network stack bypass)</h4><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>可以将规则写在文件中，通过<code>nft -f file</code>加载。推荐这种方式</p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>说明：以下练习 INPUT 和 OUTPUT 默认策略均为 DROP</p>
<p>1、限制本地主机的 web 服务器在周一不允许访问；新请求的速率不能超过 100 个每秒；web 服务器包含了 admin 字符串的页面不允许访问；web 服务器仅允许响应报文离开本机</p>
<p>2、在工作时间，即周一到周五的 8:30-18:00，开放本机的 ftp 服务给 172.16.0.0 网络中的主机访问；数据下载请求的次数每分钟不得超过 5 个</p>
<p>3、开放本机的 ssh 服务给 172.16.x.1-172.16.x.100 中的主机，x 为你的学号，新请求建立的速率一分钟不得超过 2 个；仅允许响应报文通过其服务端口离开本机</p>
<p>4、拒绝 TCP 标志位全部为 1 及全部为 0 的报文访问本机</p>
<p>5、允许本机 ping 别的主机；但不开放别的主机 ping 本机</p>
<p>6、判断下述规则的意义</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/virt-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/virt-install/" class="post-title-link" itemprop="url">virt-install</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:43:12" itemprop="dateCreated datePublished" datetime="2020-12-09T23:43:12+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/" itemprop="url" rel="index"><span itemprop="name">虚拟化和KVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>从指定安装源创建新虚拟机</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">virt-install <span class="token parameter variable">--name</span> NAME <span class="token parameter variable">--memory</span> MB STORAGE INSTALL <span class="token punctuation">[</span>options<span class="token punctuation">]</span></code></pre>

<ul>
<li>–help：帮助信息</li>
<li>–version：版本信息</li>
<li>–connect URI：通过 libvirt URI 连接到虚拟机管理程序（hypervisor）</li>
</ul>
<h2 id="通用选项："><a href="#通用选项：" class="headerlink" title="通用选项："></a>通用选项：</h2><ul>
<li><p>-n NAME, –name NAME 客户机实例名称</p>
</li>
<li><p>–memory MEMORY：配置虚拟机内存分配，默认 m 为单位</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--memory</span> <span class="token number">1024</span> <span class="token punctuation">(</span>in MiB<span class="token punctuation">)</span>
<span class="token parameter variable">--memory</span> <span class="token assign-left variable">memory</span><span class="token operator">=</span><span class="token number">1024</span>,currentMemory<span class="token operator">=</span><span class="token number">512</span></code></pre>
</li>
<li><p>–vcpus VCPUS：为虚拟机配置的 vcpus 数</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--vcpus</span> <span class="token number">5</span>
<span class="token parameter variable">--vcpus</span> <span class="token number">5</span>,maxvcpus<span class="token operator">=</span><span class="token number">10</span>,cpuset<span class="token operator">=</span><span class="token number">1</span>-4,6,8
<span class="token parameter variable">--vcpus</span> <span class="token assign-left variable">sockets</span><span class="token operator">=</span><span class="token number">2</span>,cores<span class="token operator">=</span><span class="token number">4</span>,threads<span class="token operator">=</span><span class="token number">2</span></code></pre>
</li>
<li><p>–cpu CPU：CPU 型号及功能</p>
</li>
<li><p>–metadata METADATA：配置客户机元数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--metadata</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>foo,title<span class="token operator">=</span><span class="token string">"My pretty title"</span>,uuid<span class="token operator">=</span><span class="token punctuation">..</span>.
<span class="token parameter variable">--metadata</span> <span class="token assign-left variable">description</span><span class="token operator">=</span><span class="token string">"My nice long description"</span></code></pre></li>
</ul>
<h2 id="安装方法选项："><a href="#安装方法选项：" class="headerlink" title="安装方法选项："></a>安装方法选项：</h2><ul>
<li><p>–cdrom CDROM：光驱安装介质，用不到</p>
</li>
<li><p>-l | –location LOCATION：安装源，常用</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">nfs:host:/path
http://host/path
ftp://host/path</code></pre>
</li>
<li><p>–pxe：使用 PXE 协议从网络引导</p>
</li>
<li><p>–import：在已有的磁盘镜像中构建客户机</p>
</li>
<li><p>-x | –extra-args EXTRA_ARGS：将附加参数添加到由 –location 引导的内核中</p>
</li>
<li><p>–initrd-inject INITRD_INJECT：添加指定文件到由 –location 指定的 initrd 根中</p>
</li>
<li><p>–boot BOOT：配置客户机引导设置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--boot</span> hd,cdrom,menu<span class="token operator">=</span>on				<span class="token comment"># hd是harddisk，cdrom是光盘</span>
<span class="token parameter variable">--boot</span> <span class="token assign-left variable">init</span><span class="token operator">=</span>/sbin/init <span class="token punctuation">(</span>针对容器<span class="token punctuation">)</span></code></pre>
</li>
<li><p>–idmap IDMAP：为 LXC 容器启用用户名称空间</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--idmap</span> <span class="token assign-left variable">uid_start</span><span class="token operator">=</span><span class="token number">0</span>,uid_target<span class="token operator">=</span><span class="token number">1000</span>,uid_count<span class="token operator">=</span><span class="token number">10</span></code></pre>
</li>
<li><p>–unattended [UNATTENDED]：Perform an unattended installation</p>
</li>
<li><p>–install INSTALL：Specify fine grained install options</p>
</li>
</ul>
<h2 id="OS-选项："><a href="#OS-选项：" class="headerlink" title="OS 选项："></a>OS 选项：</h2><ul>
<li>–os-variant OS_VARIANT：在其中安装 OS 变体的虚拟机，比如:’fedora18’、’rhel6’、’winxp’ 等等</li>
</ul>
<h2 id="设备选项："><a href="#设备选项：" class="headerlink" title="设备选项："></a>设备选项：</h2><ul>
<li><p>–disk DISK：指定存储的各种选项</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--disk</span> <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">10</span> <span class="token punctuation">(</span>在默认位置创建 10GiB 镜像<span class="token punctuation">)</span>
<span class="token parameter variable">--disk</span> /my/existing/disk,cache<span class="token operator">=</span>none
<span class="token parameter variable">--disk</span> <span class="token assign-left variable">device</span><span class="token operator">=</span>cdrom,bus<span class="token operator">=</span>scsi
<span class="token parameter variable">--disk</span><span class="token operator">=</span>?

<span class="token parameter variable">--disk</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>/var/lib/libvirt/images/centos7-pxe1.qcow2,bus<span class="token operator">=</span>virtio
<span class="token parameter variable">--disk</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>/dev/vm_images_lvm/lv2,bus<span class="token operator">=</span>virtio</code></pre>
</li>
<li><p>-w | –network NETWORK：配置客户机网络接口</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--network</span> <span class="token assign-left variable">bridge</span><span class="token operator">=</span>mybr0
<span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>my_libvirt_virtual_net
<span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>mynet,model<span class="token operator">=</span>virtio,mac<span class="token operator">=</span>00:11<span class="token punctuation">..</span>.
<span class="token parameter variable">--network</span> none
<span class="token parameter variable">--network</span> <span class="token builtin class-name">help</span></code></pre>
</li>
<li><p>–graphics GRAPHICS：配置虚拟机显示设置</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--graphics</span> spice
<span class="token parameter variable">--graphics</span> vnc,port<span class="token operator">=</span><span class="token number">5901</span>,listen<span class="token operator">=</span><span class="token number">0.0</span>.0.0
<span class="token parameter variable">--graphics</span> none</code></pre>
</li>
<li><p>–controller CONTROLLER：配置虚拟机控制程序设备</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--controller</span> <span class="token assign-left variable">type</span><span class="token operator">=</span>usb,model<span class="token operator">=</span>qemu-xhci
<span class="token parameter variable">--controller</span> virtio-scsi</code></pre>
</li>
<li><p>–input INPUT：配置客户机输入设备</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--input</span> tablet
<span class="token parameter variable">--input</span> keyboard,bus<span class="token operator">=</span>usb</code></pre>
</li>
<li><p>–serial SERIAL：配置客户机串口设备</p>
</li>
<li><p>–parallel PARALLEL：配置客户机并口设备</p>
</li>
<li><p>–channel CHANNEL：配置客户机通信通道</p>
</li>
<li><p>–console CONSOLE：配置文本控制台连接主机与客户机</p>
</li>
<li><p>–hostdev HOSTDEV：配置物理 USB&#x2F;PCI 等主机设备与客户机共享</p>
</li>
<li><p>–filesystem FILESYSTEM：传递主机目录到客户机</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--filesystem</span> /my/source/dir,/dir/in/guest
<span class="token parameter variable">--filesystem</span> template_name,/,type<span class="token operator">=</span>template</code></pre>
</li>
<li><p>–sound [SOUND]：配置客户机声音设备仿真</p>
</li>
<li><p>–watchdog WATCHDOG：配置客户机 watchdog 设备</p>
</li>
<li><p>–video VIDEO：配置客户机视频硬件</p>
</li>
<li><p>–smartcard SMARTCARD：配置客户机智能卡设备</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--smartcard</span> <span class="token assign-left variable">mode</span><span class="token operator">=</span>passthrough</code></pre>
</li>
<li><p>–redirdev REDIRDEV：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--redirdev</span> usb,type<span class="token operator">=</span>tcp,server<span class="token operator">=</span><span class="token number">192.168</span>.1.1:4000</code></pre>
</li>
<li><p>–memballoon MEMBALLOON：配置客户机 memballoon 设备</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--memballoon</span> <span class="token assign-left variable">model</span><span class="token operator">=</span>virtio</code></pre>
</li>
<li><p>–tpm TPM：配置客户机 TPM 设备</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--tpm</span> /dev/tpm</code></pre>
</li>
<li><p>–rng RNG：Configure a guest RNG device</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--rng</span> /dev/urandom</code></pre>
</li>
<li><p>–panic PANIC：配置客户机 panic 设备</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--panic</span> default</code></pre>
</li>
<li><p>–memdev MEMDEV：Configure a guest memory device</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--memdev</span> dimm,target.size<span class="token operator">=</span><span class="token number">1024</span></code></pre>
</li>
<li><p>–vsock VSOCK：Configure guest vsock sockets</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--vsock</span> <span class="token assign-left variable">cid.auto</span><span class="token operator">=</span>yes
<span class="token parameter variable">--vsock</span> <span class="token assign-left variable">cid.address</span><span class="token operator">=</span><span class="token number">7</span></code></pre></li>
</ul>
<h2 id="客户机配置选项："><a href="#客户机配置选项：" class="headerlink" title="客户机配置选项："></a>客户机配置选项：</h2><ul>
<li><p>–iothreads IOTHREADS：Set domain <iothreads> and <iothreadids> configuration</p>
</li>
<li><p>–seclabel | –security SECLABEL：Set domain seclabel configuration</p>
</li>
<li><p>–cputune CPUTUNE：Tune CPU parameters for the domain process</p>
</li>
<li><p>–numatune NUMATUNE：为域进程调整 NUMA 策略</p>
</li>
<li><p>–memtune MEMTUNE：为域进程调整内存策略</p>
</li>
<li><p>–blkiotune BLKIOTUNE：为域进程调整 blkio 策略。</p>
</li>
<li><p>–memorybacking MEMORYBACKING：为域进程设置内存后备策略</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--memorybacking</span> <span class="token assign-left variable">hugepages</span><span class="token operator">=</span>on</code></pre>
</li>
<li><p>–features FEATURES：Set domain <features> XML</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--features</span> <span class="token assign-left variable">acpi</span><span class="token operator">=</span>off
<span class="token parameter variable">--features</span> <span class="token assign-left variable">apic</span><span class="token operator">=</span>on,apic.eoi<span class="token operator">=</span>on</code></pre>
</li>
<li><p>–clock CLOCK：设置域 <clock> XML</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--clock</span> <span class="token assign-left variable">offset</span><span class="token operator">=</span>localtime,rtc_tickpolicy<span class="token operator">=</span>catchup</code></pre>
</li>
<li><p>–pm PM：配置 VM 电源管理功能</p>
</li>
<li><p>–events EVENTS：配置 VM 生命周期管理策略</p>
</li>
<li><p>–resource RESOURCE：配置 VM 资源分区(cgroups)</p>
</li>
<li><p>–sysinfo SYSINFO：Configure SMBIOS System Information</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--sysinfo</span> <span class="token function">host</span>
<span class="token parameter variable">--sysinfo</span> <span class="token assign-left variable">bios.vendor</span><span class="token operator">=</span>MyVendor,bios.version<span class="token operator">=</span><span class="token number">1.2</span>.3,<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>–qemu-commandline QEMU_COMMANDLINE：Pass arguments directly to the qemu emulator</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">--qemu-commandline<span class="token operator">=</span><span class="token string">'-display gtk,gl=on'</span>
--qemu-commandline <span class="token assign-left variable">env</span><span class="token operator">=</span><span class="token environment constant">DISPLAY</span><span class="token operator">=</span>:0.1</code></pre>
</li>
<li><p>–launchSecurity | -launchsecurity LAUNCHSECURITY：Configure VM launch security (e.g. SEV memory encryption)</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--launchSecurity</span> <span class="token assign-left variable">type</span><span class="token operator">=</span>sev,cbitpos<span class="token operator">=</span><span class="token number">47</span>,reducedPhysBits<span class="token operator">=</span><span class="token number">1</span>,policy<span class="token operator">=</span>0x0001,dhCert<span class="token operator">=</span>BASE64CERT
<span class="token parameter variable">--launchSecurity</span> sev</code></pre></li>
</ul>
<h2 id="虚拟化平台选项："><a href="#虚拟化平台选项：" class="headerlink" title="虚拟化平台选项："></a>虚拟化平台选项：</h2><ul>
<li>-v, –hvm：这个客户机应该是一个全虚拟化客户机</li>
<li>-p, –paravirt：这个客户机应该是一个半虚拟化客户机</li>
<li>–container：这个客户机应该是一个容器客户机</li>
<li>–virt-type VIRT_TYPE：要使用的管理程序名称 (kvm, qemu, xen, …)</li>
<li>–arch ARCH：模拟 CPU 架构</li>
<li>–machine MACHINE：机器类型为仿真类型，要模拟的机器类型</li>
</ul>
<h2 id="其它选项："><a href="#其它选项：" class="headerlink" title="其它选项："></a>其它选项：</h2><ul>
<li><p>–autostart：主机启动时自动启动域。</p>
</li>
<li><p>–transient：Create a transient domain.</p>
</li>
<li><p>–destroy-on-exit：Force power off the domain when the console viewer is closed.</p>
</li>
<li><p>–wait [WAIT]：请等待数分钟以便完成安装</p>
</li>
<li><p>–noautoconsole：不要自动尝试连接到客户端控制台</p>
</li>
<li><p>–noreboot：安装完成后不启动客户机</p>
</li>
<li><p>–print-xml [XMLONLY]：打印生成的 XML 域，而不是创建客户机。</p>
</li>
<li><p>–dry-run：运行安装程序，但不创建设备或定义客户机。</p>
</li>
<li><p>–check CHECK：启用或禁用验证检查</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--check</span> <span class="token assign-left variable">path_in_use</span><span class="token operator">=</span>off
<span class="token parameter variable">--check</span> <span class="token assign-left variable">all</span><span class="token operator">=</span>off</code></pre>
</li>
<li><p>-q, –quiet：禁止无错误输出</p>
</li>
<li><p>-d, –debug：输入故障排除信息</p>
</li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>使用 ‘–option&#x3D;?’ 或 ‘–option help’ 来查看可用的子选项<br>请参考 man 手册，以便了解示例和完整的选项语法。</p>
<p>例如：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~$ <span class="token function">sudo</span> virt-install <span class="token parameter variable">--network</span> <span class="token builtin class-name">help</span>
<span class="token parameter variable">--network</span> options:
  clearxml
  address.base
  address.bus
  address.controller
  address.cssid
  address.devno
  address.domain
  address.function
  address.iobase
  address.irq
  address.multifunction
  address.port
  address.reg
  address.slot
  address.ssid
  address.target
  address.type
  address.unit
  address.zpci.fid
  address.zpci.uid
  alias.name
  boot.loadparm
  boot.order
  bridge
  driver.ats
  driver.iommu
  driver.name
  driver.queues
  filterref.filter
  link.state
  mac
  mac.address
  model
  model.type
  mtu.size
  network
  rom.bar
  rom.file
  <span class="token builtin class-name">source</span>
  source.mode
  source.path
  source.portgroup
  source.type
  target.dev
  trustGuestRxFilters
  <span class="token builtin class-name">type</span>
  virtualport.parameters.instanceid
  virtualport.parameters.interfaceid
  virtualport.parameters.managerid
  virtualport.parameters.profileid
  virtualport.parameters.typeid
  virtualport.parameters.typeidversion
  virtualport.type
</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~$ <span class="token function">man</span> virt-install
<span class="token punctuation">..</span>.
内容太多
<span class="token punctuation">..</span>.
/--network 	<span class="token comment"># 搜索对应的内容</span></code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/virsh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/virsh/" class="post-title-link" itemprop="url">virsh</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:43:00" itemprop="dateCreated datePublished" datetime="2020-12-09T23:43:00+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/" itemprop="url" rel="index"><span itemprop="name">虚拟化和KVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>virsh 能实现的，virt-manger 都能实现</p>
<p>常用子命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">help</span>               <span class="token comment"># 打印基本帮助信息</span>
attach-device      <span class="token comment"># 使用XML文件中的设备定义在虚拟机中添加设备</span>
attach-disk        <span class="token comment"># 在虚拟机中附加新磁盘设备</span>
attach-interface   <span class="token comment"># 在虚拟机中附加新网络接口</span>
create             <span class="token comment"># 从 XML 配置文件生成虚拟机并启动新虚拟机</span>
define             <span class="token comment"># 为虚拟机输出XML配置文件</span>
destroy            <span class="token comment"># 强制虚拟机停止</span>
detach-device      <span class="token comment"># 从虚拟机中分离设备,使用同样的XML 描述作为命令</span>
attach-device
detach-disk        <span class="token comment"># 从虚拟机中分离磁盘设备</span>
detach-interface   <span class="token comment"># 从虚拟机中分离网络接口</span>
domblkstat         <span class="token comment"># 显示正在运行的虚拟机的块设备统计</span>
domid              <span class="token comment"># 显示虚拟机ID</span>
domifstat          <span class="token comment"># 显示正在运行的虚拟机的网络接口统计</span>
dominfo            <span class="token comment"># 显示虚拟机信息</span>
domname            <span class="token comment"># 显示虚拟机名称</span>
domstate           <span class="token comment"># 显示虚以机状态</span>
domuuid            <span class="token comment"># 显示虚拟机UUID</span>
dumpxml            <span class="token comment"># 输出虚拟机 XML配置文件</span>
list               <span class="token comment"># 列出所有虚拟机</span>
migrate            <span class="token comment"># 将虚拟机迁移到另一台主机中</span>
nodeinfo           <span class="token comment"># 有关管理程序的输出信息</span>
quit               <span class="token comment"># 退出这个互动终端</span>
<span class="token function">reboot</span>             <span class="token comment"># 重新启动虚拟机</span>
restore            <span class="token comment"># 恢复以前保存在文件中的虚拟机</span>
resume             <span class="token comment"># 恢复暂停的虚拟机</span>
save               <span class="token comment"># 将虚拟机当前状态保存到某个文件中</span>
setmaxmem          <span class="token comment"># 为管理程序设定内存上限</span>
setmem             <span class="token comment"># 为虚拟机设定分配的内存</span>
setvcpus           <span class="token comment"># 修改为虚拟机分配的虚拟CPU数目</span>
<span class="token function">shutdown</span>           <span class="token comment"># 关闭某个虚拟机</span>
start              <span class="token comment"># 启动未激活的虚拟机</span>
<span class="token function">suspend</span>            <span class="token comment"># 暂停虚拟机</span>
undefine           <span class="token comment"># 删除与虚拟机关联的所有文件</span>
vcpupin            <span class="token comment"># 控制虚拟机的虚拟CPU亲和性</span>
version            <span class="token comment"># 显示virsh版</span></code></pre>

<p>查看帮助：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> <span class="token builtin class-name">help</span>				<span class="token comment"># virsh帮助</span>
<span class="token function">virsh</span> <span class="token builtin class-name">help</span> COMMAND		<span class="token comment"># virsh子命令帮助</span></code></pre>

<h2 id="管理存储池"><a href="#管理存储池" class="headerlink" title="管理存储池"></a>管理存储池</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># virsh help pool</span>

find-storage-pool-sources-as	<span class="token comment"># 通过参数查找存储池源 find potential storage pool sources</span>
find-storage-pool-sources		<span class="token comment"># 通过XML文档查找存储池源找到潜在存储池源</span>
pool-autostart          		<span class="token comment"># 自动启动某个池</span>
pool-build          			<span class="token comment"># 建立池</span>
pool-create-as          		<span class="token comment"># 在一组变量中定义池</span>
pool-create        		 		<span class="token comment"># 从一个XML文件中创建一个池</span>
pool-define-as          		<span class="token comment"># 从一组变量中创建一个池</span>
pool-define         			<span class="token comment"># 在一个XML文件中定义（但不启动）一个池或修改已经有池</span>
pool-delete         			<span class="token comment"># 删除池</span>
pool-destroy            		<span class="token comment"># 销毁（停止）池</span>
pool-dumpxml           	 		<span class="token comment"># 将池信息保存到XML文件中的</span>
pool-edit           			<span class="token comment"># 为存储池编辑XML配置</span>
pool-info           			<span class="token comment"># 存储池信息</span>
pool-list           			<span class="token comment"># 列出池</span>
pool-name           			<span class="token comment"># 把一个池名称转换为池UUID</span>
pool-refresh            		<span class="token comment"># 刷新池</span>
pool-start          			<span class="token comment"># 启动一个（以前定义的）非活跃的池</span>
pool-undefine           		<span class="token comment"># 取消定义一个不活跃的池</span>
pool-uuid           			<span class="token comment"># 将池UUID转换为池名称</span>
pool-event                      <span class="token comment"># Storage Pool Events</span>
pool-capabilities               <span class="token comment"># storage pool capabilities</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># virsh help pool-create-as</span>

<span class="token function">virsh</span> pool-create-as <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token operator">&lt;</span>type<span class="token operator">></span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

每一个存储池都对应一个xml配置文件，其中的标签和下面的option都有对应
OPTIONS：
<span class="token punctuation">[</span>--name<span class="token punctuation">]</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  						<span class="token comment"># 储存池名称</span>
<span class="token punctuation">[</span>--type<span class="token punctuation">]</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  						<span class="token comment"># 储存池类型</span>
--print-xml 							<span class="token comment"># 打印xml文档</span>
--source-host <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 底层存储的源主机</span>
--source-path <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 底层存储的源路径</span>
--source-dev <span class="token operator">&lt;</span>string<span class="token operator">></span>  					<span class="token comment"># 用于底层存储的源设备</span>
--source-name <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 底层存储的源名称</span>
<span class="token parameter variable">--target</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  						<span class="token comment"># 底层存储的目标</span>
--source-format <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 底层存储格式</span>
--auth-type <span class="token operator">&lt;</span>string<span class="token operator">></span>  					<span class="token comment"># 用于底层存储的认证类型</span>
--auth-username <span class="token operator">&lt;</span>string<span class="token operator">></span> 	 			<span class="token comment"># 用于底层存储的认证用户名</span>
--secret-usage <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 用于底层存储的认证秘密用法</span>
--secret-uuid <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 用于底层存储的秘密UUID</span>
--adapter-name <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 用于基础存储的适配器名称</span>
--adapter-wwnn <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 用于底层存储的适配器wwnn</span>
--adapter-wwpn <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 用于底层存储的适配器wwpn</span>
--adapter-parent <span class="token operator">&lt;</span>string<span class="token operator">></span>  				<span class="token comment"># 用于底层vHBA存储的适配器父scsi_hostN</span>
--adapter-parent-wwnn <span class="token operator">&lt;</span>string<span class="token operator">></span>  		<span class="token comment"># 用于底层vHBA存储的适配器父scsi_hostN wwnn</span>
--adapter-parent-wwpn <span class="token operator">&lt;</span>string<span class="token operator">></span>  		<span class="token comment"># 用于底层vHBA存储的适配器父scsi_hostN wwpn</span>
--adapter-parent-fabric-wwn <span class="token operator">&lt;</span>string<span class="token operator">></span>  	<span class="token comment"># 用于底层vHBA存储的适配器父scsi_hostN fabric_wwn</span>
--source-protocol-ver <span class="token operator">&lt;</span>string<span class="token operator">></span>  		<span class="token comment"># nfsvers值NFS储存池挂载选项</span>
<span class="token parameter variable">--build</span> 								<span class="token comment"># build the pool as normal</span>
--no-overwrite  						<span class="token comment"># do not overwrite any existing data</span>
--no-overwrite  						<span class="token comment"># overwrite any existing data</span></code></pre>

<h3 id="基于-dir-的-pool"><a href="#基于-dir-的-pool" class="headerlink" title="基于 dir 的 pool"></a>基于 dir 的 pool</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 创建存储池 vm_images_dir</span>
<span class="token function">virsh</span> pool-define-as vm_images_dir <span class="token function">dir</span> <span class="token parameter variable">--target</span> <span class="token string">"/data/vm_images"</span>
<span class="token comment"># 2. /data/vm_images目录如果没有提前创建，可以使用pool-build自动创建</span>
<span class="token function">virsh</span> pool-build vm_images_dir
<span class="token comment"># 3. 启动存储池</span>
<span class="token function">virsh</span> pool-start vm_images_dir
<span class="token comment"># 4. 设置存储池自动启动</span>
<span class="token function">virsh</span> pool-autostart vm_images_dir
<span class="token comment"># 5. 停止存储池，删除之前必须先停止</span>
<span class="token function">virsh</span> pool-destroy <span class="token parameter variable">--pool</span> vm_images_dir
<span class="token comment"># 6. 删除存储池</span>
<span class="token function">virsh</span> pool-delete <span class="token parameter variable">--pool</span> vm_images_dir		<span class="token comment"># 删除数据</span>
<span class="token function">virsh</span> pool-undefine <span class="token parameter variable">--pool</span> vm_images_dir	<span class="token comment"># 删除配置</span></code></pre>

<h3 id="基于-fs-的-pool"><a href="#基于-fs-的-pool" class="headerlink" title="基于 fs 的 pool"></a>基于 fs 的 pool</h3><p>基于已经创建文件系统的分区</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 准备分区并创建文件系统</span>
<span class="token function">fdisk</span> /dev/sdb
mkfs.ext4 /dev/sdb6
<span class="token comment"># 2. 准备存储池的挂载点目录,如果没有创建，创建存储池后执行`virsh pool-build vm_images_fs`会自动生成</span>
<span class="token function">mkdir</span> /vm_images
<span class="token comment"># 3. 创建存储池 vm_images_fs</span>
<span class="token function">virsh</span> pool-define-as vm_images_fs fs --source-dev <span class="token string">"/dev/sdb6"</span> <span class="token parameter variable">--target</span> <span class="token string">"/vm_images"</span>
	<span class="token comment"># --source-dev：块设备名</span>
	<span class="token comment"># --target：mount到的目录名，libvirtd 会自动mount</span>
<span class="token comment"># 4、5、6 启动、自动启动，停止、删除等操作所有类型的对于所有类型的存储池都一样，这里就不重复了</span></code></pre>

<h3 id="基于-disk-的-pool"><a href="#基于-disk-的-pool" class="headerlink" title="基于 disk 的 pool"></a>基于 disk 的 pool</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 准备工作：确认/dev/sdb磁盘的格式为gpt</span>
<span class="token comment"># 2. 创建存储池</span>
<span class="token function">virsh</span> pool-define-as vm_images_disk disk --source-dev <span class="token string">"/dev/sdb"</span> --source-format gpt  <span class="token parameter variable">--target</span> <span class="token string">"/dev"</span>
<span class="token comment"># 或者直接编辑xml配置文件</span>
<span class="token operator">&lt;</span>pool <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'disk'</span><span class="token operator">></span>
	<span class="token operator">&lt;</span>name<span class="token operator">></span>vm_images_disk<span class="token operator">&lt;</span>/name<span class="token operator">></span>
	<span class="token operator">&lt;</span>source<span class="token operator">></span>
		<span class="token operator">&lt;</span>device <span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token string">'/dev/sdb'</span>/<span class="token operator">></span>
		<span class="token operator">&lt;</span>format <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'gpt'</span>/<span class="token operator">></span>
	<span class="token operator">&lt;</span>/source<span class="token operator">></span>
	<span class="token operator">&lt;</span>target<span class="token operator">></span>
		<span class="token operator">&lt;</span>path<span class="token operator">></span>/dev<span class="token operator">&lt;</span>/path<span class="token operator">></span>
	<span class="token operator">&lt;</span>/target<span class="token operator">></span>
<span class="token operator">&lt;</span>/pool<span class="token operator">></span>
<span class="token comment"># 通过xml配置文件创建存储池</span>
<span class="token function">virsh</span> pool-define vm_images_disk.xml</code></pre>

<h3 id="基于-LVM-的-pool"><a href="#基于-LVM-的-pool" class="headerlink" title="基于 LVM 的 pool"></a>基于 LVM 的 pool</h3><p>没有卷组，直接创建存储池：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> pool-define-as vm_images_lvm logical --source-dev<span class="token operator">=</span>/dev/sdb
<span class="token function">virsh</span> pool-build vm_images_lvm</code></pre>

<p>基于已有卷组，创建存储池（推荐）：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> pool-define-as vm_images_lvm logical --source-name<span class="token operator">=</span>vm_images_lvm</code></pre>

<h3 id="基于-NFS-的-pool"><a href="#基于-NFS-的-pool" class="headerlink" title="基于 NFS 的 pool"></a>基于 NFS 的 pool</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在宿主机执行：</span>
<span class="token function">virsh</span> pool-define-as vm_images_nfs netfs <span class="token punctuation">\</span>
--source-host <span class="token number">10.0</span>.0.18 --source-path /data/kvmdata <span class="token parameter variable">--target</span> /data/vm_images_nfs</code></pre>

<h2 id="管理存储卷"><a href="#管理存储卷" class="headerlink" title="管理存储卷"></a>管理存储卷</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># virsh help volume</span>

vol-clone           <span class="token comment"># 克隆卷</span>
vol-create-as       <span class="token comment"># 通过一组参数创建卷</span>
vol-create          <span class="token comment"># 通过XML文件创建卷</span>
vol-create-from     <span class="token comment"># 通过输入的其他卷创建—个新的卷</span>
vol-delete          <span class="token comment"># 删除一个卷</span>
vol-download        <span class="token comment"># 下载卷的内容到一个文件</span>
vol-dumpxml         <span class="token comment"># 保存卷信息的信息到xML文件中</span>
vol-info            <span class="token comment"># 存储卷的信息</span>
vol-key         	<span class="token comment"># 根据卷名或路径返回卷的key</span>
vol-list            <span class="token comment"># 列出卷</span>
vol-name            <span class="token comment"># 根据卷的key或路径返回卷名</span>
vol-path            <span class="token comment"># 根据卷名或key返回卷的路径</span>
vol-pool            <span class="token comment"># 根据卷的key或路径返回存储池</span>
vol-resize          <span class="token comment"># 调整卷大小</span>
vol-upload          <span class="token comment"># 上传文件内容到一个卷</span>
vol-wipe            <span class="token comment"># wipe ─个卷</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># virsh help vol-create-as</span>

<span class="token function">virsh</span> vol-create-as <span class="token operator">&lt;</span>pool<span class="token operator">></span> <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token operator">&lt;</span>capacity<span class="token operator">></span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

OPTIONS
<span class="token punctuation">[</span>--pool<span class="token punctuation">]</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  pool name
<span class="token punctuation">[</span>--name<span class="token punctuation">]</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  name of the volume
<span class="token punctuation">[</span>--capacity<span class="token punctuation">]</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  size of the vol, as scaled integer <span class="token punctuation">(</span>default bytes<span class="token punctuation">)</span>
<span class="token parameter variable">--allocation</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  initial allocation size, as scaled integer <span class="token punctuation">(</span>default bytes<span class="token punctuation">)</span>
<span class="token parameter variable">--format</span> <span class="token operator">&lt;</span>string<span class="token operator">></span>  <span class="token function">file</span> <span class="token function">format</span> <span class="token builtin class-name">type</span> raw,bochs,qcow,qcow2,qed,vmdk
--backing-vol <span class="token operator">&lt;</span>string<span class="token operator">></span>  the backing volume <span class="token keyword">if</span> taking a snapshot
--backing-vol-format <span class="token operator">&lt;</span>string<span class="token operator">></span>  <span class="token function">format</span> of backing volume <span class="token keyword">if</span> taking a snapshot
--prealloc-metadata  preallocate metadata <span class="token punctuation">(</span>for qcow2 instead of full allocation<span class="token punctuation">)</span>
--print-xml      print XML document, but don't define/create</code></pre>

<p>基于文件系统的存储池，创建其中的存储卷，可以使用 <code>touch</code>、<code>mkdir</code>、<code>qemu-img create</code>等命令，这些命令只能创建特定的存储卷，例如<code>touch</code>创建 raw 格式的文件，<code>mkdir</code>创建目录，<code>qemu-img create</code>创建磁盘镜像。</p>
<p>基于磁盘的存储池，创建其中的存储卷，也有对应命令，例如 disk 格式的存储池，使用<code>fdisk</code>创建分区；logical 格式的存储池，使用<code>lvcreate</code>，等等</p>
<p><code>virsh vol-create-as</code> 配置项丰富，可以给各种类型的存储池，创建各种格式的存储卷，可以说相当于上述各种命令的合体</p>
<h3 id="基于目录的-pool-的-volume-管理"><a href="#基于目录的-pool-的-volume-管理" class="headerlink" title="基于目录的 pool 的 volume 管理"></a>基于目录的 pool 的 volume 管理</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新建</span>
<span class="token function">virsh</span> vol-create-as vm_images_dir test1.qcow2 1g <span class="token parameter variable">--format</span> qcow2
<span class="token comment"># 删除</span>
<span class="token function">virsh</span> vol-delete test1.qcow2 vm_images_dir</code></pre>

<h3 id="基于-LVM-的-pool-的-volume-管理"><a href="#基于-LVM-的-pool-的-volume-管理" class="headerlink" title="基于 LVM 的 pool 的 volume 管理"></a>基于 LVM 的 pool 的 volume 管理</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新建</span>
<span class="token function">virsh</span> vol-create-as vm_images_lvm lvvol1 10g
<span class="token comment"># 删除</span>
<span class="token function">virsh</span> vol-delete lvvol1 vm_images_lvm</code></pre>

<h3 id="克隆存储卷"><a href="#克隆存储卷" class="headerlink" title="克隆存储卷"></a>克隆存储卷</h3><p>克隆比直接 cp 复制文件要好</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> vol-clone <span class="token operator">&lt;</span>vol<span class="token operator">></span> <span class="token operator">&lt;</span>newname<span class="token operator">></span> <span class="token punctuation">[</span>--pool <span class="token operator">&lt;</span>string<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>--prealloc-metadata<span class="token punctuation">]</span> <span class="token punctuation">[</span>--reflink<span class="token punctuation">]</span></code></pre>

<h3 id="向虚拟机添加存储卷"><a href="#向虚拟机添加存储卷" class="headerlink" title="向虚拟机添加存储卷"></a>向虚拟机添加存储卷</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> attach-disk <span class="token operator">&lt;</span>domain<span class="token operator">></span> <span class="token operator">&lt;</span>source<span class="token operator">></span> <span class="token operator">&lt;</span>target<span class="token operator">></span> <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span>

<span class="token function">virsh</span> attach-disk <span class="token punctuation">\</span>
<span class="token parameter variable">--domain</span> centos7 <span class="token parameter variable">--sourcetype</span> block <span class="token parameter variable">--source</span> /dev/vm_images_lvm/lvvol1 <span class="token parameter variable">--target</span> vdb</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/qemu-img/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/qemu-img/" class="post-title-link" itemprop="url">qemu-img</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:42:52" itemprop="dateCreated datePublished" datetime="2020-12-09T23:42:52+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/" itemprop="url" rel="index"><span itemprop="name">虚拟化和KVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="管理磁盘快照"><a href="#管理磁盘快照" class="headerlink" title="管理磁盘快照"></a>管理磁盘快照</h2><h2 id="管理虚拟磁盘文件"><a href="#管理虚拟磁盘文件" class="headerlink" title="管理虚拟磁盘文件"></a>管理虚拟磁盘文件</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/" class="post-title-link" itemprop="url">虚拟化和KVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:42:34" itemprop="dateCreated datePublished" datetime="2020-12-09T23:42:34+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E8%99%9A%E6%8B%9F%E5%8C%96%E5%92%8CKVM/" itemprop="url" rel="index"><span itemprop="name">虚拟化和KVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="虚拟化基础"><a href="#虚拟化基础" class="headerlink" title="虚拟化基础"></a>虚拟化基础</h2><h3 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h3><ul>
<li>Hyperisor 是一种运行在基础物理服务器和操作系统之间的中间软件层，其可以允许多个操作系统和应用共享底层的内存、CPU、磁盘等物理硬件，也可以叫做 <strong>VMM</strong>（vritual machine moitor），即 <strong>虚拟机监视器</strong></li>
<li>Hypervisor 是所有虚拟化技术的核心,非中断地支持多工作负载迁移的能力是 Hypervisor 的基本功能,当服务器启动并执行 Hypervisor 时,它会给每一台虚拟机分配适量的内存、CPU、网络和磁盘,并加载所有虚拟机的客户操作系统</li>
</ul>
<p>X86 CPU 的保护环：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604731710496.png"></p>
<h4 id="Hypervisor-分类"><a href="#Hypervisor-分类" class="headerlink" title="Hypervisor 分类"></a>Hypervisor 分类</h4><ul>
<li>裸金属型</li>
<li>宿主型</li>
</ul>
<h3 id="虚拟化技术分类"><a href="#虚拟化技术分类" class="headerlink" title="虚拟化技术分类"></a>虚拟化技术分类</h3><h4 id="模拟器-x2F-软件仿真"><a href="#模拟器-x2F-软件仿真" class="headerlink" title="模拟器 &#x2F; 软件仿真"></a>模拟器 &#x2F; 软件仿真</h4><p>通过软件模拟完整的硬件环境来虚拟化来宾平台，可以模拟 X86、ARM 、PowerPC 等多种 CPU</p>
<p>性能比较低</p>
<p>产品或方案：QEMU</p>
<h4 id="全虚拟化"><a href="#全虚拟化" class="headerlink" title="全虚拟化"></a>全虚拟化</h4><p>全虚拟化不做 CPU 和内存模拟，只对 CPU 和内存做相应的分配等操作</p>
<h5 id="软件辅助的全虚拟化"><a href="#软件辅助的全虚拟化" class="headerlink" title="软件辅助的全虚拟化"></a>软件辅助的全虚拟化</h5><p>在 Intel 等 CPU 厂商还没有发布 x86 CPU 虚拟化技术之前，完全虚拟化都是通过软件辅助的方式来实现的</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604733842976.png"></p>
<h5 id="硬件辅助的完全虚拟化"><a href="#硬件辅助的完全虚拟化" class="headerlink" title="硬件辅助的完全虚拟化"></a>硬件辅助的完全虚拟化</h5><p>2005 年 Intel 提出并开发了由 CPU 直接支持的虚拟化技术，CPU 可以明确的分辨出来自 GuestOS 的特权指令，并针对 GuestOS 进行特权操作，而不会影响到 HostOS。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604733918601.png"></p>
<p>将虚拟化模块加载到 HostOS 的内核中,例如:KVM。<br>KVM 通过在 HostOS 内核中加载 KVM Kernel Module 来将 HostOS 转换成为一个 VMM。所以此时 VMM 可以看作是 HostOS，反之亦然。</p>
<h4 id="半虚拟化"><a href="#半虚拟化" class="headerlink" title="半虚拟化"></a>半虚拟化</h4><p>半虚拟化要求 guest OS 知道自己运行在虚拟化环境中，因此 guest OS 的系统架构必须和宿主机的系统架构相同，并且要求对 guest OS 的内核做相应的修改。</p>
<p>如果不修改内核而实现半虚拟化，可以在每一个 GuestOS 中安装半虚拟化软件，如 VMTools、RHEVTools。</p>
<h3 id="云计算"><a href="#云计算" class="headerlink" title="云计算"></a>云计算</h3><p>美国国家标准与技术研究院（NIST）定义：</p>
<blockquote>
<p>云计算是一种按使用量付费的模式，这种模式提供可用的、便捷的、按需的网络访问， 进入可配置的计算资源共享池（资源包括网络，服务器，存储，应用软件，服务），这些资源能够被快速提供，只需投入很少的管理工作，或与服务供应商进行很少的交互</p>
</blockquote>
<ul>
<li>公有云：阿里云、腾讯云等，个人都可以付费使用，不需要关心底层硬件，但是数据安全需要考虑</li>
<li>私有云：在自己公司内部或 IDC 自建 Openstack、VMware 等环境</li>
<li>混合云：既要使用公有云，又要使用私有云，即自己的私有云的部分业务和公有云有交接，这部分称为混合云</li>
</ul>
<p>云计算分层：SaaS、PaaS、IaaS</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610267352052.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1610267374788.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1614168890933.png"></p>
<ul>
<li>IaaS：按需创建主机</li>
<li>PaaS：按需创建应用程序并部署应用程序</li>
</ul>
<p>虚拟化和云计算：</p>
<p>云计算是一种服务模式，虚拟化是一种技术；</p>
<p>虚拟化是云计算的重要支撑技术。</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="center">虚拟化</th>
<th align="center">云</th>
</tr>
</thead>
<tbody><tr>
<td align="left">定义</td>
<td align="center">技术</td>
<td align="center">方法</td>
</tr>
<tr>
<td align="left">目的</td>
<td align="center">从 1 个物理硬件系统创建多个模拟环境</td>
<td align="center">汇聚并自动化分配虚拟资源以供按需使用</td>
</tr>
<tr>
<td align="left">用途</td>
<td align="center">针对具体用途为特定用户提供打包资源</td>
<td align="center">针对多种用途为用户群组提供不同资源</td>
</tr>
<tr>
<td align="left">配置</td>
<td align="center">基于镜像</td>
<td align="center">基于模板</td>
</tr>
<tr>
<td align="left">使用寿命</td>
<td align="center">数年（长期）</td>
<td align="center">数小时至数月（短期）</td>
</tr>
<tr>
<td align="left">成本</td>
<td align="center">资本支出（CAPEX）高、运营支出（OPEX）低</td>
<td align="center">私有云：CAPEX 高、OPEX 低 公共云：CAPEX 低、OPEX 高</td>
</tr>
<tr>
<td align="left">可扩展性</td>
<td align="center">纵向扩展</td>
<td align="center">横向扩展</td>
</tr>
<tr>
<td align="left">工作负载</td>
<td align="center">有状态</td>
<td align="center">无状态</td>
</tr>
<tr>
<td align="left">租赁</td>
<td align="center">单一租户</td>
<td align="center">多个租户</td>
</tr>
</tbody></table>
<p>参考：<a target="_blank" rel="noopener" href="https://www.redhat.com/zh/topics/cloud-computing/cloud-vs-virtualization">https://www.redhat.com/zh/topics/cloud-computing/cloud-vs-virtualization</a></p>
<h2 id="虚拟化技术之-KVM-架构和部署"><a href="#虚拟化技术之-KVM-架构和部署" class="headerlink" title="虚拟化技术之 KVM 架构和部署"></a>虚拟化技术之 KVM 架构和部署</h2><h3 id="KVM-架构"><a href="#KVM-架构" class="headerlink" title="KVM 架构"></a>KVM 架构</h3><ul>
<li><p>kvm 只提供了三个模块：kvm.ko、kvm_intel.ko、kvm_amd.ko，后两个模块是根据物理主机的 CPU 所属厂家自动匹配的</p>
</li>
<li><p>kvm 开发团队借用了 qemu 代码，并作了一些修改，形成了一套工具，也就是 qemu-kvm</p>
</li>
<li><p>&#x2F;dev&#x2F;kvm 设备是 kvm 虚拟出来的一个设备文件</p>
</li>
<li><p>&#x2F;dev&#x2F;kvm 只是 kvm 内核模块提供给用户空间的一个接口，这个接口被 qemu-kvm 调用，通过 ioctl 系统调用就可以给用户提供一个工具用以创建，删除，管理虚拟机等</p>
</li>
</ul>
<p><strong>KVM 体系结构：</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604735745767.png"></p>
<ul>
<li>KVM：初始化 CPU 硬件，打开虚拟机模式，负责 CPU、内存、中断控制器、时钟。由内核模块 kvm_xxx.ko 实现，工作在 Hypervisor，设备&#x2F;dev&#x2F;kvm，是一个字符设备，在用户空间可以通过 ioctl()系统调用来完成 KVM 创建、启动、为 VM 分配内存、读写 VCPU（虚拟 CPU）的寄存器、向 CPU 注入中断、时钟等管理功能</li>
<li>QEMU：工作在用户空间，主要用于实现模拟 IO 设备，如显卡、网卡、硬盘等，qemu-kvm 进程，用于实现一个虚拟机实例</li>
<li>libvirt：后文详细介绍</li>
</ul>
<p><strong>KVM 模块载入后的系统的运行模式：</strong></p>
<img data-src="//img.to2b.cn/blog/ljk/1604736440428.png" style="zoom:150%;" />

<ul>
<li>内核模式：GuestOS 执行 I&#x2F;O 类操作，或其他的特殊指令的操作；又称为“来宾-内核”模式</li>
<li>用户模式：代表 GuestOS 请求 I&#x2F;O 类操作</li>
<li>来宾模式：GuestOS 的非 I&#x2F;O 类操作；有被称为“来宾-用户“模式，称作虚拟机的用户模式更贴切</li>
</ul>
<p><strong>KVM 的组件：</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604736735407.png"></p>
<p><strong>KVM 功能：</strong></p>
<ul>
<li>支持 CPU 和 Memory 超分(Overcommit)</li>
<li>支持半虚拟化 I&#x2F;O (virtio)</li>
<li>支持热插拔 (cpu、块设备、网络设备等)</li>
<li>支持对称多处理(Symmetric Multi-Processing 缩写为 SMP )</li>
<li>支持实时迁移(Live Migration)</li>
<li>支持 PCI 设备直接分配和 单根 I&#x2F;O 虚拟化 (SR-IOV)</li>
<li>支持内核同页合并 (KSM )</li>
<li>支持 NUMA (Non-Uniform Memory Access 非一致存储访问结构 )</li>
</ul>
<p><strong>QEMU：</strong></p>
<p>Qemu 是纯软件实现的虚拟化模拟器，几乎可以模拟任何硬件设备，能够模拟一台能够独立运行操作系统的虚拟机，因为 Qemu 是纯软件实现的，所有的指令都要经 Qemu，性能非常低，所以，在生产环境中，大多数的做法都是配合 KVM 来完成虚拟化工作，KVM 完成复杂及要求比较高的设备虚拟化，而 Qemu 完成像鼠标、键盘等设备的虚拟化。</p>
<p><strong>KVM 和 Xen：</strong></p>
<p>总的来说，Xen 性能更高，但是 KVM 更简单易用，所以 KVM 更流行</p>
<p>目前在各大公有云厂商新购买的虚拟机基本运行在 KVM 环境下,就连早期一直使用 Xen 的 AWS 也在 2017 年开始逐渐转换到 KVM 环境</p>
<h3 id="RHEL-CentOS-虚拟设备三种工作模式"><a href="#RHEL-CentOS-虚拟设备三种工作模式" class="headerlink" title="RHEL(CentOS)虚拟设备三种工作模式"></a>RHEL(CentOS)虚拟设备三种工作模式</h3><p>Red Hat Enterprise Linux 7 的虚拟化功能为虚拟机提供了三种不同形式的系统设备。这些硬件设备都被显示为物理连接到虚拟机，但设备的驱动以不同方式工作。这三种形式包括：</p>
<ul>
<li>虚拟和仿真设备</li>
<li>半虚拟化设备</li>
<li>物理共享设备</li>
</ul>
<p><strong>虚拟和仿真设备：</strong></p>
<p>完全使用软件实现的虚拟化设备</p>
<p><strong>半虚拟化设备：</strong></p>
<ul>
<li>KVM 为虚拟机提供准虚拟化设备，它使用 Virtio API 作为 VMM 和 GuestOS 的中间层</li>
<li>virtio 设备由两部分组成：主机设备和客机驱动。半虚拟化设备驱动允许 GuestOS 访问 HostOS 上的物理设备</li>
<li>半虚拟化设备的驱动必须安装在客机操作系统上</li>
<li>当虚拟机运行大小需要密集 I&#x2F;O 操作的应用程序时，推荐使用半虚拟化设备,而不是使用仿真设备</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">半虚拟化网络设备：virtio-net
半虚拟化块设备：virtio-blk
半虚拟化控制器设备：virtio-scsi
半虚拟化时钟：
半虚拟化串口设备：virtio-serial
气球设备：virtio-balloon
半虚拟化随机数字生成器：virtio-rng
半虚拟化图形卡：</code></pre>

<p><strong>透传物理主机设备：</strong></p>
<p>特定硬件平台允许虚拟机直接访问多种硬件设备及组件。在虚拟化中,此操作被称为“设备分配 ”(device assignment)。设备分配又被称作 “传递 ”(passthrough)</p>
<pre class="language-none"><code class="language-none">VFIO 设备分配：
USB 传递：
SR-IOV：
NPIV：</code></pre>

<h3 id="KVM-集中管理和控制"><a href="#KVM-集中管理和控制" class="headerlink" title="KVM 集中管理和控制"></a>KVM 集中管理和控制</h3><ul>
<li>oVirt：功能强大，Redhat 虚拟化管理平台 RHEV 的开源版</li>
<li>WebVirtMgr：virt-manager 的 Web 模式的替代品</li>
<li>OpenStack：最主流的开源虚拟化管理平台</li>
<li>Proxmox virtualization environment：简称 PVE，开源免费的基于 linux 的企业级虚拟化方案，可以认为是简化版的 OpenStack</li>
</ul>
<p>重点学习 OpenStack 和 PVE</p>
<h3 id="安装-KVM-工具包"><a href="#安装-KVM-工具包" class="headerlink" title="安装 KVM 工具包"></a>安装 KVM 工具包</h3><ul>
<li>qemu-kvm：为 kvm 提供底层仿真支持</li>
<li>libvirt-daemon：libvirtd 守护进程，管理虚拟机</li>
<li>libvirt-client：用户端软件，提供客户端管理命令</li>
<li>libvirt-daemon-driver-qemu：libvirtd 连接 qemu 的驱动</li>
<li>libvirt：提供统一 API，是使用最多的 KVM 虚拟化管理工具，通过 libvirt 调用 KVM 创建虚拟机，其不但能管理 KVM，还能管理 VMware、Xen、Hyper-V、virtualBox 等虚拟化方案</li>
<li>virt-manager：图形界面管理工具，其底层是调用 libvirt API 来完成对虚拟机的各种操作</li>
<li>virt-install：虚拟机命令行安装工具</li>
<li>virsh：基于 libvirt API 创建的命令行工具，它可以作为图形化的 virt-manager 应用的备选工具。</li>
<li>virt-viewer：通过 VNC 和 SPICE 协议显示虚拟机器图形控制台的最小工具。该工具来自 virtviewer 程序包</li>
<li>cockpit：CentOS8 专门提供的基于 Web 的虚拟机管理界面</li>
</ul>
<h4 id="libvirt-包功能"><a href="#libvirt-包功能" class="headerlink" title="libvirt 包功能"></a>libvirt 包功能</h4><p>libvirt 程序包提供：</p>
<ol>
<li>一个稳定的通用层来安全地管理主机上的虚拟机</li>
<li>一个管理本地系统和联网主机的通用接口</li>
</ol>
<p>Libvirt API 是相对独立与 VMM 的虚拟化应用程序接口，在 VMM 支持的情况下，调用 Libvirt API 进行部署、创建、修改、监测、控制、迁移以及停止虚拟机等操作。</p>
<p>尽管 libvirt 可同时访问多个主机，但 API 只限于单节点操作。</p>
<p>libvirt 主要的功能是管理单节点主机，列举、监测和使用管理节点上的可用资源，其中包括 CPU、内存、储存、网络和非一致性内存访问(NUMA)分区。</p>
<p>virt-manager 与 virsh 是基于 Libvirt API 构建的高级管理工具。管理工具可以位于独立于主机的物理机上，并通过安全协议和主机进行交流。</p>
<p><strong>libvirt 结构图：</strong></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604749854253.png"></p>
<h4 id="安装-KVM-相关包"><a href="#安装-KVM-相关包" class="headerlink" title="安装 KVM 相关包"></a>安装 KVM 相关包</h4><ul>
<li>CentOS</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> qemu-kvm libvirt virt-manager virt-install  virt-viewer
systemctl start <span class="token parameter variable">--now</span> libvirtd

<span class="token comment"># CentOS 8 还提供基于Web的虚拟机管理方式</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> cockpit</code></pre>

<ul>
<li>Ubuntu</li>
</ul>
<p>官方文档：<a target="_blank" rel="noopener" href="https://ubuntu.com/server/docs/virtualization-libvirt">https://ubuntu.com/server/docs/virtualization-libvirt</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># kvm-ok 验证是否支持kvm,只有Ubuntu支持,CentOS 不支持</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> qemu-kvm virt-manager libvirt-daemon-system</code></pre>

<h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h2><p>三种方式：</p>
<ol>
<li>virt-manger 工具交互式安装</li>
<li>virt-install 命令安装</li>
<li>基于现有虚拟机磁盘为模版创建新的虚拟机</li>
</ol>
<p>重点掌握 virt-install 命令配合 PXE 自动实现自动安装系统</p>
<h3 id="virt-install-命令"><a href="#virt-install-命令" class="headerlink" title="virt-install 命令"></a>virt-install 命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash">virt-install <span class="token parameter variable">--help</span></code></pre>

<p>virt-install 的选项很多，需要好好研究，但是这里就不一一列举了</p>
<h3 id="qemu-img-命令"><a href="#qemu-img-命令" class="headerlink" title="qemu-img 命令"></a>qemu-img 命令</h3><p>利用 qemu-img 命令创建虚拟磁盘，注意: qemu-img create 会覆盖原文件，所以要先检查是否有同名文件存在</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> qemu-img create <span class="token parameter variable">-f</span> qcow2 /var/lib/libvirt/images/centos7-pxe1.qcow2 20G</code></pre>

<h3 id="范例：virt-install-amp-PXE"><a href="#范例：virt-install-amp-PXE" class="headerlink" title="范例：virt-install &amp; PXE"></a>范例：virt-install &amp; PXE</h3><p>HostOS：ubuntu20.04 （物理机）</p>
<p>GuestOS：Centos7</p>
<ol>
<li><p>配置 PXE 环境，参考前面的笔记</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">install</span>
xconfig <span class="token parameter variable">--startxonboot</span>
keyboard <span class="token parameter variable">--vckeymap</span><span class="token operator">=</span>us <span class="token parameter variable">--xlayouts</span><span class="token operator">=</span><span class="token string">'us'</span>
lang en_US.UTF-8
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$1</span><span class="token variable">$YyodG</span>.X7<span class="token variable">$LzhHqxWONgSh0NBoC730o0</span>
url <span class="token parameter variable">--url</span><span class="token operator">=</span><span class="token string">"http://10.0.0.1/centos/7/os/x86_64"</span>
auth <span class="token parameter variable">--useshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>sha512
text
firstboot <span class="token parameter variable">--enable</span>
selinux <span class="token parameter variable">--disabled</span>
skipx
services <span class="token parameter variable">--disabled</span><span class="token operator">=</span><span class="token string">"chronyd"</span>
ignoredisk --only-use<span class="token operator">=</span>vda
firewall <span class="token parameter variable">--disabled</span>
network <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0
network <span class="token parameter variable">--hostname</span><span class="token operator">=</span>c7
<span class="token function">reboot</span>
timezone Asia/Shanghai <span class="token parameter variable">--nontp</span>
bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">"net.ifnames=0"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr --boot-drive<span class="token operator">=</span>vda
zerombr
clearpart <span class="token parameter variable">--all</span> <span class="token parameter variable">--initlabel</span>
part /boot <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--ondisk</span><span class="token operator">=</span>vda <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">300</span>
part pv.01 <span class="token parameter variable">--size</span> <span class="token number">1</span> <span class="token parameter variable">--grow</span>
volgroup volgrp pv.01
logvol swap <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>swap <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"swap"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">2048</span>
logvol / <span class="token parameter variable">--vgname</span><span class="token operator">=</span>volgrp <span class="token parameter variable">--name</span><span class="token operator">=</span>root <span class="token parameter variable">--fstype</span><span class="token operator">=</span><span class="token string">"ext4"</span> <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--grow</span>
%post
<span class="token function">useradd</span> lujinkai
%end
%packages
@^minimal
@core
%end</code></pre>
</li>
<li><p>qemu-img 命令创建虚拟磁盘</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> qemu-img create <span class="token parameter variable">-f</span> qcow2 /var/lib/libvirt/images/centos7-pxe1.qcow2 20G</code></pre>
</li>
<li><p>virt-install 命令安装</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> virt-install <span class="token punctuation">\</span>
--virt-type kvm <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> centos7-pxe1 <span class="token punctuation">\</span>
<span class="token parameter variable">--memory</span> <span class="token number">2048</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--vcpus</span> <span class="token number">1</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--disk</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>/var/lib/libvirt/images/centos7-pxe1.qcow2,bus<span class="token operator">=</span>virtio <span class="token punctuation">\</span>
<span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>default <span class="token punctuation">\</span>
<span class="token parameter variable">--graphics</span> vnc,listen<span class="token operator">=</span><span class="token number">0.0</span>.0.0 <span class="token punctuation">\</span>
<span class="token parameter variable">--location</span><span class="token operator">=</span>/usr/local/src/CentOS-7-x86_64-Minimal-2003.iso <span class="token punctuation">\</span>
--extra-args<span class="token operator">=</span><span class="token string">"ks=http://10.0.0.1/ks/centos7.cfg"</span></code></pre>

<p><font color=red>注意：</font> –disk 的 bus 选项一定要指定，因为默认 bus&#x3D;scsi，而这里直接在 ubutu 物理机中安装，硬盘是 sata，可以指定 bus&#x3D;sata，不过这样是全虚拟化，而指定 bus&#x3D;virtio 是半虚拟化，性能更好</p>
</li>
<li><p>安装成功，初始化配置，这里只说一点：</p>
<p>关于 ssh 连接慢的问题，宿主机 ubuntu 修改&#x2F;etc&#x2F;ssh&#x2F;ssh_conf：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">GSSAPIAuthentication no

ServerAliveInterval <span class="token number">55</span>
ServerAliveCountMax <span class="token number">9</span>
</code></pre>

<p>来宾机 centos 修改&#x2F;etc&#x2F;ssh&#x2F;sshd_conf：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">UseDNS no	<span class="token comment"># 跳过dns验证</span></code></pre></li>
</ol>
<h3 id="范例：基于现有虚拟机磁盘为模版创建新的虚拟机"><a href="#范例：基于现有虚拟机磁盘为模版创建新的虚拟机" class="headerlink" title="范例：基于现有虚拟机磁盘为模版创建新的虚拟机"></a>范例：基于现有虚拟机磁盘为模版创建新的虚拟机</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 先复制</span>
lujinkai@Z510:~$ <span class="token builtin class-name">cd</span> /var/lib/libvirt/images/
lujinkai@Z510:/var/lib/libvirt/images$ <span class="token function">sudo</span> <span class="token function">cp</span> centos7-pxe1.qcow2 centos7-pxe3.qcow2
<span class="token comment"># 然后创建</span>
lujinkai@Z510:/var/lib/libvirt/images$ <span class="token function">sudo</span> virt-install <span class="token punctuation">\</span>
<span class="token operator">></span> --virt-type kvm <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--name</span> centos7-pxe3 <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--memory</span> <span class="token number">2048</span> <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--vcpus</span> <span class="token number">1</span> <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--disk</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span>virtio,path<span class="token operator">=</span>/var/lib/libvirt/images/centos7-pxe3.qcow2 <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>default,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--graphics</span> vnc,listen<span class="token operator">=</span><span class="token number">0.0</span>.0.0 <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--noautoconsole</span> <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--autostart</span> <span class="token punctuation">\</span>
<span class="token operator">></span> <span class="token parameter variable">--boot</span> hd
WARNING  未检测到操作系统，虚拟机性能可能会受到影响。使用 --os-variant 选项指定操作系统以获得最佳性能。

开始安装<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
域创建完成。</code></pre>

<p>这样相当于直接拷贝镜像，开机后会发现 ip 冲突，需要手动修改 ip，不过 MAC 没有冲突</p>
<h2 id="管理虚拟机"><a href="#管理虚拟机" class="headerlink" title="管理虚拟机"></a>管理虚拟机</h2><h3 id="使用半虚拟化驱动-virtio"><a href="#使用半虚拟化驱动-virtio" class="headerlink" title="使用半虚拟化驱动 virtio"></a>使用半虚拟化驱动 virtio</h3><p>为了提高内存、硬盘、网络的性能，需要支持半虚拟化</p>
<h4 id="virtio-工作原理"><a href="#virtio-工作原理" class="headerlink" title="virtio 工作原理"></a>virtio 工作原理</h4><p>virtio 是一种 I&#x2F;O 半虚拟化解决方案,是一套通用 I&#x2F;O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I&#x2F;O 设备的抽象，提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率，windows 系统需要单独安装 virtio 驱 动，linux 系统自带 virtio 驱动</p>
<img data-src="//img.to2b.cn/blog/ljk/1604972341007.png" style="zoom: 50%;" />

<img data-src="//img.to2b.cn/blog/ljk/1604972371669.png" style="zoom:50%;" />

<img data-src="//img.to2b.cn/blog/ljk/1604973329811.png" style="zoom: 67%;" />

<p>virtio 使用 virtqueue 来实现 I&#x2F;O 机制，每个 virtqueue 就是一个承载大量数据的队列，具体使用多少个队列取决于需求，例如,virtio 网络驱动程序(virtio-net)使用两个队列(一个用于接受，另一个用于发送)，而 virtio 块驱动程序(virtio-blk)仅使用一个队列</p>
<img data-src="//img.to2b.cn/blog/ljk/1604973449546.png" style="zoom:;" />

<p>使用统一的 virtio 接口，可以支持多种硬件设备：</p>
<ul>
<li>不同的虚拟设备和不同的虚拟机可以有不同的前端驱动</li>
<li>不同的硬件设备可以有不同的后端驱动</li>
<li>两者之间的交互遵循 virtio 的标准</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1604973998582.png"></p>
<h4 id="virtio-驱动安装"><a href="#virtio-驱动安装" class="headerlink" title="virtio 驱动安装"></a>virtio 驱动安装</h4><p>Linux 自带，Windows 需要额外安装</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 如果有红帽的RHN订阅,可以从以下位置下载virtio-win包</span>
https://rhn.redhat.com/rhn/software/packages/details/Overview.do?pid<span class="token operator">=</span><span class="token number">868414</span>
<span class="token comment"># 从社区获得</span>
http://www.linux-kvm.org/page/Downloads
https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html</code></pre>

<h3 id="安装与配置-QEMU-guest-agent"><a href="#安装与配置-QEMU-guest-agent" class="headerlink" title="安装与配置 QEMU guest agent"></a>安装与配置 QEMU guest agent</h3><p>在 GuestOS（VM）中安装 QEMU guest agent，HostOS 就可以调用 libvirt 向 VM 发送命令，例如：“冻结”、“释放文件系统、虚拟 CPU 的热添加及移除等</p>
<ul>
<li>RHEL&#x2F;CentOS 中有相应的安装包：qemu-guest-agent-xxx.rpm</li>
<li>Windows 需要手工安装</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token function">install</span> qemu-guest-agent.x86_64
<span class="token comment"># 启动</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start qemu-guest-agent.service</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> <span class="token function">shutdown</span> <span class="token parameter variable">--mode</span><span class="token operator">=</span>agen	<span class="token comment"># 比--mode=acpi更加安全地关闭操作系统</span>
<span class="token function">virsh</span> snapshot-create <span class="token parameter variable">-quiesce</span>	<span class="token comment"># 在创建快照之前面,将缓存的内容刷入到磁盘</span>
<span class="token function">virsh</span> domfsfreeze	<span class="token comment"># 静默文件系统</span>
<span class="token function">virsh</span> domfsthaw		<span class="token comment"># 恢复静默的文件系统</span>
<span class="token function">virsh</span> domfstrim		<span class="token comment"># 让虚拟机trim文件系统</span>
<span class="token function">virsh</span> domtime		<span class="token comment"># 获得虚拟机的时间</span>
<span class="token function">virsh</span> setvcpus		<span class="token comment"># 配置虚拟机的vCPU</span>
<span class="token function">virsh</span> domifaddr <span class="token parameter variable">--source</span> agent	<span class="token comment"># 查询虚拟机的IP地址</span>
<span class="token function">virsh</span> domfsinfo		<span class="token comment"># 显示虚拟机的文件系统列表</span>
<span class="token function">virsh</span> set-user-password <span class="token comment"># 设置虚拟机用户的密码</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:~$ <span class="token function">virsh</span> domfsinfo centos7-pxe1
 Mountpoint   Name   Type   Target
------------------------------------
 /            dm-0   ext4   vda
 /boot        vda1   ext4   vda

lujinkai@Z510:~$ <span class="token function">virsh</span> domifaddr <span class="token parameter variable">--source</span> agent centos7-pxe1
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
 lo         00:00:00:00:00:00    ipv4         <span class="token number">127.0</span>.0.1/8
 -          -                    ipv6         ::1/128
 eth0       <span class="token number">52</span>:54:00:5b:08:5d    ipv4         <span class="token number">10.0</span>.0.71/24
 -          -                    ipv6         fe80::5054:ff:fe5b:85d/64</code></pre>

<h3 id="安装和配置-SPICE-agent"><a href="#安装和配置-SPICE-agent" class="headerlink" title="安装和配置 SPICE agent"></a>安装和配置 SPICE agent</h3><p>在 VM 操作系统中安装 SPICE client、SPICE agent 可以让 virt-manager 等图形应用程序更加流畅</p>
<ul>
<li>在 virt-manager 中调整窗口尺寸，SPICE agent 自动调整 X 会话的分辨率</li>
<li>在 Host 与 Guest 之间复制与粘贴</li>
<li>防止鼠标拖尾等</li>
</ul>
<h2 id="libvirt-管理虚拟机"><a href="#libvirt-管理虚拟机" class="headerlink" title="libvirt 管理虚拟机"></a>libvirt 管理虚拟机</h2><p>主要通过 virsh 和 virst-manager 这两个工具调用 libvirt 来实现虚拟机的管理</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1604989585145.png"></p>
<p><strong>注意: 如果 libvirtd 服务意外关闭，将导致相关工具，如 virt-manager 和 virsh 等无法和虚拟机连接，但虚拟机仍会正常运行</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">systemctl start libvirtd.service</code></pre>

<h3 id="virsh-命令"><a href="#virsh-命令" class="headerlink" title="virsh 命令"></a>virsh 命令</h3><p>virsh 可以认为是 virt-manager 的命令行工具</p>
<p>两种工作模式：交互式和非交互式，重点掌握非交互式</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> <span class="token parameter variable">--help</span>	<span class="token comment"># 查看帮助</span>
<span class="token function">virsh</span> <span class="token builtin class-name">help</span> <span class="token builtin class-name">command</span>	<span class="token comment"># 查看子命令帮助</span></code></pre>

<ul>
<li>启动和关闭虚拟机</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> list						<span class="token comment"># 查看运行中的虚拟机</span>
<span class="token function">virsh</span> list <span class="token parameter variable">--all</span>				<span class="token comment"># 查看所有虚拟机</span>
<span class="token function">virsh</span> start     				<span class="token comment"># 启动虚拟机</span>
<span class="token function">virsh</span> <span class="token function">shutdown</span>      			<span class="token comment"># 关闭虚拟机</span></code></pre>

<ul>
<li>暂停和恢复虚拟机</li>
</ul>
<p>暂停时，将内存、寄存器，缓存等全部状态保存到硬盘<br>恢复时，将保存下来的数据读取回去，所以就能按原来的状态运行了</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> <span class="token function">suspend</span>		<span class="token comment"># 暂停虚拟机</span>
<span class="token function">virsh</span> resume		<span class="token comment"># 回复虚拟机</span></code></pre>

<ul>
<li>配置虚拟机开机自启动：</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> autostart centos7-pxe1</code></pre>

<ul>
<li>查看虚拟机配置：</li>
</ul>
<p>每个虚拟机的配置默认存放在 &#x2F;etc&#x2F;libvirt&#x2F;qemu 目录下的 xml 文件中</p>
<p>查看虚拟机配置：相当于查看 &#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;centos7-pxe1.xml 文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> dumpxml <span class="token parameter variable">--domain</span> centos7-pxe1</code></pre>

<ul>
<li>删除虚拟机配置：</li>
</ul>
<p>删除虚拟机配置（qemu&#x2F;xxx.xml），但是不删除磁盘文件（images&#x2F;xxx.qcow2）</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">virsh</span> undefine centos7-pxe1</code></pre>

<h2 id="存储管理"><a href="#存储管理" class="headerlink" title="存储管理"></a>存储管理</h2><p>KVM 中，存储主要有两个概念：</p>
<ol>
<li>存储池</li>
<li>存储卷</li>
</ol>
<h3 id="存储池"><a href="#存储池" class="headerlink" title="存储池"></a>存储池</h3><p>libvirt 以存储池的形式对存储进行统一管理，简化操作</p>
<p>存储池有很多种类型，这取决于存储池是基于什么“介质”创建的，以下是存储池支持的“介质”，分为两种：文件系统 和 磁盘：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 文件系统：</span>
dir：文件系统目录，就是一个目录
fs：预格式化设备，就是一个创建了文件系统的分区，例如：/dev/sdb6
netfs：网络导出的目录，例如 nfs、samba

<span class="token comment"># 磁盘：</span>
disk：物理磁盘设备，直接读写硬盘设备，例如： /dev/sdb
scsi：本地SCSI存储，例如：host0（/sys/class/scsi_host/host0）
iscsi：网络共享iSCSI存储
logical：LVM卷组，最常用，推荐

<span class="token comment"># 不太清楚文件系统还是磁盘：</span>
gluster：Gluster 文件系统
mpath：多路径设备枚举器
rbd:RADOS 设备块/Ceph
sheepdog：Sheepdog文件系统，分布式文件系统
zfs：ZFS pool</code></pre>

<h3 id="存储卷"><a href="#存储卷" class="headerlink" title="存储卷"></a>存储卷</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605619798709.png"></p>
<p>存储卷在存储池中，存储卷的类型取决于存储池的类型：</p>
<p>如果存储池基于文件系统，其中的存储卷就是文件，例如 dir、fs、netfs；<br>如果存储池是基于磁盘，其中的存储卷就是其对应的数据块，例如 logical 对应逻辑卷、disk 对应分区；</p>
<h4 id="qcow2-和-lv"><a href="#qcow2-和-lv" class="headerlink" title="qcow2 和 lv"></a>qcow2 和 lv</h4><p>稀疏文件：从表现形式上来看，当 ls 和 du 命令查看文件，显示的大小不一样，那这个文件就是稀疏文件</p>
<p>虚拟机可以安装在不同的介质上，重点掌握两种：磁盘镜像 和 逻辑卷</p>
<ul>
<li>磁盘镜像</li>
</ul>
<p>磁盘镜像就是个文件，可以存储在各种文件系统中</p>
<p>磁盘镜像的格式有好几种，最常用的是 qcow2 格式，qcow2 格式的镜像文件功能丰富，支持如快照、压缩及加密等功能，缺点就是性能不太好</p>
<p>上文创建虚拟机用的就是磁盘镜像</p>
<ul>
<li>逻辑卷</li>
</ul>
<p>虚拟机直接安装在磁盘，性能最好，LVM 性能稍差，但是更加灵活，所以推荐 LVM，将虚拟机安装在逻辑卷中</p>
<p>使用 virt-manager 将虚拟机安装在逻辑卷，关键点在 step 4，选择自定义的存储，即选择逻辑卷</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605618457482.png"></p>
<p>安装完后启动可能会报错，重启 libvirt 就好了</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605616246298.png"></p>
<p>virt-install 安装虚拟机到逻辑卷，和前面安装虚拟机到磁盘镜像中的区别就是–disk 选项，其他都一样：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">--disk</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>/dev/vm_images_lvm/lv2,bus<span class="token operator">=</span>virtio <span class="token punctuation">\</span></code></pre>

<h3 id="离线工具"><a href="#离线工具" class="headerlink" title="离线工具"></a>离线工具</h3><p>不启动虚拟机的情况下，直接访问管理虚拟机对应的磁盘，即离线访问</p>
<h4 id="离线工具应用"><a href="#离线工具应用" class="headerlink" title="离线工具应用"></a>离线工具应用</h4><ul>
<li>拯救和修复客户无法启动或需要更改启动配置的虚拟机</li>
<li>准备新的磁盘映像，其中包含文件、目录、文件系统、分区、逻辑卷和其他选项</li>
<li>查看或下载虚拟机磁盘中的文件；编辑或上传文件到虚拟机磁盘</li>
<li>通过克隆和修改模板来部署虚拟机</li>
<li>读取或写入虚拟机配置</li>
<li>监控虚拟机的磁盘使用情况</li>
</ul>
<h4 id="guestfs"><a href="#guestfs" class="headerlink" title="guestfs"></a>guestfs</h4><p>guestfish 是一个基于 libguestfs API 的交互 shell</p>
<p>libguestfs 提供了一个简单地访问虚机磁盘镜像文件的方法，即使是在虚拟机无法启动的情况下</p>
<p>libguestfs 是由一组丰富的工具集组成，可以让管理员访问虚机文件，甚至调整和挽救文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">dnf <span class="token parameter variable">-y</span> <span class="token function">install</span> libguestfs-tools

<span class="token comment"># 查看虚拟机的磁盘文件</span>
<span class="token function">virsh</span> domblklist centos7

<span class="token comment"># 只读方式打开虚拟磁盘，选项-i可以实现自动探查后进行自动挂载</span>
guestfish <span class="token parameter variable">--ro</span> <span class="token parameter variable">-a</span> /var/lib/libvirt/images/centos7.qcow2 <span class="token parameter variable">-i</span>		<span class="token comment"># 交互式</span>

<span class="token comment"># 读写方式打开虚拟磁盘</span>
guestfish <span class="token parameter variable">-d</span> centos7 <span class="token parameter variable">-i</span>		<span class="token comment"># 交互式</span>
</code></pre>

<h4 id="其他离线工具"><a href="#其他离线工具" class="headerlink" title="其他离线工具"></a>其他离线工具</h4><pre class="language-bash" data-language="bash"><code class="language-bash">virt-df 			<span class="token comment"># 监视磁盘使用</span>
virt-resize 		<span class="token comment"># 离线调整虚拟磁盘大小</span>
virt-inspector 		<span class="token comment"># 虚拟机检视</span>
virt-win-reg 		<span class="token comment"># Windows注册表读取和修改</span>
virt-sysprep 		<span class="token comment"># 虚拟机设置重置</span></code></pre>

<h2 id="网络管理"><a href="#网络管理" class="headerlink" title="网络管理"></a>网络管理</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://wiki.libvirt.org/page/VirtualNetworking">https://wiki.libvirt.org/page/VirtualNetworking</a></p>
<h3 id="nmcli-实现网桥"><a href="#nmcli-实现网桥" class="headerlink" title="nmcli 实现网桥"></a>nmcli 实现网桥</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建网桥</span>
nmcli connection <span class="token function">add</span> <span class="token builtin class-name">type</span> bridge con-name br0 ifname br0
nmcli connection modify br0 ipv4.addresses <span class="token number">10.0</span>.0.100/24 ipv4.method manual
nmcli connection reload
nmcli connection up br0

<span class="token comment">#加入物理网卡</span>
nmcli con <span class="token function">add</span> <span class="token builtin class-name">type</span> bridge-slave con-name br0-port0 ifname eth0 master br0
nmcli con <span class="token function">add</span> <span class="token builtin class-name">type</span> bridge-slave con-name br0-port1 ifname eth1 master br0
nmcli connection reload
nmcli con up br0-port0
nmcli con up br0-port1</code></pre>

<h3 id="qemu-kvm-支持的网络"><a href="#qemu-kvm-支持的网络" class="headerlink" title="qemu-kvm 支持的网络"></a>qemu-kvm 支持的网络</h3><h3 id="默认网络架构"><a href="#默认网络架构" class="headerlink" title="默认网络架构"></a>默认网络架构</h3><p>默认虚拟机网络配置为 NAT 模式，相当于 wmware 的 ANT 模式</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605578835894.png"></p>
<h3 id="自定义网桥架构"><a href="#自定义网桥架构" class="headerlink" title="自定义网桥架构"></a>自定义网桥架构</h3><p>自定义网桥架构：桥接网络可以让运行在宿主机上的虚拟机使用和宿主机相同网段的 IP，并且可以从外部直接访问到虚拟机，目前企业中大部分场景都使用桥接网络</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605625062472.png"></p>
<p>网桥（或者交换机）一定是有网卡接口的，给网卡接口配置 ip，才能实现桥接的功能，默认的 nat 模式下，虚拟网桥 virbr0 的网卡接口是 virbr0-nic；自定义网桥架构中，网卡接口是 eth0</p>
<p><code>ip a</code>显示 nat 模式下，virbr0-nic 没有 ip，自定义网桥模式下，eth0 没有 ip，而虚拟网桥 virbr0 和 virbr1 显示有 ip，这时为什么呢？ 我猜这是因为虽然我们常说给网卡配置 ip，但其实 ip 是配置在内核的，所以不论显示在哪里，都是网桥的 ip，形式不重要</p>
<h3 id="用户自定义的隔离的虚拟网络"><a href="#用户自定义的隔离的虚拟网络" class="headerlink" title="用户自定义的隔离的虚拟网络"></a>用户自定义的隔离的虚拟网络</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605625176480.png"></p>
<h2 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/LVS/LVS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/LVS/LVS/" class="post-title-link" itemprop="url">LVS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:41:03" itemprop="dateCreated datePublished" datetime="2020-12-09T23:41:03+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/LVS/" itemprop="url" rel="index"><span itemprop="name">LVS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="集群和分布式"><a href="#集群和分布式" class="headerlink" title="集群和分布式"></a>集群和分布式</h2><p>集群（cluster）：为了解决某个特定问题将多台服务器组合起来形成的单个系统</p>
<p>cluster 分为三种类型：负载均衡（LB）、高可用（HA）、高性能（HPC，例如天河一号）</p>
<p>集群和分布式：</p>
<p>集群是一个业务系统部署在多台服务器上，分布式是拆分业务系统，然后分别部署在不同服务器</p>
<p>分布式是指通过网络连接的多个组件，通过交换信息协作而形成的系统。而集群，是指同一种组件的多个实例，形成的逻辑上的整体</p>
<h3 id="cluster-负载均衡-LB"><a href="#cluster-负载均衡-LB" class="headerlink" title="cluster 负载均衡 LB"></a>cluster 负载均衡 LB</h3><p>按实现方式：</p>
<ul>
<li>硬件：F5，非常昂贵，一个 F5 就 18W，配置一套主从高可用就是 36W</li>
<li>软件：LVS、Nginx、haproxy</li>
</ul>
<p>基于工作的协议层划分：</p>
<ul>
<li>传输层：LVS、Nginx、haproxy</li>
<li>应用层：针对特定协议，常称为 proxy server<ul>
<li>http：nginx、httpd、haproxy…</li>
<li>fastcgi：nginx、httpd…</li>
<li>mysql：mysql-proxy、mycat…</li>
</ul>
</li>
</ul>
<h3 id="cluster-高可用集群-HA"><a href="#cluster-高可用集群-HA" class="headerlink" title="cluster 高可用集群 HA"></a>cluster 高可用集群 HA</h3><p>keepalived</p>
<h2 id="LVS-简介"><a href="#LVS-简介" class="headerlink" title="LVS 简介"></a>LVS 简介</h2><p>Linux Virtual Server，官网: <a target="_blank" rel="noopener" href="http://www.linuxvirtualserver.org/">http://www.linuxvirtualserver.org/</a></p>
<p>四层负载均衡，转发效率极高，具有处理百万计并发连接请求的能力。</p>
<p>阿里的四层 <a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1803">SLB</a> ( Server Load Balance )是基于 LVS + keepalived 实现</p>
<p><strong>LVS &#x3D; IPVS（内核空间） + ipvsadm（用户空间）</strong></p>
<ul>
<li><strong>IPVS：</strong>集成在内核，工作在 netfilter 框架上，具体来讲就是工作在 INPUT 链上，将发往 INPUT 的流量进行 “处理”</li>
<li><strong>ipvsadm：</strong>管理 ipvs 规则的用户空间软件</li>
</ul>
<p>负载均衡的应用场景为高访问量的业务,提高应用程序的可用性和可靠性</p>
<ol>
<li>应用于高访问量的业务</li>
<li>扩展应用程序：随时添加和移除 ECS 实例来扩展应用系统的服务能力</li>
<li>消除单点故障</li>
<li>同城容灾 (多可用区容灾)</li>
<li>跨地域容灾</li>
</ol>
<h2 id="LVS-集群"><a href="#LVS-集群" class="headerlink" title="LVS 集群"></a>LVS 集群</h2><h3 id="LVS-集群体系架构图"><a href="#LVS-集群体系架构图" class="headerlink" title="LVS 集群体系架构图"></a>LVS 集群体系架构图</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605433606569.png"></p>
<h3 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h3><ul>
<li>CIP：Client IP</li>
<li>VS：Virtual Server；Director Server(DS)、Dispatcher(调度器)、Load Balancer</li>
<li>RS：Real Server；upstream server(nginx)、backend server(haproxy)</li>
<li>DIP：Director IP，VS 内网 IP</li>
<li>VIP：Virtual server IP，VS 和 RS 的外网 IP</li>
<li>RIP：Real server IP，RS 的 IP</li>
</ul>
<p>访问流程：CIP &lt;–&gt; VIP&#x3D;&#x3D;DIP &lt;–&gt; RIP</p>
<h2 id="IPVS-工作模式"><a href="#IPVS-工作模式" class="headerlink" title="IPVS 工作模式"></a>IPVS 工作模式</h2><ul>
<li>nat：修改请求报文的目标 IP</li>
<li>fullnat：修改请求报文的源和目标 IP，默认不支持</li>
<li>dr：操纵封装新的 mac 地址</li>
<li>tun：在原请求 IP 报文之外新加一个 IP 首部</li>
</ul>
<h3 id="nat"><a href="#nat" class="headerlink" title="nat"></a>nat</h3><p>本质是多目标 IP 的 DNAT，通过将请求报文中的目标地址和目标端口修改为某挑出的 RS 的 RIP 和 PORT 实现转发</p>
<p>缺点：请求报文和响应报文都必须经由 VS 转发，VS 容易成为系统瓶颈</p>
<h3 id="fullnat"><a href="#fullnat" class="headerlink" title="fullnat"></a>fullnat</h3><p>lvs-nat 模式下，DIP 和 RIP 应该在同一个 IP 网段，RS 的网关要指向 DIP</p>
<p>而 lvs-fullnat 模式下，DIP 和 RIP 通常不在一个网段，只要能通信就行，当然 RS 的网关也不指向 DIP</p>
<p><strong>注意：此类型 kernel 默认不支持</strong></p>
<h3 id="dr-重点"><a href="#dr-重点" class="headerlink" title="dr (重点)"></a>dr (重点)</h3><p>Direct Routing 直接路由，LVS 默认模式，应用也最广泛，重点掌握。</p>
<p>通过为请求报文重新封装一个 MAC 首部进行转发，源 MAC 是 DIP 的 MAC，目标 MAC 是一个挑选出的 RS 的 RIP 的 MAC 地址；源 IP&#x2F;PORT 以及目标 IP&#x2F;PORT 均保持不变</p>
<p><strong>lvs-dr 模式的特点：</strong></p>
<ul>
<li><p>Director 和各 RS 都配置同一个公网 IP（VIP），通常配置在 lo 上</p>
</li>
<li><p>RS 和 Director 要在同一个物理网络（同一个机房）</p>
</li>
<li><p>请求报文要经由 Director，但响应报文不经由 Director，而由 RS 直接发往 Client</p>
</li>
<li><p>所以为了保证目标为 VIP 的请求发往 VS 而不是 RS，需要在 RS 上修改 arp_ignore 和 rp_announce 参数，从而隐藏 RS</p>
</li>
<li><p>RIP 和 DIP 在同一 IP 网段，RS 网关不能指向 DIP（避免响应报文经过 VS）</p>
</li>
<li><p>不支持端口映射</p>
</li>
<li><p>无需开启 ip_forward</p>
</li>
</ul>
<h3 id="tun"><a href="#tun" class="headerlink" title="tun"></a>tun</h3><blockquote>
<p>一般来说，TUN 模式常会用来负载调度缓存服务器组，这些缓存服务器一般放置在不同的网络环境，可以就近折返给客户端。在请求对象不在 Cache 服务器本地命中的情况下，Cache 服务器要向源服务器发送请求，将结果取回，最后将结果返回给用户。</p>
<p>LAN 环境一般多采用 DR 模式，WAN 环境虽然可以用 TUN 模式，但是一般在 WAN 环境下，请求转发更多的被 haproxy、nginx、DNS 等实现。因此，TUN 模式实际应用的很少，跨机房的应用一般专线光纤连接或 DNS 调度</p>
</blockquote>
<h3 id="总结和比较"><a href="#总结和比较" class="headerlink" title="总结和比较"></a>总结和比较</h3><table>
<thead>
<tr>
<th></th>
<th>NAT</th>
<th>TUN</th>
<th>DR</th>
</tr>
</thead>
<tbody><tr>
<td>Real Server</td>
<td>any</td>
<td>Tunneling</td>
<td>Non-arp device</td>
</tr>
<tr>
<td>Real server network</td>
<td>private</td>
<td>LAN&#x2F;WAN</td>
<td>LAN</td>
</tr>
<tr>
<td>Real server number</td>
<td>low (10~20)</td>
<td>High (100)</td>
<td>High (100)</td>
</tr>
<tr>
<td>Real server gateway</td>
<td>load balancer</td>
<td>own router</td>
<td>own router</td>
</tr>
<tr>
<td>优点</td>
<td>端口转换</td>
<td>WAN</td>
<td>性能最好</td>
</tr>
<tr>
<td>缺点</td>
<td>性能瓶颈</td>
<td>支持隧道</td>
<td>不支持跨网段</td>
</tr>
</tbody></table>
<h2 id="IPVS-负载均衡调度算法"><a href="#IPVS-负载均衡调度算法" class="headerlink" title="IPVS 负载均衡调度算法"></a>IPVS 负载均衡调度算法</h2><p>根据其调度时是否考虑各 RS 当前的负载状态，分为两种：静态方法和动态方法</p>
<h3 id="静态算法"><a href="#静态算法" class="headerlink" title="静态算法"></a>静态算法</h3><p>仅根据算法本身进行调度</p>
<table>
<thead>
<tr>
<th><font style="display:inline-block;min-width: 150px">静态算法</font></th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>RR</td>
<td>roundrobin 轮询，常用</td>
</tr>
<tr>
<td>WRR</td>
<td>weighted rr 加权轮询，常用</td>
</tr>
<tr>
<td>SH</td>
<td>源 IP hash，将来自于同一个 IP 地址的请求始终发往第一次挑中的 RS，从而实现会话绑定</td>
</tr>
<tr>
<td>DH</td>
<td>目标 IP hash，第一次轮询调度至 RS，后续将发往同一个目标地址的请求始终转发至第一次挑中的 RS，典型使用场景是正向代理缓存场景中的负载均衡，如：web 缓存</td>
</tr>
</tbody></table>
<h3 id="动态算法"><a href="#动态算法" class="headerlink" title="动态算法"></a>动态算法</h3><p>主要根据每 RS 当前的负载状态及调度算法进行调度 Overhead&#x3D;value，较小的 RS 将被调度</p>
<table>
<thead>
<tr>
<th>动态算法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>LC</td>
<td>least connections 适用于长连接应用</td>
</tr>
<tr>
<td>WLC</td>
<td>Weighted LC 默认调度方法,较常用</td>
</tr>
<tr>
<td>SED</td>
<td>Shortest Expection Delay 初始连接高权重优先，只检查活动连接，而不考虑非活动连接</td>
</tr>
<tr>
<td>NQ</td>
<td>Never Queue 第一轮均匀分配，后续 SED</td>
</tr>
<tr>
<td>LBLC</td>
<td>Locality-Based LC，动态的 DH 算法，使用场景：根据负载状态实现正向代理,实现 Web Cache 等</td>
</tr>
<tr>
<td>LBLCR</td>
<td>LBLC with Replication 带复制功能的 LBLC，解决 LBLC 负载不均衡问题，从负载重的复制到负载轻的 RS，实现 Web Cache 等</td>
</tr>
<tr>
<td>FO</td>
<td>内核 4.15 之后新增</td>
</tr>
<tr>
<td>OVF</td>
<td>内核 4.15 之后新增</td>
</tr>
</tbody></table>
<h2 id="ipvsadm"><a href="#ipvsadm" class="headerlink" title="ipvsadm"></a>ipvsadm</h2><p>ipvsadm 的核心功能：管理集群服务 和 集群服务的 RS</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> ipvsadm
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$rpm</span> <span class="token parameter variable">-ql</span> ipvsadm
/etc/sysconfig/ipvsadm-config					<span class="token comment"># 配置文件</span>
/usr/lib/systemd/system/ipvsadm.service			<span class="token comment">#</span>
/usr/sbin/ipvsadm								<span class="token comment"># 主程序</span>
/usr/sbin/ipvsadm-restore						<span class="token comment"># 规则重载工具</span>
/usr/sbin/ipvsadm-save							<span class="token comment"># 规则保存工具</span>
<span class="token punctuation">..</span>.</code></pre>

<h3 id="管理集群服务"><a href="#管理集群服务" class="headerlink" title="管理集群服务"></a>管理集群服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm -A<span class="token operator">|</span>E -t<span class="token operator">|</span>u<span class="token operator">|</span>f service-address <span class="token punctuation">[</span>-s scheduler<span class="token punctuation">]</span> <span class="token punctuation">[</span>-p <span class="token punctuation">[</span>timeout<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>-M netmask<span class="token punctuation">]</span> <span class="token punctuation">[</span>--pe persistence_engine<span class="token punctuation">]</span> <span class="token punctuation">[</span>-b sched-flags<span class="token punctuation">]</span>

<span class="token parameter variable">-A</span>		<span class="token comment"># add</span>
<span class="token parameter variable">-E</span>		<span class="token comment"># edit</span>

service-address		<span class="token comment"># vip:port 如：10.0.0.100:80</span>
    <span class="token parameter variable">-t</span>		<span class="token comment"># tcp协议</span>
    <span class="token parameter variable">-u</span>		<span class="token comment"># udp协议</span>
    <span class="token parameter variable">-f</span>		<span class="token comment"># firewall mark，标记，一个数字</span>

<span class="token parameter variable">-s</span>		<span class="token comment"># 指定集群的调度算法，默认为wlc</span>

<span class="token comment"># 范例</span>
ipvsadm <span class="token parameter variable">-A</span> <span class="token parameter variable">-t</span> <span class="token number">10.0</span>.0.100:80 <span class="token parameter variable">-s</span> wrr</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm <span class="token parameter variable">-D</span> -t<span class="token operator">|</span>u<span class="token operator">|</span>f service-address 	<span class="token comment"># 删除</span>
ipvsadm –C 							<span class="token comment"># 清空定义的所有内容</span>
ipvsadm –R 							<span class="token comment"># 重载,相当于ipvsadm-restore</span>
ipvsadm <span class="token parameter variable">-S</span> <span class="token punctuation">[</span>-n<span class="token punctuation">]</span> 					<span class="token comment"># 保存,相当于ipvsadm-save</span></code></pre>

<h3 id="管理集群上的-RS"><a href="#管理集群上的-RS" class="headerlink" title="管理集群上的 RS"></a>管理集群上的 RS</h3><pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm -a<span class="token operator">|</span>e -t<span class="token operator">|</span>u<span class="token operator">|</span>f service-address <span class="token parameter variable">-r</span> server-address <span class="token punctuation">[</span>-g<span class="token operator">|</span>i<span class="token operator">|</span>m<span class="token punctuation">]</span> <span class="token punctuation">[</span>-w weight<span class="token punctuation">]</span>

<span class="token parameter variable">-a</span>		<span class="token comment"># add</span>
<span class="token parameter variable">-e</span>		<span class="token comment"># edit</span>
<span class="token parameter variable">-r</span>		<span class="token comment"># rip[:port] 如省略port，不作端口映射</span>
    <span class="token parameter variable">-g</span>		<span class="token comment"># gateway，dr类型，默认</span>
    <span class="token parameter variable">-i</span>		<span class="token comment"># ipip，tun类型</span>
    <span class="token parameter variable">-m</span>		<span class="token comment"># masquerade，nat类型</span>
<span class="token parameter variable">-w</span>		<span class="token comment"># 权重</span>

<span class="token comment"># 范例</span>
ipvsadm <span class="token parameter variable">-a</span> <span class="token parameter variable">-t</span> <span class="token number">10.0</span>.0.100:80 <span class="token parameter variable">-r</span> <span class="token number">10.0</span>.0.8:8080 <span class="token parameter variable">-m</span> <span class="token parameter variable">-w</span> <span class="token number">3</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm <span class="token parameter variable">-d</span> -t<span class="token operator">|</span>u<span class="token operator">|</span>f service-address <span class="token parameter variable">-r</span> server-address		<span class="token comment"># 删除</span>
ipvsadm <span class="token parameter variable">-Z</span> <span class="token punctuation">[</span>-t<span class="token operator">|</span>u<span class="token operator">|</span>f service-address<span class="token punctuation">]</span>						<span class="token comment"># 清空计数器</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm -L<span class="token operator">|</span>l <span class="token punctuation">[</span>options<span class="token punctuation">]</span>	<span class="token comment"># 查看</span>

options：
-n：			以数字形式输出地址和端口号
--exact：	扩展信息,精确值
-c：			当前IPVS连接输出
--stats：	统计信息
--rate：		输出速率信息</code></pre>

<h3 id="ipvs-规则"><a href="#ipvs-规则" class="headerlink" title="ipvs 规则"></a>ipvs 规则</h3><pre class="language-bash" data-language="bash"><code class="language-bash">/proc/net/ip_vs</code></pre>

<h3 id="ipvs-连接"><a href="#ipvs-连接" class="headerlink" title="ipvs 连接"></a>ipvs 连接</h3><pre class="language-bash" data-language="bash"><code class="language-bash">/proc/net/ip_vs_conn</code></pre>

<h3 id="保存规则"><a href="#保存规则" class="headerlink" title="保存规则"></a>保存规则</h3><p>ipvs 调度规则建议保存至 &#x2F;etc&#x2F;sysconfig&#x2F;ipvsadm.rules</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm-save <span class="token operator">></span> /etc/sysconfig/ipvsadm.rules
ipvsadm <span class="token parameter variable">-S</span> <span class="token operator">></span> /etc/sysconfig/ipvsadm.rules	<span class="token comment"># ipvsadm -S 和 ipvsadm-save等价</span>
systemctl stop ipvsadm.service			<span class="token comment"># 会自动保存规则至/etc/sysconfig/ipvsadm.rules</span></code></pre>

<h3 id="重载"><a href="#重载" class="headerlink" title="重载"></a>重载</h3><pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm-restore <span class="token operator">&lt;</span> /etc/sysconfig/ipvsadm.rules
systemctl start ipvsadm.service			<span class="token comment"># #会自动加载/etc/sysconfig/ipvsadm.rules中规则</span></code></pre>

<h3 id="防火墙标记"><a href="#防火墙标记" class="headerlink" title="防火墙标记"></a>防火墙标记</h3><p>FWM：FireWall Mark</p>
<p>借助防火墙标记来分类报文，而后基于标记定义集群服务，可将多个不同的应用使用同一个集群服务进行调度</p>
<p>实现方法：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 在VS主机打标记</span>
iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-d</span> <span class="token variable">$vip</span> <span class="token parameter variable">-p</span> <span class="token variable">$proto</span> <span class="token parameter variable">-m</span> multiport <span class="token parameter variable">--dports</span> <span class="token variable">$port1</span>,<span class="token variable">$port2</span>,<span class="token punctuation">..</span>. <span class="token parameter variable">-j</span> MARK --set-mark NUMBER

<span class="token comment"># 2. 在VS主机基于标记定义集群服务</span>
ipvsadm <span class="token parameter variable">-A</span> <span class="token parameter variable">-f</span> NUMBER <span class="token punctuation">[</span>options<span class="token punctuation">]</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$iptables</span> <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-d</span> <span class="token number">172.16</span>.0.100 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> multiport <span class="token parameter variable">--dports</span> <span class="token number">80,443</span> <span class="token parameter variable">-j</span> MARK --set-mark <span class="token number">10</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$ipvsadm</span> <span class="token parameter variable">-C</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$ipvsadm</span> <span class="token parameter variable">-A</span> <span class="token parameter variable">-f</span> <span class="token number">10</span> <span class="token parameter variable">-s</span> rr
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$ipvsadm</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-f</span> <span class="token number">10</span> <span class="token parameter variable">-r</span> <span class="token number">10.0</span>.0.72 <span class="token parameter variable">-g</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$ipvsadm</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-f</span> <span class="token number">10</span> <span class="token parameter variable">-r</span> <span class="token number">10.0</span>.0.73 <span class="token parameter variable">-g</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$ipvsadm</span> <span class="token parameter variable">-Ln</span>
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
FWM  <span class="token number">10</span> rr
  -<span class="token operator">></span> <span class="token number">10.0</span>.0.72:0                  Route   <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.0</span>.0.73:0                  Route   <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
<span class="token punctuation">[</span>root@c71 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /proc/net/ip_vs
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">></span> RemoteAddress:Port Forward Weight ActiveConn InActConn
FWM  0000000A rr
  -<span class="token operator">></span> 0A000049:0000      Route   <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> 0A000048:0000      Route   <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></code></pre>

<h3 id="持久标记"><a href="#持久标记" class="headerlink" title="持久标记"></a>持久标记</h3><p>session 绑定：对共享同一组 RS 的多个集群服务，需要统一进行绑定，IPVS 调度算法无法实现</p>
<p>持久连接模板：无论使用任何调度算法，在一段时间内（默认 360s），能够实现将来自同一地址的请求始终发往同一个 RS</p>
<p>实现方法：ipvsadm 指定 -p 选项即可</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ipvsadm -A<span class="token operator">|</span>E -t<span class="token operator">|</span>u<span class="token operator">|</span>f service-address <span class="token punctuation">[</span>-s scheduler<span class="token punctuation">]</span> <span class="token parameter variable">-p</span> <span class="token punctuation">[</span>timeout<span class="token punctuation">]</span> <span class="token punctuation">[</span>-M netmask<span class="token punctuation">]</span> <span class="token punctuation">[</span>--pe persistence_engine<span class="token punctuation">]</span> <span class="token punctuation">[</span>-b sched-flags<span class="token punctuation">]</span>

<span class="token comment"># 范例：</span>
ipvsadm -A<span class="token operator">|</span>E <span class="token parameter variable">-f</span> <span class="token number">10</span> <span class="token parameter variable">-p</span>
ipvsadm -A<span class="token operator">|</span>E <span class="token parameter variable">-f</span> <span class="token number">10</span> <span class="token parameter variable">-p</span> <span class="token number">3600</span></code></pre>

<h2 id="LVS-实战案例"><a href="#LVS-实战案例" class="headerlink" title="LVS 实战案例"></a>LVS 实战案例</h2><p>重点掌握 LVS-DR 模式即可，其他模式如果用到再复习</p>
<h3 id="LVS-DR-模式单网段案例"><a href="#LVS-DR-模式单网段案例" class="headerlink" title="LVS-DR 模式单网段案例"></a>LVS-DR 模式单网段案例</h3><p>DR 模式中各主机上均需配置 VIP，解决地址冲突的方式有三种，最常用的是修改 RS 的内核参数：</p>
<ul>
<li><p>arp_ignore：用于处理接收到的 arp 请求，</p>
<ul>
<li><p>设置为 1：请求的目的 IP 地址为接收网卡上的 IP，才响应。</p>
<p>举例来讲：服务器上配置两个网卡 A 和 B，A 接收到 arp 请求，只要请求的目的 IP 不是 A 的 IP 就不响应。</p>
</li>
</ul>
</li>
<li><p>arp_announce：用于处理发送的 arp 请求</p>
<ul>
<li>设置为 2：请求的源 IP 为发送网卡的 IP</li>
</ul>
</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1605495268542.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">环境：五台主机

一台客户机：eht0：仅主机 <span class="token number">192.168</span>.10.6/24 GW：192.168.10.200

一台路由器：
eht0：NAT <span class="token number">10.0</span>.0.200/24
eht1：仅主机 <span class="token number">192.168</span>.10.200/24
启用ip_forward

<span class="token comment"># dr模式下，vs只负责转发请求，不往外网发送请求，所以网关可以随便设置一个ip，但是不能不配置，因为如果不配置，vs会认为自己和外网没有通信的可能，就不会转发请求了</span>
一台VS：eht0：NAT <span class="token number">10.0</span>.0.8/24 GW：10.0.0.200		lo：10.0.0.100/32

两台RS：
RS1：eth0：NAT <span class="token number">10.0</span>.0.7/24 GW:10.0.0.200		lo：10.0.0.100/32
RS2：eth0：NAT <span class="token number">10.0</span>.0.17/24 GW:10.0.0.200		lo：10.0.0.100/32</code></pre>

<ul>
<li><p>RS 要可以出网，所以配置了网关</p>
</li>
<li><p>VIP 是 10.0.0.100，给 VS 和 RS 的 lo 网卡都配置上</p>
</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 客户机配置过程略。。。</span>
<span class="token comment"># 路由器配置过程略。。。</span>
<span class="token comment"># RS配置：将arp_ignore设置为1、arp_announce设置为2；lo的ip配置为VIP</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_ignore
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_ignore
<span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_announce
<span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_announce
<span class="token function">ip</span> a <span class="token function">add</span> <span class="token number">10.0</span>.0.100/32 dev lo label lo:1
<span class="token comment"># VS配置：lo的ip配置为VIP，配置ipvs规则</span>
ipvsadm <span class="token parameter variable">-A</span> <span class="token parameter variable">-t</span> <span class="token number">10.0</span>.0.100:80 <span class="token parameter variable">-s</span> rr
ipvsadm <span class="token parameter variable">-a</span> <span class="token parameter variable">-t</span> <span class="token number">10.0</span>.0.100:80 <span class="token parameter variable">-r</span> <span class="token number">10.0</span>.0.7:80 <span class="token parameter variable">-g</span>
ipvsadm <span class="token parameter variable">-a</span> <span class="token parameter variable">-t</span> <span class="token number">10.0</span>.0.100:80 <span class="token parameter variable">-r</span> <span class="token number">10.0</span>.0.17:80 <span class="token parameter variable">-g</span>

<span class="token comment"># 测试访问：客户机多次执行 curl 10.0.0.100</span></code></pre>

<h3 id="LVS-DR-模式多网段案例"><a href="#LVS-DR-模式多网段案例" class="headerlink" title="LVS-DR 模式多网段案例"></a>LVS-DR 模式多网段案例</h3><p>前面的单网段案例中，lo 和 eth0 在同一个网段，如果把 lo 和 eth0 的 ip 设置在不同的网段就是多网段，这种情况是物理上单网段，逻辑上多网段</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605497471540.png"></p>
<p>实现过程略。。。</p>
<h2 id="LVS-高可用实现"><a href="#LVS-高可用实现" class="headerlink" title="LVS 高可用实现"></a>LVS 高可用实现</h2><h3 id="DS-不可用时"><a href="#DS-不可用时" class="headerlink" title="DS 不可用时"></a>DS 不可用时</h3><ul>
<li>keepalived</li>
<li>heartbeat&#x2F;corosync</li>
</ul>
<h3 id="RS-不可用时"><a href="#RS-不可用时" class="headerlink" title="RS 不可用时"></a>RS 不可用时</h3><p>某 RS 不可用时，Director 依然会调度请求至此 RS</p>
<p>解决方案： 由 Director 对各 RS 健康状态进行检查，失败时禁用，成功时启用</p>
<p>常用解决方案：</p>
<ul>
<li>keepalived</li>
<li>heartbeat&#x2F;corosync</li>
<li>ldirectord</li>
</ul>
<p>检测方式：</p>
<ul>
<li>网络层检测：icmp</li>
<li>传输层检测：端口探测</li>
<li>应用层检测：请求某关键资源</li>
</ul>
<h3 id="ldirectord"><a href="#ldirectord" class="headerlink" title="ldirectord"></a>ldirectord</h3><p>…</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block ljk-index-post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/pureftpd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/pureftpd/" class="post-title-link" itemprop="url">pureftpd</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:40:12" itemprop="dateCreated datePublished" datetime="2020-12-09T23:40:12+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/" itemprop="url" rel="index"><span itemprop="name">网络文件共享</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="pure-ftpd-conf："><a href="#pure-ftpd-conf：" class="headerlink" title="pure-ftpd.conf："></a>pure-ftpd.conf：</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 限制所有用户在其主目录中，change root directory（更改根目录），参考chroot命令</span>
ChrootEveryone               <span class="token function">yes</span>
<span class="token comment"># 如果前一个指令被设置为了 "no"，下面组的成员(GID)就不受主目录的限制了。而其他的用户还是会被限制在自己的主目录里。如果你不想把任何用户限制在自己的主目录里，只要注释掉 ChrootEveryone 和 TrustedGID 就可以了</span>
<span class="token comment"># TrustedGID                   100</span>
BrokenClientsCompatibility   no	<span class="token comment"># 兼容ie等比较非正规化的ftp客户端</span>
MaxClientsNumber             <span class="token number">50</span>	<span class="token comment"># 服务器总共允许同时连接的最大用户数</span>
Daemonize                    <span class="token function">yes</span>	<span class="token comment"># 做为守护(doemon)进程运行(Fork in background)</span>
<span class="token comment"># 同一IP允许同时连接的用户数（Maximum number of sim clients with the same IP address）</span>
MaxClientsPerIP              <span class="token number">8</span>
VerboseLog                   no		<span class="token comment"># 如果你要记录所有的客户命令，设置这个指令为 "yes"</span>
DisplayDotFiles              <span class="token function">yes</span>	<span class="token comment"># 即使客户端没有发送 '-a' 选项也列出隐藏文件</span>
AnonymousOnly                no		<span class="token comment"># 是否只让匿名用户登录</span>
NoAnonymous                  no		<span class="token comment"># 不允许匿名连接，仅允许认证用户使用</span>
SyslogFacility               <span class="token function">ftp</span>	<span class="token comment"># 缺省的facility 是 "ftp"。 "none" 将禁止日志</span>
<span class="token comment"># 定制用户登陆后的显示信息（Display fortune cookies）</span>
<span class="token comment"># FortunesFile                 /usr/share/fortune/zippy</span>
<span class="token comment"># 在日志文件中不解析主机名。日志没那么详细的话，就使用更少的带宽。在一个访问量很大的站点中，设置这个指令为 "yes" ，如果你没有一个能工作的DNS的话</span>
DontResolve                  <span class="token function">yes</span>
MaxIdleTime                  <span class="token number">15</span>	<span class="token comment"># 客户端允许的最大的空闲时间（分钟，缺省15分钟）</span>
<span class="token comment"># LDAPConfigFile	/etc/pureftpd-ldap.conf	# LDAP配置文件 (参考README.LDAP)</span>
<span class="token comment"># MySQLConfigFile	/etc/pureftpd-mysql.conf # MySQL配置文件 (参考README.MySQL)</span>
<span class="token comment"># PGSQLConfigFile	/etc/pureftpd-pgsql.conf	# Postgres配置文件 (参考README.PGSQL)</span>
<span class="token comment"># PureDB	/etc/pureftpd.pdb # PureDB用户数据库 (参考README.Virtual-Users)</span>
<span class="token comment"># ExtAuth	/var/run/ftpd.sock # pure-authd 的socket 路径(参考README.Authentication-Modules)</span>
<span class="token comment"># 如果你要启用 PAM 认证方式, 去掉下面行的注释</span>
<span class="token comment"># PAMAuthentication            yes</span>
<span class="token comment"># 如果你要启用 简单的 Unix系统 认证方式(/etc/passwd), 去掉下面行的注释，就是允许系统用户登录</span>
<span class="token comment"># UnixAuthentication           yes</span>
<span class="token comment"># 'ls' 命令的递归限制。第一个参数给出文件显示的最大数目。第二个参数给出最大的子目录深度</span>
LimitRecursion               <span class="token number">10000</span> <span class="token number">8</span>
AnonymousCanCreateDirs       no	<span class="token comment"># 允许匿名用户创建新目录</span>
<span class="token comment"># 如果系统被 loaded 超过下面的值，匿名用户会被禁止下载</span>
MaxLoad                      <span class="token number">4</span>
<span class="token comment"># PassivePortRange             30000 50000	# 被动连接响应的端口范围</span>
<span class="token comment"># ForcePassiveIP               192.168.0.1	# 强制一个IP地址使用被动响应</span>
<span class="token comment"># AnonymousRatio               1 10		# 匿名用户的上传/下载的比率</span>
<span class="token comment"># UserRatio                    1 10		# 所有用户的上传/下载的比率</span>
<span class="token comment"># 不接受所属者是 "ftp" 的文件的下载。例如：那些匿名用户上传后未被本地管理员验证的文件</span>
AntiWarez                    <span class="token function">yes</span>
<span class="token comment"># Bind                         127.0.0.1,21	# 服务监听的IP 地址和端口。(缺省是所有IP地址和21端口)</span>
<span class="token comment"># AnonymousBandwidth           8	# 匿名用户的最大带宽（KB/s）</span>
<span class="token comment"># UserBandwidth                8	# 所有用户的最大带宽（KB/s），包括匿名用户</span>
<span class="token comment"># 新建目录及文件的属性掩码值：&lt;文件掩码>:&lt;目录掩码>，如果不放心，就直接设置177:077</span>
Umask                        <span class="token number">133</span>:022
MinUID                       <span class="token number">100</span>	<span class="token comment"># 认证用户允许登陆的最小组ID（UID）</span>
AllowUserFXP                 no		<span class="token comment"># 仅允许认证用户进行 FXP 传输</span>
AllowAnonymousFXP            no		<span class="token comment"># 对匿名用户和非匿名用户允许进行匿名 FXP 传输</span>
<span class="token comment"># 用户不能删除和写点文件（以 '.' 开头的文件），即使用户是文件的所有者也不行</span>
ProhibitDotFilesWrite        no
<span class="token comment"># 禁止读点文件（文件名以 '.' 开头的文件）</span>
ProhibitDotFilesRead         no
<span class="token comment"># 永不覆盖文件。当上传的文件，其文件名已经存在时，自动重命名，如： file.1, file.2, file.3, ...</span>
AutoRename                   no
AnonymousCantUpload          no		<span class="token comment"># 不接受匿名用户上传新文件( no = 允许上传)</span>
<span class="token comment"># 仅允许来自以下IP地址的非匿名用户连接。你可以使用这个指令来打开几个公网IP来提供匿名FTP，而保留一个私有的防火墙保护的IP来进行远程管理。你还可以只允许一内网地址进行认证，而在另外一个IP上提供纯匿名的FTP服务。</span>
<span class="token comment"># TrustedIP                    10.1.1.1</span>
<span class="token comment"># 如果你要为日志每一行添加 PID   去掉下面行的注释。</span>
<span class="token comment"># LogPID                       yes</span>

<span class="token comment"># 使用类似于 Apache的格式创建一个额外的日志文件，如：</span>
<span class="token comment"># fw.c9x.org - jedi [13/Dec/1975:19:36:39] "GET /ftp/linux.tar.bz2" 200 21809338</span>
<span class="token comment"># 这个日志文件能被 www 流量分析器处理</span>
<span class="token comment"># AltLog                       clf:/var/log/pureftpd.log</span>
<span class="token comment"># 使用优化过的格式为统计报告创建一个额外的日志文件</span>
<span class="token comment"># AltLog                       stats:/var/log/pureftpd.log</span>
<span class="token comment"># 使用标准的W3C格式创建一个额外的日志文件。（与大部分的商业日志分析器兼容）</span>
<span class="token comment"># AltLog                       w3c:/var/log/pureftpd.log</span>
<span class="token comment"># NoChmod                      yes	# 不接受 chmod 命令。用户不能更改他们文件的属性</span>
<span class="token comment"># KeepAllFiles                 yes	# 允许用户恢复和上传文件，却不允许删除他们</span>
<span class="token comment"># CreateHomeDir                yes	# 用户主目录不存在的话，自动创建</span>
<span class="token comment"># 启用虚拟的磁盘限额。第一个数字是最大的文件数，第二个数字是最大的总的文件大小(单位：Mb)，所以，1000:10 就是限制每一个用户只能使用 1000 个文件，共10Mb</span>
<span class="token comment"># Quota                        1000:10</span>
<span class="token comment"># 如果你的 pure-ftpd 编译时加入了独立服务器( standalone 支持，你能够改变 pid 文件的位置。缺省位置是 /var/run/pure-ftpd.pid</span>
<span class="token comment"># PIDFile                      /var/run/pure-ftpd.pid</span>

<span class="token comment"># 如果你的pure-ftpd编译时加入了pure-uploadscrīpt支持，这个指令将会使pure-ftpd发送关于新上传的情况信息到/var/run/pure-ftpd.upload.pipe，这样 pure-uploadscrīpt就能读然后调用一个脚本去处理新的上传</span>
<span class="token comment"># CallUploadScript             yes</span>
<span class="token comment"># 这个选项对允许匿名上传的服务器是有用的。当 /var/ftp 在 /var 里时，需要保留一定磁盘空间来保护日志文件。当所在磁盘分区使用超过百分之 X 时，将不在接受新的上传</span>
MaxDiskUsage                   <span class="token number">99</span>
<span class="token comment"># NoRename                     yes	# 如果你不想要你的用户重命名文件的话，就设置为 'yes'</span>
<span class="token comment"># 如果你所有的用户都有基本的Unix知识的话，这个特性将没什么用了。不过，如果你是一个主机提供商的话，启用它</span>
CustomerProof                <span class="token function">yes</span>
<span class="token comment"># 每一个用户的并发限制。只有在添加了 --with-peruserlimits 编译选项进行编译后，这个指令才起作用。(大部分的二进制的发布版本就是例子)，格式是 : &lt;每一个用户最大允许的进程>:&lt;最大的匿名用户进程>，例如： 3:20 意思是同一个认证用户最大可以有3个同时活动的进程。而且同时最多只能有20个匿名用户进程</span>
<span class="token comment"># PerUserLimits                3:20</span>

<span class="token comment"># NoTruncate                   yes</span>
<span class="token comment"># TLS                          1</span>
<span class="token comment"># TLSCipherSuite               HIGH</span>
<span class="token comment"># CertFile                     /etc/ssl/private/pure-ftpd.pem</span>
<span class="token comment"># CertFileAndKey               "/etc/pure-ftpd.pem" "/etc/pure-ftpd.key"</span>
<span class="token comment"># ExtCert                      /var/run/ftpd-certs.sock</span>
<span class="token comment"># IPV4Only                     yes</span>
<span class="token comment"># IPV6Only                     yes</span></code></pre>

<p>请注意：LDAPConfigFile, MySQLConfigFile, PAMAuthentication 和 UnixAuthentication 这些指令只能被使用一次，不过，他们能被混合在一起用。例如：如果你使用了 MySQLConfigFile 和 UnixAuthentication，那么 SQL 服务器将被访问。如果因为用户名未找到而使 SQL 认证失败的话，就会在&#x2F;etc&#x2F;passwd 和 &#x2F;etc&#x2F;shadow 中尝试另外一种认证，如果因为密码错误而使 SQL 认证失败的话，认证就会在此结束了。认证方式由它们被给出来的顺序而被链接了起来</p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><pre class="language-bash" data-language="bash"><code class="language-bash">lujinkai@Z510:/usr/local/pureftpd$ ll bin/ sbin/
bin/:
总用量 <span class="token number">100</span>
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 ./
drwxr-xr-x <span class="token number">6</span> root root  <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 <span class="token punctuation">..</span>/
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">50248</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-pw*
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">17400</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-pwconvert*
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">17416</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-statsdecode*

sbin/:
总用量 <span class="token number">364</span>
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 ./
drwxr-xr-x <span class="token number">6</span> root root   <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 <span class="token punctuation">..</span>/
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">17200</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-authd*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">28320</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-certd*
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">213928</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-ftpd*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">17248</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-ftpwho*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">17424</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-mrtginfo*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">27768</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-quotacheck*
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">27904</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-uploadscript*
lujinkai@Z510:
lujinkai@Z510:/usr/local/pureftpd$ ll share/man/man8/
总用量 <span class="token number">84</span>
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 ./
drwxr-xr-x <span class="token number">3</span> root root  <span class="token number">4096</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 <span class="token punctuation">..</span>/
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4146</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-authd.8
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">2889</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-certd.8
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">29533</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-ftpd.8
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">2425</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-ftpwho.8
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">2101</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-mrtginfo.8
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">3280</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-pw.8
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">781</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-pwconvert.8
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">2164</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-quotacheck.8
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1125</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-statsdecode.8
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4156</span> <span class="token number">11</span>月 <span class="token number">11</span> <span class="token number">11</span>:04 pure-uploadscript.8
</code></pre>

<h3 id="pure-pw"><a href="#pure-pw" class="headerlink" title="pure-pw"></a>pure-pw</h3><p>Manage virtual users files for Pure-FTPd.</p>
<p>Virtual users is a simple mechanism to store a list of users, with their password, name, uid, directory, etc. It’s just like &#x2F;etc&#x2F;passwd. But it’s not &#x2F;etc&#x2F;passwd. It’s a different file, only for FTP.<br>It means that you can easily create FTP-only accounts without messing your system accounts.<br>Additionnaly, virtual users files can store individual quotas, ratios, bandwidth, etc. System accounts can’t do this.<br>Thousands of virtual users can share the same system user, as long as they all are chrooted, and they have their own home directory.</p>
<h3 id="pure-pwconvert"><a href="#pure-pwconvert" class="headerlink" title="pure-pwconvert"></a>pure-pwconvert</h3><p>Generate a virtual users file from system accounts.</p>
<p>This program scans system accounts (&#x2F;etc&#x2F;passwd) and outputs a FTP virtual users list, suitable to the pure-pw command.</p>
<h3 id="pure-statsdecode"><a href="#pure-statsdecode" class="headerlink" title="pure-statsdecode"></a>pure-statsdecode</h3><p>Show human-readable dates from a “stats” logfile.</p>
<p>This program decodes Pure-FTPd’s “stats” log files and converts timestamps into human-readable dates.</p>
<h3 id="pure-authd"><a href="#pure-authd" class="headerlink" title="pure-authd"></a>pure-authd</h3><p>External authentication agent for Pure-FTPd</p>
<p>pure-authd is a daemon that forks an authentication program, waits for an authentication reply, and feed them to an application server.<br>pure-authd listens to a local Unix socket. A new connection to that socket should feed pure-authd the following structure:<br>​ account:xxx<br>​ password:xxx<br>​ localhost:xxx<br>​ localport:xxx<br>​ peer:xxx</p>
<h3 id="pure-certd"><a href="#pure-certd" class="headerlink" title="pure-certd"></a>pure-certd</h3><p>TLS certificate agent for Pure-FTPd.</p>
<p>pure-certd is a daemon that forks an authentication program, waits for a certificate path as a reply, and returns it to an application server.<br>pure-certd listens to a local Unix socket. A new connection to that socket should send pure-authd the following structure:<br>sni_name:xxx end<br>These content is passed to the authentication program, as an environment variable:<br>CERTD_SNI_NAME<br>The authentication program should take appropriate actions to select a TLS certificate, and reply to the standard output with the fol‐lowing format:<br>action:strict cert_file:&#x2F;path&#x2F;to&#x2F;cert.pem key_file:&#x2F;path&#x2F;to&#x2F;cert.pem end</p>
<h3 id="pure-ftpd"><a href="#pure-ftpd" class="headerlink" title="pure-ftpd"></a>pure-ftpd</h3><p>simple File Transfer Protocol server</p>
<p>Pure-FTPd is a small, simple server for the old and hairy File Transfer Protocol, designed to use less resources than older servers,be smaller and very secure, and to never execute any external program.<br>It support most-used features and commands of FTP (including many modern extensions), and leaves out everything which is deprecated,meaningless, insecure, or correlates with trouble.<br>IPv6 is fully supported.</p>
<h3 id="pure-ftpwho"><a href="#pure-ftpwho" class="headerlink" title="pure-ftpwho"></a>pure-ftpwho</h3><p>Report current FTP sessions.</p>
<p>pure-ftpwho shows current Pure-FTPd client sessions. Only the system administrator may run this. Output can be text (default), HTML, XML data and parser-optimized. The server has to be compiled with –with-ftpwho to support this command.</p>
<h3 id="pure-mrtginfo"><a href="#pure-mrtginfo" class="headerlink" title="pure-mrtginfo"></a>pure-mrtginfo</h3><p>provide an MRTG-graphable user count for ftpd.</p>
<p>Pure-Mrtginfo counts the number of clients currently connected to ftpd(8) and output the format in a format graphable by MRTG.</p>
<h3 id="pure-quotacheck"><a href="#pure-quotacheck" class="headerlink" title="pure-quotacheck"></a>pure-quotacheck</h3><p>Update virtual quota files for Pure-FTPd.</p>
<p>pure-quotacheck create a .ftpquota file in the specified directory.<br>This file contains the current file and size of the directory, and it is used by Pure-FTPd when virtual quotas are enabled.<br>It’s recommended to periodically run pure-quotacheck for every user, in crontabs.</p>
<h3 id="pure-uploadscript"><a href="#pure-uploadscript" class="headerlink" title="pure-uploadscript"></a>pure-uploadscript</h3><p>Automatically run an external program after a successful upload.</p>
<p>If Pure-FTPd is compiled with –with-uploadscript (default in binary distributions), and if the -o (or –uploadscript) is passed to the server, a named pipe called &#x2F;var&#x2F;run&#x2F;pure-ftpd.upload.pipe is created. You will also notice an important file called &#x2F;var&#x2F;run&#x2F;pure-ftpd.upload.lock, used for locking.<br>After a successful upload, the file name is written to the pipe.<br>pure-uploadscript reads this pipe to automatically run any program or script to process the newly uploaded file.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.lujinkai.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.lujinkai.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.lujinkai.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.lujinkai.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
