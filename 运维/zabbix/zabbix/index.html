<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.to2b.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.to2b.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="监控服务介绍逻辑布局 整体布局 常见的监控服务开源监控软件：cacti、naglos、zabbix、smokeping、open-falcon 等 Cacti官网：https:&#x2F;&#x2F;www.cacti.net&#x2F;github：https:&#x2F;&#x2F;github.com&#x2F;Cacti&#x2F;cacti Cacti是基于LAMP平台展现的网络流量监测及分析工具，通过SNMP技术或自定义脚本从目标设备&#x2F;主机获取">
<meta property="og:type" content="article">
<meta property="og:title" content="Zabbix">
<meta property="og:url" content="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:description" content="监控服务介绍逻辑布局 整体布局 常见的监控服务开源监控软件：cacti、naglos、zabbix、smokeping、open-falcon 等 Cacti官网：https:&#x2F;&#x2F;www.cacti.net&#x2F;github：https:&#x2F;&#x2F;github.com&#x2F;Cacti&#x2F;cacti Cacti是基于LAMP平台展现的网络流量监测及分析工具，通过SNMP技术或自定义脚本从目标设备&#x2F;主机获取">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612493098811.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612493127884.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612542025387.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612545414997.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612545454796.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612546094789.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612547625040.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613050322184.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613135861331.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613622059982.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613654628015.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613636339217.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613636481313.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613636377969.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613655277258.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613655353719.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613655591144.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613698738326.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613698754613.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613701073079.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613726193516.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613726466582.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613727074510.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613727183092.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613727236979.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613727527469.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613728220959.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613730116604.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613732542403.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1613733940901.png">
<meta property="article:published_time" content="2021-02-05T02:43:08.000Z">
<meta property="article:modified_time" content="2023-05-29T08:58:05.502Z">
<meta property="article:author" content="像方便面一样的男子">
<meta property="article:tag" content="Zabbix">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.to2b.cn/blog/ljk/1612493098811.png">


<link rel="canonical" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix/","path":"运维/zabbix/zabbix/","title":"Zabbix"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zabbix | LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LJKのBlog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">监控服务介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%B8%83%E5%B1%80"><span class="nav-number">1.1.</span> <span class="nav-text">逻辑布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E5%B8%83%E5%B1%80"><span class="nav-number">1.2.</span> <span class="nav-text">整体布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.3.</span> <span class="nav-text">常见的监控服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Cacti"><span class="nav-number">1.3.1.</span> <span class="nav-text">Cacti</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nagios"><span class="nav-number">1.3.2.</span> <span class="nav-text">Nagios</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SmokePing"><span class="nav-number">1.3.3.</span> <span class="nav-text">SmokePing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Open-falcon"><span class="nav-number">1.3.4.</span> <span class="nav-text">Open-falcon</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9C%E8%8E%BA"><span class="nav-number">1.3.5.</span> <span class="nav-text">夜莺</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zabbix"><span class="nav-number">1.3.6.</span> <span class="nav-text">Zabbix</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Prometheus"><span class="nav-number">1.3.7.</span> <span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%95%86%E4%B8%9A%E7%9B%91%E6%8E%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.3.8.</span> <span class="nav-text">商业监控解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zabbix-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E5%8F%8A%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="nav-number">1.4.</span> <span class="nav-text">Zabbix 使用场景及系统概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.4.1.</span> <span class="nav-text">使用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="nav-number">1.4.2.</span> <span class="nav-text">系统概述</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">主要功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">数据采集</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">数据存储</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%98%88%E5%80%BC"><span class="nav-number">1.4.2.5.</span> <span class="nav-text">阈值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%91%8A%E8%AD%A6%E6%9C%BA%E5%88%B6"><span class="nav-number">1.4.2.6.</span> <span class="nav-text">告警机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA"><span class="nav-number">1.4.2.7.</span> <span class="nav-text">数据展示</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zabbix-%E8%A7%84%E5%88%92%E5%8F%8A%E9%83%A8%E7%BD%B2"><span class="nav-number">2.</span> <span class="nav-text">Zabbix 规划及部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E5%88%92"><span class="nav-number">2.1.</span> <span class="nav-text">规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yum-x2F-apt-%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">yum&#x2F;apt 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-number">2.3.</span> <span class="nav-text">编译安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zabbix-%E7%9B%91%E6%8E%A7%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80"><span class="nav-number">3.</span> <span class="nav-text">Zabbix 监控入门基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#zabbix-%E6%A6%82%E5%BF%B5"><span class="nav-number">3.1.</span> <span class="nav-text">zabbix 概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%A1%E7%90%86"><span class="nav-number">3.1.2.</span> <span class="nav-text">管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zabbix-server"><span class="nav-number">3.2.</span> <span class="nav-text">zabbix server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zabbix-proxy"><span class="nav-number">3.3.</span> <span class="nav-text">zabbix proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zabbix-agent"><span class="nav-number">3.4.</span> <span class="nav-text">zabbix agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sender"><span class="nav-number">3.5.</span> <span class="nav-text">sender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get"><span class="nav-number">3.6.</span> <span class="nav-text">get</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-tomcat"><span class="nav-number">3.7.</span> <span class="nav-text">监控 tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%8A%A8%E4%B8%8E%E8%A2%AB%E5%8A%A8%E7%9B%91%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.8.</span> <span class="nav-text">主动与被动监控模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A2%AB%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.8.1.</span> <span class="nav-text">被动模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.8.2.</span> <span class="nav-text">主动模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zabbix-proxy-1"><span class="nav-number">4.</span> <span class="nav-text">zabbix proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#zabbix-proxy-%E6%9E%B6%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">zabbix proxy 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zabbix-proxy-%E5%AF%B9%E6%AF%94-zbbbix-server"><span class="nav-number">4.2.</span> <span class="nav-text">zabbix proxy 对比 zbbbix server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zabbix-proxy-%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="nav-number">4.3.</span> <span class="nav-text">zabbix proxy 部署与使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#apt-x2F-yum-%E5%AE%89%E8%A3%85-zabbix-proxy"><span class="nav-number">4.3.1.</span> <span class="nav-text">apt&#x2F;yum 安装 zabbix proxy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-zabbix-proxy"><span class="nav-number">4.3.2.</span> <span class="nav-text">编译安装 zabbix proxy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zabbix-%E7%9B%91%E6%8E%A7%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98"><span class="nav-number">5.</span> <span class="nav-text">zabbix 监控案例实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-Linux-TCP-%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81"><span class="nav-number">5.1.</span> <span class="nav-text">监控 Linux TCP 连接状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-Memcached"><span class="nav-number">5.2.</span> <span class="nav-text">监控 Memcached</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-Redis"><span class="nav-number">5.3.</span> <span class="nav-text">监控 Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-Nginx"><span class="nav-number">5.4.</span> <span class="nav-text">监控 Nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SNMP-%E7%9B%91%E6%8E%A7"><span class="nav-number">5.5.</span> <span class="nav-text">SNMP 监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SNMP-%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92"><span class="nav-number">5.5.1.</span> <span class="nav-text">SNMP 数据交互</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SNMP-%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84"><span class="nav-number">5.5.2.</span> <span class="nav-text">SNMP 组织结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SNMP-MIB"><span class="nav-number">5.5.3.</span> <span class="nav-text">SNMP MIB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SNMP-OID"><span class="nav-number">5.5.4.</span> <span class="nav-text">SNMP OID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-zabbix"><span class="nav-number">5.5.5.</span> <span class="nav-text">配置 zabbix</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-MySQL"><span class="nav-number">5.6.</span> <span class="nav-text">监控 MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#percona-monitoring-plugins"><span class="nav-number">5.6.1.</span> <span class="nav-text">percona-monitoring-plugins</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%84%9A%E6%9C%AC%E7%9B%91%E6%8E%A7-MySQL"><span class="nav-number">5.6.2.</span> <span class="nav-text">自定义脚本监控 MySQL</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AB%AF%E5%8F%A3%E5%92%8C%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7"><span class="nav-number">5.7.</span> <span class="nav-text">自定义端口和进程监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E8%87%AA%E6%B2%BB%E6%84%88%E5%8A%9F%E8%83%BD"><span class="nav-number">5.8.</span> <span class="nav-text">故障自治愈功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grafana-%E5%9B%BE%E5%BD%A2%E5%B1%95%E7%A4%BA"><span class="nav-number">5.9.</span> <span class="nav-text">grafana 图形展示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%BA%E7%A1%80%E7%9B%91%E6%8E%A7%E6%A8%A1%E6%9D%BF"><span class="nav-number">5.10.</span> <span class="nav-text">自定义基础监控模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E5%90%88-pyhton-%E8%84%9A%E6%9C%AC%E7%9B%91%E6%8E%A7%E6%A1%88%E4%BE%8B"><span class="nav-number">5.11.</span> <span class="nav-text">结合 pyhton 脚本监控案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kubernetes-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC"><span class="nav-number">5.11.1.</span> <span class="nav-text">kubernetes 集群状态监控脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-MongodbDB-%E5%A4%8D%E5%88%B6%E9%9B%86%E7%8A%B6%E6%80%81"><span class="nav-number">5.11.2.</span> <span class="nav-text">监控 MongodbDB 复制集状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-Redis-%E5%88%97%E8%A1%A8%E9%95%BF%E5%BA%A6"><span class="nav-number">5.11.3.</span> <span class="nav-text">监控 Redis 列表长度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-ELK-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-number">5.11.4.</span> <span class="nav-text">监控 ELK 集群状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-RabbitMQ-%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81"><span class="nav-number">5.11.5.</span> <span class="nav-text">监控 RabbitMQ 集群节点状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zabbix-%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6"><span class="nav-number">6.</span> <span class="nav-text">Zabbix 事件通知机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%AE%E4%BB%B6%E9%80%9A%E7%9F%A5"><span class="nav-number">6.1.</span> <span class="nav-text">邮件通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%AD%E4%BF%A1%E9%80%9A%E7%9F%A5"><span class="nav-number">6.2.</span> <span class="nav-text">短信通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E4%BF%A1%E9%80%9A%E7%9F%A5"><span class="nav-number">6.3.</span> <span class="nav-text">微信通知</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zabbix-%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4"><span class="nav-number">7.</span> <span class="nav-text">Zabbix 自动化运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E9%83%A8%E7%BD%B2-Agent"><span class="nav-number">7.1.</span> <span class="nav-text">批量部署 Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">7.2.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%8F%91%E7%8E%B0%E4%B8%BB%E6%9C%BA"><span class="nav-number">7.3.</span> <span class="nav-text">动态发现主机</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.to2b.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/zabbix/zabbix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Zabbix | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Zabbix
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-05 10:43:08" itemprop="dateCreated datePublished" datetime="2021-02-05T10:43:08+08:00">2021-02-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/zabbix/" itemprop="url" rel="index"><span itemprop="name">zabbix</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="监控服务介绍"><a href="#监控服务介绍" class="headerlink" title="监控服务介绍"></a>监控服务介绍</h2><h3 id="逻辑布局"><a href="#逻辑布局" class="headerlink" title="逻辑布局"></a>逻辑布局</h3><p><img data-src="//img.to2b.cn/blog/ljk/1612493098811.png"></p>
<h3 id="整体布局"><a href="#整体布局" class="headerlink" title="整体布局"></a>整体布局</h3><p><img data-src="//img.to2b.cn/blog/ljk/1612493127884.png"></p>
<h3 id="常见的监控服务"><a href="#常见的监控服务" class="headerlink" title="常见的监控服务"></a>常见的监控服务</h3><p><strong>开源监控软件</strong>：cacti、naglos、zabbix、smokeping、open-falcon 等</p>
<h4 id="Cacti"><a href="#Cacti" class="headerlink" title="Cacti"></a>Cacti</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.cacti.net/">https://www.cacti.net/</a><br>github：<a target="_blank" rel="noopener" href="https://github.com/Cacti/cacti">https://github.com/Cacti/cacti</a></p>
<pre class="language-none"><code class="language-none">Cacti是基于LAMP平台展现的网络流量监测及分析工具，通过SNMP技术或自定义脚本从目标设备&#x2F;主机获取监控指标信息；其次进行数据存储，调用模板将数据存到数据库，使用rrdtool存储和更新数据，通过rrdtool绘制结果图形；最后进行数据展现，通过Web方式将监控结果呈现出来，常用于在数据中心监控网络设备

目前还有很多 数据中心、IDC服务商 还在用Cacti</code></pre>

<p>缺点：只针对物理设备、虚拟机这样有固定 IP 地址的设备，不适用于容器</p>
<h4 id="Nagios"><a href="#Nagios" class="headerlink" title="Nagios"></a>Nagios</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.nagios.org/">https://www.nagios.org/</a></p>
<pre class="language-none"><code class="language-none">Nagios用来监视系统和网络的开源应用软件，利用其众多的插件实现对本机和远端服务的监控，当被监控对象发生异常时，会及时向管理员告警，提供一批预设好的监控插件，用户可以直接调用，也可以自定义Shell脚本来监控服务，适合各企业的业务监控，可通过Web页面显示对象状态、日志、告警信息，分层告警机制及自定义监控相对薄弱</code></pre>

<p>缺点：报警机制比较简单，无法实现分组报警、递归报警等功能</p>
<h4 id="SmokePing"><a href="#SmokePing" class="headerlink" title="SmokePing"></a>SmokePing</h4><p>官网地址：<a target="_blank" rel="noopener" href="https://oss.oetiker.ch/smokeping/">https://oss.oetiker.ch/smokeping/</a></p>
<pre class="language-none"><code class="language-none">Smokeping是一款用于网络性能监测的开源监控软件，主要用于对IDC的网络状况，网络质量，稳定性等做检测，通过rrdtool制图方式，图形化地展示网络的时延情况，进而能够清楚的判断出网络的即时通信情况</code></pre>

<p>可以监测全国各地连接到网站的网速，类似 站长之家 的某些测速功能</p>
<h4 id="Open-falcon"><a href="#Open-falcon" class="headerlink" title="Open-falcon"></a>Open-falcon</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.open-falcon.org/">https://www.open-falcon.org/</a><br>github：<a target="_blank" rel="noopener" href="https://github.com/XiaoMi/open-falcon">https://github.com/XiaoMi/open-falcon</a><br>文档：<a target="_blank" rel="noopener" href="https://book.open-falcon.org/zh_0_2/contributing.html">https://book.open-falcon.org/zh_0_2/contributing.html</a></p>
<pre class="language-none"><code class="language-none">小米公司开源出来的监控软件open-falcon(猎鹰)，监控能力和性能较强
插件很多，部署复杂</code></pre>

<h4 id="夜莺"><a href="#夜莺" class="headerlink" title="夜莺"></a>夜莺</h4><p>官网：<a target="_blank" rel="noopener" href="https://n9e.didiyun.com/">https://n9e.didiyun.com/</a></p>
<pre class="language-none"><code class="language-none">滴滴出品，一款经过大规模生产环境验证的、分布式高性能的运维监控系统，基于 Open-falcon 二次开发</code></pre>

<h4 id="Zabbix"><a href="#Zabbix" class="headerlink" title="Zabbix"></a>Zabbix</h4><p>官网：<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/">https://www.zabbix.com/cn/</a></p>
<pre class="language-none"><code class="language-none">Zabbix是一个企业级解决方案，支持实时监控数千台服务器，虚拟机和网络设备，采集百万级监控指标，适用于任何IT基础架构、服务、应用程序和资源的解决方案

目前使用较多的开源监控软件，可横向扩展、自定义监控项、支持多种监控方式、可监控网络与服务等</code></pre>

<p>缺点：zabbix 使用 mysql，数据库部分容易成为瓶颈</p>
<h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4><p>针对容器环境的开源监控软件</p>
<h4 id="商业监控解决方案"><a href="#商业监控解决方案" class="headerlink" title="商业监控解决方案"></a>商业监控解决方案</h4><ul>
<li>监控宝：<a target="_blank" rel="noopener" href="https://www.jiankongbao.com/">https://www.jiankongbao.com/</a> 推荐使用</li>
<li>听云：<a target="_blank" rel="noopener" href="https://www.tingyun.com/">https://www.tingyun.com/</a></li>
</ul>
<h3 id="Zabbix-使用场景及系统概述"><a href="#Zabbix-使用场景及系统概述" class="headerlink" title="Zabbix 使用场景及系统概述"></a>Zabbix 使用场景及系统概述</h3><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features">https://www.zabbix.com/cn/features</a></p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/network_monitoring">网络</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/server_monitoring">服务器</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=clouds">云</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=virtual_machines">虚拟机</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=applications">应用</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=services">服务</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=databases">数据库</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=clouds">Web</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/integrations?cat=security">安全</a></p>
<h4 id="系统概述"><a href="#系统概述" class="headerlink" title="系统概述"></a>系统概述</h4><h5 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h5><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#metric_collection">数据采集</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#problem_detection">问题检测</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#visualization">可视化</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#notification">告警 &amp; 修复</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#security_authentication">安全 &amp; 认证</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#templates">轻松部署</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#auto_discovery">自动发现</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#distributed_monitoring">分布式监控</a>、<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/features#zabbix_api">Zabbix API</a></p>
<h5 id="数据采集"><a href="#数据采集" class="headerlink" title="数据采集"></a>数据采集</h5><p>所有监控系统的工作原理都类似，都需要采集被监控对象的数据</p>
<p>周期性时序数据</p>
<pre class="language-none"><code class="language-none">- 主机&#x2F;对象：服务器、路由器、交换机、存储、防火墙、IP、PORT、URL、自定义监控对象…
  - 服务器较少时，采集时间可以快点，两三分钟一次
  - URL 就是 API
  - 自定义监控对象，通过写脚本实现
- 采集目标：监控项，指标数据（metrics data）</code></pre>

<p><strong>数据采集方式：</strong></p>
<ol>
<li>zabbix-agent 采集本机数据，然后发送给 zabbix-proxy</li>
<li>zabbix-proxy 将数据发送给 zabbix-server<br>注意：不是实时转发，zabbix-proxy 也搭配 mysql，负责临时存储数据</li>
<li>zabbix-server 只和 zabbix-proxy 保持连接即可，将数据存储到 mysql，结束采集</li>
</ol>
<p>如果不安装（或者无法安装）agent 客户端，可以使用特定的协议进行数据采集：</p>
<pre class="language-none"><code class="language-none">- SNMP：适用于路由器、交换机等网络设备
- Telnet
- ssh
- IPMI：物理机上如果有IPM接口，可以采集cpu温度、风扇传输等硬件信息
- JMX：监控java</code></pre>

<h5 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h5><p>监控数据存储系统</p>
<pre class="language-none"><code class="language-none">- SQL: MySQL&#x2F;MariaDB(Zabbix)
- NoSQL：Redis(Open-falcon)
- rrd: Round Robin Database(Cacti) 环形存储，始终保存一年的数据，一年前的覆盖掉

prometheus：时序数据库
zabbix：MySQL
cacti：rrd</code></pre>

<h5 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h5><pre class="language-none"><code class="language-none">- 历史数据: 每个监控项采集到的每个监控值，查询时可能会造成数据库负载过大，开发和测试也会查看
- 趋势数据: 趋势表里主要保留某个监控项一个小时内历史数据的最大值、最小值和平均值以及该监控项一个小时内所采集到的数据个数

趋势数据是对历史数据的筛选，历史数据保存时间短一些，30天足以，趋势数据保存时间长一些，可以设置为一年</code></pre>

<h5 id="阈值"><a href="#阈值" class="headerlink" title="阈值"></a>阈值</h5><p>可按照预定义的阈值等级实现分层报警，可以 80%，不过要考虑基数，<font color=orange>Zabbix 用的好不好，就看阈值设置的好不好，需要慢慢优化</font></p>
<h5 id="告警机制"><a href="#告警机制" class="headerlink" title="告警机制"></a>告警机制</h5><p>email、短信、微信、语音、故障自治愈（zabbix 通知服务器重启，需事先写好脚本，针对物理机和虚拟机）</p>
<p>初级运维 –&gt; 中级运维&#x2F;高级运维 –&gt; 架构师 –&gt; 总监 –&gt; CTO</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">host</span> <span class="token punctuation">(</span>host <span class="token function">groups</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>- templates		<span class="token comment"># 从模板继承告警配置</span>
<span class="token function">host</span> -<span class="token operator">></span> items -<span class="token operator">></span> triggers -<span class="token operator">></span> action <span class="token punctuation">(</span>条件-conditions, 操作-operations<span class="token punctuation">)</span>		<span class="token comment"># 自定义告警配置</span></code></pre>

<h5 id="数据展示"><a href="#数据展示" class="headerlink" title="数据展示"></a>数据展示</h5><pre class="language-none"><code class="language-none">- zabbix web：基于nginx+php
- grafana：以zabbix为数据源，展示更为绚丽的界面</code></pre>

<h2 id="Zabbix-规划及部署"><a href="#Zabbix-规划及部署" class="headerlink" title="Zabbix 规划及部署"></a>Zabbix 规划及部署</h2><p>目前最新的 LTS 版本是 5.0，5.0 和之前版本有明显区别，但是文档还是英文的，所以目前学习还是以 4.0 为准</p>
<p>下载页面：<a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/download">https://www.zabbix.com/cn/download</a></p>
<h3 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h3><ul>
<li>数据库：CPU 和磁盘 IO 一定要快，内存最好 32G，磁盘要大，zabbix 的监控数据会远大于业务数据量</li>
<li>zabbix server：zabbix server 直接装在物理机<ul>
<li>CPU：16 核</li>
<li>磁盘：RAID10、500G</li>
<li>内存：8G（监控几十个节点），16G（监控几百个节点），32G（监控两千个节点）</li>
</ul>
</li>
</ul>
<p><strong>实验：</strong></p>
<p>部署环境：服务器系统 ubuntu 18.04.5 &#x2F; Centos 7.x</p>
<table>
<thead>
<tr>
<th>主机类型</th>
<th>IP 地址</th>
</tr>
</thead>
<tbody><tr>
<td>zabbix server</td>
<td>10.0.1.21</td>
</tr>
<tr>
<td>zabbix 主动代理</td>
<td>10.0.1.22</td>
</tr>
<tr>
<td>zabbix 被动代理</td>
<td>10.0.1.23</td>
</tr>
<tr>
<td>mysql master</td>
<td>10.0.1.24</td>
</tr>
<tr>
<td>mysql slave</td>
<td>10.0.1.25</td>
</tr>
<tr>
<td>web server1</td>
<td>10.0.1.26</td>
</tr>
<tr>
<td>web server2</td>
<td>10.0.1.27</td>
</tr>
</tbody></table>
<h3 id="yum-x2F-apt-安装"><a href="#yum-x2F-apt-安装" class="headerlink" title="yum&#x2F;apt 安装"></a>yum&#x2F;apt 安装</h3><ol>
<li><p>Install Zabbix repository</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$wget</span> https://repo.zabbix.com/zabbix/4.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_4.0-3+bionic_all.deb
<span class="token variable">$ls</span>
zabbix-release_4.0-3+bionic_all.deb
<span class="token variable">$dpkg</span> <span class="token parameter variable">-c</span> zabbix-release_4.0-3+bionic_all.deb 	<span class="token comment">#查看dep包的内容</span>
<span class="token punctuation">..</span>.
<span class="token comment">#zabbix.list：官方提供的源</span>
-rw-r--r-- root/root       <span class="token number">118</span> <span class="token number">2019</span>-07-30 <span class="token number">16</span>:34 ./etc/apt/sources.list.d/zabbix.list
<span class="token punctuation">..</span>.
<span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> zabbix-release_4.0-3+bionic_all.deb 	<span class="token comment">#安装dep包</span>
<span class="token variable">$vim</span> /etc/apt/sources.list.d/zabbix.list	<span class="token comment">#修改zabbix源</span>
<span class="token comment">#deb http://repo.zabbix.com/zabbix/4.0/ubuntu bionic main</span>
<span class="token comment">#deb-src http://repo.zabbix.com/zabbix/4.0/ubuntu bionic main</span>
deb https://mirrors.aliyun.com/zabbix/zabbix/4.0/ubuntu bionic main	<span class="token comment">#替换为阿里云的源</span>
deb-src https://mirrors.aliyun.com/zabbix/zabbix/4.0/ubuntu bionic main
<span class="token variable">$apt</span> update</code></pre>
</li>
<li><p>安装 Zabbix server，Web 前端，agent</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> zabbix-server-mysql zabbix-frontend-php zabbix-agent
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> disable mysql.service	<span class="token comment"># 数据库单独装，把自带的禁用掉</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> stop mysql.service</code></pre>
</li>
<li><p>安装、配置 mysql</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$apt</span> search mysql-server	<span class="token comment"># 确保mysql版本不低于5.7</span>
<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> mysql-server mysql-client

<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$mysql</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
<span class="token comment"># 创建 zabbix_server 数据库</span>
mysql<span class="token operator">></span> create database zabbix_server character <span class="token builtin class-name">set</span> utf8 collate utf8_bin<span class="token punctuation">;</span>
<span class="token comment"># 创建 zabbix_server 用户</span>
mysql<span class="token operator">></span> create user zabbix_server@<span class="token string">'10.0.%.%'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> grant all privileges on zabbix_server.* to zabbix_server@<span class="token string">'10.0.%.%'</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/mysql/mysql.conf.d/mysqld.cnf
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
bind-address        <span class="token operator">=</span> <span class="token number">0.0</span>.0.0	<span class="token comment"># 修改监地址，默认监听127.0.0.1，修改为0.0.0.0</span>

<span class="token punctuation">[</span>root@mysql-master ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart mysql.service</code></pre>

<p>数据库初始化：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$zcat</span> /usr/share/doc/zabbix-server-mysql*/create.sql.gz <span class="token operator">|</span> mysql <span class="token parameter variable">-uzabbix_server</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-h10.0.1.24</span> zabbix_server</code></pre>
</li>
<li><p>为 Zabbix server 配置数据库</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑配置文件 /etc/zabbix/zabbix_server.conf</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/zabbix/zabbix_server.conf
<span class="token assign-left variable">DBHost</span><span class="token operator">=</span><span class="token number">10.0</span>.1.24
<span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBUser</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBPassword</span><span class="token operator">=</span><span class="token number">123456</span>

<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token string">'^[a-Z]'</span>  /etc/zabbix/zabbix_server.conf
<span class="token assign-left variable">LogFile</span><span class="token operator">=</span>/var/log/zabbix/zabbix_server.log
<span class="token assign-left variable">LogFileSize</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">PidFile</span><span class="token operator">=</span>/var/run/zabbix/zabbix_server.pid
<span class="token assign-left variable">SocketDir</span><span class="token operator">=</span>/var/run/zabbix
<span class="token assign-left variable">DBHost</span><span class="token operator">=</span><span class="token number">10.0</span>.1.24
<span class="token assign-left variable">DBName</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBUser</span><span class="token operator">=</span>zabbix_server
<span class="token assign-left variable">DBPassword</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token assign-left variable">SNMPTrapperFile</span><span class="token operator">=</span>/var/log/snmptrap/snmptrap.log
<span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">4</span>
<span class="token assign-left variable">AlertScriptsPath</span><span class="token operator">=</span>/usr/lib/zabbix/alertscripts
<span class="token assign-left variable">ExternalScripts</span><span class="token operator">=</span>/usr/lib/zabbix/externalscripts
<span class="token assign-left variable">FpingLocation</span><span class="token operator">=</span>/usr/bin/fping
<span class="token assign-left variable">Fping6Location</span><span class="token operator">=</span>/usr/bin/fping6
<span class="token assign-left variable">LogSlowQueries</span><span class="token operator">=</span><span class="token number">3000</span></code></pre>
</li>
<li><p>为 Zabbix 前端配置 PHP</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编辑配置文件 /etc/zabbix/apache.conf</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/zabbix/apache.conf
<span class="token comment"># php_value date.timezone Europe/Riga</span>
php_value date.timezone Asia/Shanghai	<span class="token comment"># 修改时区</span>

<span class="token comment"># 重启 zabbix 和 apache 服务</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart zabbix-server zabbix-agent apache2</code></pre>
</li>
<li><p>浏览器访问 <a target="_blank" rel="noopener" href="http://10.0.1.21/zabbix%EF%BC%8C%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E6%8F%90%E7%A4%BA%E4%B8%80%E6%AD%A5%E6%AD%A5%E9%85%8D%E7%BD%AE">http://10.0.1.21/zabbix，然后根据提示一步步配置</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612542025387.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">Database <span class="token builtin class-name">type</span>	MySQL
Database server	<span class="token number">10.0</span>.1.24
Database port	<span class="token number">3306</span>
Database name	zabbix_server
Database user	zabbix_server
Database password	<span class="token number">123456</span>

Zabbix server	<span class="token number">10.0</span>.1.21				<span class="token comment"># ip 和 主机名 均可</span>
Zabbix server port	<span class="token number">10051</span>
Zabbix server name	zabbix_server		<span class="token comment"># 这里随便写</span>

<span class="token comment"># 如果以后更改配置，需要修改两个文件</span>
<span class="token comment">#	/etc/zabbix/zabbix_server.conf</span>
<span class="token comment">#	/usr/share/zabbix/conf/zabbix.conf.php	# 生成的配置在此文件中</span></code></pre>

<p>默认的账号 Admin，密码 zabbix</p>
</li>
<li><p>默认只能显示英文，所以需要汉化</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装简体中文语言环境</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$apt</span> <span class="token function">install</span> language-pack-zh*
<span class="token comment"># 增加中文语言环境变量</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$vim</span> /etc/environment
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games"</span>
<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span><span class="token string">"zh_CN.UTF-8"</span>		<span class="token comment"># 添加此行</span>
<span class="token comment"># 重新设置本地配置</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$dpkg</span>-reconfigure locales</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612545414997.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612545454796.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置好后，需要重启apacha、php-fpm</span>
<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart apache2 php-fpm</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612546094789.png"></p>
<p>但是，还有部分页面乱码，需要更换默认的字体包：</p>
<p>从 windows（位于 C:\Windows\Fonts） 系统中挑一个顺眼的字体包，上传到服务器</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-server fonts<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/share/zabbix/assets/fonts		<span class="token comment"># 注意目录</span>
<span class="token punctuation">[</span>root@zabbix-server fonts<span class="token punctuation">]</span><span class="token variable">$ls</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">' '</span> <span class="token punctuation">\</span>n
graphfont.ttf	<span class="token comment"># 默认字体</span>
simhei.ttf		<span class="token comment"># 刚上传的 黑体</span>
simkai.ttf		<span class="token comment"># 刚上传的 楷体，这两个都可以，其他的不一定可以</span>


<span class="token punctuation">[</span>root@zabbix-server include<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/usr/share/zabbix/include		<span class="token comment"># 注意目录</span>
<span class="token comment"># 修改默认字体为黑体，楷体也可以</span>
<span class="token punctuation">[</span>root@zabbix-server include<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/graphfont/simkai/'</span> defines.inc.php
<span class="token punctuation">[</span>root@zabbix-server include<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart apache2 php-fpm</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1612547625040.png"></p>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/installation/install">https://www.zabbix.com/documentation/4.0/zh/manual/installation/install</a></p>
<p>把 apt 安装的 zabbix-server、zabbix-proxy、zabbix-agent 等软件的 service 文件拷贝出来备用，然后恢复快照</p>
<p>具体详见脚本 script-apt</p>
<p>注意：</p>
<ol>
<li><p>server 和 proxy 不能安装在同一台主机</p>
</li>
<li><p>如果是 centos，安装依赖参考：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> gcc libxml2-devel net-snmp net-snmp-devel <span class="token function">curl</span> curl-devel php phpbcmath php-mbstring mariadb mariadb-devel <span class="token parameter variable">-y</span></code></pre>
</li>
<li><p>汉化操作需要手动执行，脚本没有实现这个功能，不要忘记重启 php-fpm</p>
</li>
</ol>
</li>
</ol>
<h2 id="Zabbix-监控入门基础"><a href="#Zabbix-监控入门基础" class="headerlink" title="Zabbix 监控入门基础"></a>Zabbix 监控入门基础</h2><ol>
<li>了解业务结构</li>
<li>监控</li>
<li>业务优化</li>
</ol>
<h3 id="zabbix-概念"><a href="#zabbix-概念" class="headerlink" title="zabbix 概念"></a>zabbix 概念</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><ul>
<li><p>模板：</p>
<ul>
<li>键值（key）：最基础的指令，每个键值表示一项数据，比如 <code>system.hostname</code> 表示主机名，zabbix 内置了 一些，如果不够用，可以自定义（需要在 zabbix_agentd.conf 中指定）</li>
<li>监控项（item）：主要是由 键值 + 更新周期 组成</li>
<li>应用集：对监控项分组，功能类似的监控项的合集</li>
<li>触发器：据监控项的返回值对比预先设置的阈值，触发器会触发动作<ul>
<li>表达式：功能一般选择 last</li>
</ul>
</li>
<li>图形：</li>
<li>自动发现：</li>
<li>web 场景&#x2F;web 检测：</li>
</ul>
</li>
<li><p>主机群组</p>
<ul>
<li>1</li>
</ul>
</li>
<li><p>主机</p>
<ul>
<li>d</li>
</ul>
</li>
<li><p>维护</p>
<ul>
<li>w</li>
</ul>
</li>
<li><p>动作</p>
<ul>
<li><p>动作：动作由触发器触发，触发动作选项用来限制触发器的范围，一般选主机群组，只有该主机群组中的主机的触发器可以触发动作，多个触发条件可以选择和&#x2F;或的关系</p>
</li>
<li><p>操作：动作的操作会调用报警媒介，发送到指定用户，毕竟数据库出问题，需要发给 DBA，发给网络工程师也不管用</p>
<ul>
<li><p>默认操作步骤持续时间：发送周期，一般配置 60s，即 60 秒发一次</p>
</li>
<li><p>默认标题 和 消息内容：用{}包裹的变量是宏，zabbix 所有内置的宏，参考：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location">官方文档</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 示例：</span>
<span class="token punctuation">&#123;</span>ALERT.SENDTO<span class="token punctuation">&#125;</span>		<span class="token comment"># 报警脚本参数，值来自于用户报警媒介配置，可能是邮件、手机号等等</span>
<span class="token punctuation">&#123;</span>ALERT.SUBJECT<span class="token punctuation">&#125;</span>		<span class="token comment"># 报警脚本参数，默认值由动作配置</span>
<span class="token punctuation">&#123;</span>ALERT.MESSAGE<span class="token punctuation">&#125;</span>		<span class="token comment"># 报警脚本参数，默认值由动作配置</span></code></pre></li>
</ul>
</li>
<li><p>恢复操作：解决完报警信息后，恢复信息也要发送</p>
</li>
<li><p>更新操作：</p>
</li>
</ul>
</li>
<li><p>关联事件</p>
<ul>
<li>4</li>
</ul>
</li>
<li><p>自动发现：添加&#x2F;移除&#x2F;更改元素时执行自动操作</p>
<p><a target="_blank" rel="noopener" href="https://www.zabbix.com/cn/auto_discovery">https://www.zabbix.com/cn/auto_discovery</a><br><a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/discovery/network_discovery">https://www.zabbix.com/documentation/4.0/zh/manual/discovery/network_discovery</a></p>
<ul>
<li>网络发现:定期扫描、发现设备类型，IP，状态，运行时间&#x2F;停机时间等，并采取预定义的操作。</li>
<li>低级别发现（LLD）:自动为设备上不同元素创建监控项，触发器和图形。</li>
<li>主动 agent 自动注册 使用 Zabbix agent 自动开始监控新设备</li>
</ul>
</li>
<li><p>服务</p>
<ul>
<li>2</li>
</ul>
</li>
</ul>
<h4 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h4><ul>
<li>agent 代理程序：即 proxy</li>
<li>报警媒介类型：把报警信息通知给用户的方式，可以配置邮件、短信、微信（通过脚本实现）等方式，以 qq 邮件为例，将 qq 邮箱和用户关联起来，发生报警后，qq 邮箱作为发件人将报警信息发送到用户的邮箱中</li>
<li>用户</li>
</ul>
<h3 id="zabbix-server"><a href="#zabbix-server" class="headerlink" title="zabbix server"></a>zabbix server</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/concepts/server">https://www.zabbix.com/documentation/4.0/zh/manual/concepts/server</a></p>
<p>zabbix server 是整个 zabbix 软件的核心程序。<br>zabbix server 是所有配置、统计和操作数据的中央存储中心，也是 zabbix 监控系统的告警中心。<br>基本的 zabbix server 的功能分解成为三个不同的组件。他们是：zabbix server、web 前端和数据库。</p>
<h3 id="zabbix-proxy"><a href="#zabbix-proxy" class="headerlink" title="zabbix proxy"></a>zabbix proxy</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/concepts/proxy">https://www.zabbix.com/documentation/4.0/zh/manual/concepts/proxy</a></p>
<p>zabbix proxy <font color=red>代表 zabbix server 采集监控数据</font>，减轻 zabbix server 的 cpu 和 io 开销。<br>zabbix proxy 从受监控设备采集监控数据，先将数据缓存到本机数据库，然后传输到所属的 zabbix server。</p>
<h3 id="zabbix-agent"><a href="#zabbix-agent" class="headerlink" title="zabbix agent"></a>zabbix agent</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/concepts/agent">https://www.zabbix.com/documentation/4.0/zh/manual/concepts/agent</a></p>
<p>proxy 和 agent 都是代理，但前者是 服务端，后者是客户端</p>
<p>zabbix agent 部署在被监控目标上，以主动监控本地资源和应用程序（硬盘、内存、处理器统计信息等）。</p>
<p>zabbix agent 收集本地的操作信息并将数据报告给 zabbix server 用于进一步处理。一旦出现异常 （例如硬盘空间已满或者有崩溃的服务进程），zabbix server 会主动警告管理员指定机器上的异常。</p>
<p>zabbix agents 的极高效率缘于它可以利用本地系统调用来完成统计数据的采集。</p>
<p>默认监听在 10051 端口。</p>
<h3 id="sender"><a href="#sender" class="headerlink" title="sender"></a>sender</h3><p>主要用于测试的命令，例如：如果 Zabbix agent 收集不到数据，可以用这个命令发一下测试数据，看一下是 Zabbix agent 的问题还是网络问题</p>
<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>主要用于测试的命令，可以与 Zabbix agent 进行通信，并从 Zabbix agent 那里获取所需的信息</p>
<p>注意：只有 zabbix_agentd.conf 中 Server 配置的 ip 才能从该主机上 get 到数据</p>
<h3 id="监控-tomcat"><a href="#监控-tomcat" class="headerlink" title="监控 tomcat"></a>监控 tomcat</h3><p>所有的监控，配置步骤都是一样的：</p>
<ol>
<li>创建主机</li>
<li>给主机添加模板</li>
</ol>
<h3 id="主动与被动监控模式"><a href="#主动与被动监控模式" class="headerlink" title="主动与被动监控模式"></a>主动与被动监控模式</h3><p>主动和被动都是相对 agent 来说的，被动模式配置简单，所以默认是被动模式</p>
<ul>
<li>被动检查：zabbix server（或 proxy）向 agent 要数据，agent 才工作，否则就不工作</li>
<li>主动检查：agent 从 zabbix server 获取监控项列表，然后定期采集数据，主动发送给 zabbix server</li>
</ul>
<h4 id="被动模式"><a href="#被动模式" class="headerlink" title="被动模式"></a>被动模式</h4><p>被动模式下，zabbix server 会根据主机关联的模板中的监控项和数据采集间隔时间，周期性的打开随机端口并向 zabbix agent 服务器的 10050 发起 tcp 连接，然后发送获取监控项数据的指令，即 zabbix server 发送什么指令，zabbix agent 就收集什么数据，zabbix server 什么时候发送 zabbix agent 就什么时候采集，zabbix server 不发送 zabbix agent 就闲着，所以 zabbix agent 也不用关心其监控项和数据采集周期间隔时间</p>
<p>优点就是配置简单，缺点是会加大 zabbix server 的工作量，在数百甚至数千台服务器的环境下会导致 zabbix server 需要轮训向每个 zabbix agent 发送数据采集指令，如果 zabbix server 负载很高还会导致不能及时获取到最新数据</p>
<h4 id="主动模式"><a href="#主动模式" class="headerlink" title="主动模式"></a>主动模式</h4><p>主动模式下，zabbix agent 主动向 zabbix server 的 10051 端口发起 tcp 连接请求（zabbix agent 配置文件中指定 zabbix server 的 IP 或者主机名），获取到自己的监控项和数据采集周期等信息，然后再周期性的采集指定的数返回给 zabbix server</p>
<p>主动模式可以有效减轻 zabbix server 的压力，推荐使用主动模式</p>
<p><strong>配置主动模式：</strong></p>
<ol>
<li><p>修改 zabbix agent 配置文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zabbix_agentd.conf</span>
<span class="token assign-left variable">PidFile</span><span class="token operator">=</span>/usr/local/zabbix/run/zabbix_agentd.pid
<span class="token assign-left variable">LogFile</span><span class="token operator">=</span>/tmp/zabbix_agentd.log
<span class="token assign-left variable">LogFileSize</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">Server</span><span class="token operator">=</span><span class="token number">10.0</span>.1.21	<span class="token comment"># 被动模式下，指定zabbix server的ip，如果全部监控项都是主动模式，则可注释此项</span>
<span class="token assign-left variable">StartAgents</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">ServerActive</span><span class="token operator">=</span><span class="token number">10.0</span>.1.21		<span class="token comment"># 重点，开启主动模式，指定zabbix server的ip</span>
<span class="token assign-left variable">Hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.1.26			<span class="token comment"># zabbix agent本机的ip</span>
<span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">30</span>
<span class="token assign-left variable">Include</span><span class="token operator">=</span>/usr/local/etc/zabbix_agentd.conf.d/*.conf</code></pre>
</li>
<li><p>生成主动模式模板<br>完全克隆 zabbix 内置的 Template OS Linux 模板，命名为：Template OS Linux-active，修改监控项的类型，可以单独改，也可以批量更新</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613050322184.png"></p>
</li>
<li><p>最后把主动模式模板添加到主机上</p>
</li>
</ol>
<h2 id="zabbix-proxy-1"><a href="#zabbix-proxy-1" class="headerlink" title="zabbix proxy"></a>zabbix proxy</h2><h3 id="zabbix-proxy-架构"><a href="#zabbix-proxy-架构" class="headerlink" title="zabbix proxy 架构"></a>zabbix proxy 架构</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613135861331.png"></p>
<h3 id="zabbix-proxy-对比-zbbbix-server"><a href="#zabbix-proxy-对比-zbbbix-server" class="headerlink" title="zabbix proxy 对比 zbbbix server"></a>zabbix proxy 对比 zbbbix server</h3><table>
<thead>
<tr>
<th>功能</th>
<th>zabbxy proxy</th>
<th>zabbix server</th>
</tr>
</thead>
<tbody><tr>
<td>量级</td>
<td>请量级</td>
<td>相对重量级</td>
</tr>
<tr>
<td>图形</td>
<td>无</td>
<td>带图形控制界面</td>
</tr>
<tr>
<td>可以独立工作</td>
<td>是，可以独立采集数据并存储</td>
<td>是，即数据采集、存储、分析、展示于一体</td>
</tr>
<tr>
<td>易维护</td>
<td>是，配置完成后基本无需管理</td>
<td>维护也不难</td>
</tr>
<tr>
<td>独立数据库</td>
<td>保留少量最近数据</td>
<td>保留指定时间内的所有数据</td>
</tr>
<tr>
<td>报警通知</td>
<td>不支持发送邮件通知</td>
<td>支持邮件、短信等告警机制（基于调用脚本）</td>
</tr>
</tbody></table>
<h3 id="zabbix-proxy-部署与使用"><a href="#zabbix-proxy-部署与使用" class="headerlink" title="zabbix proxy 部署与使用"></a>zabbix proxy 部署与使用</h3><p>zabbix proxy 的大版本必须要和 zabbix server 版本一致，否则会出现兼容性问题</p>
<h4 id="apt-x2F-yum-安装-zabbix-proxy"><a href="#apt-x2F-yum-安装-zabbix-proxy" class="headerlink" title="apt&#x2F;yum 安装 zabbix proxy"></a>apt&#x2F;yum 安装 zabbix proxy</h4><p><a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/installation/install_from_packages/debian_ubuntu">https://www.zabbix.com/documentation/4.0/zh/manual/installation/install_from_packages/debian_ubuntu</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装软件仓库配置包</span>
<span class="token variable">$wget</span> https://repo.zabbix.com/zabbix/4.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_4.0-2+bionic_all.deb
<span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> zabbix-release_4.0-2+stretch_all.deb
<span class="token variable">$sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@http://repo.zabbix.com@https://mirrors.aliyun.com/zabbix@'</span> /etc/apt/sources.list.d/zabbix.list
<span class="token variable">$apt</span> update
<span class="token comment"># 安装 SERVER/PROXY/前端</span>
<span class="token variable">$apt</span> <span class="token function">install</span> zabbix-proxy-mysql
<span class="token variable">$cat</span> /lib/systemd/system/zabbix-proxy.service	<span class="token comment"># 这里的service文件没有看懂</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Zabbix Proxy <span class="token punctuation">(</span>MySQL/MariaDB<span class="token punctuation">)</span>
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:zabbix_proxy
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target mysql.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">User</span><span class="token operator">=</span>zabbix
<span class="token assign-left variable">Group</span><span class="token operator">=</span>zabbix
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/sbin/zabbix_proxy <span class="token parameter variable">--foreground</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-abnormal

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token comment"># 配置数据库</span>
略<span class="token punctuation">..</span>.</code></pre>

<h4 id="编译安装-zabbix-proxy"><a href="#编译安装-zabbix-proxy" class="headerlink" title="编译安装 zabbix proxy"></a>编译安装 zabbix proxy</h4><ol>
<li>编译安装，参考脚本…</li>
<li>修改被监控主机的配置文件，Server 和 ServerActive</li>
<li>管理 -&gt; agent 代理程序 -&gt; 创建代理（注意名称要和 zabbix_proxy.conf 中的 hostname 对应起来） -&gt; 修改主机的“由 agent 代理程序监测”参数</li>
</ol>
<h2 id="zabbix-监控案例实战"><a href="#zabbix-监控案例实战" class="headerlink" title="zabbix 监控案例实战"></a>zabbix 监控案例实战</h2><ol>
<li>自定义监控项</li>
<li>通过脚本采集监控项数据</li>
<li>zabbix agent 获取监控项数据</li>
<li>自定义模板和图形及触发器</li>
<li>验证数据</li>
</ol>
<h3 id="监控-Linux-TCP-连接状态"><a href="#监控-Linux-TCP-连接状态" class="headerlink" title="监控 Linux TCP 连接状态"></a>监控 Linux TCP 连接状态</h3><ol>
<li><p>监控 TCP 连接数脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix-web1 ~<span class="token punctuation">]</span><span class="token comment">#cat /usr/local/zabbix/data/tcp_conn.sh</span>
<span class="token comment">#!/bin/bash</span>
ss <span class="token parameter variable">-ant</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token parameter variable">-v</span> <span class="token assign-left variable">TCP_STAT</span><span class="token operator">=</span><span class="token variable">$1</span> <span class="token parameter variable">-v</span> <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">'$1==TCP_STAT &#123;++s&#125; END &#123;print s&#125;'</span></code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$vim</span> zabbix_agentd.conf
<span class="token punctuation">..</span>.
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>tcp_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/bin/bash /usr/local/zabbix/data/tcp_conn.sh <span class="token variable">$1</span> <span class="token variable">$2</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$chmod</span> a+x zabbix_agentd.conf
<span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$systemctl</span> restart zabbix-agent</code></pre>
</li>
<li><p>zabbix server 测试监控项数据</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@zabbix bin<span class="token punctuation">]</span>$./zabbix_get <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.1.26 <span class="token parameter variable">-p</span> <span class="token number">10050</span> <span class="token parameter variable">-k</span> tcp_status<span class="token punctuation">[</span>TIME-WAIT<span class="token punctuation">]</span>
<span class="token number">1</span>
<span class="token punctuation">[</span>root@zabbix bin<span class="token punctuation">]</span>$./zabbix_get <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.1.26 <span class="token parameter variable">-p</span> <span class="token number">10050</span> <span class="token parameter variable">-k</span> tcp_status<span class="token punctuation">[</span>ESTAB<span class="token punctuation">]</span>
<span class="token number">2</span>
<span class="token punctuation">[</span>root@zabbix bin<span class="token punctuation">]</span>$./zabbix_get <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.1.26 <span class="token parameter variable">-p</span> <span class="token number">10050</span> <span class="token parameter variable">-k</span> tcp_status<span class="token punctuation">[</span>LISTEN<span class="token punctuation">]</span>
<span class="token number">9</span></code></pre>
</li>
<li><p>zabbix web 导入模板<br>配置-模板-导入</p>
</li>
<li><p>将 TCP 监控模板关联至主机</p>
</li>
<li><p>验证监控数据</p>
</li>
</ol>
<h3 id="监控-Memcached"><a href="#监控-Memcached" class="headerlink" title="监控 Memcached"></a>监控 Memcached</h3><ol>
<li><p>安装 memcached</p>
</li>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token string">'^[^#]'</span> /etc/memcached.conf
<span class="token parameter variable">-d</span>
logfile /var/log/memcached.log
<span class="token parameter variable">-m</span> <span class="token number">64</span>
<span class="token parameter variable">-p</span> <span class="token number">11211</span>
<span class="token parameter variable">-u</span> memcache
<span class="token parameter variable">-l</span> <span class="token number">127.0</span>.0.1
<span class="token parameter variable">-P</span> /var/run/memcached/memcached.pid

<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token parameter variable">-e</span> <span class="token string">"stats<span class="token entity" title="\n">\n</span>quit"</span> <span class="token operator">|</span> <span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">11211</span>
STAT pid <span class="token number">5590</span>
STAT <span class="token function">uptime</span> <span class="token number">725</span>
STAT <span class="token function">time</span> <span class="token number">1613618905</span>
STAT version <span class="token number">1.5</span>.6 Ubuntu
STAT libevent <span class="token number">2.1</span>.8-stable
STAT pointer_size <span class="token number">64</span>
STAT rusage_user <span class="token number">0.072870</span>
STAT rusage_system <span class="token number">0.048580</span>
STAT max_connections <span class="token number">1024</span>
STAT curr_connections <span class="token number">1</span>
STAT total_connections <span class="token number">4</span>
STAT rejected_connections <span class="token number">0</span>
STAT connection_structures <span class="token number">2</span>
STAT reserved_fds <span class="token number">20</span>
STAT cmd_get <span class="token number">0</span>
STAT cmd_set <span class="token number">0</span>
STAT cmd_flush <span class="token number">0</span>
STAT cmd_touch <span class="token number">0</span>
STAT get_hits <span class="token number">0</span>
STAT get_misses <span class="token number">0</span>
STAT get_expired <span class="token number">0</span>
STAT get_flushed <span class="token number">0</span>
STAT delete_misses <span class="token number">0</span>
STAT delete_hits <span class="token number">0</span>
STAT incr_misses <span class="token number">0</span>
STAT incr_hits <span class="token number">0</span>
STAT decr_misses <span class="token number">0</span>
STAT decr_hits <span class="token number">0</span>
STAT cas_misses <span class="token number">0</span>
STAT cas_hits <span class="token number">0</span>
STAT cas_badval <span class="token number">0</span>
STAT touch_hits <span class="token number">0</span>
STAT touch_misses <span class="token number">0</span>
STAT auth_cmds <span class="token number">0</span>
STAT auth_errors <span class="token number">0</span>
STAT bytes_read <span class="token number">35</span>
STAT bytes_written <span class="token number">3795</span>
STAT limit_maxbytes <span class="token number">67108864</span>
STAT accepting_conns <span class="token number">1</span>
STAT listen_disabled_num <span class="token number">0</span>
STAT time_in_listen_disabled_us <span class="token number">0</span>
STAT threads <span class="token number">4</span>
STAT conn_yields <span class="token number">0</span>
STAT hash_power_level <span class="token number">16</span>
STAT hash_bytes <span class="token number">524288</span>
STAT hash_is_expanding <span class="token number">0</span>
STAT slab_reassign_rescues <span class="token number">0</span>
STAT slab_reassign_chunk_rescues <span class="token number">0</span>
STAT slab_reassign_evictions_nomem <span class="token number">0</span>
STAT slab_reassign_inline_reclaim <span class="token number">0</span>
STAT slab_reassign_busy_items <span class="token number">0</span>
STAT slab_reassign_busy_deletes <span class="token number">0</span>
STAT slab_reassign_running <span class="token number">0</span>
STAT slabs_moved <span class="token number">0</span>
STAT lru_crawler_running <span class="token number">0</span>
STAT lru_crawler_starts <span class="token number">1275</span>
STAT lru_maintainer_juggles <span class="token number">774</span>
STAT malloc_fails <span class="token number">0</span>
STAT log_worker_dropped <span class="token number">0</span>
STAT log_worker_written <span class="token number">0</span>
STAT log_watcher_skipped <span class="token number">0</span>
STAT log_watcher_sent <span class="token number">0</span>
STAT bytes <span class="token number">0</span>
STAT curr_items <span class="token number">0</span>
STAT total_items <span class="token number">0</span>
STAT slab_global_page_pool <span class="token number">0</span>
STAT expired_unfetched <span class="token number">0</span>
STAT evicted_unfetched <span class="token number">0</span>
STAT evicted_active <span class="token number">0</span>
STAT evictions <span class="token number">0</span>
STAT reclaimed <span class="token number">0</span>
STAT crawler_reclaimed <span class="token number">0</span>
STAT crawler_items_checked <span class="token number">0</span>
STAT lrutail_reflocked <span class="token number">0</span>
STAT moves_to_cold <span class="token number">0</span>
STAT moves_to_warm <span class="token number">0</span>
STAT moves_within_lru <span class="token number">0</span>
STAT direct_reclaims <span class="token number">0</span>
STAT lru_bumps_dropped <span class="token number">0</span>
END

<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$cat</span> memcache_monitor.sh
<span class="token comment">#!/bin/bash</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"stats<span class="token entity" title="\n">\n</span>quit"</span> <span class="token operator">|</span> <span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">11211</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"STAT <span class="token variable">$1</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $3&#125;'</span></code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
</li>
<li><p>zabbix server 测试监控项数据</p>
</li>
<li><p>zabbix web 制作模板</p>
<ol>
<li>创建模板</li>
<li>创建监控项</li>
<li>创建触发器</li>
<li>创建图形</li>
</ol>
</li>
<li><p>模板关联主机</p>
</li>
<li><p>验证监控项数据</p>
</li>
</ol>
<h3 id="监控-Redis"><a href="#监控-Redis" class="headerlink" title="监控 Redis"></a>监控 Redis</h3><ol>
<li><p>安装 Redis</p>
</li>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> info			<span class="token comment"># 所有info</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> info clients	<span class="token comment"># 客户端相关info</span>
<span class="token comment"># Clients</span>
connected_clients:1				<span class="token comment"># 当前连接数</span>
client_longest_output_list:0
client_biggest_input_buf:0
blocked_clients:0
<span class="token punctuation">[</span>root@web1 data<span class="token punctuation">]</span><span class="token variable">$redis</span>-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> info memory		<span class="token comment"># 内存相关info</span>
<span class="token comment"># Memory</span>
used_memory:839288				<span class="token comment"># 已用内存</span>
used_memory_human:819.62K
used_memory_rss:3846144
used_memory_rss_human:3.67M
used_memory_peak:841288
used_memory_peak_human:821.57K
used_memory_peak_perc:99.76%
used_memory_overhead:832134
used_memory_startup:782504
used_memory_dataset:7154
used_memory_dataset_perc:12.60%
total_system_memory:2065870848
total_system_memory_human:1.92G
used_memory_lua:37888
used_memory_lua_human:37.00K
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
mem_fragmentation_ratio:4.58
mem_allocator:jemalloc-3.6.0
active_defrag_running:0
lazyfree_pending_objects:0</code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
</li>
<li><p>zabbix server 测试监控项数据</p>
</li>
<li><p>zabbix web 模板制作</p>
<ol>
<li>创建模板</li>
<li>创建触监控项：当前连接数监控项、已用内存监控项</li>
<li>创建触发器：当前连接数触发器、已用内存触发器</li>
<li>创建图形：Redis 当前连接数图形、Redis 已用内存图形</li>
</ol>
</li>
<li><p>模板关联主机</p>
</li>
<li><p>验证监控项数据</p>
</li>
</ol>
<h3 id="监控-Nginx"><a href="#监控-Nginx" class="headerlink" title="监控 Nginx"></a>监控 Nginx</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613622059982.png"></p>
<ol>
<li><p>安装 nginx</p>
</li>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function-name function">nginx_active</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Active'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_reading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Reading'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_writing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Writing'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $4&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Waiting'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $6&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_accepts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">awk</span> <span class="token assign-left variable">NR</span><span class="token operator">==</span><span class="token number">3</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_handled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">awk</span> <span class="token assign-left variable">NR</span><span class="token operator">==</span><span class="token number">3</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">nginx_requests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">curl</span> <span class="token string">"http://127.0.0.1:/nginx_status/"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token function">awk</span> <span class="token assign-left variable">NR</span><span class="token operator">==</span><span class="token number">3</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $3&#125;'</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
active<span class="token punctuation">)</span>
    nginx_active
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
reading<span class="token punctuation">)</span>
    nginx_reading
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
writing<span class="token punctuation">)</span>
    nginx_writing
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
waiting<span class="token punctuation">)</span>
    nginx_waiting
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
accepts<span class="token punctuation">)</span>
    nginx_accepts
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
handled<span class="token punctuation">)</span>
    nginx_handled
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
requests<span class="token punctuation">)</span>
    nginx_requests
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span></code></pre>
</li>
<li><p>zabbix agent 添加自定义监控项</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@web1 etc<span class="token punctuation">]</span><span class="token variable">$cat</span> zabbix_agentd.conf
<span class="token punctuation">..</span>.
<span class="token assign-left variable">UserParameter</span><span class="token operator">=</span>nginx_status<span class="token punctuation">[</span>*<span class="token punctuation">]</span>,/usr/local/zabbix/data/nginx_status.sh <span class="token variable">$1</span>
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>导入 Nginx 监控模板</p>
</li>
<li><p>模板关联主机</p>
</li>
<li><p>验证监控数据</p>
</li>
</ol>
<h3 id="SNMP-监控"><a href="#SNMP-监控" class="headerlink" title="SNMP 监控"></a>SNMP 监控</h3><p>SNMP：Simple Network Management Protocol，简单网络管理协议，<strong>TCP&#x2F;IP 协议簇的一个应用层协议</strong></p>
<p>Linux 设备通过 agent 监控，网络设备通过 SNMP 协议监控，主要用于监控华为、思科等网络设备</p>
<p>SNMP 有三个版本：目前主要使用的是 v2c 版本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">SNMP v1		<span class="token comment"># 团体名（Community Name）认证</span>
SNMP v2c	<span class="token comment"># 团体名认证，它在兼容SNMP v1的同时又扩充了SNMP v1的功能</span>
SNMP v3		<span class="token comment"># 基于用户的安全模型（USM，User-Based Security Model）的认证机制</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1613654628015.png"></p>
<h4 id="SNMP-数据交互"><a href="#SNMP-数据交互" class="headerlink" title="SNMP 数据交互"></a>SNMP 数据交互</h4><p>SNMP 管理进程与代理进程之间为了交互信息，定义了 5 种报文：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">get-request			<span class="token comment"># 从代理进程处提取一个或多个参数值</span>
get-response		<span class="token comment"># 返回的一个或多个参数值。这个操作是由代理进程发出的</span>
<span class="token builtin class-name">trap</span>				<span class="token comment"># 代理进程主动发出的报文，通知管理进程有某些事情发生</span>
get-next-request	<span class="token comment"># 从代理进程处提取一个或多个参数的下一个参数值</span>
set-request			<span class="token comment"># 设置代理进程的一个或多个参数值</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1613636339217.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613636481313.png"></p>
<h4 id="SNMP-组织结构"><a href="#SNMP-组织结构" class="headerlink" title="SNMP 组织结构"></a>SNMP 组织结构</h4><p>SNMP 结构非常复杂，一套完整的 SNMP 系统主要包括以下几个方面：</p>
<ol>
<li>SNMP 报文协议</li>
<li>管理信息结构（SMI， Structure of Management Information），一套公用的结构和表示符号</li>
<li>管理信息库（MIB，Management Information Base），管理信息库包含所有代理进程的所有可被查询和修改的参数</li>
<li>OID（Object Identifiers），一个 OID 是一个唯一的键值对，用于标识具体某一个设备的某个具体信息（对象标识），如端口信息、设备名称等</li>
</ol>
<h4 id="SNMP-MIB"><a href="#SNMP-MIB" class="headerlink" title="SNMP MIB"></a>SNMP MIB</h4><p>MIB 是 OID 的集合。MIB 是基于对象标识树的，对象标识是一个整数序列，中间以”.”分割，这些整数构成一个树型结构，类似于 DNS 或 Unix 的文件系统，MIB 被划分为若干个组，如 system、 interfaces、 a t（地址转换）和 ip 组等。iso. org.dod.internet.private.enterprises（1.3 .6 .1.4.1）这个标识，是给厂家自定义而预留的，比如华为：1.3.6.1.4.1.2011，华三：1.3.6.1.4.1.25506</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613636377969.png"></p>
<h4 id="SNMP-OID"><a href="#SNMP-OID" class="headerlink" title="SNMP OID"></a>SNMP OID</h4><p>OID 就是对象标识</p>
<p>snmpwalk 工具可以使用 SNMP 的 get 请求查询指定 OID 入口的所有 OID 树信息。通过 snmpwalk 也可以查看支持 SNMP 协议（可网管）的设备的一些其他信息，比如 cisco 交换机或路由器 IP 地址、内存使用率等，也可用来协助开发 SNMP 功能</p>
<p>ubuntu 中版本较新，这里以 centos7 为例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> net-snmp-utils
<span class="token variable">$snmpwalk</span> <span class="token parameter variable">-h</span>
USAGE: snmpwalk <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> AGENT <span class="token punctuation">[</span>OID<span class="token punctuation">]</span>
–h：显示帮助。
–v：指定snmp的版本, <span class="token number">1</span>或者2c或者3。
–c：指定连接设备SNMP密码。			<span class="token comment"># 重点</span>
–V：显示当前snmpwalk命令行版本。		<span class="token comment"># 重点，其实基本上也就只用这俩参数</span>
–r：指定重试次数，默认为0次。
–t：指定每次请求的等待超时时间，单为秒，默认为3秒。
–l：指定安全级别：noAuthNoPriv<span class="token operator">|</span>authNoPriv<span class="token operator">|</span>authPriv。
–a：验证协议：MD5<span class="token operator">|</span>SHA。只有-l指定为authNoPriv或authPriv时才需要。
–A：验证字符串。只有-l指定为authNoPriv或authPriv时才需要。
–x：加密协议：DES。只有-l指定为authPriv时才需要。
–X：加密字符串。只有-l指定为authPriv时才需要。

<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token comment">#snmpwalk -v 2c -c 123456 10.0.58.108 1.3.6.1.2.1.1.1</span>
iso.3.6.1.2.1.1.1.0 <span class="token operator">=</span> STRING: <span class="token string">"Linux centos7 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64"</span>

<span class="token punctuation">[</span>root@zabbix-server ~<span class="token punctuation">]</span><span class="token comment">#snmpwalk -v 2c -c 123456 10.0.58.108 1.3.6.1.2.1.1.5</span>
iso.3.6.1.2.1.1.5.0 <span class="token operator">=</span> STRING: <span class="token string">"centos7"</span></code></pre>

<h4 id="配置-zabbix"><a href="#配置-zabbix" class="headerlink" title="配置 zabbix"></a>配置 zabbix</h4><p>使用 zabbix 自带的 SNMP，<font color=black>要先修改团体名称，否则 会因为团体名不一致导致 zabbix 没有权限去获取被监控服务器的 snmp 利用率</font></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613655277258.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613655353719.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613655591144.png"></p>
<h3 id="监控-MySQL"><a href="#监控-MySQL" class="headerlink" title="监控 MySQL"></a>监控 MySQL</h3><p>监控 MySQL 连接数、主从同步、同步延迟等</p>
<h4 id="percona-monitoring-plugins"><a href="#percona-monitoring-plugins" class="headerlink" title="percona-monitoring-plugins"></a>percona-monitoring-plugins</h4><p>percona 官方出了专门的监控管理软件，所以已经停止维护 percona-monitoring-plugins，以下使用旧的版本</p>
<ol>
<li><p>监控脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@mysql-master src<span class="token punctuation">]</span><span class="token variable">$wget</span> https://downloads.percona.com/downloads/percona-monitoring-plugins/percona-monitoring-plugins-1.1.8/binary/debian/artful/x86_64/percona-zabbix-templates_1.1.8-1.artful_all.deb

<span class="token variable">$dpkg</span> <span class="token parameter variable">-c</span> percona-zabbix-templates_1.1.8-1.artful_all.deb <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span>
<span class="token punctuation">..</span>.
./var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh	<span class="token comment"># 监控脚本，修改手动修改</span>
./var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php	<span class="token comment"># 设置mysql的用户名和密码</span>
./var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf	<span class="token comment"># userparameter</span>
./var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8.xml	<span class="token comment"># 模板文件，直接导入即可</span>
<span class="token punctuation">..</span>.
<span class="token variable">$dpkg</span> <span class="token parameter variable">-i</span> percona-zabbix-templates_1.1.8-1.artful_all.deb

<span class="token variable">$cp</span> /var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh /usr/local/zabbix/data/
<span class="token variable">$vim</span> /var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php
<span class="token operator">&lt;</span>?php
<span class="token punctuation">..</span>.
<span class="token variable">$mysql_user</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">;</span>
<span class="token variable">$mysql_pass</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token punctuation">..</span>.</code></pre>
</li>
<li><p>新建模板：直接导入<code>zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8.xml</code>即可</p>
</li>
<li><p>新建主机，并连接到刚创建的模板</p>
</li>
</ol>
<h4 id="自定义脚本监控-MySQL"><a href="#自定义脚本监控-MySQL" class="headerlink" title="自定义脚本监控 MySQL"></a>自定义脚本监控 MySQL</h4><p>编写脚本监控脚本 MySQL 主从同步及延迟</p>
<p>slave 机器上有两个关键的进程：</p>
<ul>
<li>Slave_SQL_Running：负责自己的 slave mysql 进程</li>
<li>Slave_IO_Running：负责与主机的 io 通信</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 主从延迟，实际上只靠 Seconds_Behind_Master 这一个参数是不够的</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-e</span> <span class="token string">"show slave status\G;"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Seconds_Behind_Master:"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'&#123;print $2&#125;'</span>

mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-e</span> <span class="token string">"show slave status\G;"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Slave_IO_Running"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'&#123;print $2&#125;'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^[ \t]*//g'</span>

mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-e</span> <span class="token string">"show slave status\G;"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Slave_SQL_Running:"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'&#123;print $2&#125;'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^[ \t]*//g'</span></code></pre>

<h3 id="自定义端口和进程监控"><a href="#自定义端口和进程监控" class="headerlink" title="自定义端口和进程监控"></a>自定义端口和进程监控</h3><p>zabbix 内置相关 key：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查 TCP 端口 是否处于侦听状态。返回 0 - 未侦听；1 - 正在侦听</span>
net.tcp.listen<span class="token punctuation">[</span>port<span class="token punctuation">]</span>
<span class="token comment"># 检查是否能建立 TCP 连接到指定端口。返回 0 - 不能连接；1 - 可以连接</span>
net.tcp.port<span class="token punctuation">[</span><span class="token operator">&lt;</span>ip<span class="token operator">></span>,port<span class="token punctuation">]</span>
<span class="token comment"># 检查服务是否运行并接受 TCP 连接。返回 0 - 服务关闭；1 - 服务运行</span>
net.tcp.service<span class="token punctuation">[</span>service,<span class="token operator">&lt;</span>ip<span class="token operator">></span>,<span class="token operator">&lt;</span>port<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token comment"># 检查 TCP 服务的性能，当服务 down 时返回 0，否则返回连接服务花费的秒数</span>
net.tcp.service.perf<span class="token punctuation">[</span>service,<span class="token operator">&lt;</span>ip<span class="token operator">></span>,<span class="token operator">&lt;</span>port<span class="token operator">></span><span class="token punctuation">]</span></code></pre>

<h3 id="故障自治愈功能"><a href="#故障自治愈功能" class="headerlink" title="故障自治愈功能"></a>故障自治愈功能</h3><p>当 zabbix 监控到指定的监控项异常的时候，通过指定的操作使故障自动恢复，通常是重启服务等一些简单的操作，也可以调用脚本执行比较复杂的操作</p>
<p>设置监控项和触发器，新建动作，在触发条件里面添加操作，在远程主机通过 zabbix 客户端执行命令</p>
<ol>
<li><p>zabbix agent 需要开启远程命令执行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zabbix_agentd.conf</span>
<span class="token assign-left variable">EnableRemoteCommands</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 开启远程执行命令</span>
<span class="token assign-left variable">UnsafeUserParameters</span><span class="token operator">=</span><span class="token number">1</span>		<span class="token comment"># 允许远程执行命令的时候使用不安全的参数(特殊字符串)</span></code></pre>
</li>
<li><p>zabbix 用户授权</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># /etc/sudoers</span>
zabbix ALL <span class="token operator">=</span> NOPASSWD: ALL	<span class="token comment"># 授权指定用户执行特殊命令不再需要密码，比如sudo等</span></code></pre>
</li>
<li><p>创建动作<br>配置–动作–创建动作<br><img data-src="//img.to2b.cn/blog/ljk/1613698738326.png"></p>
</li>
<li><p>执行远程操作</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613698754613.png"></p>
</li>
<li><p>验证自治愈功能</p>
<p>将被测试的服务手动停止运行，验证能否自动启动或重启，更多操作可以远程执行脚本<br>手动将 Nginx、Tomcat 等 web 服务停止后，验证 zabbix agent 能否自动启动或重启</p>
</li>
</ol>
<h3 id="grafana-图形展示"><a href="#grafana-图形展示" class="headerlink" title="grafana 图形展示"></a>grafana 图形展示</h3><p>grafana 本身只是一个图形显示工具，它独立于 zabbix 之外，通过 zabbix 提供的 api 获取数据，进行展示，其实不只是 zabbix，它还可以搭配 prometheus、elasticsearch、mysql 等等，只要你提供数据，它都能给你展示出来</p>
<p>grafana 相比 zabbix 自带的 web 界面，更加好看</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613701073079.png"></p>
<ol>
<li><p>安装 grafana 服务<br><a target="_blank" rel="noopener" href="https://grafana.com/grafana/download?platform=linux">https://grafana.com/grafana/download?platform=linux</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> adduser libfontconfig1
<span class="token function">wget</span> https://dl.grafana.com/oss/release/grafana_7.4.2_amd64.deb
<span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> grafana_7.4.2_amd64.deb</code></pre>
</li>
<li><p>grafana 安装并启用 zabbix 插件<br><a target="_blank" rel="noopener" href="https://grafana.com/grafana/plugins/alexanderzobnin-zabbix-app">https://grafana.com/grafana/plugins/alexanderzobnin-zabbix-app</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">grafana-cli plugins <span class="token function">install</span> alexanderzobnin-zabbix-app

<span class="token comment"># 以上方式可能失败，推荐直接下载，然后移动到插件目录</span>
<span class="token variable">$wegt</span> https://storage.googleapis.com/plugins-community/alexanderzobnin-zabbix-app/release/4.1.2/alexanderzobnin-zabbix-app-4.1.2.zip
<span class="token variable">$unzip</span> alexanderzobnin-zabbix-app-4.1.2.zip
<span class="token variable">$mv</span> alexanderzobnin-zabbix-app /var/lib/grafana/plugins/

<span class="token variable">$systemctl</span> restart grafana-server.service</code></pre>
</li>
<li><p>启动 zabbix 插件</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613726193516.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613726466582.png"></p>
</li>
<li><p>添加 zabbix 数据源</p>
<ol>
<li><p>添加 mysql 数据源</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727074510.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727183092.png"></p>
</li>
<li><p>添加 zabbix 数据源</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727236979.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613727527469.png"></p>
</li>
</ol>
</li>
<li><p>添加 Dashboard</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613728220959.png"></p>
</li>
</ol>
<h3 id="自定义基础监控模板"><a href="#自定义基础监控模板" class="headerlink" title="自定义基础监控模板"></a>自定义基础监控模板</h3><p>略…</p>
<h3 id="结合-pyhton-脚本监控案例"><a href="#结合-pyhton-脚本监控案例" class="headerlink" title="结合 pyhton 脚本监控案例"></a>结合 pyhton 脚本监控案例</h3><h4 id="kubernetes-集群状态监控脚本"><a href="#kubernetes-集群状态监控脚本" class="headerlink" title="kubernetes 集群状态监控脚本"></a>kubernetes 集群状态监控脚本</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kubernetes-master1 ~<span class="token punctuation">]</span><span class="token comment"># cat /usr/local/zabbix/data/k8s_monitor.py</span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author ZhangShiJie</span>

<span class="token function">import</span> subprocess
success_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token assign-left variable">error_list</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
def get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token variable"><span class="token punctuation">((</span>"curl <span class="token operator">-</span>sXGET http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10.20</span><span class="token number">.15</span><span class="token number">.209</span><span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>nodes"<span class="token punctuation">)</span><span class="token punctuation">,</span>shell<span class="token operator">=</span>True<span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
    data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    data2 <span class="token operator">=</span> data1.get<span class="token punctuation">(</span>'items'<span class="token punctuation">)</span>
    #print data2
    for i in data2<span class="token operator">:</span>
        data3 <span class="token operator">=</span> i.get<span class="token punctuation">(</span>'status'<span class="token punctuation">)</span>
        for i in data3.get<span class="token punctuation">(</span>'conditions'<span class="token punctuation">)</span><span class="token operator">:</span>
            if i.get<span class="token punctuation">(</span>'reason'<span class="token punctuation">)</span> <span class="token operator">==</span> 'KubeletReady'<span class="token operator">:</span>
                if i.get<span class="token punctuation">(</span>'type'<span class="token punctuation">)</span> <span class="token operator">==</span> "Ready"<span class="token operator">:</span>
                    if i.get<span class="token punctuation">(</span>'status'<span class="token punctuation">)</span> <span class="token operator">==</span> 'True'<span class="token operator">:</span>
                        success_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span>'status'<span class="token punctuation">))</span></span>
                    <span class="token keyword">elif</span> i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'False'</span><span class="token builtin class-name">:</span>
                        error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">))</span>
                    else:
                        <span class="token builtin class-name">break</span>
                else:
                    error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">))</span>
                    <span class="token comment">#pass</span>
            else:
                error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">))</span>

def count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>error_list<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>:
        print <span class="token number">50</span>
    else:
        print <span class="token number">100</span>

def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># chmod a+x /usr/local/zabbix/data/k8s_monitor.py</span></code></pre>

<h4 id="监控-MongodbDB-复制集状态"><a href="#监控-MongodbDB-复制集状态" class="headerlink" title="监控 MongodbDB 复制集状态"></a>监控 MongodbDB 复制集状态</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cat /usr/local/zabbix/data/mongodb_cluster_monitor.py</span>
<span class="token comment">#!/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author: ZhangShiJie</span>

<span class="token function">import</span> subprocess
success_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token assign-left variable">error_list</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

def get_mongodb_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token punctuation">((</span><span class="token string">"echo 'rs.status()' | /usr/local/mongodb/bin/mongo -u user -p wswd --authenticationDatabase admin \
| grep health | awk -F':' '&#123;print <span class="token variable">$2</span>&#125;' | awk -F',' '&#123;print <span class="token variable">$1</span>&#125;'"</span><span class="token punctuation">)</span>,shell<span class="token operator">=</span>True, <span class="token assign-left variable">stdout</span><span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
    restful <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> restful.split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> data:
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">"1"</span><span class="token builtin class-name">:</span>
            success_list.append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        else:
            error_list.append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

def count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>error_list<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>:
        print <span class="token number">100</span>
    else:
        print <span class="token number">50</span>

def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_mongodb_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count_status<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#chmod a+x /usr/local/zabbix/data/redis_llen.py</span></code></pre>

<h4 id="监控-Redis-列表长度"><a href="#监控-Redis-列表长度" class="headerlink" title="监控 Redis 列表长度"></a>监控 Redis 列表长度</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@redis ~<span class="token punctuation">]</span><span class="token comment">#cat /usr/local/zabbix/data/redis_llen.py</span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author ZhangShijie</span>
<span class="token function">import</span> redis
def redis_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token assign-left variable">pool</span><span class="token operator">=</span>redis.ConnectionPool<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"10.20.0.252"</span>,port<span class="token operator">=</span><span class="token number">6379</span>,db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    conn <span class="token operator">=</span> redis.Redis<span class="token punctuation">(</span>connection_pool<span class="token operator">=</span>pool<span class="token punctuation">)</span>
    data <span class="token operator">=</span> conn.llen<span class="token punctuation">(</span><span class="token string">'api4-nginx-accesslog'</span><span class="token punctuation">)</span>
    print<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
redis_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@redis ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x /usr/local/zabbix/data/redis_llen.py</span></code></pre>

<h4 id="监控-ELK-集群状态"><a href="#监控-ELK-集群状态" class="headerlink" title="监控 ELK 集群状态"></a>监控 ELK 集群状态</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk-s1 ~<span class="token punctuation">]</span><span class="token comment"># vim /usr/local/zabbix/data/els_status.py</span>

<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author ZhangShijie</span>

<span class="token function">import</span> subprocess
<span class="token assign-left variable">false</span><span class="token operator">=</span><span class="token string">"false"</span>
obj <span class="token operator">=</span> subprocess.Popen<span class="token punctuation">((</span><span class="token string">"curl -sXGET http://10.20.3.128:9200/_cluster/health?
pretty=true"</span><span class="token punctuation">)</span>,shell<span class="token operator">=</span>True, <span class="token assign-left variable">stdout</span><span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
status <span class="token operator">=</span> data1.get<span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> status <span class="token operator">==</span> <span class="token string">"green"</span><span class="token builtin class-name">:</span>
    print <span class="token string">"100"</span>
else:
    print <span class="token string">"50"</span>

<span class="token punctuation">[</span>root@elk-s1 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x /usr/local/zabbix/data/els_status.py</span></code></pre>

<h4 id="监控-RabbitMQ-集群节点状态"><a href="#监控-RabbitMQ-集群节点状态" class="headerlink" title="监控 RabbitMQ 集群节点状态"></a>监控 RabbitMQ 集群节点状态</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cat /usr/local/zabbix/data/rabbit_cluster_monitor.py</span>
<span class="token comment">#!/bin/env python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#Author: ZhangShiJie</span>

<span class="token function">import</span> subprocess
running_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
error_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token assign-left variable">false</span><span class="token operator">=</span><span class="token string">"false"</span>
<span class="token assign-left variable">true</span><span class="token operator">=</span><span class="token string">"true"</span>
def get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    obj <span class="token operator">=</span> subprocess.Popen<span class="token variable"><span class="token punctuation">((</span>"curl <span class="token operator">-</span>sXGET <span class="token operator">-</span>u guest<span class="token operator">:</span>guest http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10.20</span><span class="token number">.3</span><span class="token number">.171</span><span class="token operator">:</span><span class="token number">15671</span><span class="token operator">/</span>api<span class="token operator">/</span>nodes"<span class="token punctuation">)</span><span class="token punctuation">,</span>shell<span class="token operator">=</span>True<span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess.PIPE<span class="token punctuation">)</span>
    data <span class="token operator">=</span> obj.stdout.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data1 <span class="token operator">=</span> eval<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    for i in data1<span class="token operator">:</span>
        if i.get<span class="token punctuation">(</span>"running"<span class="token punctuation">)</span> <span class="token operator">==</span> "true"<span class="token operator">:</span>
            running_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span>"name"<span class="token punctuation">))</span></span>
        else:
            error_list.append<span class="token punctuation">(</span>i.get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">))</span>
def count_server<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>running_list<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span>: <span class="token comment">#可以判断错误列表大于0或者运行列表小于3，3未总计的节点数量</span>
        print <span class="token number">100</span> <span class="token comment">#100就是集群内有节点运行不正常了</span>
    else:
        print <span class="token number">50</span> <span class="token comment">#50为所有节点全部运行正常</span>
def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    get_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count_server<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#chmoa a+x /usr/local/zabbix/data/rabbit_cluster_monitor.py</span></code></pre>

<h2 id="Zabbix-事件通知机制"><a href="#Zabbix-事件通知机制" class="headerlink" title="Zabbix 事件通知机制"></a>Zabbix 事件通知机制</h2><p>出现故障报警的时候，可以通过不同方式通知管理员进行故障处理，尽快恢复业务</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zabbix_server.conf</span>
<span class="token assign-left variable">AlertScriptsPath</span><span class="token operator">=</span>/usr/lib/zabbix/alertscripts 	<span class="token comment">#报警脚本路径</span>
<span class="token assign-left variable">ExternalScripts</span><span class="token operator">=</span>/usr/lib/zabbix/externalscripts <span class="token comment">#外部脚本路径</span></code></pre>

<p>报警的最核心就是把报警媒介配置好，包括它前后的部分</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1613730116604.png"></p>
<ol>
<li>添加报警媒介（邮件、短信、微信）</li>
<li>将报警媒介添加到动作的操作中，这样通过动作，就将触发器和报警媒介关联起来了</li>
<li>将报警媒介添加到用户，这样，当有触发器报警，就会通过报警媒介通知到用户</li>
</ol>
<h3 id="邮件通知"><a href="#邮件通知" class="headerlink" title="邮件通知"></a>邮件通知</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613732542403.png"></p>
<h3 id="短信通知"><a href="#短信通知" class="headerlink" title="短信通知"></a>短信通知</h3><p><img data-src="//img.to2b.cn/blog/ljk/1613733940901.png"></p>
<h3 id="微信通知"><a href="#微信通知" class="headerlink" title="微信通知"></a>微信通知</h3><p>略..，和短信通知差不多</p>
<h2 id="Zabbix-自动化运维"><a href="#Zabbix-自动化运维" class="headerlink" title="Zabbix 自动化运维"></a>Zabbix 自动化运维</h2><h3 id="批量部署-Agent"><a href="#批量部署-Agent" class="headerlink" title="批量部署 Agent"></a>批量部署 Agent</h3><p>使用 agent，实现 agent 的自动化批量安装，可以通过源码或 apt 等方式安装</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>通过 zabbix web 进行的操作，都提供对应的 API，可以通过编程的方式实现</p>
<p>API 简介：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/api">https://www.zabbix.com/documentation/4.0/zh/manual/api</a><br>API 列表：<a target="_blank" rel="noopener" href="https://www.zabbix.com/documentation/4.0/zh/manual/api/reference">https://www.zabbix.com/documentation/4.0/zh/manual/api/reference</a></p>
<h3 id="动态发现主机"><a href="#动态发现主机" class="headerlink" title="动态发现主机"></a>动态发现主机</h3><p><a target="_blank" rel="noopener" href="http://blogs.studylinux.net/?p=705">http://blogs.studylinux.net/?p=705</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="//img.to2b.cn/blog/ljk/1607160536339.png" alt="像方便面一样的男子 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="//img.to2b.cn/blog/ljk/1607160019009.png" alt="像方便面一样的男子 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Zabbix/" rel="tag"><i class="fa fa-tag"></i> Zabbix</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/TomCat/memcached/" rel="prev" title="memcached">
                  <i class="fa fa-chevron-left"></i> memcached
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/zabbix/zabbix_server.conf/" rel="next" title="zabbix_server.conf">
                  zabbix_server.conf <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-1 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.to2b.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.to2b.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.to2b.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.to2b.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
