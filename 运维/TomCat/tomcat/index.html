<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.lujinkai.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.lujinkai.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="JAVA 基础Java 动态网页技术servlet就是前端代码和 java 代码混合的 java 文件，hello.java 示例： 123456789101112131415161718192021import java.io.*;import javax.servlet.*;import javax.servlet.http.*;public class HelloWorld extends">
<meta property="og:type" content="article">
<meta property="og:title" content="tomcat">
<meta property="og:url" content="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/TomCat/tomcat/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:description" content="JAVA 基础Java 动态网页技术servlet就是前端代码和 java 代码混合的 java 文件，hello.java 示例： 123456789101112131415161718192021import java.io.*;import javax.servlet.*;import javax.servlet.http.*;public class HelloWorld extends">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1611972812220.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1665801418608.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1611972852483.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1611972864242.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1611973366044.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1611974301614.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612001766459.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612064233227.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612079811469.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612080515159.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612082891274.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612100702899.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612112198795.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612151828593.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612166152971.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612168658161.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612168462956.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612238340678.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612421682238.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612344278251.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612422174426.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612439688703.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612438140927.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612434978564.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612435183380.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1612435453238.png">
<meta property="article:published_time" content="2021-01-31T17:24:48.000Z">
<meta property="article:modified_time" content="2023-05-29T08:58:05.502Z">
<meta property="article:author" content="像方便面一样的男子">
<meta property="article:tag" content="Tomcat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.to2b.cn/blog/ljk/1611972812220.png">


<link rel="canonical" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/TomCat/tomcat/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/TomCat/tomcat/","path":"运维/TomCat/tomcat/","title":"tomcat"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>tomcat | LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LJKのBlog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JAVA-%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">JAVA 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5%E6%8A%80%E6%9C%AF"><span class="nav-number">1.1.</span> <span class="nav-text">Java 动态网页技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#servlet"><span class="nav-number">1.1.1.</span> <span class="nav-text">servlet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jsp-Java-Server-Pages"><span class="nav-number">1.1.2.</span> <span class="nav-text">jsp (Java Server Pages)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDK"><span class="nav-number">1.2.</span> <span class="nav-text">JDK</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Oracle-JDK"><span class="nav-number">1.2.1.</span> <span class="nav-text">Oracle JDK</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Open-JDK"><span class="nav-number">1.2.2.</span> <span class="nav-text">Open JDK</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tomcat-%E5%9F%BA%E7%A1%80"><span class="nav-number">2.</span> <span class="nav-text">Tomcat 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-x2F-%E5%8D%87%E7%BA%A7-x2F-%E5%9B%9E%E6%BB%9A"><span class="nav-number">2.1.</span> <span class="nav-text">安装&#x2F;升级&#x2F;回滚</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="nav-number">2.1.2.</span> <span class="nav-text">升级和回滚</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tomcat-%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E5%92%8C%E7%BB%84%E6%88%90"><span class="nav-number">2.2.</span> <span class="nav-text">tomcat 的文件结构和组成</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.1.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%A5%E5%BF%97"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">日志</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6"><span class="nav-number">2.2.2.</span> <span class="nav-text">组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B"><span class="nav-number">2.2.3.</span> <span class="nav-text">tomcat 处理请求过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="nav-number">2.3.</span> <span class="nav-text">应用部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JSP-WebApp-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">2.3.1.</span> <span class="nav-text">JSP WebApp 目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E9%A1%B5%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.3.2.</span> <span class="nav-text">主页设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.3.3.</span> <span class="nav-text">应用部署实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%9F%BA%E4%BA%8E-JAVA-%E7%9A%84%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F-JPress"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">部署基于 JAVA 的博客系统 JPress</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-WEB-%E7%9A%84%E7%AE%A1%E7%90%86-Server-status-%E5%92%8C-Manager-APP-%E5%AE%9E%E7%8E%B0%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">基于 WEB 的管理 Server status 和 Manager APP 实现应用部署</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-WEB-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%AE%A1%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0-APP-%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="nav-number">2.3.3.3.</span> <span class="nav-text">基于 WEB 应用程序管理器实现 APP 的部署</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.3.4.</span> <span class="nav-text">常见配置详解</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3-8005-x2F-tcp-%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">端口 8005&#x2F;tcp 安全配置管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA%E6%8C%87%E5%AE%9A%E7%9A%84-http-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-number">2.3.4.2.</span> <span class="nav-text">显示指定的 http 服务器版本信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.4.3.</span> <span class="nav-text">其他配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.4.4.</span> <span class="nav-text">多虚拟主机配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-web-%E6%96%B9%E5%BC%8F%E7%9A%84-Host-Manager-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E7%AE%A1%E7%90%86"><span class="nav-number">2.3.4.5.</span> <span class="nav-text">基于 web 方式的 Host Manager 虚拟主机管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Context-%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.4.6.</span> <span class="nav-text">Context 配置</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.</span> <span class="nav-text">反向代理和负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tomcat-Session-Replication-Cluster"><span class="nav-number">4.</span> <span class="nav-text">Tomcat Session Replication Cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#session-%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1%E5%99%A8-msm"><span class="nav-number">5.</span> <span class="nav-text">session 共享服务器 msm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-1"><span class="nav-number">5.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sticky-%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.2.</span> <span class="nav-text">sticky 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#non-sticky-%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.3.</span> <span class="nav-text">non-sticky 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-memcached-%E5%AE%9E%E7%8E%B0-non-sticky-%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.3.1.</span> <span class="nav-text">实战案例: memcached 实现 non-sticky 模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-redis-%E5%AE%9E%E7%8E%B0-non-sticky-%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.3.2.</span> <span class="nav-text">实战案例: redis 实现 non-sticky 模式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Session-%E9%97%AE%E9%A2%98%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="nav-number">5.4.</span> <span class="nav-text">Session 问题方案总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tomcat-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">6.</span> <span class="nav-text">Tomcat 性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM-%E7%BB%84%E6%88%90"><span class="nav-number">6.1.</span> <span class="nav-text">JVM 组成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-Garbage-Collection-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8"><span class="nav-number">6.2.</span> <span class="nav-text">GC (Garbage Collection) 垃圾收集器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="nav-number">6.2.1.</span> <span class="nav-text">垃圾回收算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E4%BB%A3%E5%A0%86%E5%86%85%E5%AD%98-GC-%E7%AD%96%E7%95%A5"><span class="nav-number">6.2.2.</span> <span class="nav-text">分代堆内存 GC 策略</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Minor-GC"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">Minor GC</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Major-GC"><span class="nav-number">6.2.2.2.</span> <span class="nav-text">Major GC</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java-%E5%86%85%E5%AD%98%E8%B0%83%E6%95%B4%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0"><span class="nav-number">6.2.3.</span> <span class="nav-text">java 内存调整相关参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%96%B9%E5%BC%8F"><span class="nav-number">6.2.4.</span> <span class="nav-text">垃圾收集方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E6%95%B4%E7%AD%96%E7%95%A5"><span class="nav-number">6.2.5.</span> <span class="nav-text">调整策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="nav-number">6.2.6.</span> <span class="nav-text">垃圾回收器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="nav-number">6.2.6.1.</span> <span class="nav-text">常用垃圾回收器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E8%AE%BE%E7%BD%AE"><span class="nav-number">6.2.6.2.</span> <span class="nav-text">垃圾收集器设置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JAVA-%E5%8F%82%E6%95%B0%E6%80%BB%E7%BB%93"><span class="nav-number">6.2.7.</span> <span class="nav-text">JAVA 参数总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM-%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7"><span class="nav-number">6.3.</span> <span class="nav-text">JVM 相关工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JMX"><span class="nav-number">6.3.1.</span> <span class="nav-text">JMX</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jps"><span class="nav-number">6.3.2.</span> <span class="nav-text">jps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jinfo"><span class="nav-number">6.3.3.</span> <span class="nav-text">jinfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jstat"><span class="nav-number">6.3.4.</span> <span class="nav-text">jstat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jstack"><span class="nav-number">6.3.5.</span> <span class="nav-text">jstack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jmap"><span class="nav-number">6.3.6.</span> <span class="nav-text">jmap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jhat"><span class="nav-number">6.3.7.</span> <span class="nav-text">jhat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jconsole"><span class="nav-number">6.3.8.</span> <span class="nav-text">jconsole</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jvisualvm"><span class="nav-number">6.3.9.</span> <span class="nav-text">jvisualvm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-jvisualvm-%E7%9A%84-Visual-GC-%E6%8F%92%E4%BB%B6"><span class="nav-number">6.3.9.1.</span> <span class="nav-text">使用 jvisualvm 的 Visual GC 插件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Jprofiler"><span class="nav-number">6.3.10.</span> <span class="nav-text">Jprofiler</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tomcat-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">6.4.</span> <span class="nav-text">Tomcat 性能优化常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4%E4%BC%98%E5%8C%96"><span class="nav-number">6.4.1.</span> <span class="nav-text">内存空间优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%B0%83%E6%95%B4"><span class="nav-number">6.4.2.</span> <span class="nav-text">线程池调整</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/TomCat/tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="tomcat | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          tomcat
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-01 01:24:48" itemprop="dateCreated datePublished" datetime="2021-02-01T01:24:48+08:00">2021-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/TomCat/" itemprop="url" rel="index"><span itemprop="name">TomCat</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="JAVA-基础"><a href="#JAVA-基础" class="headerlink" title="JAVA 基础"></a>JAVA 基础</h2><h3 id="Java-动态网页技术"><a href="#Java-动态网页技术" class="headerlink" title="Java 动态网页技术"></a>Java 动态网页技术</h3><h4 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h4><p>就是前端代码和 java 代码混合的 java 文件，<code>hello.java</code> 示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    message = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span><span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    response.setContentType(<span class="string">&quot;text/html&quot;</span>); <span class="comment">//响应报文内容类型</span></span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();  <span class="comment">//构建响应报文内容</span></span><br><span class="line">    out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;p&gt;&lt;a href=http://blog.lujinkai.cn/&gt;LJKのBlog&lt;/a&gt;欢迎你&lt;/p&gt;&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="jsp-Java-Server-Pages"><a href="#jsp-Java-Server-Pages" class="headerlink" title="jsp (Java Server Pages)"></a>jsp (Java Server Pages)</h4><p>jsp 是 html 模板，后缀是 jsp，<code>hello.jsp</code> 示例：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line">pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;jsp示例&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;%</span><br><span class="line">    out.println(<span class="string">&quot;你的 IP 地址 &quot;</span> + request.getRemoteAddr());</span><br><span class="line">    %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>浏览器访问 jsp 文件：</p>
<ol>
<li>tomcat 会将 .jsp 文件转为 .java 文件（servlet 类文件）</li>
<li>servlet 类文件转为字节码文件（class 文件），</li>
<li>jvm 解析执行 class 文件</li>
</ol>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello.jsp --&gt; hello.java --&gt; hello.class --&gt; jvm执行hello.class</span><br></pre></td></tr></table></figure>

<h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><p><strong>JRE</strong>：Java Runtime Environment，指 Java 运行时环境， 包含 JVM + Java 核心类库<br><strong>JDK</strong>：Java Development Kit，即 Java 语言的软件开发工具包,JDK 协议基于 JRL（JavaResearch License）协议</p>
<p>简单地说，JRE 就是运行 Java 字节码的虚拟机。但是，如果只有 Java 源码，要编译成 Java 字节码，就需要 JDK，因为 JDK 除了包含 JRE，还提供了编译器、调试器等开发工具。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611972812220.png"></p>
<p><img data-src="//img.to2b.cn/blog/lujinkai/1665801418608.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611972852483.png"></p>
<img data-src="//img.to2b.cn/blog/ljk/1611972864242.png" style="zoom:67%;" />

<h4 id="Oracle-JDK"><a href="#Oracle-JDK" class="headerlink" title="Oracle JDK"></a>Oracle JDK</h4><p><img data-src="//img.to2b.cn/blog/ljk/1611973366044.png"></p>
<p>JDK 有很多版本，Oracle JDK 是官方版，也是用的最多的</p>
<p>Oracle JDK 早期称为 J2SE（标准版）、J2EE（企业版）、J2ME（微型版），现在叫做 JavaEE</p>
<p>早期的 Oracle JDK 的版本以 1.x 的方式命令：JDK 1.0、JDK 1.1、JDK 1.2、JDK 1.3、JDK 1.4</p>
<p>2004 年 9 月 30 日 18:00PM，J2SE1.5 发布，是 Java 语言的发展史上的又一里程碑事件。为了表示这个版本的重要性，J2SE1.5 更名为 J2SE5.0</p>
<p>2005 年 6 月，JavaOne 大会召开，SUN 公司公开 Java SE 6。此时，Java 的各种版本已经更名以取消其中的数字”2”：J2EE 更名为 Java EE, J2SE 更名为 Java SE，J2ME 更名为 Java ME</p>
<h4 id="Open-JDK"><a href="#Open-JDK" class="headerlink" title="Open JDK"></a>Open JDK</h4><p>Oracle JDK 收费，OpenJDK 是第三方版本的 JDK 中最常用的</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1611974301614.png"></p>
<p>OpenJDK 7 是基于 JDK7 的 beta 版开发，但为了也将 Java SE 6 开源，从 OpenJDK7 的 b20 构建反向分支开发，从中剥离了不符合 Java SE 6 规范的代码，发布 OpenJDK 6。所以 OpenJDK6 和 JDK6 没什么关系，只是 API 兼容而已</p>
<p>相对来说,Oracle jDK 具有更好的响应能力和 JVM 性能，更加稳定</p>
<h2 id="Tomcat-基础"><a href="#Tomcat-基础" class="headerlink" title="Tomcat 基础"></a>Tomcat 基础</h2><p>tomcat 既是轻量级 web 服务器，可以处理 http 请求，又是 servlet 容器，可以处理 java 程序</p>
<p>tomcat 使用 java 开发，所以依赖 JRE 或者 JDK 环境</p>
<h3 id="安装-x2F-升级-x2F-回滚"><a href="#安装-x2F-升级-x2F-回滚" class="headerlink" title="安装&#x2F;升级&#x2F;回滚"></a>安装&#x2F;升级&#x2F;回滚</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载二进制包</span></span><br><span class="line">[root@c71 src]<span class="variable">$wget</span> https://mirrors.bfsu.edu.cn/apache/tomcat/tomcat-8/v8.5.61/bin/apache-tomcat-8.5.61.tar.gz</span><br><span class="line"><span class="comment"># 无需编译，解压即可使用</span></span><br><span class="line">[root@c71 src]<span class="variable">$tar</span> zxf apache-tomcat-8.5.61.tar.gz</span><br><span class="line">[root@c71 src]<span class="variable">$mv</span> apache-tomcat-8.5.61 /usr/local/tomcat</span><br><span class="line"><span class="comment"># 创建tomcat用户</span></span><br><span class="line">[root@c71 src]<span class="variable">$useradd</span> -r -s /sbin/nologin tomcat</span><br><span class="line">[root@c71 src]<span class="variable">$chown</span> -R tomcat:tomcat /usr/local/tomcat/</span><br><span class="line">[root@c71 src]<span class="variable">$cd</span> /usr/local/tomcat/</span><br><span class="line">[root@c72 bin]<span class="variable">$ll</span> catalina.sh startup.sh shutdown.sh</span><br><span class="line">-rwxr-x--- 1 tomcat tomcat 25121 Jan 30 17:19 catalina.sh <span class="comment"># 管理tomcat脚本</span></span><br><span class="line">-rwxr-x--- 1 tomcat tomcat  1902 Jan 30 17:19 shutdown.sh <span class="comment"># 停止tomcat脚本</span></span><br><span class="line">-rwxr-x--- 1 tomcat tomcat  1904 Jan 30 17:19 startup.sh <span class="comment"># 启动tomcat脚本</span></span><br><span class="line"><span class="comment"># 提供tomcat所需的环境变量</span></span><br><span class="line">[root@c71 tomcat]<span class="variable">$echo</span> <span class="string">&quot;JAVA_HOME=/usr/local/jdk&quot;</span> &gt;/usr/local/tomcat/conf/tomcat.conf</span><br><span class="line"><span class="comment"># 创建tomcat.service文件</span></span><br><span class="line">[root@c71 tomcat]<span class="variable">$vim</span> /usr/lib/systemd/system/tomcat.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Tomcat</span><br><span class="line"><span class="comment">#After=syslog.target network.target remote-fs.target nss-lookup.target</span></span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">EnvironmentFile=/usr/local/tomcat/conf/tomcat.conf</span><br><span class="line">ExecStart=/usr/local/tomcat/bin/startup.sh</span><br><span class="line">ExecStop=/usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">User=tomcat</span><br><span class="line">Group=tomcat</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">[root@c71 tomcat]<span class="variable">$systemctl</span> daemon-reload</span><br><span class="line">[root@c71 tomcat]<span class="variable">$systemctl</span> <span class="built_in">enable</span> --now tomcat</span><br></pre></td></tr></table></figure>

<h4 id="升级和回滚"><a href="#升级和回滚" class="headerlink" title="升级和回滚"></a>升级和回滚</h4><p>安装新的 tomcat 版本，然后删除旧的软连接，创建新的软连接，最后重启服务</p>
<h3 id="tomcat-的文件结构和组成"><a href="#tomcat-的文件结构和组成" class="headerlink" title="tomcat 的文件结构和组成"></a>tomcat 的文件结构和组成</h3><table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bin</td>
<td>服务启动、停止等相关程序和文件</td>
</tr>
<tr>
<td><strong>conf</strong></td>
<td>配置文件</td>
</tr>
<tr>
<td>lib</td>
<td>库目录</td>
</tr>
<tr>
<td>logs</td>
<td>日志目录</td>
</tr>
<tr>
<td><strong>webapps</strong></td>
<td>应用程序，应用部署目录</td>
</tr>
<tr>
<td>work</td>
<td>jsp 编译后的结果文件，建议提前预热访问</td>
</tr>
</tbody></table>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>文档：<a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.5-doc/index.html">http://tomcat.apache.org/tomcat-8.5-doc/index.html</a></p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>server.xml</td>
<td>主配置文件</td>
</tr>
<tr>
<td>web.xml</td>
<td>每个 webapp 只有“部署”后才能被访问，它的部署方式通常由 web.xml 进行定义，其存放位置为 WEB-INF&#x2F;目录中；此文件为所有的 webapps 提供默认部署相关的配置,每个 web 应用也可以使用专用配置文件,来覆盖全局文件</td>
</tr>
<tr>
<td>context.xml</td>
<td>用于定义所有 web 应用均需加载的 Context 配置，此文件为所有的 webapps 提供默认配置，每个 web 应用也可以使用自已专用的配置，它通常由专用的配置文件 context.xml 来定义，其存放位置为 WEB-INF&#x2F;目录中，覆盖全局的文件</td>
</tr>
<tr>
<td>tomcat-users.xml</td>
<td>用户认证的账号和密码文件</td>
</tr>
<tr>
<td>catalina.policy</td>
<td>当使用 security 选项启动 tomcat 时，用于为 tomcat 设置安全策略</td>
</tr>
<tr>
<td>catalina.properties</td>
<td>Tomcat 环境变量的配置，用于设定类加载器路径，以及一些与 JVM 调优相关参数</td>
</tr>
<tr>
<td>logging.properties</td>
<td>Tomcat 日志系统相关的配置，可以修改日志级别和日志路径等</td>
</tr>
</tbody></table>
<p>注意：配置文件大小写敏感</p>
<h5 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h5><p>参考文档: <a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/TOMCAT/Logging">https://cwiki.apache.org/confluence/display/TOMCAT/Logging</a><br>日志格式: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging">https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging</a></p>
<p>日志文件位于 logs 目录下，日志的格式在 conf&#x2F;server.xml 中定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@c72 tomcat]<span class="variable">$vim</span> conf/server.xml</span><br><span class="line">...</span><br><span class="line">164         &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">165                prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">166                pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><p><img data-src="//img.to2b.cn/blog/ljk/1612001766459.png"></p>
<p>每一个组件都一个对象，这些组件大体可分为以下几个类型：</p>
<ul>
<li><p>顶级组件：Server，代表整个 Tomcat 容器；</p>
</li>
<li><p>服务类组件：Service，可以创建多个 Service，但一般也只创建一个，用来组织 Engine 和 Connector 的对应关系，一个 service 中只有一个 Engine；</p>
</li>
<li><p>连接器组件：Connector，负责客户端的 HTTP、HTTPS、AJP 等协议连接。一个 Connector 只属于某一个 Engine；</p>
<p>AJP（Apache Jserv protocol）是一种基于 TCP 的二进制通讯协议</p>
</li>
<li><p>容器类组件：Engine、Host、Context 都是容器类组件；</p>
<ul>
<li>Engine：引擎，真正的处理请求的入口，其内部定义多个虚拟主机 Host。一个 Engine 上可以绑定多个 Connector</li>
<li>Host：虚拟主机</li>
<li>Context：应用的上下文，配置特定 url 路径映射和目录的映射关系：url &#x3D;&gt; directory</li>
</ul>
</li>
<li><p>内嵌类组件：valve、logger、realm、loader、manager 等。可以内嵌到其他组件内，在不同容器组件内分别定义。</p>
</li>
<li><p>集群类组件：listener、cluster</p>
</li>
</ul>
<p>多个组件关系 <code>/conf/server.xml</code> 示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8015&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">SSLEngine</span>=<span class="string">&quot;on&quot;</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">auth</span>=<span class="string">&quot;Container&quot;</span> <span class="attr">description</span>=<span class="string">&quot;User database that can be updated and saved&quot;</span> <span class="attr">factory</span>=<span class="string">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserDatabase&quot;</span> <span class="attr">pathname</span>=<span class="string">&quot;conf/tomcat-users.xml&quot;</span> <span class="attr">type</span>=<span class="string">&quot;org.apache.catalina.UserDatabase&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">port</span>=<span class="string">&quot;6804&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span> <span class="attr">resourceName</span>=<span class="string">&quot;UserDatabase&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span> <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="tomcat-处理请求过程"><a href="#tomcat-处理请求过程" class="headerlink" title="tomcat 处理请求过程"></a>tomcat 处理请求过程</h4><p>假设来自客户的请求为：<a target="_blank" rel="noopener" href="http://localhost:8080/test/index.jsp">http://localhost:8080/test/index.jsp</a></p>
<ol>
<li>浏览器端的请求被发送到服务端端口 8080，Tomcat 进程监听在此端口上。通过侦听的 HTTP&#x2F;1.1 Connector 获得此请求。</li>
<li>Connector 把该请求交给它所在的 Service 的 Engine 来处理，并等待 Engine 的响应</li>
<li>Engine 获得请求 localhost:8080&#x2F;test&#x2F;index.jsp，遍历它所有虚拟主机 Host</li>
<li>Engine 匹配到名为 localhost 的 Host。如果匹配不到,就把请求交给该 Engine 中的 defaultHost 处理</li>
<li>localhost Host 获得请求&#x2F;test&#x2F;index.jsp，匹配它所拥有的所有 Context</li>
<li>Host 匹配到路径为&#x2F;test 的 Context</li>
<li>path&#x3D;&#x2F;test 的 Context 获得请求 index.jsp，在它的 mapping table 中寻找对应的 servlet</li>
<li>Context 匹配到 URL PATTERN 为 *.jsp 的 servlet，对应于 JspServlet 类构造 HttpServletRequest 对象和 HttpServletResponse 对象，作为参数调用 JspServlet 的 doGet 或 doPost 方法。</li>
<li>Context 把执行完了之后的 HttpServletResponse 对象返回给 Host</li>
<li>Host 把 HttpServletResponse 对象返回给 Engine</li>
<li>Engine 把 HttpServletResponse 对象返回给 Connector</li>
<li>Connector 把 HttpServletResponse 对象返回给浏览器端</li>
</ol>
<h3 id="应用部署"><a href="#应用部署" class="headerlink" title="应用部署"></a>应用部署</h3><p>默认网站根目录是 webapps，其下的每个目录都是一个 WebApp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@c72 tomcat]<span class="variable">$pwd</span></span><br><span class="line">/usr/local/tomcat</span><br><span class="line">[root@c72 tomcat]<span class="variable">$ll</span> webapps/  <span class="comment"># 默认网站根目录</span></span><br><span class="line">total 24</span><br><span class="line">drwxr-x--- 2 tomcat tomcat 4096 Jan 30 22:50 docs</span><br><span class="line">drwxr-x--- 7 tomcat tomcat 4096 Jan 30 22:50 examples</span><br><span class="line">drwxr-x--- 6 tomcat tomcat 4096 Jan 30 17:19 host-manager</span><br><span class="line">drwxr-x--- 6 tomcat tomcat 4096 Jan 30 17:19 manager</span><br><span class="line">drwxr-x--- 3 tomcat tomcat 4096 Jan 30 22:52 ROOT  <span class="comment"># 网站默认根目录</span></span><br></pre></td></tr></table></figure>

<h4 id="JSP-WebApp-目录结构"><a href="#JSP-WebApp-目录结构" class="headerlink" title="JSP WebApp 目录结构"></a>JSP WebApp 目录结构</h4><p>目录结构一般由开发用工具自动生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">index.html <span class="comment"># 主页配置：默认按以下顺序查找主页文件 index.html，index.htm、index.jsp</span></span><br><span class="line">WEB-INF\ <span class="comment"># 当前目录WebApp的私有资源路径，通常存储当前应用使用的web.xml和context.xml配置文件</span></span><br><span class="line">META-INF\ <span class="comment"># 类似于WEB-INF，也是私有资源的配置信息，和WEB-INF/目录一样浏览器无法访问</span></span><br><span class="line">classes\ <span class="comment"># 类文件，当前webapp需要的类</span></span><br><span class="line">lib\  <span class="comment"># 当前应用依赖的jar包</span></span><br></pre></td></tr></table></figure>

<h4 id="主页设置"><a href="#主页设置" class="headerlink" title="主页设置"></a>主页设置</h4><ul>
<li><p>全局配置：修改 conf&#x2F;web.xml 中的 <code>&lt;welcome-file-list&gt;</code> 标签，配置修改后，<font color=red>需要重启 tomcat</font></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>WebApp 的专用配置文件：以 ROOT 为例，将上面主配置文件 conf&#x2F;web.xml 中的 <code>&lt;welcome-file-list&gt;</code> 标签，复制到 webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;web.xml 中，配置修改后，<font color=red>无需重启 tomcat 服务</font></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@c72 tomcat]<span class="variable">$vim</span> webapps/ROOT/WEB-INF/web.xml</span><br><span class="line">&lt;web-app xmlns=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="line">  xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xsi:schemaLocation=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span> version=<span class="string">&quot;3.1&quot;</span> metadata-complete=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">    &lt;display-name&gt;Welcome to Tomcat&lt;/display-name&gt;</span><br><span class="line">  &lt;description&gt;Welcome to Tomcat&lt;/description&gt;</span><br><span class="line">    &lt;welcome-file-list&gt;</span><br><span class="line">        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;  &lt;!-- 调整三个文件顺序 --&gt;</span><br><span class="line">        &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;</span><br><span class="line">        &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">    &lt;/welcome-file-list&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line">[root@c72 tomcat]<span class="variable">$chown</span> -R tomcat:tomcat ./webapps/ROOT/* <span class="comment"># 不要忘记修改属主</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="应用部署实现"><a href="#应用部署实现" class="headerlink" title="应用部署实现"></a>应用部署实现</h4><p><strong>WebApp 应用的归档格式</strong>：<code>.war</code> 和 <code>.jar</code></p>
<ul>
<li>.war：WebApp 打包,类 zip 格式文件，通常包括一个应用的所有资源，比如 jsp、html、配置文件等</li>
<li>.jar：EJB 类文件的打包压缩类 zip 格式文件，包括很多的 class 文件，网景公司发明</li>
</ul>
<p><strong>部署方式</strong>：自动部署 和 手动部署</p>
<ul>
<li><p>自动部署：Tomcat 一旦发现多了一个 web 应用 APP.war 包，默认会自动把它解压缩，加载并启动起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># conf/server.xml中文件配置</span></span><br><span class="line">&lt;Host name=<span class="string">&quot;localhost&quot;</span> appBase=<span class="string">&quot;webapps&quot;</span> unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动部署：冷部署 和 热部署</p>
<ul>
<li>冷部署：将 webapp 放到指定目录，才去启动 Tomcat 服务</li>
<li>热部署：Tomcat 服务不停止，需要依赖 manager、ant 脚本、tcd（tomcat client deployer）等工具</li>
</ul>
</li>
<li><p>反部署 undeploy：停止 webapp 运行，并从 JVM 上清除已经加载的类，从 Tomcat 应用目录中移除部署的文件</p>
</li>
<li><p>启动 start：是 webapp 能够访问</p>
</li>
<li><p>停止 stop：webapp 不能访问，不能提供服务，但是 JVM 并不清除它</p>
</li>
</ul>
<h5 id="部署基于-JAVA-的博客系统-JPress"><a href="#部署基于-JAVA-的博客系统-JPress" class="headerlink" title="部署基于 JAVA 的博客系统 JPress"></a>部署基于 JAVA 的博客系统 JPress</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@c72 webapps]<span class="variable">$pwd</span></span><br><span class="line">/usr/local/tomcat/webapps</span><br><span class="line">[root@c72 webapps]<span class="variable">$mv</span> /usr/local/src/jpress-v3.3.0.war ./</span><br><span class="line">[root@c72 webapps]<span class="variable">$ln</span> -s jpress-v3.3.0 jpress <span class="comment"># 创建软连接，方便以后升级</span></span><br><span class="line">[root@c72 webapps]<span class="variable">$ll</span></span><br><span class="line">total 70024</span><br><span class="line">drwxr-x--- 2 tomcat tomcat     4096 Jan 30 22:50 docs</span><br><span class="line">drwxr-x--- 7 tomcat tomcat     4096 Jan 30 22:50 examples</span><br><span class="line">drwxr-x--- 6 tomcat tomcat     4096 Jan 30 17:19 host-manager</span><br><span class="line">lrwxrwxrwx 1 root   root         13 Jan 31 11:35 jpress -&gt; jpress-v3.3.0</span><br><span class="line">drwxr-x--- 6 tomcat tomcat     4096 Jan 31 11:35 jpress-v3.3.0</span><br><span class="line">-rw-r--r-- 1 root   root   71677863 Jan 31 11:31 jpress-v3.3.0.war</span><br><span class="line">drwxr-x--- 6 tomcat tomcat     4096 Jan 30 17:19 manager</span><br><span class="line">drwxr-x--- 6 tomcat tomcat     4096 Jan 30 23:01 ROOT</span><br></pre></td></tr></table></figure>

<img data-src="//img.to2b.cn/blog/ljk/1612064233227.png" style="zoom:67%;" />

<h5 id="基于-WEB-的管理-Server-status-和-Manager-APP-实现应用部署"><a href="#基于-WEB-的管理-Server-status-和-Manager-APP-实现应用部署" class="headerlink" title="基于 WEB 的管理 Server status 和 Manager APP 实现应用部署"></a>基于 WEB 的管理 Server status 和 Manager APP 实现应用部署</h5><p>默认的管理页面被禁用，启用方法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.xml中Resource的pathname参数指定了授权用户信息的文件：conf/tomcat-users.xml</span></span><br><span class="line"></span><br><span class="line">[root@c72 conf]<span class="variable">$vim</span> tomcat-users.xml</span><br><span class="line"><span class="comment">#加下面两行，指定用户和密码</span></span><br><span class="line">&lt;role rolename=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line">&lt;user username=<span class="string">&quot;admin&quot;</span> password=<span class="string">&quot;123456&quot;</span> roles=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">[root@c72 manager]<span class="variable">$pwd</span></span><br><span class="line">/usr/local/tomcat/webapps/manage</span><br><span class="line">[root@c72 manager]<span class="variable">$vim</span> META-INF/context.xml</span><br><span class="line"><span class="comment"># 当前访问地址是10.0.0.72，可以修改正则表达式为</span></span><br><span class="line">allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.0\.0\.\d+&quot;</span></span><br></pre></td></tr></table></figure>

<p><img data-src="//img.to2b.cn/blog/ljk/1612079811469.png"></p>
<h5 id="基于-WEB-应用程序管理器实现-APP-的部署"><a href="#基于-WEB-应用程序管理器实现-APP-的部署" class="headerlink" title="基于 WEB 应用程序管理器实现 APP 的部署"></a>基于 WEB 应用程序管理器实现 APP 的部署</h5><p>访问 &#x2F;manager 即可</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612080515159.png"></p>
<h4 id="常见配置详解"><a href="#常见配置详解" class="headerlink" title="常见配置详解"></a>常见配置详解</h4><h5 id="端口-8005-x2F-tcp-安全配置管理"><a href="#端口-8005-x2F-tcp-安全配置管理" class="headerlink" title="端口 8005&#x2F;tcp 安全配置管理"></a>端口 8005&#x2F;tcp 安全配置管理</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ss</span> -ntlp | grep 8005</span><br><span class="line">LISTEN   0   1    [::ffff:127.0.0.1]:8005    [::]:*    <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">3117</span>,fd=<span class="number">66</span>))</span><br></pre></td></tr></table></figure>

<p>tomcat 默认监听 8005 端口，这是一个后门，可通过这个端口关闭 tomcat 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$nc</span> 127.0.0.1 8005  <span class="comment"># 连接到本机的8005端口</span></span><br><span class="line">SHUTDOWN    <span class="comment"># 输入SHUTDOWN，关闭tomcat</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.xml</span></span><br><span class="line">&lt;Server port=<span class="string">&quot;8005&quot;</span> shutdown=<span class="string">&quot;SHUTDOWN&quot;</span>&gt; <span class="comment"># 配置后门的端口，和关闭服务的指令</span></span><br></pre></td></tr></table></figure>

<p>此行不能被注释，否则无法启动 tomcat 服务</p>
<p>此管理功能建议禁用：</p>
<ul>
<li>将 SHUTDOWN 改为一串猜不出的字符串实现</li>
<li>port 修改成 0, 会使用随机端口,如:36913</li>
<li>port 设为-1 等无效端口,将关闭此功能</li>
</ul>
<h5 id="显示指定的-http-服务器版本信息"><a href="#显示指定的-http-服务器版本信息" class="headerlink" title="显示指定的 http 服务器版本信息"></a>显示指定的 http 服务器版本信息</h5><p>默认不显示 tomcat 的 http 的 Server 头信息, 可以指定 tomcat 的 http 的 Server 头信息</p>
<p>示例：冒充 nginx 服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给Connector标签添加Server参数</span></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span> connectionTimeout=<span class="string">&quot;20000&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> Server=<span class="string">&quot;nginx&quot;</span> /&gt;</span><br><span class="line"><span class="comment"># 重启tomcat</span></span><br><span class="line">systemctl restart tomcat</span><br></pre></td></tr></table></figure>

<p><img data-src="//img.to2b.cn/blog/ljk/1612082891274.png"></p>
<h5 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h5><p>server.xml 中可以配置 service、connector、Engine、Host 等</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一般情况下，一个Server实例配置一个Service，name属性相当于该Service的ID</span></span><br><span class="line">&lt;Service name=<span class="string">&quot;Catalina&quot;</span>&gt;</span><br><span class="line"><span class="comment"># redirectPort：如果访问HTTPS协议，自动转向这个连接器。但大多数时候，Tomcat并不会开启HTTPS，因为Tomcat往往部署在内部，HTTPS性能较差</span></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span> connectionTimeout=<span class="string">&quot;20000&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br><span class="line"><span class="comment"># 引擎配置</span></span><br><span class="line">&lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;localhost&quot;</span>&gt;</span><br><span class="line"><span class="comment"># defaultHost配置，默认localhost。</span></span><br><span class="line">&lt;Host name=<span class="string">&quot;localhost&quot;</span> appBase=<span class="string">&quot;webapps&quot;</span> unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<h5 id="多虚拟主机配置"><a href="#多虚拟主机配置" class="headerlink" title="多虚拟主机配置"></a>多虚拟主机配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># name：相当于 nginx 的 server_name</span></span><br><span class="line"><span class="comment"># appBase：网站根目录，可以使用相对路径或绝对路径</span></span><br><span class="line"><span class="comment"># unpackWARs：是否自动解压 war 格式</span></span><br><span class="line"><span class="comment"># autoDeploy：热部署，自动加载并运行应用</span></span><br><span class="line">&lt;Host name=<span class="string">&quot;test.ljk.cn&quot;</span> appBase=<span class="string">&quot;/data/wwwroot/test.ljk.cn&quot;</span> unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line"> <span class="comment"># className</span></span><br><span class="line"> <span class="comment"># directory：日志目录，可以使用相对路径或绝对路径</span></span><br><span class="line"> <span class="comment"># 日志文件：prefix.2021-01-31.suffix</span></span><br><span class="line">    &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;/data/wwwlogs&quot;</span> prefix=<span class="string">&quot;test.ljk.cn_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span> pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意日志的权限问题</span></span><br><span class="line"><span class="built_in">chown</span> -R tomcat:tomcat /data/wwwlogs</span><br><span class="line"></span><br><span class="line">[root@c72 test.ljk.cn]<span class="variable">$pwd</span></span><br><span class="line">/data/wwwroot/test.ljk.cn</span><br><span class="line">[root@c72 test.ljk.cn]<span class="variable">$cat</span> ./ROOT/index.html  <span class="comment"># 注意目录结构</span></span><br><span class="line">hello test.ljk.cn</span><br></pre></td></tr></table></figure>

<p><img data-src="//img.to2b.cn/blog/ljk/1612100702899.png"></p>
<h5 id="基于-web-方式的-Host-Manager-虚拟主机管理"><a href="#基于-web-方式的-Host-Manager-虚拟主机管理" class="headerlink" title="基于 web 方式的 Host Manager 虚拟主机管理"></a>基于 web 方式的 Host Manager 虚拟主机管理</h5><p>略…</p>
<h5 id="Context-配置"><a href="#Context-配置" class="headerlink" title="Context 配置"></a>Context 配置</h5><p>Context 类似 Nginx 中的 location</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># path</span></span><br><span class="line"><span class="comment"># docBase：相对、绝对路径均可</span></span><br><span class="line"><span class="comment"># reloadable：WEB-INF/classes或META-INF/lib目录下.class文件有改动，自动重载，生产建议关闭</span></span><br><span class="line">&lt;Context path=<span class="string">&quot;/test&quot;</span> docBase=<span class="string">&quot;/data/test&quot;</span> reloadable=<span class="string">&quot;true&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相当于 Nginx 中：</span></span><br><span class="line">location /test &#123;</span><br><span class="line">    <span class="built_in">alias</span> /data/test;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以单独添加日志配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Context path=<span class="string">&quot;/test&quot;</span> docBase=<span class="string">&quot;/data/test&quot;</span> reloadable=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">    &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span> prefix=<span class="string">&quot;localhost_test_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span> pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Valve 组件</strong></p>
<p>valve(阀门)组件可以定义日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span> prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span> pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># className</span></span><br><span class="line"><span class="comment"># 定义访问日志 org.apache.catalina.valves.AccessLogValve</span></span><br><span class="line"><span class="comment"># 定义访问控制 org.apache.catalina.valves.RemoteAddrValve</span></span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span> deny=<span class="string">&quot;10\.0\.0\.\d+&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<h2 id="反向代理和负载均衡"><a href="#反向代理和负载均衡" class="headerlink" title="反向代理和负载均衡"></a>反向代理和负载均衡</h2><p>tomcat 的网络并发性能比较差，所以通常只用 tomcat 解析动态页面</p>
<p>两种常见的部署方式：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612112198795.png"></p>
<p>nginx 监听 80 端口，tomcat 监听 8080 端口，nginx 负责将请求转发给 tomcat 处理</p>
<p><strong>反向代理：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name to2b.cn;</span><br><span class="line">    access_log off;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://to2b.cn:8080;  <span class="comment"># 反向代理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>负载均衡：</strong></p>
<p>略…</p>
<h2 id="Tomcat-Session-Replication-Cluster"><a href="#Tomcat-Session-Replication-Cluster" class="headerlink" title="Tomcat Session Replication Cluster"></a>Tomcat Session Replication Cluster</h2><p>Tomcat 官方实现了 Session 的复制集群，将每个 Tomcat 的 Session 进行相互的复制同步，从而保证所有 Tomcat 都有相同的 Session 信息</p>
<p>这种同步 session 的方式缺点很明显，就是占用内存，所以不适用于 tomcat 服务器太多的情况，如果只有两三台，可以使用</p>
<p>…</p>
<h2 id="session-共享服务器-msm"><a href="#session-共享服务器-msm" class="headerlink" title="session 共享服务器 msm"></a>session 共享服务器 msm</h2><p>msm：memcached session manager，将 Tomcat 的 session 保持到 memcached 或 redis，实现高可用</p>
<p>github 网站链接: <a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager">https://github.com/magro/memcached-session-manager</a></p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<ol>
<li><p>下载各种包</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612151828593.png"></p>
<p>注意：直接点击会报错 501，这时因为 maven 仓库废弃了 http 访问，手动更改为 https 即可</p>
</li>
<li><p>将相关的 jar 文件都放到 Tomcat 的 lib 目录中即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tomcat的Session管理类</span></span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 驱动类，memcached(spymemcached.jar)、Redis(jedis.jar)</span></span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># Session数据的序列化、反序列化类，官方推荐 kryo</span></span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">asm-5.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@c72 lib]<span class="variable">$pwd</span></span><br><span class="line">/usr/local/tomcat/lib</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/2.3.2/memcached-session-manager-2.3.2.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager-tc8/2.3.2/memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/net/spy/spymemcached/2.12.3/spymemcached-2.12.3.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/msm/msm-kryo-serializer/2.3.2/msm-kryo-serializer-2.3.2.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/de/javakaffee/kryo-serializers/0.45/kryo-serializers-0.45.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/com/esotericsoftware/kryo/3.0.3/kryo-3.0.3.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/org/ow2/asm/asm/5.2/asm-5.2.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/org/objenesis/objenesis/2.6/objenesis-2.6.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/com/esotericsoftware/reflectasm/1.11.9/reflectasm-1.11.9.jar</span><br><span class="line">[root@c72 lib]<span class="variable">$wget</span> https://repo1.maven.org/maven2/com/esotericsoftware/minlog/1.3.1/minlog-1.3.1.jar</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="sticky-模式"><a href="#sticky-模式" class="headerlink" title="sticky 模式"></a>sticky 模式</h3><p>前端 tomcat 和后端 memcached**有关联(粘性)**关系</p>
<p>略…</p>
<h3 id="non-sticky-模式"><a href="#non-sticky-模式" class="headerlink" title="non-sticky 模式"></a>non-sticky 模式</h3><p>前端 tomcat 和后端 memcached**无关联(无粘性)**关系，msm 1.4.0 之后版本开始支持</p>
<p>Tomcat session 为中转 Session，对每一个 SessionID 随机选中后端的 memcached 节点 n1(或者 n2)为主 session，而另一个 memcached 节点 n2(或者是 n1)为备 session。产生的新的 Session 会发送给主、备 memcached，并清除本地 Session</p>
<p>如果 n1 下线，n2 则转正。n1 再次上线，n2 依然是主 Session 存储节点</p>
<h4 id="实战案例-memcached-实现-non-sticky-模式"><a href="#实战案例-memcached-实现-non-sticky-模式" class="headerlink" title="实战案例: memcached 实现 non-sticky 模式"></a>实战案例: memcached 实现 non-sticky 模式</h4><p><img data-src="//img.to2b.cn/blog/ljk/1612166152971.png"></p>
<table>
<thead>
<tr>
<th>ip</th>
<th>服务</th>
<th>安装软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.71</td>
<td>tomcat1、memcached</td>
<td>jdk8、tomcat8、memcached</td>
</tr>
<tr>
<td>10.0.0.72</td>
<td>tomcat1、memcached</td>
<td>jdk8、tomcat8、memcached</td>
</tr>
<tr>
<td>10.0.0.73</td>
<td>负载均衡调度器</td>
<td>haproxy 或者 nginx</td>
</tr>
</tbody></table>
<p>负载均衡调度器的安装配置过程：略…</p>
<p>10.0.0.71 和 10.0.0.72 做以下配置：</p>
<ol>
<li><p>安装配置 memcached</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$yum</span> install memcached</span><br><span class="line"><span class="variable">$vim</span> /etc/sysconfig/memcached</span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span></span><br><span class="line">OPTIONS=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 tomcat 的 context.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line"> ...</span><br><span class="line"> <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">memcachedNodes</span>=<span class="string">&quot;n1:10.0.0.72:11211,n2:10.0.0.73:11211&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">sticky</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">sessionBackupAsync</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">lockingMode</span>=<span class="string">&quot;uriPattern:/path1|/path2&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">requestUriIgnorePattern</span>=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">transcoderFactoryClass</span>=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="实战案例-redis-实现-non-sticky-模式"><a href="#实战案例-redis-实现-non-sticky-模式" class="headerlink" title="实战案例: redis 实现 non-sticky 模式"></a>实战案例: redis 实现 non-sticky 模式</h4><p><img data-src="//img.to2b.cn/blog/ljk/1612168658161.png"></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612168462956.png"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis</a></p>
<h3 id="Session-问题方案总结"><a href="#Session-问题方案总结" class="headerlink" title="Session 问题方案总结"></a>Session 问题方案总结</h3><ol>
<li>session 绑定，基于 IP 或 session cookie 的。其部署简单，尤其基于 session 黏性的方式，粒度小，对负载均衡影响小。但一旦后端服务器有故障，其上的 session 丢失</li>
<li>session 复制集群，基于 tomcat 实现多个服务器内共享同步所有 session。此方法可以保证任意一台后端服务器故障，其余各服务器上还都存有全部 session，对业务无影响。但是它基于多播实现心跳，TCP 单播实现复制，当设备节点过多，这种复制机制不是很好的解决方案。且并发连接多的时候，单机上的所有 session 占据的内存空间非常巨大，甚至耗尽内存</li>
<li>session 服务器，将所有的 session 存储到一个共享的内存空间中，使用多个冗余节点保存 session，这样做到 session 存储服务器的高可用，且占据业务服务器内存较小。是一种比较好的解决 session 持久的解决方案</li>
</ol>
<p>以上的方法都有其适用性。生产环境中，应根据实际需要合理选择</p>
<h2 id="Tomcat-性能优化"><a href="#Tomcat-性能优化" class="headerlink" title="Tomcat 性能优化"></a>Tomcat 性能优化</h2><p>tomcat 是运行在 jvm 虚拟机上的一个程序，所以 tomcat 的性能和 jvm 密切相关，所以要想优化 tomcat 的性能，除了优化 tomcat 本身的设置，还需要优化 jvm</p>
<h3 id="JVM-组成"><a href="#JVM-组成" class="headerlink" title="JVM 组成"></a>JVM 组成</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$java</span> -version</span><br><span class="line">java version <span class="string">&quot;1.8.0_271&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_271-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)</span><br></pre></td></tr></table></figure>

<p>JVM：Java Virtual Machine，java 虚拟机</p>
<p>HotSpot 实现了 Java 虚拟机规范，java 虚拟机有好几种，HotSpot 是最主流的一种</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612238340678.png"></p>
<ul>
<li>类加载子系统：将 java 代码编译成字节码文件，将所需所有类加载到内存，必要时将类实例化成实例</li>
<li><strong>运行时数据区</strong>：最消耗内存的空间，需要优化</li>
<li>执行引擎：包括 JIT （JustInTimeCompiler）即时编译器，GC （Garbage Collector）垃圾回收器</li>
<li>本地方法接口：通过 JNI（Java Native Interface）调用 C、C++ 库其他语言，扩展 Java 功能</li>
</ul>
<p>运行时数据区的<strong>heap</strong>（堆）是我们关注的重点，这部分可以通过修改设置进行优化，其他部分没有优化的途径</p>
<ul>
<li>MetaSpace：元空间，线程共享，存放已加载的类信息（构造方法、接口定义）、常量（final）、静态变量（static）、运行时常量池等。但实例变量存放在堆内存中。**JDK8 之前叫 Method Area（方法区） **</li>
<li><strong>heap</strong>：堆，线程共享，虚拟机启动时创建，存放创建的所有对象信息。如果对象无法申请到可用内存将抛出 OOM 异常。堆是靠 GC 垃圾回收器管理的，通过 -Xmx -Xms 指定最大堆和最小堆空间大小</li>
<li>Java stack：java 栈，线程私有，每个线程会分配一个栈，存放 java 中 8 大基本数据类型、对象引用、实例的本地变量、方法参数和返回值等，基于 FILO()（First In Last Out），每个方法为一个栈帧</li>
<li>Program Counter Register：PC 寄存器，线程私有，就是一个指针，指向方法区中的方法字节码，每一个线程用于记录当前线程正在执行的字节码指令地址。由执行引擎读取下一条指令。因为线程需要切换，当一个线程被切换回来需要执行的时候，需要知道执行到哪里</li>
<li>Native Method stack：本地方法栈，线程私有，为本地方法执行构建的内存空间，存放本地方法执行时的局部变量、操作数等<br>所谓本地方法，即使用 native 关健字修饰的方法，比如 Thread.sleep 方法。简单的说是非 Java 实现的方法，例如操作系统的 C 编写的库提供的本地方法，Java 调用这些本地方法接口执行。但是要注意，本地方法应该避免直接编程使用，因为 Java 可能跨平台使用，如果用了 Windows API，换到了 Linux 平台部署就有了问题</li>
</ul>
<h3 id="GC-Garbage-Collection-垃圾收集器"><a href="#GC-Garbage-Collection-垃圾收集器" class="headerlink" title="GC (Garbage Collection) 垃圾收集器"></a>GC (Garbage Collection) 垃圾收集器</h3><h4 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h4><ul>
<li>标记-清除 Mark-Sweep</li>
<li>标记-压缩 Mark-Compact</li>
<li>复制 Copying</li>
</ul>
<h4 id="分代堆内存-GC-策略"><a href="#分代堆内存-GC-策略" class="headerlink" title="分代堆内存 GC 策略"></a>分代堆内存 GC 策略</h4><p>JVM 内存空间划分为 heap 区和 非 heap 区</p>
<p>heap 内存空间：</p>
<ul>
<li><strong>Eden Space</strong>：伊甸园区</li>
<li><strong>Survivor Space</strong>：幸存者区，分为两部分，一个是 from 区，一个是 to 区。大小相等、地位相同、可互换<ul>
<li>from：指的是本次复制数据的源区</li>
<li>to：指的是本次复制数据的目标区</li>
</ul>
</li>
<li><strong>Tenured Gen</strong>：养老区 或 老年代</li>
</ul>
<p>规律：一般情况 99%的对象都是临时对象</p>
<p>默认空间大小比例：</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612421682238.png"></p>
<p>非 heap 区内存划分：</p>
<ul>
<li><strong>Code Cache</strong>：</li>
<li><strong>Compressed Class Space</strong>：</li>
<li><strong>Metaspace</strong>：</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1612344278251.png"></p>
<h5 id="Minor-GC"><a href="#Minor-GC" class="headerlink" title="Minor GC"></a>Minor GC</h5><p>通常场景下，大多数对象都不会存活很久，而且创建活动非常多，伊甸园区和幸存者区的垃圾回收就非常频繁，所以采用 <strong>复制 Copying</strong> 算法</p>
<ol>
<li>所有新建对象（特大对象直接进入养老区）都出生在 eden</li>
<li>当 eden 满了，启动 GC。这个称为 Young GC 或者 <strong>Minor GC</strong>，标记 eden 存活对象，将存活对象复制到幸存者者区（两个幸存者区之一），GC 完成</li>
<li>当 eden 满了，再次启动 GC，标记 eden 和幸存者区的存活对象，将存活对象复制到另一个幸存者区，GC 完成</li>
</ol>
<p>以后就重复上面的步骤，每当 eden 满了，就将其中的存货对象和幸存者区（from 区）的存货对象复制到另一个幸存者区（to 区）</p>
<p>但是，如果一个对象一直存活，它最后就在 from、to 来回复制，如果 from 区中对象复制次数达到阈值（默认 15 次，CMS 为 6 次，可通过 java 的选项 -XX:MaxTenuringThreshold&#x3D;N 指定)，就直接复制到养老区</p>
<h5 id="Major-GC"><a href="#Major-GC" class="headerlink" title="Major GC"></a>Major GC</h5><p>进入养老区的数据较少，所以养老区被占满的速度较慢，所以垃圾回收也不频繁，所以较常采用 <strong>标记-压缩 Mark-Compact</strong> 算法</p>
<p>如果养老区也满了，会触养老区 GC，称为 Old GC 或者 <strong>Major GC</strong></p>
<p>因为 Major GC 会对整个 heap 内存空间进行垃圾回收，影响所有的区域，所以 Major GC 又叫 <strong>FullGC</strong></p>
<h4 id="java-内存调整相关参数"><a href="#java-内存调整相关参数" class="headerlink" title="java 内存调整相关参数"></a>java 内存调整相关参数</h4><p>Java 命令行参考文档: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
<p>选项分类：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-选项名称  <span class="comment"># 标准选项，所有HotSpot都支持</span></span><br><span class="line">-X选项名称  <span class="comment"># 稳定的非标准选项</span></span><br><span class="line">-XX:选项名称 <span class="comment"># 非标准的不稳定选项，下一个版本可能会取消</span></span><br></pre></td></tr></table></figure>

<p><img data-src="//img.to2b.cn/blog/ljk/1612422174426.png"></p>
<p>常用选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-Xms    <span class="comment"># 设置堆内存初始大小，示例：-Xms2g</span></span><br><span class="line">-Xmx    <span class="comment"># 设置堆内存上限，示例：-Xms4g</span></span><br><span class="line">-XX:NewSize   <span class="comment"># 设置伊甸园区和幸存者区初始大小，示例：-XX:NewSize=128m</span></span><br><span class="line">-XX:MaxNewSize  <span class="comment"># 设置伊甸园区和幸存者区上限，示例：-XX:MaxNewSize=256m</span></span><br><span class="line">-Xmnsize   <span class="comment"># 同时设置-XX:NewSize 和 -XX:MaxNewSize，示例：-Xmn1g</span></span><br><span class="line">-XX:NewRatio  <span class="comment"># 以比例方式设置新生代和老年代，示例：-XX:NewRatio=2，即new/old=1/2</span></span><br><span class="line">-XX:SurvivorRatio <span class="comment"># 以比例方式设置eden和survivor，示例：-XX:SurvivorRatio=6，即eden/survivor=6/1、new/survivor=8/1</span></span><br><span class="line">-Xss    <span class="comment"># 设置每个线程私有的栈空间大小，依据具体线程大小和数量，示例：-Xss256k</span></span><br></pre></td></tr></table></figure>

<p>注意：Xms 和 Xmx 通常设置为相同的值，防止内存碎片化</p>
<h4 id="垃圾收集方式"><a href="#垃圾收集方式" class="headerlink" title="垃圾收集方式"></a>垃圾收集方式</h4><p>按 <strong>回收线程</strong> 数：GC 线程串行（serial）还是并行（parallel）</p>
<ul>
<li>串行垃圾回收器：一个 GC 线程完成回收工作</li>
<li>并行垃圾回收器：多个 GC 线程同时一起完成回收工作，充分利用 CPU 资源</li>
</ul>
<p>按 <strong>工作模式</strong> 不同：GC 线程是否和工作线程一起运行</p>
<ul>
<li><p>独占垃圾回收器：只有 GC 在工作，STW 一直进行到回收完毕，工作线程才能继续执行</p>
</li>
<li><p>并发垃圾回收器：GC 线程垃圾回收某些阶段可以和工作线程一起进行，如标记阶段并行，回收阶段仍然串行</p>
</li>
</ul>
<h4 id="调整策略"><a href="#调整策略" class="headerlink" title="调整策略"></a>调整策略</h4><p>对 JVM 调整策略应用极广</p>
<ul>
<li><p>在 WEB 领域中 Tomcat 等</p>
</li>
<li><p>在大数据领域 Hadoop 生态各组件</p>
</li>
<li><p>在消息中间件领域的 Kafka 等</p>
</li>
<li><p>在搜索引擎领域的 ElasticSearch、Solr 等</p>
</li>
</ul>
<p><strong>注意：在不同领域和场景对 JVM 需要不同的调整策略</strong></p>
<ul>
<li>减少 STW 时长，串行变并行</li>
<li>减少 GC 次数，要分配合适的内存大小</li>
</ul>
<p><strong>一般情况下，我们大概可以使用以下原则：</strong></p>
<ul>
<li>客户端或较小程序，内存使用量不大，可以使用串行回收</li>
<li>对于服务端大型计算，可以使用并行回收</li>
<li>大型 WEB 应用，用户端不愿意等待，尽量少的 STW，可以使用并发回收</li>
</ul>
<h4 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h4><h5 id="常用垃圾回收器"><a href="#常用垃圾回收器" class="headerlink" title="常用垃圾回收器"></a>常用垃圾回收器</h5><p>ParNew：parallel new，并行处理新生代</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612439688703.png"></p>
<p><strong>按分代设置不同垃圾回收器：</strong></p>
<p>新生代：</p>
<ul>
<li>新生代串行收集器 <strong>Serial</strong></li>
<li>新生代并行回收收集器 <strong>PS</strong>（Parallel Scavenge）</li>
<li>新生代并行收集器 <strong>ParNew</strong></li>
</ul>
<p>老年代：</p>
<ul>
<li>老年代串行收集器 <strong>Serial Old</strong></li>
<li>老年代并行回收收集器 <strong>Parallel Old</strong></li>
<li><strong>CMS</strong>（Concurrent Mark Sweep 并发标记清除算法）<strong>收集器</strong></li>
</ul>
<p><strong>以下收集器不再按明确的分代单独设置：</strong></p>
<ul>
<li>G1（Garbage First）收集器<ul>
<li>最新垃圾回收器，从 JDK1.6 实验性提供，JDK1.7 发布，其设计目标是在多处理器、大内存服务器端提供优于 CMS 收集器的吞吐量和停顿控制的回收器。JDK9 将 G1 设为默认的收集器，建议 JDK9 版本以后使用</li>
<li>基于 <strong>标记压缩</strong> 算法,不会产生大量的空间碎片，有利于程序的长期执行</li>
<li>分为 4 个阶段：初始标记、并发标记、最终标记、筛选回收。并发标记并发执行，其它阶段 STW 只有 GC 线程并行执行</li>
<li>G1 收集器是面向服务端的收集器，它的思想就是首先回收尽可能多的垃圾（这也是 Garbage-First 名字的由来）</li>
<li>G1 能充分的利用多 CPU，多核环境下的硬件优势，使用多个 CPU 来缩短 STW 停顿的时间 （<strong>10ms 以内</strong>）</li>
<li>可预测的停顿：这是 G1 相对于 CMS 的另一大优势，G1 和 CMS 一样都是关注于降低停顿时间，但是 G1 能够让使用者明确的指定在一个 M 毫秒的时间片段内，消耗在垃圾收集的时间不得超过 N 毫秒</li>
<li>通过此选项指定: +UseG1GC</li>
</ul>
</li>
<li>ZGC 收集器：减少 SWT 时长(1ms 以内)，可以媲美 C++ 的效率，目前实验阶段</li>
<li>Shenandoah 收集器：和 ZGC 竞争关系，目前实验阶段</li>
<li>Epsilon 收集器：调试 JDK 使用，内部使用，不用于生产环境</li>
</ul>
<h5 id="垃圾收集器设置"><a href="#垃圾收集器设置" class="headerlink" title="垃圾收集器设置"></a>垃圾收集器设置</h5><p>优化调整 Java 相关参数的目标：尽量减少 FullGC 和 STW</p>
<p>通过以下选项可以单独指定新生代、老年代的垃圾收集器</p>
<ul>
<li>-server<br>指定为 Server 模式，也是默认值，一般使用此工作模式</li>
<li>-XX:+UseSerialGC<br>运行在 Client 模式下，新生代是 Serial, 老年代使用 SerialOld</li>
<li>-XX:+UseParNewGC<br>新生代使用 ParNew，老年代使用 SerialOld</li>
<li>-XX:+UseParallelGC<br>运行于 server 模式下，新生代使用 Serial Scavenge, 老年代使用 SerialOld</li>
<li>-XX:+UseParallelOldGC<br>新生代使用 Paralell Scavenge, 老年代使用 Paralell Old<br>-XX:ParallelGCThreads&#x3D;N 在关注吞吐量的场景使用此选项增加并行线程数</li>
<li>-XX:+UseConcMarkSweepGC<br>新生代使用 ParNew, 老年代优先使用 CMS，备选方式为 Serial Old<br>响应时间要短，停顿短使用这个垃圾收集器<br>-XX:CMSInitiatingOccupancyFraction&#x3D;N 达到老年代的大小的百分比多少时触发回收，默认 68<br>-XX:+UseCMSCompactAtFullCollection 开启此值，在 CMS 收集后，进行内存碎片整理<br>-XX:CMSFullGCsBeforeCompaction&#x3D;N 设定多少次 CMS 后，进行一次内存碎片整理<br>-XX:+CMSParallelRemarkEnabled 降低标记停顿</li>
</ul>
<h4 id="JAVA-参数总结"><a href="#JAVA-参数总结" class="headerlink" title="JAVA 参数总结"></a>JAVA 参数总结</h4><table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-Xms</td>
<td><font style="white-space:nowrap;"> 初始堆大小</font></td>
<td>物理内存的 1&#x2F;64(&lt;1GB)</td>
<td>默认(MinHeapFreeRatio 参数可以调整)空余堆内存小于 40%时，JVM 就会增大堆直到-Xmx 的最大限制.</td>
</tr>
<tr>
<td>-Xmx</td>
<td>最大堆大小</td>
<td>物理内存的 1&#x2F;4(&lt;1GB)</td>
<td>默认(MaxHeapFreeRatio 参数可以调整)空余堆内存大于 70%时，JVM 会减少堆直到-Xms 的最小限制</td>
</tr>
<tr>
<td>-Xmn</td>
<td>年轻代大小(1.4or lator)</td>
<td></td>
<td>注意：此处的大小是（eden+ 2 survivor space).与 jmap -heap 中显示的 New gen 是不同的。 整个堆大小&#x3D;年轻代大小 + 年老代大小 + 持久代大小. 增大年轻代后,将会减小年老代大小.此值对系统性能影响较大,Sun 官方推荐配置为整个堆的 3&#x2F;8</td>
</tr>
<tr>
<td>-XX:NewSize</td>
<td>设置年轻代大小(for 1.3&#x2F;1.4)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:MaxNewSize</td>
<td>年轻代最大值(for 1.3&#x2F;1.4)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:PermSize</td>
<td>设置持久代(perm gen)初始值</td>
<td>物理内存的 1&#x2F;64</td>
<td></td>
</tr>
<tr>
<td>-XX:MaxPermSize</td>
<td>设置持久代最大值</td>
<td>物理内存的 1&#x2F;4</td>
<td></td>
</tr>
<tr>
<td>-Xss</td>
<td>-Xss</td>
<td></td>
<td>JDK5.0 以后每个线程堆栈大小为 1M,以前每个线程堆栈大小为 256K.更具应用的线程所需内存大小进行 调整.在相同物理内存下,减小这个值能生成更多的线程.但是操作系统对一个进程内的线程数还是有限制的,不能无限生成,经验值在 3000~5000 左右 一般小的应用， 如果栈不是很深， 应该是 128k 够用的 大的应用建议使用 256k。这个选项对性能影响比较大，需要严格的测试。</td>
</tr>
<tr>
<td>-XX:ThreadStackSize</td>
<td>Thread StackSize</td>
<td></td>
<td>(0 means use defaultstack size) [Sparc: 512;Solaris x86: 320 (was 256prior in 5.0 and earlier);Sparc 64 bit: 1024; Linuxamd64: 1024 (was 0 in 5.0and earlier); all others 0.]</td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>年轻代(包括 Eden 和两个 Survivor 区)与年老代的比值(除去持久代)</td>
<td></td>
<td>-XX:NewRatio&#x3D;4 表示年轻代与年老代所占比值为 1:4,年轻代占整个堆栈的 1&#x2F;5Xms&#x3D;Xmx 并且设置了 Xmn 的情况下，该参数不需要进行设置。</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>Eden 区与 Survivor 区的大小比值</td>
<td></td>
<td>设置为 8,则两个 Survivor 区与一个 Eden 区的比值为 2:8,一个 Survivor 区占整个年轻代的 1&#x2F;10</td>
</tr>
<tr>
<td>-XX:LargePageSizeInBytes</td>
<td>内存页的大小不可设置过大， 会影响 Perm 的大小</td>
<td></td>
<td>&#x3D;128m</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+UseFastAccessorMethods</font></td>
<td>原始类型的快速优化</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+DisableExplicitGC</td>
<td>关闭 System.gc()</td>
<td></td>
<td>这个参数需要严格的测试</td>
</tr>
<tr>
<td>-XX:MaxTenuringThreshold</td>
<td>垃圾最大年龄</td>
<td></td>
<td>如果设置为 0 的话,则年轻代对象不经过 Survivor 区,直接进入年老代. 对于年老代比较多的应用,可以提高效率.如果将此值设置为一个较大值,则年轻代对象会在 Survivor 区进行多次复制,这样可以增加对象再年轻代的存活 时间,增加在年轻代即被回收的概率 该参数只有在串行 GC 时才有效</td>
</tr>
<tr>
<td>-XX:+AggressiveOpts</td>
<td>加快编译</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+UseBiasedLocking</td>
<td>锁机制的性能改善</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-Xnoclassgc</td>
<td>禁用垃圾回收</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:SoftRefLRUPolicyMSPerMB</td>
<td>每兆堆空闲空间中 SoftReference 的存活时间</td>
<td></td>
<td>可达的对象在上次被引用后将保留一段时间。 缺省值是堆中每个空闲兆字节的生命周期的一秒钟</td>
</tr>
<tr>
<td>-XX:PretenureSizeThreshold</td>
<td>对象超过多大是直接在旧生代分配</td>
<td>0</td>
<td>单位字节 新生代采用 Parallel Scavenge GC 时无效 另一种直接在旧生代分配的情况是大的数组对象,且数组中无外部引用对象</td>
</tr>
<tr>
<td>-XX:TLABWasteTargetPercent</td>
<td>TLAB 占 eden 区的百分比</td>
<td>1%</td>
<td></td>
</tr>
<tr>
<td>-XX:+CollectGen0First</td>
<td>FullGC 时是否先 YGC</td>
<td>false</td>
<td></td>
</tr>
</tbody></table>
<p><strong>并行收集器相关参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseParallelGC</td>
<td>Full GC 采用 parallelMSC</td>
<td></td>
<td>选择垃圾收集器为并行收集器.此配置仅对年轻代有效.即上述配置下,年轻代使用并发收集,而年老代仍旧使用串行收集</td>
</tr>
<tr>
<td>-XX:+UseParNewGC</td>
<td>设置年轻代为并行收集</td>
<td></td>
<td>可与 CMS 收集同时使用 JDK5.0 以上,JVM 会根据系统配置自行设置,所以无需再设置此值</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads</td>
<td>并行收集器的线程数</td>
<td></td>
<td>此值最好配置与处理器数目相等 同样适用于 CMS</td>
</tr>
<tr>
<td>-XX:+UseParallelOldGC</td>
<td>年老代垃圾收集方式为并行收集(ParallelCompacting)</td>
<td></td>
<td>这个是 JAVA 6 出现的参数选项</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis</td>
<td>每次年轻代垃圾回收的最长时间(最大暂停时间)</td>
<td></td>
<td>如果无法满足此时间,JVM 会自动调整年轻代大小,以满足此值</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+UseAdaptiveSizePolicy</font></td>
<td>自动选择年轻代区大小和相应的 Survivor 区比例</td>
<td></td>
<td>设置此选项后,并行收集器会自动选择年轻代区大小和相应的 Survivor 区比例,以达到目标系统规定的最低相应时间或者收集频率等,此值建议使用并行收集器时,一直打开</td>
</tr>
<tr>
<td>-XX:GCTimeRatio</td>
<td>设置垃圾回收时间占程序运行时间的百分比</td>
<td></td>
<td>公式为 1&#x2F;(1+n)</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+ScavengeBeforeFullGC</font></td>
<td>Full GC 前调用 YGC</td>
<td>true</td>
<td></td>
</tr>
</tbody></table>
<p><strong>CMS 相关参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>使用 CMS 内存收集</td>
<td></td>
<td>测试中配置这个以后,-XX:NewRatio&#x3D;4 的配置可能失效,所以,此时年轻代大小最好用-Xmn 设置</td>
</tr>
<tr>
<td>-XX:+AggressiveHeap</td>
<td></td>
<td></td>
<td>试图是使用大量的物理内存 长时间大内存使用的优化，能检查计算资源（内存， 处理器数量） 至少需要 256MB 内存 大量的 CPU／内存， （在 1.4.1 在 4CPU 的机器上已经显示有提升）</td>
</tr>
<tr>
<td>-XX:CMSFullGCsBeforeCompaction</td>
<td>多少次后进行内存压缩</td>
<td></td>
<td>由于并发收集器不对内存空间进行压缩,整理,所以运行一段时间以后会产生”碎片”,使得运行效率降低.此值设置运行多少次 GC 以后对内存空间进行压缩,整理</td>
</tr>
<tr>
<td>-XX:+CMSParallelRemarkEnabled</td>
<td>降低标记停顿</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX+UseCMSCompactAtFullCollection</td>
<td>在 FULLGC 的时候，对年老代的压缩</td>
<td></td>
<td>CMS 是不会移动内存的， 因此， 这个非常容易产生碎片，导致内存不够用， 因此， 内存的压缩这个时候就会被启用。增加这个参数是个好习惯。 可能会影响性能,但是可以消除碎片</td>
</tr>
<tr>
<td>-XX:+UseCMSInitiatingOccupancyOnly</td>
<td>使用手动定义初始化定义开始 CMS 收集</td>
<td></td>
<td>禁止 hostspot 自行触发 CMSGC</td>
</tr>
<tr>
<td>-XX:CMSInitiatingOccupancyFraction&#x3D;70</td>
<td>使用 cms 作为垃圾回收使用 70％后开始 CMS 收集</td>
<td>92</td>
<td></td>
</tr>
<tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>使用 CMS 内存收集</td>
<td></td>
<td>测试中配置这个以后,-XX:NewRatio&#x3D;4 的配置可能失效,所以,此时年轻代大小最好用-Xmn 设置</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:CMSInitiatingPermOccupancyFraction</font></td>
<td>设置 PermGen 使用到达多少比率时触发</td>
<td>92</td>
<td></td>
</tr>
<tr>
<td>-XX:+CMSIncrementalMode</td>
<td>设置为增量模式</td>
<td></td>
<td>用于单 CPU 情况</td>
</tr>
<tr>
<td>-XX:+CMSClassUnloadingEnabled</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>辅助信息：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
<th>默认值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+PrintGC</td>
<td></td>
<td></td>
<td>输出形式:[GC 118250K-&gt;113543K(130112K),0.0094143 secs] [Full GC121376K-&gt;10414K(130112K),0.0650971 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCDetails</td>
<td></td>
<td></td>
<td>输出形式:[GC [DefNew:8614K-&gt;781K(9088K),0.0123035 secs] 118250K-&gt;113543K(130112K),0.0124633 secs] [GC[DefNew: 8614K-&gt;8614K(9088K), 0.0000665secs] 121376K-&gt;10414K(130112K),0.0436268 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCTimeStamps</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintGC:PrintGCTimeStamps</td>
<td></td>
<td></td>
<td>可与-XX:+PrintGC -XX:+PrintGCDetails 混合使用输出形式:11.851: [GC98328K-&gt;93620K(130112K),0.0082960 secs]</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationStoppedTime</td>
<td>打印垃圾回收期间程序暂停的时间.可与上面混合使用</td>
<td></td>
<td>输出形式:Total time forwhich application threadswere stopped: 0.0468229seconds</td>
</tr>
<tr>
<td><font style="white-space:nowrap;">-XX:+PrintGCApplicationConcurrentTime</font></td>
<td>打印每次垃圾回收前,程序未中断的执行时间.可与上面混合使用</td>
<td></td>
<td>输出形式:Application time:0.5291524 seconds</td>
</tr>
<tr>
<td>-XX:+PrintHeapAtGC</td>
<td>打印 GC 前后的详细堆栈信息</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-Xloggc:filename</td>
<td>把相关日志信息记录到文件以便分析. 与上面几个配合使用</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintGC</td>
<td></td>
<td></td>
<td>输出形式:[GC 118250K-&gt;113543K(130112K),0.0094143 secs] [Full GC121376K-&gt;10414K(130112K),0.0650971 secs]</td>
</tr>
<tr>
<td>-XX:+PrintClassHistogram</td>
<td>garbagecollectsbeforeprintingthehistogram</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintTLAB</td>
<td>查看 TLAB 空间的使用情况</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintTenuringDistribution</td>
<td>查看每次 minor GC 后新的存活周期的阈值</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="JVM-相关工具"><a href="#JVM-相关工具" class="headerlink" title="JVM 相关工具"></a>JVM 相关工具</h3><p>$JAVA_HOME&#x2F;bin 下</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>jps</td>
<td>查看所有 jvm 进程</td>
</tr>
<tr>
<td>jinfo</td>
<td>查看进程的运行环境参数，主要是 jvm 命令行参数</td>
</tr>
<tr>
<td>jstat</td>
<td>对 jvm 应用程序的资源和性能进行实时监控</td>
</tr>
<tr>
<td>jstack</td>
<td>查看所有线程的运行状态，程序员常用堆栈情况查看工具</td>
</tr>
<tr>
<td>jmap</td>
<td>查看 jvm 占用物理内存的状态</td>
</tr>
<tr>
<td>jhat</td>
<td>+UseParNew</td>
</tr>
<tr>
<td>jconsole</td>
<td>图形工具</td>
</tr>
<tr>
<td>jvisualvm</td>
<td>图形工具</td>
</tr>
</tbody></table>
<h4 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a>JMX</h4><p>JMX（Java Management Extensions，即 Java 管理扩展）是一个为应用程序、设备、系统等植入管理功能的框架。JMX 可以跨越一系列异构操作系统平台、系统体系结构和网络传输协议，灵活的开发无缝集成的系统、网络和服务管理应用。<br>JMX 最常见的场景是监控 Java 程序的基本信息和运行情况，任何 Java 程序都可以开启 JMX，然后使用 JConsole 或 Visual VM 进行预览。</p>
<p>为 Java 程序开启 JMX 很简单，只要在运行 Java 程序的命令后面指定如下命令即可</p>
<p>在 tomcat 开启远程 JMX 如下配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Dcom.sun.management.jmxremote <span class="comment">#启用远程监控JMX</span></span><br><span class="line">-Djava.rmi.server.hostname=10.0.0.71 <span class="comment">#tomcat主机自己的IP地址,不要写zabbix服务器的地址</span></span><br><span class="line">-Dcom.sun.management.jmxremote.port=1100 <span class="comment">#默认启动的JMX端口号，要和zabbix添加主机时候的端口一致</span></span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> <span class="comment">#不启用ssl认证</span></span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span> <span class="comment">#不启用用户名密码认证</span></span><br></pre></td></tr></table></figure>

<h4 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h4><p>JVM 进程状态工具</p>
<h4 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h4><p>输出给定的 java 进程的所有配置信息</p>
<h4 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h4><p>输出指定的 java 进程的统计信息</p>
<h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p>查看指定的 java 进程的线程栈的相关信息，程序员常用堆栈情况查看工具</p>
<h4 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h4><p>Memory Map，用于查看堆内存的使用状态</p>
<h4 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a>jhat</h4><p>Java Heap Analysis Tool 堆分析工具</p>
<h4 id="jconsole"><a href="#jconsole" class="headerlink" title="jconsole"></a>jconsole</h4><p>查看 Java 进程信息的图形化工具</p>
<ol>
<li><p>配置 JMX，在服务器 10.0.0.71 上做如下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$vim</span> /usr/local/tomcat/bin/catalina.sh</span><br><span class="line"><span class="comment"># OS specific support.  $var _must_ be set to either true or false.</span></span><br><span class="line"><span class="comment"># 添加以下配置，注意位置，如果添加在文件末尾，则无法生效</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-Djava.rmi.server.hostname=10.0.0.71 -Dcom.sun.management.jmxremote.port=1100 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$systemctl</span> restart tomcat.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 windows 上配置好 jdk，去 jdk&#x2F;bin 目录下，启动 jconsole.exe</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612438140927.png"></p>
</li>
</ol>
<h4 id="jvisualvm"><a href="#jvisualvm" class="headerlink" title="jvisualvm"></a>jvisualvm</h4><p>监控 jvm 的图形化工具，可以本机监控，也可以远程监控，下面以远程监控为例：</p>
<ol>
<li><p>配置 JMX，在服务器 10.0.0.71 上做如下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$vim</span> /usr/local/tomcat/bin/catalina.sh</span><br><span class="line"><span class="comment"># OS specific support.  $var _must_ be set to either true or false.</span></span><br><span class="line"><span class="comment"># 添加以下配置，注意位置，如果添加在文件末尾，则无法生效</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-Djava.rmi.server.hostname=10.0.0.71 -Dcom.sun.management.jmxremote.port=1100 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$systemctl</span> restart tomcat.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 windows 上配置好 jdk，去 jdk&#x2F;bin 目录下，启动 jvisualvm.exe，添加远程主机 -&gt; 选择添加 jmx 连接</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612434978564.png"></p>
</li>
</ol>
<h5 id="使用-jvisualvm-的-Visual-GC-插件"><a href="#使用-jvisualvm-的-Visual-GC-插件" class="headerlink" title="使用 jvisualvm 的 Visual GC 插件"></a>使用 jvisualvm 的 Visual GC 插件</h5><p><img data-src="//img.to2b.cn/blog/ljk/1612435183380.png"></p>
<p>安装完成后，重启即可，不过因为是远程连接，还需要做其他配置，这个问题百度解决，或者选择使用本机监控</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1612435453238.png"></p>
<h4 id="Jprofiler"><a href="#Jprofiler" class="headerlink" title="Jprofiler"></a>Jprofiler</h4><p>JProfiler 是一款功能强大的 Java 开发分析工具，它可以快速的帮助用户分析出存在的错误，软件还可对需要的显示类进行标记，包括了内存的分配情况和信息的视图等</p>
<p>这个工具是收费的，可以用来定位 OOM 的问题原因</p>
<p>JProfiler 官网：<a target="_blank" rel="noopener" href="http://www.ej-technologies.com/products/jprofiler/overview.html">http://www.ej-technologies.com/products/jprofiler/overview.html</a></p>
<h3 id="Tomcat-性能优化常用配置"><a href="#Tomcat-性能优化常用配置" class="headerlink" title="Tomcat 性能优化常用配置"></a>Tomcat 性能优化常用配置</h3><h4 id="内存空间优化"><a href="#内存空间优化" class="headerlink" title="内存空间优化"></a>内存空间优化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms4g -Xmx4g -XX:NewSize= -XX:MaxNewSize= &quot;</span></span><br><span class="line"></span><br><span class="line">-server：服务器模式，VM运行在server模式，为在服务器端最大化程序运行速度而优化</span><br><span class="line">-Xms：堆内存初始化大小</span><br><span class="line">-Xmx：堆内存空间上限</span><br><span class="line">-XX:NewSize=：新生代空间初始化大小</span><br><span class="line">-XX:MaxNewSize=：新生代空间最大值</span><br></pre></td></tr></table></figure>

<p>生产案例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /usr/local/tomcat/bin/catalina.sh</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms4g -Xmx4g -Xss512k -Xmn1g -</span></span><br><span class="line"><span class="string">XX:CMSInitiatingOccupancyFraction=65 -XX:+AggressiveOpts -XX:+UseBiasedLocking -</span></span><br><span class="line"><span class="string">XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewRatio=2 -</span></span><br><span class="line"><span class="string">XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -</span></span><br><span class="line"><span class="string">XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -</span></span><br><span class="line"><span class="string">XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -</span></span><br><span class="line"><span class="string">XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods&quot;</span></span><br></pre></td></tr></table></figure>

<p>一台 tomcat 服务器并发连接数不高，生产建议分配物理内存通常 4G 到 8G 较多，如果需要更多连接，一般会利用虚拟化技术实现多台 tomcat</p>
<h4 id="线程池调整"><a href="#线程池调整" class="headerlink" title="线程池调整"></a>线程池调整</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">......</span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span> connectionTimeout=<span class="string">&quot;20000&quot;</span></span><br><span class="line">redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>常用属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">connectionTimeout  <span class="comment"># 连接超时时长,单位ms</span></span><br><span class="line">maxThreads    <span class="comment"># 最大线程数，默认200</span></span><br><span class="line">minSpareThreads   <span class="comment"># 最小空闲线程数</span></span><br><span class="line">maxSpareThreads   <span class="comment"># 最大空闲线程数</span></span><br><span class="line">acceptCount    <span class="comment"># 当启动线程满了之后，等待队列的最大长度，默认100</span></span><br><span class="line">URIEncoding    <span class="comment"># URI 地址编码格式，建议使用 UTF-8</span></span><br><span class="line">enableLookups   <span class="comment"># 是否启用客户端主机名的DNS反向解析，缺省禁用，建议禁用，就使用客户端IP就行</span></span><br><span class="line">compression    <span class="comment"># 是否启用传输压缩机制，建议 &quot;on&quot;，CPU和流量的平衡</span></span><br><span class="line"> compressionMinSize		<span class="comment"># 启用压缩传输的数据流最小值，单位是字节</span></span><br><span class="line"> compressableMimeType 	<span class="comment"># 定义启用压缩功能的 MIME 类型text/html、text/css、text/javascript</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="//img.lujinkai.cn/blog/ljk/1607160536339.png" alt="像方便面一样的男子 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="//img.lujinkai.cn/blog/ljk/1607160019009.png" alt="像方便面一样的男子 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Tomcat/" rel="tag"><i class="fa fa-tag"></i> Tomcat</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/ANSIBLE/jinja2/" rel="prev" title="jinja2">
                  <i class="fa fa-chevron-left"></i> jinja2
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/PHP/%E6%BA%90%E7%A0%81/%E5%85%A8%E6%96%B9%E4%BD%8D%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90PHP7%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81/" rel="next" title="全方位深度剖析PHP7底层源码">
                  全方位深度剖析PHP7底层源码 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.lujinkai.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.lujinkai.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.lujinkai.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.lujinkai.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
