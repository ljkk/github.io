<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.to2b.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.to2b.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="配套 B 站教程：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1Be4y167n9 Elastic Stack 在企业的常见架构 Elastic Stack 分布式⽇志系统概述 集群基础环境初始化1.准备虚拟机   IP 地址 主机名 CPU 配置 内存配置 磁盘配置 角色说明    10.0.0.101 elk101.oldboyedu.com 2 core 4G 20G+">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK">
<meta property="og:url" content="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/ELK/Elastic/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:description" content="配套 B 站教程：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1Be4y167n9 Elastic Stack 在企业的常见架构 Elastic Stack 分布式⽇志系统概述 集群基础环境初始化1.准备虚拟机   IP 地址 主机名 CPU 配置 内存配置 磁盘配置 角色说明    10.0.0.101 elk101.oldboyedu.com 2 core 4G 20G+">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667283447322.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667283566667.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667284700478.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667287595368.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667288224966.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667397337884.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667397348947.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667397358476.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667397369443.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667398812569.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667399463086.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667399789647.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667399903071.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667400112207.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667400209038.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667400316902.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667400376710.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667400682356.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667401251531.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667401452697.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667401700078.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667401967834.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667402745944.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667403026999.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667403459392.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667405121451.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407132063.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407161985.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407232833.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407385838.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407440342.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407492998.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407565612.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407613789.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407635559.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407713319.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667407777709.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667408129949.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667408158533.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667408245132.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667408384164.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667408419501.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667408466932.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667408482877.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667409049243.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667447917074.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667448439377.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667450229695.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667457339777.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667457504851.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667457540842.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667457568386.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667458865578.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667458890281.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667458780145.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667458804018.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667458744466.png">
<meta property="og:image" content="http://img.to2b.cn/blog/lujinkai/1667458716770.png">
<meta property="article:published_time" content="2021-03-03T00:30:51.000Z">
<meta property="article:modified_time" content="2023-05-29T08:58:05.490Z">
<meta property="article:author" content="像方便面一样的男子">
<meta property="article:tag" content="ELK">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.to2b.cn/blog/lujinkai/1667283447322.png">


<link rel="canonical" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/ELK/Elastic/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/ELK/Elastic/","path":"运维/ELK/Elastic/","title":"ELK"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ELK | LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LJKのBlog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Elastic-Stack-%E5%9C%A8%E4%BC%81%E4%B8%9A%E7%9A%84%E5%B8%B8%E8%A7%81%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">Elastic Stack 在企业的常见架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Elastic-Stack-%E5%88%86%E5%B8%83%E5%BC%8F%E2%BD%87%E5%BF%97%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">Elastic Stack 分布式⽇志系统概述</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">集群基础环境初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%87%86%E5%A4%87%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">2.1.</span> <span class="nav-text">1.准备虚拟机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BF%AE%E6%94%B9%E8%BD%AF%E4%BB%B6%E6%BA%90"><span class="nav-number">2.2.</span> <span class="nav-text">2.修改软件源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BF%AE%E6%94%B9%E7%BB%88%E7%AB%AF%E9%A2%9C%E8%89%B2"><span class="nav-number">2.3.</span> <span class="nav-text">3.修改终端颜色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%BF%AE%E6%94%B9-sshd-%E6%9C%8D%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="nav-number">2.4.</span> <span class="nav-text">4.修改 sshd 服务优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%85%B3%E9%97%AD%E9%98%B2%E2%BD%95%E5%A2%99"><span class="nav-number">2.5.</span> <span class="nav-text">5.关闭防⽕墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%A6%81%E2%BD%A4-selinux"><span class="nav-number">2.6.</span> <span class="nav-text">6.禁⽤ selinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E5%8F%8A%E5%90%8C%E6%AD%A5%E8%84%9A%E6%9C%AC"><span class="nav-number">2.7.</span> <span class="nav-text">7.配置集群免密登录及同步脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E9%9B%86%E7%BE%A4%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="nav-number">2.8.</span> <span class="nav-text">8.集群时间同步</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-%E5%8D%95%E7%82%B9%E9%83%A8%E7%BD%B2"><span class="nav-number">3.</span> <span class="nav-text">Elasticsearch 单点部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%8B%E8%BD%BD"><span class="nav-number">3.1.</span> <span class="nav-text">1.下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%8D%95%E7%82%B9%E9%83%A8%E7%BD%B2-elasticsearch"><span class="nav-number">3.2.</span> <span class="nav-text">2.单点部署 elasticsearch</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">4.</span> <span class="nav-text">Elasticsearch 分布式集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-elk101-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">4.1.</span> <span class="nav-text">1.elk101 修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE%E2%BD%82%E4%BB%B6%E5%88%B0%E9%9B%86%E7%BE%A4%E7%9A%84%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9"><span class="nav-number">4.2.</span> <span class="nav-text">2.同步配置⽂件到集群的其他节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%88%A0%E9%99%A4%E4%B9%8B%E5%89%8D%E7%9A%84%E4%B8%B4%E6%97%B6%E6%95%B0%E6%8D%AE"><span class="nav-number">4.3.</span> <span class="nav-text">3.所有节点删除之前的临时数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.4.</span> <span class="nav-text">4.所有节点启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8"><span class="nav-number">4.5.</span> <span class="nav-text">5.验证集群是否正常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kibana-%E6%9C%8D%E5%8A%A1"><span class="nav-number">5.</span> <span class="nav-text">部署 kibana 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85-kibana"><span class="nav-number">5.1.</span> <span class="nav-text">1.本地安装 kibana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BF%AE%E6%94%B9-kibana-%E7%9A%84%E9%85%8D%E7%BD%AE%E2%BD%82%E4%BB%B6"><span class="nav-number">5.2.</span> <span class="nav-text">2.修改 kibana 的配置⽂件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%90%AF%E5%8A%A8-kibana-%E6%9C%8D%E5%8A%A1"><span class="nav-number">5.3.</span> <span class="nav-text">3.启动 kibana 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%AE%BF%E9%97%AE-kibana-%E7%9A%84-webUI"><span class="nav-number">5.4.</span> <span class="nav-text">4.访问 kibana 的 webUI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat-%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">filebeat 部署及基础使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%83%A8%E7%BD%B2-filebeat-%E7%8E%AF%E5%A2%83"><span class="nav-number">6.1.</span> <span class="nav-text">1.部署 filebeat 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95"><span class="nav-number">6.2.</span> <span class="nav-text">2.简单测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">6.2.1.</span> <span class="nav-text">2.1 编写配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E8%BF%90%E8%A1%8C-filebeat-%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.2.2.</span> <span class="nav-text">2.2 运行 filebeat 实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-%E6%B5%8B%E8%AF%95"><span class="nav-number">6.2.3.</span> <span class="nav-text">2.3 测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-input-%E7%9A%84-log-%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.3.</span> <span class="nav-text">3.input 的 log 类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-input-%E7%9A%84%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A1%88%E4%BE%8B"><span class="nav-number">6.4.</span> <span class="nav-text">4.input 的通配符案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-input-%E7%9A%84%E9%80%9A%E7%94%A8%E5%AD%97%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="nav-number">6.5.</span> <span class="nav-text">5.input 的通用字段案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%97%A5%E5%BF%97%E8%BF%87%E6%BB%A4%E6%A1%88%E4%BE%8B"><span class="nav-number">6.6.</span> <span class="nav-text">6.日志过滤案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%B0%86%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5-es-%E6%A1%88%E4%BE%8B"><span class="nav-number">6.7.</span> <span class="nav-text">7.将数据写入 es 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E8%87%AA%E5%AE%9A%E4%B9%89-es-%E7%B4%A2%E5%BC%95%E5%90%8D%E7%A7%B0"><span class="nav-number">6.8.</span> <span class="nav-text">8.自定义 es 索引名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E5%A4%9A%E4%B8%AA%E7%B4%A2%E5%BC%95%E5%86%99%E5%85%A5%E6%A1%88%E4%BE%8B"><span class="nav-number">6.9.</span> <span class="nav-text">9.多个索引写入案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E7%89%87%E5%92%8C%E5%89%AF%E6%9C%AC%E6%A1%88%E4%BE%8B"><span class="nav-number">6.10.</span> <span class="nav-text">10.自定义分片和副本案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-filebeat-%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E5%88%B0%E6%9C%AC%E5%9C%B0"><span class="nav-number">6.11.</span> <span class="nav-text">11.filebeat 实现日志聚合到本地</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-filebeat-%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E5%88%B0-ES-%E9%9B%86%E7%BE%A4"><span class="nav-number">6.12.</span> <span class="nav-text">12.filebeat 实现日志聚合到 ES 集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EFK-%E6%9E%B6%E6%9E%84%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="nav-number">7.</span> <span class="nav-text">EFK 架构企业级实战案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%83%A8%E7%BD%B2-nginx-%E6%9C%8D%E5%8A%A1"><span class="nav-number">7.1.</span> <span class="nav-text">1.部署 nginx 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9F%BA%E4%BA%8E-log-%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86-nginx-%E5%8E%9F%E7%94%9F%E6%97%A5%E5%BF%97"><span class="nav-number">7.2.</span> <span class="nav-text">2.基于 log 类型收集 nginx 原生日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%9F%BA%E4%BA%8E-log-%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86-nginx-%E7%9A%84-json-%E6%97%A5%E5%BF%97"><span class="nav-number">7.3.</span> <span class="nav-text">3.基于 log 类型收集 nginx 的 json 日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%9F%BA%E4%BA%8E-modules-%E9%87%87%E9%9B%86-nginx-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="nav-number">7.4.</span> <span class="nav-text">4.基于 modules 采集 nginx 日志文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">7.4.1.</span> <span class="nav-text">模块的基本使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filebeat-%E9%85%8D%E7%BD%AE%E2%BD%82%E4%BB%B6%EF%BC%88%E9%9C%80%E8%A6%81%E5%90%AF%E2%BD%A4-nginx-%E6%A8%A1%E5%9D%97%EF%BC%89"><span class="nav-number">7.4.2.</span> <span class="nav-text">filebeat 配置⽂件（需要启⽤ nginx 模块）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%9F%BA%E4%BA%8E-modules-%E9%87%87%E9%9B%86-tomcat-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="nav-number">7.5.</span> <span class="nav-text">5.基于 modules 采集 tomcat 日志文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%9F%BA%E4%BA%8E-log-%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86-tomcat-%E7%9A%84%E5%8E%9F%E7%94%9F%E6%97%A5%E5%BF%97"><span class="nav-number">7.6.</span> <span class="nav-text">6.基于 log 类型收集 tomcat 的原生日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%9F%BA%E4%BA%8E-log-%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86-tomcat-%E7%9A%84-json-%E6%97%A5%E5%BF%97"><span class="nav-number">7.7.</span> <span class="nav-text">7.基于 log 类型收集 tomcat 的 json 日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%A4%9A%E2%BE%8F%E5%8C%B9%E9%85%8D-%E6%94%B6%E9%9B%86-tomcat-%E7%9A%84%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-number">7.8.</span> <span class="nav-text">8.多⾏匹配-收集 tomcat 的错误日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E5%A4%9A%E2%BE%8F%E5%8C%B9%E9%85%8D-%E6%94%B6%E9%9B%86-elasticsearch-%E7%9A%84%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-number">7.9.</span> <span class="nav-text">9.多⾏匹配-收集 elasticsearch 的错误日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-nginx-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E8%BF%87%E6%BB%A4"><span class="nav-number">7.10.</span> <span class="nav-text">10.nginx 错误日志过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-nginx-%E5%92%8C-tomcat-%E5%90%8C%E6%97%B6%E9%87%87%E9%9B%86%E6%A1%88%E4%BE%8B"><span class="nav-number">7.11.</span> <span class="nav-text">11.nginx 和 tomcat 同时采集案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-log-%E7%B1%BB%E5%9E%8B%E5%88%87%E6%8D%A2-filestream-%E7%B1%BB%E5%9E%8B%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">7.12.</span> <span class="nav-text">12.log 类型切换 filestream 类型注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-1-filestream-%E7%B1%BB%E5%9E%8B-json-%E8%A7%A3%E6%9E%90%E9%85%8D%E7%BD%AE"><span class="nav-number">7.12.1.</span> <span class="nav-text">12.1.filestream 类型 json 解析配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-2-filestream-%E7%B1%BB%E5%9E%8B%E5%A4%9A%E8%A1%8C%E5%8C%B9%E9%85%8D"><span class="nav-number">7.12.2.</span> <span class="nav-text">12.2.filestream 类型多行匹配</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E5%88%B0-redis-%E6%9C%8D%E5%8A%A1"><span class="nav-number">7.13.</span> <span class="nav-text">13.收集日志到 redis 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-1-%E9%83%A8%E7%BD%B2-redis"><span class="nav-number">7.13.1.</span> <span class="nav-text">13.1.部署 redis</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E2%BD%82%E4%BB%B6"><span class="nav-number">7.13.2.</span> <span class="nav-text">13.2.修改配置⽂件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-%E5%90%AF%E5%8A%A8-redis-%E6%9C%8D%E5%8A%A1"><span class="nav-number">7.13.3.</span> <span class="nav-text">13.3.启动 redis 服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-4-%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95-redis-%E7%8E%AF%E5%A2%83"><span class="nav-number">7.13.4.</span> <span class="nav-text">13.4.其他节点连接测试 redis 环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-5-%E5%B0%86-filebeat-%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E5%88%B0-redis-%E7%8E%AF%E5%A2%83"><span class="nav-number">7.13.5.</span> <span class="nav-text">13.5.将 filebeat 数据写入到 redis 环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-6-%E6%B5%8B%E8%AF%95%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-number">7.13.6.</span> <span class="nav-text">13.6.测试写入数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-%E4%BB%8A%E6%97%A5%E4%BD%9C%E4%B8%9A"><span class="nav-number">7.14.</span> <span class="nav-text">14.今日作业</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%BD%85%E6%A1%88%E2%BC%80%EF%BC%9Afilebeat-%E5%A4%9A%E5%AE%9E%E4%BE%8B"><span class="nav-number">7.14.1.</span> <span class="nav-text">⽅案⼀：filebeat 多实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E5%9F%BA%E4%BA%8E-rsyslog-%E6%A1%88%E4%BE%8B"><span class="nav-number">7.14.2.</span> <span class="nav-text">方案二：基于 rsyslog 案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-logstash-%E7%8E%AF%E5%A2%83%E5%8F%8A%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="nav-number">8.</span> <span class="nav-text">部署 logstash 环境及基础使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%83%A8%E7%BD%B2-logstash-%E7%8E%AF%E5%A2%83"><span class="nav-number">8.1.</span> <span class="nav-text">1.部署 logstash 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BF%AE%E6%94%B9-logstash-%E7%9A%84%E9%85%8D%E7%BD%AE%E2%BD%82%E4%BB%B6"><span class="nav-number">8.2.</span> <span class="nav-text">2.修改 logstash 的配置⽂件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-input-%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E-file-%E6%A1%88%E4%BE%8B"><span class="nav-number">8.3.</span> <span class="nav-text">3.input 插件基于 file 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-input-%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E-tcp-%E6%A1%88%E4%BE%8B"><span class="nav-number">8.4.</span> <span class="nav-text">4.input 插件基于 tcp 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-input-%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E-http-%E6%A1%88%E4%BE%8B"><span class="nav-number">8.5.</span> <span class="nav-text">5.input 插件基于 http 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-input-%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E-redis-%E6%A1%88%E4%BE%8B"><span class="nav-number">8.6.</span> <span class="nav-text">6.input 插件基于 redis 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-input-%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E-beats-%E6%A1%88%E4%BE%8B"><span class="nav-number">8.7.</span> <span class="nav-text">7.input 插件基于 beats 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-output-%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E-redis-%E6%A1%88%E4%BE%8B"><span class="nav-number">8.8.</span> <span class="nav-text">8.output 插件基于 redis 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-output-%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E-file-%E6%A1%88%E4%BE%8B"><span class="nav-number">8.9.</span> <span class="nav-text">9.output 插件基于 file 案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-logstash-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="nav-number">8.10.</span> <span class="nav-text">10.logstash 综合案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-%E4%BB%8A%E6%97%A5%E4%BD%9C%E4%B8%9A"><span class="nav-number">8.11.</span> <span class="nav-text">11.今日作业</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA-logsash-%E7%89%88%E6%9C%AC"><span class="nav-number">8.11.1.</span> <span class="nav-text">11.1 运行一个 logsash 版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-2-%E8%BF%90%E8%A1%8C%E4%B8%A4%E4%B8%AA-logstash-%E7%89%88%E6%9C%AC"><span class="nav-number">8.11.2.</span> <span class="nav-text">11.2.运行两个 logstash 版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#logstash-%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%8F%92%E4%BB%B6%E6%A1%88%E4%BE%8B-ELFK-%E6%9E%B6%E6%9E%84"><span class="nav-number">9.</span> <span class="nav-text">logstash 企业级插件案例(ELFK 架构)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-gork-%E6%8F%92%E4%BB%B6%E6%A6%82%E8%BF%B0"><span class="nav-number">9.1.</span> <span class="nav-text">1.gork 插件概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BD%BF%E2%BD%A4-grok-%E5%86%85%E7%BD%AE%E7%9A%84%E6%AD%A3%E5%88%99%E6%A1%88%E4%BE%8B-1"><span class="nav-number">9.2.</span> <span class="nav-text">2.使⽤ grok 内置的正则案例 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8-grok-%E5%86%85%E7%BD%AE%E7%9A%84%E6%AD%A3%E5%88%99%E6%A1%88%E4%BE%8B-2"><span class="nav-number">9.3.</span> <span class="nav-text">3.使用 grok 内置的正则案例 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E4%BD%BF%E7%94%A8-grop-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%AD%A3%E5%88%99%E6%A1%88%E4%BE%8B"><span class="nav-number">9.4.</span> <span class="nav-text">4.使用 grop 自定义的正则案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-filter-%E6%8F%92%E4%BB%B6%E9%80%9A%E7%94%A8%E5%AD%97%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="nav-number">9.5.</span> <span class="nav-text">5.filter 插件通用字段案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-date-%E6%8F%92%E4%BB%B6%E4%BF%AE%E6%94%B9%E5%86%99%E5%85%A5-ES-%E7%9A%84%E6%97%B6%E9%97%B4"><span class="nav-number">9.6.</span> <span class="nav-text">6.date 插件修改写入 ES 的时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-geoip-%E5%88%86%E6%9E%90%E6%BA%90%E5%9C%B0%E5%9D%80%E7%9A%84%E5%9C%B0%E5%9D%80%E4%BD%8D%E7%BD%AE"><span class="nav-number">9.7.</span> <span class="nav-text">7.geoip 分析源地址的地址位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-useragent-%E5%88%86%E6%9E%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E8%AE%BE%E5%A4%87%E7%B1%BB%E5%9E%8B"><span class="nav-number">9.8.</span> <span class="nav-text">8.useragent 分析客户端的设备类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-mutate-%E7%BB%84%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87-python-%E8%84%9A%E6%9C%AC"><span class="nav-number">9.9.</span> <span class="nav-text">9.mutate 组件数据准备-python 脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-mutate-%E7%BB%84%E4%BB%B6%E5%B8%B8%E2%BD%A4%E5%AD%97%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="nav-number">9.10.</span> <span class="nav-text">9.mutate 组件常⽤字段案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-logstash-%E7%9A%84%E5%A4%9A-if-%E5%88%86%E6%94%AF%E6%A1%88%E4%BE%8B"><span class="nav-number">9.11.</span> <span class="nav-text">10.logstash 的多 if 分支案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-%E4%BB%8A%E6%97%A5%E4%BD%9C%E4%B8%9A-1"><span class="nav-number">9.12.</span> <span class="nav-text">11.今日作业</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#filebeat-%E6%89%8B%E6%9C%BA-tomcat-%E6%97%A5%E5%BF%97"><span class="nav-number">9.12.1.</span> <span class="nav-text">filebeat 手机 tomcat 日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filebeat-%E6%94%B6%E9%9B%86-nginx-%E6%97%A5%E5%BF%97"><span class="nav-number">9.12.2.</span> <span class="nav-text">filebeat 收集 nginx 日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filebeat-%E6%94%B6%E9%9B%86-apps-%E6%97%A5%E5%BF%97"><span class="nav-number">9.12.3.</span> <span class="nav-text">filebeat 收集 apps 日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#logstash-%E6%94%B6%E9%9B%86-nginx-%E6%97%A5%E5%BF%97"><span class="nav-number">9.12.4.</span> <span class="nav-text">logstash 收集 nginx 日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#logstash-%E6%94%B6%E9%9B%86-tomcat-%E6%97%A5%E5%BF%97"><span class="nav-number">9.12.5.</span> <span class="nav-text">logstash 收集 tomcat 日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#logstash-%E6%94%B6%E9%9B%86-apps-%E6%97%A5%E5%BF%97"><span class="nav-number">9.12.6.</span> <span class="nav-text">logstash 收集 apps 日志</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kibana-%E8%87%AA%E5%AE%9A%E4%B9%89-dashboard-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="nav-number">10.</span> <span class="nav-text">kibana 自定义 dashboard 实战案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%BB%9F%E8%AE%A1-pv%EF%BC%88%E6%8C%87%E6%A0%87%EF%BC%89"><span class="nav-number">10.1.</span> <span class="nav-text">1.统计 pv（指标）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BB%9F%E8%AE%A1%E5%AE%A2%E6%88%B7%E7%AB%AF-IP%EF%BC%88%E6%8C%87%E6%A0%87%EF%BC%89"><span class="nav-number">10.2.</span> <span class="nav-text">2.统计客户端 IP（指标）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%BB%9F%E8%AE%A1-web-%E4%B8%8B%E8%BD%BD%E5%B8%A6%E5%AE%BD%EF%BC%88%E6%8C%87%E6%A0%87%EF%BC%89"><span class="nav-number">10.3.</span> <span class="nav-text">3.统计 web 下载带宽（指标）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%AE%BF%E9%97%AE%E9%A1%B5%E9%9D%A2%E7%BB%9F%E8%AE%A1%EF%BC%88%E6%B0%B4%E5%B9%B3%E6%9D%A1%E5%BD%A2%E5%9B%BE%EF%BC%89"><span class="nav-number">10.4.</span> <span class="nav-text">4.访问页面统计（水平条形图）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%88%86%E6%9E%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%9F%8E%E5%B8%82%E5%88%86%E5%B8%83%EF%BC%88%E5%9E%82%E7%9B%B4%E6%9D%A1%E5%BD%A2%E5%9B%BE%EF%BC%89"><span class="nav-number">10.5.</span> <span class="nav-text">5.分析客户端的城市分布（垂直条形图）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%9F%8E%E5%B8%82%E5%88%86%E5%B8%83%E7%99%BE%E5%88%86%E6%AF%94%EF%BC%88%E9%A5%BC%E5%9B%BE%EF%BC%89"><span class="nav-number">10.6.</span> <span class="nav-text">6.城市分布百分比（饼图）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-IP-%E7%9A%84-TopN-%E7%BB%9F%E8%AE%A1%EF%BC%88%E4%BB%AA%E8%A1%A8%E7%9B%98%EF%BC%89"><span class="nav-number">10.7.</span> <span class="nav-text">7.IP 的 TopN 统计（仪表盘）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E8%87%AA%E5%AE%9A%E4%B9%89-dashboard"><span class="nav-number">10.8.</span> <span class="nav-text">8.自定义 dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ElasticStack-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E5%8F%8A%E6%8E%92%E9%94%99"><span class="nav-number">11.</span> <span class="nav-text">ElasticStack 二进制部署及排错</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%83%A8%E7%BD%B2-Oracle-JDK-%E7%8E%AF%E5%A2%83"><span class="nav-number">11.1.</span> <span class="nav-text">1.部署 Oracle JDK 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%8D%95%E8%8A%82%E7%82%B9-ES-%E9%83%A8%E7%BD%B2"><span class="nav-number">11.2.</span> <span class="nav-text">2.单节点 ES 部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BF%AE%E6%94%B9-ES-%E7%9A%84%E5%A0%86%EF%BC%88heap%EF%BC%89%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="nav-number">11.3.</span> <span class="nav-text">3.修改 ES 的堆（heap）内存大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ES-%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99"><span class="nav-number">11.4.</span> <span class="nav-text">4.ES 启动脚本编写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E9%83%A8%E7%BD%B2-ES-%E9%9B%86%E7%BE%A4"><span class="nav-number">11.5.</span> <span class="nav-text">5.部署 ES 集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E9%83%A8%E7%BD%B2-kibana-%E6%9C%8D%E5%8A%A1"><span class="nav-number">11.6.</span> <span class="nav-text">6.部署 kibana 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E9%83%A8%E7%BD%B2-logstash"><span class="nav-number">11.7.</span> <span class="nav-text">7.部署 logstash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E9%83%A8%E7%BD%B2-filebeat"><span class="nav-number">11.8.</span> <span class="nav-text">7.部署 filebeat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E9%83%A8%E7%BD%B2-es-head-%E6%8F%92%E4%BB%B6"><span class="nav-number">11.9.</span> <span class="nav-text">8.部署 es-head 插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E9%83%A8%E7%BD%B2-postman-%E7%BB%84%E4%BB%B6"><span class="nav-number">11.10.</span> <span class="nav-text">9.部署 postman 组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E4%BB%8A%E2%BD%87%E4%BD%9C%E4%B8%9A"><span class="nav-number">11.11.</span> <span class="nav-text">10.今⽇作业</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ElasticSearch-%E7%9A%84-Restful-%E9%A3%8E%E6%A0%BC-API-%E5%AE%9E%E6%88%98"><span class="nav-number">12.</span> <span class="nav-text">ElasticSearch 的 Restful 风格 API 实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Restful-%E5%8F%8A-JSON-%E6%A0%BC%E5%BC%8F"><span class="nav-number">12.1.</span> <span class="nav-text">1.Restful 及 JSON 格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ElasticSearch-%E7%9A%84%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD"><span class="nav-number">12.2.</span> <span class="nav-text">2.ElasticSearch 的相关术语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%AE%A1%E7%90%86%E7%B4%A2%E5%BC%95%E7%9A%84-API"><span class="nav-number">12.3.</span> <span class="nav-text">3.管理索引的 API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E4%BF%A1%E6%81%AF"><span class="nav-number">12.3.1.</span> <span class="nav-text">3.1 查看索引信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">12.3.2.</span> <span class="nav-text">3.2 创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95"><span class="nav-number">12.3.3.</span> <span class="nav-text">3.3 修改索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">12.3.4.</span> <span class="nav-text">3.4 删除索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-%E7%B4%A2%E5%BC%95%E5%88%AB%E5%90%8D"><span class="nav-number">12.3.5.</span> <span class="nav-text">3.5 索引别名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-%E7%B4%A2%E5%BC%95%E5%85%B3%E9%97%AD"><span class="nav-number">12.3.6.</span> <span class="nav-text">3.6 索引关闭</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-7-%E7%B4%A2%E5%BC%95%E6%89%93%E5%BC%80"><span class="nav-number">12.3.7.</span> <span class="nav-text">3.7 索引打开</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="nav-number">12.3.8.</span> <span class="nav-text">3.8 索引的其他操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%AE%A1%E7%90%86%E6%96%87%E6%A1%A3%E7%9A%84-API"><span class="nav-number">12.4.</span> <span class="nav-text">4.管理文档的 API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-%E6%96%87%E6%A1%A3%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">12.4.1.</span> <span class="nav-text">4.1 文档的创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-%E6%96%87%E6%A1%A3%E7%9A%84%E6%9F%A5%E7%9C%8B"><span class="nav-number">12.4.2.</span> <span class="nav-text">4.2 文档的查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-%E6%96%87%E6%A1%A3%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-number">12.4.3.</span> <span class="nav-text">4.3 文档的修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-%E6%96%87%E6%A1%A3%E7%9A%84%E5%88%A0%E9%99%A4"><span class="nav-number">12.4.4.</span> <span class="nav-text">4.4 文档的删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-%E6%96%87%E6%A1%A3%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-number">12.4.5.</span> <span class="nav-text">4.5 文档的批量操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-6-%E8%AF%BE%E5%A0%82%E7%9A%84%E7%BB%83%E4%B9%A0"><span class="nav-number">12.4.6.</span> <span class="nav-text">4.6 课堂的练习</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E4%BD%BF%E7%94%A8%E6%98%A0%E5%B0%84%EF%BC%88mapping%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">12.5.</span> <span class="nav-text">5.使用映射（mapping）自定义数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-%E6%98%A0%E5%B0%84%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">12.5.1.</span> <span class="nav-text">5.1 映射的数据类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-IP-%E6%A1%88%E4%BE%8B"><span class="nav-number">12.5.2.</span> <span class="nav-text">5.2 IP 案例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E7%B1%BB%E5%9E%8B%E6%A1%88%E4%BE%8B"><span class="nav-number">12.5.3.</span> <span class="nav-text">5.3 其他类型类型案例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-IK-%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">12.6.</span> <span class="nav-text">6. IK 中文分词器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-%E5%86%85%E7%BD%AE%E7%9A%84%E6%A0%87%E5%87%86%E5%88%86%E8%AF%8D%E5%99%A8-%E5%88%86%E6%9E%90%E8%8B%B1%E6%96%87"><span class="nav-number">12.6.1.</span> <span class="nav-text">6.1 内置的标准分词器 - 分析英文</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-%E5%86%85%E7%BD%AE%E7%9A%84%E6%A0%87%E5%87%86%E5%88%86%E8%AF%8D%E5%99%A8-%E5%88%86%E6%9E%90%E4%B8%AD%E6%96%87%E5%B9%B6%E4%B8%8D%E5%8F%8B%E5%A5%BD"><span class="nav-number">12.6.2.</span> <span class="nav-text">6.2 内置的标准分词器 - 分析中文并不友好</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-%E5%AE%89%E8%A3%85-IK-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">12.6.3.</span> <span class="nav-text">6.3 安装 IK 分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-%E8%87%AA%E5%AE%9A%E4%B9%89-IK-%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E5%AD%97%E5%85%B8"><span class="nav-number">12.6.4.</span> <span class="nav-text">6.4 自定义 IK 分词器的字典</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8-%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF"><span class="nav-number">12.6.5.</span> <span class="nav-text">6.5 自定义分词器 - 了解即可</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E4%BB%8A%E6%97%A5%E4%BD%9C%E4%B8%9A"><span class="nav-number">12.7.</span> <span class="nav-text">7. 今日作业</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-shopping-json"><span class="nav-number">12.7.1.</span> <span class="nav-text">7.1 shopping.json</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-oldboyedu-linux80-json"><span class="nav-number">12.7.2.</span> <span class="nav-text">7.2 oldboyedu-linux80.json</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B-1"><span class="nav-number">12.7.2.1.</span> <span class="nav-text">参考案例 1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%A1%88%E4%BE%8B-2"><span class="nav-number">12.7.2.2.</span> <span class="nav-text">参考案例 2</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="nav-number">13.</span> <span class="nav-text">索引模板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="nav-number">13.1.</span> <span class="nav-text">1.什么是索引模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="nav-number">13.2.</span> <span class="nav-text">2.查看索引模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%9B%E5%BB%BA-x2F-%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="nav-number">13.3.</span> <span class="nav-text">3.创建&#x2F;修改索引模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="nav-number">13.4.</span> <span class="nav-text">4.删除索引模板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-%E7%9A%84-DSL-%E8%AF%AD%E5%8F%A5%E6%9F%A5%E8%AF%A2-DBA-%E6%96%B9%E5%90%91%E9%9C%80%E8%A6%81%E6%8E%8C%E6%8F%A1"><span class="nav-number">14.</span> <span class="nav-text">ES 的 DSL 语句查询 - DBA 方向需要掌握!</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-DSL"><span class="nav-number">14.1.</span> <span class="nav-text">1.什么是 DSL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2-match-%E6%9F%A5%E8%AF%A2"><span class="nav-number">14.2.</span> <span class="nav-text">2.全文检索 - match 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AE%8C%E5%85%A8%E5%8C%B9%E9%85%8D-match-phrase-%E6%9F%A5%E8%AF%A2"><span class="nav-number">14.3.</span> <span class="nav-text">3.完全匹配 - match_phrase 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%85%A8%E9%87%8F%E6%9F%A5%E8%AF%A2-match-all"><span class="nav-number">14.4.</span> <span class="nav-text">4.全量查询 - match_all</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-size-from"><span class="nav-number">14.5.</span> <span class="nav-text">5.分页查询 - size-from</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%9F%A5%E7%9C%8B%E2%80%9C-source%E2%80%9D%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5"><span class="nav-number">14.6.</span> <span class="nav-text">6.查看“_source”对象的指定字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%9F%A5%E8%AF%A2%E5%8C%85%E5%90%AB%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E7%9A%84%E6%96%87%E6%A1%A3-exists"><span class="nav-number">14.7.</span> <span class="nav-text">7.查询包含指定字段的文档 - exists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE-hightlight"><span class="nav-number">14.8.</span> <span class="nav-text">8.语法高亮 - hightlight</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E5%9F%BA%E4%BA%8E%E5%AD%97%E6%AE%B5%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F-sort"><span class="nav-number">14.9.</span> <span class="nav-text">9.基于字段进行排序 - sort</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2-bool"><span class="nav-number">14.10.</span> <span class="nav-text">10.多条件查询 - bool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2-filter"><span class="nav-number">14.11.</span> <span class="nav-text">11.范围查询 - filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D%E5%A4%9A%E4%B8%AA%E5%80%BC-terms"><span class="nav-number">14.12.</span> <span class="nav-text">12.精确匹配多个值 - terms</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-%E5%A4%9A%E8%AF%8D%E6%90%9C%E7%B4%A2-%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF"><span class="nav-number">14.13.</span> <span class="nav-text">13.多词搜索 - 了解即可</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-%E6%9D%83%E9%87%8D%E6%A1%88%E4%BE%8B-%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF"><span class="nav-number">14.14.</span> <span class="nav-text">14.权重案例 - 了解即可</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF"><span class="nav-number">14.15.</span> <span class="nav-text">15.聚合查询 - 了解即可</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-%E9%9B%86%E7%BE%A4%E8%BF%81%E7%A7%BB"><span class="nav-number">15.</span> <span class="nav-text">ES 集群迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%83%A8%E7%BD%B2-ES6-%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4"><span class="nav-number">15.1.</span> <span class="nav-text">1.部署 ES6 分布式集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9F%BA%E4%BA%8E-reindex-%E7%9A%84-API-%E8%BF%81%E7%A7%BB"><span class="nav-number">15.2.</span> <span class="nav-text">2.基于_reindex 的 API 迁移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%9F%BA%E4%BA%8E-logstash-%E5%AE%9E%E7%8E%B0%E7%B4%A2%E5%BC%95%E8%B7%A8%E9%9B%86%E7%BE%A4%E8%BF%81%E7%A7%BB"><span class="nav-number">15.3.</span> <span class="nav-text">3.基于 logstash 实现索引跨集群迁移</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-%E9%9B%86%E7%BE%A4%E5%B8%B8%E7%94%A8%E7%9A%84-API"><span class="nav-number">16.</span> <span class="nav-text">ES 集群常用的 API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-ES-%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81-API%EF%BC%88heath%EF%BC%89"><span class="nav-number">16.1.</span> <span class="nav-text">1.ES 集群健康状态 API（heath）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ES-%E9%9B%86%E7%BE%A4%E7%9A%84%E8%AE%BE%E7%BD%AE%E5%8F%8A%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%88settings%EF%BC%89"><span class="nav-number">16.2.</span> <span class="nav-text">2.ES 集群的设置及优先级（settings）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81-API%EF%BC%88state%EF%BC%89"><span class="nav-number">16.3.</span> <span class="nav-text">3.集群状态 API（state）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%9B%86%E7%BE%A4%E7%BB%9F%E8%AE%A1-API%EF%BC%88stats%EF%BC%89"><span class="nav-number">16.4.</span> <span class="nav-text">4.集群统计 API（stats）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%9A%84%E5%88%86%E7%89%87%E5%88%86%E9%85%8D%E6%83%85%E5%86%B5%EF%BC%88allocation%EF%BC%89"><span class="nav-number">16.5.</span> <span class="nav-text">5.查看集群的分片分配情况（allocation）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E9%9B%86%E7%BE%A4%E5%88%86%E7%89%87%E9%87%8D%E8%B7%AF%E7%94%B1-API%EF%BC%88reroute%EF%BC%89"><span class="nav-number">16.6.</span> <span class="nav-text">6.集群分片重路由 API（reroute）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E4%BB%8A%E6%97%A5%E4%BD%9C%E4%B8%9A-1"><span class="nav-number">16.7.</span> <span class="nav-text">7.今日作业</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-%E9%9B%86%E7%BE%A4%E7%90%86%E8%AE%BA%E7%AF%87"><span class="nav-number">17.</span> <span class="nav-text">ES 集群理论篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">17.1.</span> <span class="nav-text">1.倒排索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95-%E6%AD%A3%E5%90%91%E7%B4%A2%E5%BC%95"><span class="nav-number">17.1.1.</span> <span class="nav-text">正排索引(正向索引)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95-%E5%8F%8D%E5%90%91%E7%B4%A2%E5%BC%95"><span class="nav-number">17.1.2.</span> <span class="nav-text">倒排索引(反向索引)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="nav-number">17.2.</span> <span class="nav-text">2.集群角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%96%87%E6%A1%A3%E7%9A%84%E5%86%99%E6%B5%81%E7%A8%8B"><span class="nav-number">17.3.</span> <span class="nav-text">3.文档的写流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%8D%95%E4%B8%AA%E6%96%87%E6%A1%A3%E7%9A%84%E8%AF%BB%E6%B5%81%E7%A8%8B"><span class="nav-number">17.4.</span> <span class="nav-text">4.单个文档的读流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-ES-%E5%BA%95%E5%B1%82%E5%AD%98%E5%82%A8%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90"><span class="nav-number">17.5.</span> <span class="nav-text">5.ES 底层存储原理剖析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E4%B9%90%E8%A7%82%E9%94%81%E6%9C%BA%E5%88%B6-%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF"><span class="nav-number">17.6.</span> <span class="nav-text">6.乐观锁机制 - 了解即可</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#python-%E6%93%8D%E4%BD%9C-ES-%E9%9B%86%E7%BE%A4-API-%E5%AE%9E%E6%88%98"><span class="nav-number">18.</span> <span class="nav-text">python 操作 ES 集群 API 实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">18.1.</span> <span class="nav-text">1.创建索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%86%99%E2%BC%8A%E5%8D%95%E4%B8%AA%E2%BD%82%E6%A1%A3"><span class="nav-number">18.2.</span> <span class="nav-text">2.写⼊单个⽂档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%86%99%E5%85%A5%E5%A4%9A%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="nav-number">18.3.</span> <span class="nav-text">3.写入多个文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%85%A8%E9%87%8F%E6%9F%A5%E8%AF%A2"><span class="nav-number">18.4.</span> <span class="nav-text">4.全量查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9F%A5%E7%9C%8B%E5%A4%9A%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="nav-number">18.5.</span> <span class="nav-text">5.查看多个文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-DSL-%E6%9F%A5%E8%AF%A2"><span class="nav-number">18.6.</span> <span class="nav-text">6.DSL 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">18.7.</span> <span class="nav-text">7.查看索引是否存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="nav-number">18.8.</span> <span class="nav-text">8.修改文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E5%88%A0%E9%99%A4%E5%8D%95%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="nav-number">18.9.</span> <span class="nav-text">9.删除单个文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">18.10.</span> <span class="nav-text">10.删除索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-%E9%9B%86%E7%BE%A4%E5%8A%A0%E5%AF%86%E7%9A%84-Kibana-%E7%9A%84-RABC-%E5%AE%9E%E6%88%98"><span class="nav-number">19.</span> <span class="nav-text">ES 集群加密的 Kibana 的 RABC 实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E4%BA%8E-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%8E%A7%E5%88%B6-kibana"><span class="nav-number">19.1.</span> <span class="nav-text">1.基于 nginx 反向代理控制 kibana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%85%8D%E7%BD%AE-ES-%E9%9B%86%E7%BE%A4-TLS-%E8%AE%A4%E8%AF%81"><span class="nav-number">19.2.</span> <span class="nav-text">2.配置 ES 集群 TLS 认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-kibana-%E6%B7%BB%E5%8A%A0-ES-%E8%AE%A4%E8%AF%81"><span class="nav-number">19.3.</span> <span class="nav-text">3.kibana 添加 ES 认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-kibana-%E7%9A%84-RBAC"><span class="nav-number">19.4.</span> <span class="nav-text">4.kibana 的 RBAC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-logstash-%E5%86%99%E5%85%A5-ES-%E5%8A%A0%E5%AF%86%E9%9B%86%E7%BE%A4%E6%A1%88%E4%BE%8B"><span class="nav-number">19.5.</span> <span class="nav-text">5.logstash 写入 ES 加密集群案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-filebeat-%E5%86%99%E5%85%A5-ES-%E5%8A%A0%E5%AF%86%E9%9B%86%E7%BE%A4%E6%A1%88%E4%BE%8B"><span class="nav-number">19.6.</span> <span class="nav-text">6.filebeat 写入 ES 加密集群案例</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.to2b.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/ELK/Elastic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ELK | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ELK
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-03 08:30:51" itemprop="dateCreated datePublished" datetime="2021-03-03T08:30:51+08:00">2021-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>配套 B 站教程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Be4y167n9">https://www.bilibili.com/video/BV1Be4y167n9</a></p>
<h2 id="Elastic-Stack-在企业的常见架构"><a href="#Elastic-Stack-在企业的常见架构" class="headerlink" title="Elastic Stack 在企业的常见架构"></a>Elastic Stack 在企业的常见架构</h2><p><img data-src="//img.to2b.cn/blog/lujinkai/1667283447322.png"></p>
<h3 id="Elastic-Stack-分布式⽇志系统概述"><a href="#Elastic-Stack-分布式⽇志系统概述" class="headerlink" title="Elastic Stack 分布式⽇志系统概述"></a>Elastic Stack 分布式⽇志系统概述</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667283566667.png"></p>
<h2 id="集群基础环境初始化"><a href="#集群基础环境初始化" class="headerlink" title="集群基础环境初始化"></a>集群基础环境初始化</h2><h3 id="1-准备虚拟机"><a href="#1-准备虚拟机" class="headerlink" title="1.准备虚拟机"></a>1.准备虚拟机</h3><table>
<thead>
<tr>
<th>IP 地址</th>
<th>主机名</th>
<th>CPU 配置</th>
<th>内存配置</th>
<th>磁盘配置</th>
<th>角色说明</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>elk101.oldboyedu.com</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>elk102.oldboyedu.com</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>elk103.oldboyedu.com</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
</tbody></table>
<h3 id="2-修改软件源"><a href="#2-修改软件源" class="headerlink" title="2.修改软件源"></a>2.修改软件源</h3><p>参考链接：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/centos/">https://mirrors.tuna.tsinghua.edu.cn/help/centos/</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 对于 CentOS 7</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org|baseurl=https://mirrors.tuna.tsinghua.edu.cn|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo

<span class="token comment"># 对于 CentOS 8</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo</code></pre>

<h3 id="3-修改终端颜色"><a href="#3-修改终端颜色" class="headerlink" title="3.修改终端颜色"></a>3.修改终端颜色</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">>></span> ~/.bashrc</span>
PS1='[\[<span class="token entity" title="\e">\e</span>[34;1m\]\u@\[<span class="token entity" title="\e">\e</span>[0m\]\[<span class="token entity" title="\e">\e</span>[32;1m\]\H\[<span class="token entity" title="\e">\e</span>[0m\]\[<span class="token entity" title="\e">\e</span>[31;1m\] \W\[<span class="token entity" title="\e">\e</span>[0m\]]# '
EOF</span>
<span class="token builtin class-name">source</span> ~/.bashrc</code></pre>

<h3 id="4-修改-sshd-服务优化"><a href="#4-修改-sshd-服务优化" class="headerlink" title="4.修改 sshd 服务优化"></a>4.修改 sshd 服务优化</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s@^#UseDNS yes@UseDNS no@g'</span> /etc/ssh/sshd_config
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s#^GSSAPIAuthentication yes#GSSAPIAuthentication no#g'</span> /etc/ssh/sshd_config
<span class="token function">grep</span> ^UseDNS /etc/ssh/sshd_config
<span class="token function">grep</span> ^GSSAPIAuthentication /etc/ssh/sshd_config</code></pre>

<h3 id="5-关闭防⽕墙"><a href="#5-关闭防⽕墙" class="headerlink" title="5.关闭防⽕墙"></a>5.关闭防⽕墙</h3><pre class="language-bash" data-language="bash"><code class="language-bash">systemctl disable <span class="token parameter variable">--now</span> firewalld <span class="token operator">&amp;&amp;</span> systemctl is-enabled firewalld
systemctl status firewalld</code></pre>

<h3 id="6-禁⽤-selinux"><a href="#6-禁⽤-selinux" class="headerlink" title="6.禁⽤ selinux"></a>6.禁⽤ selinux</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s#(SELINUX=)enforcing#\1disabled#'</span> /etc/selinux/config
<span class="token function">grep</span> ^SELINUX<span class="token operator">=</span> /etc/selinux/config
setenforce <span class="token number">0</span>
getenforce</code></pre>

<h3 id="7-配置集群免密登录及同步脚本"><a href="#7-配置集群免密登录及同步脚本" class="headerlink" title="7.配置集群免密登录及同步脚本"></a>7.配置集群免密登录及同步脚本</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.修改主机列表</span>
<span class="token function">cat</span> <span class="token operator">>></span>/etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
10.0.0.101 elk101.oldboyedu.com
10.0.0.102 elk102.oldboyedu.com
10.0.0.103 elk103.oldboyedu.com
EOF</span>
<span class="token comment"># 2.elk101节点上⽣成密钥对</span>
ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-P</span> <span class="token string">''</span> <span class="token parameter variable">-f</span> ~/.ssh/id_rsa <span class="token parameter variable">-q</span>
<span class="token comment"># 3.elk101配置所有集群节点的免密登录</span>
<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>host_id <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span> host_id <span class="token operator">&lt;=</span> <span class="token number">103</span><span class="token punctuation">;</span> host_id<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  ssh-copy-id
  elk<span class="token variable">$&#123;host_id&#125;</span>.oldboyedu.com
<span class="token keyword">done</span>
<span class="token comment"># 4.链接测试</span>
<span class="token function">ssh</span> <span class="token string">'elk101.oldboyedu.com'</span>
<span class="token function">ssh</span> <span class="token string">'elk102.oldboyedu.com'</span>
<span class="token function">ssh</span> <span class="token string">'elk103.oldboyedu.com'</span>
<span class="token comment"># 5.所有节点安装rsync数据同步⼯具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">rsync</span>
<span class="token comment"># 6.编写同步脚本</span>
<span class="token function">vim</span> /usr/local/sbin/data_rsync.sh
<span class="token comment"># 将下⾯的内容拷⻉到该⽂件即可</span>
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># Auther: Jason Yin</span>
<span class="token keyword">if</span>
  <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> /path/to/file(绝对路径)"</span>
  <span class="token builtin class-name">exit</span>
<span class="token keyword">fi</span>
<span class="token comment"># 判断⽂件是否存在</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-e</span> <span class="token variable">$1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"[ <span class="token variable">$1</span> ] dir or file not find!"</span>
  <span class="token builtin class-name">exit</span>
<span class="token keyword">fi</span>
<span class="token comment"># 获取⽗路径</span>
<span class="token assign-left variable">fullpath</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> $1<span class="token variable">)</span></span>
<span class="token comment"># 获取⼦路径</span>
<span class="token assign-left variable">basename</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $1<span class="token variable">)</span></span>
<span class="token comment"># 进⼊到⽗路径</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$fullpath</span>
<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>host_id <span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span> host_id <span class="token operator">&lt;=</span> <span class="token number">103</span><span class="token punctuation">;</span> host_id<span class="token operator">++</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token comment"># 使得终端输出变为绿⾊</span>
  tput setaf <span class="token number">2</span>
  <span class="token builtin class-name">echo</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> rsyncing elk<span class="token variable">$&#123;host_id&#125;</span>.oldboyedu.com: <span class="token variable">$basename</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
  <span class="token comment"># 使得终端恢复原来的颜⾊</span>
  tput setaf <span class="token number">7</span>
  <span class="token comment"># 将数据同步到其他两个节点</span>
  <span class="token function">rsync</span> <span class="token parameter variable">-az</span> <span class="token variable">$basename</span>
  <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>@elk<span class="token variable">$&#123;host_id&#125;</span>.oldboyedu.com:<span class="token variable">$fullpath</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"命令执⾏成功!"</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>


<span class="token comment"># 7.给脚本授权</span>
<span class="token function">chmod</span> +x /usr/local/sbin/data_rsync.sh</code></pre>

<h3 id="8-集群时间同步"><a href="#8-集群时间同步" class="headerlink" title="8.集群时间同步"></a>8.集群时间同步</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.安装常⽤的Linux⼯具，您可以⾃定义哈。</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">vim</span> net-tools
<span class="token comment"># 2.安装chrony服务</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ntpdate chrony
<span class="token comment"># 3.修改chrony服务配置⽂件</span>
<span class="token function">vim</span> /etc/chrony.conf
<span class="token comment">#...</span>
<span class="token comment"># 注释官⽅的时间服务器，换成国内的时间服务器即可</span>
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst
server ntp2.aliyun.com iburst
server ntp3.aliyun.com iburst
server ntp4.aliyun.com iburst
server ntp5.aliyun.com iburst
<span class="token comment">#...</span>
<span class="token comment"># 4.配置chronyd的开机⾃启动</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> chronyd
systemctl restart chronyd
<span class="token comment"># 5.查看服务</span>
systemctl status chronyd</code></pre>

<h2 id="Elasticsearch-单点部署"><a href="#Elasticsearch-单点部署" class="headerlink" title="Elasticsearch 单点部署"></a>Elasticsearch 单点部署</h2><h3 id="1-下载"><a href="#1-下载" class="headerlink" title="1.下载"></a>1.下载</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<h3 id="2-单点部署-elasticsearch"><a href="#2-单点部署-elasticsearch" class="headerlink" title="2.单点部署 elasticsearch"></a>2.单点部署 elasticsearch</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.安装服务</span>
$ yum <span class="token parameter variable">-y</span> localinstal elasticsearch-7.17.3-x86_64.rpm
<span class="token comment"># 2.修改配置⽂件</span>
$ <span class="token function">egrep</span> <span class="token parameter variable">-v</span> <span class="token string">"^#|^$"</span> /etc/elasticsearch/elasticsearch.yml
cluster.name: oldboyedu-elk
node.name: oldboyedu-elk103
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: <span class="token number">10.0</span>.0.103
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>

<span class="token comment"># 相关参数说明:</span>
<span class="token comment"># cluster.name: 集群名称，若不指定，则默认是"elasticsearch",⽇志⽂件的前缀也是集群名称。</span>
<span class="token comment"># node.name: 指定节点的名称，可以⾃定义，推荐使⽤当前的主机名，要求集群唯⼀。</span>
<span class="token comment"># path.data: 数据路径。</span>
<span class="token comment"># path.logs: ⽇志路径</span>
<span class="token comment"># network.host: ES服务监听的IP地址</span>
<span class="token comment"># discovery.seed_hosts: 服务发现的主机列表，对于单点部署⽽⾔，主机列表和"network.host"字段配置相同即可。</span>

<span class="token comment"># 3.启动服务</span>
$ systemctl start elasticsearch.service</code></pre>

<h2 id="Elasticsearch-分布式集群部署"><a href="#Elasticsearch-分布式集群部署" class="headerlink" title="Elasticsearch 分布式集群部署"></a>Elasticsearch 分布式集群部署</h2><h3 id="1-elk101-修改配置文件"><a href="#1-elk101-修改配置文件" class="headerlink" title="1.elk101 修改配置文件"></a>1.elk101 修改配置文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">egrep</span> <span class="token parameter variable">-v</span> <span class="token string">"^$|^#"</span> /etc/elasticsearch/elasticsearch.yml
<span class="token punctuation">..</span>.
cluster.name: oldboyedu-elk
node.name: elk101
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: <span class="token number">0.0</span>.0.0
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"elk101"</span>,<span class="token string">"elk102"</span>,<span class="token string">"elk103"</span><span class="token punctuation">]</span>
cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"elk101"</span>,<span class="token string">"elk102"</span>,<span class="token string">"elk103"</span><span class="token punctuation">]</span>


<span class="token comment"># 温馨提示:</span>
<span class="token comment"># "node.name"各个节点配置要区分清楚，建议写对应的主机名称。</span></code></pre>

<h3 id="2-同步配置⽂件到集群的其他节点"><a href="#2-同步配置⽂件到集群的其他节点" class="headerlink" title="2.同步配置⽂件到集群的其他节点"></a>2.同步配置⽂件到集群的其他节点</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.elk101同步配置⽂件到集群的其他节点</span>
data_rsync.sh /etc/elasticsearch/elasticsearch.yml

<span class="token comment"># 2.elk102节点配置</span>
<span class="token function">vim</span> /etc/elasticsearch/elasticsearch.yml
<span class="token punctuation">..</span>.
node.name: elk102

<span class="token comment"># 3.elk103节点配置</span>
<span class="token function">vim</span> /etc/elasticsearch/elasticsearch.yml
<span class="token punctuation">..</span>.
node.name: elk103</code></pre>

<h3 id="3-所有节点删除之前的临时数据"><a href="#3-所有节点删除之前的临时数据" class="headerlink" title="3.所有节点删除之前的临时数据"></a>3.所有节点删除之前的临时数据</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">pkill</span> <span class="token function">java</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/<span class="token punctuation">&#123;</span>lib,log<span class="token punctuation">&#125;</span>/elasticsearch/* /tmp/*
ll /var/<span class="token punctuation">&#123;</span>lib,log<span class="token punctuation">&#125;</span>/elasticsearch/ /tmp/</code></pre>

<h3 id="4-所有节点启动服务"><a href="#4-所有节点启动服务" class="headerlink" title="4.所有节点启动服务"></a>4.所有节点启动服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.所有节点启动服务</span>
systemctl start elasticsearch

<span class="token comment"># 2.启动过程中建议查看⽇志</span>
<span class="token function">tail</span> <span class="token parameter variable">-100f</span> /var/log/elasticsearch/oldboyedu-elk.log</code></pre>

<h3 id="5-验证集群是否正常"><a href="#5-验证集群是否正常" class="headerlink" title="5.验证集群是否正常"></a>5.验证集群是否正常</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> elk103:9200/_cat/nodes?v</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667284700478.png"></p>
<h2 id="部署-kibana-服务"><a href="#部署-kibana-服务" class="headerlink" title="部署 kibana 服务"></a>部署 kibana 服务</h2><h3 id="1-本地安装-kibana"><a href="#1-本地安装-kibana" class="headerlink" title="1.本地安装 kibana"></a>1.本地安装 kibana</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> localinstall kibana-7.17.3-x86_64.rpm</code></pre>

<h3 id="2-修改-kibana-的配置⽂件"><a href="#2-修改-kibana-的配置⽂件" class="headerlink" title="2.修改 kibana 的配置⽂件"></a>2.修改 kibana 的配置⽂件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/kibana/kibana.yml
<span class="token punctuation">..</span>.
server.host: <span class="token string">"10.0.0.101"</span>
server.name: <span class="token string">"oldboyedu-kibana-server"</span>
elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
i18n.locale: <span class="token string">"zh-CN"</span></code></pre>

<h3 id="3-启动-kibana-服务"><a href="#3-启动-kibana-服务" class="headerlink" title="3.启动 kibana 服务"></a>3.启动 kibana 服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash">systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kibana
systemctl status kibana</code></pre>

<h3 id="4-访问-kibana-的-webUI"><a href="#4-访问-kibana-的-webUI" class="headerlink" title="4.访问 kibana 的 webUI"></a>4.访问 kibana 的 webUI</h3><p>略。。。</p>
<h2 id="filebeat-部署及基础使用"><a href="#filebeat-部署及基础使用" class="headerlink" title="filebeat 部署及基础使用"></a>filebeat 部署及基础使用</h2><pre class="language-bash" data-language="bash"><code class="language-bash">$ ./filebeat <span class="token parameter variable">--help</span>
Usage:
  filebeat <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
  filebeat <span class="token punctuation">[</span>command<span class="token punctuation">]</span>

Available Commands:
  <span class="token builtin class-name">export</span>      Export current config or index template
  generate    Generate Filebeat modules, filesets and fields.yml
  <span class="token builtin class-name">help</span>        Help about any <span class="token builtin class-name">command</span>
  keystore    Manage secrets keystore
  modules     Manage configured modules
  run         Run filebeat
  setup       Setup index template, dashboards and ML <span class="token function">jobs</span>
  <span class="token builtin class-name">test</span>        Test config
  version     Show current version info

Flags:
  -E, <span class="token parameter variable">--E</span> <span class="token assign-left variable">setting</span><span class="token operator">=</span>value              Configuration overwrite
  -M, <span class="token parameter variable">--M</span> <span class="token assign-left variable">setting</span><span class="token operator">=</span>value              Module configuration overwrite
  -N, <span class="token parameter variable">--N</span>                            Disable actual publishing <span class="token keyword">for</span> testing
  -c, <span class="token parameter variable">--c</span> string                     Configuration file, relative to path.config <span class="token punctuation">(</span>default <span class="token string">"filebeat.yml"</span><span class="token punctuation">)</span>
      <span class="token parameter variable">--cpuprofile</span> string            Write cpu profile to <span class="token function">file</span>
  -d, <span class="token parameter variable">--d</span> string                     Enable certain debug selectors
  -e, <span class="token parameter variable">--e</span>                            Log to stderr and disable syslog/file output
      <span class="token parameter variable">--environment</span> environmentVar   <span class="token builtin class-name">set</span> environment being ran <span class="token keyword">in</span> <span class="token punctuation">(</span>default default<span class="token punctuation">)</span>
  -h, <span class="token parameter variable">--help</span>                         <span class="token builtin class-name">help</span> <span class="token keyword">for</span> filebeat
      <span class="token parameter variable">--httpprof</span> string              Start pprof http server
      <span class="token parameter variable">--memprofile</span> string            Write memory profile to this <span class="token function">file</span>
      <span class="token parameter variable">--modules</span> string               List of enabled modules <span class="token punctuation">(</span>comma separated<span class="token punctuation">)</span>
      <span class="token parameter variable">--once</span>                         Run filebeat only once <span class="token keyword">until</span> all harvesters reach EOF
      <span class="token parameter variable">--path.config</span> string           Configuration path
      <span class="token parameter variable">--path.data</span> string             Data path
      <span class="token parameter variable">--path.home</span> string             Home path
      <span class="token parameter variable">--path.logs</span> string             Logs path
      <span class="token parameter variable">--plugin</span> pluginList            Load additional plugins
      <span class="token parameter variable">--strict.perms</span>                 Strict permission checking on config files <span class="token punctuation">(</span>default <span class="token boolean">true</span><span class="token punctuation">)</span>
  -v, <span class="token parameter variable">--v</span>                            Log at INFO level

Use <span class="token string">"filebeat [command] --help"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a command.</code></pre>

<h3 id="1-部署-filebeat-环境"><a href="#1-部署-filebeat-环境" class="headerlink" title="1.部署 filebeat 环境"></a>1.部署 filebeat 环境</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> localinstall filebeat-7.17.3-x86_64.rpm

<span class="token comment"># 温馨提示: elk102节点操作</span></code></pre>

<h3 id="2-简单测试"><a href="#2-简单测试" class="headerlink" title="2.简单测试"></a>2.简单测试</h3><h4 id="2-1-编写配置文件"><a href="#2-1-编写配置文件" class="headerlink" title="2.1 编写配置文件"></a>2.1 编写配置文件</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> /etc/filebeat/config
<span class="token function">cat</span> <span class="token operator">></span> /etc/filebeat/config/01-stdin-to-console.yml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
filebeat.inputs:         # 指定输⼊的类型
 - type: stdin           # 指定输⼊的类型为"stdin",表示标准输⼊
output.console:          # 指定输出的类型
 pretty: true            # 打印漂亮的格式
EOF</span></code></pre>

<h4 id="2-2-运行-filebeat-实例"><a href="#2-2-运行-filebeat-实例" class="headerlink" title="2.2 运行 filebeat 实例"></a>2.2 运行 filebeat 实例</h4><pre class="language-bash" data-language="bash"><code class="language-bash">$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> /etc/filebeat/config/01-stdin-to-console.yml
<span class="token punctuation">..</span>.</code></pre>

<h4 id="2-3-测试"><a href="#2-3-测试" class="headerlink" title="2.3 测试"></a>2.3 测试</h4><pre class="language-bash" data-language="bash"><code class="language-bash"> <span class="token punctuation">..</span>.
hello word
<span class="token punctuation">&#123;</span>
  <span class="token string">"@timestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-11-04T05:47:24.880Z"</span>,
  <span class="token string">"@metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"beat"</span><span class="token builtin class-name">:</span> <span class="token string">"filebeat"</span>,
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.4.3"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"ecs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.0.0"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"host"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"lujinkai-pc"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"log"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"file"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string">"path"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"offset"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"hello word"</span>,
  <span class="token string">"input"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"stdin"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"agent"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"filebeat"</span>,
    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"8.4.3"</span>,
    <span class="token string">"ephemeral_id"</span><span class="token builtin class-name">:</span> <span class="token string">"8a43c946-9a6d-43dc-8a79-4fe673f7882d"</span>,
    <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"af9266b6-6d99-48d2-abc2-acea45ef1c61"</span>,
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"lujinkai-pc"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">..</span>.</code></pre>

<h3 id="3-input-的-log-类型"><a href="#3-input-的-log-类型" class="headerlink" title="3.input 的 log 类型"></a>3.input 的 log 类型</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /tmp/test.log
<span class="token key atrule">output.console</span><span class="token punctuation">:</span>
  <span class="token key atrule">pretty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>

<h3 id="4-input-的通配符案例"><a href="#4-input-的通配符案例" class="headerlink" title="4.input 的通配符案例"></a>4.input 的通配符案例</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /tmp/test.log
      <span class="token punctuation">-</span> /tmp/<span class="token important">*.txt</span>
<span class="token key atrule">output.console</span><span class="token punctuation">:</span>
  <span class="token key atrule">pretty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>

<h3 id="5-input-的通用字段案例"><a href="#5-input-的通用字段案例" class="headerlink" title="5.input 的通用字段案例"></a>5.input 的通用字段案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    <span class="token comment"># 是否启动当前的输⼊类型，默认值为true</span>
    enabled: <span class="token boolean">true</span>
    <span class="token comment"># 指定数据路径</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    <span class="token comment"># 给当前的输⼊类型搭上标签</span>
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    <span class="token comment"># ⾃定义字段</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    <span class="token comment"># 将⾃定义字段的key-value放到顶级字段.</span>
    <span class="token comment"># 默认值为false，会将数据放在⼀个叫"fields"字段的下⾯.</span>
    fields_under_root: <span class="token boolean">true</span>

output.console:
  pretty: <span class="token boolean">true</span></code></pre>

<h3 id="6-日志过滤案例"><a href="#6-日志过滤案例" class="headerlink" title="6.日志过滤案例"></a>6.日志过滤案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*.log
    <span class="token comment"># 注意，⿊⽩名单均⽀持通配符,⽣产环节中不建议同时使⽤，</span>
    <span class="token comment"># 指定⽩名单，包含指定的内容才会采集，且区分⼤⼩写!</span>
    include_lines: <span class="token punctuation">[</span><span class="token string">"^ERR"</span>, <span class="token string">"^WARN"</span>, <span class="token string">"oldboyedu"</span><span class="token punctuation">]</span>
    <span class="token comment"># 指定⿊名单，排除指定的内容</span>
    exclude_lines: <span class="token punctuation">[</span><span class="token string">"^DBG"</span>, <span class="token string">"linux"</span>, <span class="token string">"oldboyedu"</span><span class="token punctuation">]</span>

output.console:
  pretty: <span class="token boolean">true</span></code></pre>

<h3 id="7-将数据写入-es-案例"><a href="#7-将数据写入-es-案例" class="headerlink" title="7.将数据写入 es 案例"></a>7.将数据写入 es 案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span></code></pre>

<h3 id="8-自定义-es-索引名称"><a href="#8-自定义-es-索引名称" class="headerlink" title="8.自定义 es 索引名称"></a>8.自定义 es 索引名称</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span>					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span>		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span>	<span class="token comment"># 设置索引模板的匹配模式</span></code></pre>

<h3 id="9-多个索引写入案例"><a href="#9-多个索引写入案例" class="headerlink" title="9.多个索引写入案例"></a>9.多个索引写入案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>
output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token comment"># index: "oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
  indices:
    - index: <span class="token string">"oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token comment"># 匹配指定字段包含的内容</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-linux80"</span>
    - index: <span class="token string">"oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-python"</span>

setup.ilm.enabled: <span class="token boolean">false</span>						<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span>			<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span>		<span class="token comment"># 设置索引模板的匹配模式</span></code></pre>

<h3 id="10-自定义分片和副本案例"><a href="#10-自定义分片和副本案例" class="headerlink" title="10.自定义分片和副本案例"></a>10.自定义分片和副本案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test.log
      - /tmp/*.txt
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-linux80"</span>, <span class="token string">"容器运维"</span>, <span class="token string">"DBA运维"</span>, <span class="token string">"SRE运维⼯程师"</span><span class="token punctuation">]</span>
    fields:
      school: <span class="token string">"北京昌平区沙河镇"</span>
      class: <span class="token string">"linux80"</span>
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /tmp/test/*/*.log
    tags: <span class="token punctuation">[</span><span class="token string">"oldboyedu-python"</span>, <span class="token string">"云原⽣开发"</span><span class="token punctuation">]</span>
    fields:
      name: <span class="token string">"oldboy"</span>
      hobby: <span class="token string">"linux,抖⾳"</span>
    fields_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token comment"># index: "oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
  indices:
    - index: <span class="token string">"oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token comment"># 匹配指定字段包含的内容</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-linux80"</span>
    - index: <span class="token string">"oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"oldboyedu-python"</span>


setup.ilm.enabled: <span class="token boolean">false</span>						<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span>			<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span>		<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">false</span>					<span class="token comment"># 覆盖已有的索引模板</span>
setup.template.settings:						<span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span>						<span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">2</span>						<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="11-filebeat-实现日志聚合到本地"><a href="#11-filebeat-实现日志聚合到本地" class="headerlink" title="11.filebeat 实现日志聚合到本地"></a>11.filebeat 实现日志聚合到本地</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>

output.file:
  path: <span class="token string">"/tmp/filebeat"</span>
  filename: oldboyedu-linux80
  rotate_every_kb: <span class="token number">102400</span> 		<span class="token comment"># 指定⽂件的滚动⼤⼩，默认值为20MB</span>
  number_of_files: <span class="token number">300</span> 			<span class="token comment"># 指定保存的⽂件个数，默认是7个，有效值为2-1024个</span>
  permissions: 0600 			<span class="token comment"># 指定⽂件的权限，默认权限是0600</span></code></pre>

<h3 id="12-filebeat-实现日志聚合到-ES-集群"><a href="#12-filebeat-实现日志聚合到-ES-集群" class="headerlink" title="12.filebeat 实现日志聚合到 ES 集群"></a>12.filebeat 实现日志聚合到 ES 集群</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667287595368.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>
    tags: <span class="token punctuation">[</span><span class="token string">"aaa"</span><span class="token punctuation">]</span>
  - type: tcp
    host: <span class="token string">"0.0.0.0:8000"</span>
    tags: <span class="token punctuation">[</span><span class="token string">"bbb"</span><span class="token punctuation">]</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  indices:
    - index: <span class="token string">"oldboyedu-linux80-elk-aaa-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"aaa"</span>
    - index: <span class="token string">"oldboyedu-linux80-elk-bbb-%&#123;+yyyy.MM.dd&#125;"</span>
      when.contains:
        tags: <span class="token string">"bbb"</span>

setup.ilm.enabled: <span class="token boolean">false</span>
setup.template.name: <span class="token string">"oldboyedu-linux80-elk"</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux80-elk*"</span>
setup.template.overwrite: <span class="token boolean">true</span>
setup.template.settings:
    index.number_of_shards: <span class="token number">3</span>
    index.number_of_replicas: <span class="token number">0</span></code></pre>

<h2 id="EFK-架构企业级实战案例"><a href="#EFK-架构企业级实战案例" class="headerlink" title="EFK 架构企业级实战案例"></a>EFK 架构企业级实战案例</h2><h3 id="1-部署-nginx-服务"><a href="#1-部署-nginx-服务" class="headerlink" title="1.部署 nginx 服务"></a>1.部署 nginx 服务</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.配置nginx的软件源</span>
<span class="token function">cat</span> <span class="token operator">></span>/etc/yum.repos.d/nginx.repo <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/centos/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
EOF</span>
<span class="token comment"># 2.安装nginx服务</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nginx
<span class="token comment"># 3.启动nginx服务</span>
systemctl start nginx</code></pre>

<h3 id="2-基于-log-类型收集-nginx-原生日志"><a href="#2-基于-log-类型收集-nginx-原生日志" class="headerlink" title="2.基于 log 类型收集 nginx 原生日志"></a>2.基于 log 类型收集 nginx 原生日志</h3><pre class="language-bash" data-language="bash"><code class="language-bash">filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /var/log/nginx/access.log*
    tags: <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-nginx-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span> 					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> 		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> 	<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span> 				<span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: 					<span class="token comment"># 配置索引模板</span>
  index.number_of_shards: <span class="token number">3</span> 					<span class="token comment"># 设置分⽚数量</span>
  index.number_of_replicas: <span class="token number">0</span> 					<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="3-基于-log-类型收集-nginx-的-json-日志"><a href="#3-基于-log-类型收集-nginx-的-json-日志" class="headerlink" title="3.基于 log 类型收集 nginx 的 json 日志"></a>3.基于 log 类型收集 nginx 的 json 日志</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 修改nginx的源⽇志格式</span>
<span class="token function">vim</span> /etc/nginx/nginx.conf
<span class="token punctuation">..</span>.
log_format oldboyedu_nginx_json <span class="token string">'&#123;"@timestamp":"$time_iso8601",'</span>
<span class="token string">'"host":"$server_addr",'</span>
<span class="token string">'"clientip":"$remote_addr",'</span>
<span class="token string">'"SendBytes":$body_bytes_sent,'</span>
<span class="token string">'"responsetime":$request_time,'</span>
<span class="token string">'"upstreamtime":"$upstream_response_time",'</span>
<span class="token string">'"upstreamhost":"$upstream_addr",'</span>
<span class="token string">'"http_host":"$host",'</span>
<span class="token string">'"uri":"$uri",'</span>
<span class="token string">'"domain":"$host",'</span>
<span class="token string">'"xff":"$http_x_forwarded_for",'</span>
<span class="token string">'"referer":"$http_referer",'</span>
<span class="token string">'"tcp_xff":"$proxy_protocol_addr",'</span>
<span class="token string">'"http_user_agent":"$http_user_agent",'</span>
<span class="token string">'"status":"$status"&#125;'</span><span class="token punctuation">;</span>

access_log /var/log/nginx/access.log oldboyedu_nginx_json<span class="token punctuation">;</span>
<span class="token comment"># 2.检查nginx的配置⽂件语法并重启nginx服务</span>
nginx <span class="token parameter variable">-t</span>
systemctl restart nginx
<span class="token comment"># 3.定义配置⽂件</span>
filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /var/log/nginx/access.log*
    tags: <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    json.keys_under_root: <span class="token boolean">true</span>      <span class="token comment"># 以JSON格式解析message字段的内容</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span> 					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> 		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> 	<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span> 				<span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: 					<span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span> 					<span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">0</span> 				<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="4-基于-modules-采集-nginx-日志文件"><a href="#4-基于-modules-采集-nginx-日志文件" class="headerlink" title="4.基于 modules 采集 nginx 日志文件"></a>4.基于 modules 采集 nginx 日志文件</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667288224966.png"></p>
<h4 id="模块的基本使用"><a href="#模块的基本使用" class="headerlink" title="模块的基本使用"></a>模块的基本使用</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看模块</span>
$ filebeat modules list
<span class="token comment"># 启动模块</span>
$ filebeat modules <span class="token builtin class-name">enable</span> nginx tomcat
<span class="token comment"># 禁⽤模块</span>
$ filebeat modules disable nginx tomcat</code></pre>

<h4 id="filebeat-配置⽂件（需要启⽤-nginx-模块）"><a href="#filebeat-配置⽂件（需要启⽤-nginx-模块）" class="headerlink" title="filebeat 配置⽂件（需要启⽤ nginx 模块）"></a>filebeat 配置⽂件（需要启⽤ nginx 模块）</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.config.modules</span><span class="token punctuation">:</span>
  <span class="token comment"># 指定模块的配置⽂件路径，如果是yum⽅式安装，在7.17.3版本中不能使⽤如下的默认值。</span>
  <span class="token comment">#  path: $&#123;path.config&#125;/modules.d/*.yml</span>
  <span class="token comment"># 经过实际测试，推荐⼤家使⽤如下的配置,此处写绝对路径即可!⽽对于⼆进制部署⽆需做此操作.</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/filebeat/modules.d/<span class="token important">*.yml</span>
  <span class="token comment"># 开启热加载功能</span>
  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span></code></pre>

<p><code>/etc/filebeat/modules.d/nginx.yml</code> ⽂件内容：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">module</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">access</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">var.paths</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/var/log/nginx/access.log*"</span><span class="token punctuation">]</span>
  <span class="token key atrule">error</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">var.paths</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/var/log/nginx/error.log"</span><span class="token punctuation">]</span>
  <span class="token key atrule">ingress_controller</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>

<h3 id="5-基于-modules-采集-tomcat-日志文件"><a href="#5-基于-modules-采集-tomcat-日志文件" class="headerlink" title="5.基于 modules 采集 tomcat 日志文件"></a>5.基于 modules 采集 tomcat 日志文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.部署tomcat服务</span>
<span class="token comment"># 1.1.解压tomcat软件包</span>
<span class="token function">tar</span> xf apache-tomcat-10.0.20.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token comment"># 1.2.创建符号链接</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> apache-tomcat-10.0.20 tomcat
<span class="token comment"># 1.3.配置环境变量</span>
<span class="token function">vim</span> /etc/profile.d/elk.sh
<span class="token punctuation">..</span>.
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/share/elasticsearch/jdk
<span class="token builtin class-name">export</span> <span class="token assign-left variable">TOMCAT_HOME</span><span class="token operator">=</span>/oldboyedu/softwares/tomcat
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$TOMCAT_HOME</span>/bin:<span class="token variable">$JAVA_HOME</span>/bin
<span class="token comment"># 1.4.使得环境变量⽣效</span>
<span class="token builtin class-name">source</span> /etc/profile.d/elk.sh
<span class="token comment"># 1.5.启动服务</span>
catalina.sh start

<span class="token comment"># 2.启⽤tomcat的模块管理</span>
filebeat <span class="token parameter variable">-c</span> ~/config/11-nginx-to-es.yml modules disable nginx
filebeat <span class="token parameter variable">-c</span> ~/config/11-nginx-to-es.yml modules <span class="token builtin class-name">enable</span> tomcat
filebeat <span class="token parameter variable">-c</span> ~/config/11-nginx-to-es.yml modules list

<span class="token comment"># 3.filebeat配置⽂件</span>
filebeat.config.modules:
  <span class="token comment"># 指定模块的配置⽂件路径，如果是yum⽅式安装，在7.17.3版本中不能使⽤如下的默认值。</span>
  <span class="token comment"># path: $&#123;path.config&#125;/modules.d/*.yml</span>
  <span class="token comment"># 经过实际测试，推荐⼤家使⽤如下的配置,此处写绝对路径即可!⽽对于⼆进制部署⽆需做此操作.</span>
  path: /etc/filebeat/modules.d/*.yml
  <span class="token comment"># 开启热加载功能</span>
  reload.enabled: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span>  					<span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> 		<span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> 	<span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span>		<span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: 			<span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span> 		<span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">0</span> 	<span class="token comment"># 设置副本数量，要求⼩于集群的数量</span>

<span class="token comment"># 4./etc/filebeat/modules.d/tomcat.yml⽂件内容</span>
- module: tomcat
  log:
    enabled: <span class="token boolean">true</span>
    <span class="token comment"># 指定输⼊的类型是⽂件，默认是监听udp端⼝哟～</span>
    var.input: <span class="token function">file</span>
    var.paths:
      - <span class="token string">"/oldboyedu/softwares/apache-tomcat-10.0.20/logs/localhost_access_log.2022-05-11.txt"</span></code></pre>

<h3 id="6-基于-log-类型收集-tomcat-的原生日志"><a href="#6-基于-log-类型收集-tomcat-的原生日志" class="headerlink" title="6.基于 log 类型收集 tomcat 的原生日志"></a>6.基于 log 类型收集 tomcat 的原生日志</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.txt</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="7-基于-log-类型收集-tomcat-的-json-日志"><a href="#7-基于-log-类型收集-tomcat-的-json-日志" class="headerlink" title="7.基于 log 类型收集 tomcat 的 json 日志"></a>7.基于 log 类型收集 tomcat 的 json 日志</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.⾃定义tomcat的⽇志格式</span>
<span class="token function">cp</span> /oldboyedu/softwares/apache-tomcat-10.0.20/conf/<span class="token punctuation">&#123;</span>server.xml,server.xml-<span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%F<span class="token variable">`</span></span><span class="token punctuation">&#125;</span>
<span class="token comment"># ...(切换到⾏尾修改，⼤概是在133-149之间)</span>
<span class="token operator">&lt;</span>Host <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"tomcat.oldboyedu.com"</span> <span class="token assign-left variable">appBase</span><span class="token operator">=</span><span class="token string">"webapps"</span>
      <span class="token assign-left variable">unpackWARs</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token assign-left variable">autoDeploy</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span>
           <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span>
           <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"tomcat.oldboyedu.com_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span>
           <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;request&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;http_user_agent&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;"</span>/<span class="token operator">></span>
<span class="token operator">&lt;</span>/Host<span class="token operator">></span>

<span class="token comment"># 2.修改filebeat的配置⽂件</span>
filebeat.inputs:
  - type: log
    enabled: <span class="token boolean">true</span>
    paths:
      - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt
    <span class="token comment"># 解析message字段的json格式，并放在顶级字段中</span>
    json.keys_under_root: <span class="token boolean">true</span>

output.elasticsearch:
  enabled: <span class="token boolean">true</span>
  hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>, <span class="token string">"http://10.0.0.102:9200"</span>, <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  index: <span class="token string">"oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>

setup.ilm.enabled: <span class="token boolean">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
setup.template.name: <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
setup.template.pattern: <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
setup.template.overwrite: <span class="token boolean">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
setup.template.settings: <span class="token comment"># 配置索引模板</span>
    index.number_of_shards: <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
    index.number_of_replicas: <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="8-多⾏匹配-收集-tomcat-的错误日志"><a href="#8-多⾏匹配-收集-tomcat-的错误日志" class="headerlink" title="8.多⾏匹配-收集 tomcat 的错误日志"></a>8.多⾏匹配-收集 tomcat 的错误日志</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html">https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html</a></p>
<p><code>multiline.match</code></p>
<p>Specifies how Filebeat combines matching lines into an event. The settings are <code>after</code> or <code>before</code>. The behavior of these settings depends on what you specify for <code>negate</code>:</p>
<table>
<thead>
<tr>
<th>Setting for <code>negate</code></th>
<th>Setting for <code>match</code></th>
<th>Result</th>
<th>Example <code>pattern: ^b</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>false</code></td>
<td><code>after</code></td>
<td>Consecutive lines that match the pattern are appended to the previous line that doesn’t match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397337884.png"></td>
</tr>
<tr>
<td><code>false</code></td>
<td><code>before</code></td>
<td>Consecutive lines that match the pattern are prepended to the next line that doesn’t match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397348947.png"></td>
</tr>
<tr>
<td><code>true</code></td>
<td><code>after</code></td>
<td>Consecutive lines that don’t match the pattern are appended to the previous line that does match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397358476.png"></td>
</tr>
<tr>
<td><code>true</code></td>
<td><code>before</code></td>
<td>Consecutive lines that don’t match the pattern are prepended to the next line that does match.</td>
<td><img data-src="//img.to2b.cn/blog/lujinkai/1667397369443.png"></td>
</tr>
</tbody></table>
<blockquote>
<p>The <code>after</code> setting is equivalent to <code>previous</code> in <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html">Logstash</a>, and <code>before</code> is equivalent to <code>next</code>.</p>
</blockquote>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.out</span>
    <span class="token comment"># 指定多⾏匹配的类型，可选值为"pattern","count"</span>
    <span class="token key atrule">multiline.type</span><span class="token punctuation">:</span> pattern
    <span class="token comment"># 指定匹配模式</span>
    <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">'^\d&#123;2&#125;'</span>
    <span class="token comment"># 下⾯2个参数参考官⽅架构图即可，如上图所示。</span>
    <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-tomcat-error-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="9-多⾏匹配-收集-elasticsearch-的错误日志"><a href="#9-多⾏匹配-收集-elasticsearch-的错误日志" class="headerlink" title="9.多⾏匹配-收集 elasticsearch 的错误日志"></a>9.多⾏匹配-收集 elasticsearch 的错误日志</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/elasticsearch/oldboyedu<span class="token punctuation">-</span>elk<span class="token punctuation">-</span>2022.log*
    <span class="token comment"># 指定多⾏匹配的类型，可选值为"pattern","count"</span>
    <span class="token key atrule">multiline.type</span><span class="token punctuation">:</span> pattern
    <span class="token comment"># 指定匹配模式</span>
    <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">'^\['</span>
    <span class="token comment"># 下⾯2个参数参考官⽅架构图即可</span>
    <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-es-error-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="10-nginx-错误日志过滤"><a href="#10-nginx-错误日志过滤" class="headerlink" title="10.nginx 错误日志过滤"></a>10.nginx 错误日志过滤</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/access.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    <span class="token comment"># 解析message字段的json格式，并放在顶级字段中</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/error.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span>
    <span class="token key atrule">include_lines</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'\[error\]'</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token comment"># index: "oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;"</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token comment"># 匹配指定字段包含的内容</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"error"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="11-nginx-和-tomcat-同时采集案例"><a href="#11-nginx-和-tomcat-同时采集案例" class="headerlink" title="11.nginx 和 tomcat 同时采集案例"></a>11.nginx 和 tomcat 同时采集案例</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/access.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nginx-access"</span><span class="token punctuation">]</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/error.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nginx-error"</span><span class="token punctuation">]</span>
    <span class="token key atrule">include_lines</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'\[error\]'</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.txt</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"tomcat-access"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.out</span>
    <span class="token key atrule">multiline.type</span><span class="token punctuation">:</span> pattern
    <span class="token key atrule">multiline.pattern</span><span class="token punctuation">:</span> <span class="token string">'^\d&#123;2&#125;'</span>
    <span class="token key atrule">multiline.negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">multiline.match</span><span class="token punctuation">:</span> after
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"tomcat-error"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"nginx-access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-nginx-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"nginx-error"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"tomcat-access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"tomcat-error"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 禁⽤索引⽣命周期管理</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span> <span class="token comment"># 设置索引模板的名称</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span> <span class="token comment"># 设置索引模板的匹配模式</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 覆盖已有的索引模板</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span> <span class="token comment"># 配置索引模板</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 设置分⽚数量</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 设置副本数量，要求⼩于集群的数量</span></code></pre>

<h3 id="12-log-类型切换-filestream-类型注意事项"><a href="#12-log-类型切换-filestream-类型注意事项" class="headerlink" title="12.log 类型切换 filestream 类型注意事项"></a>12.log 类型切换 filestream 类型注意事项</h3><h4 id="12-1-filestream-类型-json-解析配置"><a href="#12-1-filestream-类型-json-解析配置" class="headerlink" title="12.1.filestream 类型 json 解析配置"></a>12.1.filestream 类型 json 解析配置</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/nginx/access.log*
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    <span class="token comment"># 对于filestream类型⽽⾔，不能直接配置json解析，⽽是需要借助解析器实现</span>
    <span class="token comment"># json.keys_under_root: true</span>
    <span class="token comment"># 综上所述，我们就需要使⽤以下的写法实现.</span>
    <span class="token key atrule">parsers</span><span class="token punctuation">:</span>
      <span class="token comment"># 使 Filebeat能够解码结构化为JSON消息的⽇志。</span>
      <span class="token comment"># Filebeat逐⾏处理⽇志，因此JSON解码仅在每条消息有⼀个JSON对象时才有效。</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ndjson</span><span class="token punctuation">:</span>
        <span class="token comment"># 对message字段进⾏JSON格式解析，并将key放在顶级字段。</span>
        <span class="token key atrule">keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-nginx-%&#123;+yyyy.MM.dd&#125;"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h4 id="12-2-filestream-类型多行匹配"><a href="#12-2-filestream-类型多行匹配" class="headerlink" title="12.2.filestream 类型多行匹配"></a>12.2.filestream 类型多行匹配</h4><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.txt</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"access"</span><span class="token punctuation">]</span>
    <span class="token key atrule">parsers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ndjson</span><span class="token punctuation">:</span>
          <span class="token key atrule">keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /oldboyedu/softwares/apache<span class="token punctuation">-</span>tomcat<span class="token punctuation">-</span>10.0.20/logs/<span class="token important">*.out</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span>
    <span class="token key atrule">parsers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">multiline</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> pattern
        <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">'^\d&#123;2&#125;'</span>
        <span class="token key atrule">negate</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">match</span><span class="token punctuation">:</span> after

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-access-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"access"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux-web-tomcat-error-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"error"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h3 id="13-收集日志到-redis-服务"><a href="#13-收集日志到-redis-服务" class="headerlink" title="13.收集日志到 redis 服务"></a>13.收集日志到 redis 服务</h3><h4 id="13-1-部署-redis"><a href="#13-1-部署-redis" class="headerlink" title="13.1.部署 redis"></a>13.1.部署 redis</h4><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> redis</code></pre>

<h4 id="13-2-修改配置⽂件"><a href="#13-2-修改配置⽂件" class="headerlink" title="13.2.修改配置⽂件"></a>13.2.修改配置⽂件</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/redis.conf
<span class="token punctuation">..</span>.
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
requirepass oldboyedu</code></pre>

<h4 id="13-3-启动-redis-服务"><a href="#13-3-启动-redis-服务" class="headerlink" title="13.3.启动 redis 服务"></a>13.3.启动 redis 服务</h4><pre class="language-bash" data-language="bash"><code class="language-bash">systemctl start redis</code></pre>

<h4 id="13-4-其他节点连接测试-redis-环境"><a href="#13-4-其他节点连接测试-redis-环境" class="headerlink" title="13.4.其他节点连接测试 redis 环境"></a>13.4.其他节点连接测试 redis 环境</h4><pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-a</span> oldboyedu <span class="token parameter variable">-h</span> <span class="token number">10.0</span>.0.101 <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">--raw</span> <span class="token parameter variable">-n</span> <span class="token number">5</span></code></pre>

<h4 id="13-5-将-filebeat-数据写入到-redis-环境"><a href="#13-5-将-filebeat-数据写入到-redis-环境" class="headerlink" title="13.5.将 filebeat 数据写入到 redis 环境"></a>13.5.将 filebeat 数据写入到 redis 环境</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667398812569.png"></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> tcp
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0:9000"</span>

<span class="token key atrule">output.redis</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6379"</span><span class="token punctuation">]</span> <span class="token comment"># 写⼊redis的主机地址</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu"</span> <span class="token comment"># 指定redis的认证⼝令</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 指定连接数据库的编号</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux80-filebeat"</span> <span class="token comment"># 指定的key值</span>
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 规定超时时间.</span></code></pre>

<h4 id="13-6-测试写入数据"><a href="#13-6-测试写入数据" class="headerlink" title="13.6.测试写入数据"></a>13.6.测试写入数据</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 写⼊数据:</span>
<span class="token builtin class-name">echo</span> <span class="token number">33333333333333333333</span><span class="token operator">|</span> <span class="token function">nc</span> <span class="token number">10.0</span>.0.102 <span class="token number">9000</span>
<span class="token comment"># 查看数据:</span>
<span class="token punctuation">[</span>root@elk103.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a oldboyedu -h 10.0.0.101 -p</span>
<span class="token number">6379</span> <span class="token parameter variable">--raw</span> <span class="token parameter variable">-n</span> <span class="token number">5</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token number">10.0</span>.0.101:6379<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">></span> LRANGE oldboyedu-linux80-filebeat <span class="token number">0</span> <span class="token parameter variable">-1</span></code></pre>

<h3 id="14-今日作业"><a href="#14-今日作业" class="headerlink" title="14.今日作业"></a>14.今日作业</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 完成课堂的所有练习;</span>

<span class="token comment"># 2. 使⽤filebeat收集以下系统⽇志:</span>
/var/log/secure
/var/log/maillog
/var/log/yum.log
/var/log/firewalld
/var/log/cron
/var/log/messages
    <span class="token comment"># 要求如下:</span>
    <span class="token comment"># 1.在同⼀个filebeat配置⽂件中书写;</span>
    <span class="token comment"># 2.将上述6类⽇志分别写⼊不同的索引，索引前缀名称为"oldboyedu-elk-system-log-&#123;xxx&#125;-%&#123;+yyyy.MM.dd&#125;";</span>
    <span class="token comment"># 3.要求副本数量为0，分⽚数量为10;</span>

<span class="token comment"># 7.17.3版本可能遇到的问题:</span>
<span class="token comment"># 1.input源配置⼀旦超过4个，写⼊ES时，就可能会复现出部分数据⽆法写⼊的问题;</span>
<span class="token comment"># 有两种解决⽅案:</span>
<span class="token comment"># ⽅案⼀: 拆成多个filebeat实例。运⾏多个filebeat实例时需要指定数据路径"--path.data"。</span>
	filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/23-systemLog-to-es.yml <span class="token parameter variable">--path.data</span> /tmp/filebeat
<span class="token comment"># ⽅案⼆: ⽇志聚合思路解决问题。</span>
<span class="token comment"># 1)部署服务</span>
	yum <span class="token parameter variable">-y</span> <span class="token function">install</span> rsyslog
<span class="token comment"># 2)修改配置⽂件</span>
	<span class="token function">vim</span> /etc/rsyslog.conf
    <span class="token punctuation">..</span>.
    <span class="token variable">$ModLoad</span> imtcp
    <span class="token variable">$InputTCPServerRun</span> <span class="token number">514</span>
    <span class="token punctuation">..</span>.
    *.* /var/log/oldboyedu.log
<span class="token comment"># 3)重启服务并测试</span>
    systemctl restart rsyslog
    logger <span class="token string">"1111"</span></code></pre>

<h4 id="⽅案⼀：filebeat-多实例"><a href="#⽅案⼀：filebeat-多实例" class="headerlink" title="⽅案⼀：filebeat 多实例"></a>⽅案⼀：filebeat 多实例</h4><p>filebeat 实例⼀：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/firewalld
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"firewalld"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/cron
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cron"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/messages
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
<span class="token key atrule">indices</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-firewalld-%&#123;+yyyy.MM.dd&#125;"</span>
    <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"firewalld"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-cron-%&#123;+yyyy.MM.dd&#125;"</span>
    <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"cron"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-message-%&#123;+yyyy.MM.dd&#125;"</span>
    <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"message"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<p>filebeat 实例二：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/secure
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secure"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/maillog
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"maillog"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/yum.log
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"yum"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-secure-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"secure"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-maillog-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"maillog"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log-yum-%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"yum"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h4 id="方案二：基于-rsyslog-案例"><a href="#方案二：基于-rsyslog-案例" class="headerlink" title="方案二：基于 rsyslog 案例"></a>方案二：基于 rsyslog 案例</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667399463086.png"></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> filestream
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/log/oldboyedu.log
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"rsyslog"</span><span class="token punctuation">]</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-rsyslog--%&#123;+yyyy.MM.dd&#125;"</span>
      <span class="token key atrule">when.contains</span><span class="token punctuation">:</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"rsyslog"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-elk-system-log*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<h2 id="部署-logstash-环境及基础使用"><a href="#部署-logstash-环境及基础使用" class="headerlink" title="部署 logstash 环境及基础使用"></a>部署 logstash 环境及基础使用</h2><h3 id="1-部署-logstash-环境"><a href="#1-部署-logstash-环境" class="headerlink" title="1.部署 logstash 环境"></a>1.部署 logstash 环境</h3><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token parameter variable">-y</span> localinstall logstash-7.17.3-x86_64.rpm
<span class="token function">ln</span> <span class="token parameter variable">-sv</span> /usr/share/logstash/bin/logstash /usr/local/bin/

<span class="token comment"># 下载地址: https://www.elastic.co/downloads/past-releases#logstash</span></code></pre>

<h3 id="2-修改-logstash-的配置⽂件"><a href="#2-修改-logstash-的配置⽂件" class="headerlink" title="2.修改 logstash 的配置⽂件"></a>2.修改 logstash 的配置⽂件</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)编写配置⽂件</span>
<span class="token function">cat</span> <span class="token operator">></span> conf.d/01-stdin-to-stdout.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
input &#123;
    stdin &#123;&#125;
&#125;
output &#123;
    stdout &#123;&#125;
&#125;
EOF</span>

<span class="token comment"># (2)检查配置⽂件语法</span>
logstash <span class="token parameter variable">-tf</span> conf.d/01-stdin-to-stdout.conf

<span class="token comment"># (3)启动logstash实例</span>
logstash <span class="token parameter variable">-f</span> conf.d/01-stdin-to-stdout.conf</code></pre>

<h3 id="3-input-插件基于-file-案例"><a href="#3-input-插件基于-file-案例" class="headerlink" title="3.input 插件基于 file 案例"></a>3.input 插件基于 file 案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定收集的路径</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"/tmp/test/*.txt"</span><span class="token punctuation">]</span>
        <span class="token comment"># 指定⽂件的读取位置，仅在".sincedb*"⽂件中没有记录的情况下⽣效!</span>
        start_position <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"beginning"</span>
        <span class="token comment"># start_position => "end"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="4-input-插件基于-tcp-案例"><a href="#4-input-插件基于-tcp-案例" class="headerlink" title="4.input 插件基于 tcp 案例"></a>4.input 插件基于 tcp 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667399789647.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    tcp <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="5-input-插件基于-http-案例"><a href="#5-input-插件基于-http-案例" class="headerlink" title="5.input 插件基于 http 案例"></a>5.input 插件基于 http 案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    http <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    http <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="6-input-插件基于-redis-案例"><a href="#6-input-插件基于-redis-案例" class="headerlink" title="6.input 插件基于 redis 案例"></a>6.input 插件基于 redis 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667399903071.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># filebeat的配置:(仅供参考)</span>
filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>

output.redis:
  hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6379"</span><span class="token punctuation">]</span> <span class="token comment"># 写⼊redis的主机地址</span>
  password: <span class="token string">"oldboyedu"</span> <span class="token comment"># 指定redis的认证⼝令</span>
  db: <span class="token number">5</span> <span class="token comment"># 指定连接数据库的编号</span>
  key: <span class="token string">"oldboyedu-linux80-filebeat"</span> <span class="token comment"># 指定的key值</span>
  timeout: <span class="token number">3</span> <span class="token comment"># 规定超时时间.</span>

<span class="token comment"># logstash的配置:</span>
input <span class="token punctuation">&#123;</span>
    redis <span class="token punctuation">&#123;</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>	    				<span class="token comment"># 指定的是REDIS的键(key)的类型</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5</span>	        						<span class="token comment"># 指定数据库的编号,默认值是0号数据库</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>					<span class="token comment"># 指定数据库的ip地址,默认值是localhost</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>	        				<span class="token comment"># 指定数据库的端⼝号，默认值为6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>					<span class="token comment"># 指定redis的认证密码</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>		<span class="token comment"># 指定从redis的哪个key取数据</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="7-input-插件基于-beats-案例"><a href="#7-input-插件基于-beats-案例" class="headerlink" title="7.input 插件基于 beats 案例"></a>7.input 插件基于 beats 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400112207.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># filbeat配置:</span>
filebeat.inputs:
  - type: tcp
    host: <span class="token string">"0.0.0.0:9000"</span>
output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:5044"</span><span class="token punctuation">]</span>

<span class="token comment"># logstsh配置:</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5044</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="8-output-插件基于-redis-案例"><a href="#8-output-插件基于-redis-案例" class="headerlink" title="8.output 插件基于 redis 案例"></a>8.output 插件基于 redis 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400209038.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    redis <span class="token punctuation">&#123;</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>		<span class="token comment"># 指定redis的主机地址</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"6379"</span>				<span class="token comment"># 指定redis的端⼝号</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10</span>					<span class="token comment"># 指定redis数据库编号</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>		<span class="token comment"># 指定redis的密码</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>			<span class="token comment"># 指定写⼊数据的key类型</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash"</span>		<span class="token comment"># 指定的写⼊的key名称</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="9-output-插件基于-file-案例"><a href="#9-output-插件基于-file-案例" class="headerlink" title="9.output 插件基于 file 案例"></a>9.output 插件基于 file 案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400316902.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
   		port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定磁盘的落地位置</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/oldboyedu-linux80-logstash.log"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="10-logstash-综合案例"><a href="#10-logstash-综合案例" class="headerlink" title="10.logstash 综合案例"></a>10.logstash 综合案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400376710.png"></p>
<p>1.filebeat-to-redis 参考笔记</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> tcp
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0:8888"</span>

<span class="token key atrule">output.redis</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6379"</span><span class="token punctuation">]</span> <span class="token comment"># 写⼊redis的主机地址</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu"</span> <span class="token comment"># 指定redis的认证⼝令</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux80-filebeat"</span> <span class="token comment"># 指定的key值</span>
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 规定超时时间.</span></code></pre>

<p>2.filebeat-to-logstash 参考笔记</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> tcp
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0:9999"</span>
<span class="token key atrule">output.logstash</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:7777"</span><span class="token punctuation">]</span></code></pre>

<p>3.logstash 配置⽂件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
    tcp <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-tcp"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6666</span>
    <span class="token punctuation">&#125;</span>
    beats <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-beat"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">7777</span>
    <span class="token punctuation">&#125;</span>
    redis <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-redis"</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-tcp"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-tcp-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-beat"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-beat-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-redis"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-redis-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-other-%&#123;+YYYY.MM.dd&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="11-今日作业"><a href="#11-今日作业" class="headerlink" title="11.今日作业"></a>11.今日作业</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667400682356.png"></p>
<pre class="language-none"><code class="language-none">(1)完成课堂的所有练习，要求能够⼿绘架构图;
(2)如上图所示，按照上述要求完成作业;</code></pre>

<h4 id="11-1-运行一个-logsash-版本"><a href="#11-1-运行一个-logsash-版本" class="headerlink" title="11.1 运行一个 logsash 版本"></a>11.1 运行一个 logsash 版本</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/11-many-to-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    redis <span class="token punctuation">&#123;</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/11-many-to-es.conf</code></pre>

<h4 id="11-2-运行两个-logstash-版本"><a href="#11-2-运行两个-logstash-版本" class="headerlink" title="11.2.运行两个 logstash 版本"></a>11.2.运行两个 logstash 版本</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># logstash接受redis示例：</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/13-redis-to-es.conf
input <span class="token punctuation">&#123;</span>
    redis <span class="token punctuation">&#123;</span>
        data_type <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"list"</span>
        db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8</span>
        <span class="token function">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu"</span>
        key <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-filebeat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/13-redis-to-es.conf

<span class="token comment">#logstash接受beats示例：</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/12-beat-to-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/12-beat-to-es.conf <span class="token parameter variable">--path.data</span> /tmp/logstash</code></pre>

<h2 id="logstash-企业级插件案例-ELFK-架构"><a href="#logstash-企业级插件案例-ELFK-架构" class="headerlink" title="logstash 企业级插件案例(ELFK 架构)"></a>logstash 企业级插件案例(ELFK 架构)</h2><h3 id="1-gork-插件概述"><a href="#1-gork-插件概述" class="headerlink" title="1.gork 插件概述"></a>1.gork 插件概述</h3><p>Grok 是将⾮结构化⽇志数据解析为结构化和可查询的好⽅法。底层原理是基于正则匹配任意⽂本格式。<br>该⼯具⾮常适合 syslog ⽇志、apache 和其他⽹络服务器⽇志、mysql ⽇志，以及通常为⼈类⽽⾮计算机消耗⽽编写的任何⽇志格式。<br>内置 120 种匹配模式，当然也可以⾃定义匹配模式:<br><a target="_blank" rel="noopener" href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a></p>
<h3 id="2-使⽤-grok-内置的正则案例-1"><a href="#2-使⽤-grok-内置的正则案例-1" class="headerlink" title="2.使⽤ grok 内置的正则案例 1"></a>2.使⽤ grok 内置的正则案例 1</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667401251531.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/14-beat-grok-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
  	  port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># "message" => "%&#123;COMBINEDAPACHELOG&#125;"</span>
        <span class="token comment"># 上⾯的""变量官⽅github上已经废弃，建议使⽤下⾯的匹配模式</span>
        <span class="token comment"># https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span>
        <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/14-beat-grok-es.conf</code></pre>

<h3 id="3-使用-grok-内置的正则案例-2"><a href="#3-使用-grok-内置的正则案例-2" class="headerlink" title="3.使用 grok 内置的正则案例 2"></a>3.使用 grok 内置的正则案例 2</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/15-stdin-grok-stdout.conf
input <span class="token punctuation">&#123;</span>
	stdin <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;IP:oldboyedu-client&#125; %&#123;WORD:oldboyedu-method&#125; %&#123;URIPATHPARAM:oldboyedu-request&#125; %&#123;NUMBER:oldboyedu-bytes&#125; %&#123;NUMBER:oldboyedu-duration&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/15-stdin-grok-stdout.conf


<span class="token comment"># 温馨提示:（如下图所示，按照要求输⼊数据）</span>
<span class="token number">55.3</span>.244.1 GET /index.html <span class="token number">15824</span> <span class="token number">0.043</span>
<span class="token number">10.0</span>.0.103 POST /oldboyedu.html <span class="token number">888888</span> <span class="token number">5.20</span>
<span class="token comment"># 参考地址:</span>
https://github.com/logstash-plugins/logstash-patterns-core/tree/main/patterns/legacy</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667401452697.png"></p>
<h3 id="4-使用-grop-自定义的正则案例"><a href="#4-使用-grop-自定义的正则案例" class="headerlink" title="4.使用 grop 自定义的正则案例"></a>4.使用 grop 自定义的正则案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667401700078.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/16-stdin-grok_custom_patterns-stdout.conf
input <span class="token punctuation">&#123;</span>
    stdin <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定匹配模式的⽬录，可以使⽤绝对路径哟～</span>
        <span class="token comment"># 在./patterns⽬录下随便创建⼀个⽂件，并写⼊以下匹配模式</span>
        <span class="token comment"># POSTFIX_QUEUEID [0-9A-F]&#123;10,11&#125;</span>
        <span class="token comment"># OLDBOYEDU_LINUX80 [\d]&#123;3&#125;</span>
        patterns_dir <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"./patterns"</span><span class="token punctuation">]</span>
        <span class="token comment"># 匹配模式</span>
        <span class="token comment"># 测试数据为: Jan 1 06:25:43 mailserver14 postfix/cleanup[21403]:BEF25A72965: message-id=&lt;20130101142543.5828399CCAF@mailserver14.example.com></span>
        <span class="token comment"># match => &#123; "message" => "%&#123;SYSLOGBASE&#125; %&#123;POSTFIX_QUEUEID:queue_id&#125;: %&#123;GREEDYDATA:syslog_message&#125;" &#125;</span>
        <span class="token comment"># 测试数据为: ABCDE12345678910 ---> 333FGHIJK</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;POSTFIX_QUEUEID:oldboyedu_queue_id&#125; ---> %&#123;OLDBOYEDU_LINUX80:oldboyedu_linux80_elk&#125;"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-f</span> config-logstash/16-stdin-grok_custom_patterns-stdout.conf</code></pre>

<h3 id="5-filter-插件通用字段案例"><a href="#5-filter-插件通用字段案例" class="headerlink" title="5.filter 插件通用字段案例"></a>5.filter 插件通用字段案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667401967834.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/17-beat-grok-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># "message" => "%&#123;COMBINEDAPACHELOG&#125;"</span>
            <span class="token comment"># 上⾯的""变量官⽅github上已经废弃，建议使⽤下⾯的匹配模式</span>
            <span class="token comment"># https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment"># 移除指定的字段</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"agent"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 添加指定的字段</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
            <span class="token string">"oldboyedu-clientip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip ---> %&#123;clientip&#125;"</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment"># 添加tag</span>
        add_tag <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"linux80"</span>,<span class="token string">"zookeeper"</span>,<span class="token string">"kafka"</span>,<span class="token string">"elk"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 移除tag</span>
        remove_tag <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"zookeeper"</span>, <span class="token string">"kafka"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 创建插件的唯⼀ID，如果不创建则系统默认⽣成</span>
        <span class="token function">id</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"nginx"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token comment"># elasticsearch &#123;</span>
        <span class="token comment"># hosts => ["10.0.0.101:9200","10.0.0.102:9200","10.0.0.103:9200"]</span>
        <span class="token comment"># index => "oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token comment"># &#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/17-beat-grok-es.conf</code></pre>

<h3 id="6-date-插件修改写入-ES-的时间"><a href="#6-date-插件修改写入-ES-的时间" class="headerlink" title="6.date 插件修改写入 ES 的时间"></a>6.date 插件修改写入 ES 的时间</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/18-beat-grok_date-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
  	  port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># "message" => "%&#123;COMBINEDAPACHELOG&#125;"</span>
            <span class="token comment"># 上⾯的""变量官⽅github上已经废弃，建议使⽤下⾯的匹配模式</span>
            <span class="token comment"># https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment"># 移除指定的字段</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"agent"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        <span class="token comment"># 添加指定的字段</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token function">date</span> <span class="token punctuation">&#123;</span>
        <span class="token comment"># 匹配时间字段并解析,值得注意的是，logstash的输出时间可能会错8⼩时,但写⼊es但数据是准确的!</span>
        <span class="token comment"># "13/May/2022:15:47:24 +0800", 以下2种match写法均可!</span>
        <span class="token comment"># match => ["timestamp","dd/MMM/yyyy:HH:mm:ss Z"]</span>
        <span class="token comment"># 当然，我们也可以不对时区字段进⾏解析，⽽是使⽤"timezone"指定时区哟!</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"timestamp"</span>,<span class="token string">"dd/MMM/yyyy:HH:mm:ss +0800"</span><span class="token punctuation">]</span>
        <span class="token comment"># 设置时区字段为UTC时间,写⼊ES的数据时间是不准确的</span>
        <span class="token comment"># timezone => "UTC"</span>
        <span class="token comment"># 建议⼤家设置为"Asia/Shanghai"，写⼊ES的数据是准确的!</span>
        timezone <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Asia/Shanghai"</span>
        <span class="token comment"># 将匹配到到时间字段解析后存储到⽬标字段，若不指定，则默认字段为"@timestamp"字段</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx-access-time"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/18-beat-grok_date-es.conf</code></pre>

<h3 id="7-geoip-分析源地址的地址位置"><a href="#7-geoip-分析源地址的地址位置" class="headerlink" title="7.geoip 分析源地址的地址位置"></a>7.geoip 分析源地址的地址位置</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> config-logstash/19-beat-grok_date_geoip-es.conf
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    grok <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;HTTPD_COMMONLOG&#125;"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"agent"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">date</span> <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"timestamp"</span>,<span class="token string">"dd/MMM/yyyy:HH:mm:ss Z"</span><span class="token punctuation">]</span>
        timezone <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Asia/Shanghai"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx-access-time"</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定基于哪个字段分析IP地址</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        <span class="token comment"># 如果期望查看指定的字段，则可以在这⾥配置即可，若不设置，表示显示所有的查询字段.</span>
        fields <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"city_name"</span>,<span class="token string">"country_name"</span>,<span class="token string">"ip"</span><span class="token punctuation">]</span>
        <span class="token comment"># 指定geoip的输出字段，如果想要对多个IP地址进⾏分析，则该字段很有⽤哟~</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/19-beat-grok_date_geoip-es.conf</code></pre>

<h3 id="8-useragent-分析客户端的设备类型"><a href="#8-useragent-分析客户端的设备类型" class="headerlink" title="8.useragent 分析客户端的设备类型"></a>8.useragent 分析客户端的设备类型</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/20-beat-grok_date_geoip_useragent-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    <span class="token function">date</span> <span class="token punctuation">&#123;</span>
        match <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"timestamp"</span>,<span class="token string">"dd/MMM/yyyy:HH:mm:ss Z"</span><span class="token punctuation">]</span>
        timezone <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Asia/Shanghai"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx-access-time"</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"agent"</span>, <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        fields <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"city_name"</span>,<span class="token string">"country_name"</span>,<span class="token string">"ip"</span><span class="token punctuation">]</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
    <span class="token punctuation">&#125;</span>
    useragent <span class="token punctuation">&#123;</span>
        <span class="token comment"># 指定客户端的设备相关信息的字段</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"http_user_agent"</span>
        <span class="token comment"># 将分析的数据存储在⼀个指定的字段中，若不指定，则默认存储在target字段中。</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/20-beat-grok_date_geoip_useragent-es.conf</code></pre>

<h3 id="9-mutate-组件数据准备-python-脚本"><a href="#9-mutate-组件数据准备-python-脚本" class="headerlink" title="9.mutate 组件数据准备-python 脚本"></a>9.mutate 组件数据准备-python 脚本</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> generate_log.py <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/usr/bin/env python
# -*- coding: UTF-8 -*-
# @author : oldboyedu-linux80

import datetime
import random
import logging
import time
import sys

LOG_FORMAT = "%(levelname)s %(asctime)s [com.oldboyedu.%(module)s] - %(message)s "
DATE_FORMAT = "%Y-%m-%d %H:%M:%S"

# 配置root的logging.Logger实例的基本配置
logging.basicConfig(level=logging.INFO, format=LOG_FORMAT,datefmt=DATE_FORMAT, filename=sys.argv[1], filemode='a',)
actions = ["浏览⻚⾯", "评论商品", "加⼊收藏", "加⼊购物⻋", "提交订单", "使⽤优惠券", "领取优惠券","搜索", "查看订单", "付款", "清空购物⻋"]

while True:
    time.sleep(random.randint(1, 5))
    user_id = random.randint(1, 10000)
    # 对⽣成的浮点数保留2位有效数字.
    price = round(random.uniform(15000, 30000),2)
    action = random.choice(actions)
    svip = random.choice([0,1])
	logging.info("DAU|&#123;0&#125;|&#123;1&#125;|&#123;2&#125;|&#123;3&#125;".format(user_id,action,svip,price))
EOF</span>

$ <span class="token function">nohup</span> python generate_log.py /tmp/app.log <span class="token operator">&amp;></span>/dev/null <span class="token operator">&amp;</span></code></pre>

<h3 id="9-mutate-组件常⽤字段案例"><a href="#9-mutate-组件常⽤字段案例" class="headerlink" title="9.mutate 组件常⽤字段案例"></a>9.mutate 组件常⽤字段案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667402745944.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/21-mutate.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
	mutate <span class="token punctuation">&#123;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"@timestamp"</span>, <span class="token string">"agent"</span>, <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	<span class="token comment"># 对"message"字段内容使⽤"|"进⾏切分。</span>
        <span class="token function">split</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        	<span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"|"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 添加字段，其中引⽤到了变量</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][1]&#125;"</span>
            <span class="token string">"action"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][2]&#125;"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][3]&#125;"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][4]&#125;"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	strip <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"svip"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	<span class="token comment"># 将指定字段转换成相应对数据类型.</span>
        convert <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"integer"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"boolean"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"float"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 将"price"字段拷⻉到"oldboyedu-linux80-price"字段中.</span>
        copy <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-price"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 修改字段到名称</span>
        <span class="token function">rename</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-ssvip"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 替换字段的内容</span>
        replace <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;message&#125;: My new message"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token comment"># 将指定字段的字⺟全部⼤写</span>
        uppercase <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"message"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	elasticsearch <span class="token punctuation">&#123;</span>
		hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
		index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;"</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/21-mutate.conf</code></pre>

<h3 id="10-logstash-的多-if-分支案例"><a href="#10-logstash-的多-if-分支案例" class="headerlink" title="10.logstash 的多 if 分支案例"></a>10.logstash 的多 if 分支案例</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667403026999.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/22-beats_tcp-filter-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-beats"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
    tcp <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-tcp"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">9999</span>
    <span class="token punctuation">&#125;</span>
    tcp <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-tcp-new"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">7777</span>
    <span class="token punctuation">&#125;</span>
    http <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-http"</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6666</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">file</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-file"</span>
        path <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/apps.log"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"school"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京市昌平区沙河镇⽼男孩IT教育"</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token string">"oldboyedu-beats"</span>,<span class="token string">"oldboyedu-tcp-new"</span>,<span class="token string">"oldboyedu-http"</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
        mutate <span class="token punctuation">&#123;</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token string">"agent"</span>, <span class="token string">"host"</span>, <span class="token string">"@version"</span>, <span class="token string">"ecs"</span>,<span class="token string">"tags"</span>,<span class="token string">"input"</span>, <span class="token string">"log"</span> <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
        geoip <span class="token punctuation">&#123;</span>
            <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
            target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
        <span class="token punctuation">&#125;</span>
        useragent <span class="token punctuation">&#123;</span>
            <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"http_user_agent"</span>
            target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-file"</span> <span class="token punctuation">&#123;</span>
    	mutate <span class="token punctuation">&#123;</span>
            add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"class"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80"</span>
                <span class="token string">"address"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"北京昌平区沙河镇⽼男孩IT教育"</span>
                <span class="token string">"hobby"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"LOL"</span>,<span class="token string">"王者荣耀"</span><span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"host"</span>,<span class="token string">"@version"</span>,<span class="token string">"school"</span><span class="token punctuation">]</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        mutate <span class="token punctuation">&#123;</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"port"</span>,<span class="token string">"@version"</span>,<span class="token string">"host"</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
        mutate <span class="token punctuation">&#123;</span>
            <span class="token function">split</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"|"</span>
            <span class="token punctuation">&#125;</span>
            add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][1]&#125;"</span>
                <span class="token string">"action"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][2]&#125;"</span>
                <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][3]&#125;"</span>
                <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][4]&#125;"</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment"># 利⽤完message字段后，在删除是可以等!注意代码等执⾏顺序!</span>
            remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>
            strip <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"svip"</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
        mutate <span class="token punctuation">&#123;</span>
            convert <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"integer"</span>
                <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"boolean"</span>
                <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"float"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"oldboyedu-beats"</span> <span class="token punctuation">&#123;</span>
        elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-beats"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    	elasticsearch <span class="token punctuation">&#123;</span>
            hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
            index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-tcp"</span>
    	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/22-beats_tcp-filter-es.conf</code></pre>

<h3 id="11-今日作业-1"><a href="#11-今日作业-1" class="headerlink" title="11.今日作业"></a>11.今日作业</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667403459392.png"></p>
<pre class="language-none"><code class="language-none">如上图所示，要求完成以下内容:
(1)收集nginx⽇志，写⼊ES集群，分⽚数量为3，副本数量为0，索引名称为&quot;oldboyedu-linux80-nginx&quot;;
(2)收集tomcat⽇志，写⼊ES集群，分⽚数量为5，副本数量为0，索引名称为&quot;oldboyedu-linux80-tomcat&quot;;
(3)收集app⽇志，写⼊ES集群，分⽚数量为10，副本数量为0，索引名称为&quot;oldboyedu-linux80-app&quot;;
进阶作业:
(1)分析出nginx，tomcat的客户端ip所属城市，访问时使⽤的设备类型等。
(2)请调研使⽤logstash的pipline来替代logstash的多实例⽅案;</code></pre>

<h4 id="filebeat-手机-tomcat-日志"><a href="#filebeat-手机-tomcat-日志" class="headerlink" title="filebeat 手机 tomcat 日志"></a>filebeat 手机 tomcat 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat ~/config/38-tomcat-to-logstash.yml</span>
filebeat.inputs:
    - type: log
      enabled: <span class="token boolean">true</span>
      paths:
          - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt
      json.keys_under_root: <span class="token boolean">true</span>

output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:7777"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/38-tomcat-to-logstash.yml</code></pre>

<h4 id="filebeat-收集-nginx-日志"><a href="#filebeat-收集-nginx-日志" class="headerlink" title="filebeat 收集 nginx 日志"></a>filebeat 收集 nginx 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat ~/config/37-nginx-to-logstash.yml</span>
filebeat.inputs:
    - type: log
      enabled: <span class="token boolean">true</span>
      paths:
          - /var/log/nginx/access.log*
      json.keys_under_root: <span class="token boolean">true</span>

output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:8888"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/37-nginx-to-logstash.yml <span class="token parameter variable">--path.data</span> /tmp/filebeat-nginx</code></pre>

<h4 id="filebeat-收集-apps-日志"><a href="#filebeat-收集-apps-日志" class="headerlink" title="filebeat 收集 apps 日志"></a>filebeat 收集 apps 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat ~/config/39-apps-to-logstash.yml</span>
filebeat.inputs:
    - type: log
      enabled: <span class="token boolean">true</span>
      paths:
          - /tmp/app.log*
output.logstash:
    hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101:6666"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk102.oldboyedu.com ~<span class="token punctuation">]</span>$ filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> ~/config/39-apps-to-logstash.yml <span class="token parameter variable">--path.data</span> /tmp/filebeat-app</code></pre>

<h4 id="logstash-收集-nginx-日志"><a href="#logstash-收集-nginx-日志" class="headerlink" title="logstash 收集 nginx 日志"></a>logstash 收集 nginx 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/24-homework-01-to-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8888</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"tags"</span>,<span class="token string">"log"</span>,<span class="token string">"agent"</span>,<span class="token string">"@version"</span>, <span class="token string">"input"</span>,<span class="token string">"ecs"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
    <span class="token punctuation">&#125;</span>
    useragent <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"http_user_agent"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	elasticsearch <span class="token punctuation">&#123;</span>
		hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
		index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-nginx"</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># logstash -rf config-logstash/24-homework-01-to-es.conf</span></code></pre>

<h4 id="logstash-收集-tomcat-日志"><a href="#logstash-收集-tomcat-日志" class="headerlink" title="logstash 收集 tomcat 日志"></a>logstash 收集 tomcat 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/24-homework-02-to-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
        port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">7777</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"tags"</span>,<span class="token string">"log"</span>,<span class="token string">"agent"</span>,<span class="token string">"@version"</span>, <span class="token string">"input"</span>,<span class="token string">"ecs"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    geoip <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"clientip"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-geoip"</span>
    <span class="token punctuation">&#125;</span>
    useragent <span class="token punctuation">&#123;</span>
        <span class="token builtin class-name">source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"AgentVersion"</span>
        target <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-useragent"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-tomcat"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/24-homework-02-to-es.conf <span class="token parameter variable">--path.data</span> /tmp/homework-logstash-02</code></pre>

<h4 id="logstash-收集-apps-日志"><a href="#logstash-收集-apps-日志" class="headerlink" title="logstash 收集 apps 日志"></a>logstash 收集 apps 日志</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span><span class="token comment"># cat config-logstash/24-homework-03-to-es.conf</span>
input <span class="token punctuation">&#123;</span>
    beats <span class="token punctuation">&#123;</span>
    	port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6666</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
filter <span class="token punctuation">&#123;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"tags"</span>,<span class="token string">"log"</span>,<span class="token string">"agent"</span>,<span class="token string">"@version"</span>, <span class="token string">"input"</span>,<span class="token string">"ecs"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
    	remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"port"</span>,<span class="token string">"@version"</span>,<span class="token string">"host"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        <span class="token function">split</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"message"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"|"</span>
        <span class="token punctuation">&#125;</span>
        add_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][1]&#125;"</span>
            <span class="token string">"action"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][2]&#125;"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][3]&#125;"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"%&#123;[message][4]&#125;"</span>
        <span class="token punctuation">&#125;</span>
        remove_field <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>
        strip <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"svip"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
    mutate <span class="token punctuation">&#123;</span>
        convert <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
            <span class="token string">"user_id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"integer"</span>
            <span class="token string">"svip"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"boolean"</span>
            <span class="token string">"price"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"float"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	elasticsearch <span class="token punctuation">&#123;</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"10.0.0.101:9200"</span>,<span class="token string">"10.0.0.102:9200"</span>,<span class="token string">"10.0.0.103:9200"</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-apps"</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> config-logstash/24-homework-03-to-es.conf <span class="token parameter variable">--path.data</span> /tmp/homework-logstash-03</code></pre>

<h2 id="kibana-自定义-dashboard-实战案例"><a href="#kibana-自定义-dashboard-实战案例" class="headerlink" title="kibana 自定义 dashboard 实战案例"></a>kibana 自定义 dashboard 实战案例</h2><h3 id="1-统计-pv（指标）"><a href="#1-统计-pv（指标）" class="headerlink" title="1.统计 pv（指标）"></a>1.统计 pv（指标）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667405121451.png"></p>
<pre class="language-none"><code class="language-none">Page View(简称:&quot;PV&quot;)
	⻚⾯访问或点击量。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)新建可视化
    (4)基于聚合
    (5)指标
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中选择:
        聚合: 计数
        定制标签: PV</code></pre>

<h3 id="2-统计客户端-IP（指标）"><a href="#2-统计客户端-IP（指标）" class="headerlink" title="2.统计客户端 IP（指标）"></a>2.统计客户端 IP（指标）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407132063.png"></p>
<pre class="language-none"><code class="language-none">客户端IP:
	通常指的是访问Web服务器的客户端IP地址，但要注意，客户端IP数量并不难代表UV。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)指标
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中选择:
        聚合: 唯⼀计数
        字段: clientip.keyword
        定制标签: IP</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667407161985.png"></p>
<h3 id="3-统计-web-下载带宽（指标）"><a href="#3-统计-web-下载带宽（指标）" class="headerlink" title="3.统计 web 下载带宽（指标）"></a>3.统计 web 下载带宽（指标）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407232833.png"></p>
<pre class="language-none"><code class="language-none">带宽:
	统计nginx返回给客户端⽂件⼤⼩的字段进⾏累计求和。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)指标
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中选择:
        聚合: 求和
        字段: SendBytes
        定制标签: 带宽</code></pre>

<h3 id="4-访问页面统计（水平条形图）"><a href="#4-访问页面统计（水平条形图）" class="headerlink" title="4.访问页面统计（水平条形图）"></a>4.访问页面统计（水平条形图）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407385838.png"></p>
<pre class="language-none"><code class="language-none">访问资源统计:
	对URI的访问次数统计。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)⽔平条形图
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    定制标签: 访问量
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: uri.keyword
        ...
        定制标签: URI</code></pre>

<h3 id="5-分析客户端的城市分布（垂直条形图）"><a href="#5-分析客户端的城市分布（垂直条形图）" class="headerlink" title="5.分析客户端的城市分布（垂直条形图）"></a>5.分析客户端的城市分布（垂直条形图）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407440342.png"></p>
<pre class="language-none"><code class="language-none">分析客户端的城市分布:
	需要借助logstash的filter插件的geoip实现对客户端的IP地址进⾏地域解析。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)垂直条形图
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    定制标签: 城市分布
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: oldboyedu-linux80-nginx.city_name.keyword
        ...
        定制标签: 城市名称</code></pre>

<h3 id="6-城市分布百分比（饼图）"><a href="#6-城市分布百分比（饼图）" class="headerlink" title="6.城市分布百分比（饼图）"></a>6.城市分布百分比（饼图）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407492998.png"></p>
<pre class="language-none"><code class="language-none">分析客户端的城市分布:
	需要借助logstash的filter插件的geoip实现对客户端的IP地址进⾏地域解析。
kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)饼图
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    定制标签: 城市分布
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: oldboyedu-linux80-nginx.city_name.keyword
        ...
        定制标签: 城市名称</code></pre>

<h3 id="7-IP-的-TopN-统计（仪表盘）"><a href="#7-IP-的-TopN-统计（仪表盘）" class="headerlink" title="7.IP 的 TopN 统计（仪表盘）"></a>7.IP 的 TopN 统计（仪表盘）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407565612.png"></p>
<pre class="language-none"><code class="language-none">IP的TopN统计:
	统计访问量的客户端IP最⼤的是谁。

kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Visualize Library(可视化库);
    (3)创建可视化
    (4)基于聚合
    (5)仪表盘
    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)
    (7)指标栏中设置(即Y轴)
    聚合: 计数
    (8)添加&quot;存储痛&quot;，选择&quot;X&quot;轴
        聚合: 词
        字段: client.keyword
        顺序: 降序
        ⼤⼩: 3
        ...</code></pre>

<h3 id="8-自定义-dashboard"><a href="#8-自定义-dashboard" class="headerlink" title="8.自定义 dashboard"></a>8.自定义 dashboard</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407613789.png"></p>
<pre class="language-none"><code class="language-none">kibana界⾯⿏标依次点击如下:
    (1)菜单栏;
    (2)Dashboard
    (3)创建仪表盘
    (4)从可视化库中添加即可。

如上图和下图所示，为我添加到dashboard界⾯。</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667407635559.png"></p>
<h2 id="ElasticStack-二进制部署及排错"><a href="#ElasticStack-二进制部署及排错" class="headerlink" title="ElasticStack 二进制部署及排错"></a>ElasticStack 二进制部署及排错</h2><h3 id="1-部署-Oracle-JDK-环境"><a href="#1-部署-Oracle-JDK-环境" class="headerlink" title="1.部署 Oracle JDK 环境"></a>1.部署 Oracle JDK 环境</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667407713319.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 官⽅连接:		https://www.oracle.com/java/technologies/downloads/#java8</span>
<span class="token comment"># elk101单节点部署oracle jdk步骤:</span>
<span class="token comment"># (1)创建⼯作⽬录</span>
$ <span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /oldboyedu/softwares
<span class="token comment"># (2)解压JDK到指定的⽬录</span>
$ <span class="token function">tar</span> xf jdk-8u291-linux-x64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token comment"># (3)创建符号链接</span>
$ <span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> jdk1.8.0_291 jdk
<span class="token comment"># (4)创建环境变量</span>
$ <span class="token function">cat</span> <span class="token operator">></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/bin/bash
export JAVA_HOME=/oldboyedu/softwares/jdk
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$JAVA_HOME</span>/bin
EOF</span>

$ <span class="token builtin class-name">source</span> /etc/profile.d/elk.sh
<span class="token comment">#  (5)查看JDK的版本号</span>
$ <span class="token function">java</span> <span class="token parameter variable">-version</span>
<span class="token comment"># 集群部署还需要做下⾯2个步骤:</span>
<span class="token comment"># (1)同步jdk环境到其他节点</span>
$ data_rsync.sh /oldboyedu/
$ data_rsync.sh /etc/profile.d/elk.sh
<span class="token comment"># (2)其他节点测试</span>
$ <span class="token builtin class-name">source</span> /etc/profile.d/elk.sh
$ <span class="token function">java</span> <span class="token parameter variable">-version</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667407777709.png"></p>
<h3 id="2-单节点-ES-部署"><a href="#2-单节点-ES-部署" class="headerlink" title="2.单节点 ES 部署"></a>2.单节点 ES 部署</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)下载ES软件</span>
<span class="token comment"># 略，参考之前的视频。</span>

<span class="token comment"># (2)解压ES</span>
$ <span class="token function">tar</span> xf elasticsearch-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/

<span class="token comment"># (3)创建符号链接</span>
$ <span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> elasticsearch-7.17.3 es

<span class="token comment"># (4)配置环境变量</span>
$ <span class="token function">cat</span> <span class="token operator">>></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
export ES_HOME=/oldboyedu/softwares/es
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$ES_HOME</span>/bin
EOF</span>

$ <span class="token builtin class-name">source</span> /etc/profile.d/elk.sh

<span class="token comment"># (5)创建ES⽤户，⽤于运⾏ES服务</span>
$ <span class="token function">useradd</span> oldboyedu

<span class="token comment"># (6)修改配置⽂件</span>
$ <span class="token function">vim</span> /oldboyedu/softwares/es/config/elasticsearch.yml
<span class="token punctuation">..</span>.
cluster.name: oldboyedu-linux80-elk
network.host: <span class="token number">0.0</span>.0.0
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span><span class="token punctuation">]</span>
cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span><span class="token punctuation">]</span>

<span class="token comment"># (7)修改权限</span>
$ <span class="token function">chown</span> oldboyedu:oldboyedu <span class="token parameter variable">-R</span> /oldboyedu/softwares/elasticsearch-7.17.3/

<span class="token comment"># (8)修改⽂件打开数量的限制(退出当前会话⽴即⽣效)</span>
$ <span class="token function">cat</span> <span class="token operator">></span> /etc/security/limits.d/elk.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
* soft nofile 65535
* hard nofile 131070
EOF</span>

<span class="token comment"># (9)修改内核参数的内存映射信息</span>
$ <span class="token function">cat</span> <span class="token operator">></span> /etc/sysctl.d/elk.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
vm.max_map_count = 262144
EOF</span>
$ <span class="token function">sysctl</span> <span class="token parameter variable">-f</span> /etc/sysctl.d/elk.conf
$ <span class="token function">sysctl</span> <span class="token parameter variable">-q</span> vm.max_map_count

<span class="token comment"># (10)启动服务("-d"选项代表是后台启动服务.)</span>
$ <span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"elasticsearch"</span> oldboyedu
$ <span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"elasticsearch -d"</span> oldboyedu

<span class="token comment"># (11)验证服务</span>
$ <span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200
$ <span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200/_cat/nodes</code></pre>

<h3 id="3-修改-ES-的堆（heap）内存大小"><a href="#3-修改-ES-的堆（heap）内存大小" class="headerlink" title="3.修改 ES 的堆（heap）内存大小"></a>3.修改 ES 的堆（heap）内存大小</h3><pre class="language-none"><code class="language-none">前置知识:
    jps快速⼊⻔:
        作⽤:
        	查看java相关的进程信息。
        常⽤参数:
            -l: 显示包名称。
            -v: 显示进程的相信信息
            -V: 默认就是该选项，表示查看简要信息。
            -q: 只查看pid。

    jmap快速⼊⻔:
        作⽤:
        	查看java的堆栈信息。
        常⽤参数:
            -heap: 查看堆内存的⼤⼩。
            -dump: 下载堆内存的相关信息。

(1)修改堆内存⼤⼩
vim &#x2F;oldboyedu&#x2F;softwares&#x2F;es&#x2F;config&#x2F;jvm.options
...
# 堆内存设置不建议超过32G.
-Xms256m
-Xmx256m

(2)重启服务
kill &#96;jps | grep Elasticsearch | awk &#39;&#123;print $1&#125;&#39;&#96;
su -c &quot;elasticsearch -d&quot; oldboyedu

(3)验证堆内存的⼤⼩
jmap -heap &#96;jps | grep Elasticsearch | awk &#39;&#123;print $1&#125;&#39;&#96;

推荐阅读:
https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;7.17&#x2F;advanced-configuration.html#set-jvm-heap-size</code></pre>

<h3 id="4-ES-启动脚本编写"><a href="#4-ES-启动脚本编写" class="headerlink" title="4.ES 启动脚本编写"></a>4.ES 启动脚本编写</h3><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">></span> /usr/lib/systemd/system/es.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Oldboyedu linux80 ELK
After=network.target

[Service]
Type=forking
ExecStart=/oldboyedu/softwares/es/bin/elasticsearch -d
Restart=no
User=oldboyedu
Group=oldboyedu
LimitNOFILE=131070

[Install]
WantedBy=multi-user.target
EOF</span>

$ systemctl daemon-reload
$ systemctl restart es</code></pre>

<h3 id="5-部署-ES-集群"><a href="#5-部署-ES-集群" class="headerlink" title="5.部署 ES 集群"></a>5.部署 ES 集群</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)停⽌ES服务并删除集群之前的数据（如果是ES集群扩容就别删除数据了，我这⾥是部署⼀个"⼲净"的集群）</span>
systemctl stop es
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /oldboyedu/softwares/es/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span> /tmp/*
<span class="token function">install</span> <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyedu <span class="token parameter variable">-d</span> /oldboyedu/softwares/es/logs

<span class="token comment"># (2)创建数据和⽇志⽬录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /oldboyedu/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span>
<span class="token function">install</span> <span class="token parameter variable">-d</span> /oldboyedu/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span>/es7 <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyedu

<span class="token comment"># (3)修改配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/es/config/elasticsearch.yml
<span class="token punctuation">..</span>.
cluster.name: oldboyedu-linux80-elk
path.data: /oldboyedu/data/es7
path.logs: /oldboyedu/logs/es7
network.host: <span class="token number">0.0</span>.0.0
discovery.seed_hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span>,<span class="token string">"10.0.0.102"</span>,<span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>
cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span>,<span class="token string">"10.0.0.102"</span>,<span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>

<span class="token comment"># (4)elk101节点同步数据到其他节点</span>
data_rsync.sh /oldboyedu/
data_rsync.sh /etc/security/limits.d/elk.conf
data_rsync.sh /etc/sysctl.d/elk.conf
data_rsync.sh /usr/lib/systemd/system/es.service
data_rsync.sh /etc/profile.d/elk.sh

<span class="token comment"># (5)其他节点重连会话后执⾏以下操作</span>
<span class="token function">useradd</span> oldboyedu
<span class="token function">sysctl</span> <span class="token parameter variable">-f</span> /etc/sysctl.d/elk.conf
<span class="token function">sysctl</span> <span class="token parameter variable">-q</span> vm.max_map_count
systemctl daemon-reload

<span class="token comment"># (6)启动ES集群</span>
systemctl start es

<span class="token comment"># (7)验证ES的集群服务是否正常</span>
<span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200
<span class="token function">curl</span> <span class="token number">10.0</span>.0.101:9200/_cat/nodes</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408129949.png"></p>
<h3 id="6-部署-kibana-服务"><a href="#6-部署-kibana-服务" class="headerlink" title="6.部署 kibana 服务"></a>6.部署 kibana 服务</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667408158533.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)解压软件包</span>
<span class="token function">tar</span> xf kibana-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/

<span class="token comment"># (2)创建符号链接</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> kibana-7.17.3-linux-x86_64 kibana

<span class="token comment"># (3)配置环境变量</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
export KIBANA_HOME=/oldboyedu/softwares/kibana
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$KIBANA_HOME</span>/bin
EOF</span>

<span class="token builtin class-name">source</span> /etc/profile.d/elk.sh

<span class="token comment"># (4)修改⽂件全选</span>
<span class="token function">chown</span> oldboyedu:oldboyedu <span class="token parameter variable">-R</span> /oldboyedu/softwares/kibana-7.17.3-linux-x86_64/

<span class="token comment"># (5)修改配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/kibana/config/kibana.yml
<span class="token punctuation">..</span>.
server.host: <span class="token string">"0.0.0.0"</span>
server.name: <span class="token string">"oldboyedu-linux80-kibana"</span>
elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span>,<span class="token string">"http://10.0.0.102:9200"</span>,<span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
i18n.locale: <span class="token string">"zh-CN"</span>

<span class="token comment"># (6)启动服务</span>
<span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"kibana"</span> oldboyedu</code></pre>

<h3 id="7-部署-logstash"><a href="#7-部署-logstash" class="headerlink" title="7.部署 logstash"></a>7.部署 logstash</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)解压logstash</span>
<span class="token function">tar</span> xf logstash-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/

<span class="token comment"># (2)创建符号链接</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/ <span class="token operator">&amp;&amp;</span> <span class="token function">ln</span> <span class="token parameter variable">-sv</span> logstash-7.17.3 logstsash

<span class="token comment"># (3)配置环境变量</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/profile.d/elk.sh <span class="token operator">&lt;&lt;</span><span class="token string">EOF
export LOGSTASH_HOME=/oldboyedu/softwares/logstsash
export PATH=<span class="token environment constant">$PATH</span>:<span class="token variable">$LOGSTASH_HOME</span>/bin
EOF</span>

<span class="token builtin class-name">source</span> /etc/profile.d/elk.sh

<span class="token comment"># (4)编写测试案例</span>
<span class="token function">cat</span> <span class="token operator">></span> conf-logstash/01-stdin-to-stdout.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
input &#123;
    stdin &#123;&#125;
&#125;
output&#123;
    stdout &#123;&#125;
&#125;
EOF</span>

<span class="token comment"># (5)运⾏测试案例</span>
logstash <span class="token parameter variable">-f</span> conf-logstash/01-stdin-to-stdout.conf</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408245132.png"></p>
<h3 id="7-部署-filebeat"><a href="#7-部署-filebeat" class="headerlink" title="7.部署 filebeat"></a>7.部署 filebeat</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)解压软件包</span>
<span class="token function">tar</span> xf filebeat-7.17.3-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/filebeat-7.17.3-linux-x86_64
<span class="token function">mkdir</span> config-filebeat

<span class="token comment"># (2)编写配置⽂件</span>
<span class="token function">cat</span> <span class="token operator">></span> config-filebeat/01-stdin-to-console.yml <span class="token operator">&lt;</span>EOF
filebeat.inputs:
    - type: stdin
output.console:
    pretty: <span class="token boolean">true</span>
EOF

<span class="token comment"># (3)启动filebeat实例</span>
./filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> config-filebeat/01-stdin-to-console.yml</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408384164.png"></p>
<h3 id="8-部署-es-head-插件"><a href="#8-部署-es-head-插件" class="headerlink" title="8.部署 es-head 插件"></a>8.部署 es-head 插件</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667408419501.png"></p>
<pre class="language-none"><code class="language-none">(1)解压es-head组件的软件包
unzip es-head-0.1.4_0.crx.zip

(2)⾕歌浏览器导⼊软件包
设置 ---&gt; 扩展程序 ---&gt; 勾选&quot;开发者模式&quot; ---&gt; &quot;加载已经解压的扩展程序&quot; ---&gt; 选择&quot;上⼀步骤解压的⽬录&quot;</code></pre>

<h3 id="9-部署-postman-组件"><a href="#9-部署-postman-组件" class="headerlink" title="9.部署 postman 组件"></a>9.部署 postman 组件</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667408466932.png"></p>
<pre class="language-none"><code class="language-none">(1)下载postman组件
https:&#x2F;&#x2F;www.postman.com&#x2F;downloads&#x2F;

(2)post的使⽤
后续讲解。</code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667408482877.png"></p>
<h3 id="10-今⽇作业"><a href="#10-今⽇作业" class="headerlink" title="10.今⽇作业"></a>10.今⽇作业</h3><pre class="language-none"><code class="language-none">(1)完成课堂的所有练习
(2)完善kibana的启动脚本，使⽤systemctl⼯具管理kibana并设置为开机⾃启动;

进阶作业:
	调研logstash的多pipline编写。</code></pre>

<h2 id="ElasticSearch-的-Restful-风格-API-实战"><a href="#ElasticSearch-的-Restful-风格-API-实战" class="headerlink" title="ElasticSearch 的 Restful 风格 API 实战"></a>ElasticSearch 的 Restful 风格 API 实战</h2><h3 id="1-Restful-及-JSON-格式"><a href="#1-Restful-及-JSON-格式" class="headerlink" title="1.Restful 及 JSON 格式"></a>1.Restful 及 JSON 格式</h3><table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>字符串</td>
<td>要求使⽤双引号（””）引起来的数据</td>
<td>“oldboyedu”</td>
</tr>
<tr>
<td>数字</td>
<td>通常指的是 0-9 的所有数字。</td>
<td>100</td>
</tr>
<tr>
<td>布尔值</td>
<td>只有 true 和 false 两个值</td>
<td>true</td>
</tr>
<tr>
<td>空值</td>
<td>只有 null 一个值</td>
<td>null</td>
</tr>
<tr>
<td>数组</td>
<td>使⽤⼀对中括号（”[]”）放⼊不同的元素（⽀持⾼级数据类型和基础数据类型）</td>
<td>[“linux”,100,false]</td>
</tr>
<tr>
<td>对象</td>
<td>使⽤⼀对⼤括号（”{}”）扩起来，⾥⾯的数据使⽤ KEY-VALUE 键值对即可。</td>
<td>{“class”:”linux80”,”age”:25}</td>
</tr>
</tbody></table>
<pre class="language-none"><code class="language-none">Restful⻛格程序:
	RESTFUL是⼀种⽹络应⽤程序的设计⻛格和开发⽅式，基于HTTP，可以使⽤XML格式定义或
JSON格式定义。
	REST（英⽂：Representational State Transfer，简称REST）描述了⼀个架构样式的⽹络系统，⽐如 web 应⽤程序。
	REST⾸次出现在2000年Roy Fielding的博⼠论⽂中，Roy Fielding是HTTP规范的主要编写者之⼀。

JSON语法:
    基础数据类型:
        字符串:
            &quot;oldboyedu&quot;
            &quot;⽼男孩IT教育&quot;
            &quot;2022&quot;
            &quot;&quot;
    数字:
        0
        1
        2
        ...
    布尔值:
        true
        false
    空值:
        null

    ⾼级数据类型:
        数组:
        	[&quot;oldboyedu&quot;,&quot;沙河&quot;,2022,null,true,&#123;&quot;school&quot;:&quot;oldboyedu&quot;,&quot;class&quot;:&quot;linux80&quot;&#125;]
        对象:
        	&#123;&quot;name&quot;:&quot;oldboy&quot;, &quot;age&quot;:40, &quot;address&quot;:&quot;北京沙河&quot;, &quot;hobby&quot;:[&quot;Linux&quot;,&quot;思想课&quot;],&quot;other&quot;:null&#125;

课堂练习:
	使⽤json格式记录你的名字(name),年龄(age),学校(school),爱好(hobby),地址(address)。</code></pre>

<h3 id="2-ElasticSearch-的相关术语"><a href="#2-ElasticSearch-的相关术语" class="headerlink" title="2.ElasticSearch 的相关术语"></a>2.ElasticSearch 的相关术语</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667409049243.png"></p>
<pre class="language-none"><code class="language-none">Document:
	即⽂档，是⽤户存储在ES的⼀些数据，它是ES中最⼩的存储单元。换句话说，⼀个⽂档是不可被拆分的。
	⼀个⽂档使⽤的是json的对象数据类型存储。
filed:
	相当于数据库表的字段，对⽂档数据根据不同属性进⾏分类标示。
index:
	即索引，⼀个索引就是⼀个拥有相似特征⽂档的集合。
shard:
	即分⽚，是真正存储数据的地⽅，每个分⽚底层对应的是⼀个Lucene库。⼀个索引⾄少有1个或多个分⽚。
replica:
	即副本，是对数据的备份，⼀个分⽚可以有0个或多个副本。
	⼀旦副本数量不为0，就会引⼊主分⽚(primary shard)和副本分⽚(replica shard)的概念。
		主分⽚(primary shard):
			可以实现数据的读写操作。
		副本分⽚(replica shard):
			可以实现数据读操作，与此同时，需要去主分⽚同步数据，当主分⽚挂掉，副本分⽚会变为主分⽚。
Allocation:
	即分配，将分⽚(shard)分配给某个节点的过程，包括主分⽚和副本分⽚。
	如果是副本分⽚，还包含从主分⽚复制数据的过程，这个分配过程由master节点调度完成。
Type:
	在es 5.x即更早的版本，在⼀个索引中，我们可以定义⼀种或多种数据类型。但在es7仅⽀持&quot;_doc&quot;类型。</code></pre>

<h3 id="3-管理索引的-API"><a href="#3-管理索引的-API" class="headerlink" title="3.管理索引的 API"></a>3.管理索引的 API</h3><h4 id="3-1-查看索引信息"><a href="#3-1-查看索引信息" class="headerlink" title="3.1 查看索引信息"></a>3.1 查看索引信息</h4><pre class="language-none"><code class="language-none">GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;_cat&#x2F;indices		# 查看全部的索引信息
GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;_cat&#x2F;indices?v	# 查看表头信息
GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;_cat&#x2F;indices&#x2F;.kibana_7.17.3_001?v	# 查看单个索引
GET http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;.kibana_7.17.3_001	# 查看单个索引的详细信息</code></pre>

<h4 id="3-2-创建索引"><a href="#3-2-创建索引" class="headerlink" title="3.2 创建索引"></a>3.2 创建索引</h4><pre class="language-none"><code class="language-none">PUT http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux82 # 创建索引并指定分⽚和副本
&#123;
    &quot;settings&quot;: &#123;
        &quot;index&quot;: &#123;
            &quot;number_of_shards&quot;: &quot;3&quot;,
            &quot;number_of_replicas&quot;: 0
        &#125;
    &#125;
&#125;

参数说明:
	&quot;number_of_shards&quot;:		指定分⽚数量。
	&quot;number_of_replicas&quot;:	指定副本数量。</code></pre>

<h4 id="3-3-修改索引"><a href="#3-3-修改索引" class="headerlink" title="3.3 修改索引"></a>3.3 修改索引</h4><pre class="language-none"><code class="language-none">PUT http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux80&#x2F;_settings
&#123;
	&quot;number_of_replicas&quot;: 0
&#125;

温馨提示:
	分⽚数量⽆法修改，副本数量是可以修改的。</code></pre>

<h4 id="3-4-删除索引"><a href="#3-4-删除索引" class="headerlink" title="3.4 删除索引"></a>3.4 删除索引</h4><pre class="language-none"><code class="language-none">DELETE http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux80

温馨提示:
	删除索引，服务器的数据也会随之删除哟!</code></pre>

<h4 id="3-5-索引别名"><a href="#3-5-索引别名" class="headerlink" title="3.5 索引别名"></a>3.5 索引别名</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/_aliases 	<span class="token comment"># 添加索引别名</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"actions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"add"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"Linux容器运维"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token punctuation">&#123;</span>
            <span class="token string">"add"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux82"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"DBA"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/_aliases <span class="token comment"># 查看索引别名</span>

POST http://10.0.0.101:9200/_aliases <span class="token comment"># 删除索引别名</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"actions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"remove"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"Linux容器运维"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_aliases <span class="token comment"># 修改索引别名</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"actions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"remove"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux82"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"DBA"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token punctuation">&#123;</span>
            <span class="token string">"add"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux82"</span>,
                <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"SRE"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="3-6-索引关闭"><a href="#3-6-索引关闭" class="headerlink" title="3.6 索引关闭"></a>3.6 索引关闭</h4><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-linux80&#x2F;_close	# 关闭索引
POST http:&#x2F;&#x2F;10.0.0.101:9200&#x2F;oldboyedu-*&#x2F;_close			# 基于通配符关闭索引

温馨提示:
	索引关闭意味着该索引⽆法进⾏任何的读写操作，但数据并不会被删除。</code></pre>

<h4 id="3-7-索引打开"><a href="#3-7-索引打开" class="headerlink" title="3.7 索引打开"></a>3.7 索引打开</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/oldboyedu-linux80/_open		<span class="token comment"># 打开索引</span>
POST http://10.0.0.101:9200/oldboyedu-*/_open			<span class="token comment"># 基于通配符打开索引</span></code></pre>

<h4 id="3-8-索引的其他操作"><a href="#3-8-索引的其他操作" class="headerlink" title="3.8 索引的其他操作"></a>3.8 索引的其他操作</h4><p>推荐阅读: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html</a></p>
<h3 id="4-管理文档的-API"><a href="#4-管理文档的-API" class="headerlink" title="4.管理文档的 API"></a>4.管理文档的 API</h3><h4 id="4-1-文档的创建"><a href="#4-1-文档的创建" class="headerlink" title="4.1 文档的创建"></a>4.1 文档的创建</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/teacher/_doc	<span class="token comment"># 创建⽂档不指定"_id"</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"Linux"</span>,
        <span class="token string">"思想课"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/student/_doc/1003	<span class="token comment"># 创建⽂档并指定ID</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"苍⽼师"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"家庭主妇"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="4-2-文档的查看"><a href="#4-2-文档的查看" class="headerlink" title="4.2 文档的查看"></a>4.2 文档的查看</h4><pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/teacher/_search	<span class="token comment"># 查看所有的⽂档</span>
GET http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6	<span class="token comment"># 查看某⼀个⽂档</span>
HEAD http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6	<span class="token comment"># 判断某⼀个⽂档是否存在，返回200，404.</span>

温馨提示:
    源数据:
    	指的是⽤户写⼊的数据。
    元数据:
    	指的是描述数据的数据，由ES内部维护。</code></pre>

<h4 id="4-3-文档的修改"><a href="#4-3-文档的修改" class="headerlink" title="4.3 文档的修改"></a>4.3 文档的修改</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6	<span class="token comment"># 全量更新，会覆盖原有的⽂档数据内容。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"Linux"</span>,
        <span class="token string">"思想课"</span>,
        <span class="token string">"抖⾳"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
POST http://10.0.0.101:9200/teacher/_doc/4FHB0IABf2fC857QLdH6/_update	<span class="token comment"># 局部更新，并不会覆盖原有的数据。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"doc"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"⽼男孩"</span>,
        <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">45</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="4-4-文档的删除"><a href="#4-4-文档的删除" class="headerlink" title="4.4 文档的删除"></a>4.4 文档的删除</h4><pre class="language-bash" data-language="bash"><code class="language-bash">DELETE http://10.0.0.101:9200/teacher/_doc/1001</code></pre>

<h4 id="4-5-文档的批量操作"><a href="#4-5-文档的批量操作" class="headerlink" title="4.5 文档的批量操作"></a>4.5 文档的批量操作</h4><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 批量创建</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,<span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"Linux"</span>,<span class="token string">"思想课"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,<span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token number">1002</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"振亚"</span>,<span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"妹⼦"</span>,<span class="token string">"吃⾯"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,<span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token number">1001</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"苍⽼师"</span>,<span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"家庭主妇"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 批量删除</span>
<span class="token punctuation">&#123;</span> <span class="token string">"delete"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>, <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1001"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"delete"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>, <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1002"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 批量修改</span>
<span class="token punctuation">&#123;</span> <span class="token string">"update"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1001"</span>, <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"doc"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"CangLaoShi"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"update"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1002"</span>, <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"doc"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"ZhenYa"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_mget	<span class="token comment"># 批量查看</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"docs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,
            <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1001"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token punctuation">&#123;</span>
            <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span>,
            <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1002"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示: 对于⽂档的批量写操作，需要使⽤<code>_bulk</code>的 API，⽽对于批量的读操作，需要使⽤<code>_mget</code>的 API。</p>
<p>参考链接:</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-bulk.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-bulk.html</a><br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-multi-get.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-multi-get.html</a></p>
<h4 id="4-6-课堂的练习"><a href="#4-6-课堂的练习" class="headerlink" title="4.6 课堂的练习"></a>4.6 课堂的练习</h4><p>将下⾯的数据存储到 ES 集群：</p>
<pre class="language-none"><code class="language-none">&#123;&quot;name&quot;:&quot;oldboy&quot;,&quot;hobby&quot;:[&quot;Linux&quot;,&quot;思想课&quot;]&#125;
&#123;&quot;name&quot;:&quot;振亚&quot;,&quot;hobby&quot;:[&quot;妹⼦&quot;,&quot;吃⾯&quot;]&#125;
&#123;&quot;name&quot;:&quot;苍⽼师&quot;,&quot;hobby&quot;:[&quot;家庭主妇&quot;]&#125;</code></pre>

<h3 id="5-使用映射（mapping）自定义数据类型"><a href="#5-使用映射（mapping）自定义数据类型" class="headerlink" title="5.使用映射（mapping）自定义数据类型"></a>5.使用映射（mapping）自定义数据类型</h3><h4 id="5-1-映射的数据类型"><a href="#5-1-映射的数据类型" class="headerlink" title="5.1 映射的数据类型"></a>5.1 映射的数据类型</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667447917074.png"></p>
<p>当写⼊⽂档时，字段的数据类型会被 ES 动态⾃动创建，但有的时候动态创建的类型并符合我们的需求。这个时候就可以使⽤映射解决。</p>
<p>使⽤映射技术，可以对 ES ⽂档的字段类型提前定义我们期望的数据类型，便于后期的处理和搜索。</p>
<ul>
<li>text: 全⽂检索，可以被全⽂匹配，即该字段是可以被拆分的。</li>
<li>keyword: 精确匹配，必须和内容完全匹配，才能被查询出来。</li>
<li>ip: ⽀持 Ipv4 和 Ipv6，将来可以对该字段类型进⾏ IP 地址范围搜索。</li>
</ul>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/mapping-types.html</a></p>
<h4 id="5-2-IP-案例"><a href="#5-2-IP-案例" class="headerlink" title="5.2 IP 案例"></a>5.2 IP 案例</h4><pre class="language-bash" data-language="bash"><code class="language-bash">PUT http://10.0.0.101:9200/oldboyedu-linux80-elk	<span class="token comment"># 创建索引时指定映射关系</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"mappings"</span> :<span class="token punctuation">&#123;</span>
        <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            	<span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"ip"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk	<span class="token comment"># 查看索引的映射关系</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 创建测试数据</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.10.101"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.10.201"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"172.31.10.100"</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"10.0.0.222"</span> <span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk/_search	<span class="token comment"># 查看IP的⽹断</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.0/16"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="5-3-其他类型类型案例"><a href="#5-3-其他类型类型案例" class="headerlink" title="5.3 其他类型类型案例"></a>5.3 其他类型类型案例</h4><pre class="language-bash" data-language="bash"><code class="language-bash">PUT http://10.0.0.101:9200/oldboyedu-linux80-elk-2022	<span class="token comment"># 创建索引</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022<span class="token comment"># 查看索引信息</span>

PUT http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_mapping	<span class="token comment"># 为已创建的索引修改数据类型</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"gender"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"telephone"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>,
            <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"email"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"ip"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_bulk	<span class="token comment"># 添加测试数据</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.10.101"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"柳鹏"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"男性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"33333333"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"沙河"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"liupeng@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.20.21"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王岩"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"男性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"55555"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"松兰堡"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"wangyan@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"172.28.30.101"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"赵嘉欣"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"⼥性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"33333333"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"于⾟庄"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"zhaojiaxin@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"172.28.50.121"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"庞冉"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"⼥性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"444444444"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"于⾟庄"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"pangran@oldboyedu.com"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"create"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span> <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-linux80-elk-2022"</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span> <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"10.0.0.67"</span> ,<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王浩任"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"男性的"</span>,<span class="token string">"telephone"</span><span class="token builtin class-name">:</span><span class="token string">"22222222"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"松兰堡"</span>,<span class="token string">"email"</span><span class="token builtin class-name">:</span><span class="token string">"wanghaoren@oldboyedu.com"</span><span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于gender字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"gender"</span><span class="token builtin class-name">:</span> <span class="token string">"⼥"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于name字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于email字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"email"</span><span class="token builtin class-name">:</span> <span class="token string">"pangran@oldboyedu.com"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于ip_addr字段搜索</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.0/16"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
GET http://10.0.0.101:9200/oldboyedu-linux80-elk-2022/_search	<span class="token comment"># 基于address字段搜索，⽆法完成。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token string">"松兰堡"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="6-IK-中文分词器"><a href="#6-IK-中文分词器" class="headerlink" title="6. IK 中文分词器"></a>6. IK 中文分词器</h3><h4 id="6-1-内置的标准分词器-分析英文"><a href="#6-1-内置的标准分词器-分析英文" class="headerlink" title="6.1 内置的标准分词器 - 分析英文"></a>6.1 内置的标准分词器 - 分析英文</h4><pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"My name is Jason Yin, and I'm 18 years old !"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示: 标准分词器模式使⽤空格和符号进⾏切割分词的。</p>
<h4 id="6-2-内置的标准分词器-分析中文并不友好"><a href="#6-2-内置的标准分词器-分析中文并不友好" class="headerlink" title="6.2 内置的标准分词器 - 分析中文并不友好"></a>6.2 内置的标准分词器 - 分析中文并不友好</h4><pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"我爱北京天安⻔!"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示: 标准分词器默认使⽤单个汉⼦进⾏切割，很明显，并不符合我们国内的使⽤习惯。</p>
<h4 id="6-3-安装-IK-分词器"><a href="#6-3-安装-IK-分词器" class="headerlink" title="6.3 安装 IK 分词器"></a>6.3 安装 IK 分词器</h4><p><img data-src="//img.to2b.cn/blog/lujinkai/1667448439377.png"></p>
<p>下载地址: <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>安装 IK 分词器：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">install</span> <span class="token parameter variable">-d</span> /oldboyedu/softwares/es/plugins/ik <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyed
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/es/plugins/ik
<span class="token function">unzip</span> elasticsearch-analysis-ik-7.17.3.zip
<span class="token function">rm</span> <span class="token parameter variable">-f</span> elasticsearch-analysis-ik-7.17.3.zip
<span class="token function">chown</span> <span class="token parameter variable">-R</span> oldboyedu:oldboyedu *</code></pre>

<p>重启 ES 节点，使之加载插件：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">systemctl restart es</code></pre>

<p>测试 IK 分词器：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">GET http://10.0.0.101:9200/_analyze		<span class="token comment"># 细粒度拆分</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_max_word"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"我爱北京天安⻔!"</span>
<span class="token punctuation">&#125;</span>

GET http://10.0.0.101:9200/_analyze		<span class="token comment"># 粗粒度拆分</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_smart"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"我爱北京天安⻔!"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="6-4-自定义-IK-分词器的字典"><a href="#6-4-自定义-IK-分词器的字典" class="headerlink" title="6.4 自定义 IK 分词器的字典"></a>6.4 自定义 IK 分词器的字典</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)进⼊到IK分词器的插件安装⽬录</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/es/plugins/ik/config

<span class="token comment"># (2)⾃定义字典</span>
<span class="token function">cat</span> <span class="token operator">></span> oldboyedu-linux80.dic <span class="token operator">&lt;&lt;</span><span class="token string">EOF
上号
德玛⻄亚
艾欧尼亚
亚索
EOF</span>

<span class="token function">chown</span> oldboyedu:oldboyedu oldboyedu-linux80.dic

<span class="token comment"># (3)加载⾃定义字典</span>
<span class="token function">vim</span> IKAnalyzer.cfg.xml
<span class="token punctuation">..</span>.
<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">"ext_dict"</span><span class="token operator">></span>oldboyedu-linux80.dic<span class="token operator">&lt;</span>/entry<span class="token operator">></span>

<span class="token comment"># (4)重启ES集群</span>
systemctl restart es

<span class="token comment"># (5)测试分词器</span>
GET http://10.0.0.101:9200/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_smart"</span>,
    <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token string">"嗨，哥们! 上号，我德玛⻄亚和艾欧尼亚都有号! 我亚索贼6，肯定能带你⻜!!!"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="6-5-自定义分词器-了解即可"><a href="#6-5-自定义分词器-了解即可" class="headerlink" title="6.5 自定义分词器 - 了解即可"></a>6.5 自定义分词器 - 了解即可</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)⾃定义分词器</span>
PUT http://10.0.0.101:9200/oldboyedu_linux80_2022
<span class="token punctuation">&#123;</span>
    <span class="token string">"settings"</span>:<span class="token punctuation">&#123;</span>
        <span class="token string">"analysis"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"char_filter"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"&amp;_to_and"</span>:<span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"mapping"</span>,
                    <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"&amp; => and"</span><span class="token punctuation">]</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"filter"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"my_stopwords"</span>:<span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"stop"</span>,
                    <span class="token string">"stopwords"</span>:<span class="token punctuation">[</span><span class="token string">"the"</span>,<span class="token string">"a"</span>,<span class="token string">"if"</span>,<span class="token string">"are"</span>,<span class="token string">"to"</span>,<span class="token string">"be"</span>,<span class="token string">"kind"</span><span class="token punctuation">]</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"analyzer"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"my_analyzer"</span>:<span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token builtin class-name">:</span><span class="token string">"custom"</span>,
                    <span class="token string">"char_filter"</span>:<span class="token punctuation">[</span><span class="token string">"html_strip"</span>,<span class="token string">"&amp;_to_and"</span><span class="token punctuation">]</span>,
                    <span class="token string">"tokenizer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>,
                    <span class="token string">"filter"</span>:<span class="token punctuation">[</span><span class="token string">"lowercase"</span>,<span class="token string">"my_stopwords"</span><span class="token punctuation">]</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># (2)验证置⾃定义分词器是否⽣效</span>
GET http://10.0.0.101:9200/oldboyedu_linux80_2022/_analyze
<span class="token punctuation">&#123;</span>
    <span class="token string">"text"</span><span class="token builtin class-name">:</span><span class="token string">"If you are a PERSON, Please be kind to small Animals."</span>,
    <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span><span class="token string">"my_analyzer"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="7-今日作业"><a href="#7-今日作业" class="headerlink" title="7. 今日作业"></a>7. 今日作业</h3><pre class="language-none"><code class="language-none">(1)将&quot;shopping.json&quot;⽂件的内容使⽤&quot;_bulk&quot;的API批量写⼊ES集群，要求索引名称为&quot;oldboyedu-shopping&quot;;

(2)每⼈收集10条数据并写⼊ES集群，索引名称为&quot;oldboyedu-linux80&quot;</code></pre>

<h4 id="7-1-shopping-json"><a href="#7-1-shopping-json" class="headerlink" title="7.1 shopping.json"></a>7.1 shopping.json</h4><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"戴尔（DELL）31.5英⼨ 4K 曲⾯ 内置⾳箱 低蓝光 影院级⾊彩 FreeSync技术 可壁挂 1800R 电脑显示器 S3221QS"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">3399.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"Dell"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"15.25kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100014940686.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"三星（SAMSUNG）28英⼨ 4K IPS 10.7亿⾊ 90%DCI-P3 Eyecomfort2.0认证 专业设计制图显示器（U28R550UQC）"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">2099.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"SAMSUNG"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"7.55kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100009558656.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"ALIENWARE外星⼈新品外设⾼端键⿏套装AW510K机械键盘cherry轴RGB/AW610M 610M ⽆线⿏标+510K机械键盘+510H⽿机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">6000.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"ALIENWARE外星⼈"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10030370257612.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"樱桃CHERRY MX8.0彩光87键游戏机械键盘合⾦⼥⽣樱粉⾊版 彩光-粉⾊红轴-粉⾊箱 官⽅标配"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4066.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"樱桃CHERRY"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10024385308012.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"罗技（G）G610机械键盘 有线机械键盘 游戏机械键盘 全尺⼨背光机械键盘 吃鸡键盘 Cherry红轴"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">429.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"罗技"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.627kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/3378484.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"美商海盗船（USCORSAIR）K68机械键盘⿊⾊ 防⽔防尘樱桃轴体 炫彩背光游戏有线 红光红轴"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">499.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"美商海盗船"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.41kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/43580479783.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"雷蛇(Razer) 蝰蛇标准版 ⿏标 有线⿏标 游戏⿏标 ⼈体⼯程学 电竞 ⿊⾊6400DPI lol吃鸡神器cf"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">109.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"雷蛇"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"185.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/8141909.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"罗技（G）G502 HERO主宰者有线⿏标 游戏⿏标 HERO引擎 RGB⿏标 电竞⿏标 25600DPI"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">299.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"罗技"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"250.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100001691967.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"武极 i5 10400F/GTX1050Ti/256G游戏台式办公电脑主机DIY组装机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4099.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"武极"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"5.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/1239166056.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"变异者 组装电脑主机DIY台式游戏 i5 9400F/16G/GTX1050Ti 战胜G1"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4299.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"变异者"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"9.61kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/41842373306.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"宏碁(Acer) 暗影骑⼠·威N50-N92 英特尔酷睿i5游戏台机 吃鸡电脑主机(⼗⼀代i5-11400F 16G 256G+1T GTX1650)"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">5299.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"宏碁"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"7.25kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100020726324.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"京天 酷睿i7 10700F/RTX2060/16G内存 吃鸡游戏台式电脑主机DIY组装机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">7999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"京天"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"10.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/40808512828.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"戴尔（DELL）OptiPlex 3070MFF/3080MFF微型台式机电脑迷你⼩主机客厅HTPC 标配 i5-10500T/8G/1T+256G 内置WiFi+蓝⽛ 全国联保 三年上⻔"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">3999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"DELL"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"2.85kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10025304273651.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"伊萌纯种英短蓝⽩猫活体猫咪幼猫活体英国短⽑猫矮脚猫英短蓝猫幼体银渐层蓝⽩活体宠物蓝猫幼崽猫咪宠物猫短 双⾎统A级 ⺟"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4000.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"英短"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10027188382742.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"柴墨 ⾦渐层幼猫英短猫宠物猫英短⾦渐层猫咪活体猫活体纯种⼩猫银渐层 双⾎统"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">12000.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"英短"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"3.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10029312412476.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Redmi Note10 Pro 游戏智能5G⼿机 ⼩⽶ 红⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">9999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"10.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100021970002.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"【⼆⼿99新】⼩⽶Max3⼿机⼆⼿⼿机 ⼤屏安卓 曜⽯⿊ 6G+128G 全⽹通"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1046.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"0.75kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/35569092038.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"现货速发（10天价保）⼩⽶11 5G⼿机 骁⻰888 游戏智能⼿机 PRO店内可选⿊⾊ 套装版 12GB+256GB"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4699.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"0.7kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10025836790851.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"⼩⽶⼿环6 NFC版 全⾯彩屏 30种运动模式 24h⼼率检测 50⽶防⽔ 智能⼿环"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">279.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"⼩⽶"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"65.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100019867468.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"HUAWEI MateView⽆线原⾊显示器⽆线版 28.2英⼨ 4K+ IPS 98% DCI-P310.7亿⾊ HDR400 TypeC 双扬声器 双MIC"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4699.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"9.8kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100021420806.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"华为nova7se/nova7 se 5G⼿机（ 12期免息可选 ）下单享好礼 绮境森林乐活版 8G+128G（1年碎屏险）"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">2999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"500.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10029312412476.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"华为HUAWEI FreeBuds 4i主动降噪 ⼊⽿式真⽆线蓝⽛⽿机/通话降噪/⻓续航/⼩巧舒适 Android&amp;ios通⽤ 陶瓷⽩"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">479.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"137.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100018510746.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"HUAWEI WATCH GT2 华为⼿表 运动智能⼿表 两周⻓续航/蓝⽛通话/⾎氧检测/麒麟芯⽚ 华为gt2 46mm 曜⽯⿊"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1488.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华为"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"335.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100008492922.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Apple苹果12 mini iPhone 12 mini 5G ⼿机（现货速发 12期免息可选）蓝⾊ 5G版 64G"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4699.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"280.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10026100075337.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Apple iPhone 12 (A2404) 128GB 紫⾊ ⽀持移动联通电信5G 双卡双待⼿机"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">6799.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"330.00g"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100011203359.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"华硕ROG冰刃双屏 ⼗代英特尔酷睿 15.6英⼨液⾦导热300Hz电竞游戏笔记本电脑 i9-10980H 32G 2T RTX2080S"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">48999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"华硕"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"2.5kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10021558215658.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"联想⼩新Air15 2021超轻薄笔记本电脑 ⾼⾊域学⽣办公设计师游戏本 ⼋核锐⻰R7-5700U 16G内存 512G固态 升级15.6英⼨IPS全⾯屏【DC调光护眼⽆闪烁】"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">5499.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"10.0kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/33950552707.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"苹果（Apple）MacBook Air 13.3英⼨ 笔记本电脑 【2020款商务灰】⼗代i7 16G 512G 官⽅标配 19点前付款当天发货"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">10498.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"苹果"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.29kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/10021130510120.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"科⼤讯⻜机器⼈ 阿尔法蛋A10智能机器⼈ 专业教育⼈⼯智能编程机器⼈学习机智能可编程 ⽩⾊"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">1099.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"科⼤讯⻜"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"1.7kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100005324258.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"robosen乐森机器⼈六⼀⼉童节礼物⾃营孩⼦玩具星际特⼯智能编程机器⼈⼉童语⾳控制陪伴益智变形机器⼈"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">2499.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"senpowerT9-X"</span><span class="token punctuation">,</span>
	<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token string">"3.01kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100006740372.html"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
	<span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"优必选（UBTECH）悟空智能语⾳监控对话⼈形机器⼈⼉童教育陪伴早教学习机玩具"</span><span class="token punctuation">,</span>
	<span class="token property">"price"</span><span class="token operator">:</span> <span class="token number">4999.00</span><span class="token punctuation">,</span>
	<span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"优必选悟空"</span><span class="token punctuation">,</span>
	<span class="token property">"weigth"</span><span class="token operator">:</span> <span class="token string">"1.21kg"</span><span class="token punctuation">,</span>
	<span class="token property">"item"</span><span class="token operator">:</span> <span class="token string">"https://item.jd.com/100000722348.html"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="7-2-oldboyedu-linux80-json"><a href="#7-2-oldboyedu-linux80-json" class="headerlink" title="7.2 oldboyedu-linux80.json"></a>7.2 oldboyedu-linux80.json</h4><pre class="language-none"><code class="language-none">等你来完善...

要求如下:
	(1)收集源数据，要求包含&quot;title&quot;,&quot;price&quot;,&quot;brand&quot;,&quot;weigth&quot;,&quot;item&quot;,&quot;producer&quot;;
    &quot;title&quot;		商品的标题。
    &quot;price&quot;		商品的价格。
    &quot;brand&quot;		商品的品牌。
    &quot;weigth&quot;	商品的重量。
    &quot;item&quot;		商品的链接。
    &quot;producer&quot;	收集者姓名。

	(2)要求使⽤ES的批量操作的API完成;</code></pre>

<h5 id="参考案例-1"><a href="#参考案例-1" class="headerlink" title="参考案例 1"></a>参考案例 1</h5><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_bulk
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;戴尔（DELL）31.5英⼨ 4K 曲⾯ 内置⾳箱 低蓝光 影院级⾊彩 FreeSync技术 可壁挂 1800R 电脑显示器 S3221QS&quot;,&quot;price&quot;:3399.00,&quot;brand&quot;:&quot;Dell&quot;,&quot;weight&quot;:&quot;15.25kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100014940686.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;三星（SAMSUNG）28英⼨ 4K IPS 10.7亿⾊ 90%DCI-P3 Eyecomfort2.0认证 专业设计制图显示器（U28R550UQC）&quot;,&quot;price&quot;:2099.00,&quot;brand&quot;:&quot;SAMSUNG&quot;,&quot;weight&quot;:&quot;7.55kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100009558656.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;ALIENWARE外星⼈新品外设⾼端键⿏套装AW510K机械键盘cherry轴RGB&#x2F;AW610M 610M ⽆线⿏标+510K机械键盘+510H⽿机&quot;,&quot;price&quot;:6000.00,&quot;brand&quot;:&quot;ALIENWARE外星⼈&quot;,&quot;weight&quot;:&quot;1.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10030370257612.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;樱桃CHERRY MX8.0彩光87键游戏机械键盘合⾦⼥⽣樱粉⾊版 彩光-粉⾊红轴-粉⾊箱 官⽅标配&quot;,&quot;price&quot;:4066.00,&quot;brand&quot;:&quot;樱桃CHERRY&quot;,&quot;weight&quot;:&quot;1.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10024385308012.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;罗技（G）G610机械键盘 有线机械键盘 游戏机械键盘 全尺⼨背光机械键盘 吃技&quot;,&quot;weight&quot;:&quot;1.627kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;3378484.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;美商海盗船（USCORSAIR）K68机械键盘⿊⾊ 防⽔防尘樱桃轴体 炫彩背光游戏有线 红光红轴&quot;,&quot;price&quot;:499.00,&quot;brand&quot;:&quot;美商海盗船&quot;,&quot;weight&quot;:&quot;1.41kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;43580479783.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;雷蛇(Razer) 蝰蛇标准版 ⿏标 有线⿏标 游戏⿏标 ⼈体⼯程学 电竞 ⿊⾊6400DPI lol吃鸡神器cf&quot;,&quot;price&quot;:109.00,&quot;brand&quot;:&quot;雷蛇&quot;,&quot;weight&quot;:&quot;185.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;8141909.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;罗技（G）G502 HERO主宰者有线⿏标 游戏⿏标 HERO引擎 RGB⿏标 电竞⿏标25600DPI&quot;,&quot;price&quot;:299.00,&quot;brand&quot;:&quot;罗技&quot;,&quot;weight&quot;:&quot;250.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100001691967.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;武极 i5 10400F&#x2F;GTX1050Ti&#x2F;256G游戏台式办公电脑主机DIY组装机&quot;,&quot;price&quot;:4099.00,&quot;brand&quot;:&quot;武极&quot;,&quot;weight&quot;:&quot;5.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;1239166056.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;宏碁(Acer) 暗影骑⼠·威N50-N92 英特尔酷睿i5游戏台机 吃鸡电脑主机(⼗⼀代i5-11400F 16G 256G+1T GTX1650)&quot;,&quot;price&quot;:5299.00,&quot;brand&quot;:&quot;宏碁&quot;,&quot;weight&quot;:&quot;7.25kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100020726324.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;京天 酷睿i7 10700F&#x2F;RTX2060&#x2F;16G内存 吃鸡游戏台式电脑主机DIY组装机&quot;,&quot;price&quot;:7999.00,&quot;brand&quot;:&quot;京天&quot;,&quot;weight&quot;:&quot;10.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;40808512828.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;戴尔（DELL）OptiPlex 3070MFF&#x2F;3080MFF微型台式机电脑迷你⼩主机客厅HTPC 标配 i5-10500T&#x2F;8G&#x2F;1T+256G 内置WiFi+蓝⽛ 全国联保 三年上⻔&quot;,&quot;price&quot;:3999.00,&quot;brand&quot;:&quot;DELL&quot;,&quot;weight&quot;:&quot;2.85kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10025304273651.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;伊萌纯种英短蓝⽩猫活体猫咪幼猫活体英国短⽑猫矮脚猫英短蓝猫幼体银渐层蓝⽩活体宠物蓝猫幼崽猫咪宠物猫短 双⾎统A级 ⺟&quot;,&quot;price&quot;:4000.00,&quot;brand&quot;:&quot;英短&quot;,&quot;weight&quot;:&quot;1.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10027188382742.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;柴墨 ⾦渐层幼猫英短猫宠物猫英短⾦渐层猫咪活体猫活体纯种⼩猫银渐层 双⾎统&quot;,&quot;price&quot;:12000.00,&quot;brand&quot;:&quot;英短&quot;,&quot;weight&quot;:&quot;3.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10029312412476.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;Redmi Note10 Pro 游戏智能5G⼿机 ⼩⽶ 红⽶&quot;,&quot;price&quot;:9999.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;10.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100021970002.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;【⼆⼿99新】⼩⽶Max3⼿机⼆⼿⼿机 ⼤屏安卓 曜⽯⿊ 6G+128G 全⽹通&quot;,&quot;price&quot;:1046.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;0.75kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;35569092038.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;现货速发（10天价保）⼩⽶11 5G⼿机 骁⻰888 游戏智能⼿机 PRO店内可选⿊⾊ 套装版 12GB+256GB&quot;,&quot;price&quot;:4699.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;0.75kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10025836790851.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;⼩⽶⼿环6 NFC版 全⾯彩屏 30种运动模式 24h⼼率检测 50⽶防⽔ 智能⼿环&quot;,&quot;price&quot;:279.00,&quot;brand&quot;:&quot;⼩⽶&quot;,&quot;weight&quot;:&quot;65.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100019867468.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;HUAWEI MateView⽆线原⾊显示器⽆线版 28.2英⼨ 4K+ IPS 98% DCI-P310.7亿⾊ HDR400 TypeC 双扬声器 双MIC&quot;,&quot;price&quot;:4699.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;9.8kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100021420806.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;华为nova7se&#x2F;nova7 se 5G⼿机（ 12期免息可选 ）下单享好礼 绮境森林 乐活版 8G+128G（1年碎屏险）&quot;,&quot;price&quot;:2999.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;500.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10029312412476.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;华为HUAWEI FreeBuds 4i主动降噪 ⼊⽿式真⽆线蓝⽛⽿机&#x2F;通话降噪&#x2F;⻓续航&#x2F;⼩巧舒适 Android&amp;ios通⽤ 陶瓷⽩&quot;,&quot;price&quot;:479.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;137.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100018510746.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;HUAWEI WATCH GT2 华为⼿表 运动智能⼿表 两周⻓续航&#x2F;蓝⽛通话&#x2F;⾎氧检测&#x2F;麒麟芯⽚ 华为gt2 46mm 曜⽯⿊&quot;,&quot;price&quot;:1488.00,&quot;brand&quot;:&quot;华为&quot;,&quot;weight&quot;:&quot;335.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100008492922.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;Apple苹果12 mini iPhone 12 mini 5G ⼿机（现货速发 12期免息可选）蓝⾊ 5G版 64G&quot;,&quot;price&quot;:4699.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;280.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10026100075337.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;Apple iPhone 12 (A2404) 128GB 紫⾊ ⽀持移动联通电信5G 双卡双待⼿机&quot;,&quot;price&quot;:6799.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;330.00g&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100011203359.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;华硕ROG冰刃双屏 ⼗代英特尔酷睿 15.6英⼨液⾦导热300Hz电竞游戏笔记本电脑 i9-10980H 32G 2T RTX2080S&quot;,&quot;price&quot;:48999.00,&quot;brand&quot;:&quot;华硕&quot;,&quot;weight&quot;:&quot;2.5kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10021558215658.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;联想⼩新Air15 2021超轻薄笔记本电脑 ⾼⾊域学⽣办公设计师游戏本 ⼋核锐⻰R7-5700U 16G内存 512G固态 升级15.6英⼨IPS全⾯屏【DC调光护眼⽆闪烁】&quot;,&quot;price&quot;:5499.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;10.0kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;33950552707.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;苹果（Apple）MacBook Air 13.3英⼨ 笔记本电脑 【2020款商务灰】⼗代i7 16G 512G 官⽅标配 19点前付款当天发货&quot;,&quot;price&quot;:10498.00,&quot;brand&quot;:&quot;苹果&quot;,&quot;weight&quot;:&quot;1.29kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;10021130510120.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;科⼤讯⻜机器⼈ 阿尔法蛋A10智能机器⼈ 专业教育⼈⼯智能编程机器⼈学习机智能可编程 ⽩⾊&quot;,&quot;price&quot;:1099.00,&quot;brand&quot;:&quot;科⼤讯⻜&quot;,&quot;weight&quot;:&quot;1.7kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100005324258.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;robosen乐森机器⼈六⼀⼉童节礼物⾃营孩⼦玩具星际特⼯智能编程机器⼈⼉童语⾳控制陪伴益智变形机器⼈&quot;,&quot;price&quot;:2499.00,&quot;brand&quot;:&quot;senpowerT9-X&quot;,&quot;weight&quot;:&quot;3.01kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100006740372.html&quot;&#125;
&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;oldboyedu-shopping&quot;&#125;&#125;&#123;&quot;title&quot;:&quot;优必选（UBTECH）悟空智能语⾳监控对话⼈形机器⼈⼉童教育陪伴早教学习机玩具&quot;,&quot;price&quot;:4999.00,&quot;brand&quot;:&quot;优必选悟空&quot;,&quot;weight&quot;:&quot;1.21kg&quot;,&quot;item&quot;:&quot;https:&#x2F;&#x2F;item.jd.com&#x2F;100000722348.html&quot;&#125;</code></pre>

<h5 id="参考案例-2"><a href="#参考案例-2" class="headerlink" title="参考案例 2"></a>参考案例 2</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)启动filebeat</span>
<span class="token function">cat</span> <span class="token operator">></span> config-filebeat/02-log-to-es.yml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
filebeat.inputs:
    - type: log
      paths:
          - /tmp/shopping.json
      json.keys_under_root: true

output.logstash:
    hosts: ["10.0.0.101:8888"]
EOF</span>
./filebeat <span class="token parameter variable">-e</span> <span class="token parameter variable">-c</span> config-filebeat/02-log-to-es.yml

<span class="token comment"># (2)启动logstash</span>
<span class="token function">cat</span> <span class="token operator">></span> conf-logstash/02-beats-to-es.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
input &#123;
    beats &#123;
   		port => 8888
    &#125;
&#125;
filter &#123;
    mutate &#123;
        remove_field => ["host","@timestamp","tags","log","agent","@version", "input","ecs"]
    &#125;
&#125;
output &#123;
	stdout &#123;&#125;
    elasticsearch &#123;
        hosts => ["10.0.0.101:9200","10.0.0.102:9200","10.0.0.103:9200"]
        index => "oldboyedu-linux80-shopping"
    &#125;
&#125;
EOF</span>

logstash <span class="token parameter variable">-rf</span> conf-logstash/02-beats-to-es.conf</code></pre>

<h2 id="索引模板"><a href="#索引模板" class="headerlink" title="索引模板"></a>索引模板</h2><h3 id="1-什么是索引模板"><a href="#1-什么是索引模板" class="headerlink" title="1.什么是索引模板"></a>1.什么是索引模板</h3><p>索引模板是创建索引的⼀种⽅式。<br>当数据写⼊指定索引时，如果该索引不存在，则根据索引名称匹配相应索引模板的话，会根据模板的配置⽽建⽴索引。<br>索引模板仅对新创建的索引⽣效，对已经创建的索引是没有任何作⽤的。<br>推荐阅读: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index-templates.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index-templates.html</a></p>
<h3 id="2-查看索引模板"><a href="#2-查看索引模板" class="headerlink" title="2.查看索引模板"></a>2.查看索引模板</h3><pre class="language-none"><code class="language-none">GET http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_template 					# 查看所有的索引模板
GET http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_template&#x2F;oldboyedu-linux80 	# 查看单个索引模板</code></pre>

<h3 id="3-创建-x2F-修改索引模板"><a href="#3-创建-x2F-修改索引模板" class="headerlink" title="3.创建&#x2F;修改索引模板"></a>3.创建&#x2F;修改索引模板</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/_template/oldboyedu-linux80
<span class="token punctuation">&#123;</span>
    <span class="token string">"aliases"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"DBA"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>,
        <span class="token string">"SRE"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>,
        <span class="token string">"K8S"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"index_patterns"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
   		<span class="token string">"oldboyedu-linux80*"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"number_of_shards"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
            <span class="token string">"number_of_replicas"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"properties"</span>:<span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"ip"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"access_time"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"date"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span> <span class="token builtin class-name">:</span><span class="token string">"text"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="4-删除索引模板"><a href="#4-删除索引模板" class="headerlink" title="4.删除索引模板"></a>4.删除索引模板</h3><pre class="language-none"><code class="language-none">DELETE http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_template&#x2F;oldboyedu-linux80</code></pre>

<h2 id="ES-的-DSL-语句查询-DBA-方向需要掌握"><a href="#ES-的-DSL-语句查询-DBA-方向需要掌握" class="headerlink" title="ES 的 DSL 语句查询 - DBA 方向需要掌握!"></a>ES 的 DSL 语句查询 - DBA 方向需要掌握!</h2><h3 id="1-什么是-DSL"><a href="#1-什么是-DSL" class="headerlink" title="1.什么是 DSL"></a>1.什么是 DSL</h3><p>Elasticsearch 提供了基于 JSON 的完整 Query DSL（Domain Specific Language，领域特定语⾔）来定义查询。</p>
<h3 id="2-全文检索-match-查询"><a href="#2-全文检索-match-查询" class="headerlink" title="2.全文检索 - match 查询"></a>2.全文检索 - match 查询</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span><span class="token string">"⼩苹华"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	查询品牌是<span class="token string">"⼩苹华"</span>的所有商品。背后的逻辑是会对中⽂进⾏分词。</code></pre>

<h3 id="3-完全匹配-match-phrase-查询"><a href="#3-完全匹配-match-phrase-查询" class="headerlink" title="3.完全匹配 - match_phrase 查询"></a>3.完全匹配 - match_phrase 查询</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span><span class="token string">"⼩苹华"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	查询品牌是<span class="token string">"⼩苹华"</span>的所有商品。背后的逻辑并不会对中⽂进⾏分词。</code></pre>

<h3 id="4-全量查询-match-all"><a href="#4-全量查询-match-all" class="headerlink" title="4.全量查询 - match_all"></a>4.全量查询 - match_all</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_all"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	请求体的内容可以不写，即默认就是发起了全量查询<span class="token punctuation">(</span>match_all<span class="token punctuation">)</span>。</code></pre>

<h3 id="5-分页查询-size-from"><a href="#5-分页查询-size-from" class="headerlink" title="5.分页查询 - size-from"></a>5.分页查询 - size-from</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_all"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">7</span>,
    <span class="token string">"from"</span><span class="token builtin class-name">:</span> <span class="token number">28</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    size:
        指定每⻚显示多少条数据，默认值为10.
    from:
        指定跳过数据偏移量的⼤⼩，默认值为0，即默认看第⼀⻚。
        查询指定⻚码的from值 <span class="token operator">=</span> <span class="token string">"(⻚码 - 1) * 每⻚数据⼤⼩(size)"</span>

温馨提示:
	⽣产环境中，不建议深度分⻚，百度的⻚码数量控制在76⻚左右。</code></pre>

<h3 id="6-查看“-source”对象的指定字段"><a href="#6-查看“-source”对象的指定字段" class="headerlink" title="6.查看“_source”对象的指定字段"></a>6.查看“_source”对象的指定字段</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_all"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">7</span>,
    <span class="token string">"from"</span><span class="token builtin class-name">:</span> <span class="token number">28</span>,
    <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"brand"</span>,<span class="token string">"price"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    _source:
        ⽤于指定查看<span class="token string">"_source"</span>对象的指定字段。</code></pre>

<h3 id="7-查询包含指定字段的文档-exists"><a href="#7-查询包含指定字段的文档-exists" class="headerlink" title="7.查询包含指定字段的文档 - exists"></a>7.查询包含指定字段的文档 - exists</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"exists"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"hobby"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    exists
        判断某个字段是否存在，若存在则返回该⽂档，若不存在，则不返回⽂档。</code></pre>

<h3 id="8-语法高亮-hightlight"><a href="#8-语法高亮-hightlight" class="headerlink" title="8.语法高亮 - hightlight"></a>8.语法高亮 - hightlight</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"苹果"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"highlight"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"pre_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"post_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;/h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
    highlight:	设置⾼亮。
    fields:		指定对哪个字段进⾏语法⾼亮。
    pre_tags:	⾃定义⾼亮的前缀标签。
    post_tags	⾃定义⾼亮的后缀标签。</code></pre>

<h3 id="9-基于字段进行排序-sort"><a href="#9-基于字段进行排序-sort" class="headerlink" title="9.基于字段进行排序 - sort"></a>9.基于字段进行排序 - sort</h3><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;: &#123;
        &quot;match_phrase&quot;: &#123;
            &quot;brand&quot;: &quot;苹果&quot;
        &#125;
    &#125;,
    &quot;sort&quot;: &#123;
        &quot;price&quot; :&#123;
            &quot;order&quot;: &quot;asc&quot;
        &#125;
    &#125;
&#125;

相关字段说明:
    sort:	基于指定的字段进⾏排序。此处为指定的是&quot;price&quot;
    order:	指定排序的规则，分为&quot;asc&quot;(升序)和&quot;desc&quot;(降序)。</code></pre>

<h3 id="10-多条件查询-bool"><a href="#10-多条件查询-bool" class="headerlink" title="10.多条件查询 - bool"></a>10.多条件查询 - bool</h3><pre class="language-none"><code class="language-none">POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;:&#123;
        &quot;bool&quot; :&#123;
            &quot;must&quot;: [
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot; :&quot; 苹果&quot;
                    &#125;
                &#125;,
                &#123;
                    &quot;match&quot;: &#123;
                        &quot;price&quot;: 5499
                    &#125;
                &#125;
			]
		&#125;
	&#125;
&#125;

POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;:&#123;
        &quot;bool&quot; :&#123;
            &quot;must_not&quot;: [
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot; :&quot; 苹果&quot;
                    &#125;
                &#125;,
                &#123;
                    &quot;match&quot;: &#123;
                        &quot;price&quot;: 3399
                    &#125;
                &#125;
            ]
        &#125;
    &#125;
&#125;

POST http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;oldboyedu-shopping&#x2F;_search
&#123;
    &quot;query&quot;: &#123;
        &quot;bool&quot;: &#123;
            &quot;should&quot;: [
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot;: &quot; 苹果&quot;
                    &#125;
                &#125;,
                &#123;
                    &quot;match&quot;: &#123;
                        &quot;price&quot;: 5499
                    &#125;
                &#125;,
                &#123;
                    &quot;match_phrase&quot;: &#123;
                        &quot;brand&quot;: &quot; ⼩⽶&quot;
                    &#125;
                &#125;
            ],
            &quot;minimum_should_match&quot;: 2
        &#125;
    &#125;
&#125;

温馨提示:
    bool:		可以匹配多个条件查询。其中有&quot;must&quot;，&quot;must_not&quot;,&quot;should&quot;。
    &quot;must&quot;		必须匹配的条件。
    &quot;must_not&quot;	必须不匹配的条件，即和must相反。
    &quot;should&quot;	不是必要条件，满⾜其中之⼀即可，可以使⽤&quot;minimum_should_match&quot;来限制满⾜要求的条件数量。</code></pre>

<h3 id="11-范围查询-filter"><a href="#11-范围查询-filter" class="headerlink" title="11.范围查询 - filter"></a>11.范围查询 - filter</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">" 苹果"</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token punctuation">]</span>,
			<span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"price"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"gt"</span><span class="token builtin class-name">:</span> <span class="token number">5000</span>,
                        <span class="token string">"lt"</span><span class="token builtin class-name">:</span> <span class="token number">8000</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关字段说明:
    filter	过滤数据。
    range：	基于范围进⾏过滤，此处为基于的是<span class="token string">"price"</span>进⾏过滤。
    常⻅的操作符如下:
        gt:		⼤于。
        lt:		⼩于。
        gte:	⼤于等于。
        lte:	⼩于等于。</code></pre>

<h3 id="12-精确匹配多个值-terms"><a href="#12-精确匹配多个值-terms" class="headerlink" title="12.精确匹配多个值 - terms"></a>12.精确匹配多个值 - terms</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"price"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token number">4699</span>,
                <span class="token number">299</span>,
                <span class="token number">4066</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="13-多词搜索-了解即可"><a href="#13-多词搜索-了解即可" class="headerlink" title="13.多词搜索 - 了解即可"></a>13.多词搜索 - 了解即可</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"显示器曲⾯"</span>,
                            <span class="token string">"operator"</span><span class="token builtin class-name">:</span> <span class="token string">"and"</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
        	<span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"highlight"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"pre_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"post_tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;/h1>"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	当我们将<span class="token string">"operator"</span>设置为<span class="token string">"and"</span>则⽂档必须包含<span class="token string">"query"</span>中的所有词汇，<span class="token string">"operator"</span>的默认值为<span class="token string">"or"</span>。</code></pre>

<h3 id="14-权重案例-了解即可"><a href="#14-权重案例-了解即可" class="headerlink" title="14.权重案例 - 了解即可"></a>14.权重案例 - 了解即可</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"⼩苹华"</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"should"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"防⽔"</span>,
                            <span class="token string">"boost"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>,
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"⿊⾊"</span>,
                            <span class="token string">"boost"</span><span class="token builtin class-name">:</span> <span class="token number">10</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"highlight"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>,
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
<span class="token punctuation">&#125;</span>

温馨提示:
	修改<span class="token string">"boost"</span>字段的值来提升相应权重。</code></pre>

<h3 id="15-聚合查询-了解即可"><a href="#15-聚合查询-了解即可" class="headerlink" title="15.聚合查询 - 了解即可"></a>15.聚合查询 - 了解即可</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计每个品牌的数量。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_brand_group"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"terms"</span>:<span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"brand.keyword"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>
POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计苹果商品中最贵的。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"苹果"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_max_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"max"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计华为商品中最便宜的。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"华为"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_min_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"min"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计⼩⽶商品的品均架构。</span>
<span class="token punctuation">&#123;</span>
<span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"⼩⽶"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_avg_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"avg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.103:9200/oldboyedu-shopping/_search	<span class="token comment"># 统计⻢下⼩⽶所有商品的价格。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"⼩⽶"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu_sum_shopping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"sum"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"price"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="ES-集群迁移"><a href="#ES-集群迁移" class="headerlink" title="ES 集群迁移"></a>ES 集群迁移</h2><h3 id="1-部署-ES6-分布式集群"><a href="#1-部署-ES6-分布式集群" class="headerlink" title="1.部署 ES6 分布式集群"></a>1.部署 ES6 分布式集群</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)下载ES 6的软件包</span>
<span class="token function">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.23.tar.gz

<span class="token comment"># (2)解压软件包并创建数据⽬录和⽇志⽬录</span>
<span class="token function">tar</span> xf elasticsearch-6.8.23.tar.gz <span class="token parameter variable">-C</span> /oldboyedu/softwares/
<span class="token function">install</span> <span class="token parameter variable">-d</span> /oldboyedu/<span class="token punctuation">&#123;</span>data,logs<span class="token punctuation">&#125;</span>/es6 <span class="token parameter variable">-o</span> oldboyedu <span class="token parameter variable">-g</span> oldboyedu
<span class="token function">chown</span> oldboyedu:oldboyedu <span class="token parameter variable">-R</span> /oldboyedu/softwares/elasticsearch-6.8.23/

<span class="token comment"># (3)修改配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/elasticsearch-6.8.23/config/elasticsearch.yml
<span class="token punctuation">..</span><span class="token punctuation">..</span>.
cluster.name: oldboyedu-linux80-es6
node.name: elk101
path.data: /oldboyedu/data/es6
path.logs: /oldboyedu/logs/es6
network.host: <span class="token number">0.0</span>.0.0
http.port: <span class="token number">19200</span>
transport.tcp.port: <span class="token number">19300</span>
discovery.zen.ping.unicast.hosts: <span class="token punctuation">[</span><span class="token string">"10.0.0.101"</span>,<span class="token string">"10.0.0.102"</span>,<span class="token string">"10.0.0.103"</span><span class="token punctuation">]</span>
discovery.zen.minimum_master_nodes: <span class="token number">2</span>

<span class="token comment"># (4)同步环境到其他节点</span>
data_rsync.sh /oldboyedu/softwares/elasticsearch-6.8.23

<span class="token comment"># (5)其他节点修改⼀下⼏个参数即可修改各节点的"node.name"名称即可。</span>

<span class="token comment"># (6)编写启动脚本</span>
<span class="token function">cat</span> <span class="token operator">></span> /etc/sysconfig/jdk <span class="token operator">&lt;&lt;</span><span class="token string">EOF
JAVA_HOME=/oldboyedu/softwares/jdk
EOF</span>
<span class="token function">cat</span> <span class="token operator">></span> /usr/lib/systemd/system/es68.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Oldboyedu linux80 ELK
After=network.target

[Service]
Type=forking
EnvironmentFile=/etc/sysconfig/jdk
ExecStart=/oldboyedu/softwares/elasticsearch-6.8.23/bin/elasticsearch -d
Restart=no
User=oldboyedu
Group=oldboyedu
LimitNOFILE=131070

[Install]
WantedBy=multi-user.target
EOF</span>

systemctl daemon-reload

<span class="token comment"># (7)启动服务</span>
systemctl start es68</code></pre>

<h3 id="2-基于-reindex-的-API-迁移"><a href="#2-基于-reindex-的-API-迁移" class="headerlink" title="2.基于_reindex 的 API 迁移"></a>2.基于_reindex 的 API 迁移</h3><pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.103:9200/_reindex
<span class="token punctuation">&#123;</span>
    <span class="token string">"source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"dest"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping-new"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 不同⼀个集群迁移索引</span>
POST http://10.0.0.103:9200/_reindex
<span class="token punctuation">&#123;</span>
    <span class="token string">"source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping"</span>,
        <span class="token string">"remote"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"host"</span><span class="token builtin class-name">:</span> <span class="token string">"http://10.0.0.101:19200"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"match_phrase"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"brand"</span><span class="token builtin class-name">:</span> <span class="token string">"Dell"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"dest"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboyedu-shopping-new-22222222222"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

温馨提示:
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>不同集群迁移时，需要修改9200端⼝对应的ES7的elasticsearch.yml配置⽂件，添加如下内容，并重启集群。
        reindex.remote.whitelist: <span class="token string">"*:*"</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>跨集群迁移时，可以使⽤DSL语句来对源集群的数据进⾏过滤，⽐如上⾯的<span class="token string">"query"</span>语句。
推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/docs-reindex.html</code></pre>

<h3 id="3-基于-logstash-实现索引跨集群迁移"><a href="#3-基于-logstash-实现索引跨集群迁移" class="headerlink" title="3.基于 logstash 实现索引跨集群迁移"></a>3.基于 logstash 实现索引跨集群迁移</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> conf-logstash/03-es-to-es.conf
input <span class="token punctuation">&#123;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-shopping"</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101:19200"</span>
        query <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'&#123; "query": &#123; "match_phrase": &#123; "brand": "dell" &#125; &#125;&#125;'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
    stdout <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-shopping-6666666666666666666"</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101:9200"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>root@elk101.oldboyedu.com ~<span class="token punctuation">]</span>$ logstash <span class="token parameter variable">-rf</span> conf-logstash/03-es-to-es.conf

温馨提示:
    对于低版本的数据迁移到⾼版本时，⽐如从ES5迁移到ES7，应该注意不同点:
        <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>默认的分⽚数量和副本数量<span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>默认的⽂档类型是否相同,尤其是在ES7版本中移除了type类型，仅保留了<span class="token string">"_doc"</span>这⼀种内置类型<span class="token punctuation">;</span></code></pre>

<h2 id="ES-集群常用的-API"><a href="#ES-集群常用的-API" class="headerlink" title="ES 集群常用的 API"></a>ES 集群常用的 API</h2><h3 id="1-ES-集群健康状态-API（heath）"><a href="#1-ES-集群健康状态-API（heath）" class="headerlink" title="1.ES 集群健康状态 API（heath）"></a>1.ES 集群健康状态 API（heath）</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667450229695.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)安装jq⼯具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> jq

<span class="token comment"># (2)测试取数据</span>
<span class="token function">curl</span> http://10.0.0.103:9200/_cluster/health <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">|</span> jq
<span class="token function">curl</span> http://10.0.0.103:9200/_cluster/health <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">|</span> jq .status
<span class="token function">curl</span> http://10.0.0.103:9200/_cluster/health <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token operator">|</span> jq
.active_shards_percent_as_number


相关参数说明:
    cluster_name
    	集群的名称。
    status
        集群的健康状态，基于其主分⽚和副本分⽚的状态。
        ES集群有以下三种状态:
            green	所有分⽚都已分配。
            yellow	所有主分⽚都已分配，但⼀个或多个副本分⽚未分配。如果集群中的某个节点发⽣故障，则在修复该节点之前，某些数据可能不可⽤。
            red		⼀个或多个主分⽚未分配，因此某些数据不可⽤。这可能会在集群启动期间短暂发⽣，因为分配了主分⽚。
    timed_out
    	是否在参数false指定的时间段内返回响应（默认情况下30秒）。
    number_of_nodes
   		集群内的节点数。
    number_of_data_nodes
        作为专⽤数据节点的节点数。
    active_primary_shards
        可⽤主分⽚的数量。
    active_shards
        可⽤主分⽚和副本分⽚的总数。
    relocating_shards
        正在重定位的分⽚数。
    initializing_shards
        正在初始化的分⽚数。
    unassigned_shards
        未分配的分⽚数。
    delayed_unassigned_shards
        分配因超时设置⽽延迟的分⽚数。
    number_of_pending_tasks
        尚未执⾏的集群级别更改的数量。
    number_of_in_flight_fetch
        未完成的提取次数。
    task_max_waiting_in_queue_millis
        ⾃最早启动的任务等待执⾏以来的时间（以毫秒为单位）。
    active_shards_percent_as_number
        集群中活动分⽚的⽐率，以百分⽐表示。</code></pre>

<h3 id="2-ES-集群的设置及优先级（settings）"><a href="#2-ES-集群的设置及优先级（settings）" class="headerlink" title="2.ES 集群的设置及优先级（settings）"></a>2.ES 集群的设置及优先级（settings）</h3><pre class="language-bash" data-language="bash"><code class="language-bash">如果您使⽤多种⽅法配置相同的设置，Elasticsearch 会按以下优先顺序应⽤这些设置：
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>Transient setting<span class="token punctuation">(</span>临时配置，集群重启后失效<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>Persistent setting<span class="token punctuation">(</span>持久化配置，集群重启后依旧⽣效<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>elasticsearch.yml setting<span class="token punctuation">(</span>配置⽂件<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>Default setting value<span class="token punctuation">(</span>默认设置值<span class="token punctuation">)</span>

<span class="token comment"># (1)查询集群的所有配置信息</span>
GET http://10.0.0.103:9200/_cluster/settings?include_defaults<span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">flat_settings</span><span class="token operator">=</span>true

<span class="token comment"># (2)修改集群的配置信息</span>
PUT http://10.0.0.103:9200/_cluster/settings
<span class="token punctuation">&#123;</span>
    <span class="token string">"transient"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"cluster.routing.allocation.enable"</span><span class="token builtin class-name">:</span> <span class="token string">"none"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

相关参数说明:
<span class="token string">"cluster.routing.allocation.enable"</span><span class="token builtin class-name">:</span>
    <span class="token string">"all"</span>			允许所有分⽚类型进⾏分配。
    <span class="token string">"primaries"</span>		仅允许分配主分⽚。
    <span class="token string">"new_primaries"</span>	仅允许新创建索引分配主分⽚。
    <span class="token string">"none"</span>			不允许分配任何类型的分配。

参考链接:
https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-get-settings.html
https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-update-settings.html</code></pre>

<h3 id="3-集群状态-API（state）"><a href="#3-集群状态-API（state）" class="headerlink" title="3.集群状态 API（state）"></a>3.集群状态 API（state）</h3><pre class="language-bash" data-language="bash"><code class="language-bash">集群状态是⼀种内部数据结构，它跟踪每个节点所需的各种信息，包括：
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>集群中其他节点的身份和属性
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>集群范围的设置
    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>索引元数据，包括每个索引的映射和设置
    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>集群中每个分⽚副本的位置和状态

<span class="token comment"># (1)查看集群的状态信息</span>
GET http://10.0.0.103:9200/_cluster/state

<span class="token comment"># (2)只查看节点信息。</span>
GET http://10.0.0.103:9200/_cluster/state/nodes

<span class="token comment"># (3)查看nodes,version,routing_table这些信息，并且查看以"oldboyedu*"开头的所有索引</span>
http://10.0.0.103:9200/_cluster/state/nodes,version,routing_table/oldboyedu*


推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-state.html</code></pre>

<h3 id="4-集群统计-API（stats）"><a href="#4-集群统计-API（stats）" class="headerlink" title="4.集群统计 API（stats）"></a>4.集群统计 API（stats）</h3><pre class="language-bash" data-language="bash"><code class="language-bash">Cluster Stats API 允许从集群范围的⻆度检索统计信息。返回基本索引指标（分⽚数量、存储⼤⼩、内存使⽤情况）和有关构成集群的当前节点的信息（数量、⻆⾊、操作系统、jvm 版本、内存使⽤情况、cpu 和已安装的插件）。

<span class="token comment"># (1)查看统计信息</span>
GET http://10.0.0.103:9200/_cluster/stats


推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-stats.html</code></pre>

<h3 id="5-查看集群的分片分配情况（allocation）"><a href="#5-查看集群的分片分配情况（allocation）" class="headerlink" title="5.查看集群的分片分配情况（allocation）"></a>5.查看集群的分片分配情况（allocation）</h3><p>集群分配解释 API 的⽬的是为集群中的分⽚分配提供解释。</p>
<p>对于未分配的分⽚，解释 API 提供了有关未分配分⽚的原因的解释。</p>
<p>对于分配的分⽚，解释 API 解释了为什么分⽚保留在其当前节点上并且没有移动或重新平衡到另⼀个节点。</p>
<p>当您尝试诊断分⽚未分配的原因或分⽚继续保留在其当前节点上的原因时，此 API 可能⾮常有⽤，⽽您可能会对此有所期待。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)分析teacher索引的0号分⽚未分配的原因。</span>
GET http://10.0.0.101:9200/_cluster/allocation/explain
<span class="token punctuation">&#123;</span>
    <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"teacher"</span>,
    <span class="token string">"shard"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
    <span class="token string">"primary"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span>

推荐阅读:
	https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-allocation-explain.html</code></pre>

<h3 id="6-集群分片重路由-API（reroute）"><a href="#6-集群分片重路由-API（reroute）" class="headerlink" title="6.集群分片重路由 API（reroute）"></a>6.集群分片重路由 API（reroute）</h3><p>reroute 命令允许⼿动更改集群中各个分⽚的分配。</p>
<p>例如，可以将分⽚从⼀个节点显式移动到另⼀个节点，可以取消分配，并且可以将未分配的分⽚显式分配给特定节点。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">POST http://10.0.0.101:9200/_cluster/reroute	<span class="token comment"># 将"teacher"索引的0号分⽚从elk102节点移动到elk101节点。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"commands"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"move"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"teacher"</span>,
                <span class="token string">"shard"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
                <span class="token string">"from_node"</span><span class="token builtin class-name">:</span> <span class="token string">"elk102.oldboyedu.com"</span>,
                <span class="token string">"to_node"</span><span class="token builtin class-name">:</span> <span class="token string">"elk101.oldboyedu.com"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

POST http://10.0.0.101:9200/_cluster/reroute	<span class="token comment"># 取消副本分⽚的分配，其副本会重新初始化分配。</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"commands"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"cancel"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"teacher"</span>,
                <span class="token string">"shard"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
                <span class="token string">"node"</span><span class="token builtin class-name">:</span> <span class="token string">"elk101.oldboyedu.com"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>推荐阅读: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-reroute.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-reroute.html</a></p>
<h3 id="7-今日作业-1"><a href="#7-今日作业-1" class="headerlink" title="7.今日作业"></a>7.今日作业</h3><pre class="language-none"><code class="language-none">(1)完成课堂的所有练习;

进阶作业:
(2)使⽤zabbix健康ES集群的健康状态，包含以下2个指标:
    curl http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_cluster&#x2F;health 2&gt;&#x2F;dev&#x2F;null| jq .status
    curl http:&#x2F;&#x2F;10.0.0.103:9200&#x2F;_cluster&#x2F;health 2&gt;&#x2F;dev&#x2F;null| jq .active_shards_percent_as_number</code></pre>

<h2 id="ES-集群理论篇"><a href="#ES-集群理论篇" class="headerlink" title="ES 集群理论篇"></a>ES 集群理论篇</h2><h3 id="1-倒排索引"><a href="#1-倒排索引" class="headerlink" title="1.倒排索引"></a>1.倒排索引</h3><p>⾯试题: 分⽚底层时如何⼯作的？</p>
<p>答: 分⽚底层对应的是⼀个 Lucene 库，⽽ Lucene 底层使⽤倒排索引技术实现。</p>
<h4 id="正排索引-正向索引"><a href="#正排索引-正向索引" class="headerlink" title="正排索引(正向索引)"></a>正排索引(正向索引)</h4><p>我们 MySQL 为例，⽤ id 字段存储博客⽂章的编号，⽤ context 存储⽂件的内容。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> blog <span class="token punctuation">(</span>id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> contextTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INDEX</span> blog <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'I am Jason Yin, I love Linux ...'</span><span class="token punctuation">)</span></code></pre>

<p>此时，如果我们查询⽂章内容包含”Jason Yin”的词汇的时候，就⽐较麻烦了，因为要进⾏全表扫描。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> blog <span class="token keyword">WHERE</span> context <span class="token operator">LIKE</span> <span class="token string">'Jason Yin'</span><span class="token punctuation">;</span></code></pre>

<h4 id="倒排索引-反向索引"><a href="#倒排索引-反向索引" class="headerlink" title="倒排索引(反向索引)"></a>倒排索引(反向索引)</h4><p>ES 使⽤⼀种称为”倒排索引”的结构，它适⽤于快速的全⽂检索。<br>倒排索引中有以下三个专业术语:</p>
<p>1、词条:<br>指的是最⼩的存储和查询单元，换句话说，指的是您想要查询的关键字(词)。<br>对应英⽂⽽⾔通常指的是⼀个单词，⽽对于中⽂⽽⾔，对应的是⼀个词组。</p>
<p>2、词典(字典):<br>它是词条的集合，底层通常基于”Btree+”和”HASHMap”实现。</p>
<p>3、倒排表:<br>记录了词条出现在什么位置，出现的频率是什么。<br>倒排表中的每⼀条记录我们称为倒排项。</p>
<p>倒排索引的搜索过程:</p>
<ol>
<li>⾸先根据⽤户需要查询的词条进⾏分词后，将分词后的各个词条字典进⾏匹配，验证词条在词典中是否存在;</li>
<li>如果上⼀步搜索结果发现词条不在字典中，则结束本次搜索，如果在词典中，就需要去查看倒排表中的记录(倒排项);</li>
<li>根据倒排表中记录的倒排项来定位数据在哪个⽂档中存在，⽽后根据这些⽂档的”_id”来获取指定的数据;</li>
</ol>
<p>综上所述，假设有 10 亿篇⽂章，对于 mysql 不创建索引的情况下，会进⾏全表扫描搜索”JasonYin”。⽽对于 ES ⽽⾔，其只需要将倒排表中返回的 id 进⾏扫描即可，⽽⽆须进⾏全量查询。</p>
<h3 id="2-集群角色"><a href="#2-集群角色" class="headerlink" title="2.集群角色"></a>2.集群角色</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457339777.png"></p>
<pre class="language-none"><code class="language-none">⻆⾊说明:
    c：	Cold data
    d：	data node
    f：	frozen node
    h：	hot node
    i：	ingest node
    l：	machine learning node
    m：	master eligible node
    r：	remote cluster client node
    s：	content node
    t：	transform node
    v：	voting-only node
    w：	warm node
    -：	coordinating node only

常⽤的⻆⾊说明:
    data node:	指的是存储数据的节点。
    			node.data: true
    master node:	控制ES集群，并维护集群的状态(cluster state，包括节点信息，索引信息等，ES集群每个节点都有⼀份)。
    				node.master: true
    coordinating:	协调节点可以处理请求的节点，ES集群所有的节点均为协调节点，该⻆⾊⽆法取消。</code></pre>

<h3 id="3-文档的写流程"><a href="#3-文档的写流程" class="headerlink" title="3.文档的写流程"></a>3.文档的写流程</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457504851.png"></p>
<h3 id="4-单个文档的读流程"><a href="#4-单个文档的读流程" class="headerlink" title="4.单个文档的读流程"></a>4.单个文档的读流程</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457540842.png"></p>
<h3 id="5-ES-底层存储原理剖析"><a href="#5-ES-底层存储原理剖析" class="headerlink" title="5.ES 底层存储原理剖析"></a>5.ES 底层存储原理剖析</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667457568386.png"></p>
<p>事务⽇志存储在哪⾥?</p>
<pre class="language-none"><code class="language-none">在索引分⽚⽬录下，取名⽅式如下:
	translog-N.tlog:	真正的⽇志⽂件，N表示generation（代）的意思，通过它跟索引⽂件关联
	tranlog.ckp:		⽇志的元数据⽂件，⻓度总是20个字节，记录3个信息：偏移量 &amp; 事务操作数量 &amp; 当前代</code></pre>

<p>什么时候删事务⽇志？</p>
<pre class="language-none"><code class="language-none">在flush的时候，translog⽂件会被清空。实际的过程是先删掉⽼⽂件，再创建⼀个新⽂件，取名时，序号加1，⽐如图2中，flush后你只会看到 translog-2.tlog，原来的translog-1.tlog已被删除。</code></pre>

<p>为什么要删？</p>
<pre class="language-none"><code class="language-none">因为数据修改已经写⼊磁盘了，之前的旧的⽇志就⽆⽤武之地了，留着只能⽩嫖存储空间。</code></pre>

<h3 id="6-乐观锁机制-了解即可"><a href="#6-乐观锁机制-了解即可" class="headerlink" title="6.乐观锁机制 - 了解即可"></a>6.乐观锁机制 - 了解即可</h3><p>两种⽅法通常被⽤来解决并发更新时变更不会丢失的解决⽅案:</p>
<p><strong>1、悲观并发控制</strong></p>
<p>这种⽅法被关系型数据库⼴泛使⽤，它假定有变更冲突可能发⽣，因此阻塞访问资源以防⽌冲突。⼀个典型的例⼦是修改⼀⾏数据之前像将其锁住，确保只有获得锁的线程能够对这⾏数据进⾏修改。</p>
<p><strong>2、乐观锁并发控制</strong></p>
<p>ES 中使⽤的这种⽅法假设冲突是不可能发⽣的，并且不会阻塞正在尝试的操作。然⽽，如果源数据在读写当中被修改，更新将会失败。应⽤程序接下来该如果解决冲突。例如，可以重试更新，使⽤新的数据，或者将相关情况报告给⽤户。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)创建⽂档</span>
PUT http://10.0.0.103:9200/oldboyedu_student/_doc/10001
<span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王岩"</span>,
    <span class="token string">"age"</span>:25,
    <span class="token string">"hobby"</span>:<span class="token punctuation">[</span><span class="token string">"苍⽼师"</span>,<span class="token string">"⽼男孩"</span>,<span class="token string">"欧美"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># (2)模拟事物1修改</span>
POST http://10.0.0.103:9200/oldboyedu_student/_doc/10001/_update?
<span class="token assign-left variable">if_seq_no</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span><span class="token assign-left variable">if_primary_term</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"⽇韩"</span>,
            <span class="token string">"国内"</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># (3)模拟事物2修改(如果上⾯的事物执⾏成功，则本事物执⾏失败，因为"_seq_no"发⽣变化)</span>
POST http://10.0.0.103:9200/oldboyedu_student/_doc/10001/_update?
<span class="token assign-left variable">if_seq_no</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span><span class="token assign-left variable">if_primary_term</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"欧美"</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 扩展:(基于扩展的version版本来控制)</span>
POST http://10.0.0.103:9200/oldboyedu_student/_doc/10001?version<span class="token operator">=</span><span class="token number">10</span><span class="token operator">&amp;</span><span class="token assign-left variable">version_type</span><span class="token operator">=</span>external
<span class="token punctuation">&#123;</span>
	<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"oldboy"</span>,
    <span class="token string">"hobby"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"⽇韩"</span>,
        <span class="token string">"国内"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="python-操作-ES-集群-API-实战"><a href="#python-操作-ES-集群-API-实战" class="headerlink" title="python 操作 ES 集群 API 实战"></a>python 操作 ES 集群 API 实战</h2><h3 id="1-创建索引"><a href="#1-创建索引" class="headerlink" title="1.创建索引"></a>1.创建索引</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
msg_body <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"settings"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"index"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"number_of_replicas"</span><span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
            <span class="token string">"number_of_shards"</span><span class="token punctuation">:</span> <span class="token string">"5"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"mappings"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"ip"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"long"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"keyword"</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"aliases"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"oldboyedu-elstaicstack-linux80-python"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">"oldboyedu-linux80-python"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>msg_body<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="2-写⼊单个⽂档"><a href="#2-写⼊单个⽂档" class="headerlink" title="2.写⼊单个⽂档"></a>2.写⼊单个⽂档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 写⼊单个⽂档</span>
msg_body <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Jason Yin"</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"120.53.104.136"</span><span class="token punctuation">,</span>
    <span class="token string">"blog"</span><span class="token punctuation">:</span> <span class="token string">"https://blog.yinzhengjie.com/"</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"k8s"</span><span class="token punctuation">,</span> <span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"elk"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"yinzhengjie@oldboyedu.com"</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">10086</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>index<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> doc_type<span class="token operator">=</span><span class="token string">"_doc"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>msg_body<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="3-写入多个文档"><a href="#3-写入多个文档" class="headerlink" title="3.写入多个文档"></a>3.写入多个文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch
<span class="token keyword">from</span> elasticsearch<span class="token punctuation">.</span>helpers <span class="token keyword">import</span> bulk

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 批量写⼊多个⽂档</span>
doc2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">10010</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"⽼男孩"</span><span class="token punctuation">,</span>
    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">45</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"下棋"</span><span class="token punctuation">,</span> <span class="token string">"抖⾳"</span><span class="token punctuation">,</span> <span class="token string">"思想课"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"10.0.0.101"</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"oldboy@oldboyedu.com"</span>
<span class="token punctuation">&#125;</span>
doc3 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">10011</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"李导"</span><span class="token punctuation">,</span>
    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"三剑客"</span><span class="token punctuation">,</span> <span class="token string">"打枪"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"lidao@oldboyedu.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"10.0.0.201"</span>
<span class="token punctuation">&#125;</span>
doc4 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">100012</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"赵嘉欣"</span><span class="token punctuation">,</span>
    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
    <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"⽇韩"</span><span class="token punctuation">,</span> <span class="token string">"⼩说"</span><span class="token punctuation">,</span> <span class="token string">"王岩"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"zhaojiaxin@oldboyedu.com"</span><span class="token punctuation">,</span>
    <span class="token string">"ip_addr"</span><span class="token punctuation">:</span> <span class="token string">"10.0.0.222"</span>
<span class="token punctuation">&#125;</span>
many_doc <span class="token operator">=</span> <span class="token punctuation">[</span>doc2<span class="token punctuation">,</span> doc3<span class="token punctuation">,</span> doc4<span class="token punctuation">]</span>
write_number<span class="token punctuation">,</span> _ <span class="token operator">=</span> bulk<span class="token punctuation">(</span>es<span class="token punctuation">,</span> many_doc<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>write_number<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="4-全量查询"><a href="#4-全量查询" class="headerlink" title="4.全量查询"></a>4.全量查询</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 全量查询</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hobby"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>

<h3 id="5-查看多个文档"><a href="#5-查看多个文档" class="headerlink" title="5.查看多个文档"></a>5.查看多个文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 获取多个⽂档</span>
doc1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'ids'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"5gIk24AB2f3QZVpX1AxN"</span><span class="token punctuation">,</span> <span class="token string">"5AIk24AB2f3QZVpX1AxN"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
res <span class="token operator">=</span> es<span class="token punctuation">.</span>mget<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>doc1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">'docs'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="6-DSL-查询"><a href="#6-DSL-查询" class="headerlink" title="6.DSL 查询"></a>6.DSL 查询</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

<span class="token comment"># 设置字符集，兼容Python2</span>
<span class="token builtin">reload</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>setdefaultencoding<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># DSL语句查询</span>
dsl <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"query"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"match"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token string">"王岩"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># DSL语句查询</span>
<span class="token comment"># dsl = &#123;</span>
<span class="token comment">#     "query": &#123;</span>
<span class="token comment">#         "bool": &#123;</span>
<span class="token comment">#             "should": [</span>
<span class="token comment">#                 &#123;</span>
<span class="token comment">#                     "match": &#123;</span>
<span class="token comment">#                         "type": "pets"</span>
<span class="token comment">#                     &#125;</span>
<span class="token comment">#                 &#125;,</span>
<span class="token comment">#                 &#123;</span>
<span class="token comment">#                     "match": &#123;</span>
<span class="token comment">#                         "type": "lunxury"</span>
<span class="token comment">#                     &#125;</span>
<span class="token comment">#                 &#125;</span>
<span class="token comment">#             ],</span>
<span class="token comment">#             "minimum_should_match": 1,</span>
<span class="token comment">#             "filter": &#123;</span>
<span class="token comment">#                 "range": &#123;</span>
<span class="token comment">#                     "price": &#123;</span>
<span class="token comment">#                         "gt": 1500,</span>
<span class="token comment">#                         "lt": 2500</span>
<span class="token comment">#                     &#125;</span>
<span class="token comment">#                 &#125;</span>
<span class="token comment">#             &#125;</span>
<span class="token comment">#         &#125;</span>
<span class="token comment">#     &#125;,</span>
<span class="token comment">#     "sort": &#123;</span>
<span class="token comment">#         "price": &#123;</span>
<span class="token comment">#             "order": "desc"</span>
<span class="token comment">#         &#125;</span>
<span class="token comment">#     &#125;,</span>
<span class="token comment">#     "_source": [</span>
<span class="token comment">#         "title",</span>
<span class="token comment">#         "price",</span>
<span class="token comment">#         "producer"</span>
<span class="token comment">#     ]</span>
<span class="token comment"># &#125;</span>

res <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"shopping"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>dsl<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
res <span class="token operator">=</span> es<span class="token punctuation">.</span>search<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>dsl<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="7-查看索引是否存在"><a href="#7-查看索引是否存在" class="headerlink" title="7.查看索引是否存在"></a>7.查看索引是否存在</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span>
                    <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 判断索引是否存在</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-shopping"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="8-修改文档"><a href="#8-修改文档" class="headerlink" title="8.修改文档"></a>8.修改文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
new_doc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">'doc'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"hobby"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'下棋'</span><span class="token punctuation">,</span> <span class="token string">'抖⾳'</span><span class="token punctuation">,</span> <span class="token string">'思想课'</span><span class="token punctuation">,</span> <span class="token string">"Linux运维"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">:</span> <span class="token string">'中华⼈⺠共和国北京市昌平区沙河镇⽼男孩教育'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token comment"># 更新⽂档</span>
res <span class="token operator">=</span> es<span class="token punctuation">.</span>update<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'5gIk24AB2f3QZVpX1AxN'</span><span class="token punctuation">,</span> body<span class="token operator">=</span>new_doc<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="9-删除单个文档"><a href="#9-删除单个文档" class="headerlink" title="9.删除单个文档"></a>9.删除单个文档</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 删除单个⽂档</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"5gIk24AB2f3QZVpX1AxN"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h3 id="10-删除索引"><a href="#10-删除索引" class="headerlink" title="10.删除索引"></a>10.删除索引</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment"># _*_coding:utf-8_*_</span>
<span class="token keyword">from</span> elasticsearch <span class="token keyword">import</span> Elasticsearch

es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'10.0.0.101:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.102:9200'</span><span class="token punctuation">,</span> <span class="token string">'10.0.0.103:9200'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 删除索引</span>
result <span class="token operator">=</span> es<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">"oldboyedu-linux80-2022"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

es<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<h2 id="ES-集群加密的-Kibana-的-RABC-实战"><a href="#ES-集群加密的-Kibana-的-RABC-实战" class="headerlink" title="ES 集群加密的 Kibana 的 RABC 实战"></a>ES 集群加密的 Kibana 的 RABC 实战</h2><h3 id="1-基于-nginx-反向代理控制-kibana"><a href="#1-基于-nginx-反向代理控制-kibana" class="headerlink" title="1.基于 nginx 反向代理控制 kibana"></a>1.基于 nginx 反向代理控制 kibana</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667458865578.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)部署nginx服务	略，参考之前的笔记即可。</span>

<span class="token comment"># (2)编写nginx的配置⽂件</span>
<span class="token function">cat</span> <span class="token operator">></span> /etc/nginx/conf.d/kibana.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
server &#123;
	listen 80;
	server_name kibana.oldboyedu.com;
    location / &#123;
        proxy_pass http://10.0.0.103:5601<span class="token variable">$request_uri</span>;
        auth_basic "oldboyedu kibana web!";
        auth_basic_user_file conf/htpasswd;
    &#125;
&#125;
EOF</span>

<span class="token comment"># (3)创建账号⽂件</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /etc/nginx/conf
htpasswd <span class="token parameter variable">-c</span> <span class="token parameter variable">-b</span> /etc/nginx/conf/htpasswd admin oldboyedu

<span class="token comment"># (4)启动nginx服务</span>
nginx <span class="token parameter variable">-t</span>
systemcat restart nginx

<span class="token comment"># (5)访问nginx验证kibana访问	如下图所示。</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667458890281.png"></p>
<h3 id="2-配置-ES-集群-TLS-认证"><a href="#2-配置-ES-集群-TLS-认证" class="headerlink" title="2.配置 ES 集群 TLS 认证"></a>2.配置 ES 集群 TLS 认证</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667458780145.png"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)⽣成证书⽂件</span>
<span class="token builtin class-name">cd</span> /oldboyedu/softwares/es/
elasticsearch-certutil cert <span class="token parameter variable">-out</span> config/elastic-certificates.p12 <span class="token parameter variable">-pass</span> <span class="token string">""</span>

<span class="token comment"># (2)为证书⽂件修改属主和属组</span>
<span class="token function">chown</span> oldboyedu:oldboyedu config/elastic-certificates.p12

<span class="token comment"># (3)同步证书⽂件到其他节点</span>
data_rsync.sh <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/config/elastic-certificates.p12

<span class="token comment"># (4)修改ES集群的配置⽂件</span>
vim/oldboyedu/softwares/es/config/elasticsearch.yml
<span class="token punctuation">..</span>.
<span class="token comment"># 在最后⼀⾏添加以下内容</span>
xpack.security.enabled: <span class="token boolean">true</span>
xpack.security.transport.ssl.enabled: <span class="token boolean">true</span>
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: elastic-certificates.p12

<span class="token comment"># (5)同步ES配置⽂件到其他节点</span>
data_rsync.sh <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/config/elasticsearch.yml

<span class="token comment"># (6)所有节点重启ES集群</span>
systemctl restart es

<span class="token comment"># (7)⽣成随机密码(如上图所示)</span>
elasticsearch-setup-passwords auto

<span class="token comment"># (8)postman访问	如下图所示。</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667458804018.png"></p>
<h3 id="3-kibana-添加-ES-认证"><a href="#3-kibana-添加-ES-认证" class="headerlink" title="3.kibana 添加 ES 认证"></a>3.kibana 添加 ES 认证</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># (1)修改kibana的配置⽂件</span>
<span class="token function">vim</span> /oldboyedu/softwares/kibana/config/kibana.yml
<span class="token punctuation">..</span>.

elasticsearch.username: <span class="token string">"kibana_system"</span>
elasticsearch.password: <span class="token string">"NqJFTqDoVLmgX70bMc9t"</span>

<span class="token comment"># (2)重启kibana访问</span>
<span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"kibana"</span> oldboyedu

<span class="token comment"># (3)访问测试	如下图所示。</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/lujinkai/1667458744466.png"></p>
<h3 id="4-kibana-的-RBAC"><a href="#4-kibana-的-RBAC" class="headerlink" title="4.kibana 的 RBAC"></a>4.kibana 的 RBAC</h3><p><img data-src="//img.to2b.cn/blog/lujinkai/1667458716770.png"></p>
<p>具体实操⻅视频。</p>
<h3 id="5-logstash-写入-ES-加密集群案例"><a href="#5-logstash-写入-ES-加密集群案例" class="headerlink" title="5.logstash 写入 ES 加密集群案例"></a>5.logstash 写入 ES 加密集群案例</h3><pre class="language-bash" data-language="bash"><code class="language-bash">input <span class="token punctuation">&#123;</span>
	stdin <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
output <span class="token punctuation">&#123;</span>
	stdout <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    elasticsearch <span class="token punctuation">&#123;</span>
        index <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"oldboyedu-linux80-logstash-6666666666666666666"</span>
        hosts <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"10.0.0.101:9200"</span>
        user <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"logstash-linux80"</span>
        password <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"123456"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>温馨提示:<br>建议⼤家不要使⽤ elastic 管理员⽤户给 logstash 程序使⽤，⽽是创建⼀个普通⽤户，并为该⽤户细化权限。</p>
<h3 id="6-filebeat-写入-ES-加密集群案例"><a href="#6-filebeat-写入-ES-加密集群案例" class="headerlink" title="6.filebeat 写入 ES 加密集群案例"></a>6.filebeat 写入 ES 加密集群案例</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> stdin

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://10.0.0.101:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.102:9200"</span><span class="token punctuation">,</span> <span class="token string">"http://10.0.0.103:9200"</span><span class="token punctuation">]</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux80-stdin-%&#123;+yyyy.MM.dd&#125;"</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"filebeat-linux80"</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>

<span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux"</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"oldboyedu-linux*"</span>
<span class="token key atrule">setup.template.overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre>

<p>温馨提示:<br>建议⼤家不要使⽤ elastic 管理员⽤户给 filebeat 程序使⽤，⽽是创建⼀个普通⽤户，并为该⽤户细化权限。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="//img.to2b.cn/blog/ljk/1607160536339.png" alt="像方便面一样的男子 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="//img.to2b.cn/blog/ljk/1607160019009.png" alt="像方便面一样的男子 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/ELK/" rel="tag"><i class="fa fa-tag"></i> ELK</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/Jenkins%E4%B8%8EGitlab/postgresql/" rel="prev" title="postgresql">
                  <i class="fa fa-chevron-left"></i> postgresql
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/ELK/ELK/" rel="next" title="ELK">
                  ELK <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.to2b.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.to2b.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.to2b.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.to2b.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
