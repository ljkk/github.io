<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.lujinkai.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.lujinkai.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="补充知识：iSCSI 概括的说，iSCSI 是一种存储设备远程映射技术，它可以将一个远程服务器上的存储设备映射到本地，并呈现为一个块设备（大白话就是磁盘）。从普通用户的角度，映射过来的磁盘与本地安装的磁盘毫无差异。 这种映射方式基于是基于 SCSI 协议的，SCSI 协议是计算机与外围设备（例如硬盘、光盘等）通信的协议。而 iSCSI 则是通过 TCP 协议对 SCSI 进行封装的一种协议，也就是">
<meta property="og:type" content="article">
<meta property="og:title" content="文件共享服务">
<meta property="og:url" content="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:description" content="补充知识：iSCSI 概括的说，iSCSI 是一种存储设备远程映射技术，它可以将一个远程服务器上的存储设备映射到本地，并呈现为一个块设备（大白话就是磁盘）。从普通用户的角度，映射过来的磁盘与本地安装的磁盘毫无差异。 这种映射方式基于是基于 SCSI 协议的，SCSI 协议是计算机与外围设备（例如硬盘、光盘等）通信的协议。而 iSCSI 则是通过 TCP 协议对 SCSI 进行封装的一种协议，也就是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1605015314494.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1605015584443.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1605016511802.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1605016539213.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1605259157055.png">
<meta property="article:published_time" content="2020-12-09T15:38:35.000Z">
<meta property="article:modified_time" content="2023-05-29T08:58:05.514Z">
<meta property="article:author" content="像方便面一样的男子">
<meta property="article:tag" content="文件共享">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.to2b.cn/blog/ljk/1605015314494.png">


<link rel="canonical" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/","path":"运维/网络文件共享/网络文件共享服务/","title":"文件共享服务"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>文件共享服务 | LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LJKのBlog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.</span> <span class="nav-text">存储类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E5%AD%98%E5%82%A8%E6%AF%94%E8%BE%83"><span class="nav-number">1.1.</span> <span class="nav-text">三种存储比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E5%AD%98%E5%82%A8%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.2.</span> <span class="nav-text">三种存储应用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FTP-%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.</span> <span class="nav-text">FTP 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vsftpd"><span class="nav-number">2.1.</span> <span class="nav-text">vsftpd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pureftpd"><span class="nav-number">2.2.</span> <span class="nav-text">pureftpd</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NFS-%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.</span> <span class="nav-text">NFS 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">3.1.</span> <span class="nav-text">工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nfs-%E8%BD%AF%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.2.</span> <span class="nav-text">nfs 软件介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nfs-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.3.</span> <span class="nav-text">nfs 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nfs-%E5%B7%A5%E5%85%B7"><span class="nav-number">3.4.</span> <span class="nav-text">nfs 工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#fpcinfo"><span class="nav-number">3.4.1.</span> <span class="nav-text">fpcinfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exportfs"><span class="nav-number">3.4.2.</span> <span class="nav-text">exportfs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#showmount"><span class="nav-number">3.4.3.</span> <span class="nav-text">showmount</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monut"><span class="nav-number">3.4.4.</span> <span class="nav-text">monut</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E6%8C%82%E8%BD%BD-autofs"><span class="nav-number">3.5.</span> <span class="nav-text">自动挂载 autofs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#x2F-etc-x2F-fstab-%E5%92%8C-autofs"><span class="nav-number">3.5.1.</span> <span class="nav-text">&#x2F;etc&#x2F;fstab 和 autofs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SAMBA-%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">SAMBA 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#samba-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.</span> <span class="nav-text">samba 服务器配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#smb-conf-%E4%B8%AD%E7%9A%84%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="nav-number">4.1.1.</span> <span class="nav-text">smb.conf 中的宏定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#global-%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.2.</span> <span class="nav-text">[global] 全局配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E5%AE%9A%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.3.</span> <span class="nav-text">特定共享目录配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#samba-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="nav-number">4.2.</span> <span class="nav-text">samba 用户管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#smbpasswd-%E5%91%BD%E4%BB%A4"><span class="nav-number">4.2.1.</span> <span class="nav-text">smbpasswd 命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A"><span class="nav-number">4.2.2.</span> <span class="nav-text">案例：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5"><span class="nav-number">5.</span> <span class="nav-text">数据的实时同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#inotify"><span class="nav-number">5.1.</span> <span class="nav-text">inotify</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#inotify-%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="nav-number">5.1.1.</span> <span class="nav-text">inotify 内核参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#inotify-tools"><span class="nav-number">5.1.2.</span> <span class="nav-text">inotify-tools</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#inotifywait"><span class="nav-number">5.1.2.1.</span> <span class="nav-text">inotifywait</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#inotifywatch"><span class="nav-number">5.1.2.2.</span> <span class="nav-text">inotifywatch</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rsync"><span class="nav-number">5.2.</span> <span class="nav-text">rsync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inotify-rsync-shell-%E8%84%9A%E6%9C%AC-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="nav-number">5.3.</span> <span class="nav-text">inotify+rsync+shell 脚本 实现实时数据同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sersync-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="nav-number">5.4.</span> <span class="nav-text">sersync 实现实时数据同步</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-rsync-daemon-%E5%AE%9E%E7%8E%B0-sersync"><span class="nav-number">5.4.1.</span> <span class="nav-text">基于 rsync daemon 实现 sersync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E8%BF%9C%E7%A8%8B-shell-%E5%AE%9E%E7%8E%B0-sersync"><span class="nav-number">5.4.2.</span> <span class="nav-text">基于远程 shell 实现 sersync</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="文件共享服务 | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          文件共享服务
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:38:35" itemprop="dateCreated datePublished" datetime="2020-12-09T23:38:35+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/" itemprop="url" rel="index"><span itemprop="name">网络文件共享</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>补充知识：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/60986068">iSCSI</a></p>
<p>概括的说，iSCSI 是一种存储设备远程映射技术，它可以将一个远程服务器上的存储设备映射到本地，并呈现为一个块设备（大白话就是磁盘）。从普通用户的角度，映射过来的磁盘与本地安装的磁盘毫无差异。</p>
<p>这种映射方式基于是基于 SCSI 协议的，SCSI 协议是计算机与外围设备（例如硬盘、光盘等）通信的协议。而 iSCSI 则是通过 TCP 协议对 SCSI 进行封装的一种协议，也就是通过以太网传输 SCSI 协议的内容。</p>
<h2 id="存储类型"><a href="#存储类型" class="headerlink" title="存储类型"></a>存储类型</h2><p>存储类型分为三类：</p>
<ul>
<li><p>直连式存储：Direct-Attached Storage，简称 DAS</p>
</li>
<li><p>网络附加存储：Network-Attached Storage，简称 NAS</p>
</li>
<li><p>存储区域网络：Storage Area Network，简称 SAN</p>
<p>FC：Fibre Channel 光纤</p>
</li>
</ul>
<p><img data-src="//img.to2b.cn/blog/ljk/1605015314494.png"></p>
<h3 id="三种存储比较"><a href="#三种存储比较" class="headerlink" title="三种存储比较"></a>三种存储比较</h3><p><img data-src="//img.to2b.cn/blog/ljk/1605015584443.png"></p>
<h3 id="三种存储应用场景"><a href="#三种存储应用场景" class="headerlink" title="三种存储应用场景"></a>三种存储应用场景</h3><ul>
<li>DAS 虽然比较古老了，但是还是很适用于那些数据量不大，对磁盘访问速度要求较高的中小企业</li>
<li>NAS 多适用于文件服务器，用来存储非结构化数据，虽然受限于以太网的速度，但是部署灵活，成本低</li>
<li>SAN 则适用于大型应用或数据库系统，缺点是成本高、较为复杂</li>
</ul>
<h2 id="FTP-服务"><a href="#FTP-服务" class="headerlink" title="FTP 服务"></a>FTP 服务</h2><p>文件传输协议：File Transfer Protocol，基于 C&#x2F;S 结构</p>
<p>数据传输格式：二进制（默认）和文本</p>
<p>双通道协议：命令和数据传输使用不同的端口</p>
<p>两种模式：从服务器角度命令 <strong>主动</strong> 和 <strong>被动</strong> 模式</p>
<ul>
<li><p>主动模式：Port Style</p>
<p>windows 连接 FTP 服务器默认使用主动模式</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605016511802.png"></p>
</li>
<li><p>被动模式：PASV Style</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605016539213.png"></p>
</li>
</ul>
<p>FTP 服务状态码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1XX：信息   125：数据连接打开</span><br><span class="line">2XX：成功类状态   200：命令OK 230：登录成功</span><br><span class="line">3XX：补充类   331：用户名OK</span><br><span class="line">4XX：客户端错误   425：不能打开数据连接</span><br><span class="line">5XX：服务器错误   530：不能登录</span><br></pre></td></tr></table></figure>

<p>用户认证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">匿名用户：ftp、anonymous，对应Linux用户ftp</span><br><span class="line">系统用户：Linux用户、用户/etc/passwd，密码/etc/shadow</span><br><span class="line">虚拟用户：特定服务的专用用户、独立的用户/密码文件</span><br></pre></td></tr></table></figure>

<p>常见 FTP 相关软件：</p>
<ul>
<li><p>FTP 服务器端软件</p>
<p>Wu-ftpd、Proftpd、Pureftpd、Filezilla Server、Serv-U、Wing FTP Server、IIS</p>
<p><a target="_blank" rel="noopener" href="https://security.appspot.com/vsftpd.html">vsftpd</a>：Very Secure FTP Daemon，CentOS 默认 FTP 服务器</p>
</li>
<li><p>客户端软件</p>
<p>ftp、lftp、lftpget、wget、curl</p>
</li>
</ul>
<h3 id="vsftpd"><a href="#vsftpd" class="headerlink" title="vsftpd"></a>vsftpd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="pureftpd"><a href="#pureftpd" class="headerlink" title="pureftpd"></a>pureftpd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="NFS-服务"><a href="#NFS-服务" class="headerlink" title="NFS 服务"></a>NFS 服务</h2><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>Network File System：网络文件系统，基于内核的文件系统。通过 NFS，用户和程序可以像访问本地文件一样去访问远端系统上的文件，基于 RPC（Remote Procedure Call Protecol）实现。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1605259157055.png"></p>
<p>上图中的 portmap，自 centos6 之后就被 rpcbind 代替了</p>
<p><strong>优点：</strong>节省本地存储空间,将常用的数据,如:&#x2F;home 目录,存放在 NFS 服务器上且可以通过网络访问,本地终端将可减少自身存储空间的使用</p>
<p><strong>缺点：</strong>1. 占用带宽；2. 端口号比较多，而且不固定，防火墙不太好配；所以 nfs 一般不用在互联网，都是用在局域网</p>
<h3 id="nfs-软件介绍"><a href="#nfs-软件介绍" class="headerlink" title="nfs 软件介绍"></a>nfs 软件介绍</h3><p>软件包：nfs-utils（包括服务器和客户端相关工具）</p>
<p>相关软件包：rpcbind（必须）、tcp_wrappers</p>
<p>kernel 支持：nfs.ko</p>
<p>端口：2049（nfsd），其他端口由 portmap 分配</p>
<p>nfs 服务主要进程：</p>
<ul>
<li>rpc.nfsd：最主要的 NFS 进程,管理客户端是否可登录</li>
<li>rpc.mountd：挂载和卸载 NFS 文件系统,包括权限管理</li>
<li>rpc.lockd：非必要,管理文件锁,避免同时写出错</li>
<li>rpc.statd：非必要,检查文件一致性,可修复文件</li>
</ul>
<p>日志：&#x2F;var&#x2F;lib&#x2F;nfs</p>
<p>配置文件：&#x2F;etc&#x2F;exports 和 &#x2F;etc&#x2F;exports.d&#x2F;*.exports</p>
<h3 id="nfs-配置文件"><a href="#nfs-配置文件" class="headerlink" title="nfs 配置文件"></a>nfs 配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dir	host1(opt1,opt2)	host2(opt1,opt2)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>host 格式：支持通配符 *、ipv4、ipv6、FQDN（全域名）、NIS 域的主机组</p>
</li>
<li><p>opt 格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">默认选项：(ro,<span class="built_in">sync</span>,root_squash,no_all_squash)</span><br><span class="line">ro：只读</span><br><span class="line">rw：可读可写</span><br><span class="line">async：异步,数据变化后不立即写磁盘,先写入到缓冲区中,过一段时间再写入磁盘,性能高,安全性低</span><br><span class="line"><span class="built_in">sync</span>：1.0.0后为默认，同步,数据在请求时立即写入共享存储磁盘,性能低,安全性高</span><br><span class="line">root_squash：默认，远程root映射为nobody（CentOS7以前的版本为nfsnobody）,UID为65534</span><br><span class="line">no_root_squash：远程root映射成NFS服务器的root用户，squash的意思是压榨</span><br><span class="line">all_squash：所有远程用户(包括root)都被压榨</span><br><span class="line">no_all_squash：默认，保留共享文件的UID和GID，即不压榨</span><br><span class="line">anonuid和anongid：指明匿名用户映射为特定用户UID和组GID,而非nobody,可配合all_squash使用</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  默认把root用户压榨成nobody用户，普通用户不压榨，anonuid和anongid可以设置默认压榨成哪个用户</span><br><span class="line"></span><br><span class="line">范例：</span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line"># vim /etc/exports</span><br><span class="line"></span><br><span class="line">/data/script 10.0.0.0/24(ro,async)</span><br><span class="line">/data/script 10.0.0.0/24(rw,async,root_squash,anonuid=1000,anongid=1000,all_squash)</span><br><span class="line"></span><br><span class="line">/myshare server.example.com</span><br><span class="line">/myshare *.example.com</span><br><span class="line">/myshare server?.example.com</span><br><span class="line">/myshare server[0-20].example.com</span><br><span class="line">/myshare 172.25.11.10</span><br><span class="line">/myshare 172.25.0.0/16</span><br><span class="line">/myshare 2000:472:18:b51:c32:a21</span><br><span class="line">/myshare 2000:472:18:b51::/64</span><br><span class="line">/myshare *.example.com 172.25.0.0/16</span><br><span class="line">/myshare desktop.example.com(ro)</span><br><span class="line">/myshare desktop.example.com(ro) server[0-20].example.com(rw)</span><br><span class="line">/myshare diskless.example.com(rw,no_root_squash)</span><br></pre></td></tr></table></figure>

<h3 id="nfs-工具"><a href="#nfs-工具" class="headerlink" title="nfs 工具"></a>nfs 工具</h3><h4 id="fpcinfo"><a href="#fpcinfo" class="headerlink" title="fpcinfo"></a>fpcinfo</h4><p>rpcinfo 工具可以查看 RPC 相关信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看注册在指定主机的RPC程序</span></span><br><span class="line">rpcinfo -p hostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看RPC注册程序</span></span><br><span class="line">rpcinfo -s hostname</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#rpcinfo -p</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rpcinfo -s</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#rpcinfo -p 10.0.0.8	# 查看远程主机</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#rpcinfo -s 10.0.0.8</span></span><br></pre></td></tr></table></figure>

<h4 id="exportfs"><a href="#exportfs" class="headerlink" title="exportfs"></a>exportfs</h4><p>用于管理 NFS 导出的文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exportfs [-avi] [-o options,..] [client:/path ..]</span><br><span class="line">exportfs -r [-v]</span><br><span class="line">exportfs [-av] -u [client:/path ..]</span><br><span class="line">exportfs [-v]</span><br><span class="line">exportfs -f</span><br><span class="line">exportfs -s</span><br></pre></td></tr></table></figure>

<ul>
<li>-v：查看本机所有 NFS 共享</li>
<li>-r：重读配置文件，这个选项可以避免重启服务</li>
<li>-a：输出本机所有共享</li>
<li>-au：停止本机所有共享</li>
</ul>
<h4 id="showmount"><a href="#showmount" class="headerlink" title="showmount"></a>showmount</h4><p>常见用法：查看远程主机的 nfs 共享</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e hostname</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#showmount -e 10.0.0.8</span></span><br><span class="line">Export list <span class="keyword">for</span> 10.0.0.8:</span><br><span class="line">/data/wordpress *</span><br></pre></td></tr></table></figure>

<h4 id="monut"><a href="#monut" class="headerlink" title="monut"></a>monut</h4><p>客户端 nfs 挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount [-fnrsvw] -t nfs [-o options] device <span class="built_in">dir</span></span><br></pre></td></tr></table></figure>

<p>options：</p>
<ul>
<li>nfsvers&#x3D;n</li>
<li>vers&#x3D;n</li>
<li>soft &#x2F; hard</li>
<li></li>
</ul>
<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="自动挂载-autofs"><a href="#自动挂载-autofs" class="headerlink" title="自动挂载 autofs"></a>自动挂载 autofs</h3><p>使用 autofs 服务按需要挂载外围设备，NFS 共享等，并在空闲 5 分钟后后自动卸载</p>
<p>配置文件：&#x2F;etc&#x2F;auto.master</p>
<p>案例：</p>
<p>10.0.0.1(ubuntu)：nfs server，共享&#x2F;data&#x2F;wwwroot&#x2F;script 目录</p>
<p>10.0.0.71(centos)：nfs client</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.1</span></span><br><span class="line"><span class="comment"># 安装nfs服务端软件</span></span><br><span class="line">lujinkai@Z510:~$ sudo apt -y install nfs-kernel-server</span><br><span class="line"><span class="comment"># 修改exports共享设置文件</span></span><br><span class="line">lujinkai@Z510:~$ vim /etc/exports</span><br><span class="line">/data/wwwroot/script 10.0.0.0/24(rw,async,root_squash,anonuid=1000,anongid=1000,all_squash)</span><br><span class="line"><span class="comment"># 重新加载配置文件</span></span><br><span class="line">lujinkai@Z510:~$ sudo exportfs -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.0.71</span></span><br><span class="line"><span class="comment"># 安装autofs，并设置开机自启</span></span><br><span class="line">[root@c71 ~]<span class="variable">$yum</span> -y install autofs</span><br><span class="line">[root@c71 ~]<span class="variable">$systemctl</span> <span class="built_in">enable</span> --now autofs.service</span><br><span class="line"><span class="comment"># 查看10.0.0.1共享的目录</span></span><br><span class="line">[root@c71 ~]<span class="variable">$showmount</span> -e 10.0.0.1</span><br><span class="line">Export list <span class="keyword">for</span> 10.0.0.1:</span><br><span class="line">/data/wwwroot/script 10.0.0.0/24</span><br><span class="line"><span class="comment"># 修改auto.master，注意格式，`man auto.master`可以查看格式</span></span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/auto.master</span><br><span class="line">...</span><br><span class="line">/root/www /etc/auto.www</span><br><span class="line"><span class="comment"># 编辑/root/www指定的配置文件</span></span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/auto.www</span><br><span class="line">script -fstype=nfs 10.0.0.1:/home/lujinkai/www/script</span><br><span class="line"><span class="comment"># 重启autofs</span></span><br><span class="line">[root@c71 ~]<span class="variable">$systemctl</span> restart autofs.service</span><br><span class="line"><span class="comment"># 查看是否挂载成功</span></span><br><span class="line">[root@c71 ~]<span class="variable">$cd</span> ~/www/</span><br><span class="line">[root@c71 www]<span class="variable">$ll</span>	<span class="comment"># 没有任何东西</span></span><br><span class="line">总用量 0</span><br><span class="line">[root@c71 www]<span class="variable">$df</span> -Th ./</span><br><span class="line">文件系统       类型    容量  已用  可用 已用% 挂载点</span><br><span class="line">/etc/auto.www  autofs     0     0     0     - /root/www</span><br><span class="line">[root@c71 www]<span class="variable">$cd</span> script	<span class="comment"># 直接进入，就会自动挂载</span></span><br><span class="line">[root@c71 script]<span class="variable">$ll</span></span><br><span class="line">总用量 48</span><br><span class="line">-rwxrwxrwx 1 lujinkai lujinkai  688 11月 13 21:54 demo.sh</span><br><span class="line">drwxrwxrwx 2 lujinkai lujinkai 4096 11月 12 10:09 etc</span><br><span class="line">drwxrwxrwx 4 lujinkai lujinkai 4096 11月 12 16:30 include</span><br><span class="line">drwxrwxrwx 2 lujinkai lujinkai 4096 11月 12 19:34 ini</span><br><span class="line">drwxrwxrwx 2 lujinkai lujinkai 4096 11月 11 11:08 init.d</span><br><span class="line">-rwxrwxrwx 1 lujinkai lujinkai 3750 10月 31 20:11 install.sh</span><br><span class="line">-rwxrwxrwx 1 lujinkai lujinkai 2051 10月 31 15:52 magedu.sh</span><br><span class="line">-rwxrwxrwx 1 lujinkai lujinkai 1462 10月 28 15:58 scp_list.sh</span><br><span class="line">-rwxrwxrwx 1 lujinkai lujinkai 1744 11月 11 10:54 scp_sh.sh</span><br><span class="line">-rwxrwxrwx 1 lujinkai lujinkai 1440 10月 13 21:57 sftp-config.json</span><br><span class="line">drwxrwxrwx 3 lujinkai lujinkai 4096 11月 11 11:03 src</span><br><span class="line">-rwxrwxr-x 1 lujinkai lujinkai 1211 11月 11 10:55 u_scp_sh.sh</span><br><span class="line">[root@c71 script]<span class="variable">$df</span> -Th ./</span><br><span class="line">文件系统                           类型  容量  已用  可用 已用% 挂载点</span><br><span class="line">10.0.0.1:/home/lujinkai/www/script nfs4  117G   37G   74G   34% /root/www/script</span><br></pre></td></tr></table></figure>

<h4 id="x2F-etc-x2F-fstab-和-autofs"><a href="#x2F-etc-x2F-fstab-和-autofs" class="headerlink" title="&#x2F;etc&#x2F;fstab 和 autofs"></a>&#x2F;etc&#x2F;fstab 和 autofs</h4><p>&#x2F;etc&#x2F;fstab 设置开机自动挂载，系统开机会去读取这个文件，用于挂载本地固定设备，如硬盘</p>
<p>autofs 设置自动挂载，只有当访问挂载点的时候，autofs 才会挂载，过一段时间没有访问，autofs 就会自动卸载设备，用于挂载动态的设备，如光盘、nfs、smb 等文件系统</p>
<h2 id="SAMBA-服务"><a href="#SAMBA-服务" class="headerlink" title="SAMBA 服务"></a>SAMBA 服务</h2><p>官网：<a target="_blank" rel="noopener" href="https://www.samba.org/">https://www.samba.org/</a></p>
<p>相关包：</p>
<ul>
<li>samba 提供 smb 服务器端</li>
<li>samba-client 客户端软件</li>
<li>samba-common 通用软件</li>
<li>cifs-utils smb 客户端工具</li>
<li>samba-winbind 和 AD 相关</li>
</ul>
<p>相关服务进程：</p>
<ul>
<li>smbd 提供 smb(cifs)服务 TCP：139、445</li>
<li>nmbd NetBIOS 名称解析 UDP：137、138，如果不使用计算机名来访问，这个就没用</li>
</ul>
<p>主配置文件：&#x2F;etc&#x2F;samba&#x2F;smb.conf</p>
<p>语法检查: testparm [-v] [&#x2F;etc&#x2F;samba&#x2F;smb.conf]</p>
<p>客户端工具：smbclient、mount.cifs</p>
<h3 id="samba-服务器配置"><a href="#samba-服务器配置" class="headerlink" title="samba 服务器配置"></a>samba 服务器配置</h3><p>&#x2F;etc&#x2F;samba&#x2F;smb.conf 是主配置文件，ini 格式，来自 samba-common 包</p>
<p>分为全局配置[global] 和特定的共享设置，例如[homes]、[printers]等\</p>
<h4 id="smb-conf-中的宏定义"><a href="#smb-conf-中的宏定义" class="headerlink" title="smb.conf 中的宏定义"></a>smb.conf 中的宏定义</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">%m 客户端主机的NetBIOS名</span><br><span class="line">%M 客户端主机的FQDN</span><br><span class="line">%H 当前用户家目录路径</span><br><span class="line">%U 当前用户的用户名</span><br><span class="line">%g 当前用户所属组</span><br><span class="line">%h samba服务器的主机名</span><br><span class="line">%L samba服务器的NetBIOS名</span><br><span class="line">%I 客户端主机的IP，是i的大写字母</span><br><span class="line">%T 当前日期和时间</span><br><span class="line">%S 可登录的用户名</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="global-全局配置"><a href="#global-全局配置" class="headerlink" title="[global] 全局配置"></a>[global] 全局配置</h4><ul>
<li><p>workgroup：指定工作组名称</p>
</li>
<li><p>server string：主机注释信息</p>
</li>
<li><p>netbios name：指定 NetBIOS 名，可以被 SAMBA 客户端使用，但不支持 ping</p>
<p>注意：netbios name 需要启动 nmb 服务</p>
<p>范例：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">workgroup</span> = workgroup</span><br><span class="line">netbios <span class="attr">name</span> = smbserver <span class="comment"># 此设置需要启动nmb服务才可能生效</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>interfaces：指定服务侦听接口和 IP</p>
</li>
<li><p>hosts allow： 允许指定主机访问，可用逗号，空格，或 tab 分隔，默认允许所有主机访问，可以在其他共享独立配置，但是[global]中的设置会覆盖其他共享设置，可以是以下格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.16.0.0/24</span><br><span class="line">172.16.0.0/255.255.255.0</span><br><span class="line">desktop.example.com</span><br><span class="line">.example.com	<span class="comment"># 以example.com后缀的主机名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>hosts deny：拒绝指定主机访问，格式和 hosts allow 相同</p>
</li>
<li><p>config file&#x3D;&#x2F;etc&#x2F;samba&#x2F;conf.d&#x2F;%U：用户独立的配置文件</p>
</li>
<li><p>log file&#x3D;&#x2F;var&#x2F;log&#x2F;samba&#x2F;log.%I：不同客户机采用不同日志</p>
</li>
<li><p>log level &#x3D; 2：日志级别，默认为 0，不记录日志</p>
<p>范例：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line">Log <span class="attr">file</span>=/var/log/samba/log.%I</span><br><span class="line">log <span class="attr">level</span> = <span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>max log size&#x3D;50：日志文件达到 50K，将轮循 rotate，单位 KB</p>
</li>
<li><p>security&#x3D;user：认证方式，有三种</p>
<ul>
<li>user：samba 用户（采有 linux 用户，samba 的独立口令）</li>
<li>share：匿名(CentOS7 不再支持)，已不建议使用</li>
<li>server：已不建议使用</li>
</ul>
</li>
<li><p>passdb backend &#x3D; tdbsam：密码数据库格式</p>
</li>
<li><p>…</p>
</li>
</ul>
<h4 id="特定共享目录配置"><a href="#特定共享目录配置" class="headerlink" title="特定共享目录配置"></a>特定共享目录配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[共享名称] 		 <span class="comment"># 远程网络看到的共享名称</span></span><br><span class="line">comment 		<span class="comment"># 注释信息</span></span><br><span class="line">path 			<span class="comment"># 所共享的目录路径</span></span><br><span class="line">public			<span class="comment"># 能否被guest访问的共享，默认no，和guest=ok 类似</span></span><br><span class="line">browsable 		<span class="comment"># 是否允许所有用户浏览此共享,默认为yes,no为隐藏</span></span><br><span class="line">writable=<span class="built_in">yes</span> 	<span class="comment"># 可以被所有用户读写，默认为no</span></span><br><span class="line"><span class="built_in">read</span> only=no 	<span class="comment"># 和writable=yes等价，如与以上设置冲突，放在后面的设置生效，默认只读</span></span><br><span class="line">write list		<span class="comment"># 可读写的用户，可设置为用户或者组，用空格或逗号分隔，用户组有两种格式：@组名、+组名；如果设置writable=no，那write list中的用户和组可读写</span></span><br><span class="line">valid <span class="built_in">users</span> 	<span class="comment"># 规定合法用户，即能访问该共享的用户，用空格或逗号分隔，如为空，将允许所有</span></span><br><span class="line">force group		<span class="comment"># 指定存取资源时须以此设定的群组使用者进入才能存取(用户名/@组名)</span></span><br><span class="line">force user		<span class="comment"># 指定存取资源时须以此设定的使用者进入才能存取(用户名/@组名)</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[share]</span></span><br><span class="line"><span class="attr">path</span> = /data/dir</span><br><span class="line">valid <span class="attr">users</span>=wang,@admins</span><br><span class="line"><span class="attr">writeable</span> = <span class="literal">no</span></span><br><span class="line"><span class="attr">browseable</span> = <span class="literal">no</span></span><br></pre></td></tr></table></figure>

<h3 id="samba-用户管理"><a href="#samba-用户管理" class="headerlink" title="samba 用户管理"></a>samba 用户管理</h3><h4 id="smbpasswd-命令"><a href="#smbpasswd-命令" class="headerlink" title="smbpasswd 命令"></a>smbpasswd 命令</h4><p>smbpasswd 用于管理 samba 用户</p>
<p><strong>添加用户：</strong>实际上是把把系统用户映射为 samba 用户，所以添加的用户首先必须是 linux 系统用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd -a &lt;user&gt;		# 交互式</span><br><span class="line">pdbedit -a -u &lt;user&gt;</span><br></pre></td></tr></table></figure>

<p><strong>修改用户密码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd &lt;user&gt;	<span class="comment"># 交互式</span></span><br></pre></td></tr></table></figure>

<p><strong>删除用户和密码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd -x &lt;user&gt;</span><br><span class="line">pdbedit -x -u &lt;user&gt;	<span class="comment"># 这个好像权限更大</span></span><br></pre></td></tr></table></figure>

<p><strong>查看 samba 用户列表：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pdbedit -L -v</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为了方便配置，可以将用户指定同一个组</span></span><br><span class="line">[root@c71 ~]$ groupadd -r smb</span><br><span class="line">[root@c71 ~]<span class="variable">$useradd</span> -G smb -s /sbin/nologin smb1</span><br><span class="line">[root@c71 ~]<span class="variable">$useradd</span> -G smb -s /sbin/nologin smb2</span><br><span class="line"></span><br><span class="line">[root@c71 ~]<span class="variable">$smbpasswd</span> -a smb1</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">[root@c71 ~]<span class="variable">$smbpasswd</span> -a smb2</span><br><span class="line">New SMB password:</span><br><span class="line">Retype new SMB password:</span><br><span class="line">Added user smb2.</span><br><span class="line"></span><br><span class="line">[root@c71 ~]<span class="variable">$pdbedit</span> -L</span><br><span class="line">smb1:1001:</span><br><span class="line">smb2:1002:</span><br><span class="line">[root@c71 ~]<span class="variable">$pdbedit</span> -L -v</span><br><span class="line">---------------</span><br><span class="line">Unix username:        smb1</span><br><span class="line">NT username:</span><br><span class="line">Account Flags:        [U          ]</span><br><span class="line">User SID:             S-1-5-21-540276018-2794668495-3753694806-1000</span><br><span class="line">Primary Group SID:    S-1-5-21-540276018-2794668495-3753694806-513</span><br><span class="line">Full Name:</span><br><span class="line">Home Directory:       \\c71\smb1</span><br><span class="line">HomeDir Drive:</span><br><span class="line">Logon Script:</span><br><span class="line">Profile Path:         \\c71\smb1\profile</span><br><span class="line">Domain:               C71</span><br><span class="line">Account desc:</span><br><span class="line">Workstations:</span><br><span class="line">Munged dial:</span><br><span class="line">Logon time:           0</span><br><span class="line">Logoff time:          Wed, 06 Feb 2036 23:06:39 CST</span><br><span class="line">Kickoff time:         Wed, 06 Feb 2036 23:06:39 CST</span><br><span class="line">Password last <span class="built_in">set</span>:    Sat, 14 Nov 2020 17:46:18 CST</span><br><span class="line">Password can change:  Sat, 14 Nov 2020 17:46:18 CST</span><br><span class="line">Password must change: never</span><br><span class="line">Last bad password   : 0</span><br><span class="line">Bad password count  : 0</span><br><span class="line">Logon hours         : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span><br><span class="line">---------------</span><br><span class="line">Unix username:        smb2</span><br><span class="line">NT username:</span><br><span class="line">Account Flags:        [U          ]</span><br><span class="line">User SID:             S-1-5-21-540276018-2794668495-3753694806-1001</span><br><span class="line">Primary Group SID:    S-1-5-21-540276018-2794668495-3753694806-513</span><br><span class="line">Full Name:</span><br><span class="line">Home Directory:       \\c71\smb2</span><br><span class="line">HomeDir Drive:</span><br><span class="line">Logon Script:</span><br><span class="line">Profile Path:         \\c71\smb2\profile</span><br><span class="line">Domain:               C71</span><br><span class="line">Account desc:</span><br><span class="line">Workstations:</span><br><span class="line">Munged dial:</span><br><span class="line">Logon time:           0</span><br><span class="line">Logoff time:          Wed, 06 Feb 2036 23:06:39 CST</span><br><span class="line">Kickoff time:         Wed, 06 Feb 2036 23:06:39 CST</span><br><span class="line">Password last <span class="built_in">set</span>:    Sat, 14 Nov 2020 17:46:24 CST</span><br><span class="line">Password can change:  Sat, 14 Nov 2020 17:46:24 CST</span><br><span class="line">Password must change: never</span><br><span class="line">Last bad password   : 0</span><br><span class="line">Bad password count  : 0</span><br><span class="line">Logon hours         : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span><br></pre></td></tr></table></figure>

<h4 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h4><p>实现不同 samba 用户访问相同的 samba 共享，实现不同的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.0.0.71 服务端</span></span><br><span class="line">[root@c71 ~]<span class="variable">$yum</span> -y install samba</span><br><span class="line">[root@c71 ~]<span class="variable">$groupadd</span> -r smb</span><br><span class="line">[root@c71 ~]<span class="variable">$useradd</span> -G smb -s /sbin/nologin smb1	<span class="comment"># 注意这里是-G，而不是-g</span></span><br><span class="line">[root@c71 ~]<span class="variable">$useradd</span> -G smb -s /sbin/nologin smb2</span><br><span class="line">[root@c71 ~]<span class="variable">$smbpasswd</span> -a smb1</span><br><span class="line">[root@c71 ~]<span class="variable">$smbpasswd</span> -a smb2</span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/samba/smb.conf</span><br><span class="line"><span class="comment">#在workgroup下加一行</span></span><br><span class="line">config file= /etc/samba/conf.d/%U</span><br><span class="line">[share]</span><br><span class="line">Path=/data/dir</span><br><span class="line">Read only= NO</span><br><span class="line">Guest ok = <span class="built_in">yes</span></span><br><span class="line">write list=@wheel</span><br><span class="line"><span class="comment">#针对smb1和smb2用户创建单独的配置文件</span></span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/samba/smb.conf/smb1</span><br><span class="line">[share]</span><br><span class="line">Path=/data/dir1</span><br><span class="line">Read only= NO 					<span class="comment"># 等价于writable = yes</span></span><br><span class="line">Create mask=0644 				<span class="comment"># 说明：默认为744</span></span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/samba/smb.conf/smb2</span><br><span class="line">[share]</span><br><span class="line">path=/data/dir2</span><br><span class="line">Read only= NO</span><br><span class="line">Create mask=0644</span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">[root@c71 ~]<span class="variable">$systemctl</span> restart smb.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.0.0.72 客户端</span></span><br><span class="line"><span class="comment"># 用户smb1，smb2访问share共享目录，看到目录是不同目录</span></span><br><span class="line">[root@c72 ~]<span class="variable">$yum</span> -y install samba-client cifs-utils</span><br><span class="line">[root@c72 ~]<span class="variable">$smbclient</span> //10.0.0.73/share -U smb1%123456</span><br><span class="line">[root@c72 ~]<span class="variable">$smbclient</span> //10.0.0.73/share -U smb2%123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># windows：文件管理器输入 \\10.0.0.73\share 回车，然后输入账号密码即可</span></span><br></pre></td></tr></table></figure>

<h2 id="数据的实时同步"><a href="#数据的实时同步" class="headerlink" title="数据的实时同步"></a>数据的实时同步</h2><p>实现实时同步的方法：</p>
<ul>
<li>inotify + rsync</li>
<li>sersync：国人周洋在 inotify 基础上开发的，功能强大，只是已经不再更新了</li>
</ul>
<h3 id="inotify"><a href="#inotify" class="headerlink" title="inotify"></a>inotify</h3><p>异步的文件系统事件监控机制，利用事件驱动机制，而无须通过诸如 cron 等的轮询机制来获取事件，linux 内核从 2.6.13 起支持 inotify，通过 inotify 可以监控文件系统中添加、删除，修改、移动等各种事件</p>
<p>inotify+rsync 使用方式：</p>
<ol>
<li>利用监控服务（inotify），监控同步数据服务器目录中信息的变化</li>
<li>发现目录中数据产生变化，就利用 rsync 服务推送到备份服务器上</li>
<li>利用脚本进行结合</li>
</ol>
<h4 id="inotify-内核参数"><a href="#inotify-内核参数" class="headerlink" title="inotify 内核参数"></a>inotify 内核参数</h4><ul>
<li>max_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错误，默认值:16384， 生产环境建议调大，比如:327679</li>
<li>max_user_instances：每个用户创建 inotify 实例最大值，默认值:128</li>
<li>max_user_watches：可以监视的文件的总数量(inotifywait 单进程)，默认值:8192，建议调大</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@data-centos8 ~]<span class="comment">#vim /etc/sysctl.conf</span></span><br><span class="line">fs.inotify.max_queued_events=66666</span><br><span class="line">fs.inotify.max_user_watches=100000</span><br><span class="line">[root@centos8 ~]<span class="comment">#sysctl</span></span><br><span class="line">-p</span><br><span class="line">fs.inotify.max_queued_events = 66666</span><br><span class="line">fs.inotify.max_user_watches = 100000</span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /proc/sys/fs/inotify/*</span></span><br><span class="line">66666</span><br><span class="line">128</span><br><span class="line">100000</span><br></pre></td></tr></table></figure>

<h4 id="inotify-tools"><a href="#inotify-tools" class="headerlink" title="inotify-tools"></a>inotify-tools</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@c71 ~]<span class="variable">$yum</span> -y install inotify-tools</span><br><span class="line"></span><br><span class="line">[root@c71 ~]<span class="variable">$rpm</span> -ql inotify-tools</span><br><span class="line"><span class="comment"># 在被监控的文件或目录上等待特定文件系统事件(open、close、delete等)发生，常用于实时同步的目录监控</span></span><br><span class="line">/usr/bin/inotifywait</span><br><span class="line"><span class="comment"># 收集被监控的文件系统使用的统计数据，指文件系统事件发生的次数统计</span></span><br><span class="line">/usr/bin/inotifywatch</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h5 id="inotifywait"><a href="#inotifywait" class="headerlink" title="inotifywait"></a>inotifywait</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用option</span></span><br><span class="line">-m, --monitor：			始终保持事件监听</span><br><span class="line">-d, --daemon：			以守护进程方式执行,和-m相似,配合-o使用</span><br><span class="line">-r, --recursive：		递归监控目录数据信息变化</span><br><span class="line">-q, --quiet：			输出少量事件信息</span><br><span class="line">--exclude &lt;pattern&gt;：	指定排除文件或目录,使用扩展的正则表达式匹配的模式实现</span><br><span class="line">--excludei &lt;pattern&gt;：	和exclude相似,不区分大小写</span><br><span class="line">-o, --outfile &lt;file&gt;：	打印事件到文件中,相当于标准正确输出,注意:使用绝对路径</span><br><span class="line">-s, --syslogOutput：		发送错误到syslog相当于标准错误输出</span><br><span class="line">--timefmt &lt;<span class="built_in">fmt</span>&gt;：		指定时间输出格式</span><br><span class="line">--format &lt;<span class="built_in">fmt</span>&gt;：			指定的输出格式;即实际监控输出内容</span><br><span class="line">-e：						指定监听指定的事件,如果省略,表示所有事件都进行监听</span><br><span class="line"></span><br><span class="line">--timefmt <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span></span><br><span class="line">%Y 	<span class="comment"># 年份信息,包含世纪信息</span></span><br><span class="line">%y 	<span class="comment"># 年份信息,不包括世纪信息</span></span><br><span class="line">%m 	<span class="comment"># 显示月份,范围 01-12</span></span><br><span class="line">%d 	<span class="comment"># 每月的第几天,范围是 01-31</span></span><br><span class="line">%H 	<span class="comment"># 小时信息,使用 24小时制,范围 00-23</span></span><br><span class="line">%M 	<span class="comment"># 分钟,范围 00-59</span></span><br><span class="line">%S 	<span class="comment"># 秒,范例 0-60</span></span><br><span class="line"></span><br><span class="line">--format <span class="string">&quot;%T %w%f event: %;e&quot;</span></span><br><span class="line">%T 	<span class="comment"># 输出时间格式中定义的时间格式信息,通过 --timefmt option 语法格式指定时间信息</span></span><br><span class="line">%w 	<span class="comment"># 事件出现时,监控文件或目录的名称信息,相当于dirname</span></span><br><span class="line">%f 	<span class="comment"># 事件出现时,将显示监控目录下触发事件的文件或目录信息,否则为空,相当于basename</span></span><br><span class="line">%e 	<span class="comment"># 显示发生的事件信息,不同的事件默认用逗号分隔</span></span><br><span class="line">%Xe <span class="comment"># 显示发生的事件信息,不同的事件指定用X进行分隔</span></span><br><span class="line"></span><br><span class="line">-e create,delete,moved_to,close_write,attrib</span><br><span class="line">create 			<span class="comment">#文件或目录创建</span></span><br><span class="line">delete 			<span class="comment">#文件或目录被删除</span></span><br><span class="line">modify 			<span class="comment">#文件或目录内容被写入</span></span><br><span class="line">attrib 			<span class="comment">#文件或目录属性改变</span></span><br><span class="line">close_write 	<span class="comment">#文件或目录关闭,在写入模式打开之后关闭的</span></span><br><span class="line">close_nowrite 	<span class="comment">#文件或目录关闭,在只读模式打开之后关闭的</span></span><br><span class="line">close 			<span class="comment">#文件或目录关闭,不管读或是写模式</span></span><br><span class="line">open 			<span class="comment">#文件或目录被打开</span></span><br><span class="line">lsdir 			<span class="comment">#浏览目录内容</span></span><br><span class="line">moved_to 		<span class="comment">#文件或目录被移动到监控的目录中</span></span><br><span class="line">moved_from 		<span class="comment">#文件或目录从监控的目录中被移动</span></span><br><span class="line">move 			<span class="comment">#文件或目录不管移动到或是移出监控目录都触发事件</span></span><br><span class="line">access 			<span class="comment">#文件或目录内容被读取</span></span><br><span class="line">delete_self 	<span class="comment">#文件或目录被删除,目录本身被删除</span></span><br><span class="line">unmount 		<span class="comment">#取消挂载</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控一次性事件</span></span><br><span class="line">inotifywait /data/www</span><br><span class="line"></span><br><span class="line"><span class="comment"># 持续前台监控</span></span><br><span class="line">inotifywait -mrq /data/www --exclude=<span class="string">&quot;.*\.swx|\.swp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 持续后台监控,并记录日志</span></span><br><span class="line">inotifywait -o /root/inotify.log -drq /data/www --timefmt <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span> --format <span class="string">&quot;%T %w%f event: %e&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#持续前台监控特定事件</span></span><br><span class="line">inotifywait -mrq /data/www --timefmt <span class="string">&quot;%F %H:%M:%S&quot;</span> --format <span class="string">&quot;%T %w%f event:%;e&quot;</span> -e create,delete,moved_to,close_write,attrib</span><br></pre></td></tr></table></figure>

<h5 id="inotifywatch"><a href="#inotifywatch" class="headerlink" title="inotifywatch"></a>inotifywatch</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inotifywatch [ options ] file1 [ file2 ] [ ... ]</span><br></pre></td></tr></table></figure>

<h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><p>rsync 常用做镜像备份和同步数据，配合计划任务实现定时备份，配合 inotify 可以实现触发式的实时数据同步</p>
<p>官方网站: <a target="_blank" rel="noopener" href="http://rsync.samba.org/">http://rsync.samba.org/</a></p>
<p>软件包：rsync、rsync-daemon(CentOS 8)</p>
<p>服务文件：&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;rsyncd.service</p>
<p>配置文件：&#x2F;etc&#x2F;rsyncd.conf</p>
<p>端口：873&#x2F;tcp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 源地址 和 目标地址 都在本机</span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... DEST</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 通过远程shell连接</span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST		<span class="comment"># pull 推</span></span><br><span class="line">rsync [OPTION]... [USER@]HOST:SRC [DEST]			<span class="comment"># push 拉</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 连接到rsync守护进程</span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST 					<span class="comment"># pull 推</span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST		<span class="comment"># pull 推</span></span><br><span class="line">rsync [OPTION]... [USER@]HOST::SRC [DEST]							<span class="comment"># push 拉</span></span><br><span class="line">rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]				<span class="comment"># push 拉</span></span><br><span class="line"></span><br><span class="line">The <span class="string">&#x27;:&#x27;</span> usages connect via remote shell, <span class="keyword">while</span> <span class="string">&#x27;::&#x27;</span> &amp; <span class="string">&#x27;rsync://&#x27;</span> usages connect to an rsync daemon, and require SRC or DEST to start with a module name.</span><br></pre></td></tr></table></figure>

<p>前两种的本质是通过本地或远程 shell，而第 3 种方式则是让远程主机上运行 rsyncd 服务，使其监听在一个端口上，等待客户端的连接</p>
<p><strong>范例：</strong>备份服务器启动 rsync 的守护进程，然后数据服务器去连接，再进行数据的推送和拉取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份服务器 10.0.0.71</span></span><br><span class="line">[root@c71 ~]<span class="variable">$systemctl</span> start rsyncd.service</span><br><span class="line">[root@c71 ~]<span class="variable">$ss</span> -ntl</span><br><span class="line">State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port</span><br><span class="line">LISTEN     0      5                       *:873                                 *:*</span><br><span class="line">LISTEN     0      5                    [::]:873                              [::]:*</span><br><span class="line"></span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/rsyncd.conf</span><br><span class="line">...</span><br><span class="line">[backup]				<span class="comment"># bachup 模块</span></span><br><span class="line">path = /data/backup		<span class="comment"># 备份路径</span></span><br><span class="line"><span class="built_in">read</span> only = no			<span class="comment"># 设置可写，默认只读</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看设置的模块</span></span><br><span class="line">[root@c71 ~]<span class="variable">$rsync</span> 127.0.0.1::</span><br><span class="line">backup</span><br><span class="line">[root@c71 ~]<span class="variable">$rsync</span> rsync://127.0.0.1</span><br><span class="line">backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认用户以nobody访问此目录，所以给nobody设置读写权限</span></span><br><span class="line">[root@c71 ~]<span class="variable">$setfacl</span> -m u:nobody:rwx /data/backup/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据服务器 10.0.0.1</span></span><br><span class="line">lujinkai@Z510:~$ rsync rsync://10.0.0.71</span><br><span class="line">backup</span><br><span class="line">lujinkai@Z510:~$ rsync 10.0.0.71::</span><br><span class="line">backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送，将本机的u_script目录备份到10.0.0.71的/data/backup目录（rsyncd.conf中backup模块设置）</span></span><br><span class="line">lujinkai@Z510:~/www$ rsync -av ./u_script/ root@10.0.0.71::backup</span><br><span class="line">lujinkai@Z510:~/www$ rsync 10.0.0.71::backup</span><br><span class="line">drwxrwxr-x          4,096 2020/11/14 22:38:48 .</span><br><span class="line">-rwxrwxr-x            319 2020/11/14 22:38:48 demo.sh</span><br><span class="line">drwxrwxr-x          4,096 2020/11/09 14:52:39 include</span><br><span class="line"><span class="comment"># 拉取</span></span><br><span class="line">lujinkai@Z510:~/www$ rsync -av root@10.0.0.71::backup ./u_script/</span><br></pre></td></tr></table></figure>

<p>rsyncd.conf 的格式 参考 <code>man rsyncd.conf</code> 或者 <a target="_blank" rel="noopener" href="https://linux.die.net/man/5/rsyncd.conf">https://linux.die.net/man/5/rsyncd.conf</a></p>
<p>上面的过程都是免密的，我们也可以设置认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份服务器 10.0.0.71</span></span><br><span class="line">[root@c71 ~]<span class="variable">$echo</span> <span class="string">&quot;rsyncuser:123456&quot;</span> &gt; /etc/rsync.pas</span><br><span class="line">[root@c71 ~]<span class="variable">$chmod</span> 600 /etc/rsync.pas</span><br><span class="line">[root@c71 ~]<span class="variable">$vim</span> /etc/rsyncd.conf</span><br><span class="line">...</span><br><span class="line">[backup]</span><br><span class="line">path = /data/backup</span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line">auth <span class="built_in">users</span> = rsyncuser	<span class="comment"># 默认anonymous可以访问rsync服务器，这里设置只能虚拟用户rsyncuser访问</span></span><br><span class="line">secrets file = /etc/rsync.pas	<span class="comment"># 认证文件</span></span><br><span class="line">...</span><br><span class="line">[root@c71 ~]<span class="variable">$systemctl</span> restart rsyncd.service	<span class="comment"># 也可以不重启</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据服务器 10.0.0.1</span></span><br><span class="line"><span class="comment"># 将秘密写入到/etc/rsync.pas，也可以赋值给环境变量 export RSYNC_PASSWORD=123456</span></span><br><span class="line">lujinkai@Z510:~/www$ <span class="built_in">echo</span> 123456 &gt; /etc/rsync.pas</span><br><span class="line"><span class="comment"># 测试,注意这里一定要指定用户名 rsyncuser</span></span><br><span class="line">lujinkai@Z510:~/www$ rsync rsyncuser@10.0.0.71::backup</span><br><span class="line">Password:</span><br><span class="line">drwxrwxr-x          4,096 2020/11/14 22:38:48 .</span><br><span class="line">-rwxrwxr-x            319 2020/11/14 22:38:48 demo.sh</span><br><span class="line">drwxrwxr-x          4,096 2020/11/09 14:52:39 include</span><br></pre></td></tr></table></figure>

<h3 id="inotify-rsync-shell-脚本-实现实时数据同步"><a href="#inotify-rsync-shell-脚本-实现实时数据同步" class="headerlink" title="inotify+rsync+shell 脚本 实现实时数据同步"></a>inotify+rsync+shell 脚本 实现实时数据同步</h3><p>备份数据库是：10.0.0.71，inotifywait 监控文件变化，rsync 负责同步数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SRC=<span class="string">&#x27;/data/www/&#x27;</span> <span class="comment">#注意最后的/</span></span><br><span class="line">DEST=<span class="string">&#x27;rsyncuser@10.0.0.71::backup&#x27;</span></span><br><span class="line">rpm -q rsync &amp;&gt;/dev/null || yum install rsync</span><br><span class="line">inotifywait \</span><br><span class="line">    -mrq \</span><br><span class="line">    --exclude=<span class="string">&quot;.*\.swp&quot;</span> \</span><br><span class="line">    --timefmt <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span> \</span><br><span class="line">    --format <span class="string">&#x27;%T %w %f&#x27;</span> \</span><br><span class="line">    -e create,delete,moved_to,close_write,attrib <span class="variable">$&#123;SRC&#125;</span> |</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> DATE TIME DIR FILE; <span class="keyword">do</span></span><br><span class="line">        FILEPATH=<span class="variable">$&#123;DIR&#125;</span><span class="variable">$&#123;FILE&#125;</span></span><br><span class="line">        rsync \</span><br><span class="line">            -az \</span><br><span class="line">            --delete \</span><br><span class="line">            -password-file=/etc/rsync.pas <span class="variable">$SRC</span> <span class="variable">$DEST</span> &amp;&amp;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;At <span class="variable">$&#123;TIME&#125;</span> on <span class="variable">$&#123;DATE&#125;</span>, file <span class="variable">$FILEPATH</span> was backuped up via rsync&quot;</span> &gt;&gt;/var/log/changelist.log</span><br><span class="line">    <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="sersync-实现实时数据同步"><a href="#sersync-实现实时数据同步" class="headerlink" title="sersync 实现实时数据同步"></a>sersync 实现实时数据同步</h3><p>sersync 虽然快 10 年没更新了，但是还是比较好用的</p>
<p>sersync 项目地址: <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/">https://code.google.com/archive/p/sersync/</a><br>sersync 下载地址: <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/downloads">https://code.google.com/archive/p/sersync/downloads</a></p>
<p>sersync 类似于 inotify，同样用于监控，但它克服了 inotify 的缺点</p>
<p>inotify 最大的不足是会产生重复事件,或者同一个目录下多个文件的操作会产生多个事件,例如,当监控目录中有 5 个文件时,删除目录时会产生 6 个监控事件,从而导致重复调用 rsync 命令。另外比如:vim 文件时,inotify 会监控到临时文件的事件,但这些事件相对于 rsync 来说是不应该被监控的</p>
<p>sersync 优点：</p>
<ul>
<li>c++编写，速度快</li>
<li>对 linux 系统文件系统产生的临时文件和重复的文件操作进行过滤，所以在结合 rsync 同步的时候，节省了运行时耗和网络资源</li>
<li>配置很简单，其中提供了静态编译好的二进制文件和 xml 配置文件，直接使用即可</li>
<li>使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态</li>
<li>有出错处理机制,通过失败队列对出错的文件重新同步,如果仍旧失败,则按设定时长对同步失败的文件重新同步</li>
<li>不仅可以实现实时同步，另外还自带 crontab 功能，只需在 xml 配置文件中开启，即也可以按要求隔一段时间整体同步一次，而无需再额外配置 crontab 功能</li>
<li>可以二次开发</li>
</ul>
<p>sersync 只有两个文件：</p>
<ul>
<li><p>二进制程序文件 sersync2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lujinkai@Z510:/usr/local/sersync$ ./sersync2 -h</span><br><span class="line"><span class="built_in">set</span> the system param</span><br><span class="line">execute：<span class="built_in">echo</span> 50000000 &gt; /proc/sys/fs/inotify/max_user_watches</span><br><span class="line">sh: 1: cannot create /proc/sys/fs/inotify/max_user_watches: Permission denied</span><br><span class="line">execute：<span class="built_in">echo</span> 327679 &gt; /proc/sys/fs/inotify/max_queued_events</span><br><span class="line">sh: 1: cannot create /proc/sys/fs/inotify/max_queued_events: Permission denied</span><br><span class="line">parse the <span class="built_in">command</span> param</span><br><span class="line">_______________________________________________________</span><br><span class="line">参数-d:启用守护进程模式</span><br><span class="line">参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍</span><br><span class="line">c参数-n: 指定开启守护线程的数量，默认为10个</span><br><span class="line">参数-o:指定配置文件，默认使用confxml.xml文件</span><br><span class="line">参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块</span><br><span class="line">参数-m:单独启用其他模块，使用 -m socket 开启socket模块</span><br><span class="line">参数-m:单独启用其他模块，使用 -m http 开启http模块</span><br><span class="line">不加-m参数，则默认执行同步程序</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件 confxml.xml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">lujinkai@Z510:/usr/local/sersync$ vim confxml.xml</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;ISO-8859-1&quot;</span>?&gt;</span><br><span class="line">&lt;<span class="built_in">head</span> version=<span class="string">&quot;2.5&quot;</span>&gt;</span><br><span class="line">    &lt;host hostip=<span class="string">&quot;localhost&quot;</span> port=<span class="string">&quot;8008&quot;</span>&gt;&lt;/host&gt;</span><br><span class="line">    &lt;debug start=<span class="string">&quot;false&quot;</span>/&gt;		<span class="comment"># 是否开启调试模式</span></span><br><span class="line">    &lt;fileSystem xfs=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line">    &lt;filter start=<span class="string">&quot;false&quot;</span>&gt;	<span class="comment"># 是否开启文件过滤功能</span></span><br><span class="line">		&lt;exclude expression=<span class="string">&quot;(.*)\.svn&quot;</span>&gt;&lt;/exclude&gt;</span><br><span class="line">		&lt;exclude expression=<span class="string">&quot;(.*)\.gz&quot;</span>&gt;&lt;/exclude&gt;</span><br><span class="line">		&lt;exclude expression=<span class="string">&quot;^info/*&quot;</span>&gt;&lt;/exclude&gt;</span><br><span class="line">		&lt;exclude expression=<span class="string">&quot;^static/*&quot;</span>&gt;&lt;/exclude&gt;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line">    &lt;inotify&gt;	<span class="comment"># 监控的事件</span></span><br><span class="line">		&lt;delete start=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">		&lt;createFolder start=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">		&lt;createFile start=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line">		&lt;closeWrite start=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">		&lt;moveFrom start=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">		&lt;moveTo start=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">		&lt;attrib start=<span class="string">&quot;false&quot;</span>/&gt;		<span class="comment"># 修改此行为true，文件属性变化后也会同步</span></span><br><span class="line">		&lt;modify start=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line">    &lt;/inotify&gt;</span><br><span class="line"></span><br><span class="line">    &lt;sersync&gt;	<span class="comment"># rsync命令的配置段</span></span><br><span class="line">	&lt;localpath watch=<span class="string">&quot;/opt/tongbu&quot;</span>&gt;		<span class="comment"># 同步的目录</span></span><br><span class="line">		<span class="comment"># name是远程rsyncd的模块名，如果下面ssh标签开启了start，name则为远程sehll方式运行的目标目录</span></span><br><span class="line">	    &lt;remote ip=<span class="string">&quot;127.0.0.1&quot;</span> name=<span class="string">&quot;tongbu1&quot;</span>/&gt;</span><br><span class="line">	    &lt;!--&lt;remote ip=<span class="string">&quot;192.168.8.39&quot;</span> name=<span class="string">&quot;tongbu&quot;</span>/&gt;--&gt;</span><br><span class="line">	    &lt;!--&lt;remote ip=<span class="string">&quot;192.168.8.40&quot;</span> name=<span class="string">&quot;tongbu&quot;</span>/&gt;--&gt;</span><br><span class="line">	&lt;/localpath&gt;</span><br><span class="line">	&lt;rsync&gt;</span><br><span class="line">	    &lt;commonParams params=<span class="string">&quot;-artuz&quot;</span>/&gt;		<span class="comment"># 指定rsync选项</span></span><br><span class="line">	    &lt;auth start=<span class="string">&quot;false&quot;</span> <span class="built_in">users</span>=<span class="string">&quot;root&quot;</span> passwordfile=<span class="string">&quot;/etc/rsync.pas&quot;</span>/&gt;</span><br><span class="line">	    &lt;userDefinedPort start=<span class="string">&quot;false&quot;</span> port=<span class="string">&quot;874&quot;</span>/&gt;&lt;!-- port=874 --&gt;</span><br><span class="line">	    &lt;<span class="built_in">timeout</span> start=<span class="string">&quot;false&quot;</span> time=<span class="string">&quot;100&quot;</span>/&gt;&lt;!-- <span class="built_in">timeout</span>=100 --&gt;</span><br><span class="line">	    &lt;ssh start=<span class="string">&quot;false&quot;</span>/&gt;	<span class="comment"># 默认使用rsync daemon运行rsync命令,true为使用远程shell模式</span></span><br><span class="line">	&lt;/rsync&gt;</span><br><span class="line">	<span class="comment"># 错误重传及日志文件路径，默认60分钟</span></span><br><span class="line">	&lt;failLog path=<span class="string">&quot;/tmp/rsync_fail_log.sh&quot;</span> timeToExecute=<span class="string">&quot;60&quot;</span>/&gt;</span><br><span class="line">	&lt;crontab start=<span class="string">&quot;false&quot;</span> schedule=<span class="string">&quot;600&quot;</span>&gt;	<span class="comment"># 定时，默认600分钟</span></span><br><span class="line">	    &lt;crontabfilter start=<span class="string">&quot;false&quot;</span>&gt;	<span class="comment"># 是否开启定时</span></span><br><span class="line">		&lt;exclude expression=<span class="string">&quot;*.php&quot;</span>&gt;&lt;/exclude&gt;</span><br><span class="line">		&lt;exclude expression=<span class="string">&quot;info/*&quot;</span>&gt;&lt;/exclude&gt;</span><br><span class="line">	    &lt;/crontabfilter&gt;</span><br><span class="line">	&lt;/crontab&gt;</span><br><span class="line">	&lt;plugin start=<span class="string">&quot;false&quot;</span> name=<span class="string">&quot;command&quot;</span>/&gt;</span><br><span class="line">    &lt;/sersync&gt;</span><br><span class="line"><span class="comment">#####################################以下行不需要修改####################################</span></span><br><span class="line">    &lt;plugin name=<span class="string">&quot;command&quot;</span>&gt;</span><br><span class="line">	&lt;param prefix=<span class="string">&quot;/bin/sh&quot;</span> suffix=<span class="string">&quot;&quot;</span> ignoreError=<span class="string">&quot;true&quot;</span>/&gt;	&lt;!--prefix /opt/tongbu/mmm.sh suffix--&gt;</span><br><span class="line">	&lt;filter start=<span class="string">&quot;false&quot;</span>&gt;</span><br><span class="line">	    &lt;include expression=<span class="string">&quot;(.*)\.php&quot;</span>/&gt;</span><br><span class="line">	    &lt;include expression=<span class="string">&quot;(.*)\.sh&quot;</span>/&gt;</span><br><span class="line">	&lt;/filter&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;plugin name=<span class="string">&quot;socket&quot;</span>&gt;</span><br><span class="line">	&lt;localpath watch=<span class="string">&quot;/opt/tongbu&quot;</span>&gt;</span><br><span class="line">	    &lt;deshost ip=<span class="string">&quot;192.168.138.20&quot;</span> port=<span class="string">&quot;8009&quot;</span>/&gt;</span><br><span class="line">	&lt;/localpath&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">    &lt;plugin name=<span class="string">&quot;refreshCDN&quot;</span>&gt;</span><br><span class="line">	&lt;localpath watch=<span class="string">&quot;/data0/htdocs/cms.xoyo.com/site/&quot;</span>&gt;</span><br><span class="line">	    &lt;cdninfo domainname=<span class="string">&quot;ccms.chinacache.com&quot;</span> port=<span class="string">&quot;80&quot;</span> username=<span class="string">&quot;xxxx&quot;</span> passwd=<span class="string">&quot;xxxx&quot;</span>/&gt;</span><br><span class="line">	    &lt;sendurl base=<span class="string">&quot;http://pic.xoyo.com/cms&quot;</span>/&gt;</span><br><span class="line">	    &lt;regexurl regex=<span class="string">&quot;false&quot;</span> match=<span class="string">&quot;cms.xoyo.com/site([/a-zA-Z0-9]*).xoyo.com/images&quot;</span>/&gt;</span><br><span class="line">	&lt;/localpath&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/head&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="基于-rsync-daemon-实现-sersync"><a href="#基于-rsync-daemon-实现-sersync" class="headerlink" title="基于 rsync daemon 实现 sersync"></a>基于 rsync daemon 实现 sersync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">lujinkai@Z510:~/www/script/src$ wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz</span><br><span class="line"><span class="comment"># 解压，可以看到，sersync只有两个文件：二进制程序文件和xml配置文件</span></span><br><span class="line">lujinkai@Z510:~/www/script/src$ tar zxvf sersync2.5.4_64bit_binary_stable_final.tar.gz</span><br><span class="line">lujinkai@Z510:~/www/script/src$ sudo <span class="built_in">mv</span> GNU-Linux-x86/ /usr/local/sersync</span><br><span class="line"><span class="comment"># 添加到环境变量PATH，过程略...</span></span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line">lujinkai@Z510:~/www/script/src$ <span class="built_in">cd</span> /usr/local/sersync/</span><br><span class="line">lujinkai@Z510:/usr/local/sersync$ vim confxml.xml	<span class="comment"># 过程略...</span></span><br><span class="line"><span class="comment"># 确认安装rsync客户端工具</span></span><br><span class="line">lujinkai@Z510:/usr/local/sersync$ apt -y install rsync</span><br><span class="line"><span class="comment"># 创建连接rsynd服务器的用户密码文件,并必须修改权限</span></span><br><span class="line">lujinkai@Z510:~$ <span class="built_in">echo</span> 123456 &gt; /etc/rsync.pas</span><br><span class="line">lujinkai@Z510:~$ <span class="built_in">chmod</span> 600 /etc/rsync.pas</span><br><span class="line"><span class="comment"># 以后台方式执行同步</span></span><br><span class="line">lujinkai@Z510:~$ sersync2 -dro /usr/local/sersync/confxml.xml</span><br><span class="line"><span class="comment"># 如果同步失败,可以手动执行下面命令,观察过程</span></span><br><span class="line">lujinkai@Z510:~$ <span class="built_in">cd</span> /data/www &amp;&amp; rsync -artuz -R --delete ./rsyncuser@10.0.0.71::backup --password-file=/etc/rsync.pas &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># sersync支持多实例，监控多个目录时，只需分别配置不同配置文件，然后使用sersync2指定对应配置文件运行</span></span><br><span class="line">lujinkai@Z510:~$ sersync2 -rd -o /etc/sersync.d/nginx.xml</span><br></pre></td></tr></table></figure>

<h4 id="基于远程-shell-实现-sersync"><a href="#基于远程-shell-实现-sersync" class="headerlink" title="基于远程 shell 实现 sersync"></a>基于远程 shell 实现 sersync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先配置ssh基于key的自动验证，过程略...</span></span><br><span class="line"><span class="comment"># 修改配置文件 confxml.xml</span></span><br><span class="line">&lt;localpath watch=<span class="string">&quot;/data/www&quot;</span>&gt;</span><br><span class="line">&lt;remote ip=<span class="string">&quot;备份服务器IP&quot;</span> name=<span class="string">&quot;/data/backup&quot;</span>/&gt; <span class="comment">#修改此行指定备份服务器地址和备份目标目录</span></span><br><span class="line">&lt;/localpath&gt;</span><br><span class="line">...</span><br><span class="line">&lt;ssh start=<span class="string">&quot;true&quot;</span>/&gt;		<span class="comment"># 开启ssh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不需要配置/etc/rsync.pas，其他步骤和上面一样</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="//img.lujinkai.cn/blog/ljk/1607160536339.png" alt="像方便面一样的男子 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="//img.lujinkai.cn/blog/ljk/1607160019009.png" alt="像方便面一样的男子 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/" rel="tag"><i class="fa fa-tag"></i> 文件共享</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/%E6%97%A5%E5%BF%97/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/" rel="prev" title="日志服务管理">
                  <i class="fa fa-chevron-left"></i> 日志服务管理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB/pureftpd/" rel="next" title="pureftpd">
                  pureftpd <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.lujinkai.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.lujinkai.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.lujinkai.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.lujinkai.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
