<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.lujinkai.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.lujinkai.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="OpenVPN 简介VPN专用网：需要向电信运行商申请租用专线，在这条专用的线路上只传输自己的信息，安全稳定，但费用高昂。 VPN：Virtual Private Network，虚拟私有网络，又称为虚拟专用网络，用于在不安全的线路上安全的传输数据。 OpenVPNOpenVPN：一个实现 VPN 的开源软件，OpenVPN 是一个健壮的、高度灵活的 VPN 守护进程。它支持 SSL&#x2F;T">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenVPN">
<meta property="og:url" content="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/OpenVPN/OpenVPN/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:description" content="OpenVPN 简介VPN专用网：需要向电信运行商申请租用专线，在这条专用的线路上只传输自己的信息，安全稳定，但费用高昂。 VPN：Virtual Private Network，虚拟私有网络，又称为虚拟专用网络，用于在不安全的线路上安全的传输数据。 OpenVPNOpenVPN：一个实现 VPN 的开源软件，OpenVPN 是一个健壮的、高度灵活的 VPN 守护进程。它支持 SSL&#x2F;T">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1601385275341.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1602126060938.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1602126241434.png">
<meta property="article:published_time" content="2020-12-09T15:19:16.000Z">
<meta property="article:modified_time" content="2023-05-29T08:58:05.502Z">
<meta property="article:author" content="像方便面一样的男子">
<meta property="article:tag" content="OpenVPN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.to2b.cn/blog/ljk/1601385275341.png">


<link rel="canonical" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/OpenVPN/OpenVPN/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/OpenVPN/OpenVPN/","path":"运维/OpenVPN/OpenVPN/","title":"OpenVPN"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>OpenVPN | LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LJKのBlog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenVPN-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">OpenVPN 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VPN"><span class="nav-number">1.1.</span> <span class="nav-text">VPN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenVPN"><span class="nav-number">1.2.</span> <span class="nav-text">OpenVPN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.2.</span> <span class="nav-text">通信过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VPN-%E5%92%8C-SSH"><span class="nav-number">1.2.3.</span> <span class="nav-text">VPN 和 SSH</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenVPN-%E9%83%A8%E7%BD%B2"><span class="nav-number">2.</span> <span class="nav-text">OpenVPN 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87-OpenVPN-%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83"><span class="nav-number">2.1.</span> <span class="nav-text">准备 OpenVPN 部署环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-OpenVPN-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">2.1.1.</span> <span class="nav-text">配置 OpenVPN 服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.1.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.3.</span> <span class="nav-text">准备证书相关文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%9F%A5%E7%9C%8B%E5%88%9D%E5%A7%8B%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">1. 查看初始文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96-PKI%EF%BC%8C%E7%94%9F%E6%88%90-PKI-%E7%9B%B8%E5%85%B3%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">2. 初始化 PKI，生成 PKI 相关目录和文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E5%88%9B%E5%BB%BA%E7%A7%81%E6%9C%89-CA-%E6%9C%BA%E6%9E%84"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">3. 创建私有 CA 机构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="nav-number">2.1.3.4.</span> <span class="nav-text">4. 创建服务端证书申请</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-%E9%A2%81%E5%8F%91%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%81%E4%B9%A6"><span class="nav-number">2.1.3.5.</span> <span class="nav-text">5. 颁发服务端证书</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-%E5%88%9B%E5%BB%BA-Diffie-Hellman-%E5%AF%86%E9%92%A5"><span class="nav-number">2.1.3.6.</span> <span class="nav-text">6. 创建 Diffie-Hellman 密钥</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-%E5%87%86%E5%A4%87%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6%E7%8E%AF%E5%A2%83"><span class="nav-number">2.1.3.7.</span> <span class="nav-text">7. 准备客户端证书环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-%E5%88%9B%E5%BB%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="nav-number">2.1.3.8.</span> <span class="nav-text">8. 创建客户端证书申请</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-%E7%AD%BE%E5%8F%91%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6"><span class="nav-number">2.1.3.9.</span> <span class="nav-text">9. 签发客户端证书</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-%E5%B0%86-ca-%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%BA%94%E7%9A%84%E7%9B%AE%E5%BD%95"><span class="nav-number">2.1.3.10.</span> <span class="nav-text">10. 将 ca 和服务器相关文件复制到服务器相应的目录</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#11-%E5%B0%86-ca-%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3%E7%9A%84%E7%9B%AE%E5%BD%95"><span class="nav-number">2.1.3.11.</span> <span class="nav-text">11. 将 ca 和客户端相关文件复制到服务器相关的目录</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87-OpenVPN-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.4.</span> <span class="nav-text">准备 OpenVPN 服务端配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="nav-number">2.1.4.1.</span> <span class="nav-text">配置文件说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.4.2.</span> <span class="nav-text">修改服务端配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E6%97%A5%E5%BF%97%E7%9B%B8%E5%85%B3"><span class="nav-number">2.1.4.3.</span> <span class="nav-text">准备日志相关</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="nav-number">2.1.5.</span> <span class="nav-text">配置防火墙和内核参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-OpenVPN"><span class="nav-number">2.1.6.</span> <span class="nav-text">启动 OpenVPN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87-OpenVPN-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.7.</span> <span class="nav-text">准备 OpenVPN 客户端配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E-1"><span class="nav-number">2.1.7.1.</span> <span class="nav-text">配置文件说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.7.2.</span> <span class="nav-text">修改客户端配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Windows-%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2-OpenVPN-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">2.1.8.</span> <span class="nav-text">Windows 配置部署 OpenVPN 客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mac-OS-%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2-OpenVPN-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">2.1.9.</span> <span class="nav-text">Mac OS 配置部署 OpenVPN 客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%94%99"><span class="nav-number">3.</span> <span class="nav-text">故障排错</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenVPN-%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">4.</span> <span class="nav-text">OpenVPN 高级功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86"><span class="nav-number">5.</span> <span class="nav-text">扩展知识</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.lujinkai.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/OpenVPN/OpenVPN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.lujinkai.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="OpenVPN | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          OpenVPN
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:19:16" itemprop="dateCreated datePublished" datetime="2020-12-09T23:19:16+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/OpenVPN/" itemprop="url" rel="index"><span itemprop="name">OpenVPN</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="OpenVPN-简介"><a href="#OpenVPN-简介" class="headerlink" title="OpenVPN 简介"></a>OpenVPN 简介</h2><h3 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a>VPN</h3><p>专用网：需要向电信运行商申请租用专线，在这条专用的线路上只传输自己的信息，安全稳定，但费用高昂。</p>
<p>VPN：Virtual Private Network，虚拟私有网络，又称为虚拟专用网络，用于在不安全的线路上安全的传输数据。</p>
<h3 id="OpenVPN"><a href="#OpenVPN" class="headerlink" title="OpenVPN"></a>OpenVPN</h3><p>OpenVPN：一个实现 VPN 的开源软件，OpenVPN 是一个健壮的、高度灵活的 VPN 守护进程。它支持 SSL&#x2F;TLS 安全、Ethernet bridging、经由代理的 TCP 或 UDP 隧道和 NAT。另外，它也支持动态 IP 地址以及 DHCP，可伸缩性足以支持数百或数千用户的使用场景，同时可移植至大多数主流操作系统平台上。<br>官网：<a target="_blank" rel="noopener" href="https://openvpn.net/">https://openvpn.net</a><br>GitHub 地址：<a target="_blank" rel="noopener" href="https://github.com/OpenVPN/openvpn">https://github.com/OpenVPN/openvpn</a></p>
<p><img data-src="//img.to2b.cn/blog/ljk/1601385275341.png"></p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/OpenVPN">https://baike.baidu.com/item/OpenVPN</a><br><a target="_blank" rel="noopener" href="https://www.bbsmax.com/A/MAzAkpvq59/">https://www.bbsmax.com/A/MAzAkpvq59/</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28727570">https://zhuanlan.zhihu.com/p/28727570</a></p>
<p>客户端和服务端都需要安装 OpenVPN，OpenVPN 的技术核心是虚拟网卡和 SSL 协议，我们知道，物理网卡工作在数据链路层，而虚拟网卡即可以工作在数据链路层，也可以工作在网络层，这取决于设置 tun 模式还是 tap 模式，客户端和服务端的虚拟网卡配置的 IP 处于同一个网段（10.8.0.0&#x2F;24），客户端和服务端通过虚拟网卡通信，这样虽然中间隔着互联网，但就好像在一个局域网中一样</p>
<h4 id="通信过程"><a href="#通信过程" class="headerlink" title="通信过程"></a>通信过程</h4><ol>
<li>服务器 OpenVPN 配置一个静态的虚拟 IP（10.8.0.1）和一个虚拟 IP 池（10.8.0.2 - 1.0.8.254），为每一个成功建立 SSL 连接的客户端 OpenVPN 分配一个虚拟 IP 池中的 IP，然后将局域网网段、路由设置等信息推送给客户端 OpenVPN，这样，客户端就成功加入了虚拟的局域网</li>
<li>在 OpenVpn 中，如果用户访问一个远程的虚拟地址（属于虚拟网卡配用的地址系列，区别于真实地址），则操作系统会通过路由机制将数据包（TUN 模式）或数据帧（TAP 模式）发送到虚拟网卡上，服务程序接收该数据并进行相应的处理后，通过 SOCKET 从外网上发送出去，远程服务程序通过 SOCKET 从外网上接收数据，并进行相应的处理后，发送给虚拟网卡，则应用软件可以接收到，完成了一个单向传输的过程，反之亦然。</li>
<li>通信过程加密，支持 TCP 和 UDP</li>
</ol>
<h4 id="VPN-和-SSH"><a href="#VPN-和-SSH" class="headerlink" title="VPN 和 SSH"></a><a target="_blank" rel="noopener" href="http://www.howtoip.com/vpn-vs-ssh-tunnel-which-is-more-secure/">VPN 和 SSH</a></h4><p>我们知道，SSH 具有隧道转发的功能，它和 VPN 一样，都可以加密网络流量，实现安全通信，但是两者还是有很大的不同：….</p>
<h2 id="OpenVPN-部署"><a href="#OpenVPN-部署" class="headerlink" title="OpenVPN 部署"></a>OpenVPN 部署</h2><p>10.0.0.2 56hpnM</p>
<h3 id="准备-OpenVPN-部署环境"><a href="#准备-OpenVPN-部署环境" class="headerlink" title="准备 OpenVPN 部署环境"></a>准备 OpenVPN 部署环境</h3><p>需要四台主机，一台客户端，一台 OpenVPN 服务器，两台内网服务器。</p>
<p>三台服务从阿里云购买，OpenVPN 服务器需要配置公网 IP，两台内网服务器不需要配置公网 IP。</p>
<h4 id="配置-OpenVPN-服务器"><a href="#配置-OpenVPN-服务器" class="headerlink" title="配置 OpenVPN 服务器"></a>配置 OpenVPN 服务器</h4><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ol>
<li>编译安装的 openvpn 总是无法启动，每次都启动超时，不知道为什么，所以还是通过 yum 来安装吧</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># OpenVPN</span>
<span class="token punctuation">[</span>root@4710419222 /<span class="token punctuation">]</span><span class="token variable">$yum</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> openvpn
<span class="token comment"># 证书管理工具</span>
<span class="token punctuation">[</span>root@4710419222 /<span class="token punctuation">]</span><span class="token variable">$cd</span> /usr/local/src
<span class="token punctuation">[</span>root@4710419222 src<span class="token punctuation">]</span><span class="token variable">$wget</span> https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.8/EasyRSA-3.0.8.tgz
<span class="token punctuation">[</span>root@4710419222 src<span class="token punctuation">]</span><span class="token variable">$tar</span> zxvf EasyRSA-3.0.8.tgz</code></pre>

<p>easy-rsa：证书管理工具，负责建立私有 CA、颁发管理证书等工作，通过调用 openssl 来实现功能，所以 easy-rsa 能实现的功能，openssl 都能实现，只是更麻烦一些</p>
<ol start="2">
<li>准备相关配置文件</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置文件</span>
<span class="token function">cp</span> /usr/share/doc/openvpn-2.4.9/sample/sample-config-files/server.conf /etc/openvpn
<span class="token comment"># 证书签发相关文件</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/openvpn/easy-rsa-<span class="token punctuation">&#123;</span>server,client<span class="token punctuation">&#125;</span>
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /usr/local/src/EasyRSA-3.0.8/<span class="token punctuation">&#123;</span>easyrsa,vars.example,x509-types,openssl-easyrsa.cnf<span class="token punctuation">&#125;</span> /etc/openvpn/easy-rsa-server/
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /usr/local/src/EasyRSA-3.0.8/<span class="token punctuation">&#123;</span>easyrsa,vars.example,x509-types,openssl-easyrsa.cnf<span class="token punctuation">&#125;</span> /etc/openvpn/easy-rsa-client/
<span class="token function">mv</span> /etc/openvpn/easy-rsa-server/vars.example /etc/openvpn/easy-rsa-server/vars
<span class="token function">mv</span> /etc/openvpn/easy-rsa-client/vars.example /etc/openvpn/easy-rsa-client/vars
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── client
├── easy-rsa-client
│   ├── easyrsa
│   ├── openssl-easyrsa.cnf
│   ├── vars
│   └── x509-types
│       ├── ca
│       ├── client
│       ├── code-signing
│       ├── COMMON
│       ├── email
│       ├── kdc
│       ├── server
│       └── serverClient
├── easy-rsa-server
│   ├── easyrsa
│   ├── openssl-easyrsa.cnf
│   ├── vars
│   └── x509-types
│       ├── ca
│       ├── client
│       ├── code-signing
│       ├── COMMON
│       ├── email
│       ├── kdc
│       ├── server
│       └── serverClient
├── server
└── server.conf

<span class="token number">7</span> directories, <span class="token number">23</span> files</code></pre>

<h4 id="准备证书相关文件"><a href="#准备证书相关文件" class="headerlink" title="准备证书相关文件"></a>准备证书相关文件</h4><h5 id="1-查看初始文件"><a href="#1-查看初始文件" class="headerlink" title="1. 查看初始文件"></a>1. 查看初始文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cd</span> easy-rsa-server/
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">100</span>
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">76946</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 easyrsa
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4616</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 openssl-easyrsa.cnf
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">8925</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 vars
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 x509-types
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa <span class="token parameter variable">--version</span>
EasyRSA Version Information
Version:     <span class="token number">3.0</span>.8
Generated:   Wed Sep  <span class="token number">9</span> <span class="token number">15</span>:59:45 CDT <span class="token number">2020</span>
SSL Lib:     OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Git Commit:  f12e00e53b4f486ce3d119ca429198780fa694ac
Source Repo: https://github.com/OpenVPN/easy-rsa
</code></pre>

<h5 id="2-初始化-PKI，生成-PKI-相关目录和文件"><a href="#2-初始化-PKI，生成-PKI-相关目录和文件" class="headerlink" title="2. 初始化 PKI，生成 PKI 相关目录和文件"></a>2. 初始化 PKI，生成 PKI 相关目录和文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa init-pki

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars

init-pki complete<span class="token punctuation">;</span> you may now create a CA or requests.
Your newly created PKI <span class="token function">dir</span> is: /etc/openvpn/easy-rsa-server/pki


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── easyrsa
├── openssl-easyrsa.cnf
├── pki		<span class="token comment"># 生成一个新目录及相关文件</span>
│   ├── openssl-easyrsa.cnf
│   ├── private
│   ├── reqs
│   └── safessl-easyrsa.cnf
├── vars
└── x509-types
    ├── ca
    ├── client
    ├── code-signing
    ├── COMMON
    ├── email
    ├── kdc
    ├── server
    └── serverClient

<span class="token number">4</span> directories, <span class="token number">13</span> files
</code></pre>

<h5 id="3-创建私有-CA-机构"><a href="#3-创建私有-CA-机构" class="headerlink" title="3. 创建私有 CA 机构"></a>3. 创建私有 CA 机构</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa build-ca nopass

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating RSA private key, <span class="token number">2048</span> bit long modulus
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Common Name <span class="token punctuation">(</span>eg: your user, host, or server name<span class="token punctuation">)</span> <span class="token punctuation">[</span>Easy-RSA CA<span class="token punctuation">]</span>:	<span class="token comment"># 接受默认值,直接回车</span>

CA creation complete and you may now <span class="token function">import</span> and sign cert requests.
Your new CA certificate <span class="token function">file</span> <span class="token keyword">for</span> publishing is at:
/etc/openvpn/easy-rsa-server/pki/ca.crt		<span class="token comment"># 生成自签名的证书文件</span>



<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── easyrsa
├── openssl-easyrsa.cnf
├── pki
│   ├── ca.crt				<span class="token comment"># 生成自签名的证书文件</span>
│   ├── certs_by_serial
│   ├── index.txt			<span class="token comment"># 数据库文件</span>
│   ├── index.txt.attr
│   ├── issued
│   ├── openssl-easyrsa.cnf
│   ├── private
│   │   └── ca.key			<span class="token comment"># 生成私钥文件</span>
│   ├── renewed
│   │   ├── certs_by_serial
│   │   ├── private_by_serial
│   │   └── reqs_by_serial
│   ├── reqs
│   ├── revoked
│   │   ├── certs_by_serial
│   │   ├── private_by_serial
│   │   └── reqs_by_serial
│   ├── safessl-easyrsa.cnf
│   └── serial				<span class="token comment"># CA serial number file</span>
├── vars
└── x509-types
    ├── ca
    ├── client
    ├── code-signing
    ├── COMMON
    ├── email
    ├── kdc
    ├── server
    └── serverClient

<span class="token number">14</span> directories, <span class="token number">18</span> files</code></pre>

<h5 id="4-创建服务端证书申请"><a href="#4-创建服务端证书申请" class="headerlink" title="4. 创建服务端证书申请"></a>4. 创建服务端证书申请</h5><p>首先生成私钥，然后使用私钥生成证书申请文件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa gen-req server nopass

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating a <span class="token number">2048</span> bit RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
writing new private key to <span class="token string">'/etc/openvpn/easy-rsa-server/pki/easy-rsa-2906.nnaLFU/tmp.yVgZX9'</span>
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Common Name <span class="token punctuation">(</span>eg: your user, host, or server name<span class="token punctuation">)</span> <span class="token punctuation">[</span>server<span class="token punctuation">]</span>: <span class="token comment"># 默认值,直接回车</span>

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-server/pki/reqs/server.req		<span class="token comment"># 生成请求文件</span>
key: /etc/openvpn/easy-rsa-server/pki/private/server.key	<span class="token comment"># 生成私钥文件</span>



<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki
pki
├── ca.crt
├── certs_by_serial
├── index.txt
├── index.txt.attr
├── issued
├── openssl-easyrsa.cnf
├── private
│   ├── ca.key
│   └── server.key			<span class="token comment"># 生成私钥文件</span>
├── renewed
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── reqs
│   └── server.req			<span class="token comment"># 生成请求文件</span>
├── revoked
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── safessl-easyrsa.cnf
└── serial

<span class="token number">12</span> directories, <span class="token number">9</span> files</code></pre>

<h5 id="5-颁发服务端证书"><a href="#5-颁发服务端证书" class="headerlink" title="5. 颁发服务端证书"></a>5. 颁发服务端证书</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看命令用法，</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa <span class="token builtin class-name">help</span> sign

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars

  sign-req <span class="token operator">&lt;</span>type<span class="token operator">></span> <span class="token operator">&lt;</span>filename_base<span class="token operator">></span>
      Sign a certificate request of the defined type. <span class="token operator">&lt;</span>type<span class="token operator">></span> must be a known
      <span class="token builtin class-name">type</span> such as <span class="token string">'client'</span>, <span class="token string">'server'</span>, <span class="token string">'serverClient'</span>, or <span class="token string">'ca'</span> <span class="token punctuation">(</span>or a user-added type.<span class="token punctuation">)</span>

      This request <span class="token function">file</span> must exist <span class="token keyword">in</span> the reqs/ <span class="token function">dir</span> and have a .req <span class="token function">file</span>
      extension. See import-req below <span class="token keyword">for</span> importing reqs from other sources.

<span class="token comment"># 颁发服务端证书</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa sign server server

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>


You are about to sign the following certificate.
Please check over the details shown below <span class="token keyword">for</span> accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span class="token builtin class-name">source</span> or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate <span class="token keyword">for</span> <span class="token number">825</span> days:

<span class="token assign-left variable">subject</span><span class="token operator">=</span>
    commonName                <span class="token operator">=</span> server


Type the word <span class="token string">'yes'</span> to continue, or any other input to abort.
  Confirm request details: <span class="token function">yes</span>		<span class="token comment"># 输入yes，回车</span>
Using configuration from /etc/openvpn/easy-rsa-server/pki/easy-rsa-3000.Ova1sM/tmp.xCpj0p
Check that the request matches the signature
Signature ok
The Subject<span class="token string">'s Distinguished Name is as follows
commonName            :ASN.1 12:'</span>server'
Certificate is to be certified <span class="token keyword">until</span> Jan  <span class="token number">7</span> <span class="token number">14</span>:03:25 <span class="token number">2023</span> GMT <span class="token punctuation">(</span><span class="token number">825</span> days<span class="token punctuation">)</span>

Write out database with <span class="token number">1</span> new entries
Data Base Updated

Certificate created at: /etc/openvpn/easy-rsa-server/pki/issued/server.crt <span class="token comment"># 生成的证书</span>


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki
pki
├── ca.crt
├── certs_by_serial
│   └── 61A86BA6C8B9482479FEF411570C8654.pem	<span class="token comment"># 服务器证书文件</span>
├── index.txt
├── index.txt.attr
├── index.txt.attr.old
├── index.txt.old
├── issued
│   └── server.crt
├── openssl-easyrsa.cnf
├── private
│   ├── ca.key
│   └── server.key		<span class="token comment"># 服务器证书文件，这两个文件是一样的</span>
├── renewed
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── reqs
│   └── server.req
├── revoked
│   ├── certs_by_serial
│   ├── private_by_serial
│   └── reqs_by_serial
├── safessl-easyrsa.cnf
├── serial
└── serial.old

<span class="token number">12</span> directories, <span class="token number">14</span> files</code></pre>

<h5 id="6-创建-Diffie-Hellman-密钥"><a href="#6-创建-Diffie-Hellman-密钥" class="headerlink" title="6. 创建 Diffie-Hellman 密钥"></a>6. 创建 Diffie-Hellman 密钥</h5><p>DH 密钥，用于 SSL 加密通信</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa gen-dh

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating DH parameters, <span class="token number">2048</span> bit long safe prime, generator <span class="token number">2</span>
This is going to take a long <span class="token function">time</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.	<span class="token comment"># 需要等一会</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$ll</span> ./pki/dh.pem
-rw------- <span class="token number">1</span> root root <span class="token number">424</span> Oct  <span class="token number">4</span> <span class="token number">22</span>:09 ./pki/dh.pem</code></pre>

<h5 id="7-准备客户端证书环境"><a href="#7-准备客户端证书环境" class="headerlink" title="7. 准备客户端证书环境"></a>7. 准备客户端证书环境</h5><p>上面服务端证书配置完成，下面是配置客户端证书</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$cd</span> <span class="token punctuation">..</span>/easy-rsa-client/
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn/easy-rsa-client
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">100</span>
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">76946</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 easyrsa
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4616</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 openssl-easyrsa.cnf
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">8925</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 vars
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Oct  <span class="token number">4</span> <span class="token number">21</span>:38 x509-types
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$tree</span>
<span class="token builtin class-name">.</span>
├── easyrsa
├── openssl-easyrsa.cnf
├── vars
└── x509-types
    ├── ca
    ├── client
    ├── code-signing
    ├── COMMON
    ├── email
    ├── kdc
    ├── server
    └── serverClient

<span class="token number">1</span> directory, <span class="token number">11</span> files
<span class="token comment"># 初始化pki，和上面步骤一样，就不详细介绍了</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span>$./easyrsa init-pki</code></pre>

<h5 id="8-创建客户端证书申请"><a href="#8-创建客户端证书申请" class="headerlink" title="8. 创建客户端证书申请"></a>8. 创建客户端证书申请</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span>$./easyrsa gen-req lujinkai nopass

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>
Generating a <span class="token number">2048</span> bit RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++
writing new private key to <span class="token string">'/etc/openvpn/easy-rsa-client/pki/easy-rsa-3187.Tyzo2P/tmp.KswAlv'</span>
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Common Name <span class="token punctuation">(</span>eg: your user, host, or server name<span class="token punctuation">)</span> <span class="token punctuation">[</span>lujinkai<span class="token punctuation">]</span>:	<span class="token comment"># 默认，回车</span>

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-client/pki/reqs/lujinkai.req		<span class="token comment"># 申请文件</span>
key: /etc/openvpn/easy-rsa-client/pki/private/lujinkai.key	<span class="token comment"># 私钥</span>
</code></pre>

<h5 id="9-签发客户端证书"><a href="#9-签发客户端证书" class="headerlink" title="9. 签发客户端证书"></a>9. 签发客户端证书</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 回到easy-rsa-server</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-client<span class="token punctuation">]</span><span class="token variable">$cd</span> <span class="token punctuation">..</span>/easy-rsa-server/
<span class="token comment"># 将客户端证书请求文件复制到CA的工作目录，也可以使用cp命令</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa import-req /etc/openvpn/easy-rsa-client/pki/reqs/lujinkai.req lujinkai

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>

The request has been successfully imported with a short name of: lujinkai
You may now use this name to perform signing operations on this request.


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki/reqs/
pki/reqs/
├── lujinkai.req	<span class="token comment"># 复制过来的申请文件</span>
└── server.req

<span class="token number">0</span> directories, <span class="token number">2</span> files
<span class="token comment"># 签发客户端证书</span>
<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span>$./easyrsa sign client lujinkai

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/vars
Using SSL: openssl OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span>


You are about to sign the following certificate.
Please check over the details shown below <span class="token keyword">for</span> accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span class="token builtin class-name">source</span> or that you have verified the request checksum with the sender.

Request subject, to be signed as a client certificate <span class="token keyword">for</span> <span class="token number">825</span> days:

<span class="token assign-left variable">subject</span><span class="token operator">=</span>
    commonName                <span class="token operator">=</span> lujinkai


Type the word <span class="token string">'yes'</span> to continue, or any other input to abort.
  Confirm request details: <span class="token function">yes</span>	<span class="token comment"># 输入yes，回车</span>
Using configuration from /etc/openvpn/easy-rsa-server/pki/easy-rsa-3291.YugvYL/tmp.xXkvue
Check that the request matches the signature
Signature ok
The Subject<span class="token string">'s Distinguished Name is as follows
commonName            :ASN.1 12:'</span>lujinkai'
Certificate is to be certified <span class="token keyword">until</span> Jan  <span class="token number">7</span> <span class="token number">14</span>:24:14 <span class="token number">2023</span> GMT <span class="token punctuation">(</span><span class="token number">825</span> days<span class="token punctuation">)</span>

Write out database with <span class="token number">1</span> new entries
Data Base Updated

Certificate created at: /etc/openvpn/easy-rsa-server/pki/issued/lujinkai.crt


<span class="token punctuation">[</span>root@4710419222 easy-rsa-server<span class="token punctuation">]</span><span class="token variable">$tree</span> pki/issued/
pki/issued/
├── lujinkai.crt	<span class="token comment"># 签发的客户端证书</span>
└── server.crt

<span class="token number">0</span> directories, <span class="token number">2</span> files</code></pre>

<h5 id="10-将-ca-和服务器相关文件复制到服务器相应的目录"><a href="#10-将-ca-和服务器相关文件复制到服务器相应的目录" class="headerlink" title="10. 将 ca 和服务器相关文件复制到服务器相应的目录"></a>10. 将 ca 和服务器相关文件复制到服务器相应的目录</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cp</span> <span class="token parameter variable">-r</span> ./easy-rsa-server/pki/<span class="token punctuation">&#123;</span>ca.crt,issued/server.crt,private/server.key,dh.pem<span class="token punctuation">&#125;</span> ./certs/
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$ll</span> ./certs/
total <span class="token number">20</span>
-rw------- <span class="token number">1</span> root root <span class="token number">1172</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 ca.crt
-rw------- <span class="token number">1</span> root root  <span class="token number">424</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 dh.pem
-rw------- <span class="token number">1</span> root root <span class="token number">4547</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 server.crt
-rw------- <span class="token number">1</span> root root <span class="token number">1704</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:48 server.key</code></pre>

<h5 id="11-将-ca-和客户端相关文件复制到服务器相关的目录"><a href="#11-将-ca-和客户端相关文件复制到服务器相关的目录" class="headerlink" title="11. 将 ca 和客户端相关文件复制到服务器相关的目录"></a>11. 将 ca 和客户端相关文件复制到服务器相关的目录</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cp</span> easy-rsa-server/pki/<span class="token punctuation">&#123;</span>ca.crt,issued/lujinkai.crt<span class="token punctuation">&#125;</span> client/
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$cp</span> easy-rsa-client/pki/private/lujinkai.key client/
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$ll</span> client/
total <span class="token number">16</span>
-rw------- <span class="token number">1</span> root root <span class="token number">1172</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:52 ca.crt
-rw------- <span class="token number">1</span> root root <span class="token number">4431</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:52 lujinkai.crt
-rw------- <span class="token number">1</span> root root <span class="token number">1708</span> Oct  <span class="token number">5</span> <span class="token number">18</span>:52 lujinkai.key</code></pre>

<h4 id="准备-OpenVPN-服务端配置文件"><a href="#准备-OpenVPN-服务端配置文件" class="headerlink" title="准备 OpenVPN 服务端配置文件"></a>准备 OpenVPN 服务端配置文件</h4><h5 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># grep -Ev '^#|^$' server.conf 或：</span>
<span class="token punctuation">[</span>root@4710419222 openvpn<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-e</span> <span class="token string">'/^#/d'</span> <span class="token parameter variable">-e</span> <span class="token string">'/^$/d'</span> server.conf
<span class="token punctuation">;</span><span class="token builtin class-name">local</span> a.b.c.d	<span class="token comment"># 本机监听IP,默认为本机所有IP</span>
port <span class="token number">1194</span>
<span class="token punctuation">;</span>proto tcp
proto udp
<span class="token punctuation">;</span>dev tap	<span class="token comment"># 创建一个以太网隧道，tap模拟以太网设备，工作在第二层</span>
dev tun		<span class="token comment"># 创建一个路由IP隧道，tun模拟网络层设备，工作在第三层</span>
<span class="token punctuation">;</span>dev-node MyTap		<span class="token comment"># TAP-Win32适配器。非windows不需要配置</span>
ca ca.crt			<span class="token comment"># ca证书文件</span>
cert server.crt		<span class="token comment"># 服务器证书文件</span>
key server.key		<span class="token comment"># 服务器私钥文件  # This file should be kept secret</span>
dh dh2048.pem		<span class="token comment"># dh参数文件</span>
<span class="token punctuation">;</span>topology subnet	<span class="token comment"># 拓扑类型：默认是net30模式，很浪费IP地址，建议开启subnet模式</span>
server <span class="token number">10.8</span>.0.0 <span class="token number">255.255</span>.255.0 <span class="token comment"># 客户端建立ssl连接后分配IP的连接池，服务器默认占用第一个IP 10.8.0.1</span>
ifconfig-pool-persist ipp.txt	<span class="token comment"># 为客户端分配固定的IP</span>
<span class="token punctuation">;</span>server-bridge <span class="token number">10.8</span>.0.4 <span class="token number">255.255</span>.255.0 <span class="token number">10.8</span>.0.50 <span class="token number">10.8</span>.0.100	<span class="token comment"># 配置网桥模式</span>
<span class="token punctuation">;</span>server-bridge
<span class="token punctuation">;</span>push <span class="token string">"route 192.168.10.0 255.255.255.0"</span>	<span class="token comment"># 推送路由设置给客户端，设置私网地址</span>
<span class="token punctuation">;</span>push <span class="token string">"route 192.168.20.0 255.255.255.0"</span>
<span class="token punctuation">;</span>client-config-dir ccd		<span class="token comment"># 指定的客户端添加路由，此路由通常是客户端后面的内网网段</span>
<span class="token punctuation">;</span>route <span class="token number">192.168</span>.40.128 <span class="token number">255.255</span>.255.248
<span class="token punctuation">;</span>client-config-dir ccd
<span class="token punctuation">;</span>route <span class="token number">10.9</span>.0.0 <span class="token number">255.255</span>.255.252
<span class="token punctuation">;</span>learn-address ./script		<span class="token comment"># 运行外部脚本，创建不同组的iptables规则</span>
<span class="token punctuation">;</span>push <span class="token string">"redirect-gateway def1 bypass-dhcp"</span>	<span class="token comment"># 启用后，客户端所有流量都将通过VPN服务器</span>
<span class="token punctuation">;</span>push <span class="token string">"dhcp-option DNS 208.67.222.222"</span>		<span class="token comment"># 推送DNS服务器</span>
<span class="token punctuation">;</span>push <span class="token string">"dhcp-option DNS 208.67.220.220"</span>
<span class="token punctuation">;</span>client-to-client		<span class="token comment"># 允许不同的client直接通信,不安全,生产环境一般不配置</span>
<span class="token punctuation">;</span>duplicate-cn		<span class="token comment"># 多个用户共用一个证书，一般用于测试环境，生产环境都是一个用户一个证书</span>
keepalive <span class="token number">10</span> <span class="token number">120</span>	<span class="token comment"># 心跳，10秒ping一次，120秒没有回应则认为对方已经down</span>
<span class="token comment"># 访止DoS等攻击的安全增强配置，可以使用openvpn命令生成：openvpn --genkey --secret ta.key</span>
<span class="token comment"># 服务器和每个客户端都需要拥有该密钥的一个拷贝。第二个参数在服务器端应该为’0’，在客户端应该为’1’</span>
tls-auth ta.key <span class="token number">0</span> <span class="token comment"># This file is secret</span>
cipher AES-256-CBC	<span class="token comment"># 加密算法</span>
<span class="token punctuation">;</span>compress lz4-v2	<span class="token comment"># 启用Openvpn2.4.X新版压缩算法</span>
<span class="token punctuation">;</span>push <span class="token string">"compress lz4-v2"</span>	<span class="token comment"># 推送客户端使用新版压缩算法,和下面的comp-lzo不要同时使用</span>
<span class="token punctuation">;</span>comp-lzo	<span class="token comment"># 旧户端兼容的压缩配置，需要客户端配置开启压缩,openvpn2.4.X等新版可以不用开启</span>
<span class="token punctuation">;</span>max-clients <span class="token number">100</span>	<span class="token comment"># 最大客户端数</span>
<span class="token punctuation">;</span>user nobody	<span class="token comment"># 运行openvpn服务的用户和组</span>
<span class="token punctuation">;</span>group nobody
persist-key		<span class="token comment"># 重启VPN服务时默认会重新读取key文件</span>
persist-tun		<span class="token comment"># 重启vpn服务时，一直保持tun或者tap设备是up的，否则会先down然后再up</span>
status openvpn-status.log	<span class="token comment"># openVPN状态记录文件，每分钟会记录一次</span>
<span class="token punctuation">;</span>log         openvpn.log	<span class="token comment"># 指定日志路径，log会在openvpn启动的时候清空日志文件</span>
<span class="token punctuation">;</span>log-append  openvpn.log	<span class="token comment"># 指定日志路径，重启openvpn后在之前的日志后面追加新的日志</span>
<span class="token comment"># 设置日志级别，0-9，级别越高记录的内容越详细,0 表示静默运行，只记录致命错误,4 表示合理的常规用法,5 和 6 可以帮助调试连接错误。9 表示极度冗余，输出非常详细的日志信息</span>
verb <span class="token number">3</span>
<span class="token punctuation">;</span>mute <span class="token number">20</span>	<span class="token comment"># 相同类别的信息只有前20条会输出到日志文件中</span>
<span class="token comment"># 通知客户端，在服务端重启后自动重新连接，仅能用于udp模式，tcp模式不需要配置即可实现断开重新连接,且开启此项后tcp配置后将导致openvpn服务无法启动,所以tcp时必须不能开启此项</span>
explicit-exit-notify <span class="token number">1</span></code></pre>

<h5 id="修改服务端配置文件"><a href="#修改服务端配置文件" class="headerlink" title="修改服务端配置文件"></a>修改服务端配置文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash">port <span class="token number">1194</span>
proto tcp
dev tun
ca /etc/openvpn/certs/ca.crt
cert /etc/openvpn/certs/server.crt
key /etc/openvpn/certs/server.key  <span class="token comment"># This file should be kept secret</span>
dh /etc/openvpn/certs/dh.pem
topology subnet
server <span class="token number">10.8</span>.0.0 <span class="token number">255.255</span>.255.0
push <span class="token string">"route 10.0.0.0 255.255.255.0"</span>
keepalive <span class="token number">10</span> <span class="token number">120</span>
max-clients <span class="token number">1024</span>
user openvpn
group openvpn
status /var/log/openvpn/openvpn-status.log
log-append  /var/log/openvpn/openvpn.log
verb <span class="token number">9</span>
mute <span class="token number">20</span></code></pre>

<h5 id="准备日志相关"><a href="#准备日志相关" class="headerlink" title="准备日志相关"></a>准备日志相关</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$getent</span> <span class="token function">passwd</span> openvpn
openvpn:x:995:993:OpenVPN:/etc/openvpn:/sbin/nologin
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$mkdir</span> /var/log/openvpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$chown</span> openvpn.openvpn /var/log/openvpn</code></pre>

<h4 id="配置防火墙和内核参数"><a href="#配置防火墙和内核参数" class="headerlink" title="配置防火墙和内核参数"></a>配置防火墙和内核参数</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启ip_forward</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/net/ipv4/ip_forward
<span class="token comment"># 添加snat规则</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$nft</span> list ruleset
table <span class="token function">ip</span> nat <span class="token punctuation">&#123;</span>
        chain postrouting <span class="token punctuation">&#123;</span>
                <span class="token builtin class-name">type</span> nat hook postrouting priority srcnat<span class="token punctuation">;</span> policy accept<span class="token punctuation">;</span>
                <span class="token function">ip</span> saddr <span class="token number">10.8</span>.0.0/24 masquerade
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>比较奇怪的是以上设置不对，好像 nftables 不行，只能使用 iptables，于是关掉 nftables，设置 iptables：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 nftables<span class="token punctuation">]</span><span class="token variable">$iptables</span> <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">10.8</span>.0.0/24 <span class="token parameter variable">-j</span> MASQUERADE</code></pre>

<h4 id="启动-OpenVPN"><a href="#启动-OpenVPN" class="headerlink" title="启动 OpenVPN"></a>启动 OpenVPN</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> start openvpn@server
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$systemctl</span> status openvpn@server
● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/openvpn@.service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Wed <span class="token number">2020</span>-10-07 <span class="token number">17</span>:41:08 CST<span class="token punctuation">;</span> 2s ago
 Main PID: <span class="token number">10185</span> <span class="token punctuation">(</span>openvpn<span class="token punctuation">)</span>
   Status: <span class="token string">"Initialization Sequence Completed"</span>
   CGroup: /system.slice/system-openvpn.slice/openvpn@server.service
           └─10185 /usr/sbin/openvpn <span class="token parameter variable">--cd</span> /etc/openvpn/ <span class="token parameter variable">--config</span> server.conf

Oct 07 <span class="token number">17</span>:41:08 <span class="token number">4710419222</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Starting OpenVPN Robust And Highly Flexible Tunneling Application On server<span class="token punctuation">..</span>.
Oct 07 <span class="token number">17</span>:41:08 <span class="token number">4710419222</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started OpenVPN Robust And Highly Flexible Tunneling Application On server.
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$ss</span> <span class="token parameter variable">-ntl</span>
State      Recv-Q Send-Q                                     Local Address:Port                                                    Peer Address:Port
LISTEN     <span class="token number">0</span>      <span class="token number">32</span>                                                     *:1194                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:3306                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                            <span class="token number">127.0</span>.0.1:6379                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:80                                                                 *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:22                                                                 *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:443                                                                *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:9501                                                               *:*
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>                                                    *:8000                                                               *:*
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> openvpn
openvpn  <span class="token number">10185</span>  <span class="token number">0.0</span>  <span class="token number">0.3</span>  <span class="token number">75036</span>  <span class="token number">7420</span> ?        Ss   <span class="token number">17</span>:41   <span class="token number">0</span>:00 /usr/sbin/openvpn <span class="token parameter variable">--cd</span> /etc/openvpn/ <span class="token parameter variable">--config</span> server.conf
root     <span class="token number">10232</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>   <span class="token number">9096</span>   <span class="token number">848</span> pts/1    R+   <span class="token number">17</span>:41   <span class="token number">0</span>:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span> openvpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$ip</span> a
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span>
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:16:3e:05:9f:fc brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.0</span>.0.1/24 brd <span class="token number">10.0</span>.0.255 scope global dynamic eth0
       valid_lft 315108100sec preferred_lft 315108100sec
    inet6 fe80::216:3eff:fe05:9ffc/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: tun0: <span class="token operator">&lt;</span>POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UNKNOWN group default qlen <span class="token number">100</span>
    link/none
    inet <span class="token number">10.8</span>.0.1/24 brd <span class="token number">10.8</span>.0.255 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::2fa5:3d20:6dff:99d9/64 scope <span class="token function">link</span> flags <span class="token number">800</span>
       valid_lft forever preferred_lft forever</code></pre>

<h4 id="准备-OpenVPN-客户端配置文件"><a href="#准备-OpenVPN-客户端配置文件" class="headerlink" title="准备 OpenVPN 客户端配置文件"></a>准备 OpenVPN 客户端配置文件</h4><h5 id="配置文件说明-1"><a href="#配置文件说明-1" class="headerlink" title="配置文件说明"></a>配置文件说明</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 客户端配置文件，后缀必须是.ovpn</span>
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$grep</span> <span class="token parameter variable">-v</span> <span class="token string">'^#'</span> /usr/share/doc/openvpn-2.4.9/sample/sample-config-files/client.conf <span class="token operator">></span> /etc/openvpn/client/lujinkai/client.ovpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/^$/d'</span> /etc/openvpn/client/lujinkai/client.ovpn
<span class="token punctuation">[</span>root@4710419222 ~<span class="token punctuation">]</span><span class="token variable">$cat</span> /etc/openvpn/client/lujinkai/client.ovpn
client		<span class="token comment"># 声明客户端</span>
<span class="token punctuation">;</span>dev tap	<span class="token comment"># 接口类型，必须和服务端一致</span>
dev tun
<span class="token punctuation">;</span>dev-node MyTap
<span class="token punctuation">;</span>proto tcp	<span class="token comment"># 协议类型，必须和服务端一致</span>
proto udp
remote my-server-1 <span class="token number">1194</span>		<span class="token comment"># server端的ip和端口，可以写域名但是需要可以解析成IP</span>
<span class="token punctuation">;</span>remote my-server-2 <span class="token number">1194</span>
<span class="token punctuation">;</span>remote-random
resolv-retry infinite		<span class="token comment"># 如果写域名，就始终解析，当域名发生变化，会重新连接到新的域名对应的IP</span>
nobind		<span class="token comment"># 本机不绑定监听端口，客户端是随机打开端口连接到服务端的1194</span>
<span class="token punctuation">;</span>user nobody
<span class="token punctuation">;</span>group nobody
persist-key
persist-tun
<span class="token punctuation">;</span>http-proxy-retry <span class="token comment"># retry on connection failures</span>
<span class="token punctuation">;</span>http-proxy <span class="token punctuation">[</span>proxy server<span class="token punctuation">]</span> <span class="token punctuation">[</span>proxy port <span class="token comment">#]</span>
<span class="token punctuation">;</span>mute-replay-warnings
ca ca.crt
cert client.crt
key client.key
remote-cert-tls server	<span class="token comment"># 指定采用服务器证书校验方式</span>
tls-auth ta.key <span class="token number">1</span>
cipher AES-256-CBC
verb <span class="token number">3</span>
<span class="token punctuation">;</span>mute <span class="token number">20</span></code></pre>

<h5 id="修改客户端配置文件"><a href="#修改客户端配置文件" class="headerlink" title="修改客户端配置文件"></a>修改客户端配置文件</h5><pre class="language-bash" data-language="bash"><code class="language-bash">client
dev tun
proto tcp
remote <span class="token number">47.104</span>.192.22 <span class="token number">1194</span>
resolv-retry infinite
nobind
ca ca.crt
cert lujinkai.crt
key lujinkai.key
remote-cert-tls server
<span class="token punctuation">;</span>tls-auth ta.key <span class="token number">1</span>
<span class="token punctuation">;</span>cipher AES-256-CBC
verb <span class="token number">3</span>
mute <span class="token number">20</span></code></pre>

<h4 id="Windows-配置部署-OpenVPN-客户端"><a href="#Windows-配置部署-OpenVPN-客户端" class="headerlink" title="Windows 配置部署 OpenVPN 客户端"></a>Windows 配置部署 OpenVPN 客户端</h4><p>将客户端相关文件下载下来：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@4710419222 lujinkai<span class="token punctuation">]</span><span class="token variable">$pwd</span>
/etc/openvpn/client/lujinkai
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$ll</span> lujinkai
total <span class="token number">20</span>
-rw------- <span class="token number">1</span> root root <span class="token number">1172</span> Oct  <span class="token number">4</span> <span class="token number">19</span>:25 ca.crt
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">436</span> Oct  <span class="token number">7</span> <span class="token number">18</span>:05 client.ovpn
-rw------- <span class="token number">1</span> root root <span class="token number">4438</span> Oct  <span class="token number">4</span> <span class="token number">19</span>:25 lujinkai.crt
-rw------- <span class="token number">1</span> root root <span class="token number">1704</span> Oct  <span class="token number">4</span> <span class="token number">19</span>:25 lujinkai.key
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$tar</span> cvf lujinkai.tar lujinkai/
lujinkai/
lujinkai/lujinkai.key
lujinkai/client.ovpn
lujinkai/ca.crt
lujinkai/lujinkai.crt
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$ll</span>
total <span class="token number">24</span>
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">4096</span> Oct  <span class="token number">7</span> <span class="token number">18</span>:28 lujinkai
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">20480</span> Oct  <span class="token number">8</span> <span class="token number">10</span>:57 lujinkai.tar
<span class="token punctuation">[</span>root@4710419222 client<span class="token punctuation">]</span><span class="token variable">$sz</span> lujinkai.tar
rz
Starting zmodem transfer.  Press Ctrl+C to cancel.
Transferring lujinkai.tar<span class="token punctuation">..</span>.
  <span class="token number">100</span>%      <span class="token number">20</span> KB      <span class="token number">20</span> KB/sec    00:00:01       <span class="token number">0</span> Errors</code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1602126060938.png"></p>
<p>注意：tap 网卡驱动可能因为缺少数字签名无法启动，可以在开机的时候按 F8，然后禁用校验驱动的数字签名，可是这样只能当次开机有效，不知道怎么彻底解决。。。</p>
<p><img data-src="//img.to2b.cn/blog/ljk/1602126241434.png"></p>
<h4 id="Mac-OS-配置部署-OpenVPN-客户端"><a href="#Mac-OS-配置部署-OpenVPN-客户端" class="headerlink" title="Mac OS 配置部署 OpenVPN 客户端"></a>Mac OS 配置部署 OpenVPN 客户端</h4><p>略。。。</p>
<h2 id="故障排错"><a href="#故障排错" class="headerlink" title="故障排错"></a>故障排错</h2><h2 id="OpenVPN-高级功能"><a href="#OpenVPN-高级功能" class="headerlink" title="OpenVPN 高级功能"></a>OpenVPN 高级功能</h2><h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="//img.lujinkai.cn/blog/ljk/1607160536339.png" alt="像方便面一样的男子 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="//img.lujinkai.cn/blog/ljk/1607160019009.png" alt="像方便面一样的男子 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/OpenVPN/" rel="tag"><i class="fa fa-tag"></i> OpenVPN</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/%E9%98%B2%E7%81%AB%E5%A2%99/iptables/" rel="prev" title="iptables">
                  <i class="fa fa-chevron-left"></i> iptables
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/MySQL/58%E5%88%B0%E5%AE%B6%E6%95%B0%E6%8D%AE%E5%BA%9330%E6%9D%A1%E5%86%9B%E8%A7%84%E8%A7%A3%E8%AF%BB/" rel="next" title="58到家数据库30条军规解读">
                  58到家数据库30条军规解读 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.lujinkai.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.lujinkai.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.lujinkai.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.lujinkai.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
