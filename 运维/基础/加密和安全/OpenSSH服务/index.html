<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="32x32" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="icon" type="image/png" sizes="16x16" href="//img.to2b.cn/blog/ljk/1607154764582.png">
  <link rel="mask-icon" href="//img.to2b.cn/blog/ljk/1607154764582.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//s1.to2b.cn/libs/fontawesome-free/5.15.4/css/all.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.lujinkai.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":10},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"KN3H1V8A6V","apiKey":"c5d73d0dde2dd770ce49b505f938553d","indexName":"hexo","hits":{"per_page":20,"labels":{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="说明：ssh 客户端（后面简称 ssh）、ssh 服务端（后面简称 sshd） SSH 认证过程  Client 10.0.0.8 ssh 远程连接 Server 10.0.0.7： [root@centos8 ~]$ssh 10.0.0.7 The authenticity of host &#39;10.0.0.7 (10.0.0.7)&#39; can&#39;t be established. ECDSA key">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenSSH服务">
<meta property="og:url" content="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSH%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="LJKのBlog">
<meta property="og:description" content="说明：ssh 客户端（后面简称 ssh）、ssh 服务端（后面简称 sshd） SSH 认证过程  Client 10.0.0.8 ssh 远程连接 Server 10.0.0.7： [root@centos8 ~]$ssh 10.0.0.7 The authenticity of host &#39;10.0.0.7 (10.0.0.7)&#39; can&#39;t be established. ECDSA key">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1599574238261.png">
<meta property="og:image" content="http://img.to2b.cn/blog/ljk/1599660530199.png">
<meta property="article:published_time" content="2020-12-09T15:03:35.000Z">
<meta property="article:modified_time" content="2023-05-29T08:58:05.506Z">
<meta property="article:author" content="像方便面一样的男子">
<meta property="article:tag" content="OpenSSH">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.to2b.cn/blog/ljk/1599574238261.png">


<link rel="canonical" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSH%E6%9C%8D%E5%8A%A1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSH%E6%9C%8D%E5%8A%A1/","path":"运维/基础/加密和安全/OpenSSH服务/","title":"OpenSSH服务"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>OpenSSH服务 | LJKのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LJKのBlog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学无止境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#SSH-%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">SSH 认证过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="nav-number">2.</span> <span class="nav-text">相关文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ssh-Client-%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">ssh Client 相关文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ssh-Server-%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.</span> <span class="nav-text">ssh Server 相关文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ssh-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7"><span class="nav-number">3.</span> <span class="nav-text">ssh 客户端工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ssh"><span class="nav-number">3.1.</span> <span class="nav-text">ssh</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-keygen"><span class="nav-number">3.1.1.</span> <span class="nav-text">ssh-keygen</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-copy-id"><span class="nav-number">3.1.2.</span> <span class="nav-text">ssh-copy-id</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#scp"><span class="nav-number">3.2.</span> <span class="nav-text">scp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rsync"><span class="nav-number">3.3.</span> <span class="nav-text">rsync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sftp"><span class="nav-number">3.4.</span> <span class="nav-text">sftp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">高级应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SSH-%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-number">4.1.</span> <span class="nav-text">SSH 本地端口转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSH-%E8%BF%9C%E7%A8%8B%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-number">4.2.</span> <span class="nav-text">SSH 远程端口转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSH-%E5%8A%A8%E6%80%81%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-number">4.3.</span> <span class="nav-text">SSH 动态端口转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#X-%E5%8D%8F%E8%AE%AE%E8%BD%AC%E5%8F%91"><span class="nav-number">4.4.</span> <span class="nav-text">X 协议转发</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="像方便面一样的男子"
      src="//img.to2b.cn/blog/ljk/1607154764582.png">
  <p class="site-author-name" itemprop="name">像方便面一样的男子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">340</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ljkk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljkk" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.lujinkai.cn/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSH%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="//img.to2b.cn/blog/ljk/1607154764582.png">
      <meta itemprop="name" content="像方便面一样的男子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LJKのBlog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="OpenSSH服务 | LJKのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          OpenSSH服务
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-12-09 23:03:35" itemprop="dateCreated datePublished" datetime="2020-12-09T23:03:35+08:00">2020-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-29 16:58:05" itemprop="dateModified" datetime="2023-05-29T16:58:05+08:00">2023-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">加密和安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>说明：ssh 客户端（后面简称 ssh）、ssh 服务端（后面简称 sshd）</p>
<h2 id="SSH-认证过程"><a href="#SSH-认证过程" class="headerlink" title="SSH 认证过程"></a><a target="_blank" rel="noopener" href="https://blog.51cto.com/wchrt/1650552">SSH 认证过程</a></h2><img data-src="//img.to2b.cn/blog/ljk/1599574238261.png"  />

<p>Client 10.0.0.8 ssh 远程连接 Server 10.0.0.7：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$ssh</span> <span class="token number">10.0</span>.0.7
The authenticity of <span class="token function">host</span> <span class="token string">'10.0.0.7 (10.0.0.7)'</span> can<span class="token string">'t be established.
ECDSA key fingerprint is SHA256:CfDVSb/UU590ZKQ0DZhZp7/76rLHeKak/pHGp2af4kw.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span><span class="token number">10.0</span>.0.7<span class="token string">' (ECDSA) to the list of known hosts.
root@10.0.0.7'</span>s password:
Last login: Wed Sep  <span class="token number">9</span> <span class="token number">19</span>:05:15 <span class="token number">2020</span> from <span class="token number">10.0</span>.0.8
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#</span></code></pre>

<p><img data-src="//img.to2b.cn/blog/ljk/1599660530199.png"></p>
<ol>
<li><p>no.6、no.8：协商版本号，可以看到 Client 的 OpenSSH 版本更高，则以 Server 为准</p>
</li>
<li><p>no.10、no.11：相互交换各自支持的算法，协商各种算法，以 Client 优先</p>
</li>
<li><p>no.12 - 14：使用 DH 算法交换密钥，之后的通信都使用会话密钥加密，具体参考笔记[13.2 DH.md](.&#x2F;13.2 DH.md)，</p>
</li>
<li><p>认证：SSH 支持多种认证，最常用的是口令认证和密钥认证，这个过程已经加密了，用 Wireshark 抓包看不出任何信息</p>
</li>
</ol>
<h2 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h2><p>一台主机，既可以是 ssh Client，也可以是 ssh Server</p>
<h3 id="ssh-Client-相关文件"><a href="#ssh-Client-相关文件" class="headerlink" title="ssh Client 相关文件"></a>ssh Client 相关文件</h3><table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;ssh&#x2F;ssh_config</td>
<td>客户端全局配置文件</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;config</td>
<td>客户端的用户配置文件，默认不存在，权限只能是 644</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;known_hosts</td>
<td>保存服务端的公钥</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;id_rsa</td>
<td>客户端私钥，由 ssh-keygen 生成，权限只能是 600</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;id_rsa.pub</td>
<td>客户端公钥，由 ssh-keygen 生成</td>
</tr>
</tbody></table>
<p><strong>&#x2F;etc&#x2F;ssh&#x2F;ssh_config：</strong></p>
<p>需要说明的是，客户端配置文件有很多配置项和服务端配置项名称相同，但它们一个是在连接时采取的配置(客户端配置文件)，一个是 sshd 启动时开关性的设置(服务端配置文件)。例如，两配置文件都有 GSSAPIAuthentication 项，在客户端将其设置为 no，表示连接时将直接跳过该身份验证机制，而在服务端设置为 no 则表示 sshd 启动时不开启 GSSAPI 身份验证的机制。即使客户端使用了 GSSAPI 认证机制，只要服务端没有开启，就绝对不可能认证通过。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>PasswordAuthentication</td>
<td>yes</td>
<td>是否启用基于密码的身份认证机制</td>
</tr>
<tr>
<td>HostbasedAuthentication</td>
<td>no</td>
<td>是否启用基于主机的身份认证机制</td>
</tr>
<tr>
<td>GSSAPIAuthentication</td>
<td>no</td>
<td>是否启用基于 GSSAPI 的身份认证机制</td>
</tr>
<tr>
<td>BatchMode</td>
<td>no</td>
<td>yes：将禁止 passphrase&#x2F;password 询问</td>
</tr>
<tr>
<td>StrictHostKeyChecking</td>
<td>ask</td>
<td>yes：拒绝连接那些未知的主机，它将强制用户手动添加 host key 到~&#x2F;.ssh&#x2F;known_hosts 中； <br/>ask：询问是否保存到~&#x2F;.ssh&#x2F;known_hosts 文件； <br/>no：自动添加到~&#x2F;.ssh&#x2F;known_hosts 文件</td>
</tr>
<tr>
<td>Port</td>
<td>22</td>
<td>当命令行中不指定端口时，默认连接的远程主机上的端口</td>
</tr>
</tbody></table>
<h3 id="ssh-Server-相关文件"><a href="#ssh-Server-相关文件" class="headerlink" title="ssh Server 相关文件"></a>ssh Server 相关文件</h3><table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;ssh&#x2F;sshd_config</td>
<td>服务端全局配置文件</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;ssh&#x2F;ssh<em>host</em>*</td>
<td>sshd 启动时生成的服务端公钥和私钥文件，其中私钥文件权限只能是 600</td>
</tr>
<tr>
<td>~&#x2F;.ssh&#x2F;authorized_keys</td>
<td>保存客户端的公钥，用于 key 验证，免密登录</td>
</tr>
</tbody></table>
<p><strong>&#x2F;etc&#x2F;ssh&#x2F;sshd_config：</strong></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#Port 22                # 服务端SSH端口，可以指定多条表示监听在多个端口上</span>
<span class="token comment">#ListenAddress 0.0.0.0  # 监听的IP地址。0.0.0.0表示监听所有IP</span>
Protocol <span class="token number">2</span>              <span class="token comment"># 使用SSH 2版本</span>

<span class="token comment">#####################################</span>
<span class="token comment">#          私钥保存位置               #</span>
<span class="token comment">#####################################</span>
<span class="token comment"># HostKey for protocol version 1</span>
<span class="token comment">#HostKey /etc/ssh/ssh_host_key      # SSH 1保存位置/etc/ssh/ssh_host_key</span>
<span class="token comment"># HostKeys for protocol version 2</span>
<span class="token comment">#HostKey /etc/ssh/ssh_host_rsa_key  # SSH 2保存RSA位置/etc/ssh/ssh_host_rsa _key</span>
<span class="token comment">#HostKey /etc/ssh/ssh_host_dsa_key  # SSH 2保存DSA位置/etc/ssh/ssh_host_dsa _key</span>


<span class="token comment">###################################</span>
<span class="token comment">#           杂项配置               #</span>
<span class="token comment">###################################</span>
<span class="token comment">#PidFile /var/run/sshd.pid        # 服务程序sshd的PID的文件路径</span>
<span class="token comment">#ServerKeyBits 1024               # 服务器生成的密钥长度</span>
<span class="token comment">#SyslogFacility AUTH              # 使用哪个syslog设施记录ssh日志。日志路径默认为/var/log/secure</span>
<span class="token comment">#LogLevel INFO                    # 记录SSH的日志级别为INFO</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下项影响认证速度               #</span>
<span class="token comment">###################################</span>
<span class="token comment">#UseDNS yes                       # 指定是否将客户端主机名解析为IP，以检查此主机名是否与其IP地址真实									  对应。默认yes。</span>
                                  <span class="token comment"># 由此可知该项影响的是主机验证阶段。建议在未配置DNS解析时，将其设置									  为no，否则主机验证阶段会很慢</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下是和安全有关的配置           #</span>
<span class="token comment">###################################</span>
<span class="token comment">#PermitRootLogin yes              # 是否允许root用户登录</span>
<span class="token comment">#GSSAPIAuthentication no          # 是否开启GSSAPI身份认证机制，默认为yes</span>
<span class="token comment">#PubkeyAuthentication yes         # 是否开启基于公钥认证机制</span>
<span class="token comment">#AuthorizedKeysFile  .ssh/authorized_keys  # 基于公钥认证机制时，来自客户端的公钥的存放位置</span>
PasswordAuthentication <span class="token function">yes</span>        <span class="token comment"># 是否使用密码验证，如果使用密钥对验证可以关了它</span>
<span class="token comment">#PermitEmptyPasswords no          # 是否允许空密码，如果上面的那项是yes，这里最好设置no</span>
<span class="token comment">#MaxSessions 10                   # 最大客户端连接数量</span>
<span class="token comment">#LoginGraceTime 2m                # 身份验证阶段的超时时间，若在此超时期间内未完成身份验证将自动断开</span>
<span class="token comment">#MaxAuthTries 6                   # 指定每个连接最大允许的认证次数。默认值是6。</span>
                                  <span class="token comment"># 如果失败认证次数超过该值一半，将被强制断开，且生成额外日志消息。</span>
MaxStartups <span class="token number">10</span>                    <span class="token comment"># 最大允许保持多少个未认证的连接。默认值10。</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下可以自行添加到配置文件        #</span>
<span class="token comment">###################################</span>
DenyGroups  hellogroup testgroup  <span class="token comment"># 表示hellogroup和testgroup组中的成员不允许使用sshd服务，即拒绝              					   这些用户连接</span>
DenyUsers   hello <span class="token builtin class-name">test</span>            <span class="token comment"># 表示用户hello和test不能使用sshd服务，即拒绝这些用户连接</span>

<span class="token comment">###################################</span>
<span class="token comment">#   以下一项和远程端口转发有关        #</span>
<span class="token comment">###################################</span>
<span class="token comment">#GatewayPorts no                  # 设置为yes表示sshd允许被远程主机所设置的本地转发端口绑定在非环回 									地址上</span>
                                  <span class="token comment"># 默认值为no，表示远程主机设置的本地转发端口只能绑定在环回地址上，见									  后文"远程端口转发"</span></code></pre>

<p>一般来说，如非有特殊需求，只需修改下监听端口和 UseDNS 为 no 以加快主机验证阶段的速度即可。</p>
<h2 id="ssh-客户端工具"><a href="#ssh-客户端工具" class="headerlink" title="ssh 客户端工具"></a>ssh 客户端工具</h2><h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>user@<span class="token punctuation">]</span>remote_host <span class="token punctuation">[</span>command<span class="token punctuation">]</span>

<span class="token parameter variable">-p</span> port      <span class="token comment"># 远程服务监听的端口，默认是22</span>
<span class="token parameter variable">-o</span> option    <span class="token comment"># 临时修改配置</span>
<span class="token parameter variable">-i</span> <span class="token operator">&lt;</span>file <span class="token operator">></span>   <span class="token comment"># 指定私钥文件，默认使用 ~/.ssh/id_xxx</span></code></pre>

<h4 id="ssh-keygen"><a href="#ssh-keygen" class="headerlink" title="ssh-keygen"></a>ssh-keygen</h4><p>在客户端生成密钥对，默认存放在~&#x2F;.ssh 目录下</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa	<span class="token comment"># 提示保存位置，输入密码</span>

ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-P</span> <span class="token string">''</span> <span class="token parameter variable">-f</span> ~/.ssh/id_rsa	<span class="token comment"># 不提示直接生成密钥</span></code></pre>

<h4 id="ssh-copy-id"><a href="#ssh-copy-id" class="headerlink" title="ssh-copy-id"></a>ssh-copy-id</h4><p>使用 SSH 协议，将公钥追加到服务器的 ~&#x2F;.ssh&#x2F;authorized_keys 文件中</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ssh-copy-id <span class="token parameter variable">-i</span> ~/.ssh/id_rsa.pub remote_host</code></pre>

<h3 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h3><p>scp 命令用于 Linux 之间复制文件和目录，基于 SSH 协议。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> SRC<span class="token punctuation">..</span>. DEST/

<span class="token parameter variable">-C</span>    <span class="token comment"># 压缩数据流</span>
<span class="token parameter variable">-r</span>    <span class="token comment"># 递归复制</span>
<span class="token parameter variable">-p</span>    <span class="token comment"># 保持原文件的属性信息</span>
<span class="token parameter variable">-q</span>    <span class="token comment"># 静默模式</span>
<span class="token parameter variable">-P</span>    <span class="token comment"># PORT 指明remote host的监听的端口</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 从本地复制到远程：</span>
<span class="token function">scp</span> local_file root@to2b.cn:remote_file
<span class="token function">scp</span> local_file root@lujinkai:remote_file
<span class="token function">scp</span> local_file root@test.to2b.cn:remote_file

<span class="token comment"># 从远程复制到本地：</span>
<span class="token function">scp</span> root@to2b.cn:remote_file local_file
<span class="token function">scp</span> root@lujinkai.cn:remote_file local_file
<span class="token function">scp</span> root@test.to2b.cn:remote_file local_file</code></pre>

<h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><p>rsync 工具基于 SSH 和 RSYNC 协议实现高效率的远程系统之间复制文件，比 scp 更快，基于增量数据同步，此工具来自于 rsync 包</p>
<p>注意：通信双方都需要安装 rsync 软件</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">rsync</span> <span class="token parameter variable">-av</span> /etc server1:/tmp <span class="token comment">#复制目录和目录下文件</span>
<span class="token function">rsync</span> <span class="token parameter variable">-av</span> /etc/ server1:/tmp <span class="token comment">#只复制目录下文件</span>

<span class="token parameter variable">-n</span>                    <span class="token comment"># 模拟复制过程</span>
<span class="token parameter variable">-v</span>                    <span class="token comment"># 显示详细过程，-vvvv显示更详细的信息</span>
<span class="token parameter variable">-r</span>                    <span class="token comment"># 递归复制目录树</span>
<span class="token parameter variable">-p</span>                    <span class="token comment"># 保留权限（不包括特殊权限）</span>
<span class="token parameter variable">-t</span>                    <span class="token comment"># 保留修改时间戳（mtime），强烈建议任何时候都加上"-t",否则目标文件mtime会设置为系统时间,导致下次更新</span>
<span class="token parameter variable">-g</span>                    <span class="token comment"># 保留组信息</span>
<span class="token parameter variable">-o</span>                    <span class="token comment"># 保留所有者信息</span>
<span class="token parameter variable">-l</span>                    <span class="token comment"># 将软链接文件本身进行复制（默认）</span>
<span class="token parameter variable">-L</span>                    <span class="token comment"># 将软链接文件指向的文件复制</span>
<span class="token parameter variable">-u</span>                    <span class="token comment"># 如果接收者的文件比发送者的文件较新，将忽略同步</span>
<span class="token parameter variable">-z</span>                    <span class="token comment"># 压缩，节约网络带宽</span>
<span class="token parameter variable">-D</span>                    <span class="token comment"># "--device --specials"选项的组合,即也拷贝设备文件和特殊文件</span>
<span class="token parameter variable">-a</span>                    <span class="token comment"># 存档，相当于-rlptgoD，但不保留ACL（-A）和SELinux属性（-X）</span>
<span class="token parameter variable">-b</span>                    <span class="token comment"># 对目标上已存在的文件做一个备份,备份的文件名后默认使用"~"做后缀</span>
<span class="token parameter variable">--delete</span>              <span class="token comment"># 源数据删除，目标数据也自动同步删除</span>
--max-size            <span class="token comment">#</span>
--min-size            <span class="token comment"># 限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件</span>
<span class="token parameter variable">--exclude</span>             <span class="token comment"># 排除不需要传输的文件</span>
<span class="token parameter variable">--port</span>                <span class="token comment"># 连接daemon时使用的端口号,默认为873端口</span>
<span class="token parameter variable">--existing</span>            <span class="token comment"># 只更新目标端已存在的文件，注意：使用相对路径时如果上层目录不存在也不会传输</span>
--ignore-existing     <span class="token comment"># 要求只更新目标端不存在的文件。和"--existing"结合使用有特殊功能</span>
--remove-source-files <span class="token comment"># 要求删除源端已经成功传输的文件</span></code></pre>

<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment">#rsync -auv --delete /data/test 10.0.0.7:/data</span></code></pre>

<h3 id="sftp"><a href="#sftp" class="headerlink" title="sftp"></a>sftp</h3><p><strong>交互式</strong>文件传输工具，利用 ssh 服务实现安全的文件上传和下载，使用 ls cd mkdir rmdir pwd get put 等指令，详细说明可以使用 help 查看</p>
<p>范例：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>lujinkai@ubuntu1804 data<span class="token punctuation">]</span><span class="token variable">$sftp</span> root@10.0.0.7
root@10.0.0.7<span class="token string">'s password:
Connected to 10.0.0.7.
sftp> help	# 查看帮助
Available commands:
bye                                Quit sftp
cd path                            Change remote directory to '</span>path<span class="token string">'
chgrp grp path                     Change group of file '</span>path<span class="token string">' to '</span>grp<span class="token string">'
chmod mode path                    Change permissions of file '</span>path<span class="token string">' to '</span>mode<span class="token string">'
chown own path                     Change owner of file '</span>path<span class="token string">' to '</span>own<span class="token string">'
df [-hi] [path]                    Display statistics for current directory or
                                   filesystem containing '</span>path<span class="token string">'
exit                               Quit sftp
get [-afPpRr] remote [local]       Download file
reget [-fPpRr] remote [local]      Resume download file
reput [-fPpRr] [local] remote      Resume upload file
help                               Display this help text
lcd path                           Change local directory to '</span>path<span class="token string">'
lls [ls-options [path]]            Display local directory listing
lmkdir path                        Create local directory
ln [-s] oldpath newpath            Link remote file (-s for symlink)
lpwd                               Print local working directory
ls [-1afhlnrSt] [path]             Display remote directory listing
lumask umask                       Set local umask to '</span><span class="token builtin class-name">umask</span><span class="token string">'
mkdir path                         Create remote directory
progress                           Toggle display of progress meter
put [-afPpRr] local [remote]       Upload file
pwd                                Display remote working directory
quit                               Quit sftp
rename oldpath newpath             Rename remote file
rm path                            Delete remote file
rmdir path                         Remove remote directory
symlink oldpath newpath            Symlink remote file
version                            Show SFTP version
!command                           Execute '</span>command' <span class="token keyword">in</span> <span class="token builtin class-name">local</span> shell
<span class="token operator">!</span>                                  Escape to <span class="token builtin class-name">local</span> shell
?                                  Synonym <span class="token keyword">for</span> <span class="token builtin class-name">help</span>
sftp<span class="token operator">></span> <span class="token builtin class-name">pwd</span>	<span class="token comment"># 查看远程服务器目录</span>
Remote working directory: /root
sftp<span class="token operator">></span> lpwd	<span class="token comment"># 查看本机目录</span>
Local working directory: /home/lujinkai/data
sftp<span class="token operator">></span> <span class="token function">ls</span>
ELS.txt  a.log
sftp<span class="token operator">></span> get a.log /tmp/	<span class="token comment"># get 下载文件</span>
Fetching /root/data/a.log to /tmp/a.log
/root/data/a.log                                        <span class="token number">100</span>%   <span class="token number">21</span>     <span class="token number">6</span>.5KB/s   00:00
sftp<span class="token operator">></span> put /etc/passwd ./	<span class="token comment"># 上传文件</span>
Uploading /etc/passwd to /root/data/./passwd
/etc/passwd                                             <span class="token number">100</span>% <span class="token number">1567</span>   <span class="token number">544</span>.2KB/s   00:00</code></pre>

<h2 id="高级应用"><a href="#高级应用" class="headerlink" title="高级应用"></a><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/12/ssh_port_forwarding.html">高级应用</a></h2><p>SSH 端口转发能够提供两大功能：</p>
<ul>
<li>加密 SSH Client 端至 SSH Server 端之间的通讯数据</li>
<li>突破防火墙的限制完成一些之前无法建立的 TCP 连接</li>
</ul>
<h3 id="SSH-本地端口转发"><a href="#SSH-本地端口转发" class="headerlink" title="SSH 本地端口转发"></a>SSH 本地端口转发</h3><p>三台主机：</p>
<p>host1：家用电脑，公网中<br>host2：业务服务器，内网中<br>host3：中转服务器，内网中</p>
<p>host1 不能直接连接 host2，但是可以通过 host3 中转，在 host1 上执行下面命令：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-fNL</span> <span class="token number">1234</span>:host2_ip:80 <span class="token punctuation">[</span>host3_user@<span class="token punctuation">]</span>host3_ip

<span class="token parameter variable">-N</span>                                   <span class="token comment"># 不打开远程shell，适用于转发端口</span>
<span class="token parameter variable">-f</span>                                   <span class="token comment"># 后台启用，避免占用终端前台</span>
<span class="token parameter variable">-L</span> <span class="token punctuation">[</span>bind_address:<span class="token punctuation">]</span>port:host:hostport <span class="token comment"># 本机端口：目标主机：目标主机端口，默认ssh只监听127.0.0.1的port，指定bind_address，则监听bind_address的port，如果bind_address设置为0.0.0.0，表示监听本机全部地址的port</span>
host3                                <span class="token comment"># 中转服务器</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># host1：CentOS6 10.0.0.6</span>
<span class="token comment"># host2：CentOS7 10.0.0.7</span>
<span class="token comment"># host3：CentOS 10.0.0.8</span>

<span class="token comment"># host1 ssh监听本机的1234端口，将1234端口的请求通过10.0.0.8转发到10.0.0.7的80端口</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># ssh -fNL 1234:10.0.0.7:80 root@10.0.0.8</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># curl 127.0.0.1:1234</span>
hello nginx<span class="token operator">!</span>

<span class="token comment"># host2</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#cat /usr/local/nginx/html/index.html</span>
hello nginx<span class="token operator">!</span>
<span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#tail -f /usr/local/nginx/logs/access.log</span>
<span class="token number">10.0</span>.0.8 - - <span class="token punctuation">[</span><span class="token number">12</span>/Sep/2020:14:15:53 +0800<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">13</span> <span class="token string">"-"</span> <span class="token string">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2"</span></code></pre>

<p>绑定本地端口，指定数据传送的目标主机，们把这种情况称为”本地端口转发”（Local forwarding）。</p>
<p>因为 host1 和 host3 通信使用 SSH 加密，仿佛形成一个数据传输的秘密隧道，因此又被称为”SSH 隧道”。</p>
<h3 id="SSH-远程端口转发"><a href="#SSH-远程端口转发" class="headerlink" title="SSH 远程端口转发"></a>SSH 远程端口转发</h3><p>三台主机：</p>
<p>host1：家用电脑，公网中<br>host2：业务服务器，内网中<br>host3：中转服务器，内网中</p>
<p>host1 不能直接连接 host2，也不能直接连接 host3，但是 host3 既可以连接 host1，又可以连接 host2，所有使用 host3 做中转。</p>
<p>远程端口转发 和 本地端口转发 逻辑上刚好相反：</p>
<ul>
<li>本地端口转发是 host1 主动监听本机的 1234 端口（因为主动，所以是 ssh 监听 1234），要求 host3 帮忙转发；</li>
<li>远程端口转发是 host3 通知 host1，让其监听自身的 1234 端口（因为被动，所以是 sshd 监听 1234），host3 主动拿帮 host1 转发。</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-fNR</span> <span class="token number">1234</span>:host2_ip:80 <span class="token punctuation">[</span>host1_user@<span class="token punctuation">]</span>host1_ip

<span class="token parameter variable">-R</span> <span class="token punctuation">[</span>bind_address:<span class="token punctuation">]</span>port:host:hostport   <span class="token comment"># 远程主机端口：目标主机：目标主机端口</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># host1：CentOS6 10.0.0.6</span>
<span class="token comment"># host2：CentOS7 10.0.0.7</span>
<span class="token comment"># host3：CentOS 10.0.0.8</span>

<span class="token comment"># host3</span>
<span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token variable">$ssh</span> <span class="token parameter variable">-fNR</span> <span class="token number">1234</span>:10.0.0.7:80 root@10.0.0.6

<span class="token comment"># host1，成功访问到host2，</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># curl 127.0.0.1:1234</span>
hello nginx<span class="token operator">!</span></code></pre>

<h3 id="SSH-动态端口转发"><a href="#SSH-动态端口转发" class="headerlink" title="SSH 动态端口转发"></a>SSH 动态端口转发</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-D</span> <span class="token number">1080</span> root@10.0.0.8</code></pre>

<p>SSH 创建 SOCKS 代理服务，去监听本地的 1080 端口。一旦有数据传向那个端口，就自动把它转移到 SSH 连接上面，发往远程主机 10.0.0.8。可以想象，如果 1080 端口原来是一个不加密端口，现在将变成一个加密端口。</p>
<p>目前 SOCKS4 和 SOCKS5 协议支持端口转发：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># CentOS6 配置 SOCKS代理</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># ssh -fND 1080 root@10.0.0.8</span>
<span class="token comment"># CentOS8替CentOS6访问http://10.0.0.7，将返回数据加密，发送回CentOS6</span>
<span class="token punctuation">[</span>root@centos6 ~<span class="token punctuation">]</span><span class="token comment"># curl --socks5 127.0.0.1:1080 http://10.0.0.7</span>
hello nginx<span class="token operator">!</span></code></pre>

<h3 id="X-协议转发"><a href="#X-协议转发" class="headerlink" title="X 协议转发"></a>X 协议转发</h3>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="//img.to2b.cn/blog/ljk/1607160536339.png" alt="像方便面一样的男子 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="//img.to2b.cn/blog/ljk/1607160019009.png" alt="像方便面一样的男子 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/OpenSSH/" rel="tag"><i class="fa fa-tag"></i> OpenSSH</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/DSA/" rel="prev" title="DSA">
                  <i class="fa fa-chevron-left"></i> DSA
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/%E5%9F%BA%E7%A1%80/%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/OpenSSL%E5%91%BD%E4%BB%A4/" rel="next" title="OpenSSL命令">
                  OpenSSL命令 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18016600号-3 </a>
  </div>

<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">像方便面一样的男子</span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="//s1.to2b.cn/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="//s1.to2b.cn/libs/lozad.js/1.16.0/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="//s1.to2b.cn/libs/algoliasearch/4.11.0/algoliasearch-lite.umd.min.js"></script>
<script src="//s1.to2b.cn/libs/instantsearch.js/4.36.0/instantsearch.production.min.js"></script><script src="/js/third-party/search/algolia-search.js"></script>






  





</body>
</html>
